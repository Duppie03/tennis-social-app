{"mappings":"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","sources":["<anon>","public/script.js"],"sourcesContent":["console.log(\"--- script.js started ---\");\ndocument.addEventListener('DOMContentLoaded', ()=>{\n    const ADMIN_PIN_BASE = \"0308\"; // <-- ADD THIS NEW LINE\n    let MASTER_MEMBER_LIST = []; // Will be populated from the CSV file\n    // --- NEW HELPER FUNCTION TO PARSE CSV DATA ---\n    function parseCSV(csvText) {\n        const lines = csvText.trim().split('\\n');\n        if (!lines[0]) return []; // Handle empty file\n        // Updated headers to include 'phonetic spelling'\n        const headers = lines[0].split(',').map((h)=>h.trim().toLowerCase());\n        const result = [];\n        for(let i = 1; i < lines.length; i++){\n            if (!lines[i]) continue; // Skip blank lines\n            // Split line, handling potential commas within quoted fields if needed (simple split for now)\n            const values = lines[i].split(',').map((v)=>v.trim());\n            // --- THIS IS THE FIX: Allow for variable column length ---\n            // We expect at least Name, Gender, Type (3 columns).\n            // Committee and Phonetic Spelling might be missing or empty.\n            if (values.length < 3) continue; // Skip lines with insufficient basic data\n            // --- END OF FIX ---\n            const entry = {};\n            headers.forEach((header, index)=>{\n                // Ensure we don't try to access an index that doesn't exist\n                if (index >= values.length) return;\n                const value = values[index];\n                if (!value) return; // Skip if the value is empty\n                if (header === 'gender') entry[header] = value.charAt(0).toUpperCase();\n                else if (header === 'phonetic spelling') entry['phoneticName'] = value; // Store under phoneticName key\n                else if (header === 'guest' || header === 'isPaused') entry[header] = value.toLowerCase() === 'true';\n                else entry[header] = value;\n            });\n            if (!entry.name) continue; // Skip entries without a name\n            // Add the default values that are not in the CSV\n            entry.guest = entry.guest || false; // Keep existing guest status if loaded\n            entry.isPaused = entry.isPaused || false; // Keep existing pause status\n            result.push(entry);\n        }\n        return result;\n    }\n    // --- NEW HELPER FUNCTION: Gets the name to use for TTS ---\n    // --- UPDATED HELPER FUNCTION: Gets the name to use for TTS (Phonetic First + Surname) ---\n    function getPronounceableName(playerName) {\n        if (!playerName) return ''; // Handle null or empty input\n        // Find the player object in the master list or current state\n        const playerObj = MASTER_MEMBER_LIST.find((p)=>p.name === playerName) || state.availablePlayers.find((p)=>p.name === playerName) || state.courts.flatMap((c)=>c.players).find((p)=>p.name === playerName);\n        // Extract surname (assuming name format is \"FirstName LastName\" or similar)\n        const nameParts = playerName.split(' ');\n        const surname = nameParts.length > 1 ? nameParts.slice(1).join(' ') : ''; // Get everything after the first space\n        // Use phonetic first name + surname if available, otherwise default to full name\n        if (playerObj && playerObj.phoneticName && surname) // Combine phonetic first name with the regular surname\n        return `${playerObj.phoneticName} ${surname}`;\n        else if (playerObj && playerObj.phoneticName) // If only a phonetic first name exists (maybe single-name entry?), use just that\n        return playerObj.phoneticName;\n        else // Fallback to the full original name if no phonetic spelling exists\n        return playerName;\n    }\n    // --- END UPDATED HELPER ---\n    // --- END NEW HELPER ---\n    // Define the preferred court hierarchy\n    const COURT_HIERARCHY = [\n        'B',\n        'C',\n        'D',\n        'A',\n        'E'\n    ];\n    // --- STATE MANAGEMENT ---\n    let state = {\n        undoHistory: {\n            actions: [],\n            maxHistory: 10 // Keep last 10 actions\n        },\n        juniorClub: {\n            // Master list of all registered parents/children\n            parents: [],\n            // Children currently checked into the club (will be returned to queue later)\n            activeChildren: [],\n            // History logs check-in sessions for payment tracking\n            history: [],\n            // --- FIX: Corrected the object structure ---\n            statsFilter: {\n                parent: 'all',\n                paid: 'all'\n            },\n            rosterFilter: {\n                sortKey: 'name',\n                sortOrder: 'asc',\n                type: 'all'\n            },\n            // NEW: State for the main check-in list filter\n            checkInFilter: {\n                displayMode: 'parent'\n            },\n            // NEW STATE FOR DYNAMIC FORM FLOW\n            registrationFlow: {\n                parentCollapsed: false,\n                childrenExpanded: false\n            }\n        },\n        // --- NEW: Event Management & Screensaver State ---\n        events: [],\n        // Structure for each event object:\n        // {\n        //  id: Date.now(), // Unique ID\n        //  eventType: 'Social', // 'Social', 'Club Champs', 'League', 'Other'\n        //  heading: '',\n        //  eventDate: '', // YYYY-MM-DD\n        //  rsvpDate: '',   // YYYY-MM-DD\n        //  startTime: '', // HH:MM\n        //  body1: '',\n        //  body2: '',\n        //  costAdult: 0,\n        //  costChild: 0,\n        //  participationDiscountPercent: 0, // 0-100\n        //  rsvpText: '',\n        //  volunteersNeeded: false,\n        //  contactDetails: '',\n        //  openTo: 'All Members', // 'Full Members', 'Social Members', 'All Members'\n        //  isOpenToGuests: false,\n        //  image1Filename: 'None', // e.g., 'Braai.jpg', 'None'\n        //  image2Filename: 'None',\n        //  isActive: false, // Controls screensaver visibility\n        //  interestedPlayers: [] // Array of player names\n        // }\n        // --- END: Event Management ---\n        uiSettings: {\n            fontSizeMultiplier: 1.0,\n            displaySizeMultiplier: 1.0 // Add this line\n        },\n        detailedWeatherView: 'day',\n        weatherData: null,\n        pongAnimationOffset: 0,\n        clubMembers: [\n            ...MASTER_MEMBER_LIST\n        ].sort((a, b)=>a.name.localeCompare(b.name)),\n        availablePlayers: [],\n        courts: [\n            // ADD isCollapsed: false to each court object\n            {\n                id: 'A',\n                status: 'available',\n                players: [],\n                teams: {\n                    team1: [],\n                    team2: []\n                },\n                autoStartTimer: null,\n                gameMode: null,\n                gameStartTime: null,\n                autoStartTimeTarget: null,\n                becameAvailableAt: Date.now(),\n                isCollapsed: false,\n                isModeOverlayActive: false,\n                courtMode: 'doubles'\n            },\n            {\n                id: 'B',\n                status: 'available',\n                players: [],\n                teams: {\n                    team1: [],\n                    team2: []\n                },\n                autoStartTimer: null,\n                gameMode: null,\n                gameStartTime: null,\n                autoStartTimeTarget: null,\n                becameAvailableAt: Date.now(),\n                isCollapsed: false,\n                isModeOverlayActive: false,\n                courtMode: 'doubles'\n            },\n            {\n                id: 'C',\n                status: 'available',\n                players: [],\n                teams: {\n                    team1: [],\n                    team2: []\n                },\n                autoStartTimer: null,\n                gameMode: null,\n                gameStartTime: null,\n                autoStartTimeTarget: null,\n                becameAvailableAt: Date.now(),\n                isCollapsed: false,\n                isModeOverlayActive: false,\n                courtMode: 'doubles'\n            },\n            {\n                id: 'D',\n                status: 'available',\n                players: [],\n                teams: {\n                    team1: [],\n                    team2: []\n                },\n                autoStartTimer: null,\n                gameMode: null,\n                gameStartTime: null,\n                autoStartTimeTarget: null,\n                becameAvailableAt: Date.now(),\n                isCollapsed: false,\n                isModeOverlayActive: false,\n                courtMode: 'doubles'\n            },\n            {\n                id: 'E',\n                status: 'available',\n                players: [],\n                teams: {\n                    team1: [],\n                    team2: []\n                },\n                autoStartTimer: null,\n                gameMode: null,\n                gameStartTime: null,\n                autoStartTimeTarget: null,\n                becameAvailableAt: Date.now(),\n                isCollapsed: false,\n                isModeOverlayActive: false,\n                courtMode: 'doubles'\n            }\n        ],\n        courtSettings: {\n            visibleCourts: [\n                'A',\n                'B',\n                'C',\n                'D',\n                'E'\n            ],\n            autoAssignModes: true,\n            showGameModeSelector: false // <-- ADD THIS LINE\n        },\n        // NEW MATCH SETTINGS BLOCK\n        matchSettings: {\n            matchMode: '1set',\n            fastPlayGames: 4,\n            autoMatchModes: true // Auto-assign match modes\n        },\n        mobileControls: {\n            isSummaryExpanded: true,\n            isPlayersExpanded: true\n        },\n        selection: {\n            gameMode: 'doubles',\n            players: [],\n            courtId: null\n        },\n        historySort: {\n            key: 'endTime',\n            order: 'desc'\n        },\n        gameHistoryFilter: {\n            timeFrame: 'Total',\n            gameType: 'all' // 'all', 'doubles', 'singles'\n        },\n        guestHistory: [],\n        gameHistory: [],\n        reorderHistory: [],\n        historyViewMode: 'games',\n        statsFilter: {\n            gender: 'all',\n            teamGender: 'all',\n            sortKey: 'totalDurationMs',\n            sortOrder: 'desc'\n        },\n        // NEW COMPARISON MODAL STATE\n        comparison: {\n            active: false,\n            type: null,\n            items: [],\n            timeFrame: 'Total',\n            opponents: new Set() // <-- ADD THIS LINE\n        },\n        // NEW ANNOUNCEMENT STATE\n        announcements: [],\n        customAnnouncementState: {\n            scheduler: null,\n            nextAnnouncementTime: 0,\n            currentIndex: 0,\n            isPaused: false,\n            ttsIntervalMins: 30 // <-- ADD THIS LINE (default is 30 mins)\n        },\n        powerScoreSort: {\n            key: 'finalScore',\n            order: 'desc'\n        },\n        suggestionSettings: {\n            femaleRatioPercent: 50,\n            maleRatioPercent: 70,\n            prioritizeLeastPlaytime: true,\n            powerScoreOnly: false,\n            // --- NEW SETTINGS ---\n            topPlayerPercent: 35,\n            frequentOpponentPercent: 35,\n            weakPlayerPercent: 35,\n            weakPlayerThreshold: -0.1\n        },\n        currentSuggestionType: null,\n        currentSuggestionOutcome: null,\n        adminChecklist: {\n            arrival: [\n                {\n                    id: 'arrUnlockTuckshop',\n                    text: 'Unlock Tuckshop & Setup POS',\n                    checked: false\n                },\n                {\n                    id: 'arrUnlockCloakrooms',\n                    text: 'Unlock Cloakrooms',\n                    checked: false\n                },\n                {\n                    id: 'arrMainTv',\n                    text: 'Main TV: On & Sport Channel',\n                    checked: false\n                },\n                {\n                    id: 'arrTuckshopTv',\n                    text: 'Tuckshop TV: On & Music Videos',\n                    checked: false\n                },\n                {\n                    id: 'arrAmpAux',\n                    text: 'Amp: Aux Analog',\n                    checked: false\n                },\n                {\n                    id: 'arrAmpOptical',\n                    text: 'Amp: Optical/Main TV',\n                    checked: false\n                },\n                {\n                    id: 'arrOpenCurtains',\n                    text: 'Open Curtains & Sliding Door',\n                    checked: false\n                },\n                {\n                    id: 'arrPutCushions',\n                    text: 'Put Out Bench Cushions',\n                    checked: false\n                },\n                {\n                    id: 'arrSignOutBalls',\n                    text: 'Sign Out Social Balls (via Ball Mgmt)',\n                    checked: false\n                },\n                {\n                    id: 'arrEmptyDishwasher',\n                    text: 'Empty Dishwasher & Check Dishes',\n                    checked: false\n                },\n                {\n                    id: 'arrCheckFridge',\n                    text: 'Check Fridge for Expired Products',\n                    checked: false\n                },\n                {\n                    id: 'arrEmptyBins',\n                    text: 'Empty Full Bins & Replace Liners',\n                    checked: false\n                },\n                {\n                    id: 'arrManStation',\n                    text: 'Man Duty Station (Busy Times)',\n                    checked: false\n                },\n                {\n                    id: 'arrAssistApp',\n                    text: 'Assist Members with App',\n                    checked: false\n                },\n                {\n                    id: 'arrRemindAccounts',\n                    text: 'Remind Members re: Tuck Shop Accounts',\n                    checked: false\n                }\n            ],\n            departure: [\n                {\n                    id: 'depReturnBalls',\n                    text: 'Return Social Balls & Sign In (via Ball Mgmt)',\n                    checked: false\n                },\n                {\n                    id: 'depCheckOutApp',\n                    text: 'Ensure All Players Checked Out on App',\n                    checked: false\n                },\n                {\n                    id: 'depLoadDishes',\n                    text: 'Load/Wash Dishes',\n                    checked: false\n                },\n                {\n                    id: 'depReturnCushions',\n                    text: 'Return Bench Cushions',\n                    checked: false\n                },\n                {\n                    id: 'depTurnOffTvAmp',\n                    text: 'Turn Off TVs & Amp',\n                    checked: false\n                },\n                {\n                    id: 'depWipeBar',\n                    text: 'Wipe Down Bar Counter',\n                    checked: false\n                },\n                {\n                    id: 'depEmptyIceBucket',\n                    text: 'Empty & Wash Ice Bucket',\n                    checked: false\n                },\n                {\n                    id: 'depWipeKitchen',\n                    text: 'Wipe Down Kitchen Counter',\n                    checked: false\n                },\n                {\n                    id: 'depTrashOut',\n                    text: 'Take Inside Trash to Outside Bins',\n                    checked: false\n                },\n                {\n                    id: 'depLockBarStore',\n                    text: 'Lock Bar & Storeroom',\n                    checked: false\n                },\n                {\n                    id: 'depCloseCurtains',\n                    text: 'Close Sliding Door & Curtains',\n                    checked: false\n                },\n                {\n                    id: 'depLockClubhouseAlarm',\n                    text: 'Lock Clubhouse & Set Alarm',\n                    checked: false\n                },\n                {\n                    id: 'depLockCloakrooms',\n                    text: 'Lock Cloakrooms',\n                    checked: false\n                },\n                {\n                    id: 'depLockGates',\n                    text: 'Check & Lock Pedestrian Gates',\n                    checked: false\n                }\n            ]\n        },\n        checklistHistory: [],\n        selectedChecklistHistoryDate: null,\n        onDuty: 'None',\n        selectedAlertSound: 'Alert1.mp3',\n        // NEW NOTIFICATION CONTROL STATES\n        notificationControls: {\n            isMuted: false,\n            isMinimized: false,\n            isTTSDisabled: false,\n            autoMinimize: true // <-- ADD THIS NEW LINE\n        },\n        currentQuoteIndex: 0,\n        currentAlertCount: 0,\n        tennisQuotes: [\n            \"You only live once, but you get to serve twice.\",\n            \"Tennis is a perfect combination of violent action taking place in an atmosphere of total tranquility.\",\n            \"The serve is the only shot you have 100% control over.\",\n            \"Losing is not my enemy, fear of losing is my enemy.\",\n            \"My motto is: I'm alive, so I have to live it.\",\n            \"Tennis uses the language of life. Advantage, service, fault, break, love.\",\n            \"It's one-on-one out there, man. There ain't no hiding.\",\n            \"The fifth set is not about tennis, it's about nerves.\",\n            \"What is the single most important quality in a tennis champion? I would have to say desire.\",\n            \"Success is a journey, not a destination.\",\n            \"If you can keep your head when all about you are losing theirs, it's just possible you haven't grasped the situation.\",\n            \"I fear no one, but I respect everyone.\",\n            \"Tennis is mostly mental. You win or lose the match before you even go out there.\",\n            \"A champion is afraid of losing. Everyone else is afraid of winning.\",\n            \"The difference between involvement and commitment is like ham and eggs. The chicken is involved; the pig is committed.\",\n            \"You've got to get to the stage in life where going for it is more important than winning or losing.\",\n            \"I'm not the best, but I'm capable of beating the best on any given day.\",\n            \"When you do something best in life, you don't really want to give that up.\",\n            \"The mark of a great champion is to be able to win when you are not playing your best.\",\n            \"Every point is a new opportunity.\",\n            \"Just go out there and do what you have to do.\",\n            \"Tennis is a game of inches. And sometimes, those inches are in your head.\",\n            \"It\\u2019s not whether you get knocked down, it\\u2019s whether you get up.\",\n            \"Hard work beats talent when talent doesn't work hard.\",\n            \"Don't practice until you get it right. Practice until you can't get it wrong.\",\n            \"Play each point like your life depends on it.\",\n            \"Champions keep playing until they get it right.\",\n            \"I never look back, I look forward.\",\n            \"The harder the battle, the sweeter the victory.\",\n            \"You are never a loser until you quit trying.\",\n            \"To be a great champion you must believe you are the best. If you are not, pretend you are.\",\n            \"The pain you feel today will be the strength you feel tomorrow.\",\n            \"If it doesn\\u2019t challenge you, it won\\u2019t change you.\",\n            \"Victory is sweetest when you\\u2019ve known defeat.\",\n            \"What seems hard now will one day be your warm-up.\",\n            \"I've failed over and over and over again in my life. And that is why I succeed.\",\n            \"Tennis is life.\",\n            \"Keep calm and play tennis.\",\n            \"Tennis: the only place where love means nothing.\",\n            \"I play each point as if it were the last point of the match.\",\n            \"Never give up on a dream just because of the time it will take to accomplish it.\",\n            \"It's not the will to win that matters\\u2014everyone has that. It's the will to prepare to win that matters.\",\n            \"Pressure is a privilege.\",\n            \"One point at a time.\",\n            \"Control the controllables.\",\n            \"Tennis requires agility, mental and physical.\",\n            \"My backhand is my weapon.\",\n            \"A perfect volley is a work of art.\",\n            \"There's no place like the court.\",\n            \"Tennis is a dance between two players.\"\n        ],\n        // NEW ADMIN COURT MANAGEMENT STATE\n        adminCourtManagement: {\n            mode: 'card1_select_court',\n            courtId: null,\n            // The list of players currently on court (Card 2) after initialization, excluding temporary removals.\n            currentCourtPlayers: [],\n            // Players marked for removal from the court on Card 2 (will go to bottom of queue on confirm)\n            removedPlayers: [],\n            // Players selected to be added to the court on Card 3 (consumed from available queue on confirm)\n            addedPlayers: []\n        },\n        // NEW LIGHT MANAGEMENT STATE (Local RPC Method)\n        lightSettings: {\n            shellyBaseUrl: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch',\n            shellyAuthKey: 'MzEyNDRhdWlk4A2C89A1B41C12C193A1BF0978CB3C8D7891CD751D3C578EDA094C05D1DB4E618708AE34BCD86240',\n            courts: {\n                'A': {\n                    id: 'A',\n                    label: 'Court A Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.0.15',\n                    shellyCloudId: 'YOUR_COURT_A_CLOUD_ID',\n                    toggleAfter: 0\n                },\n                'B': {\n                    id: 'B',\n                    label: 'Court B Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.0.147',\n                    shellyCloudId: 'YOUR_COURT_B_CLOUD_ID',\n                    toggleAfter: 0\n                },\n                'C': {\n                    id: 'C',\n                    label: 'Court C Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.0.130',\n                    shellyCloudId: 'YOUR_COURT_C_CLOUD_ID',\n                    toggleAfter: 0\n                },\n                'D': {\n                    id: 'D',\n                    label: 'Court D Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.0.179',\n                    shellyCloudId: 'YOUR_COURT_D_CLOUD_ID',\n                    toggleAfter: 0\n                },\n                // Court E for testing - Use its actual Cloud ID\n                'E': {\n                    id: 'E',\n                    label: 'Court E Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.88.74',\n                    shellyCloudId: '2cbcbb2fb26c'\n                } // Use the actual Cloud ID here\n            },\n            general: {\n                'clubhouse': {\n                    id: 'clubhouse',\n                    label: 'Clubhouse Lights',\n                    isManaged: true,\n                    isActive: false,\n                    shellyDeviceId: '192.168.0.100',\n                    shellyCloudId: 'YOUR_CLUBHOUSE_CLOUD_ID'\n                } // Replace placeholder\n            }\n        },\n        gateSettings: {\n            pedestrian: {\n                label: 'Pedestrian Gate',\n                shellyCloudId: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch',\n                shellyDeviceId: '',\n                isManaged: false,\n                toggleAfter: 1 // 1 second pulse\n            },\n            parking: {\n                label: 'Parking Lot Gate',\n                shellyCloudId: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch',\n                shellyDeviceId: '',\n                isManaged: false,\n                toggleAfter: 1 // 1 second pulse\n            }\n        },\n        manualEntry: {\n            players: []\n        },\n        // NEW BALL MANAGEMENT STATE (ADD THIS BLOCK - Updated to CANS)\n        ballManagement: {\n            stock: 0,\n            usedStock: 0,\n            // History logs the member, category, and number of CANS.\n            history: [],\n            historyFilter: 'all',\n            // NEW: Temporary state for multi-step sale flow\n            tempSale: {\n                stockType: null,\n                memberSignOut: null,\n                purchaserName: null\n            }\n        }\n    };\n    // Drag & Drop State\n    let draggedPlayer = null;\n    let draggedFromCourt = null;\n    let draggedPlayerPosition = null;\n    let dragOverTarget = null;\n    let activeDraggablePlayer = null; // Track which player is currently enabled for dragging\n    // Track long-press state\n    let gateButtonPressTimer = null;\n    let gateButtonIsLongPress = false;\n    // ============================================================================\n    // COURT LIGHT LONG-PRESS SETUP\n    // ============================================================================\n    let lightIconPressTimer = null;\n    let lightIconIsLongPress = false;\n    // Undo system - separate from state because functions can't be serialized\n    let currentUndoAction = null;\n    let currentUndoTimeout = null;\n    let localChangeInProgress = false; // Prevent WebSocket from overwriting local changes\n    //NEW SLIDE HEADER\n    // --- HEADER & TIME OVERLAY SLIDE-DOWN FUNCTIONALITY ---\n    let headerTimeout = null;\n    const header = document.querySelector('header');\n    const timeOverlay = document.getElementById('time-overlay');\n    const headerPullTab = document.getElementById('header-pull-tab');\n    let touchStartY = 0;\n    let isDragging = false;\n    let lastScrollY = 0;\n    //NEW PAUSE COOLDOWN TIMER\n    let cooldownTimerInterval = null;\n    // NEW/ADJUSTED STATE VARIABLES FOR ALERT SCHEDULING\n    let alertScheduleTime = 0; // Timestamp of the next alert fire time\n    let currentAudio = null; // Track the currently playing audio object\n    // Tracks the state of the alert cycle: 'initial_check' -> '2_min_countdown' -> '5_min_repeat'\n    let alertState = 'initial_check';\n    // NEW: Announcement Queue System\n    let announcementQueue = [];\n    let isAnnouncementPlaying = false;\n    // NEW: Admin timer\n    let adminSessionActive = false; // NEW: Track admin login state\n    let adminSessionTimer = null; // NEW: Timer for admin session timeout\n    // --- NEW: Screensaver Variables ---\n    let inactivityTimer = null;\n    let screensaverCycleInterval = null;\n    const INACTIVITY_TIMEOUT_MS = 300000; // 5 minutes\n    const SCREENSAVER_INTERVAL_MS = 15000; // 15 seconds per view (event or app)\n    let screensaverCurrentIndex = 0;\n    let isShowingScreensaverEvent = true; // Start by showing an event first\n    const screensaverOverlay = document.getElementById('screensaver-overlay');\n    const screensaverContent = document.getElementById('screensaver-content');\n    // --- END: Screensaver Variables ---\n    const ANNOUNCEMENT_GRACE_PERIOD_MS = 30000; // 30 seconds\n    const leaderboardConfirmModal = document.getElementById('leaderboard-confirm-modal');\n    const disclaimerModal = document.getElementById('disclaimer-modal');\n    // NEW ELEMENTS: Weather Modals\n    const currentWeatherModal = document.getElementById('current-weather-modal');\n    const detailedWeatherModal = document.getElementById('detailed-weather-modal');\n    // JUNIOR CLUB:\n    // --- NEW ELEMENTS: Junior Club Modals (Required for listeners and utility calls) ---\n    const juniorClubModal = document.getElementById('junior-club-modal');\n    const juniorClubList = document.getElementById('junior-club-list');\n    const juniorClubCloseBtn = document.getElementById('junior-club-close-btn');\n    const newParentBtn = document.getElementById('new-parent-btn');\n    const newParentModal = document.getElementById('new-parent-modal');\n    const newParentCancelBtn = document.getElementById('new-parent-cancel-btn');\n    const newParentConfirmBtn = document.getElementById('new-parent-confirm-btn');\n    const parentNameInput = document.getElementById('parent-name-input');\n    const parentSurnameInput = document.getElementById('parent-surname-input');\n    const childrenContainer = document.getElementById('children-container');\n    const addChildBtn = document.getElementById('add-child-btn');\n    const parentPhoneInput = document.getElementById('parent-phone-input'); // <-- NEW REFERENCE\n    parentPhoneInput.addEventListener('input', function(e) {\n        let value = e.target.value;\n        // Remove leading zero if it's the first character\n        if (value.startsWith('0')) e.target.value = value.substring(1);\n    });\n    const parentEmailInput = document.getElementById('parent-email-input'); // <-- NEW EMAIL INPUT\n    const removeChildSelectionModal = document.getElementById('remove-child-selection-modal');\n    const childrenForRemovalList = document.getElementById('children-for-removal-list');\n    const removeChildSelectionBackBtn = document.getElementById('remove-child-selection-back-btn');\n    const removeChildSelectionConfirmBtn = document.getElementById('remove-child-selection-confirm-btn');\n    const childSelectionModal = document.getElementById('child-selection-modal');\n    const childSelectionConfirmBtn = document.getElementById('child-selection-confirm-btn');\n    const childSelectionBackBtn = document.getElementById('child-selection-back-btn');\n    const attendingChildrenList = document.getElementById('attending-children-list');\n    const juniorClubHistoryBtn = document.getElementById('junior-club-history-btn');\n    const juniorClubStatsModal = document.getElementById('junior-club-stats-modal');\n    const juniorClubHistoryList = document.getElementById('junior-club-history-list');\n    const juniorClubStatsBackBtn = document.getElementById('junior-club-stats-back-btn');\n    const juniorClubStatsDetailsBtn = document.getElementById('junior-club-stats-details-btn');\n    const juniorClubDetailModal = document.getElementById('junior-club-detail-modal');\n    const detailCloseBtn = document.getElementById('detail-close-btn');\n    const detailTogglePaidBtn = document.getElementById('detail-toggle-paid-btn');\n    const juniorClubBtn = document.getElementById('junior-club-btn');\n    // NEW: Reference to the filter group element\n    const juniorClubNameFilterGroup = document.getElementById('junior-club-name-filter-group');\n    const removeChildBtn = document.getElementById('remove-child-btn-main');\n    // --- NEW ELEMENTS FOR ROSTER MODAL ---\n    const juniorClubRosterBtn = document.getElementById('junior-club-roster-btn');\n    const juniorClubRosterModal = document.getElementById('junior-club-roster-modal');\n    const juniorClubRosterList = document.getElementById('junior-club-roster-list');\n    const rosterCloseBtn = document.getElementById('roster-close-btn');\n    const rosterTypeFilterGroup = document.getElementById('roster-type-filter-group'); // <-- NEW ELEMENT\n    // CRITICAL FIX: Add the missing gender filter element reference\n    const rosterGenderFilterGroup = document.getElementById('roster-gender-filter-group');\n    // TEMPORARY DUTY HANDOVER ELEMENTS\n    const tempDutyHandoverModal = document.getElementById('temp-duty-handover-modal');\n    const tempDutyHandoverList = document.getElementById('temp-duty-handover-list');\n    const tempDutyCurrentMember = document.getElementById('temp-duty-current-member');\n    const tempDutyCancelBtn = document.getElementById('temp-duty-cancel-btn');\n    const tempDutyConfirmBtn = document.getElementById('temp-duty-confirm-btn');\n    // NEW ELEMENTS FOR MANUAL GAME ENTRY\n    const manualEntryModal = document.getElementById('manual-entry-modal');\n    const manualPlayerList = document.getElementById('manual-player-list');\n    const manualEntryConfirmBtn = document.getElementById('manual-entry-confirm-btn');\n    const manualEntryCancelBtn = document.getElementById('manual-entry-cancel-btn');\n    const addOutsidePlayerBtn = document.getElementById('add-outside-player-btn');\n    const outsidePlayerModal = document.getElementById('outside-player-modal');\n    const outsidePlayerList = document.getElementById('outside-player-list');\n    const outsidePlayerBackBtn = document.getElementById('outside-player-back-btn');\n    // ADD THESE TWO LINES\n    const manualSelectedPlayersContainer = document.getElementById('manual-selected-players');\n    const outsideSelectedPlayersContainer = document.getElementById('outside-selected-players');\n    const outsidePlayerConfirmBtn = document.getElementById('outside-player-confirm-btn');\n    // --- NEW ELEMENTS FOR ROSTER DETAIL MODAL ---\n    const rosterDetailModal = document.getElementById('roster-detail-modal');\n    const rosterDetailTitle = document.getElementById('roster-detail-title');\n    const rosterDetailContent = document.getElementById('roster-detail-content');\n    const rosterDetailCloseBtn = document.getElementById('roster-detail-close-btn');\n    // --- END NEW ELEMENTS ---\n    // --- DOM ELEMENTS ---\n    const headerClock = document.getElementById('header-clock');\n    const availablePlayersSection = document.getElementById('availablePlayersSection');\n    const availablePlayersList = document.getElementById('availablePlayersList');\n    const courtGrid = document.getElementById('court-grid');\n    const infoBar = document.getElementById('info-bar');\n    const infoBarText = document.getElementById('info-bar-text');\n    const modeDoublesBtn = document.getElementById('mode-doubles');\n    const modeSinglesBtn = document.getElementById('mode-singles');\n    const chooseTeamsModal = document.getElementById('choose-teams-modal');\n    const modalPlayerList = document.getElementById('modal-player-list');\n    const modalConfirmBtn = document.getElementById('modal-confirm-teams-btn');\n    const modalCancelBtn = document.getElementById('modal-cancel-btn');\n    const cancelConfirmModal = document.getElementById('cancel-confirm-modal');\n    const modalBtnYesConfirm = document.getElementById('modal-btn-yes-confirm');\n    const modalBtnNo = document.getElementById('modal-btn-no');\n    const checkInModal = document.getElementById('check-in-modal');\n    const checkInList = document.getElementById('check-in-list');\n    const checkInCancelBtn = document.getElementById('check-in-cancel-btn');\n    const checkInBtn = document.getElementById('checkInBtn');\n    const checkOutModal = document.getElementById('check-out-modal');\n    const checkOutList = document.getElementById('check-out-list');\n    const checkOutBtn = document.getElementById('checkOutBtn');\n    const checkOutCloseBtn = document.getElementById('check-out-cancel-btn');\n    const historyBtn = document.getElementById('historyBtn');\n    const historyPage = document.getElementById('history-page');\n    const historyList = document.getElementById('history-list');\n    const historyToggleViewBtn = document.getElementById('history-toggle-view');\n    const historyCloseBtn = document.getElementById('history-close-btn');\n    const endGameModal = document.getElementById('end-game-modal');\n    const endGameTeams = document.getElementById('end-game-teams');\n    const endGameConfirmBtn = document.getElementById('end-game-confirm-btn');\n    const endGameCancelBtn = document.getElementById('end-game-cancel-btn');\n    const tieBreakerArea = document.getElementById('tie-breaker-area');\n    const scoreSection = document.getElementById('score-section');\n    const winningScoreInput = document.getElementById('winning-score');\n    const losingScoreInput = document.getElementById('losing-score');\n    const winnerTiebreakInput = document.getElementById('winner-tiebreak');\n    const loserTiebreakInput = document.getElementById('loser-tiebreak');\n    const endGameTimestamp = document.getElementById('end-game-timestamp');\n    // NEW ELEMENTS: Style Editor\n    const editStylesBtn = document.getElementById('edit-styles-btn');\n    const editStylesModal = document.getElementById('edit-styles-modal');\n    const editStylesCloseBtn = document.getElementById('edit-styles-close-btn');\n    const fontSizeSlider = document.getElementById('font-size-slider');\n    // KEYPAD ELEMENTS AND STATE\n    const customKeypadModal = document.getElementById('custom-keypad-modal');\n    const keypadDisplay = document.getElementById('keypad-display');\n    const keypadButtons = customKeypadModal.querySelectorAll('.keypad-btn');\n    const keypadConfirmBtn = document.getElementById('keypad-confirm-btn');\n    const keypadCancelBtn = document.getElementById('keypad-cancel-btn');\n    let activeInput = null;\n    let keypadConfig = {};\n    // GUEST/ALPHA KEYPAD ELEMENTS\n    const addGuestBtn = document.getElementById('add-guest-btn');\n    const guestNameModal = document.getElementById('guest-name-modal');\n    const guestNameInput = document.getElementById('guest-name-input');\n    const guestSurnameInput = document.getElementById('guest-surname-input');\n    const guestGenderRadios = document.querySelectorAll('input[name=\"guest-gender\"]');\n    const guestConfirmBtn = document.getElementById('guest-confirm-btn');\n    const guestCancelBtn = document.getElementById('guest-cancel-btn');\n    const customAlphaKeypadModal = document.getElementById('custom-alpha-keypad-modal');\n    const alphaKeypadDisplay = document.getElementById('alpha-keypad-display');\n    const alphaKeypadGrid = document.getElementById('alpha-keypad-grid');\n    let activeAlphaInput = null;\n    // --- NEW GLOBAL KEYBOARD REFERENCES ---\n    const globalKeyboardModal = document.getElementById('global-keyboard-modal');\n    const globalKeyboardDisplay = document.getElementById('global-keyboard-display');\n    const globalKeyboardGrid = document.getElementById('global-keyboard-grid');\n    const emojiSearchInput = document.getElementById('emoji-search-input');\n    const emojiSearchContainer = document.getElementById('emoji-search-container');\n    let activeGlobalInput = null;\n    // --- END GLOBAL KEYBOARD REFERENCES ---\n    // --- GLOBAL KEYBOARD STATE ---\n    let globalKeyboardState = {\n        currentPage: 'LetterPad',\n        case: 'lower',\n        longPressTimer: null\n    };\n    // --- END GLOBAL KEYBOARD STATE ---\n    // --- GLOBAL KEYBOARD DATA ---\n    // Keys are mapped to their display text or special action/page codes\n    const KEYBOARD_LAYOUTS = {\n        'LetterPad': [\n            [\n                'q',\n                'w',\n                'e',\n                'r',\n                't',\n                'y',\n                'u',\n                'i',\n                'o',\n                'p'\n            ],\n            [\n                'a',\n                's',\n                'd',\n                'f',\n                'g',\n                'h',\n                'j',\n                'k',\n                'l'\n            ],\n            [\n                'SHIFT',\n                'z',\n                'x',\n                'c',\n                'v',\n                'b',\n                'n',\n                'm',\n                'BACK'\n            ],\n            [\n                '?123',\n                'GLOBE',\n                'SPACE',\n                \", / \\uD83D\\uDE00\",\n                'ENTER'\n            ]\n        ],\n        'SymbolsP1': [\n            [\n                '[',\n                ']',\n                '{',\n                '}',\n                '#',\n                '%',\n                '^',\n                '*',\n                '+',\n                '='\n            ],\n            [\n                '_',\n                '\\\\',\n                '|',\n                '~',\n                '<',\n                '>',\n                \"\\u20AC\",\n                \"\\xa3\",\n                \"\\xa5\",\n                \"\\u2022\"\n            ],\n            [\n                'ABC',\n                '.',\n                ',',\n                '?',\n                '!',\n                \"'\",\n                '\"',\n                'BACK'\n            ],\n            [\n                '1234',\n                'GLOBE',\n                'SPACE',\n                '!@#',\n                'ENTER'\n            ]\n        ],\n        'SymbolsP2': [\n            [\n                '`',\n                \"\\xb4\",\n                \"\\xa8\",\n                \"\\xe7\",\n                \"\\xf1\",\n                \"\\xe6\",\n                \"\\u0153\",\n                \"\\xdf\",\n                \"\\xf7\",\n                \"\\xbf\"\n            ],\n            [\n                '@',\n                '$',\n                '&',\n                '/',\n                '(',\n                ')',\n                \"\\u201C\",\n                \"\\u201D\",\n                \"\\u2026\",\n                \"\\xae\"\n            ],\n            [\n                'ABC',\n                '.',\n                ',',\n                '?',\n                '!',\n                \"'\",\n                '\"',\n                'BACK'\n            ],\n            [\n                '?123',\n                'GLOBE',\n                'SPACE',\n                '!@#',\n                'ENTER'\n            ] // Note: ?123 maps to SymbolsP1\n        ],\n        'NumberPad': [\n            // Row 0: %, 1, 2, 3, + (5 keys)\n            [\n                'PERCENT',\n                '1',\n                '2',\n                '3',\n                '+'\n            ],\n            // Row 1: SPACE, 4, 5, 6, - (5 keys)\n            [\n                'SPACE',\n                '4',\n                '5',\n                '6',\n                '-'\n            ],\n            // Row 2: BACK, 7, 8, 9, * (5 keys)\n            [\n                'BACK',\n                '7',\n                '8',\n                '9',\n                '*'\n            ],\n            // Row 3: abc, comma, ?123, 0, =, period, return (7 keys)\n            [\n                'ABC',\n                'COMMA',\n                '?123',\n                '0',\n                '=',\n                'DOT',\n                'ENTER'\n            ]\n        ]\n    };\n    const EMOJI_LIST = [\n        // This should be loaded dynamically, but for simplicity, use a sample array\n        \"\\uD83D\\uDE00\",\n        \"\\uD83D\\uDE03\",\n        \"\\uD83D\\uDE04\",\n        \"\\uD83D\\uDE01\",\n        \"\\uD83D\\uDE06\",\n        \"\\uD83D\\uDE05\",\n        \"\\uD83D\\uDE02\",\n        \"\\uD83E\\uDD23\",\n        \"\\uD83D\\uDE0A\",\n        \"\\uD83D\\uDE07\",\n        \"\\uD83D\\uDE42\",\n        \"\\uD83D\\uDE09\",\n        \"\\uD83D\\uDE0C\",\n        \"\\uD83D\\uDE0D\",\n        \"\\uD83D\\uDE18\",\n        \"\\uD83D\\uDE17\",\n        \"\\uD83D\\uDE19\",\n        \"\\uD83D\\uDE1A\",\n        \"\\uD83D\\uDE0B\",\n        \"\\uD83D\\uDE1B\",\n        \"\\uD83D\\uDE1C\",\n        \"\\uD83E\\uDD2A\",\n        \"\\uD83D\\uDE1D\",\n        \"\\uD83E\\uDD17\",\n        \"\\uD83E\\uDD28\",\n        \"\\uD83D\\uDE10\",\n        \"\\uD83D\\uDE11\",\n        \"\\uD83D\\uDE36\",\n        \"\\uD83D\\uDE0F\",\n        \"\\uD83D\\uDE12\",\n        \"\\uD83D\\uDE44\",\n        \"\\uD83D\\uDE2C\",\n        \"\\uD83E\\uDD25\",\n        \"\\uD83E\\uDD27\",\n        \"\\uD83D\\uDE29\",\n        \"\\uD83D\\uDE2B\",\n        \"\\uD83D\\uDE24\",\n        \"\\uD83D\\uDE21\",\n        \"\\uD83D\\uDE20\",\n        \"\\uD83E\\uDD2C\",\n        \"\\uD83D\\uDE37\",\n        \"\\uD83E\\uDD12\",\n        \"\\uD83E\\uDD15\",\n        \"\\uD83E\\uDD22\",\n        \"\\uD83E\\uDD2E\",\n        \"\\uD83E\\uDD2F\",\n        \"\\uD83E\\uDD73\",\n        \"\\uD83D\\uDE0E\",\n        \"\\uD83E\\uDD13\",\n        \"\\uD83E\\uDDD0\",\n        \"\\uD83D\\uDE15\",\n        \"\\uD83D\\uDE1F\",\n        \"\\uD83D\\uDE41\",\n        \"\\uD83D\\uDE2E\",\n        \"\\uD83D\\uDE2F\",\n        \"\\uD83D\\uDE32\",\n        \"\\uD83D\\uDE33\",\n        \"\\uD83E\\uDD7A\",\n        \"\\uD83D\\uDE26\",\n        \"\\uD83D\\uDE27\",\n        \"\\uD83D\\uDE28\",\n        \"\\uD83D\\uDE30\",\n        \"\\uD83D\\uDE25\",\n        \"\\uD83D\\uDE22\",\n        \"\\uD83D\\uDE2D\",\n        \"\\uD83D\\uDE31\",\n        \"\\uD83D\\uDE16\",\n        \"\\uD83D\\uDE29\",\n        \"\\uD83D\\uDE2B\",\n        \"\\uD83D\\uDE34\",\n        \"\\uD83E\\uDD24\",\n        \"\\uD83D\\uDE2A\"\n    ];\n    // --- END GLOBAL KEYBOARD DATA ---\n    // ADMIN MODAL ELEMENTS\n    const adminSettingsModal = document.getElementById('admin-settings-modal');\n    const committeeMemberList = document.getElementById('committee-member-list');\n    const courtAvailabilityList = document.getElementById('court-availability-list');\n    const adminCloseBtn = document.getElementById('admin-close-btn');\n    const reorderPlayersModal = document.getElementById('reorder-players-modal');\n    const reorderPlayersList = document.getElementById('reorder-players-list');\n    const reorderPlayersBtn = document.getElementById('reorder-players-btn');\n    const reorderSaveBtn = document.getElementById('reorder-save-btn');\n    const reorderCancelBtn = document.getElementById('reorder-cancel-btn');\n    const reorderLogModal = document.getElementById('reorder-log-modal');\n    const reorderHistoryList = document.getElementById('reorder-history-list');\n    const viewReorderLogBtn = document.getElementById('view-reorder-log-btn');\n    const reorderLogCloseBtn = document.getElementById('reorder-log-close-btn');\n    const reorderLogBackBtn = document.getElementById('reorder-log-back-btn'); // NEW ELEMENT\n    let tempPlayerOrder = [];\n    // SOUND SELECTION ELEMENTS\n    const selectSoundBtn = document.getElementById('select-sound-btn');\n    const soundSelectionModal = document.getElementById('sound-selection-modal');\n    const soundSelectionList = document.getElementById('sound-selection-list');\n    const soundConfirmBtn = document.getElementById('sound-confirm-btn');\n    const soundCancelBtn = document.getElementById('sound-cancel-btn');\n    const alertSounds = Array.from({\n        length: 17\n    }, (_, i)=>`Alert${i + 1}.mp3`);\n    let tempSelectedSound = ''; // Temporary selection in the modal\n    // NEW ELEMENTS: Notification Control Buttons\n    const muteBtn = document.getElementById('mute-btn');\n    const minimizeNotificationsBtn = document.getElementById('minimize-notifications-btn');\n    const noSpeechBtn = document.getElementById('no-speech-btn');\n    let alertStatusDisplay;\n    // NEW COURT MODE KEYPAD ELEMENTS\n    const courtModeKeypadModal = document.getElementById('court-mode-keypad-modal');\n    const courtModeKeypadDisplay = document.getElementById('court-mode-keypad-display');\n    const courtModeKeypadButtons = courtModeKeypadModal.querySelectorAll('.keypad-btn');\n    const courtModeKeypadConfirmBtn = document.getElementById('court-mode-keypad-confirm-btn');\n    const courtModeKeypadCancelBtn = document.getElementById('court-mode-keypad-cancel-btn');\n    let courtModeAction = null; // To store the action after PIN entry\n    // NEW ELEMENTS: Admin Court Player Management (REFACTORED)\n    const manageCourtPlayersBtn = document.getElementById('manage-court-players-btn');\n    const manageCourtPlayersModal = document.getElementById('manage-court-players-modal');\n    const courtListForManagement = document.getElementById('court-list-for-management'); // Card 1\n    const removePlayersList = document.getElementById('remove-players-list'); // Card 2 - Players currently on court\n    const addPlayersList = document.getElementById('add-players-list'); // Card 3 - Available players to add\n    const managePlayersCloseBtn = document.getElementById('manage-players-close-btn');\n    const managePlayersBackBtn = document.getElementById('manage-players-back-btn');\n    const managePlayersAddBtn = document.getElementById('manage-players-add-btn');\n    const managePlayersConfirmBtn = document.getElementById('manage-players-confirm-btn'); // Card 3 Confirm\n    // NEW: Reference to the modal-actions div for setting the data-card-mode\n    const manageModalActions = manageCourtPlayersModal.querySelector('.modal-actions');\n    // NEW ELEMENTS CUSTOM ANNOUNCEMENTS\n    const customAnnouncementModal = document.getElementById('custom-announcement-modal');\n    const announcementList = document.getElementById('announcement-list');\n    const announcementSaveBtn = document.getElementById('announcement-save-btn');\n    const announcementCancelBtn = document.getElementById('announcement-cancel-btn');\n    const customAnnouncementBtn = document.getElementById('custom-announcement-btn');\n    // NEW ELEMENTS: Ball Management (ADD THIS BLOCK)\n    const ballManagementBtn = document.getElementById('ball-management-btn');\n    const ballManagementModal = document.getElementById('ball-management-modal');\n    const ballManagementCloseBtn = document.getElementById('ball-management-close-btn');\n    const ballStockCount = document.getElementById('ball-stock-count');\n    const usedBallStockCount = document.getElementById('used-ball-stock-count'); // <-- ADD THIS\n    const addStockBtn = document.getElementById('add-stock-btn');\n    const signOutOptions = document.getElementById('sign-out-options');\n    const signOutMemberModal = document.getElementById('sign-out-member-modal');\n    const signOutMemberList = document.getElementById('sign-out-member-list');\n    const signOutMemberConfirmBtn = document.getElementById('sign-out-member-confirm-btn');\n    const signOutMemberCancelBtn = document.getElementById('sign-out-member-cancel-btn');\n    const returnStockBtn = document.getElementById('return-stock-btn');\n    const returnUsedBallsBtn = document.getElementById('return-used-balls-btn'); // <-- ADD THIS\n    const ballHistoryBtn = document.getElementById('ball-history-btn');\n    const ballHistoryModal = document.getElementById('ball-history-modal');\n    // NEW ELEMENTS: Ball History Detail Modal\n    const ballHistoryDetailModal = document.getElementById('ball-history-detail-modal');\n    const ballDetailContent = document.getElementById('ball-detail-content');\n    const detailStockType = document.getElementById('detail-stock-type');\n    const detailCategory = document.getElementById('detail-category');\n    const detailDatetime = document.getElementById('detail-datetime');\n    const detailCount = document.getElementById('detail-count');\n    const detailCommitteeMember = document.getElementById('detail-committee-member');\n    const detailPurchaser = document.getElementById('detail-purchaser');\n    const detailStockBefore = document.getElementById('detail-stock-before');\n    const detailStockChange = document.getElementById('detail-stock-change');\n    const detailStockAfter = document.getElementById('detail-stock-after');\n    const ballDetailCloseBtn = document.getElementById('ball-detail-close-btn');\n    // --- NEW ELEMENTS FOR BALL SALES FLOW ---\n    const ballSaleTypeModal = document.getElementById('ball-sale-type-modal');\n    const saleTypeCansBtn = document.getElementById('sale-type-cans-btn');\n    const saleTypeSinglesBtn = document.getElementById('sale-type-singles-btn');\n    const saleTypeCancelBtn = document.getElementById('sale-type-cancel-btn');\n    const purchaserSelectionModal = document.getElementById('purchaser-selection-modal');\n    const purchaserMemberList = document.getElementById('purchaser-member-list');\n    const purchaserSelectionPrompt = document.getElementById('purchaser-selection-prompt');\n    const ballHistoryList = document.getElementById('ball-history-list');\n    const ballHistoryCloseBtn = document.getElementById('ball-history-close-btn');\n    const signOutMemberPrompt = document.getElementById('sign-out-member-prompt');\n    const cooldownModal = document.getElementById('cooldown-modal');\n    const cooldownTimer = document.getElementById('cooldown-timer');\n    const cooldownCloseBtn = document.getElementById('cooldown-close-btn');\n    // NEW: Comparison Modal Elements\n    const comparisonModal = document.getElementById('comparison-modal');\n    const comparisonTitle = document.getElementById('comparison-title');\n    const comparisonContent = document.getElementById('comparison-content');\n    const comparisonFilterContainer = document.getElementById('comparison-filter-container');\n    const comparisonCloseBtn = document.getElementById('comparison-close-btn');\n    // NEW: Powerscore modal elements\n    const powerScoreModal = document.getElementById('power-score-modal');\n    const powerScoreList = document.getElementById('power-score-list');\n    const powerScoreBtn = document.getElementById('power-score-btn');\n    const powerScoreCloseBtn = document.getElementById('power-score-close-btn');\n    // NEW ELEMENTS: Suggestion Settings Modal\n    const suggestionSettingsBtn = document.getElementById('suggestion-settings-btn');\n    const suggestionSettingsModal = document.getElementById('suggestion-settings-modal');\n    const suggestionSettingsCloseBtn = document.getElementById('suggestion-settings-close-btn');\n    const femaleRatioSlider = document.getElementById('female-ratio-slider');\n    const femaleRatioDisplay = document.getElementById('female-ratio-display');\n    const maleRatioSlider = document.getElementById('male-ratio-slider');\n    const maleRatioDisplay = document.getElementById('male-ratio-display');\n    const leastPlaytimeToggle = document.getElementById('least-playtime-toggle');\n    const powerScoreOnlyToggle = document.getElementById('power-score-only-toggle');\n    const topPlayerSlider = document.getElementById('top-player-slider');\n    const topPlayerDisplay = document.getElementById('top-player-display');\n    const frequentOpponentSlider = document.getElementById('frequent-opponent-slider');\n    const frequentOpponentDisplay = document.getElementById('frequent-opponent-display');\n    const weakPlayerSlider = document.getElementById('weak-player-slider');\n    const weakPlayerDisplay = document.getElementById('weak-player-display');\n    // References to new containers for disabling\n    const topPlayerContainer = document.querySelector('.top-player-container');\n    const frequentOpponentContainer = document.querySelector('.frequent-opponent-container');\n    const weakPlayerContainer = document.querySelector('.weak-player-container');\n    // NEW ELEMENTS: Admin Checklist Modal\n    const checklistBtn = document.getElementById('checklist-btn');\n    const checklistModal = document.getElementById('checklist-modal');\n    const checklistList = document.getElementById('checklist-list');\n    const checklistCloseBtn = document.getElementById('checklist-close-btn');\n    const checklistContent = document.getElementById('checklist-content'); // New container\n    const checklistHistoryBtn = document.getElementById('checklist-history-btn');\n    const checklistHistoryModal = document.getElementById('checklist-history-modal');\n    const checklistHistoryListView = document.getElementById('checklist-history-list-view');\n    const checklistHistoryDetailView = document.getElementById('checklist-history-detail-view');\n    const checklistHistoryList = document.getElementById('checklist-history-list');\n    const checklistHistoryDetail = document.getElementById('checklist-history-detail');\n    const checklistHistoryTitle = document.getElementById('checklist-history-title');\n    const checklistDetailDate = document.getElementById('checklist-detail-date');\n    const checklistHistoryBackBtn = document.getElementById('checklist-history-back-btn');\n    const checklistHistoryCloseBtn = document.getElementById('checklist-history-close-btn');\n    // References to the container elements for fade effect\n    const leastPlaytimeContainer = document.querySelector('.least-playtime-toggle-container');\n    const femaleRatioContainer = document.querySelector('.female-ratio-container');\n    const maleRatioContainer = document.querySelector('.male-ratio-container');\n    // --- SLIDE DOWN HEADER ---\n    // Auto-hide header (and time overlay) after 3 seconds of no interaction\n    function hideHeader() {\n        if (window.innerWidth > 900) return; // <-- ADD THIS LINE\n        header.classList.add('header-hidden');\n        timeOverlay.classList.add('header-hidden'); // Add this line\n        clearTimeout(headerTimeout);\n    }\n    function startHeaderHideTimer() {\n        if (window.innerWidth > 900) return; // <-- ADD THIS LINE\n        clearTimeout(headerTimeout);\n        headerTimeout = setTimeout(hideHeader, 3000); // Correctly calls the function\n    }\n    // Show header (and time overlay)\n    function showHeader() {\n        if (window.innerWidth > 900) return; // <-- ADD THIS LINE\n        header.classList.remove('header-hidden');\n        timeOverlay.classList.remove('header-hidden'); // Add this line\n        startHeaderHideTimer();\n    }\n    // Handle scroll to show/hide header\n    let ticking = false;\n    function handleScroll() {\n        if (!ticking) {\n            window.requestAnimationFrame(()=>{\n                const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;\n                // Scrolling up - show header\n                if (currentScrollY < lastScrollY) showHeader();\n                else if (currentScrollY > lastScrollY && currentScrollY > 100) {\n                    clearTimeout(headerTimeout);\n                    headerTimeout = setTimeout(hideHeader, 1000); // Correctly calls the function\n                }\n                lastScrollY = currentScrollY;\n                ticking = false;\n            });\n            ticking = true;\n        }\n    }\n    // Touch/drag functionality for mobile\n    function handleTouchStart(e) {\n        touchStartY = e.touches[0].clientY;\n        isDragging = true;\n    }\n    function handleTouchMove(e) {\n        if (!isDragging) return;\n        const touchY = e.touches[0].clientY;\n        const deltaY = touchY - touchStartY;\n        // Dragging down from top - show header\n        if (deltaY > 50 && touchStartY < 50) {\n            showHeader();\n            isDragging = false;\n        }\n    }\n    function handleTouchEnd() {\n        isDragging = false;\n    }\n    // Mouse drag functionality for desktop\n    let mouseStartY = 0;\n    let isMouseDragging = false;\n    function handleMouseDown(e) {\n        mouseStartY = e.clientY;\n        isMouseDragging = true;\n    }\n    function handleMouseMove(e) {\n        if (!isMouseDragging) return;\n        const mouseY = e.clientY;\n        const deltaY = mouseY - mouseStartY;\n        // Dragging down from top - show header\n        if (deltaY > 50 && mouseStartY < 50) {\n            showHeader();\n            isMouseDragging = false;\n        }\n    }\n    function handleMouseUp() {\n        isMouseDragging = false;\n    }\n    // Pull tab click\n    if (headerPullTab) headerPullTab.addEventListener('click', showHeader);\n    // Header mouse enter - keep visible\n    if (header) {\n        header.addEventListener('mouseenter', ()=>{\n            clearTimeout(headerTimeout);\n            header.classList.remove('header-hidden');\n        });\n        header.addEventListener('mouseleave', startHeaderHideTimer);\n    }\n    // Time overlay mouse enter - keep visible\n    if (timeOverlay) {\n        timeOverlay.addEventListener('mouseenter', ()=>{\n            clearTimeout(headerTimeout);\n            header.classList.remove('header-hidden');\n        });\n        timeOverlay.addEventListener('mouseleave', startHeaderHideTimer);\n    }\n    // --- NEW: DRAG-TO-SCROLL FOR HORIZONTAL COURT LIST ---\n    const scrollContainer = document.getElementById('courtsSection');\n    if (scrollContainer) {\n        let isDown = false;\n        let startX;\n        let scrollLeft;\n        // Mouse Events for Desktop\n        scrollContainer.addEventListener('mousedown', (e)=>{\n            isDown = true;\n            scrollContainer.style.cursor = 'grabbing';\n            startX = e.pageX - scrollContainer.offsetLeft;\n            scrollLeft = scrollContainer.scrollLeft;\n        });\n        scrollContainer.addEventListener('mouseleave', ()=>{\n            isDown = false;\n            scrollContainer.style.cursor = 'grab';\n        });\n        scrollContainer.addEventListener('mouseup', ()=>{\n            isDown = false;\n            scrollContainer.style.cursor = 'grab';\n        });\n        scrollContainer.addEventListener('mousemove', (e)=>{\n            if (!isDown) return;\n            e.preventDefault();\n            const x = e.pageX - scrollContainer.offsetLeft;\n            const walk = (x - startX) * 2; // The multiplier '2' makes the scroll faster\n            scrollContainer.scrollLeft = scrollLeft - walk;\n        });\n        // Touch Events for Mobile\n        scrollContainer.addEventListener('touchstart', (e)=>{\n            isDown = true;\n            startX = e.touches[0].pageX - scrollContainer.offsetLeft;\n            scrollLeft = scrollContainer.scrollLeft;\n        }, {\n            passive: true\n        }); // Use passive listener for better scroll performance\n        scrollContainer.addEventListener('touchend', ()=>{\n            isDown = false;\n        });\n        scrollContainer.addEventListener('touchmove', (e)=>{\n            if (!isDown) return;\n            const x = e.touches[0].pageX - scrollContainer.offsetLeft;\n            const walk = (x - startX) * 2;\n            scrollContainer.scrollLeft = scrollLeft - walk;\n        }, {\n            passive: true\n        });\n    }\n    function setActiveMobileMenuItem(buttonId) {\n        if (window.innerWidth > 900) return; // Only on mobile\n        document.querySelectorAll('.mobile-menu-btn').forEach((btn)=>{\n            btn.classList.remove('active');\n        });\n        const activeBtn = document.getElementById(buttonId);\n        if (activeBtn) activeBtn.classList.add('active');\n    }\n    // --- MODIFIED: ACTIVE CARD STYLING ON HORIZONTAL SCROLL ---\n    const scrollSnapContainer = document.getElementById('courtsSection');\n    if (scrollSnapContainer) {\n        let scrollTimeout;\n        // Set the active card on initial load\n        setTimeout(setActiveCardForMobileScroll, 200);\n        scrollSnapContainer.addEventListener('scroll', ()=>{\n            clearTimeout(scrollTimeout);\n            // Run the logic only after the user has stopped scrolling (snapped to a card)\n            scrollTimeout = setTimeout(setActiveCardForMobileScroll, 150);\n        });\n    }\n    // --- NEW: REUSABLE FUNCTION TO SET THE ACTIVE SCROLLING CARD ---\n    function setActiveCardForMobileScroll() {\n        const scrollSnapContainer = document.getElementById('courtsSection');\n        if (!scrollSnapContainer) return;\n        // Check if the screen is in mobile view (where this feature is active)\n        if (window.innerWidth >= 900) {\n            // On desktop, ensure all cards are reset to their normal state\n            const cards = scrollSnapContainer.querySelectorAll('.summary-card, .court-card');\n            cards.forEach((card)=>card.classList.remove('is-active-card'));\n            return;\n        }\n        const containerRect = scrollSnapContainer.getBoundingClientRect();\n        const containerCenter = containerRect.left + containerRect.width / 2;\n        let closestCard = null;\n        let minDistance = Infinity;\n        const cards = scrollSnapContainer.querySelectorAll('.summary-card, .court-card');\n        cards.forEach((card)=>{\n            const cardRect = card.getBoundingClientRect();\n            const cardCenter = cardRect.left + cardRect.width / 2;\n            const distance = Math.abs(containerCenter - cardCenter);\n            if (distance < minDistance) {\n                minDistance = distance;\n                closestCard = card;\n            }\n        });\n        if (closestCard) {\n            // Remove active class from all other cards\n            cards.forEach((card)=>card.classList.remove('is-active-card'));\n            // Add active class to the new card\n            closestCard.classList.add('is-active-card');\n        }\n    }\n    // --- NEW FUNCTION: Scrolls to the first available court ---\n    function scrollToFirstAvailableCourt() {\n        // Only run this logic on mobile view where horizontal scrolling is active\n        if (window.innerWidth >= 900) return;\n        const courtId1 = findNextAvailableCourtId(); // Uses your existing hierarchy logic\n        if (courtId1) {\n            const courtCard = document.querySelector(`.court-card[data-court-id=\"${courtId1}\"]`);\n            if (courtCard) // Smoothly scroll the found court card to the center of the view\n            courtCard.scrollIntoView({\n                behavior: 'smooth',\n                block: 'nearest',\n                inline: 'center'\n            });\n        }\n    }\n    function scrollToSummaryCard() {\n        // Only run this logic on mobile view\n        if (window.innerWidth < 900) {\n            const summaryCard = document.querySelector('.summary-card');\n            if (summaryCard) // Smoothly scroll the summary card to the start of the view\n            summaryCard.scrollIntoView({\n                behavior: 'smooth',\n                block: 'nearest',\n                inline: 'start'\n            });\n        }\n    }\n    // --- NEW FUNCTION: Automatically expands the player list on mobile ---\n    function expandPlayerListOnMobile() {\n        // Only run this logic on mobile view if the list is currently collapsed\n        if (window.innerWidth < 900 && !state.mobileControls.isPlayersExpanded) {\n            state.mobileControls.isPlayersExpanded = true; // Update the state\n            // Directly manipulate the DOM to trigger the expansion\n            const playersSection = document.getElementById('availablePlayersSection');\n            const playersToggleIcon = document.querySelector('#players-toggle-btn i');\n            if (playersSection) playersSection.classList.remove('is-collapsed');\n            if (playersToggleIcon) playersToggleIcon.className = 'mdi mdi-chevron-up';\n            saveState(); // Save the new expanded state\n        }\n    }\n    // --- NEW FUNCTION: Automatically collapses the player list on mobile when selection is complete ---\n    function collapsePlayerListOnMobile() {\n        // Only run this logic on mobile view\n        if (window.innerWidth < 900 && state.mobileControls.isPlayersExpanded) {\n            state.mobileControls.isPlayersExpanded = false; // Update the state\n            // Directly manipulate the DOM to trigger the collapse\n            const playersSection = document.getElementById('availablePlayersSection');\n            const playersToggleIcon = document.querySelector('#players-toggle-btn i');\n            if (playersSection) playersSection.classList.add('is-collapsed');\n            if (playersToggleIcon) playersToggleIcon.className = 'mdi mdi-chevron-down';\n            saveState(); // Save the new collapsed state\n        }\n    }\n    // --- NEW: Central function to enforce all queue logic (Duty & Gender) ---\n    function enforceQueueLogic() {\n        if (state.availablePlayers.length < 2) return; // Not enough players for any logic to apply.\n        const players = state.availablePlayers;\n        // --- PART 1: On-Duty Member Logic (Existing Logic) ---\n        if (state.onDuty !== 'None') {\n            const firstActiveIndex = players.findIndex((p)=>!p.isPaused);\n            if (firstActiveIndex !== -1 && players[firstActiveIndex].name === state.onDuty) {\n                const targetSwapIndex = players.findIndex((p, index)=>index > firstActiveIndex && !p.isPaused && p.name !== state.onDuty);\n                if (targetSwapIndex !== -1) // Perform the swap\n                [players[firstActiveIndex], players[targetSwapIndex]] = [\n                    players[targetSwapIndex],\n                    players[firstActiveIndex]\n                ];\n            }\n        }\n        // --- PART 2: Gender Balancing Logic (New & Improved Logic) ---\n        const selectorPlayer = players.find((p)=>!p.isPaused);\n        if (!selectorPlayer) return; // No active selector\n        const selectableGroupBaseSize = 7;\n        const selectorIndex = players.indexOf(selectorPlayer);\n        // Check if there are enough players after the selector to form a group\n        if (players.length - 1 - selectorIndex >= selectableGroupBaseSize) {\n            const playersAfterSelector = players.slice(selectorIndex + 1);\n            const availableInSelectableRange = playersAfterSelector.filter((p)=>!p.isPaused).slice(0, selectableGroupBaseSize);\n            const sameGenderCountInRange = availableInSelectableRange.filter((p)=>p.gender === selectorPlayer.gender).length;\n            // IF a gender imbalance is detected (0 or 1 same-gender players in the next 7)...\n            if (sameGenderCountInRange <= 1) {\n                const endOfRangeIndex = players.indexOf(availableInSelectableRange[availableInSelectableRange.length - 1]);\n                // Search for the next available, non-paused, same-gender player *after* the current selection box\n                const searchPool = players.slice(endOfRangeIndex + 1);\n                const nextSuitablePlayerIndexInPool = searchPool.findIndex((p)=>p.gender === selectorPlayer.gender && !p.isPaused);\n                if (nextSuitablePlayerIndexInPool !== -1) {\n                    // We found a player to move!\n                    const originalIndexOfPlayerToMove = endOfRangeIndex + 1 + nextSuitablePlayerIndexInPool;\n                    const [playerToMove] = players.splice(originalIndexOfPlayerToMove, 1);\n                    // Insert them at the end of the orange selection box (position #8, which is index 7 relative to the selector)\n                    const insertionIndex = Math.min(selectorIndex + 1 + selectableGroupBaseSize, players.length);\n                    players.splice(insertionIndex, 0, playerToMove);\n                }\n            }\n        }\n    }\n    // --- DYNAMIC HEIGHT FUNCTION ---\n    function setPlayerListHeight() {\n        const courtGridEl = document.getElementById('court-grid');\n        const referenceCard = courtGridEl.querySelector('.court-card, .summary-card');\n        const courtGridStyles = window.getComputedStyle(courtGridEl);\n        // Determine the number of columns currently being used by the grid.\n        const courtColumnCount = courtGridStyles.gridTemplateColumns.split(' ').length;\n        // If no reference card is found, or if the layout is stacked (1 column or fewer than 2), \n        // set height to auto and exit.\n        if (!referenceCard || courtColumnCount < 2) {\n            availablePlayersSection.style.height = 'auto';\n            return;\n        }\n        // Measure the actual height of the court grid container.\n        // This accurately captures the total space of all cards + gaps now that CSS forces equal rows.\n        const totalHeight = courtGridEl.offsetHeight;\n        // Set the available players section height to match.\n        availablePlayersSection.style.height = `${totalHeight}px`;\n    }\n    // --- CORE FUNCTIONS ---\n    function getAllKnownPlayers() {\n        const playersOnCourt = state.courts.flatMap((court)=>court.players);\n        const allPlayers = [\n            ...state.clubMembers,\n            ...state.availablePlayers,\n            ...playersOnCourt\n        ];\n        const uniquePlayers = Array.from(new Map(allPlayers.map((p)=>[\n                p.name,\n                p\n            ])).values());\n        state.gameHistory.forEach((game)=>{\n            [\n                ...game.teams.team1,\n                ...game.teams.team2\n            ].forEach((name)=>{\n                if (!uniquePlayers.some((p)=>p.name === name)) uniquePlayers.push({\n                    name: name,\n                    gender: '?',\n                    guest: true\n                });\n            });\n        });\n        return uniquePlayers;\n    }\n    function getPlayerRank(playerName, playerGender) {\n        const todaysGames = state.gameHistory.filter((game)=>{\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\n            return gameDate === new Date().toISOString().split('T')[0];\n        });\n        const allStats = calculatePlayerStats(todaysGames);\n        const allPlayers = getAllKnownPlayers();\n        const leaderboardPlayers = Object.keys(allStats).map((name)=>{\n            const player = allPlayers.find((p)=>p.name === name);\n            return {\n                name,\n                ...allStats[name],\n                gender: player ? player.gender : '?',\n                onLeaderboard: player ? player.onLeaderboard : false\n            };\n        }).filter((p)=>p.onLeaderboard && p.gender === playerGender).sort((a, b)=>{\n            const winPctA = a.played > 0 ? a.won / a.played : 0;\n            const winPctB = b.played > 0 ? b.won / b.played : 0;\n            if (winPctB !== winPctA) return winPctB - winPctA;\n            return b.totalDurationMs - a.totalDurationMs;\n        });\n        const rank = leaderboardPlayers.findIndex((p)=>p.name === playerName) + 1;\n        return rank > 0 ? rank : null;\n    }\n    function findBestAndWorstMatches(playerName) {\n        const todaysGames = state.gameHistory.filter((game)=>{\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\n            return gameDate === new Date().toISOString().split('T')[0];\n        });\n        const playerGames = todaysGames.filter((game)=>(game.teams.team1.includes(playerName) || game.teams.team2.includes(playerName)) && game.score);\n        if (playerGames.length === 0) return {\n            best: null,\n            worst: null\n        };\n        let bestMatch = {\n            scoreDiff: -Infinity,\n            text: ''\n        };\n        let worstMatch = {\n            scoreDiff: Infinity,\n            text: ''\n        };\n        playerGames.forEach((game)=>{\n            const isTeam1 = game.teams.team1.includes(playerName);\n            const playerScore = isTeam1 ? game.score.team1 : game.score.team2;\n            const opponentScore = isTeam1 ? game.score.team2 : game.score.team1;\n            const scoreDiff = playerScore - opponentScore;\n            const outcome = scoreDiff > 0 ? 'Won' : 'Lost';\n            const scoreText = `${outcome} ${playerScore}-${opponentScore}`;\n            if (scoreDiff > bestMatch.scoreDiff) bestMatch = {\n                scoreDiff,\n                text: scoreText\n            };\n            if (scoreDiff < worstMatch.scoreDiff) worstMatch = {\n                scoreDiff,\n                text: scoreText\n            };\n        });\n        return {\n            best: bestMatch.text,\n            worst: worstMatch.text\n        };\n    }\n    /**\r\n     * Finds the opponent a player has played against most frequently.\r\n     * @param {string} playerName The name of the player.\r\n     * @param {Array} gameHistory The game history array.\r\n     * @returns {string|null} The name of the most frequent opponent, or null if none found.\r\n     */ function findFrequentOpponent(playerName, gameHistory) {\n        const opponentCounts = {};\n        let maxCount = 0;\n        let frequentOpponent = null;\n        gameHistory.forEach((game)=>{\n            // Skip skipped games or games without teams\n            if (game.winner === 'skipped' || !game.teams.team1 || !game.teams.team2) return;\n            const team1 = game.teams.team1;\n            const team2 = game.teams.team2;\n            let opponents = [];\n            if (team1.includes(playerName)) opponents = team2;\n            else if (team2.includes(playerName)) opponents = team1;\n            opponents.forEach((opponentName)=>{\n                opponentCounts[opponentName] = (opponentCounts[opponentName] || 0) + 1;\n                if (opponentCounts[opponentName] > maxCount) {\n                    maxCount = opponentCounts[opponentName];\n                    frequentOpponent = opponentName;\n                }\n            });\n        });\n        // Require a minimum number of games against an opponent to consider them \"frequent\"\n        return maxCount >= 2 ? frequentOpponent : null;\n    }\n    /**\r\n     * Determines if a player is considered \"weak\" based on their power score.\r\n     * @param {number} playerScore The player's calculated power score.\r\n     * @param {number} threshold The power score threshold from settings.\r\n     * @returns {boolean} True if the player's score is below the threshold.\r\n     */ function isWeakPlayer(playerScore, threshold) {\n        return playerScore < threshold;\n    }\n    function getPlayerByName(name) {\n        let player = state.availablePlayers.find((p)=>p.name === name);\n        if (player) return player;\n        player = MASTER_MEMBER_LIST.find((p)=>p.name === name);\n        if (player) return player;\n        for (const court of state.courts){\n            player = court.players.find((p)=>p.name === name);\n            if (player) return player;\n        }\n        return {\n            name: name,\n            gender: '?',\n            guest: true,\n            isPaused: false\n        };\n    }\n    function getPlayerNames(playerObjects) {\n        return playerObjects.map((p)=>p.name);\n    }\n    function totalPlayersAtClub() {\n        let total = state.availablePlayers.length;\n        state.courts.forEach((court)=>{\n            if (court.players) total += court.players.length;\n        });\n        return total;\n    }\n    // Helper function to count only active (non-paused) players\n    function getActivePlayerCount() {\n        return state.availablePlayers.filter((p)=>!p.isPaused).length;\n    }\n    // Modified to use API instead of localStorage\n    async function saveState() {\n        // Don't save if we're currently receiving an update from WebSocket\n        if (state._isReceivingUpdate) return;\n        try {\n            await API.saveState(state);\n            console.log('State saved to server');\n        } catch (error) {\n            console.error('Failed to save state:', error);\n        }\n    }\n    // ================================\n    // UNDO SYSTEM FUNCTIONS\n    // ================================\n    function showUndoToast(message, undoAction) {\n        const undoToast = document.getElementById('undo-toast');\n        const undoToastMessage = document.getElementById('undo-toast-message');\n        const undoToastBtn = document.getElementById('undo-toast-btn');\n        const undoToastTimer = document.getElementById('undo-toast-timer');\n        // Clear any existing toast\n        hideUndoToast();\n        // Set message\n        undoToastMessage.textContent = message;\n        // Store the undo action OUTSIDE of state (functions can't be serialized)\n        currentUndoAction = undoAction;\n        // Show toast\n        undoToast.classList.remove('hidden');\n        // Reset timer animation\n        undoToastTimer.style.transition = 'none';\n        undoToastTimer.style.width = '100%';\n        setTimeout(()=>{\n            undoToastTimer.style.transition = 'width 10s linear';\n            undoToastTimer.style.width = '0';\n        }, 50);\n        // Auto-hide after 10 seconds\n        currentUndoTimeout = setTimeout(()=>{\n            hideUndoToast();\n        }, 10000);\n        // Attach undo handler\n        undoToastBtn.onclick = ()=>{\n            if (currentUndoAction && typeof currentUndoAction === 'function') {\n                currentUndoAction();\n                hideUndoToast();\n            }\n        };\n    }\n    function hideUndoToast() {\n        const undoToast = document.getElementById('undo-toast');\n        if (currentUndoTimeout) {\n            clearTimeout(currentUndoTimeout);\n            currentUndoTimeout = null;\n        }\n        undoToast.classList.add('hidden');\n        currentUndoAction = null;\n    }\n    function addToUndoHistory(actionType, actionData, undoFunction) {\n        const action = {\n            type: actionType,\n            data: actionData,\n            timestamp: Date.now(),\n            undo: undoFunction\n        };\n        state.undoHistory.actions.unshift(action);\n        // Keep only last N actions\n        if (state.undoHistory.actions.length > state.undoHistory.maxHistory) state.undoHistory.actions = state.undoHistory.actions.slice(0, state.undoHistory.maxHistory);\n        saveState();\n    }\n    // ================================\n    // SWAP PLAYER MODAL FUNCTIONS\n    // ================================\n    function showSwapPlayerModal(sourceCourt) {\n        const court = state.courts.find((c)=>c.id === sourceCourt);\n        if (!court || court.status !== 'in_progress') return;\n        const swapPlayerModal = document.getElementById('swap-player-modal');\n        const swapSourcePlayer = document.getElementById('swap-source-player');\n        const swapTargetList = document.getElementById('swap-target-list');\n        const swapInstructions = document.getElementById('swap-player-instructions');\n        // Store source court in modal data\n        swapPlayerModal.dataset.sourceCourt = sourceCourt;\n        // Show source court players\n        swapInstructions.textContent = `Select a player from Court ${sourceCourt} to swap:`;\n        swapSourcePlayer.innerHTML = '';\n        court.players.forEach((player)=>{\n            const playerDiv = document.createElement('div');\n            playerDiv.className = 'swap-player-option';\n            playerDiv.innerHTML = `\n                <div class=\"player-info\">${player.name}</div>\n                <div class=\"court-info\">Court ${sourceCourt} \\u{2022} ${player.gender}</div>\n            `;\n            playerDiv.onclick = ()=>showSwapTargetSelection(sourceCourt, player);\n            playerDiv.style.cursor = 'pointer';\n            playerDiv.style.padding = '0.75rem';\n            playerDiv.style.margin = '0.5rem 0';\n            playerDiv.style.borderRadius = '6px';\n            playerDiv.style.transition = 'background-color 0.2s';\n            playerDiv.onmouseenter = ()=>playerDiv.style.backgroundColor = '#d0e7ff';\n            playerDiv.onmouseleave = ()=>playerDiv.style.backgroundColor = 'transparent';\n            swapSourcePlayer.appendChild(playerDiv);\n        });\n        // Hide the manage players modal\n        manageCourtPlayersModal.classList.add('hidden');\n        // Show swap modal\n        swapPlayerModal.classList.remove('hidden');\n    }\n    function showSwapTargetSelection(sourceCourt, sourcePlayer) {\n        const swapPlayerModal = document.getElementById('swap-player-modal');\n        const swapSourcePlayer = document.getElementById('swap-source-player');\n        const swapTargetList = document.getElementById('swap-target-list');\n        const swapInstructions = document.getElementById('swap-player-instructions');\n        // Update instructions\n        swapInstructions.textContent = `Swap ${sourcePlayer.name} with:`;\n        // Show selected source player\n        swapSourcePlayer.innerHTML = `\n            <div class=\"player-info\">${sourcePlayer.name}</div>\n            <div class=\"court-info\">Court ${sourceCourt} \\u{2022} ${sourcePlayer.gender}</div>\n        `;\n        // Store source player in modal data\n        swapPlayerModal.dataset.sourcePlayer = JSON.stringify(sourcePlayer);\n        // Get all players from other in-progress courts\n        swapTargetList.innerHTML = '';\n        const otherCourts = state.courts.filter((c)=>c.id !== sourceCourt && c.status === 'in_progress' && c.players.length > 0);\n        if (otherCourts.length === 0) {\n            swapTargetList.innerHTML = '<li style=\"justify-content: center; color: var(--neutral-color);\">No other courts in progress</li>';\n            return;\n        }\n        otherCourts.forEach((court)=>{\n            court.players.forEach((player)=>{\n                const li = document.createElement('li');\n                li.innerHTML = `\n                    <span class=\"player-name\">${player.name}</span>\n                    <span class=\"gender-label\">${player.gender}</span>\n                    <span class=\"court-label\">Court ${court.id}</span>\n                `;\n                li.onclick = ()=>confirmPlayerSwap(sourceCourt, sourcePlayer, court.id, player);\n                swapTargetList.appendChild(li);\n            });\n        });\n    }\n    function confirmPlayerSwap(sourceCourt, sourcePlayer, targetCourtId, targetPlayer) {\n        const swapConfirmModal = document.getElementById('swap-confirm-modal');\n        const swapConfirmDetails = document.getElementById('swap-confirm-details');\n        // Store swap data\n        swapConfirmModal.dataset.swapData = JSON.stringify({\n            sourceCourt,\n            sourcePlayer,\n            targetCourt: targetCourtId,\n            targetPlayer\n        });\n        // Show confirmation details\n        swapConfirmDetails.innerHTML = `\n            <div class=\"swap-row\">\n                <div class=\"player-card\">\n                    <div class=\"name\">${sourcePlayer.name}</div>\n                    <div class=\"court\">Court ${sourceCourt}</div>\n                </div>\n                <div class=\"swap-arrow\">\\u{21C4}</div>\n                <div class=\"player-card\">\n                    <div class=\"name\">${targetPlayer.name}</div>\n                    <div class=\"court\">Court ${targetCourtId}</div>\n                </div>\n            </div>\n        `;\n        // Hide swap player modal, show confirmation\n        document.getElementById('swap-player-modal').classList.add('hidden');\n        swapConfirmModal.classList.remove('hidden');\n    }\n    function executePlayerSwap() {\n        const swapConfirmModal = document.getElementById('swap-confirm-modal');\n        const swapData = JSON.parse(swapConfirmModal.dataset.swapData);\n        const { sourceCourt, sourcePlayer, targetCourt, targetPlayer } = swapData;\n        const sourceCourtObj = state.courts.find((c)=>c.id === sourceCourt);\n        const targetCourtObj = state.courts.find((c)=>c.id === targetCourt);\n        if (!sourceCourtObj || !targetCourtObj) return;\n        // Find player indices\n        const sourcePlayerIndex = sourceCourtObj.players.findIndex((p)=>p.name === sourcePlayer.name);\n        const targetPlayerIndex = targetCourtObj.players.findIndex((p)=>p.name === targetPlayer.name);\n        if (sourcePlayerIndex === -1 || targetPlayerIndex === -1) return;\n        // Store original state for undo\n        const originalSourcePlayers = JSON.parse(JSON.stringify(sourceCourtObj.players));\n        const originalTargetPlayers = JSON.parse(JSON.stringify(targetCourtObj.players));\n        const originalSourceTeams = JSON.parse(JSON.stringify(sourceCourtObj.teams));\n        const originalTargetTeams = JSON.parse(JSON.stringify(targetCourtObj.teams));\n        // Perform the swap\n        const tempPlayer = sourceCourtObj.players[sourcePlayerIndex];\n        sourceCourtObj.players[sourcePlayerIndex] = targetCourtObj.players[targetPlayerIndex];\n        targetCourtObj.players[targetPlayerIndex] = tempPlayer;\n        // Update teams if they are set\n        if (sourceCourtObj.teamsSet) updateTeamsAfterSwap(sourceCourtObj, sourcePlayer.name, targetPlayer.name);\n        if (targetCourtObj.teamsSet) updateTeamsAfterSwap(targetCourtObj, targetPlayer.name, sourcePlayer.name);\n        // Create undo function\n        const undoFunction = ()=>{\n            console.log('=== EXECUTING UNDO ===');\n            // Set flag to prevent WebSocket interference\n            localChangeInProgress = true;\n            // Find the court fresh from state\n            const courtToRestore = state.courts.find((c)=>c.id === courtId);\n            if (!courtToRestore) {\n                console.error('Court not found for undo!');\n                localChangeInProgress = false;\n                return;\n            }\n            console.log('Before restore:', JSON.parse(JSON.stringify(courtToRestore)));\n            console.log('Restoring to:', originalPlayers, originalTeams);\n            // Restore the original state\n            courtToRestore.players = JSON.parse(JSON.stringify(originalPlayers));\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalTeams));\n            console.log('After restore:', JSON.parse(JSON.stringify(courtToRestore)));\n            render();\n            saveState();\n            // Clear flag after a short delay to allow saveState to complete\n            setTimeout(()=>{\n                localChangeInProgress = false;\n                console.log('Undo complete - flag cleared');\n            }, 500);\n        };\n        // Add to undo history\n        addToUndoHistory('player_swap', swapData, undoFunction);\n        // Show undo toast\n        showUndoToast(`Swapped ${sourcePlayer.name} (Court ${sourceCourt}) \\u{2194} ${targetPlayer.name} (Court ${targetCourt})`, undoFunction);\n        // Close modals and update UI\n        swapConfirmModal.classList.add('hidden');\n        render();\n        saveState();\n    }\n    function updateTeamsAfterSwap(court, oldPlayerName, newPlayerName) {\n        // Find which team the old player was on and replace with new player\n        const team1Index = court.teams.team1.findIndex((p)=>p.name === oldPlayerName);\n        const team2Index = court.teams.team2.findIndex((p)=>p.name === oldPlayerName);\n        const newPlayerObj = court.players.find((p)=>p.name === newPlayerName);\n        if (team1Index !== -1) court.teams.team1[team1Index] = newPlayerObj;\n        else if (team2Index !== -1) court.teams.team2[team2Index] = newPlayerObj;\n    }\n    // ================================\n    // DRAG & DROP HANDLER FUNCTIONS\n    // ================================\n    function handlePlayerDragStart(e) {\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        if (!playerSpot) return;\n        // Only allow drag if this player was double-clicked (enabled)\n        if (!playerSpot.classList.contains('drag-enabled')) {\n            e.preventDefault();\n            return;\n        }\n        draggedPlayer = {\n            name: playerSpot.dataset.playerName,\n            courtId: playerSpot.dataset.courtId,\n            position: playerSpot.dataset.playerPos,\n            team: playerSpot.dataset.team || null\n        };\n        playerSpot.classList.add('dragging');\n        // Set drag data\n        e.dataTransfer.effectAllowed = 'move';\n        e.dataTransfer.setData('text/plain', draggedPlayer.name);\n        // Make drag image semi-transparent\n        if (e.dataTransfer.setDragImage) {\n            const dragImage = playerSpot.cloneNode(true);\n            dragImage.style.opacity = '0.7';\n            document.body.appendChild(dragImage);\n            e.dataTransfer.setDragImage(dragImage, 0, 0);\n            setTimeout(()=>document.body.removeChild(dragImage), 0);\n        }\n    }\n    function handlePlayerDoubleClick(e) {\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        if (!playerSpot) return;\n        // Clear any previously enabled player\n        document.querySelectorAll('.player-spot.drag-enabled').forEach((spot)=>{\n            spot.classList.remove('drag-enabled');\n        });\n        // If clicking the same player that was already enabled, disable it\n        if (activeDraggablePlayer === playerSpot) {\n            activeDraggablePlayer = null;\n            return;\n        }\n        // Enable this player for dragging\n        playerSpot.classList.add('drag-enabled');\n        activeDraggablePlayer = playerSpot;\n        // Auto-disable after 10 seconds if not used\n        setTimeout(()=>{\n            if (playerSpot.classList.contains('drag-enabled')) {\n                playerSpot.classList.remove('drag-enabled');\n                if (activeDraggablePlayer === playerSpot) activeDraggablePlayer = null;\n            }\n        }, 10000);\n    }\n    function handlePlayerDragEnd(e) {\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        if (playerSpot) {\n            playerSpot.classList.remove('dragging');\n            playerSpot.classList.remove('drag-enabled'); // Clear enabled state after drag\n        }\n        // Clear all drag-over highlights\n        document.querySelectorAll('.drag-over, .drag-over-invalid').forEach((el)=>{\n            el.classList.remove('drag-over', 'drag-over-invalid');\n        });\n        draggedPlayer = null;\n        dragOverTarget = null;\n        activeDraggablePlayer = null; // Clear active draggable\n    }\n    function handlePlayerDragOver(e) {\n        e.preventDefault(); // Allow drop\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\n        if (!draggedPlayer) return;\n        // --- SCENARIO 1: Dragging over another player on a court ---\n        if (playerSpot && playerSpot.dataset.playerName) {\n            const targetCourtId = playerSpot.dataset.courtId;\n            const targetPlayerName = playerSpot.dataset.playerName;\n            // Don't allow dropping on self\n            if (targetPlayerName === draggedPlayer.name) {\n                e.dataTransfer.dropEffect = 'none';\n                return;\n            }\n            const sameCourt = targetCourtId === draggedPlayer.courtId;\n            if (sameCourt) {\n                // Team reselection within same court\n                playerSpot.classList.add('drag-over');\n                playerSpot.classList.remove('drag-over-invalid');\n                e.dataTransfer.dropEffect = 'move';\n            } else {\n                // Player swap between courts\n                const targetCourt = state.courts.find((c)=>c.id === targetCourtId);\n                const sourceCourt = state.courts.find((c)=>c.id === draggedPlayer.courtId);\n                // Only allow if both courts are in_progress\n                if (targetCourt?.status === 'in_progress' && sourceCourt?.status === 'in_progress') {\n                    playerSpot.classList.add('drag-over');\n                    playerSpot.classList.remove('drag-over-invalid');\n                    e.dataTransfer.dropEffect = 'move';\n                } else {\n                    playerSpot.classList.add('drag-over-invalid');\n                    playerSpot.classList.remove('drag-over');\n                    e.dataTransfer.dropEffect = 'none';\n                }\n            }\n            dragOverTarget = playerSpot;\n        } else if (availablePlayerLi && !availablePlayerLi.classList.contains('waiting-message')) {\n            const targetPlayerName = availablePlayerLi.dataset.playerName;\n            // Don't allow if dragging from available to available\n            if (!draggedPlayer.courtId) {\n                availablePlayerLi.classList.add('drag-over-invalid');\n                e.dataTransfer.dropEffect = 'none';\n                return;\n            }\n            // Check if court is in_progress\n            const sourceCourt = state.courts.find((c)=>c.id === draggedPlayer.courtId);\n            if (sourceCourt?.status === 'in_progress') {\n                availablePlayerLi.classList.add('drag-over');\n                availablePlayerLi.classList.remove('drag-over-invalid');\n                e.dataTransfer.dropEffect = 'move';\n            } else {\n                availablePlayerLi.classList.add('drag-over-invalid');\n                availablePlayerLi.classList.remove('drag-over');\n                e.dataTransfer.dropEffect = 'none';\n            }\n            dragOverTarget = availablePlayerLi;\n        }\n    }\n    function handlePlayerDragLeave(e) {\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\n        if (playerSpot) playerSpot.classList.remove('drag-over', 'drag-over-invalid');\n        if (availablePlayerLi) availablePlayerLi.classList.remove('drag-over', 'drag-over-invalid');\n    }\n    function handlePlayerDrop(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        if (!draggedPlayer) return;\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\n        // Clear highlights\n        document.querySelectorAll('.drag-over, .drag-over-invalid').forEach((el)=>{\n            el.classList.remove('drag-over', 'drag-over-invalid');\n        });\n        // --- SCENARIO 1: Dropped on another player on a court ---\n        if (playerSpot && playerSpot.dataset.playerName) {\n            const targetCourtId = playerSpot.dataset.courtId;\n            const targetPlayerName = playerSpot.dataset.playerName;\n            const sameCourt = targetCourtId === draggedPlayer.courtId;\n            if (targetPlayerName === draggedPlayer.name) return; // Same player\n            if (sameCourt) // Team reselection - swap positions within same court\n            executeTeamReselectionSwap(draggedPlayer.courtId, draggedPlayer.name, targetPlayerName);\n            else {\n                // Player swap between different courts\n                const targetCourt = state.courts.find((c)=>c.id === targetCourtId);\n                const sourceCourt = state.courts.find((c)=>c.id === draggedPlayer.courtId);\n                if (targetCourt?.status === 'in_progress' && sourceCourt?.status === 'in_progress') executePlayerSwapBetweenCourts(draggedPlayer.courtId, draggedPlayer.name, targetCourtId, targetPlayerName);\n            }\n        } else if (availablePlayerLi && !availablePlayerLi.classList.contains('waiting-message')) {\n            const targetPlayerName = availablePlayerLi.dataset.playerName;\n            const sourceCourt = state.courts.find((c)=>c.id === draggedPlayer.courtId);\n            if (sourceCourt?.status === 'in_progress') executePlayerSubstitution(draggedPlayer.courtId, draggedPlayer.name, targetPlayerName);\n        }\n        draggedPlayer = null;\n        dragOverTarget = null;\n    }\n    // ================================\n    // DRAG & DROP EXECUTION FUNCTIONS\n    // ================================\n    function executeTeamReselectionSwap(courtId1, player1Name, player2Name) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court) return;\n        // Store original state for undo\n        const originalPlayers1 = JSON.parse(JSON.stringify(court.players));\n        const originalTeams1 = JSON.parse(JSON.stringify(court.teams));\n        // Find player indices\n        const player1Index = court.players.findIndex((p)=>p.name === player1Name);\n        const player2Index = court.players.findIndex((p)=>p.name === player2Name);\n        if (player1Index === -1 || player2Index === -1) return;\n        // Swap players in main array\n        const temp = court.players[player1Index];\n        court.players[player1Index] = court.players[player2Index];\n        court.players[player2Index] = temp;\n        // Update teams if they're set\n        if (court.teamsSet) {\n            // Find which teams these players are on and swap them\n            let player1Team = null, player1TeamIndex = -1;\n            let player2Team = null, player2TeamIndex = -1;\n            court.teams.team1.forEach((p, i)=>{\n                if (p.name === player1Name) {\n                    player1Team = 'team1';\n                    player1TeamIndex = i;\n                }\n                if (p.name === player2Name) {\n                    player2Team = 'team1';\n                    player2TeamIndex = i;\n                }\n            });\n            court.teams.team2.forEach((p, i)=>{\n                if (p.name === player1Name) {\n                    player1Team = 'team2';\n                    player1TeamIndex = i;\n                }\n                if (p.name === player2Name) {\n                    player2Team = 'team2';\n                    player2TeamIndex = i;\n                }\n            });\n            // Swap in teams\n            if (player1Team && player2Team) {\n                const p1 = court.teams[player1Team][player1TeamIndex];\n                const p2 = court.teams[player2Team][player2TeamIndex];\n                court.teams[player1Team][player1TeamIndex] = p2;\n                court.teams[player2Team][player2TeamIndex] = p1;\n            }\n        }\n        // Create undo function\n        const undoFunction = ()=>{\n            console.log('=== EXECUTING UNDO ===');\n            // Set flag to prevent WebSocket interference\n            localChangeInProgress = true;\n            // Find the court fresh from state\n            const courtToRestore = state.courts.find((c)=>c.id === courtId1);\n            if (!courtToRestore) {\n                console.error('Court not found for undo!');\n                localChangeInProgress = false;\n                return;\n            }\n            console.log('Before restore:', JSON.parse(JSON.stringify(courtToRestore)));\n            console.log('Restoring to:', originalPlayers1, originalTeams1);\n            // Restore the original state\n            courtToRestore.players = JSON.parse(JSON.stringify(originalPlayers1));\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalTeams1));\n            console.log('After restore:', JSON.parse(JSON.stringify(courtToRestore)));\n            render();\n            saveState();\n            // Clear flag after a short delay to allow saveState to complete\n            setTimeout(()=>{\n                localChangeInProgress = false;\n                console.log('Undo complete - flag cleared');\n            }, 500);\n        };\n        // Add to undo history\n        addToUndoHistory('team_reselection', {\n            courtId: courtId1,\n            player1Name,\n            player2Name\n        }, undoFunction);\n        // Show undo toast\n        showUndoToast(`Swapped ${player1Name.split(' ')[0]} \\u{2194} ${player2Name.split(' ')[0]} on Court ${courtId1}`, undoFunction);\n        render();\n        saveState();\n    }\n    function executePlayerSwapBetweenCourts(sourceCourtId, sourcePlayerName, targetCourtId, targetPlayerName) {\n        const sourceCourt = state.courts.find((c)=>c.id === sourceCourtId);\n        const targetCourt = state.courts.find((c)=>c.id === targetCourtId);\n        if (!sourceCourt || !targetCourt) return;\n        // Store original state for undo\n        const originalSourcePlayers = JSON.parse(JSON.stringify(sourceCourt.players));\n        const originalTargetPlayers = JSON.parse(JSON.stringify(targetCourt.players));\n        const originalSourceTeams = JSON.parse(JSON.stringify(sourceCourt.teams));\n        const originalTargetTeams = JSON.parse(JSON.stringify(targetCourt.teams));\n        // Find player indices\n        const sourcePlayerIndex = sourceCourt.players.findIndex((p)=>p.name === sourcePlayerName);\n        const targetPlayerIndex = targetCourt.players.findIndex((p)=>p.name === targetPlayerName);\n        if (sourcePlayerIndex === -1 || targetPlayerIndex === -1) return;\n        // Perform the swap\n        const tempPlayer = sourceCourt.players[sourcePlayerIndex];\n        sourceCourt.players[sourcePlayerIndex] = targetCourt.players[targetPlayerIndex];\n        targetCourt.players[targetPlayerIndex] = tempPlayer;\n        // Update teams if they are set\n        if (sourceCourt.teamsSet) updateTeamsAfterSwap(sourceCourt, sourcePlayerName, targetPlayerName);\n        if (targetCourt.teamsSet) updateTeamsAfterSwap(targetCourt, targetPlayerName, sourcePlayerName);\n        // Create undo function\n        const undoFunction = ()=>{\n            console.log('=== EXECUTING UNDO - Court Swap ===');\n            // Set flag to prevent WebSocket interference\n            localChangeInProgress = true;\n            // Find both courts fresh from state\n            const sourceCourtToRestore = state.courts.find((c)=>c.id === sourceCourtId);\n            const targetCourtToRestore = state.courts.find((c)=>c.id === targetCourtId);\n            if (!sourceCourtToRestore || !targetCourtToRestore) {\n                console.error('Courts not found for undo!');\n                localChangeInProgress = false;\n                return;\n            }\n            console.log('Restoring source court:', sourceCourtId);\n            console.log('Restoring target court:', targetCourtId);\n            // Restore the original state\n            sourceCourtToRestore.players = JSON.parse(JSON.stringify(originalSourcePlayers));\n            targetCourtToRestore.players = JSON.parse(JSON.stringify(originalTargetPlayers));\n            sourceCourtToRestore.teams = JSON.parse(JSON.stringify(originalSourceTeams));\n            targetCourtToRestore.teams = JSON.parse(JSON.stringify(originalTargetTeams));\n            render();\n            saveState();\n            // Clear flag after a short delay to allow saveState to complete\n            setTimeout(()=>{\n                localChangeInProgress = false;\n                console.log('Undo complete - flag cleared');\n            }, 500);\n        };\n        // Add to undo history\n        addToUndoHistory('court_swap', {\n            sourceCourtId,\n            sourcePlayerName,\n            targetCourtId,\n            targetPlayerName\n        }, undoFunction);\n        // Show undo toast\n        showUndoToast(`Swapped ${sourcePlayerName.split(' ')[0]} (Court ${sourceCourtId}) \\u{2194} ${targetPlayerName.split(' ')[0]} (Court ${targetCourtId})`, undoFunction);\n        render();\n        saveState();\n    }\n    function executePlayerSubstitution(courtId1, courtPlayerName, availablePlayerName) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court || court.status !== 'in_progress') return;\n        // Find players\n        const courtPlayerIndex = court.players.findIndex((p)=>p.name === courtPlayerName);\n        const availablePlayer = state.availablePlayers.find((p)=>p.name === availablePlayerName);\n        const courtPlayer = court.players[courtPlayerIndex];\n        if (courtPlayerIndex === -1 || !availablePlayer) return;\n        // Store original state for undo\n        const originalCourtPlayers = JSON.parse(JSON.stringify(court.players));\n        const originalCourtTeams = JSON.parse(JSON.stringify(court.teams));\n        const originalAvailablePlayers = JSON.parse(JSON.stringify(state.availablePlayers));\n        // Perform substitution\n        court.players[courtPlayerIndex] = availablePlayer;\n        // Update teams if set\n        if (court.teamsSet) updateTeamsAfterSwap(court, courtPlayerName, availablePlayerName);\n        // Update available players list\n        state.availablePlayers = state.availablePlayers.filter((p)=>p.name !== availablePlayerName);\n        state.availablePlayers.push(courtPlayer);\n        // Create undo function\n        const undoFunction = ()=>{\n            console.log('=== EXECUTING UNDO - Substitution ===');\n            // Set flag to prevent WebSocket interference\n            localChangeInProgress = true;\n            // Find the court fresh from state\n            const courtToRestore = state.courts.find((c)=>c.id === courtId1);\n            if (!courtToRestore) {\n                console.error('Court not found for undo!');\n                localChangeInProgress = false;\n                return;\n            }\n            console.log('Restoring court:', courtId1);\n            // Restore the original state\n            courtToRestore.players = JSON.parse(JSON.stringify(originalCourtPlayers));\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalCourtTeams));\n            state.availablePlayers = JSON.parse(JSON.stringify(originalAvailablePlayers));\n            render();\n            saveState();\n            // Clear flag after a short delay to allow saveState to complete\n            setTimeout(()=>{\n                localChangeInProgress = false;\n                console.log('Undo complete - flag cleared');\n            }, 500);\n        };\n        // Add to undo history\n        addToUndoHistory('substitution', {\n            courtId: courtId1,\n            courtPlayerName,\n            availablePlayerName\n        }, undoFunction);\n        // Show undo toast\n        showUndoToast(`Substituted ${courtPlayerName.split(' ')[0]} \\u{2192} ${availablePlayerName.split(' ')[0]} on Court ${courtId1}`, undoFunction);\n        render();\n        saveState();\n    }\n    // ================================\n    // UNDO HISTORY MODAL FUNCTIONS\n    // ================================\n    function showUndoHistoryModal() {\n        const undoHistoryModal = document.getElementById('undo-history-modal');\n        const undoHistoryList = document.getElementById('undo-history-list');\n        undoHistoryList.innerHTML = '';\n        if (state.undoHistory.actions.length === 0) {\n            const li = document.createElement('li');\n            li.className = 'empty-history';\n            li.textContent = 'No recent actions to undo';\n            undoHistoryList.appendChild(li);\n        } else state.undoHistory.actions.forEach((action, index)=>{\n            const li = document.createElement('li');\n            const actionDiv = document.createElement('div');\n            actionDiv.className = 'undo-history-action';\n            actionDiv.textContent = getActionDescription(action);\n            const timestampDiv = document.createElement('div');\n            timestampDiv.className = 'undo-history-timestamp';\n            timestampDiv.textContent = getTimeAgo(action.timestamp);\n            li.appendChild(actionDiv);\n            li.appendChild(timestampDiv);\n            li.onclick = ()=>promptUndoWithPin(action, index);\n            undoHistoryList.appendChild(li);\n        });\n        adminSettingsModal.classList.add('hidden');\n        undoHistoryModal.classList.remove('hidden');\n    }\n    function getActionDescription(action) {\n        switch(action.type){\n            case 'team_reselection':\n                return `Team Reselection: ${action.data.player1Name.split(' ')[0]} \\u{2194} ${action.data.player2Name.split(' ')[0]} (Court ${action.data.courtId})`;\n            case 'court_swap':\n                return `Court Swap: ${action.data.sourcePlayerName.split(' ')[0]} (Court ${action.data.sourceCourtId}) \\u{2194} ${action.data.targetPlayerName.split(' ')[0]} (Court ${action.data.targetCourtId})`;\n            case 'substitution':\n                return `Substitution: ${action.data.courtPlayerName.split(' ')[0]} \\u{2192} ${action.data.availablePlayerName.split(' ')[0]} (Court ${action.data.courtId})`;\n            case 'player_swap':\n                return `Player Swap: ${action.data.sourcePlayer.name.split(' ')[0]} (Court ${action.data.sourceCourt}) \\u{2194} ${action.data.targetPlayer.name.split(' ')[0]} (Court ${action.data.targetCourt})`;\n            default:\n                return 'Unknown action';\n        }\n    }\n    function getTimeAgo(timestamp) {\n        const seconds = Math.floor((Date.now() - timestamp) / 1000);\n        if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;\n        const minutes = Math.floor(seconds / 60);\n        if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;\n        const hours = Math.floor(minutes / 60);\n        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;\n    }\n    function promptUndoWithPin(action, actionIndex) {\n        // CRITICAL: Validate that undo is still safe to perform\n        const validationResult = validateUndoAction(action);\n        if (!validationResult.isValid) {\n            alert(`Cannot undo this action:\\n\\n${validationResult.reason}\\n\\nThe game state has changed too much since this action occurred.`);\n            return;\n        }\n        // Hide undo history modal\n        document.getElementById('undo-history-modal').classList.add('hidden');\n        // Store the action index in a way the keypad system can access it\n        customKeypadModal.dataset.undoActionIndex = actionIndex;\n        customKeypadModal.dataset.undoActionDescription = getActionDescription(action);\n        // Show the existing keypad in undo mode (no placeholder text)\n        showKeypad(null, {\n            mode: 'undo',\n            title: 'Enter Admin PIN to Undo'\n        });\n    }\n    function validateUndoAction(action) {\n        const { type, data } = action;\n        // Check based on action type\n        switch(type){\n            case 'team_reselection':\n                {\n                    const { courtId: courtId1, player1Name, player2Name } = data;\n                    const court = state.courts.find((c)=>c.id === courtId1);\n                    // Court must still exist and be in progress\n                    if (!court) return {\n                        isValid: false,\n                        reason: 'Court no longer exists'\n                    };\n                    if (court.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${courtId1} game has ended`\n                    };\n                    // Both players must still be on this court\n                    const hasPlayer1 = court.players.some((p)=>p.name === player1Name);\n                    const hasPlayer2 = court.players.some((p)=>p.name === player2Name);\n                    if (!hasPlayer1 || !hasPlayer2) return {\n                        isValid: false,\n                        reason: 'One or both players have left this court'\n                    };\n                    return {\n                        isValid: true\n                    };\n                }\n            case 'court_swap':\n                {\n                    const { sourceCourtId, sourcePlayerName, targetCourtId, targetPlayerName } = data;\n                    const sourceCourt = state.courts.find((c)=>c.id === sourceCourtId);\n                    const targetCourt = state.courts.find((c)=>c.id === targetCourtId);\n                    // Both courts must still be in progress\n                    if (!sourceCourt || sourceCourt.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${sourceCourtId} game has ended`\n                    };\n                    if (!targetCourt || targetCourt.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${targetCourtId} game has ended`\n                    };\n                    // Both players must still be on their respective courts\n                    const hasSourcePlayer = sourceCourt.players.some((p)=>p.name === sourcePlayerName);\n                    const hasTargetPlayer = targetCourt.players.some((p)=>p.name === targetPlayerName);\n                    if (!hasSourcePlayer) return {\n                        isValid: false,\n                        reason: `${sourcePlayerName.split(' ')[0]} is no longer on Court ${sourceCourtId}`\n                    };\n                    if (!hasTargetPlayer) return {\n                        isValid: false,\n                        reason: `${targetPlayerName.split(' ')[0]} is no longer on Court ${targetCourtId}`\n                    };\n                    return {\n                        isValid: true\n                    };\n                }\n            case 'substitution':\n                {\n                    const { courtId: courtId1, courtPlayerName, availablePlayerName } = data;\n                    const court = state.courts.find((c)=>c.id === courtId1);\n                    // Court must still be in progress\n                    if (!court || court.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${courtId1} game has ended`\n                    };\n                    // The substituted player must still be on the court\n                    const hasSubstitutedPlayer = court.players.some((p)=>p.name === availablePlayerName);\n                    if (!hasSubstitutedPlayer) return {\n                        isValid: false,\n                        reason: `${availablePlayerName.split(' ')[0]} is no longer on Court ${courtId1}`\n                    };\n                    // The original player should be in available players or on another court\n                    const originalPlayerAvailable = state.availablePlayers.some((p)=>p.name === courtPlayerName);\n                    const originalPlayerOnOtherCourt = state.courts.some((c)=>c.id !== courtId1 && c.players.some((p)=>p.name === courtPlayerName));\n                    if (!originalPlayerAvailable && !originalPlayerOnOtherCourt) return {\n                        isValid: false,\n                        reason: `${courtPlayerName.split(' ')[0]} has checked out`\n                    };\n                    return {\n                        isValid: true\n                    };\n                }\n            case 'player_swap':\n                {\n                    // This is from the modal swap (not drag & drop)\n                    const { sourceCourt, sourcePlayer, targetCourt, targetPlayer } = data;\n                    const sourceCourtObj = state.courts.find((c)=>c.id === sourceCourt);\n                    const targetCourtObj = state.courts.find((c)=>c.id === targetCourt);\n                    if (!sourceCourtObj || sourceCourtObj.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${sourceCourt} game has ended`\n                    };\n                    if (!targetCourtObj || targetCourtObj.status !== 'in_progress') return {\n                        isValid: false,\n                        reason: `Court ${targetCourt} game has ended`\n                    };\n                    const hasSourcePlayer = sourceCourtObj.players.some((p)=>p.name === sourcePlayer.name);\n                    const hasTargetPlayer = targetCourtObj.players.some((p)=>p.name === targetPlayer.name);\n                    if (!hasSourcePlayer || !hasTargetPlayer) return {\n                        isValid: false,\n                        reason: 'One or both players have moved to different courts'\n                    };\n                    return {\n                        isValid: true\n                    };\n                }\n            default:\n                return {\n                    isValid: false,\n                    reason: 'Unknown action type'\n                };\n        }\n    }\n    function executeUndoAction(actionIndex) {\n        // Get the action\n        const action = state.undoHistory.actions[actionIndex];\n        if (!action) return;\n        // Set flag to prevent WebSocket interference\n        localChangeInProgress = true;\n        // Execute undo\n        if (action.undo) action.undo();\n        // Remove from history\n        state.undoHistory.actions.splice(actionIndex, 1);\n        saveState();\n        // Clean up modal data\n        delete customKeypadModal.dataset.context;\n        delete customKeypadModal.dataset.actionIndex;\n        delete customKeypadModal.dataset.actionDescription;\n        // Clear flag after a short delay to allow saveState to complete\n        setTimeout(()=>{\n            localChangeInProgress = false;\n        }, 500);\n        // Show success message\n        showUndoToast('Action undone successfully', null);\n    }\n    // COMPLETE CORRECTED loadState FUNCTION\n    async function loadState(MASTER_MEMBER_LIST) {\n        try {\n            const loaded = await API.loadState();\n            if (loaded) {\n                // Merge loaded announcement state with default\n                if (loaded.customAnnouncementState) loaded.customAnnouncementState = {\n                    ...state.customAnnouncementState,\n                    ...loaded.customAnnouncementState\n                };\n                // Perform the general merge first\n                state = {\n                    ...state,\n                    ...loaded\n                };\n                // FIX: Reinitialize courts if loaded array is empty\n                if (!state.courts || state.courts.length === 0) {\n                    console.log(\"Empty courts array detected, reinitializing courts...\");\n                    state.courts = [\n                        {\n                            id: 'A',\n                            status: 'available',\n                            players: [],\n                            teams: {\n                                team1: [],\n                                team2: []\n                            },\n                            autoStartTimer: null,\n                            gameMode: null,\n                            gameStartTime: null,\n                            autoStartTimeTarget: null,\n                            becameAvailableAt: Date.now(),\n                            isCollapsed: false,\n                            isModeOverlayActive: false,\n                            courtMode: 'doubles'\n                        },\n                        {\n                            id: 'B',\n                            status: 'available',\n                            players: [],\n                            teams: {\n                                team1: [],\n                                team2: []\n                            },\n                            autoStartTimer: null,\n                            gameMode: null,\n                            gameStartTime: null,\n                            autoStartTimeTarget: null,\n                            becameAvailableAt: Date.now(),\n                            isCollapsed: false,\n                            isModeOverlayActive: false,\n                            courtMode: 'doubles'\n                        },\n                        {\n                            id: 'C',\n                            status: 'available',\n                            players: [],\n                            teams: {\n                                team1: [],\n                                team2: []\n                            },\n                            autoStartTimer: null,\n                            gameMode: null,\n                            gameStartTime: null,\n                            autoStartTimeTarget: null,\n                            becameAvailableAt: Date.now(),\n                            isCollapsed: false,\n                            isModeOverlayActive: false,\n                            courtMode: 'doubles'\n                        },\n                        {\n                            id: 'D',\n                            status: 'available',\n                            players: [],\n                            teams: {\n                                team1: [],\n                                team2: []\n                            },\n                            autoStartTimer: null,\n                            gameMode: null,\n                            gameStartTime: null,\n                            autoStartTimeTarget: null,\n                            becameAvailableAt: Date.now(),\n                            isCollapsed: false,\n                            isModeOverlayActive: false,\n                            courtMode: 'doubles'\n                        },\n                        {\n                            id: 'E',\n                            status: 'available',\n                            players: [],\n                            teams: {\n                                team1: [],\n                                team2: []\n                            },\n                            autoStartTimer: null,\n                            gameMode: null,\n                            gameStartTime: null,\n                            autoStartTimeTarget: null,\n                            becameAvailableAt: Date.now(),\n                            isCollapsed: false,\n                            isModeOverlayActive: false,\n                            courtMode: 'doubles'\n                        }\n                    ];\n                }\n                // Check and fix adminChecklist structure if outdated\n                if (typeof state.adminChecklist !== 'object' || !Array.isArray(state.adminChecklist.arrival)) {\n                    console.warn(\"Outdated adminChecklist structure found. Resetting to default.\");\n                    state.adminChecklist = {\n                        arrival: [\n                            {\n                                id: 'arrUnlockTuckshop',\n                                text: 'Unlock Tuckshop & Setup POS',\n                                checked: false\n                            },\n                            {\n                                id: 'arrUnlockCloakrooms',\n                                text: 'Unlock Cloakrooms',\n                                checked: false\n                            },\n                            {\n                                id: 'arrMainTv',\n                                text: 'Main TV: On & Sport Channel',\n                                checked: false\n                            },\n                            {\n                                id: 'arrTuckshopTv',\n                                text: 'Tuckshop TV: On & Music Videos',\n                                checked: false\n                            },\n                            {\n                                id: 'arrAmpAux',\n                                text: 'Amp: Aux Analog',\n                                checked: false\n                            },\n                            {\n                                id: 'arrAmpOptical',\n                                text: 'Amp: Optical/Main TV',\n                                checked: false\n                            },\n                            {\n                                id: 'arrOpenCurtains',\n                                text: 'Open Curtains & Sliding Door',\n                                checked: false\n                            },\n                            {\n                                id: 'arrPutCushions',\n                                text: 'Put Out Bench Cushions',\n                                checked: false\n                            },\n                            {\n                                id: 'arrSignOutBalls',\n                                text: 'Sign Out Social Balls (via Ball Mgmt)',\n                                checked: false\n                            },\n                            {\n                                id: 'arrEmptyDishwasher',\n                                text: 'Empty Dishwasher & Check Dishes',\n                                checked: false\n                            },\n                            {\n                                id: 'arrCheckFridge',\n                                text: 'Check Fridge for Expired Products',\n                                checked: false\n                            },\n                            {\n                                id: 'arrEmptyBins',\n                                text: 'Empty Full Bins & Replace Liners',\n                                checked: false\n                            },\n                            {\n                                id: 'arrManStation',\n                                text: 'Man Duty Station (Busy Times)',\n                                checked: false\n                            },\n                            {\n                                id: 'arrAssistApp',\n                                text: 'Assist Members with App',\n                                checked: false\n                            },\n                            {\n                                id: 'arrRemindAccounts',\n                                text: 'Remind Members re: Tuck Shop Accounts',\n                                checked: false\n                            }\n                        ],\n                        departure: [\n                            {\n                                id: 'depReturnBalls',\n                                text: 'Return Social Balls & Sign In (via Ball Mgmt)',\n                                checked: false\n                            },\n                            {\n                                id: 'depCheckOutApp',\n                                text: 'Ensure All Players Checked Out on App',\n                                checked: false\n                            },\n                            {\n                                id: 'depLoadDishes',\n                                text: 'Load/Wash Dishes',\n                                checked: false\n                            },\n                            {\n                                id: 'depReturnCushions',\n                                text: 'Return Bench Cushions',\n                                checked: false\n                            },\n                            {\n                                id: 'depTurnOffTvAmp',\n                                text: 'Turn Off TVs & Amp',\n                                checked: false\n                            },\n                            {\n                                id: 'depWipeBar',\n                                text: 'Wipe Down Bar Counter',\n                                checked: false\n                            },\n                            {\n                                id: 'depEmptyIceBucket',\n                                text: 'Empty & Wash Ice Bucket',\n                                checked: false\n                            },\n                            {\n                                id: 'depWipeKitchen',\n                                text: 'Wipe Down Kitchen Counter',\n                                checked: false\n                            },\n                            {\n                                id: 'depTrashOut',\n                                text: 'Take Inside Trash to Outside Bins',\n                                checked: false\n                            },\n                            {\n                                id: 'depLockBarStore',\n                                text: 'Lock Bar & Storeroom',\n                                checked: false\n                            },\n                            {\n                                id: 'depCloseCurtains',\n                                text: 'Close Sliding Door & Curtains',\n                                checked: false\n                            },\n                            {\n                                id: 'depLockClubhouseAlarm',\n                                text: 'Lock Clubhouse & Set Alarm',\n                                checked: false\n                            },\n                            {\n                                id: 'depLockCloakrooms',\n                                text: 'Lock Cloakrooms',\n                                checked: false\n                            },\n                            {\n                                id: 'depLockGates',\n                                text: 'Check & Lock Pedestrian Gates',\n                                checked: false\n                            }\n                        ]\n                    };\n                }\n                // Ensure uiSettings and its properties exist\n                if (!state.uiSettings) state.uiSettings = {\n                    fontSizeMultiplier: 1.0,\n                    displaySizeMultiplier: 1.0\n                };\n                else {\n                    if (state.uiSettings.displaySizeMultiplier === undefined) state.uiSettings.displaySizeMultiplier = 1.0;\n                    if (state.uiSettings.fontSizeMultiplier === undefined) state.uiSettings.fontSizeMultiplier = 1.0; // Ensure font multiplier exists\n                }\n                // Ensure courtSettings and its properties exist\n                if (!state.courtSettings) state.courtSettings = {\n                    visibleCourts: [\n                        'A',\n                        'B',\n                        'C',\n                        'D',\n                        'E'\n                    ],\n                    autoAssignModes: true,\n                    showGameModeSelector: false\n                };\n                else {\n                    if (state.courtSettings.autoAssignModes === undefined) state.courtSettings.autoAssignModes = true;\n                    if (state.courtSettings.showGameModeSelector === undefined) state.courtSettings.showGameModeSelector = false;\n                    if (!Array.isArray(state.courtSettings.visibleCourts)) state.courtSettings.visibleCourts = [\n                        'A',\n                        'B',\n                        'C',\n                        'D',\n                        'E'\n                    ]; // Ensure visibleCourts is an array\n                }\n                // Ensure matchSettings and its properties exist\n                if (!state.matchSettings) state.matchSettings = {\n                    matchMode: '1set',\n                    fastPlayGames: 4,\n                    autoMatchModes: true\n                };\n                else {\n                    if (state.matchSettings.autoMatchModes === undefined) state.matchSettings.autoMatchModes = true;\n                    if (state.matchSettings.matchMode === undefined) state.matchSettings.matchMode = '1set';\n                    if (state.matchSettings.fastPlayGames === undefined) state.matchSettings.fastPlayGames = 4;\n                }\n                // Ensure juniorClub and its nested properties exist\n                if (!state.juniorClub) state.juniorClub = {\n                    parents: [],\n                    activeChildren: [],\n                    history: [],\n                    statsFilter: {\n                        parent: 'all',\n                        paid: 'all'\n                    },\n                    rosterFilter: {\n                        sortKey: 'name',\n                        sortOrder: 'asc',\n                        type: 'all'\n                    },\n                    checkInFilter: {\n                        displayMode: 'parent'\n                    },\n                    registrationFlow: {\n                        parentCollapsed: false,\n                        childrenExpanded: false\n                    }\n                };\n                else {\n                    if (!state.juniorClub.checkInFilter) state.juniorClub.checkInFilter = {\n                        displayMode: 'parent'\n                    };\n                    if (!state.juniorClub.rosterFilter) state.juniorClub.rosterFilter = {\n                        sortKey: 'name',\n                        sortOrder: 'asc',\n                        type: 'all'\n                    };\n                    if (!state.juniorClub.registrationFlow) state.juniorClub.registrationFlow = {\n                        parentCollapsed: false,\n                        childrenExpanded: false\n                    };\n                    if (!state.juniorClub.statsFilter) state.juniorClub.statsFilter = {\n                        parent: 'all',\n                        paid: 'all'\n                    };\n                    else if (state.juniorClub.statsFilter.paid === undefined) state.juniorClub.statsFilter.paid = 'all';\n                }\n                state.gameHistory = state.gameHistory || [];\n                state.reorderHistory = state.reorderHistory || [];\n                state.guestHistory = state.guestHistory || [];\n                state.statsFilter = state.statsFilter || {\n                    gender: 'all',\n                    teamGender: 'all',\n                    sortKey: 'totalDurationMs',\n                    sortOrder: 'desc'\n                };\n                if (state.statsFilter.teamGender === undefined) state.statsFilter.teamGender = 'all';\n                state.selectedAlertSound = state.selectedAlertSound || 'Alert1.mp3';\n                if (!state.mobileControls) state.mobileControls = {\n                    isSummaryExpanded: true,\n                    isPlayersExpanded: true\n                };\n                if (!state.notificationControls) state.notificationControls = {\n                    isMuted: false,\n                    isMinimized: false,\n                    isTTSDisabled: false,\n                    autoMinimize: true\n                };\n                else if (state.notificationControls.autoMinimize === undefined) state.notificationControls.autoMinimize = true;\n                if (!state.adminCourtManagement) state.adminCourtManagement = {\n                    mode: 'card1_select_court',\n                    courtId: null,\n                    currentCourtPlayers: [],\n                    removedPlayers: [],\n                    addedPlayers: []\n                };\n                if (!state.ballManagement) state.ballManagement = {\n                    stock: 0,\n                    usedStock: 0,\n                    history: [],\n                    historyFilter: 'all',\n                    tempSale: {\n                        stockType: null,\n                        memberSignOut: null,\n                        purchaserName: null,\n                        purchaserType: null\n                    }\n                };\n                else {\n                    if (state.ballManagement.usedStock === undefined) state.ballManagement.usedStock = 0;\n                    if (!state.ballManagement.historyFilter) state.ballManagement.historyFilter = 'all';\n                    if (!state.ballManagement.tempSale) state.ballManagement.tempSale = {\n                        stockType: null,\n                        memberSignOut: null,\n                        purchaserName: null,\n                        purchaserType: null\n                    };\n                    else if (state.ballManagement.tempSale.purchaserType === undefined) state.ballManagement.tempSale.purchaserType = null;\n                }\n                // Ensure lightSettings structure exists and has basic global keys\n                if (!state.lightSettings || typeof state.lightSettings !== 'object') state.lightSettings = {\n                    shellyBaseUrl: '',\n                    shellyAuthKey: '',\n                    courts: {},\n                    general: {}\n                };\n                if (state.lightSettings.shellyBaseUrl === undefined) state.lightSettings.shellyBaseUrl = '';\n                if (state.lightSettings.shellyAuthKey === undefined) state.lightSettings.shellyAuthKey = '';\n                if (!state.lightSettings.courts || typeof state.lightSettings.courts !== 'object') state.lightSettings.courts = {};\n                if (!state.lightSettings.general || typeof state.lightSettings.general !== 'object') state.lightSettings.general = {};\n                // Ensure default court settings exist if missing after load\n                const defaultCourtIds = [\n                    'A',\n                    'B',\n                    'C',\n                    'D',\n                    'E'\n                ];\n                defaultCourtIds.forEach((id)=>{\n                    if (!state.lightSettings.courts[id]) state.lightSettings.courts[id] = {\n                        id: id,\n                        label: `Court ${id} Lights`,\n                        isManaged: false,\n                        isActive: false,\n                        shellyDeviceId: '',\n                        shellyCloudId: ''\n                    };\n                    else {\n                        // Ensure all properties exist even if the court object was loaded partially\n                        state.lightSettings.courts[id].id = state.lightSettings.courts[id].id || id;\n                        state.lightSettings.courts[id].label = state.lightSettings.courts[id].label || `Court ${id} Lights`;\n                        state.lightSettings.courts[id].isManaged = state.lightSettings.courts[id].isManaged !== undefined ? state.lightSettings.courts[id].isManaged : false;\n                        state.lightSettings.courts[id].isActive = state.lightSettings.courts[id].isActive || false;\n                        state.lightSettings.courts[id].shellyDeviceId = state.lightSettings.courts[id].shellyDeviceId || '';\n                        state.lightSettings.courts[id].shellyCloudId = state.lightSettings.courts[id].shellyCloudId || '';\n                    }\n                });\n                // Ensure default general light settings exist if missing\n                if (!state.lightSettings.general['clubhouse']) state.lightSettings.general['clubhouse'] = {\n                    id: 'clubhouse',\n                    label: 'Clubhouse Lights',\n                    isManaged: false,\n                    isActive: false,\n                    shellyDeviceId: '',\n                    shellyCloudId: ''\n                };\n                // Ensure suggestionSettings and its properties exist\n                if (!state.suggestionSettings) state.suggestionSettings = {\n                    femaleRatioPercent: 50,\n                    maleRatioPercent: 70,\n                    prioritizeLeastPlaytime: true,\n                    powerScoreOnly: false,\n                    topPlayerPercent: 35,\n                    frequentOpponentPercent: 35,\n                    weakPlayerPercent: 35,\n                    weakPlayerThreshold: -0.1\n                };\n                else {\n                    // Add new properties if they are missing from older saved states\n                    if (state.suggestionSettings.topPlayerPercent === undefined) state.suggestionSettings.topPlayerPercent = 35;\n                    if (state.suggestionSettings.frequentOpponentPercent === undefined) state.suggestionSettings.frequentOpponentPercent = 35;\n                    if (state.suggestionSettings.weakPlayerPercent === undefined) state.suggestionSettings.weakPlayerPercent = 35;\n                    if (state.suggestionSettings.weakPlayerThreshold === undefined) state.suggestionSettings.weakPlayerThreshold = -0.1;\n                }\n                state.checklistHistory = state.checklistHistory || [];\n                state.selectedChecklistHistoryDate = state.selectedChecklistHistoryDate || null;\n                state.undoHistory = state.undoHistory || {\n                    actions: [],\n                    maxHistory: 10\n                }; // Ensure undo history exists\n                // Function to ensure player objects have needed properties\n                const ensurePlayerObjects = (playerList, defaultList)=>{\n                    if (!Array.isArray(playerList)) return [];\n                    return playerList.map((player)=>{\n                        if (typeof player === 'string') {\n                            const defaultPlayer = defaultList.find((p)=>p.name === player);\n                            // Ensure default guest object includes type\n                            return defaultPlayer || {\n                                name: player,\n                                gender: '?',\n                                guest: true,\n                                type: 'Adult',\n                                isPaused: false,\n                                onLeaderboard: true\n                            };\n                        }\n                        player.isPaused = player.isPaused || false;\n                        player.onLeaderboard = player.onLeaderboard === undefined ? true : player.onLeaderboard;\n                        // Ensure type exists, default to Adult if missing\n                        player.type = player.type || 'Adult';\n                        return player;\n                    });\n                };\n                // Re-calculate clubMembers based on who is checked in\n                const checkedInNames = new Set();\n                if (Array.isArray(state.availablePlayers)) state.availablePlayers.forEach((p)=>checkedInNames.add(p.name));\n                state.courts.forEach((court)=>{\n                    if (Array.isArray(court.players)) court.players.forEach((p)=>checkedInNames.add(p.name));\n                });\n                state.clubMembers = MASTER_MEMBER_LIST.filter((p)=>!checkedInNames.has(p.name));\n                state.clubMembers.sort((a, b)=>a.name.localeCompare(b.name));\n                // Process availablePlayers and players on court\n                state.availablePlayers = ensurePlayerObjects(state.availablePlayers, MASTER_MEMBER_LIST);\n                state.courts.forEach((court)=>{\n                    if (court.status === 'available' && court.becameAvailableAt === undefined) court.becameAvailableAt = Date.now();\n                    court.isCollapsed = court.isCollapsed === undefined ? false : court.isCollapsed;\n                    court.isModeOverlayActive = court.isModeOverlayActive === undefined ? false : court.isModeOverlayActive;\n                    court.courtMode = court.courtMode || 'doubles';\n                    court.teamsSet = court.teamsSet === undefined ? null : court.teamsSet; // null indicates unset for doubles\n                    court.players = ensurePlayerObjects(court.players, MASTER_MEMBER_LIST);\n                    if (!court.teams) court.teams = {\n                        team1: [],\n                        team2: []\n                    };\n                    else {\n                        court.teams.team1 = ensurePlayerObjects(court.teams.team1, MASTER_MEMBER_LIST);\n                        court.teams.team2 = ensurePlayerObjects(court.teams.team2, MASTER_MEMBER_LIST);\n                    }\n                    // Restart timers if needed\n                    if (court.status === \"game_pending\" && court.autoStartTimeTarget) {\n                        const delay = court.autoStartTimeTarget - Date.now();\n                        if (delay > 0) {\n                            if (court.autoStartTimer) clearTimeout(court.autoStartTimer);\n                            // IMPORTANT: Ensure handleStartGame is defined correctly\n                            court.autoStartTimer = setTimeout(()=>handleStartGame(court.id), delay);\n                        } else // If delay is negative, start immediately\n                        handleStartGame(court.id);\n                    } else if (court.autoStartTimer) {\n                        clearTimeout(court.autoStartTimer);\n                        court.autoStartTimer = null;\n                    }\n                });\n                console.log('State loaded from server successfully');\n            } else {\n                console.log(\"No saved state found on server, using initial state.\");\n                // Ensure lightSettings exists even with initial state\n                if (!state.lightSettings) {\n                    state.lightSettings = {\n                        shellyBaseUrl: '',\n                        shellyAuthKey: '',\n                        courts: {},\n                        general: {}\n                    };\n                    // Populate initial default courts if needed\n                    const defaultCourtIds = [\n                        'A',\n                        'B',\n                        'C',\n                        'D',\n                        'E'\n                    ];\n                    defaultCourtIds.forEach((id)=>{\n                        state.lightSettings.courts[id] = {\n                            id: id,\n                            label: `Court ${id} Lights`,\n                            isManaged: false,\n                            isActive: false,\n                            shellyDeviceId: '',\n                            shellyCloudId: ''\n                        };\n                    });\n                    state.lightSettings.general['clubhouse'] = {\n                        id: 'clubhouse',\n                        label: 'Clubhouse Lights',\n                        isManaged: false,\n                        isActive: false,\n                        shellyDeviceId: '',\n                        shellyCloudId: ''\n                    };\n                }\n            }\n        } catch (error) {\n            console.error('Error loading state:', error);\n            console.log(\"Using initial state due to error.\");\n            // Ensure lightSettings exists even on error\n            if (!state.lightSettings) {\n                state.lightSettings = {\n                    shellyBaseUrl: '',\n                    shellyAuthKey: '',\n                    courts: {},\n                    general: {}\n                };\n                // Populate initial default courts if needed\n                const defaultCourtIds = [\n                    'A',\n                    'B',\n                    'C',\n                    'D',\n                    'E'\n                ];\n                defaultCourtIds.forEach((id)=>{\n                    state.lightSettings.courts[id] = {\n                        id: id,\n                        label: `Court ${id} Lights`,\n                        isManaged: false,\n                        isActive: false,\n                        shellyDeviceId: '',\n                        shellyCloudId: ''\n                    };\n                });\n                state.lightSettings.general['clubhouse'] = {\n                    id: 'clubhouse',\n                    label: 'Clubhouse Lights',\n                    isManaged: false,\n                    isActive: false,\n                    shellyDeviceId: '',\n                    shellyCloudId: ''\n                };\n            }\n        }\n    }\n    function updateHeaderClock() {\n        const date = new Date();\n        const weekday = date.toLocaleDateString(\"en-ZA\", {\n            weekday: \"long\"\n        });\n        const day = String(date.getDate()).padStart(2, '0');\n        // Get 24-hour time parts\n        const hour24 = String(date.getHours()).padStart(2, '0');\n        const minutes = String(date.getMinutes()).padStart(2, '0');\n        const seconds = String(date.getSeconds()).padStart(2, '0');\n        // Determine am/pm for the tag\n        const ampm = date.getHours() >= 12 ? 'pm' : 'am';\n        // Construct the custom time string\n        const time = `${hour24}:${minutes}:${seconds} ${ampm}`;\n        headerClock.textContent = `${weekday} ${day}, ${time}`;\n    }\n    function updateOverlaySpacers() {\n        const headerLogo = document.getElementById('header-logo');\n        const leftSpacer = document.getElementById('left-spacer');\n        const rightSpacer = document.getElementById('right-spacer');\n        if (!headerLogo || !leftSpacer || !rightSpacer) return;\n        // Get the logo's width\n        const logoWidth = headerLogo.offsetWidth;\n        // Apply the logo's width to both the left and right spacers\n        leftSpacer.style.width = `${logoWidth}px`;\n        rightSpacer.style.width = `${logoWidth}px`;\n    }\n    function updateTimers() {\n        updateHeaderClock();\n        state.courts.forEach((court)=>{\n            const timerEl = document.getElementById(`timer-${court.id}`);\n            if (timerEl) {\n                if (court.status === 'in_progress' && court.gameStartTime) {\n                    const elapsed = Date.now() - court.gameStartTime;\n                    const hours = Math.floor(elapsed / 3600000);\n                    const minutes = Math.floor(elapsed % 3600000 / 60000);\n                    timerEl.textContent = `${String(hours).padStart(2, \"0\")}h${String(minutes).padStart(2, \"0\")}m`;\n                } else if (court.status === 'game_pending' && court.autoStartTimeTarget) {\n                    const remaining = court.autoStartTimeTarget - Date.now();\n                    if (remaining < 0) {\n                        timerEl.textContent = \"00:00\";\n                        return;\n                    }\n                    const minutes = Math.floor(remaining / 60000);\n                    const seconds = Math.floor(remaining % 60000 / 1000);\n                    timerEl.textContent = `${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}`;\n                } else timerEl.textContent = '';\n            }\n        });\n        document.querySelectorAll('.player-pause-cooldown').forEach((timerEl)=>{\n            const pauseTime = parseInt(timerEl.dataset.pauseTime, 10);\n            if (pauseTime) {\n                const TEN_MINUTES_MS = 600000;\n                const elapsed = Date.now() - pauseTime;\n                const remaining = Math.max(0, TEN_MINUTES_MS - elapsed);\n                if (remaining === 0) {\n                    timerEl.textContent = \"00m00s\";\n                    timerEl.classList.remove('player-pause-cooldown');\n                } else {\n                    const minutes = Math.floor(remaining / 60000);\n                    const seconds = Math.floor(remaining % 60000 / 1000);\n                    // --- THIS IS THE FORMAT CHANGE ---\n                    timerEl.textContent = `${String(minutes).padStart(2, \"0\")}m${String(seconds).padStart(2, \"0\")}s`;\n                }\n            }\n        });\n        updateAlertStatusTimer();\n    }\n    // --- NEW: Global Keyboard Control Functions ---\n    // --- MODIFIED: Ensure initialValue parameter exists ---\n    function showGlobalKeyboard(inputElement, startingPage = 'LetterPad', initialValue = '') {\n        console.log('showGlobalKeyboard called for:', inputElement.id, 'Parent modal visible:', !document.getElementById('new-parent-modal').classList.contains('hidden'));\n        activeGlobalInput = inputElement;\n        globalKeyboardState.currentPage = startingPage;\n        // For date/time inputs, show partial value or empty, otherwise use actual value\n        if (inputElement.type === 'date' || inputElement.type === 'time') // *** CHANGE textContent to value ***\n        globalKeyboardDisplay.value = inputElement.dataset.partialValue || ''; //\n        else // Use initialValue if provided, otherwise use inputElement.value\n        // *** CHANGE textContent to value ***\n        globalKeyboardDisplay.value = initialValue || activeGlobalInput.value; //\n        // *** CHANGE scrollTop to scrollHeight ***\n        globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight; //\n        customAlphaKeypadModal.classList.add('hidden');\n        customKeypadModal.classList.add('hidden');\n        globalKeyboardModal.classList.remove('hidden');\n        renderGlobalKeyboard();\n        // *** NEW: Focus the textarea when shown ***\n        globalKeyboardDisplay.focus(); //\n        // Move cursor to the end\n        globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = globalKeyboardDisplay.value.length; //\n    }\n    function hideGlobalKeyboard() {\n        // Clear partial value data attribute if it exists\n        if (activeGlobalInput && activeGlobalInput.dataset.partialValue !== undefined) delete activeGlobalInput.dataset.partialValue;\n        globalKeyboardModal.classList.add('hidden');\n        activeGlobalInput = null;\n        globalKeyboardState.currentPage = 'LetterPad';\n        globalKeyboardState.case = 'lower';\n        clearTimeout(globalKeyboardState.longPressTimer);\n    }\n    // --- END NEW: Global Keyboard Control Functions ---\n    // --- NEW: Function to update the overlay display ---\n    function updateOverlayDisplay(inputElement, overlay, partialValue) {\n        const isDate = inputElement.type === 'date';\n        const currentPart = inputElement.dataset.currentDatePart;\n        if (isDate) {\n            // Extract parts from partial value (YYYYMMDD)\n            const year = partialValue.slice(0, 4).padEnd(4, 'y');\n            const month = partialValue.slice(4, 6).padEnd(2, 'm');\n            const day = partialValue.slice(6, 8).padEnd(2, 'd');\n            // Update each part in the overlay\n            const parts = overlay.querySelectorAll('.part');\n            parts[0].textContent = year.replace(/y/g, (match, offset)=>'yyyy'[offset]);\n            parts[0].classList.toggle('filled', partialValue.length > 0);\n            parts[0].classList.toggle('empty', partialValue.length === 0);\n            parts[0].classList.toggle('active', currentPart === 'YYYY');\n            parts[1].textContent = month.replace(/m/g, (match, offset)=>'mm'[offset]);\n            parts[1].classList.toggle('filled', partialValue.length > 4);\n            parts[1].classList.toggle('empty', partialValue.length <= 4);\n            parts[1].classList.toggle('active', currentPart === 'MM');\n            parts[2].textContent = day.replace(/d/g, (match, offset)=>'dd'[offset]);\n            parts[2].classList.toggle('filled', partialValue.length > 6);\n            parts[2].classList.toggle('empty', partialValue.length <= 6);\n            parts[2].classList.toggle('active', currentPart === 'DD');\n        } else {\n            // Time input (HHMM)\n            const hour = partialValue.slice(0, 2).padEnd(2, '-');\n            const minute = partialValue.slice(2, 4).padEnd(2, '-');\n            // Update each part in the overlay\n            const parts = overlay.querySelectorAll('.part');\n            parts[0].textContent = hour;\n            parts[0].classList.toggle('filled', partialValue.length > 0);\n            parts[0].classList.toggle('empty', partialValue.length === 0);\n            parts[0].classList.toggle('active', currentPart === 'HH');\n            parts[1].textContent = minute;\n            parts[1].classList.toggle('filled', partialValue.length > 2);\n            parts[1].classList.toggle('empty', partialValue.length <= 2);\n            parts[1].classList.toggle('active', currentPart === 'MM');\n        }\n    }\n    // --- END NEW ---\n    // --- NEW: Global Keyboard Rendering and Logic ---\n    // Helper to get the correct character based on case\n    function getCharForCase(key) {\n        if (globalKeyboardState.case === 'upper' || globalKeyboardState.case === 'shift') return key.toUpperCase();\n        return key.toLowerCase();\n    }\n    // Helper to switch the keyboard page\n    function switchGlobalKeyboardPage(newPage) {\n        if (newPage === 'LetterPad') // When returning to letter pad, reset to initial case state\n        globalKeyboardState.case = 'lower';\n        globalKeyboardState.currentPage = newPage;\n        renderGlobalKeyboard();\n    }\n    function renderGlobalKeyboard(searchTerm = '') {\n        const currentPage = globalKeyboardState.currentPage;\n        const layout = KEYBOARD_LAYOUTS[currentPage];\n        globalKeyboardGrid.innerHTML = '';\n        globalKeyboardGrid.classList.remove('emoji-grid');\n        // --- Control visibility of the search container ---\n        if (currentPage === 'EmojiPage') {\n            emojiSearchContainer.classList.add('active-page');\n            emojiSearchContainer.classList.remove('hidden');\n        } else {\n            emojiSearchContainer.classList.remove('active-page');\n            emojiSearchContainer.classList.add('hidden');\n        }\n        if (currentPage === 'EmojiPage') {\n            globalKeyboardGrid.classList.add('emoji-grid');\n            renderEmojiPage(searchTerm);\n            return;\n        }\n        // --- Set page attribute for CSS targeting ---\n        // Find the .keyboard-content container (parent of globalKeyboardGrid)\n        const keyboardContent = globalKeyboardGrid.closest('.keyboard-content');\n        if (keyboardContent) keyboardContent.setAttribute('data-page', currentPage);\n        layout.forEach((rowKeys, rowIndex)=>{\n            const rowDiv = document.createElement('div');\n            rowDiv.className = `keyboard-row row-${rowIndex}`;\n            let isNavigationRow = false;\n            // --- Apply custom row layout for Letter/Symbol pages ---\n            if (currentPage !== 'NumberPad') {\n                if (currentPage === 'LetterPad' && rowIndex === 1) {\n                    // Row 1 (A-L): 9 keys centered\n                    rowDiv.style.gridTemplateColumns = 'repeat(9, 1fr)';\n                    rowDiv.style.width = '90%';\n                    rowDiv.style.margin = '0 auto';\n                } else if (currentPage === 'LetterPad' && rowIndex === 2) // Row 2 (Shift ZXC...): Custom fractions\n                rowDiv.style.gridTemplateColumns = '1.5fr repeat(7, 1fr) 1.5fr';\n                else if (rowIndex === layout.length - 1) {\n                    // Last Row (NAV): Custom fractions\n                    rowDiv.style.gridTemplateColumns = '1.5fr 1fr 5fr 1fr 1.5fr';\n                    isNavigationRow = true;\n                } else // Default 10 columns for QWERTY and Symbols P1/P2\n                rowDiv.style.gridTemplateColumns = 'repeat(10, 1fr)';\n            } else {\n                // Row 0, 1, 2: 5 equal columns (full width)\n                if (rowIndex < 3) {\n                    rowDiv.style.gridTemplateColumns = 'repeat(5, 1fr)';\n                    rowDiv.style.width = '100%';\n                } else if (rowIndex === 3) {\n                    // Use 7 equal columns for all 7 keys\n                    rowDiv.style.gridTemplateColumns = 'repeat(7, 1fr)';\n                    rowDiv.style.width = '100%';\n                    isNavigationRow = true;\n                }\n            }\n            rowKeys.forEach((key)=>{\n                const button = document.createElement('button');\n                button.className = 'global-keypad-btn';\n                button.dataset.key = key;\n                let displayChar = getCharForCase(key);\n                let isActionOrSpecial = false;\n                // --- NumberPad Specific Styling (NO GRID SPANNING) ---\n                if (currentPage === 'NumberPad') {\n                    if (key === 'ENTER') {\n                        // MODIFIED: Use standard Unicode character for Return/Enter key\n                        displayChar = '\\u23CE'; // Return Symbol (⏎)\n                        button.classList.add('key-action');\n                        isActionOrSpecial = true;\n                    } else if (key === 'BACK') {\n                        displayChar = \"\\u232B\";\n                        button.classList.add('key-action');\n                        isActionOrSpecial = true;\n                    } else if (key === 'DOT') displayChar = '.';\n                    else if (key === 'PERCENT') displayChar = '%';\n                    else if (key === 'COMMA') displayChar = ',';\n                    else if ([\n                        '+',\n                        '-',\n                        '*',\n                        '='\n                    ].includes(key)) {\n                        button.classList.add('key-special');\n                        isActionOrSpecial = true;\n                    } else if (key === 'SPACE') {\n                        displayChar = 'space';\n                        button.classList.add('key-special');\n                        isActionOrSpecial = true;\n                    } else if (key === '?123') {\n                        displayChar = '?123';\n                        button.classList.add('key-special');\n                        isActionOrSpecial = true;\n                    } else if (key === 'ABC') {\n                        displayChar = 'ABC';\n                        button.classList.add('key-special');\n                        isActionOrSpecial = true;\n                    }\n                // CRITICAL: DO NOT use gridColumn span for NumberPad Row 3\n                // The fractional grid layout handles the sizing automatically\n                // Remove all gridColumn assignments for NumberPad keys\n                }\n                // --- General Key Handling ---\n                if (key === 'SHIFT') {\n                    displayChar = globalKeyboardState.case === 'upper' || globalKeyboardState.case === 'shift' ? \"\\u21E7\" : 'Caps';\n                    button.classList.add('key-special');\n                    isActionOrSpecial = true;\n                    if (globalKeyboardState.case === 'upper') button.classList.add('active');\n                } else if (key === 'BACK' && currentPage !== 'NumberPad') {\n                    displayChar = \"\\u232B\";\n                    button.classList.add('key-action');\n                    isActionOrSpecial = true;\n                } else if (key === 'ENTER') {\n                    // MODIFIED: Use standard Unicode character for Return/Enter key\n                    displayChar = '\\u23CE'; // Return Symbol (⏎)\n                    button.classList.add('key-action');\n                    isActionOrSpecial = true;\n                } else if (key === 'SPACE' && currentPage !== 'NumberPad') displayChar = 'space';\n                else if (key === 'GLOBE' || key === 'MIC') {\n                    displayChar = key === 'GLOBE' ? \"\\uD83C\\uDF10\" : \"\\uD83C\\uDF99\\uFE0F\";\n                    button.classList.add('key-special');\n                    isActionOrSpecial = true;\n                } else if ([\n                    '?123',\n                    'ABC',\n                    '1234',\n                    '!@#'\n                ].includes(key) && currentPage !== 'NumberPad') {\n                    displayChar = key;\n                    button.classList.add('key-special');\n                    isActionOrSpecial = true;\n                }\n                // Custom override for `, / 😀` button appearance\n                if (key === \", / \\uD83D\\uDE00\") {\n                    displayChar = currentPage === 'LetterPad' ? \", / \\uD83D\\uDE00\" : ',';\n                    button.classList.remove('key-special');\n                    isActionOrSpecial = false;\n                }\n                button.textContent = displayChar;\n                button.addEventListener('click', handleGlobalKeypadClick);\n                // Add long press listener for the Emoji key on LetterPad\n                currentPage === 'LetterPad' && key;\n                rowDiv.appendChild(button);\n            });\n            globalKeyboardGrid.appendChild(rowDiv);\n        });\n    }\n    // Simplified Emoji Renderer (needs work if implementing full scrollable list)\n    function renderEmojiPage(searchTerm) {\n        // Search container visibility is now controlled by renderGlobalKeyboard()\n        globalKeyboardGrid.style.gridTemplateColumns = 'repeat(7, 1fr)'; // 7 columns for emoji grid\n        const filteredEmojis = EMOJI_LIST.filter((e)=>!searchTerm || e.toLowerCase().includes(searchTerm.toLowerCase()));\n        // Add the bottom navigation bar for the Emoji Page first\n        const navRow = document.createElement('div');\n        navRow.className = 'keyboard-row row-nav';\n        navRow.style.gridTemplateColumns = '1.5fr 1fr 1fr 1.5fr';\n        // ABC (Back to LetterPad)\n        let btnABC = document.createElement('button');\n        btnABC.className = 'global-keypad-btn key-special';\n        btnABC.textContent = 'ABC';\n        btnABC.dataset.key = 'ABC';\n        btnABC.addEventListener('click', handleGlobalKeypadClick);\n        navRow.appendChild(btnABC);\n        // Globe (Placeholder/Future use)\n        let btnGlobe = document.createElement('button');\n        btnGlobe.className = 'global-keypad-btn key-special';\n        btnGlobe.textContent = \"\\uD83C\\uDF10\";\n        btnGlobe.dataset.key = 'GLOBE';\n        navRow.appendChild(btnGlobe);\n        // Mic (Placeholder/Future use)\n        let btnMic = document.createElement('button');\n        btnMic.className = 'global-keypad-btn key-special';\n        btnMic.textContent = \"\\uD83C\\uDF99\\uFE0F\";\n        btnMic.dataset.key = 'MIC';\n        navRow.appendChild(btnMic);\n        // !@# (Symbols P1)\n        let btnSymbols = document.createElement('button');\n        btnSymbols.className = 'global-keypad-btn key-special';\n        btnSymbols.textContent = '!@#';\n        btnSymbols.dataset.key = '!@#';\n        btnSymbols.addEventListener('click', handleGlobalKeypadClick);\n        navRow.appendChild(btnSymbols);\n        globalKeyboardGrid.appendChild(navRow);\n        // Render the Emojis\n        filteredEmojis.forEach((emoji)=>{\n            const button = document.createElement('button');\n            button.className = 'global-keypad-btn key-emoji';\n            button.dataset.key = emoji;\n            button.textContent = emoji;\n            button.addEventListener('click', handleGlobalKeypadClick);\n            globalKeyboardGrid.appendChild(button);\n        });\n    }\n    // Main click handler for the Global Keyboard\n    function handleGlobalKeypadClick(e) {\n        e.preventDefault();\n        const key = e.target.dataset.key;\n        // *** CHANGE textContent to value ***\n        let currentValue = globalKeyboardDisplay.value; // Get value from textarea\n        const isTargetDateInput = activeGlobalInput && activeGlobalInput.type === 'date';\n        const isTargetTimeInput = activeGlobalInput && activeGlobalInput.type === 'time';\n        const isTargetDateOrTimeInput = isTargetDateInput || isTargetTimeInput;\n        // *** NEW: Get current cursor position ***\n        const start = globalKeyboardDisplay.selectionStart; //\n        const end = globalKeyboardDisplay.selectionEnd; //\n        // *** END NEW ***\n        clearTimeout(globalKeyboardState.longPressTimer);\n        // --- Navigation Logic (Remains the same) ---\n        // ... (if/else if blocks for '?123', 'ABC', etc.) ...\n        // --- Character Input / Special Actions ---\n        // Handle BACKSPACE\n        if (key === 'BACK') {\n            if (isTargetDateOrTimeInput) ;\n            else {\n                // *** MODIFIED: Handle backspace with cursor position ***\n                if (start === end && start > 0) {\n                    currentValue = currentValue.substring(0, start - 1) + currentValue.substring(end); //\n                    globalKeyboardDisplay.value = currentValue; // Update value\n                    globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start - 1; // Move cursor back\n                } else if (start !== end) {\n                    currentValue = currentValue.substring(0, start) + currentValue.substring(end); //\n                    globalKeyboardDisplay.value = currentValue; // Update value\n                    globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start; // Move cursor to start of deletion\n                }\n            // *** END MODIFIED ***\n            }\n        } else if (key === 'ENTER' || key === 'RETURN_KEY') {\n            if (isTargetDateOrTimeInput) ;\n            else {\n                // *** MODIFIED: Insert newline at cursor ***\n                const newline = '\\n';\n                currentValue = currentValue.substring(0, start) + newline + currentValue.substring(end); //\n                globalKeyboardDisplay.value = currentValue; // Update value\n                globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + newline.length; // Move cursor after newline\n            // *** END MODIFIED ***\n            }\n        } else if (key === 'SHIFT') {\n            globalKeyboardState.case === 'lower' ? globalKeyboardState.case = 'shift' : globalKeyboardState.case === 'shift' ? globalKeyboardState.case = 'upper' : globalKeyboardState.case = 'lower';\n            renderGlobalKeyboard();\n            return;\n        } else if (key === 'SPACE') {\n            const space = ' ';\n            currentValue = currentValue.substring(0, start) + space + currentValue.substring(end); //\n            globalKeyboardDisplay.value = currentValue; // Update value\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + space.length; // Move cursor after space\n        } else if (key === \", / \\uD83D\\uDE00\" || key === 'COMMA') {\n            const char = globalKeyboardState.currentPage === 'LetterPad' && globalKeyboardState.case === 'lower' ? ',' : ',';\n            currentValue = currentValue.substring(0, start) + char + currentValue.substring(end);\n            globalKeyboardDisplay.value = currentValue;\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length;\n        } else if (key === 'GLOBE' || key === 'MIC') return;\n        else if (key === 'DOT' || key === '.') {\n            const char = '.';\n            currentValue = currentValue.substring(0, start) + char + currentValue.substring(end);\n            globalKeyboardDisplay.value = currentValue;\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length;\n        } else if (key >= '0' && key <= '9') {\n            if (isTargetDateInput || isTargetTimeInput) ;\n            else {\n                // *** MODIFIED: Insert digit at cursor ***\n                currentValue = currentValue.substring(0, start) + key + currentValue.substring(end); //\n                globalKeyboardDisplay.value = currentValue; // Update value\n                globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + 1; // Move cursor after digit\n            // *** END MODIFIED ***\n            }\n        } else {\n            if (isTargetDateOrTimeInput) return; // Ignore letters/symbols for date/time input\n            const char = getCharForCase(key);\n            // *** MODIFIED: Insert character at cursor ***\n            currentValue = currentValue.substring(0, start) + char + currentValue.substring(end); //\n            globalKeyboardDisplay.value = currentValue; // Update value\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length; // Move cursor after character\n            // *** END MODIFIED ***\n            if (globalKeyboardState.case === 'shift') {\n                globalKeyboardState.case = 'lower';\n                renderGlobalKeyboard();\n            }\n        }\n        // --- Update non-date input fields and dispatch event ---\n        if (!isTargetDateOrTimeInput && activeGlobalInput) {\n            // *** CHANGE textContent to value ***\n            activeGlobalInput.value = globalKeyboardDisplay.value; // Sync original input\n            activeGlobalInput.dispatchEvent(new Event('input'));\n        }\n        // Scroll keypad display if needed\n        globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight; //\n        // *** NEW: Refocus the textarea after button click ***\n        globalKeyboardDisplay.focus(); //\n    }\n    // --- END NEW: Global Keyboard Rendering and Logic ---\n    // Wire up search bar listener for emoji filtering\n    emojiSearchInput?.addEventListener('input', (e)=>{\n        renderGlobalKeyboard(e.target.value);\n    });\n    function applyFontSize() {\n        document.body.style.setProperty('--font-size-multiplier', state.uiSettings.fontSizeMultiplier);\n    }\n    function applyDisplaySize() {\n        document.body.style.setProperty('--display-size-multiplier', state.uiSettings.displaySizeMultiplier);\n    }\n    function showEditStylesModal() {\n        // Logic to update the Font Size buttons\n        const currentFontMultiplier = state.uiSettings.fontSizeMultiplier;\n        const fontSelector = document.getElementById('font-size-selector');\n        if (fontSelector) fontSelector.querySelectorAll('button').forEach((btn)=>{\n            // Use parseFloat to ensure a proper number comparison\n            const btnSize = parseFloat(btn.dataset.size);\n            btn.classList.toggle('active', btnSize === currentFontMultiplier);\n        });\n        // Logic to update the Display Size buttons\n        const currentDisplayMultiplier = state.uiSettings.displaySizeMultiplier;\n        const displaySelector = document.getElementById('display-size-selector');\n        if (displaySelector) displaySelector.querySelectorAll('button').forEach((btn)=>{\n            btn.classList.toggle('active', parseFloat(btn.dataset.size) === currentDisplayMultiplier);\n        });\n        // Hide the admin modal and show the styles modal\n        adminSettingsModal.classList.add('hidden');\n        editStylesModal.classList.remove('hidden');\n    }\n    // --- NEW HELPER: Find which page a data-key belongs to ---\n    function findKeyPage(dataKeyToFind) {\n        for(const pageName in KEYBOARD_LAYOUTS){\n            const layout = KEYBOARD_LAYOUTS[pageName];\n            for (const row of layout){\n                if (row.includes(dataKeyToFind)) return pageName; // Return the name of the page (e.g., 'SymbolsP1')\n            }\n        }\n        // Check special combined keys specifically\n        if (dataKeyToFind === ',' || dataKeyToFind === '/' || dataKeyToFind === \"\\uD83D\\uDE00\") {\n            if (KEYBOARD_LAYOUTS['LetterPad'][3].includes(\", / \\uD83D\\uDE00\")) return 'LetterPad';\n        }\n        if (dataKeyToFind === '.') {\n            if (KEYBOARD_LAYOUTS['NumberPad'][3].includes('DOT')) return 'NumberPad';\n        }\n        if (dataKeyToFind === '%') {\n            if (KEYBOARD_LAYOUTS['NumberPad'][0].includes('PERCENT')) return 'NumberPad';\n        }\n        return null; // Key not found in any standard layout\n    }\n    // --- END NEW HELPER ---\n    function handleFontSizeChange(newMultiplier) {\n        state.uiSettings.fontSizeMultiplier = newMultiplier;\n        applyFontSize();\n        saveState();\n        // Update active button in the UI\n        const selector = document.getElementById('font-size-selector');\n        if (selector) selector.querySelectorAll('button').forEach((btn)=>{\n            btn.classList.remove('active');\n            if (parseFloat(btn.dataset.size) === newMultiplier) btn.classList.add('active');\n        });\n    }\n    function handleDisplaySizeChange(newMultiplier) {\n        state.uiSettings.displaySizeMultiplier = newMultiplier;\n        applyDisplaySize();\n        saveState();\n        const selector = document.getElementById('display-size-selector');\n        if (selector) selector.querySelectorAll('button').forEach((btn)=>{\n            btn.classList.remove('active');\n            if (parseFloat(btn.dataset.size) === newMultiplier) btn.classList.add('active');\n        });\n    }\n    function getWindDirection(degrees) {\n        const directions = [\n            'N',\n            'NNE',\n            'NE',\n            'ENE',\n            'E',\n            'ESE',\n            'SE',\n            'SSE',\n            'S',\n            'SSW',\n            'SW',\n            'WSW',\n            'W',\n            'WNW',\n            'NW',\n            'NNW'\n        ];\n        const index = Math.round(degrees / 22.5) % 16;\n        return directions[index];\n    }\n    function getAqiLabel(value) {\n        if (value <= 20) return 'Good';\n        if (value <= 40) return 'Fair';\n        if (value <= 60) return 'Moderate';\n        if (value <= 80) return 'Poor';\n        if (value <= 100) return 'Very Poor';\n        return 'Extremely Poor';\n    }\n    /**\r\n     * Translates a WMO weather code into a display icon.\r\n     * @param {number} code The WMO weather code from the API.\r\n     * @param {boolean} isDay Whether it is currently daytime (defaults to true).\r\n     * @returns {string} An emoji character representing the weather.\r\n     */ function wmoCodeToText(code, isSpecificTime = false) {\n        switch(code){\n            case 0:\n                return 'Clear sky';\n            case 1:\n                return 'Mainly clear';\n            case 2:\n                return 'Partly cloudy';\n            case 3:\n                return 'Overcast';\n            case 45:\n            case 48:\n                return 'Fog';\n            case 51:\n            case 53:\n            case 55:\n                return 'Drizzle';\n            case 56:\n            case 57:\n                return 'Freezing Drizzle';\n            case 61:\n                return 'Slight rain';\n            case 63:\n                return 'Moderate rain';\n            case 65:\n                return 'Heavy rain';\n            case 66:\n            case 67:\n                return 'Freezing Rain';\n            case 71:\n            case 73:\n            case 75:\n                return 'Snow fall';\n            case 77:\n                return 'Snow grains';\n            case 80:\n            case 81:\n            case 82:\n                return 'Rain showers';\n            case 85:\n            case 86:\n                return 'Snow showers';\n            case 95:\n                return 'Thunderstorm';\n            case 96:\n            case 99:\n                return isSpecificTime ? 'Thunderstorm with hail' : 'A thunderstorm this morning; otherwise, clouds and sun';\n            default:\n                return 'Unknown';\n        }\n    }\n    function getWeatherIcon(code, isDay = true) {\n        switch(code){\n            case 0:\n                return isDay ? \"\\u2600\\uFE0F\" : \"\\uD83C\\uDF19\"; // Clear sky\n            case 1:\n                return \"\\uD83C\\uDF24\\uFE0F\"; // Mainly clear\n            case 2:\n                return \"\\u26C5\\uFE0F\"; // Partly cloudy\n            case 3:\n                return \"\\u2601\\uFE0F\"; // Overcast\n            case 45:\n            case 48:\n                return \"\\uD83C\\uDF2B\\uFE0F\"; // Fog\n            case 51:\n            case 53:\n            case 55:\n                return \"\\uD83C\\uDF26\\uFE0F\"; // Drizzle\n            case 56:\n            case 57:\n                return \"\\uD83E\\uDD76\"; // Freezing Drizzle\n            case 61:\n            case 63:\n            case 65:\n                return \"\\uD83C\\uDF27\\uFE0F\"; // Rain\n            case 66:\n            case 67:\n                return \"\\uD83E\\uDD76\"; // Freezing Rain\n            case 71:\n            case 73:\n            case 75:\n                return \"\\uD83C\\uDF28\\uFE0F\"; // Snow fall\n            case 77:\n                return \"\\u2744\\uFE0F\"; // Snow grains\n            case 80:\n            case 81:\n            case 82:\n                return \"\\u26C8\\uFE0F\"; // Rain showers\n            case 85:\n            case 86:\n                return \"\\uD83C\\uDF28\\uFE0F\"; // Snow showers\n            case 95:\n            case 96:\n            case 99:\n                return \"\\uD83C\\uDF29\\uFE0F\"; // Thunderstorm\n            default:\n                return \"\\uD83E\\uDD37\";\n        }\n    }\n    function getWindDirection(degrees) {\n        const directions = [\n            'N',\n            'NNE',\n            'NE',\n            'ENE',\n            'E',\n            'ESE',\n            'SE',\n            'SSE',\n            'S',\n            'SSW',\n            'SW',\n            'WSW',\n            'W',\n            'WNW',\n            'NW',\n            'NNW'\n        ];\n        const index = Math.round(degrees / 22.5) % 16;\n        return directions[index];\n    }\n    function getAqiLabel(value) {\n        if (value <= 20) return 'Good';\n        if (value <= 40) return 'Fair';\n        if (value <= 60) return 'Moderate';\n        if (value <= 80) return 'Poor';\n        if (value <= 100) return 'Very Poor';\n        return 'Extremely Poor';\n    }\n    async function fetchWeather() {\n        const weatherDisplay = document.getElementById('weather-display');\n        if (!weatherDisplay) return;\n        const lat = -25.8417;\n        const lon = 28.1593;\n        // MODIFIED: Fetch daily stats and hourly data for specific weather codes and dew point\n        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&hourly=weathercode,dewpoint_2m&timezone=auto`;\n        try {\n            const response = await fetch(apiUrl);\n            if (!response.ok) {\n                weatherDisplay.textContent = 'Weather unavailable';\n                return;\n            }\n            const data = await response.json();\n            // --- Extract Data ---\n            const now = new Date();\n            const currentHour = now.getHours();\n            // Daily Stats\n            const maxTemp = Math.round(data.daily.temperature_2m_max[0]);\n            const minTemp = Math.round(data.daily.temperature_2m_min[0]);\n            // Hourly Stats for Icons & Dew Point\n            const morningWeatherCode = data.hourly.weathercode[9]; // Weather at 9 AM\n            const afternoonWeatherCode = data.hourly.weathercode[15]; // Weather at 3 PM\n            const dewPoint = Math.round(data.hourly.dewpoint_2m[currentHour]); // Dew point for the current hour\n            // Get Icons\n            const morningIcon = getWeatherIcon(morningWeatherCode);\n            const afternoonIcon = getWeatherIcon(afternoonWeatherCode);\n            const dewPointIcon = \"\\uD83D\\uDCA7\"; // Droplet icon\n            // --- Create HTML Structure ---\n            weatherDisplay.innerHTML = `\n                <div id=\"icon-fader\">\n                    <span class=\"weather-icon icon-max is-visible\">${afternoonIcon}</span>\n                    <span class=\"weather-icon icon-min\">${morningIcon}</span>\n                    <span class=\"weather-icon icon-dew\">${dewPointIcon}</span>\n                </div>\n                <div id=\"temp-fader\">\n                    <span class=\"temp-max is-visible\">${maxTemp}\\xb0C</span>\n                    <span class=\"temp-min\">${minTemp}\\xb0C</span>\n                    <span class=\"temp-dew\">${dewPoint}\\xb0C</span>\n                </div>\n            `;\n            // --- Start Animation Cycle ---\n            const elements = {\n                icons: [\n                    weatherDisplay.querySelector('.icon-max'),\n                    weatherDisplay.querySelector('.icon-min'),\n                    weatherDisplay.querySelector('.icon-dew')\n                ],\n                temps: [\n                    weatherDisplay.querySelector('.temp-max'),\n                    weatherDisplay.querySelector('.temp-min'),\n                    weatherDisplay.querySelector('.temp-dew')\n                ]\n            };\n            let currentState = 0; // 0 = Max, 1 = Min, 2 = Dew\n            const totalStates = 3;\n            // Clear any existing interval to prevent multiple animations running\n            if (window.weatherAnimationInterval) clearInterval(window.weatherAnimationInterval);\n            window.weatherAnimationInterval = setInterval(()=>{\n                const nextState = (currentState + 1) % totalStates;\n                elements.icons[currentState].classList.remove('is-visible');\n                elements.temps[currentState].classList.remove('is-visible');\n                elements.icons[nextState].classList.add('is-visible');\n                elements.temps[nextState].classList.add('is-visible');\n                currentState = nextState;\n            }, 5000); // Run this sequence every 5 seconds\n        } catch (error) {\n            console.error('Failed to fetch weather:', error);\n            // Fallback display on API error\n            const lowTemp = 12; // Placeholder low temperature\n            const highTemp = 25; // Placeholder high temperature\n            weatherDisplay.innerHTML = `\n                <div id=\"temp-fader\">\n                    <span class=\"temp-min is-visible\">${lowTemp}\\xb0C</span>\n                    <span class=\"temp-max\">${highTemp}\\xb0C</span>\n                </div>`;\n            if (window.weatherAnimationInterval) clearInterval(window.weatherAnimationInterval);\n            let isLowVisible = true;\n            window.weatherAnimationInterval = setInterval(()=>{\n                const lowEl = weatherDisplay.querySelector('.temp-min');\n                const highEl = weatherDisplay.querySelector('.temp-max');\n                if (lowEl && highEl) {\n                    lowEl.classList.toggle('is-visible', !isLowVisible);\n                    highEl.classList.toggle('is-visible', isLowVisible);\n                    isLowVisible = !isLowVisible;\n                }\n            }, 5000);\n        }\n    }\n    function renderCurrentWeatherModal() {\n        if (!state.weatherData) return;\n        const { current } = state.weatherData;\n        document.getElementById('cw-time').textContent = current.time;\n        document.getElementById('cw-icon').textContent = getWeatherIcon(current.weatherCode);\n        document.getElementById('cw-temp').textContent = `${current.temp}\\xb0`;\n        document.getElementById('cw-realfeel').textContent = `${current.realFeel}\\xb0`;\n        document.getElementById('cw-realfeel-shade').textContent = `${current.realFeel}\\xb0`; // Current doesn't have shade\n        document.getElementById('cw-description').textContent = wmoCodeToText(current.weatherCode);\n        document.getElementById('cw-wind').textContent = `${current.windDir} ${current.windSpeed} km/h`;\n        document.getElementById('cw-wind-gusts').textContent = `${current.windGusts} km/h`;\n        const aqiEl = document.getElementById('cw-air-quality');\n        aqiEl.textContent = getAqiLabel(current.aqi);\n        aqiEl.className = `aqi-${getAqiLabel(current.aqi).toLowerCase().replace(' ', '')}`;\n    }\n    function renderDetailedWeatherModal() {\n        if (!state.weatherData) return;\n        const { current, day, morning, afternoon } = state.weatherData;\n        const view = state.detailedWeatherView;\n        // Update active tab\n        document.querySelectorAll('.weather-tabs .tab').forEach((tab)=>{\n            tab.classList.toggle('active', tab.dataset.view === view);\n        });\n        // Populate top section (Detailed Current)\n        document.getElementById('dw-uv').textContent = `${current.uv} (Low)`;\n        document.getElementById('dw-dewpoint').textContent = `${current.dewPoint}\\xb0`;\n        document.getElementById('dw-humidity').textContent = `${current.humidity}%`;\n        document.getElementById('dw-pressure').textContent = `\\u{2191} ${current.pressure} mb`;\n        document.getElementById('dw-cloud-cover').textContent = `${current.cloudCover}%`;\n        document.getElementById('dw-visibility').textContent = `${current.visibility} km`;\n        // Populate bottom section (Forecast) based on view\n        let forecastData;\n        let gridHtml = '';\n        switch(view){\n            case 'morning':\n                forecastData = morning;\n                gridHtml = `\n                    <div class=\"weather-item\"><span>Wind</span><strong>${forecastData.windDir} ${forecastData.windSpeed} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\n                    <div class=\"weather-item\"><span>Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\n                    <div class=\"weather-item\"><span>Humidity</span><strong>${forecastData.humidity}%</strong></div>\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\n                break;\n            case 'afternoon':\n                forecastData = afternoon;\n                gridHtml = `\n                    <div class=\"weather-item\"><span>Wind</span><strong>${forecastData.windDir} ${forecastData.windSpeed} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\n                    <div class=\"weather-item\"><span>Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\n                    <div class=\"weather-item\"><span>Humidity</span><strong>${forecastData.humidity}%</strong></div>\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\n                break;\n            case 'day':\n            default:\n                forecastData = day;\n                gridHtml = `\n                    <div class=\"weather-item\"><span>Max UV Index</span><strong>${forecastData.uv} (Very High)</strong></div>\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\n                    <div class=\"weather-item\"><span>Max Wind</span><strong>${forecastData.windSpeed} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Max Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\n                break;\n        }\n        document.getElementById('forecast-icon').textContent = getWeatherIcon(forecastData.weatherCode);\n        document.getElementById('forecast-temp').textContent = `${forecastData.temp}\\xb0`;\n        document.getElementById('forecast-realfeel').textContent = `${forecastData.realFeel}\\xb0`;\n        document.getElementById('forecast-realfeel-shade').textContent = `${forecastData.realFeelShade}\\xb0`;\n        document.getElementById('forecast-description').textContent = wmoCodeToText(forecastData.weatherCode, view !== 'day');\n        document.getElementById('forecast-grid').innerHTML = gridHtml;\n    }\n    // ADDED FUNCTION: Determines if any court light is on\n    function getLightStatusIcon() {\n        const courtLights = state.lightSettings.courts;\n        for(const courtId1 in courtLights){\n            // Only check court lights, not general ones\n            if (courtLights[courtId1].isActive) return {\n                class: 'mdi-lightbulb-on',\n                icon: 'mdi mdi-lightbulb-on'\n            };\n        }\n        return {\n            class: 'mdi-lightbulb-outline',\n            icon: 'mdi mdi-lightbulb-outline'\n        };\n    }\n    // ADDED FUNCTION: Updates the icon in the Admin Settings button\n    function updateLightIcon() {\n        const lightButton = document.getElementById('light-management-btn');\n        if (lightButton) {\n            const iconData = getLightStatusIcon();\n            let iconElement = lightButton.querySelector('i');\n            // Ensure the <i> element exists and is the target for class updates\n            if (!iconElement) {\n                // Re-create the <i> tag if it was accidentally removed (e.g., by emoji changes)\n                lightButton.innerHTML = `<i class=\"${iconData.icon}\"></i>`;\n                iconElement = lightButton.querySelector('i');\n            }\n            // This is the core update logic: remove old, add new\n            if (iconElement) {\n                iconElement.classList.remove('mdi-lightbulb-on', 'mdi-lightbulb-outline');\n                iconElement.classList.add(iconData.class);\n            }\n        }\n    }\n    async function sendLightCommand(light, isActive) {\n        const apiUrl = API_ENDPOINTS.controlLight;\n        // Get toggleAfter - 0 means permanent toggle, >0 means pulse control\n        const toggleAfter = light.toggleAfter || 0;\n        const shellyCloudUrl = state.lightSettings?.shellyBaseUrl || '';\n        const authKey = state.lightSettings?.shellyAuthKey || '';\n        const deviceId = light.shellyCloudId || '';\n        const shellyIp = light.shellyDeviceId || '';\n        const bodyData = {\n            shellyCloudUrl: shellyCloudUrl,\n            authKey: authKey,\n            deviceId: deviceId,\n            toggleAfter: toggleAfter,\n            shellyIp: shellyIp,\n            state: isActive,\n            method: 'cloud-first'\n        };\n        const hasCloudConfig = !!(shellyCloudUrl && shellyCloudUrl.trim() && authKey && authKey.trim() && deviceId && deviceId.trim());\n        const hasLocalConfig = !!(shellyIp && shellyIp.trim());\n        console.log(`[Frontend] Sending ${toggleAfter === 0 ? 'toggle' : 'pulse'} command for ${light.label}:`, {\n            method: bodyData.method,\n            state: isActive,\n            toggleAfter: toggleAfter,\n            hasCloudConfig: hasCloudConfig,\n            hasLocalConfig: hasLocalConfig\n        });\n        if (!hasCloudConfig && !hasLocalConfig) {\n            console.error(\"[Frontend] \\u274C No control method configured!\");\n            return {\n                success: false,\n                message: 'No control method configured. Check Admin > Gate/Light Settings.'\n            };\n        }\n        try {\n            const response = await fetch(apiUrl, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify(bodyData),\n                signal: AbortSignal.timeout(15000)\n            });\n            if (!response.ok) {\n                let errorMsg = `Server error: ${response.status}`;\n                try {\n                    const errorData = await response.json();\n                    errorMsg = errorData.message || errorData.error || errorMsg;\n                    console.error('[Frontend] Server error details:', errorData);\n                } catch (e) {}\n                console.error(`[Frontend] Error response from proxy: ${response.status}`);\n                throw new Error(errorMsg);\n            }\n            const data = await response.json();\n            console.log(`[Frontend] Response from proxy:`, data);\n            if (data.success) {\n                if (data.method) console.log(`[Frontend] \\u{2705} Control via: ${data.method.toUpperCase()}`);\n                return {\n                    success: true,\n                    data: data.data,\n                    method: data.method\n                };\n            } else return {\n                success: false,\n                message: data.message || data.error || 'Failed to control device.'\n            };\n        } catch (error) {\n            console.error(`[Frontend] Error calling proxy API:`, error);\n            if (error.name === 'AbortError') return {\n                success: false,\n                message: 'Request timed out.'\n            };\n            if (error.message.includes('Failed to fetch')) return {\n                success: false,\n                message: 'Network error.'\n            };\n            return {\n                success: false,\n                message: error.message\n            };\n        }\n    }\n    // Gate Control Functions\n    async function handleGateButtonClick(gateType) {\n        const gate = state.gateSettings?.[gateType];\n        const button = document.getElementById(`${gateType}-gate-btn`);\n        if (!gate) {\n            console.error(`Gate settings for ${gateType} not found!`);\n            playCustomTTS('Gate not configured.');\n            return;\n        }\n        if (!gate.isManaged) {\n            playCustomTTS(`${gate.label} control is disabled. Long-press to configure.`);\n            return;\n        }\n        console.log(`[Gate] Activating ${gate.label}...`);\n        // Disable button during pulse\n        button.disabled = true;\n        button.classList.add('pulsing');\n        // Send pulse command (turn on, will auto-off after 1 second via cloud API)\n        const apiResult = await sendLightCommand(gate, true);\n        // Keep pulsing animation for full 1 second\n        setTimeout(()=>{\n            button.classList.remove('pulsing');\n            button.disabled = false;\n        }, 1000);\n        if (apiResult.success) {\n            console.log(`[Gate] ${gate.label} activated successfully via ${apiResult.method}`);\n            playCustomTTS(`${gate.label} activated.`);\n        } else {\n            console.error(`[Gate] Failed to activate ${gate.label}:`, apiResult.message);\n            playCustomTTS(`Error: Failed to activate ${gate.label}.`);\n        }\n    }\n    function setupGateButtonLongPress(gateType) {\n        const button = document.getElementById(`${gateType}-gate-btn`);\n        if (!button) return;\n        // Pointer down - start timer\n        button.addEventListener('pointerdown', (e)=>{\n            gateButtonIsLongPress = false;\n            gateButtonPressTimer = setTimeout(()=>{\n                gateButtonIsLongPress = true;\n                console.log(`[Gate] Long press detected on ${gateType}`);\n                // Visual feedback\n                button.style.transform = 'scale(0.95)';\n                // Show settings modal\n                showGateSettingsModal(gateType);\n            }, 800); // 800ms for long press\n        });\n        // Pointer up - either short click or cancel long press\n        button.addEventListener('pointerup', (e)=>{\n            if (gateButtonPressTimer) clearTimeout(gateButtonPressTimer);\n            button.style.transform = '';\n            // Only trigger click if it wasn't a long press\n            if (!gateButtonIsLongPress) handleGateButtonClick(gateType);\n            gateButtonIsLongPress = false;\n        });\n        // Pointer leave - cancel timer\n        button.addEventListener('pointerleave', (e)=>{\n            if (gateButtonPressTimer) clearTimeout(gateButtonPressTimer);\n            button.style.transform = '';\n            gateButtonIsLongPress = false;\n        });\n    }\n    // ============================================================================\n    // GATE SETTINGS MODAL FUNCTIONS (SEPARATE MODALS)\n    // ============================================================================\n    function showGateSettingsModal(gateType) {\n        const modal = document.getElementById(`${gateType}-gate-settings-modal`);\n        const gate = state.gateSettings?.[gateType] || {\n            shellyCloudId: '',\n            shellyDeviceId: '',\n            isManaged: false\n        };\n        // Populate fields\n        document.getElementById(`${gateType}-gate-managed`).checked = gate.isManaged;\n        document.getElementById(`${gateType}-gate-cloud-id`).value = gate.shellyCloudId || '';\n        document.getElementById(`${gateType}-gate-local-ip`).value = gate.shellyDeviceId || '';\n        modal.classList.remove('hidden');\n    }\n    function saveGateSettings(gateType) {\n        // Initialize gateSettings if it doesn't exist\n        if (!state.gateSettings) state.gateSettings = {\n            pedestrian: {\n                label: 'Pedestrian Gate',\n                toggleAfter: 1\n            },\n            parking: {\n                label: 'Parking Lot Gate',\n                toggleAfter: 1\n            }\n        };\n        // Ensure this gate exists\n        if (!state.gateSettings[gateType]) state.gateSettings[gateType] = {\n            label: gateType === 'pedestrian' ? 'Pedestrian Gate' : 'Parking Lot Gate',\n            toggleAfter: 1\n        };\n        // Save settings\n        state.gateSettings[gateType].isManaged = document.getElementById(`${gateType}-gate-managed`).checked;\n        state.gateSettings[gateType].shellyCloudId = document.getElementById(`${gateType}-gate-cloud-id`).value.trim();\n        state.gateSettings[gateType].shellyDeviceId = document.getElementById(`${gateType}-gate-local-ip`).value.trim();\n        state.gateSettings[gateType].toggleAfter = 1; // Always 1 second for gates\n        // Clear settings if not managed\n        if (!state.gateSettings[gateType].isManaged) {\n            state.gateSettings[gateType].shellyCloudId = '';\n            state.gateSettings[gateType].shellyDeviceId = '';\n        }\n        console.log(`[Gate Settings] Saved ${gateType}:`, state.gateSettings[gateType]);\n        saveState();\n        document.getElementById(`${gateType}-gate-settings-modal`).classList.add('hidden');\n        playCustomTTS(`${state.gateSettings[gateType].label} settings saved.`);\n    }\n    // Event Listeners (add these in your DOMContentLoaded section)\n    document.getElementById('pedestrian-gate-btn')?.addEventListener('click', ()=>{\n        handleGateButtonClick('pedestrian');\n    });\n    document.getElementById('parking-gate-btn')?.addEventListener('click', ()=>{\n        handleGateButtonClick('parking');\n    });\n    function setupCourtLightLongPress() {\n        // This should be called after court cards are rendered\n        const lightButtons = document.querySelectorAll('.light-toggle-btn');\n        lightButtons.forEach((button)=>{\n            const courtId1 = button.dataset.courtId;\n            // Pointer down - start timer\n            button.addEventListener('pointerdown', (e)=>{\n                lightIconIsLongPress = false;\n                lightIconPressTimer = setTimeout(()=>{\n                    lightIconIsLongPress = true;\n                    console.log(`[Light] Long press detected on Court ${courtId1}`);\n                    // Visual feedback\n                    button.style.transform = 'scale(0.9)';\n                    // Show settings modal for this court\n                    showLightSettingsForCourt(courtId1);\n                }, 800); // 800ms for long press\n            });\n            // Pointer up - check if it was a long press\n            button.addEventListener('pointerup', (e)=>{\n                if (lightIconPressTimer) clearTimeout(lightIconPressTimer);\n                button.style.transform = '';\n                // If it WAS a long press, don't toggle the light\n                if (lightIconIsLongPress) {\n                    e.stopPropagation();\n                    e.preventDefault();\n                }\n                // Otherwise, the existing handleLightToggleChange will handle it\n                lightIconIsLongPress = false;\n            });\n            // Pointer leave - cancel timer\n            button.addEventListener('pointerleave', (e)=>{\n                if (lightIconPressTimer) clearTimeout(lightIconPressTimer);\n                button.style.transform = '';\n                lightIconIsLongPress = false;\n            });\n        });\n    }\n    function showLightSettingsForCourt(courtId1) {\n        const modal = document.getElementById('light-settings-court-modal');\n        const court = state.lightSettings?.courts?.[courtId1];\n        if (!court) {\n            console.error(`No light settings for court ${courtId1}`);\n            playCustomTTS('Court light settings not found.');\n            return;\n        }\n        // Update modal title\n        document.getElementById('light-settings-court-title').textContent = `Court ${courtId1} Light Settings`;\n        // Store which court we're editing\n        modal.dataset.editingCourtId = courtId1;\n        // Load global settings (same for all courts)\n        document.getElementById('light-setting-base-url').value = state.lightSettings.shellyBaseUrl || '';\n        document.getElementById('light-setting-auth-key').value = state.lightSettings.shellyAuthKey || '';\n        // Load court-specific settings\n        document.getElementById('light-setting-label').value = court.label || `Court ${courtId1} Lights`;\n        document.getElementById('light-setting-cloud-id').value = court.shellyCloudId || '';\n        document.getElementById('light-setting-local-ip').value = court.shellyDeviceId || '';\n        document.getElementById('light-setting-managed').checked = court.isManaged || false;\n        modal.classList.remove('hidden');\n        // ← ADD THESE 5 LINES HERE (before closing brace):\n        wireGlobalKeypadToInput(document.getElementById('light-setting-base-url'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-auth-key'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-label'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-cloud-id'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-local-ip'));\n    }\n    // Call this after rendering courts\n    // Add to your renderCourts() function or wherever courts are created:\n    // setupCourtLightLongPress();\n    // ADDED FUNCTION - This is the core logic for the light feature.\n    async function handleLightToggleChange(e) {\n        const button = e.target.closest('.light-toggle-btn');\n        if (!button) return;\n        const courtId1 = button.dataset.courtId;\n        const light = state.lightSettings.courts[courtId1];\n        if (light) {\n            // Toggle the state\n            const isActive = !light.isActive;\n            // Optimistically update UI\n            light.isActive = isActive;\n            const icon = button.querySelector('i');\n            icon.className = `mdi ${isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline'}`;\n            // Send command\n            const apiResult = await sendLightCommand(light, isActive);\n            if (!apiResult.success) {\n                // Revert state and UI if API call fails\n                light.isActive = !isActive;\n                icon.className = `mdi ${!isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline'}`;\n                playCustomTTS(`Error: Failed to turn light ${isActive ? 'on' : 'off'}. ${apiResult.message}`);\n            } else playCustomTTS(`${light.label} turned ${isActive ? 'on' : 'off'}.`);\n            saveState();\n        }\n    }\n    // Now checks if stock is < 1 can to disable sign out buttons.\n    function updateBallStockDisplay() {\n        if (ballStockCount) {\n            ballStockCount.textContent = state.ballManagement.stock;\n            const isStockLow = state.ballManagement.stock < 1;\n            signOutOptions.querySelectorAll('.sign-out-btn').forEach((btn)=>{\n                btn.disabled = isStockLow;\n                btn.style.opacity = isStockLow ? 0.5 : 1;\n            });\n        }\n    }\n    // NEW FUNCTION: Updates the display for single used balls\n    function updateUsedBallStockDisplay() {\n        if (usedBallStockCount) usedBallStockCount.textContent = state.ballManagement.usedStock;\n    }\n    // NEW FUNCTION: Initial Entry Point for Returning Used Balls\n    function handleReturnUsedBalls() {\n        showMemberSelectionModal('return_used');\n    }\n    // NEW FUNCTION: Final Confirmation for USED BALL RETURN\n    function confirmUsedBallReturn() {\n        const value = parseInt(keypadDisplay.textContent, 10);\n        const member = customKeypadModal.dataset.member;\n        hideKeypad();\n        if (isNaN(value) || value <= 0) return;\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Used Ball Return\";\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm returning ${value} used ball(s), signed in by ${member}?`;\n        modalBtnYesConfirm.textContent = \"Confirm Return\";\n        modalBtnNo.textContent = \"Cancel\";\n        cancelConfirmModal.dataset.mode = \"returnUsedBalls\";\n        cancelConfirmModal.dataset.count = value;\n        cancelConfirmModal.dataset.member = member;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // NEW FUNCTION: Execute USED BALL RETURN\n    function executeUsedBallReturn() {\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\n        const member = cancelConfirmModal.dataset.member;\n        if (isNaN(count) || count <= 0) return;\n        const stockBefore = state.ballManagement.usedStock;\n        state.ballManagement.usedStock += count;\n        const stockAfter = state.ballManagement.usedStock;\n        state.ballManagement.history.push({\n            timestamp: Date.now(),\n            action: 'in',\n            category: 'return_used',\n            count: count,\n            member: member,\n            stockBefore: stockBefore,\n            stockAfter: stockAfter\n        });\n        //playCustomTTS(`Stock updated. Returned ${count} used balls.`);\n        updateUsedBallStockDisplay();\n        saveState();\n        cancelConfirmModal.classList.add(\"hidden\");\n        ballManagementModal.classList.remove(\"hidden\");\n        resetConfirmModal();\n    }\n    // NEW FUNCTION: Handles ball history filter changes\n    function handleBallHistoryFilterChange(e) {\n        state.ballManagement.historyFilter = e.target.value;\n        saveState();\n        renderBallHistoryModal();\n    }\n    function showBallManagementModal() {\n        updateBallStockDisplay();\n        updateUsedBallStockDisplay(); // <-- ADD THIS LINE\n        adminSettingsModal.classList.add('hidden');\n        ballManagementModal.classList.remove('hidden');\n    }\n    // --- REFACTORED WORKFLOW ---\n    // 1. Initial Entry Point for Add/Return\n    function handleAddStock() {\n        showMemberSelectionModal('add');\n    }\n    function handleReturnStock() {\n        showMemberSelectionModal('return');\n    }\n    // NEW FUNCTION: Handles the selection of Cans or Singles for a Sale\n    function handleSaleStockTypeSelection(stockType) {\n        if (stockType === 'cans' && state.ballManagement.stock === 0) {\n            playCustomTTS(\"Cannot sell cans. Stock is empty.\");\n            return;\n        }\n        if (stockType === 'singles' && state.ballManagement.usedStock === 0) {\n            playCustomTTS(\"Cannot sell old balls. Used stock is empty.\");\n            return;\n        }\n        // Store the selection\n        state.ballManagement.tempSale.stockType = stockType;\n        ballSaleTypeModal.classList.add('hidden');\n        // Next step is always to select the committee member who is signing out the stock\n        // The category is hardcoded as 'Sale' to trigger the custom sale flow in handleMemberSelectionConfirm\n        showMemberSelectionModal('signout', 'Sale');\n    }\n    // NEW FUNCTION: Confirms the purchaser and proceeds to quantity keypad (Step 4 is skipped)\n    function confirmPurchaser(purchaserName, purchaserType) {\n        const tempSale = state.ballManagement.tempSale;\n        const memberSignOut = tempSale.memberSignOut; // Committee member's name\n        tempSale.purchaserName = purchaserName;\n        tempSale.purchaserType = purchaserType;\n        // Close the relevant modal if it's not already closed\n        guestNameModal.classList.add('hidden');\n        document.getElementById('returning-guest-modal').classList.add('hidden');\n        purchaserSelectionModal.classList.add('hidden');\n        // CRITICAL FIX: Ensure ALL required context variables are set on the keypad modal\n        customKeypadModal.dataset.member = memberSignOut;\n        customKeypadModal.dataset.action = 'signout';\n        customKeypadModal.dataset.purchaserName = purchaserName;\n        customKeypadModal.dataset.category = 'Sale'; // <-- FIX: Set the category explicitly here!\n        // Proceed to quantity keypad\n        showKeypad(null, {\n            mode: 'signOut',\n            maxLength: 2,\n            title: `Quantity for ${purchaserName}`\n        });\n    }\n    // 2. Initial Entry Point for Sign Out\n    function handleSignOut(e) {\n        const button = e.target.closest('.sign-out-btn');\n        if (!button) return;\n        if (button.disabled) //playCustomTTS(\"Sign out requires balls. Please add stock first.\");\n        return;\n        const category = button.dataset.category;\n        // --- NEW LOGIC: Start sale flow if category is 'Sale' ---\n        if (category === 'Sale') {\n            // CRITICAL FIX: Clear temporary sale state before starting new flow\n            state.ballManagement.tempSale = {\n                stockType: null,\n                memberSignOut: null,\n                purchaserName: null,\n                purchaserType: null\n            };\n            ballManagementModal.classList.add('hidden');\n            ballSaleTypeModal.classList.remove('hidden');\n            return;\n        }\n        // --- END NEW LOGIC ---\n        showMemberSelectionModal('signout', category);\n    }\n    // 3. Generalized Member Selection Modal\n    function showMemberSelectionModal(action, category = null) {\n        signOutMemberList.innerHTML = '';\n        const indexElement = document.getElementById('sign-out-member-abc-index'); // Get index element\n        // Set modal prompt based on the action\n        // ... (rest of the prompt setting logic remains the same) ...\n        // Store action context in the modal\n        // ... (rest of the dataset setting logic remains the same) ...\n        const members = MASTER_MEMBER_LIST.filter((m)=>m.committee).sort((a, b)=>a.name.localeCompare(b.name));\n        if (members.length === 0) {\n            signOutMemberList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No committee members found.</li>';\n            indexElement.innerHTML = ''; // Clear index if list is empty\n            // ... (rest of the return logic remains the same) ...\n            return;\n        }\n        signOutMemberConfirmBtn.disabled = true;\n        members.forEach((member)=>{\n            const li = document.createElement('li');\n            li.className = 'committee-member';\n            li.dataset.player = member.name; // Use data-player for consistency\n            // --- ADD data-player-name attribute for index ---\n            li.dataset.playerName = member.name;\n            // --- END ADD ---\n            li.innerHTML = `<label><input type=\"radio\" name=\"signoutMember\" value=\"${member.name}\"><div class=\"member-details\"><span class=\"member-name\">${member.name}</span><span class=\"member-designation\">${member.committee || 'Member'}</span></div></label>`;\n            signOutMemberList.appendChild(li);\n        });\n        signOutMemberList.querySelectorAll('input[name=\"signoutMember\"]').forEach((radio)=>{\n            // Re-bind listener: remove old, add new\n            radio.removeEventListener('change', enableSignOutConfirm); // Use named function\n            radio.addEventListener('change', enableSignOutConfirm); // Use named function\n        });\n        // --- ADD THIS LINE ---\n        setupListWithIndex(members, signOutMemberList, indexElement);\n        // --- END ADD ---\n        adminSettingsModal.classList.add('hidden');\n        ballManagementModal.classList.add('hidden');\n        signOutMemberModal.classList.remove('hidden');\n    }\n    // --- NEW HELPER FUNCTION FOR ENABLING CONFIRM BUTTON ---\n    function enableSignOutConfirm() {\n        signOutMemberConfirmBtn.disabled = false;\n    }\n    // --- END NEW HELPER FUNCTION ---\n    // 4. Generalized Member Confirmation and Keypad Trigger\n    function handleMemberSelectionConfirm() {\n        const action = signOutMemberModal.dataset.action;\n        const member = signOutMemberList.querySelector('input[name=\"signoutMember\"]:checked').value;\n        // --- NEW LOGIC: If it's a sale, redirect to purchaser selection first ---\n        if (action === 'signout' && signOutMemberModal.dataset.category === 'Sale' && !state.ballManagement.tempSale.memberSignOut) {\n            signOutMemberModal.classList.add('hidden');\n            // This is the committee member who is signing out, pass their name to the next step\n            showPurchaserSelectionModal(member);\n            return;\n        }\n        // --- END NEW LOGIC ---\n        customKeypadModal.dataset.member = member;\n        customKeypadModal.dataset.action = action;\n        signOutMemberModal.classList.add('hidden');\n        if (action === 'add') showKeypad(null, {\n            mode: 'addStock',\n            maxLength: 3,\n            title: `Cans to add for ${member}`\n        });\n        else if (action === 'return') showKeypad(null, {\n            mode: 'returnStock',\n            maxLength: 3,\n            title: `Cans to return for ${member}`\n        });\n        else if (action === 'return_used') showKeypad(null, {\n            mode: 'returnUsed',\n            maxLength: 3,\n            title: `Used balls to return for ${member}`\n        });\n        else if (action === 'signout') {\n            const category = signOutMemberModal.dataset.category;\n            customKeypadModal.dataset.category = category;\n            // CRITICAL FIX: For a non-sale signout, manually set required data attributes on the keypad modal\n            const stockType = 'cans';\n            const purchaserName = member;\n            customKeypadModal.dataset.stockType = stockType;\n            customKeypadModal.dataset.purchaserName = purchaserName;\n            showKeypad(null, {\n                mode: 'signOut',\n                maxLength: 2,\n                title: `Cans for ${member} (${category})`\n            });\n        }\n    }\n    // 5a. Final Confirmation for ADD\n    function confirmBallStockUpdate() {\n        const value = parseInt(keypadDisplay.textContent, 10);\n        const member = customKeypadModal.dataset.member;\n        hideKeypad();\n        if (isNaN(value) || value <= 0) return;\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Purchase\";\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm adding ${value} new cans, signed in by ${member}?`;\n        modalBtnYesConfirm.textContent = \"Confirm Add\";\n        modalBtnNo.textContent = \"Cancel\";\n        cancelConfirmModal.dataset.mode = \"addBallStock\";\n        cancelConfirmModal.dataset.count = value;\n        cancelConfirmModal.dataset.member = member;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // 5b. Final Confirmation for RETURN\n    function confirmBallStockReturn() {\n        const value = parseInt(keypadDisplay.textContent, 10);\n        const member = customKeypadModal.dataset.member;\n        hideKeypad();\n        if (isNaN(value) || value <= 0) return;\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Return\";\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm returning ${value} can(s), signed in by ${member}?`;\n        modalBtnYesConfirm.textContent = \"Confirm Return\";\n        modalBtnNo.textContent = \"Cancel\";\n        cancelConfirmModal.dataset.mode = \"returnBallStock\";\n        cancelConfirmModal.dataset.count = value;\n        cancelConfirmModal.dataset.member = member;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // 5c. Final Confirmation for SIGN OUT\n    function confirmSignOutQuantity() {\n        const cansToSignOut = parseInt(keypadDisplay.textContent, 10);\n        const category = customKeypadModal.dataset.category;\n        const member = customKeypadModal.dataset.member;\n        // --- CONTEXT VARIABLES ---\n        const tempSale = state.ballManagement.tempSale;\n        // For sale transactions, pull all context from tempSale. For non-sale, use defaults.\n        const isSale = category === 'Sale';\n        // stockType is 'cans' by default for non-sale (League, Social)\n        const stockType = isSale ? tempSale.stockType : 'cans';\n        // purchaserName is the member's name by default for non-sale\n        const purchaserName = isSale ? tempSale.purchaserName : member;\n        const currentStock = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\n        // --- END CONTEXT VARIABLES ---\n        hideKeypad();\n        if (isNaN(cansToSignOut) || cansToSignOut <= 0 || cansToSignOut > currentStock) //playCustomTTS(\"Sign out failed. Invalid quantity or insufficient stock.\");\n        return;\n        // Determine modal title based on context\n        const modalTitle = isSale ? `Confirm Sign Out: ${stockType === 'cans' ? 'New Balls' : 'Old Balls'}` : `Confirm Sign Out: ${category}`;\n        cancelConfirmModal.querySelector(\"h3\").textContent = modalTitle;\n        // Determine prompt text:\n        let promptText;\n        if (isSale) // Sale prompt: uses stockType and purchaserName\n        promptText = `Confirm signing out ${cansToSignOut} ${stockType} to ${purchaserName}, by ${member}?`;\n        else // Non-Sale prompt: uses 'can(s)' and category (the fix)\n        promptText = `Confirm signing out ${cansToSignOut} can(s) for ${category}, by ${member}?`;\n        cancelConfirmModal.querySelector(\"p\").textContent = promptText;\n        modalBtnYesConfirm.textContent = \"Confirm Sign Out\";\n        modalBtnNo.textContent = \"Cancel\";\n        cancelConfirmModal.dataset.mode = \"signOutBalls\";\n        // Ensure all data is passed to the final execution step\n        cancelConfirmModal.dataset.category = category;\n        cancelConfirmModal.dataset.count = cansToSignOut;\n        cancelConfirmModal.dataset.member = member;\n        cancelConfirmModal.dataset.stockType = stockType;\n        cancelConfirmModal.dataset.purchaserName = purchaserName;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // 6a. Execute ADD\n    function executeAddBallStock() {\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\n        const member = cancelConfirmModal.dataset.member;\n        if (isNaN(count) || count <= 0) return;\n        const stockBefore = state.ballManagement.stock;\n        state.ballManagement.stock += count;\n        const stockAfter = state.ballManagement.stock;\n        state.ballManagement.history.push({\n            timestamp: Date.now(),\n            action: 'in',\n            category: 'purchase',\n            count: count,\n            member: member,\n            stockBefore: stockBefore,\n            stockAfter: stockAfter\n        });\n        //playCustomTTS(`Stock updated. Added ${count} cans.`);\n        updateBallStockDisplay();\n        saveState();\n        cancelConfirmModal.classList.add(\"hidden\");\n        ballManagementModal.classList.remove(\"hidden\");\n        resetConfirmModal(); // ADD THIS LINE\n    }\n    // 6b. Execute RETURN\n    function executeReturnBallStock() {\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\n        const member = cancelConfirmModal.dataset.member;\n        if (isNaN(count) || count <= 0) return;\n        const stockBefore = state.ballManagement.stock;\n        state.ballManagement.stock += count;\n        const stockAfter = state.ballManagement.stock;\n        state.ballManagement.history.push({\n            timestamp: Date.now(),\n            action: 'in',\n            category: 'return',\n            count: count,\n            member: member,\n            stockBefore: stockBefore,\n            stockAfter: stockAfter\n        });\n        //playCustomTTS(`Stock updated. Returned ${count} cans.`);\n        updateBallStockDisplay();\n        saveState();\n        cancelConfirmModal.classList.add(\"hidden\");\n        ballManagementModal.classList.remove(\"hidden\");\n        resetConfirmModal(); // ADD THIS LINE\n    }\n    // 6c. Execute SIGN OUT\n    function executeSignOutBalls() {\n        const cansCount = parseInt(cancelConfirmModal.dataset.count, 10);\n        const category = cancelConfirmModal.dataset.category;\n        const member = cancelConfirmModal.dataset.member;\n        // --- NEW CONTEXT VARIABLES ---\n        const stockType = cancelConfirmModal.dataset.stockType;\n        const purchaserName = cancelConfirmModal.dataset.purchaserName;\n        const currentStock = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\n        // --- END NEW CONTEXT VARIABLES ---\n        if (isNaN(cansCount) || currentStock < cansCount) {\n            playCustomTTS(\"Sign out failed. Insufficient stock.\");\n            return;\n        }\n        const stockBefore = currentStock;\n        if (stockType === 'cans') state.ballManagement.stock -= cansCount;\n        else state.ballManagement.usedStock -= cansCount;\n        const stockAfter = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\n        state.ballManagement.history.push({\n            timestamp: Date.now(),\n            action: 'out',\n            category: category,\n            count: cansCount,\n            member: member,\n            stockBefore: stockBefore,\n            stockAfter: stockAfter\n        });\n        // --- NEW HISTORY FIELDS & CLEAR TEMPORARY STATE ---\n        state.ballManagement.history[state.ballManagement.history.length - 1].stockType = stockType;\n        state.ballManagement.history[state.ballManagement.history.length - 1].purchaserName = purchaserName;\n        state.ballManagement.tempSale = {\n            stockType: null,\n            memberSignOut: null,\n            purchaserName: null,\n            purchaserType: null\n        };\n        // --- END NEW ---\n        playCustomTTS(`Signed out ${cansCount} ${stockType} to ${purchaserName}, by ${member}.`);\n        updateBallStockDisplay();\n        updateUsedBallStockDisplay();\n        saveState();\n        cancelConfirmModal.classList.add(\"hidden\");\n        ballManagementModal.classList.remove(\"hidden\");\n        resetConfirmModal(); // ADD THIS LINE\n    }\n    function renderBallHistoryModal() {\n        ballHistoryList.innerHTML = ''; // Clear previous content\n        const filter = state.ballManagement.historyFilter;\n        // 1. Create the HTML for the filter radio buttons\n        const filterHTML = `\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\n                <div class=\"radio-group\">\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"all\" ${filter === 'all' ? 'checked' : ''}> All </label>\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"new\" ${filter === 'new' ? 'checked' : ''}> New </label>\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"used\" ${filter === 'used' ? 'checked' : ''}> Used </label>\n                </div>\n            </div>\n        `;\n        // 2. Filter the history based on the current state\n        const filteredHistory = state.ballManagement.history.filter((entry)=>{\n            if (filter === 'all') return true;\n            // Determine if the entry relates to used balls (singles or return_used category)\n            const isUsed = entry.stockType === 'singles' || entry.category === 'return_used';\n            if (filter === 'used') return isUsed;\n            if (filter === 'new') return !isUsed;\n            return true;\n        });\n        if (filteredHistory.length === 0) ballHistoryList.innerHTML = filterHTML + '<p style=\"text-align: center; color: #6c757d;\">No transactions match the selected filter.</p>';\n        else {\n            // 3. Build the rest of the list using the filtered data\n            // --- MODIFIED HEADER: Removed Committee Member ---\n            const headerHTML = `\n                <div class=\"history-item\" style=\"border-bottom: 2px solid var(--primary-blue); font-weight: bold; background-color: #f8f9fa; cursor: default;\">\n                    <div class=\"ball-history-details\">\n                        <span>Date & Time</span>\n                        <span class=\"numeric\">Before</span>\n                        <span class=\"numeric\">Change</span>\n                        <span class=\"numeric\">After</span>\n                    </div>\n                </div>\n            `;\n            const historyItemsHTML = [\n                ...filteredHistory\n            ].reverse().map((entry)=>{\n                const dateTime = new Date(entry.timestamp).toLocaleString('en-ZA');\n                // --- MODIFIED CHANGE DISPLAY: Removed purchaser ---\n                const change = entry.action === 'in' ? `+${entry.count}` : `-${entry.count}`;\n                const changeClass = entry.action === 'in' ? 'stock-in' : 'stock-out';\n                const isUsedBalls = entry.stockType === 'singles' || entry.category === 'return_used';\n                const stockClass = isUsedBalls ? 'stock-used' : 'stock-new';\n                // --- MODIFIED ROW: Removed Committee Member, Added data-entry-id ---\n                return `\n                    <div class=\"history-item\" data-entry-id=\"${entry.timestamp}\">\n                        <div class=\"ball-history-details\">\n                            <span class=\"timestamp\">${dateTime}</span>\n                            <span class=\"numeric ${stockClass}\" data-label=\"Before\">${entry.stockBefore}</span>\n                            <span class=\"numeric ${changeClass}\" data-label=\"Change\">${change}</span>\n                            <span class=\"numeric ${stockClass}\" data-label=\"After\">${entry.stockAfter}</span>\n                        </div>\n                    </div>\n                `;\n            }).join('');\n            ballHistoryList.innerHTML = filterHTML + headerHTML + historyItemsHTML;\n        }\n        // 4. Attach event listeners to the new radio buttons\n        ballHistoryList.querySelectorAll('input[name=\"ball-history-filter\"]').forEach((radio)=>{\n            radio.addEventListener('change', handleBallHistoryFilterChange);\n        });\n        // 5. NEW: Add click listener for list items (delegated)\n        ballHistoryList.removeEventListener('click', handleBallHistoryItemClick); // Prevent duplicates\n        ballHistoryList.addEventListener('click', handleBallHistoryItemClick);\n    }\n    // NEW FUNCTION: Handles clicks on ball history items\n    function handleBallHistoryItemClick(e) {\n        const historyItem = e.target.closest('.history-item[data-entry-id]');\n        if (historyItem) {\n            const entryId = parseInt(historyItem.dataset.entryId, 10);\n            const entry = state.ballManagement.history.find((item)=>item.timestamp === entryId);\n            if (entry) showBallHistoryDetailModal(entry);\n        }\n    }\n    // NEW FUNCTION: Shows the detailed ball history modal\n    function showBallHistoryDetailModal(entry) {\n        // Populate the modal fields\n        const stockType = entry.stockType === 'singles' || entry.category === 'return_used' ? 'Used Balls (Singles)' : 'New Balls (Cans)';\n        detailStockType.textContent = stockType;\n        // Format category for display\n        let categoryDisplay = entry.category || 'N/A';\n        if (categoryDisplay === 'purchase') categoryDisplay = 'Stock Added';\n        else if (categoryDisplay === 'return') categoryDisplay = 'Stock Returned';\n        else if (categoryDisplay === 'return_used') categoryDisplay = 'Used Balls Returned';\n        else if (categoryDisplay === 'ClubChamps') categoryDisplay = 'Club Champs'; // Format display\n        categoryDisplay = categoryDisplay.charAt(0).toUpperCase() + categoryDisplay.slice(1); // Capitalize\n        detailCategory.textContent = categoryDisplay;\n        detailDatetime.textContent = new Date(entry.timestamp).toLocaleString('en-ZA');\n        const change = entry.action === 'in' ? `+${entry.count}` : `-${entry.count}`;\n        detailCount.textContent = change;\n        detailCount.style.color = entry.action === 'in' ? 'var(--confirm-color)' : 'var(--cancel-color)';\n        detailStockChange.textContent = change; // Also update the stock level change display\n        detailStockChange.style.color = entry.action === 'in' ? 'var(--confirm-color)' : 'var(--cancel-color)';\n        // --- NEW: Dynamically set Committee Member Label ---\n        const committeeLabel = document.getElementById('detail-committee-label');\n        if (committeeLabel) committeeLabel.textContent = entry.action === 'in' ? 'Committee Member (Sign In)' : 'Committee Member (Sign Out)';\n        // --- END NEW ---\n        detailCommitteeMember.textContent = entry.member || 'N/A';\n        // --- THIS IS THE MODIFIED LOGIC for Purchaser/Recipient ---\n        let purchaserDisplay = 'N/A'; // Default\n        const nonSaleSignOuts = [\n            'Social',\n            'League',\n            'ClubChamps'\n        ];\n        if (entry.action === 'out' && nonSaleSignOuts.includes(entry.category)) // For Social, League, ClubChamps, show the category\n        purchaserDisplay = categoryDisplay; // Use the formatted category name\n        else if (entry.purchaserName) // For Sales or other types with a purchaserName, show that name\n        purchaserDisplay = entry.purchaserName;\n        detailPurchaser.textContent = purchaserDisplay;\n        // --- END MODIFIED LOGIC ---\n        // Show/hide purchaser based on whether there's relevant info to display\n        const purchaserRow = detailPurchaser.closest('.stat-item');\n        if (purchaserRow) // Show if it's a non-sale sign-out category OR if there's an actual purchaser name\n        purchaserRow.style.display = entry.action === 'out' && nonSaleSignOuts.includes(entry.category) || entry.purchaserName ? 'flex' : 'none';\n        detailStockBefore.textContent = entry.stockBefore;\n        detailStockAfter.textContent = entry.stockAfter;\n        // Show the modal\n        ballHistoryModal.classList.add('hidden'); // Hide the list modal\n        ballHistoryDetailModal.classList.remove('hidden');\n    }\n    function showBallHistoryModal() {\n        renderBallHistoryModal();\n        ballManagementModal.classList.add('hidden');\n        ballHistoryModal.classList.remove('hidden');\n    }\n    // NEW FUNCTION: Show the modal to select the purchaser\n    function showPurchaserSelectionModal(memberSignOutName) {\n        const tempSale = state.ballManagement.tempSale;\n        const stockType = tempSale.stockType;\n        const stockDisplay = stockType === 'cans' ? 'can(s) of new balls' : 'old ball(s)';\n        tempSale.memberSignOut = memberSignOutName;\n        purchaserSelectionPrompt.textContent = `Who is purchasing the ${stockDisplay} signed out by ${memberSignOutName}?`;\n        // 1. Populate the list with Club Members\n        purchaserMemberList.innerHTML = '';\n        // Get all members and guests (from clubMembers, availablePlayers, courts, and guestHistory)\n        const allKnownPlayers = getAllKnownPlayers();\n        // Filter out committee member who signed out, and filter for uniqueness\n        const membersAndGuests = allKnownPlayers.filter((p)=>p.name !== memberSignOutName).sort((a, b)=>a.name.localeCompare(b.name));\n        if (membersAndGuests.length === 0) purchaserMemberList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No other players found. Please add as a new guest.</li>';\n        else membersAndGuests.forEach((player)=>{\n            const li = document.createElement('li');\n            li.className = 'committee-member'; // Re-use the styling\n            // Determine player type for display\n            const isGuest = player.guest || !MASTER_MEMBER_LIST.some((m)=>m.name === player.name);\n            const memberData = MASTER_MEMBER_LIST.find((m)=>m.name === player.name);\n            const playerType = isGuest ? 'Guest' : memberData && memberData.committee ? memberData.committee : 'Member';\n            li.innerHTML = `<label><input type=\"radio\" name=\"purchaserMember\" value=\"${player.name}\"><div class=\"member-details\"><span class=\"member-name\">${player.name}</span><span class=\"member-designation\">${playerType}</span></div></label>`;\n            purchaserMemberList.appendChild(li);\n        });\n        purchaserSelectionModal.classList.remove('hidden');\n    }\n    function populateAbcIndex(playerList, listElement, indexElement) {\n        const firstLetters = [\n            ...new Set(playerList.map((player)=>player.name[0].toUpperCase()))\n        ].sort();\n        indexElement.innerHTML = '';\n        const scrollHandler = ()=>{\n            updateActiveIndexLetter(listElement, indexElement);\n        };\n        if (listElement._scrollHandler) listElement.removeEventListener('scroll', listElement._scrollHandler);\n        listElement.addEventListener('scroll', scrollHandler);\n        listElement._scrollHandler = scrollHandler;\n        firstLetters.forEach((letter)=>{\n            const letterDiv = document.createElement('div');\n            letterDiv.textContent = letter;\n            letterDiv.addEventListener('click', ()=>{\n                listElement.removeEventListener('scroll', listElement._scrollHandler);\n                const allLetters = indexElement.querySelectorAll('div');\n                allLetters.forEach((el)=>el.classList.remove('active'));\n                letterDiv.classList.add('active');\n                const playerToShow = listElement.querySelector(`[data-player-name^=\"${letter}\"], [data-player-name^=\"${letter.toLowerCase()}\"]`);\n                if (playerToShow) playerToShow.scrollIntoView({\n                    behavior: 'smooth',\n                    block: 'start'\n                });\n                setTimeout(()=>{\n                    listElement.addEventListener('scroll', listElement._scrollHandler);\n                }, 500);\n            });\n            indexElement.appendChild(letterDiv);\n        });\n    }\n    function updateActiveIndexLetter(listElement, indexElement) {\n        if (!listElement || !indexElement) return;\n        const listTop = listElement.getBoundingClientRect().top;\n        const listItems = Array.from(listElement.querySelectorAll('li[data-player-name]'));\n        let activeLetter = '';\n        const topItem = listItems.find((item)=>item.getBoundingClientRect().top >= listTop);\n        if (topItem) activeLetter = topItem.dataset.playerName[0].toUpperCase();\n        else if (listItems.length > 0) activeLetter = listItems[listItems.length - 1].dataset.playerName[0].toUpperCase();\n        const indexLetters = indexElement.querySelectorAll('div');\n        indexLetters.forEach((letterDiv)=>{\n            letterDiv.classList.toggle('active', letterDiv.textContent === activeLetter);\n        });\n        // --- THIS IS THE FIX ---\n        // Find the newly active letter element\n        const activeLetterEl = indexElement.querySelector('div.active');\n        if (activeLetterEl) // Automatically scroll the index list to make the active letter visible\n        activeLetterEl.scrollIntoView({\n            behavior: 'smooth',\n            block: 'nearest'\n        });\n    // --- END OF FIX ---\n    }\n    function setupListWithIndex(playerList, listElement, indexElement) {\n        populateAbcIndex(playerList, listElement, indexElement);\n        if (listElement._scrollHandler) listElement.removeEventListener('scroll', listElement._scrollHandler);\n        listElement._scrollHandler = ()=>updateActiveIndexLetter(listElement, indexElement);\n        listElement.addEventListener('scroll', listElement._scrollHandler);\n        setTimeout(()=>updateActiveIndexLetter(listElement, indexElement), 50);\n    }\n    function updateAlertStatusTimer() {\n        if (!alertStatusDisplay) return;\n        // Check current conditions\n        const hasEnoughPlayers = getActivePlayerCount() >= 4;\n        const isAnyCourtAvailable = findNextAvailableCourtId();\n        alertStatusDisplay.classList.remove('hidden');\n        if (!hasEnoughPlayers) {\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">(${getActivePlayerCount()}/4)</span><span class=\"timer-label\">Waiting for players</span>`;\n            return;\n        }\n        if (!isAnyCourtAvailable) {\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Waiting</span><span class=\"timer-label\">for courts...</span>`;\n            return;\n        }\n        if (alertScheduleTime === 0) {\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Initializing</span><span class=\"timer-label\">timer...</span>`;\n            return;\n        }\n        const remainingMs = alertScheduleTime - Date.now();\n        if (remainingMs <= 0) {\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Alert Due!</span><span class=\"timer-label\">Next game ready</span>`;\n            return;\n        }\n        const remainingSeconds = Math.floor(remainingMs / 1000);\n        const minutes = Math.floor(remainingSeconds / 60);\n        const seconds = remainingSeconds % 60;\n        // MODIFIED: Create two spans to mirror the \"On Duty\" HTML structure\n        alertStatusDisplay.innerHTML = `<span class=\"timer-value\">${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}</span><span class=\"timer-label\">Next alert in</span>`;\n    }\n    function dynamicallyCenterHeaderTitle() {\n        const headerLogo = document.getElementById('header-logo');\n        const headerTitle = document.querySelector('.header-title');\n        const headerButtons = document.querySelector('.header-buttons');\n        if (!headerLogo || !headerTitle || !headerButtons) return;\n        // Get the actual rendered width of the side elements\n        const logoWidth = headerLogo.offsetWidth;\n        const buttonsWidth = headerButtons.offsetWidth;\n        // Calculate the difference and amplify it by a factor of 3 based on feedback\n        const widthDifference = (logoWidth - buttonsWidth) * 3;\n        // Apply padding to the title to offset the difference\n        // If the logo is wider (positive difference), add padding to the right to shift text left\n        // If the buttons are wider (negative difference), add padding to the left to shift text right\n        headerTitle.style.paddingRight = widthDifference > 0 ? `${widthDifference}px` : '0';\n        headerTitle.style.paddingLeft = widthDifference < 0 ? `${-widthDifference}px` : '0';\n    }\n    function calculatePlayerPlaytime() {\n        const stats = calculatePlayerStats(state.gameHistory); // Process all games for total playtime\n        const now = Date.now();\n        state.courts.forEach((court)=>{\n            if (court.status === 'in_progress' && court.gameStartTime) {\n                const elapsed = Date.now() - court.gameStartTime;\n                court.players.forEach((player)=>{\n                    const name = player.name;\n                    stats[name] = stats[name] || {\n                        played: 0,\n                        won: 0,\n                        totalDurationMs: 0\n                    };\n                    stats[name].totalDurationMs += elapsed;\n                });\n            }\n        });\n        return stats;\n    }\n    function calculateTeamStats(gamesToProcess) {\n        const teamStats = {};\n        gamesToProcess.forEach((game)=>{\n            // Skip games that were skipped or have no score\n            if (game.winner === 'skipped' || !game.score) return;\n            // Skip games if any player opted out of the leaderboard\n            const allPlayerObjects = [\n                ...game.teams.team1,\n                ...game.teams.team2\n            ].map((name)=>getPlayerByName(name));\n            if (allPlayerObjects.some((p)=>p.onLeaderboard === false)) return;\n            // Calculate game duration\n            const [hStr, mStr] = game.duration.split('h').map((s)=>s.replace('m', ''));\n            const gameDuration = parseInt(hStr, 10) * 3600000 + parseInt(mStr, 10) * 60000;\n            const processTeam = (team, isWinner)=>{\n                // A team must consist of exactly 2 players. This excludes singles.\n                if (team.length !== 2) return;\n                // Create a unique key for the team by sorting player names\n                const teamKey = [\n                    ...team\n                ].sort().join(' & ');\n                const teamPlayerObjects = team.map((name)=>getPlayerByName(name));\n                const genders = teamPlayerObjects.map((p)=>p.gender);\n                let teamType = 'Mixed';\n                if (genders.every((g)=>g === 'M')) teamType = 'Men';\n                if (genders.every((g)=>g === 'F')) teamType = 'Women';\n                if (!teamStats[teamKey]) teamStats[teamKey] = {\n                    players: team,\n                    type: teamType,\n                    played: 0,\n                    won: 0,\n                    totalDurationMs: 0\n                };\n                teamStats[teamKey].played += 1;\n                teamStats[teamKey].totalDurationMs += gameDuration;\n                if (isWinner) teamStats[teamKey].won += 1;\n            };\n            const isTeam1Winner = game.winner === 'team1';\n            processTeam(game.teams.team1, isTeam1Winner);\n            processTeam(game.teams.team2, !isTeam1Winner);\n        });\n        return teamStats;\n    }\n    function calculateWinningStreaks() {\n        const streaks = {};\n        const lastGameResult = {}; // Tracks if the last game was a win for a player\n        // Sort games by end time, oldest to newest, to correctly track streaks\n        const sortedHistory = [\n            ...state.gameHistory\n        ].sort((a, b)=>a.endTime - b.endTime);\n        sortedHistory.forEach((game)=>{\n            if (game.winner === 'skipped') {\n                // If a game was skipped, it breaks all streaks for players involved\n                [\n                    ...game.teams.team1,\n                    ...game.teams.team2\n                ].forEach((playerName)=>{\n                    lastGameResult[playerName] = 'loss'; // Treat skip as a loss for streak purposes\n                });\n                return;\n            }\n            const winnerTeam = game.winner === 'team1' ? game.teams.team1 : game.teams.team2;\n            const loserTeam = game.winner === 'team1' ? game.teams.team2 : game.teams.team1;\n            winnerTeam.forEach((playerName)=>{\n                if (lastGameResult[playerName] === 'win') streaks[playerName] = (streaks[playerName] || 1) + 1;\n                else streaks[playerName] = 1; // Start a new streak\n                lastGameResult[playerName] = 'win';\n            });\n            loserTeam.forEach((playerName)=>{\n                streaks[playerName] = 0; // Reset streak on loss\n                lastGameResult[playerName] = 'loss';\n            });\n        });\n        // Return only players with an active streak\n        const activeStreaks = {};\n        for(const player in streaks)if (streaks[player] > 0) activeStreaks[player] = streaks[player];\n        return activeStreaks;\n    }\n    function calculateHeartbreaker() {\n        const closeLossCounts = {};\n        const today = new Date().toISOString().split('T')[0];\n        const todaysGames = state.gameHistory.filter((game)=>{\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\n            return gameDate === today && game.winner !== 'skipped' && game.score;\n        });\n        todaysGames.forEach((game)=>{\n            const winnerScore = Math.max(game.score.team1, game.score.team2);\n            const loserScore = Math.min(game.score.team1, game.score.team2);\n            // Define a \"close loss\" as a score of 7-5, 7-6, or a close Fast Play game\n            const isCloseLoss = winnerScore === 7 && (loserScore === 5 || loserScore === 6);\n            if (isCloseLoss) {\n                const loserTeam = game.score.team1 < game.score.team2 ? game.teams.team1 : game.teams.team2;\n                loserTeam.forEach((playerName)=>{\n                    closeLossCounts[playerName] = (closeLossCounts[playerName] || 0) + 1;\n                });\n            }\n        });\n        let heartbreakerName = null;\n        let maxCloseLosses = 0;\n        for(const playerName in closeLossCounts)if (closeLossCounts[playerName] > maxCloseLosses) {\n            maxCloseLosses = closeLossCounts[playerName];\n            heartbreakerName = playerName;\n        }\n        // Only return a heartbreaker if they have at least one close loss\n        return maxCloseLosses > 0 ? heartbreakerName : null;\n    }\n    function calculatePlayerPowerScore(player, allGames, returnDetailed = false) {\n        // 1. Establish Baseline Ranking (no changes here)\n        const baselineStats = {};\n        allGames.forEach((game)=>{\n            [\n                ...game.teams.team1,\n                ...game.teams.team2\n            ].forEach((pName)=>{\n                if (!baselineStats[pName]) baselineStats[pName] = {\n                    played: 0,\n                    won: 0\n                };\n            });\n            if (game.winner !== 'skipped' && game.score) {\n                const winnerTeam = game.winner === 'team1' ? game.teams.team1 : game.teams.team2;\n                const loserTeam = game.winner === 'team1' ? game.teams.team2 : game.teams.team1;\n                winnerTeam.forEach((pName)=>{\n                    baselineStats[pName].played++;\n                    baselineStats[pName].won++;\n                });\n                loserTeam.forEach((pName)=>{\n                    baselineStats[pName].played++;\n                });\n            }\n        });\n        const baselineRank = {};\n        for(const pName in baselineStats)baselineRank[pName] = baselineStats[pName].played > 0 ? baselineStats[pName].won / baselineStats[pName].played : 0;\n        const avgRank = Object.values(baselineRank).reduce((a, b)=>a + b, 0) / Object.values(baselineRank).length || 0.5;\n        // 2. Calculate Strength-of-Schedule Score (ENHANCED)\n        // Uses Expected Outcome probability to fairly assess performance\n        let historicalScore = 0;\n        let gamesPlayedHistorical = 0;\n        const thirtyDaysAgo = new Date();\n        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n        const historicalGames = allGames.filter((game)=>new Date(game.endTime) > thirtyDaysAgo && (game.teams.team1.includes(player.name) || game.teams.team2.includes(player.name)));\n        historicalGames.forEach((game)=>{\n            if (game.winner === 'skipped' || !game.score) return;\n            // Determine player's team and opponent team\n            const isPlayerInTeam1 = game.teams.team1.includes(player.name);\n            const playerTeam = isPlayerInTeam1 ? game.teams.team1 : game.teams.team2;\n            const opponentTeam = isPlayerInTeam1 ? game.teams.team2 : game.teams.team1;\n            const isWinner = isPlayerInTeam1 && game.winner === 'team1' || !isPlayerInTeam1 && game.winner === 'team2';\n            // Calculate team averages using baseline ranks\n            const playerTeamAvg = playerTeam.reduce((sum, pName)=>sum + (baselineRank[pName] || avgRank), 0) / playerTeam.length;\n            const opponentTeamAvg = opponentTeam.reduce((sum, pName)=>sum + (baselineRank[pName] || avgRank), 0) / opponentTeam.length;\n            // Calculate expected win probability using logistic function\n            // This accounts for ALL 4 players' strengths\n            const scoreDiff = playerTeamAvg - opponentTeamAvg;\n            const expectedWinProb = 1 / (1 + Math.exp(-5 * scoreDiff));\n            // Calculate performance score based on expected outcome\n            let performanceScore;\n            if (isWinner) {\n                // Won the match\n                if (expectedWinProb < 0.5) // UPSET WIN (were underdogs)\n                // Massive bonus for beating stronger opponents\n                performanceScore = (1.0 - expectedWinProb) * 2;\n                else // EXPECTED WIN (were favorites)\n                // Small credit for beating weaker opponents\n                performanceScore = (1.0 - expectedWinProb) * 0.5;\n            } else // Lost the match\n            if (expectedWinProb > 0.5) // BAD LOSS (were favorites)\n            // Heavy penalty for losing to weaker opponents\n            performanceScore = -expectedWinProb * 2;\n            else // EXPECTED LOSS (were underdogs)\n            // Small penalty for losing to stronger opponents\n            performanceScore = -expectedWinProb * 0.5;\n            historicalScore += performanceScore;\n            gamesPlayedHistorical++;\n        });\n        const finalHistoricalScore = gamesPlayedHistorical > 0 ? historicalScore / gamesPlayedHistorical : 0;\n        // 3. Today's Form (no changes here)\n        const today = new Date().toISOString().split('T')[0];\n        const todaysGames = historicalGames.filter((game)=>new Date(game.endTime).toISOString().split('T')[0] === today);\n        let todaysWins = 0;\n        todaysGames.forEach((game)=>{\n            const isWinner = game.teams.team1.includes(player.name) && game.winner === 'team1' || game.teams.team2.includes(player.name) && game.winner === 'team2';\n            if (isWinner) todaysWins++;\n        });\n        const todaysWinPct = todaysGames.length > 0 ? todaysWins / todaysGames.length - 0.5 : 0;\n        // --- THIS IS THE REFINED ADAPTIVE WEIGHTING LOGIC ---\n        const totalGamesInHistory = allGames.length;\n        let historicalWeight;\n        if (totalGamesInHistory >= 20) historicalWeight = 0.7;\n        else if (totalGamesInHistory >= 15) historicalWeight = 0.525; // 75% of the way to 0.7\n        else if (totalGamesInHistory >= 10) historicalWeight = 0.35; // 50% of the way to 0.7\n        else if (totalGamesInHistory >= 5) historicalWeight = 0.175; // 25% of the way to 0.7\n        else historicalWeight = 0.0; // 0% historical weight for the first few games\n        const todayWeight = 1 - historicalWeight;\n        let blendedScore = finalHistoricalScore * historicalWeight + todaysWinPct * todayWeight;\n        // --- END OF REFINED LOGIC ---\n        // 5. Apply Player Type Modifiers\n        // ENHANCED: Removed static penalties for Veteran/Junior\n        // Player type doesn't determine skill - performance does!\n        // Strategic veterans and elite juniors now get proper credit\n        if (player.guest && gamesPlayedHistorical === 0) blendedScore = 0;\n        if (returnDetailed) return {\n            historicalScore: finalHistoricalScore,\n            todayForm: todaysWinPct,\n            finalScore: blendedScore\n        };\n        return blendedScore;\n    }\n    // --- POWER SCORE MODAL FUNCTIONS ---\n    function showPowerScoreModal() {\n        renderPowerScoreList();\n        adminSettingsModal.classList.add('hidden');\n        powerScoreModal.classList.remove('hidden');\n    }\n    function renderPowerScoreList() {\n        powerScoreList.innerHTML = \"\";\n        const playersOnCourt = state.courts.flatMap((c)=>c.players);\n        const allPlayersAtClub = [\n            ...state.availablePlayers,\n            ...playersOnCourt\n        ];\n        const uniquePlayers = Array.from(new Map(allPlayersAtClub.map((p)=>[\n                p.name,\n                p\n            ])).values());\n        if (uniquePlayers.length === 0) {\n            powerScoreList.innerHTML = '<p style=\"text-align: center; color: #6c757d;\">No players are currently checked in.</p>';\n            return;\n        }\n        const playerScores = uniquePlayers.map((player)=>{\n            const scores = calculatePlayerPowerScore(player, state.gameHistory, true); // Get detailed scores\n            return {\n                name: player.name,\n                ...scores\n            };\n        });\n        const { key, order } = state.powerScoreSort;\n        playerScores.sort((a, b)=>{\n            let valA = a[key];\n            let valB = b[key];\n            if (key === 'name') return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);\n            return order === 'asc' ? valA - valB : valB - valA;\n        });\n        const getSortIcon = (sortKey)=>state.powerScoreSort.key !== sortKey ? ' ' : state.powerScoreSort.order === 'asc' ? \" \\uD83D\\uDD3C\" : \" \\uD83D\\uDD3D\";\n        const headerHTML = `\n            <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\n                <div class=\"power-score-grid-row\">\n                    <button class=\"sort-btn\" data-sort-key=\"name\">Player ${getSortIcon('name')}</button>\n                    <button class=\"sort-btn\" data-sort-key=\"historicalScore\">Historical ${getSortIcon('historicalScore')}</button>\n                    <button class=\"sort-btn\" data-sort-key=\"todayForm\">Today ${getSortIcon('todayForm')}</button>\n                    <button class=\"sort-btn\" data-sort-key=\"finalScore\">Score ${getSortIcon('finalScore')}</button>\n                </div>\n            </div>\n        `;\n        const playerRows = playerScores.map((p)=>`\n            <div class=\"history-item\">\n                <div class=\"power-score-grid-row\">\n                    <span>${p.name}</span>\n                    <span>${p.historicalScore.toFixed(2)}</span>\n                    <span>${p.todayForm.toFixed(2)}</span>\n                    <span style=\"font-weight: bold;\">${p.finalScore.toFixed(2)}</span>\n                </div>\n            </div>\n        `).join('');\n        powerScoreList.innerHTML = headerHTML + playerRows;\n        // Attach listeners to new sort buttons\n        powerScoreList.querySelectorAll('.sort-btn').forEach((btn)=>{\n            btn.addEventListener('click', handlePowerScoreSortClick);\n        });\n    }\n    // --- ADMIN CHECKLIST FUNCTIONS ---\n    function renderChecklist(checklistData = state.adminChecklist, targetElement = checklistContent, isReadOnly = false) {\n        targetElement.innerHTML = ''; // Clear existing content\n        const createListItems = (items, listType)=>{\n            if (!items || items.length === 0) return '';\n            return items.map((item)=>{\n                const uniqueId = `check-${listType}-${item.id}`;\n                // Add 'disabled' attribute if read-only\n                const disabledAttr = isReadOnly ? 'disabled' : '';\n                return `\n                    <li class=\"checklist-item\">\n                        <label for=\"${uniqueId}\">\n                            <input type=\"checkbox\" id=\"${uniqueId}\" data-checklist-id=\"${item.id}\" data-list-type=\"${listType}\" ${item.checked ? 'checked' : ''} ${disabledAttr}>\n                            <span>${item.text}</span>\n                        </label>\n                    </li>\n                `;\n            }).join('');\n        };\n        const arrivalItemsHTML = createListItems(checklistData.arrival, 'arrival');\n        const departureItemsHTML = createListItems(checklistData.departure, 'departure');\n        if (arrivalItemsHTML) targetElement.innerHTML += `<h2 class=\"checklist-section-header\">On Arrival</h2><ul>${arrivalItemsHTML}</ul>`;\n        if (departureItemsHTML) targetElement.innerHTML += `<h2 class=\"checklist-section-header\">On Departure</h2><ul>${departureItemsHTML}</ul>`;\n        if (!arrivalItemsHTML && !departureItemsHTML) targetElement.innerHTML = '<p style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No checklist items defined.</p>';\n        // Add internal list styling if needed (e.g., remove bullets)\n        targetElement.querySelectorAll('ul').forEach((ul)=>{\n            ul.style.listStyle = 'none';\n            ul.style.padding = '0';\n            ul.style.margin = '0';\n        });\n    }\n    function showChecklistModal() {\n        renderChecklist(); // Populate the list\n        adminSettingsModal.classList.add('hidden');\n        checklistModal.classList.remove('hidden');\n    }\n    function handleChecklistChange(e) {\n        if (e.target.type === 'checkbox' && e.target.dataset.checklistId) {\n            const itemId = e.target.dataset.checklistId;\n            const listType = e.target.dataset.listType; // 'arrival' or 'departure'\n            const isChecked = e.target.checked;\n            if (!listType || !state.adminChecklist[listType]) return; // Safety check\n            const item = state.adminChecklist[listType].find((i)=>i.id === itemId);\n            if (item) {\n                item.checked = isChecked;\n                // Mutual exclusion for Amp settings\n                if (listType === 'arrival') {\n                    if (itemId === 'arrAmpAux' && isChecked) {\n                        const opticalItem = state.adminChecklist.arrival.find((i)=>i.id === 'arrAmpOptical');\n                        if (opticalItem) opticalItem.checked = false;\n                    } else if (itemId === 'arrAmpOptical' && isChecked) {\n                        const auxItem = state.adminChecklist.arrival.find((i)=>i.id === 'arrAmpAux');\n                        if (auxItem) auxItem.checked = false;\n                    }\n                    // Re-render only the arrival list if exclusion happened\n                    if (itemId === 'arrAmpAux' || itemId === 'arrAmpOptical') renderChecklist(); // Re-render the whole checklist to update visuals\n                }\n                saveState();\n                saveChecklistHistory();\n            }\n        }\n    }\n    // --- CHECKLIST HISTORY FUNCTIONS ---\n    function saveChecklistHistory() {\n        const today = new Date();\n        const year = today.getFullYear();\n        const month = String(today.getMonth() + 1).padStart(2, '0');\n        const day = String(today.getDate()).padStart(2, '0');\n        const todayDateStr = `${year}-${month}-${day}`;\n        // --- Original Condition: Games Played & Duty Member ---\n        const gamesPlayedToday = state.gameHistory.some((game)=>// Ensure comparison uses local date string format\n            new Date(game.endTime).toLocaleDateString('en-CA') === todayDateStr // 'en-CA' gives YYYY-MM-DD\n        );\n        const dutyMemberAssigned = state.onDuty !== 'None';\n        const initialCreationConditionMet = gamesPlayedToday && dutyMemberAssigned;\n        // --- End Original Condition ---\n        const historyIndex = state.checklistHistory.findIndex((entry)=>entry.date === todayDateStr);\n        // --- Logic: Create if condition met & doesn't exist, Update if exists ---\n        if (historyIndex > -1) // --- ALWAYS UPDATE if entry for today exists ---\n        try {\n            // Update today's entry with the current state (deep copy)\n            state.checklistHistory[historyIndex].checklist = JSON.parse(JSON.stringify(state.adminChecklist));\n            // console.log(`Checklist history UPDATED for ${todayDateStr} (Live update).`);\n            saveState(); // Save the updated history\n        } catch (error) {\n            console.error(\"Error updating checklist history:\", error);\n        }\n        else if (initialCreationConditionMet) // --- CREATE entry only if initial condition is met AND it doesn't exist yet ---\n        try {\n            const checklistCopy = JSON.parse(JSON.stringify(state.adminChecklist)); // Deep copy\n            state.checklistHistory.push({\n                date: todayDateStr,\n                checklist: checklistCopy\n            });\n            // console.log(`Checklist history CREATED for ${todayDateStr} (Game/Duty condition met).`);\n            saveState(); // Save the newly created history entry\n        } catch (error) {\n            console.error(\"Error creating checklist history:\", error);\n        }\n    }\n    // --- NEW FUNCTION: Resets checklist for the new day ---\n    function resetChecklistForNewDay(forceReset = false) {\n        const today = new Date();\n        const year = today.getFullYear();\n        const month = String(today.getMonth() + 1).padStart(2, '0');\n        const day = String(today.getDate()).padStart(2, '0');\n        const todayDateStr = `${year}-${month}-${day}`;\n        // Get the date of the last reset from localStorage\n        const lastResetDate = localStorage.getItem(\"checklistLastResetDate\");\n        // Only reset if it's a new day OR if forceReset is true (e.g., from manual reset button)\n        if (forceReset || lastResetDate !== todayDateStr) {\n            console.log(`Resetting checklist for new day: ${todayDateStr}`);\n            // Reset all 'checked' states to false\n            Object.keys(state.adminChecklist).forEach((section)=>{\n                if (Array.isArray(state.adminChecklist[section])) state.adminChecklist[section].forEach((item)=>{\n                    item.checked = false;\n                });\n            });\n            // Update the last reset date in localStorage\n            localStorage.setItem(\"checklistLastResetDate\", todayDateStr);\n            saveState(); // Save the reset state\n        }\n    }\n    // Call this function periodically (e.g., every hour) or on app close/reset\n    // Simple hourly check:\n    setInterval(saveChecklistHistory, 3600000);\n    // More robust would be to tie it to a 'day end' event if available.\n    function renderChecklistHistoryList() {\n        checklistHistoryList.innerHTML = '';\n        checklistHistoryTitle.textContent = 'Checklist History'; // Reset title\n        if (state.checklistHistory.length === 0) {\n            checklistHistoryList.innerHTML = '<li style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No history recorded yet.</li>';\n            return;\n        }\n        // Sort history, newest first\n        const sortedHistory = [\n            ...state.checklistHistory\n        ].sort((a, b)=>b.date.localeCompare(a.date));\n        sortedHistory.forEach((entry)=>{\n            const li = document.createElement('li');\n            li.textContent = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-ZA', {\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric',\n                weekday: 'long'\n            });\n            li.dataset.date = entry.date;\n            checklistHistoryList.appendChild(li);\n        });\n    }\n    function showChecklistHistoryModal() {\n        renderChecklistHistoryList();\n        // Show the list view, hide the detail view\n        checklistHistoryListView.classList.remove('hidden');\n        checklistHistoryDetailView.classList.add('hidden');\n        checklistHistoryBackBtn.classList.add('hidden'); // Hide back button initially\n        checklistModal.classList.add('hidden'); // Hide main checklist\n        checklistHistoryModal.classList.remove('hidden');\n    }\n    function showChecklistHistoryDetail(dateStr) {\n        const historyEntry = state.checklistHistory.find((entry)=>entry.date === dateStr);\n        if (!historyEntry) return;\n        state.selectedChecklistHistoryDate = dateStr; // Store selected date\n        const displayDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-ZA', {\n            year: 'numeric',\n            month: 'long',\n            day: 'numeric',\n            weekday: 'long'\n        });\n        checklistHistoryTitle.textContent = `Checklist for ${displayDate}`;\n        checklistDetailDate.textContent = displayDate; // Update detail paragraph date\n        // Use the renderChecklist function in read-only mode\n        renderChecklist(historyEntry.checklist, checklistHistoryDetail, true);\n        // Switch views\n        checklistHistoryListView.classList.add('hidden');\n        checklistHistoryDetailView.classList.remove('hidden');\n        checklistHistoryBackBtn.classList.remove('hidden'); // Show back button\n    }\n    // --- END CHECKLIST HISTORY FUNCTIONS ---\n    // --- END ADMIN CHECKLIST FUNCTIONS ---    \n    function handlePowerScoreSortClick(e) {\n        const key = e.target.dataset.sortKey;\n        if (!key) return;\n        if (state.powerScoreSort.key === key) state.powerScoreSort.order = state.powerScoreSort.order === 'asc' ? 'desc' : 'asc';\n        else {\n            state.powerScoreSort.key = key;\n            state.powerScoreSort.order = 'desc'; // Default to desc for new columns\n        }\n        renderPowerScoreList();\n    }\n    // --- POWER SCORE MODAL EVENT LISTENERS ---\n    powerScoreBtn.addEventListener('click', showPowerScoreModal);\n    powerScoreCloseBtn.addEventListener('click', ()=>{\n        powerScoreModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    /**\r\n     * Determines the most balanced game based on settings and player pool.\r\n     * Incorporates percentage-based overrides for specific scenarios.\r\n     * Returns an object { suggestion: { team1, team2 } | null, type: string | null }.\r\n     */ function findMostBalancedGame(selector, available) {\n        const settings = state.suggestionSettings;\n        // Generate a single random number (0-100) to check against percentages sequentially.\n        const percentageRoll = Math.random() * 100;\n        // --- Prepare Player Data ---\n        const poolPlayers = [\n            selector,\n            ...available.slice(0, 4)\n        ];\n        const playerPlaytimes = calculatePlayerPlaytime(); // Get playtime data\n        const poolPlayerScores = poolPlayers.map((p)=>({\n                player: p,\n                score: calculatePlayerPowerScore(p, state.gameHistory)\n            }));\n        const selectorScoreData = poolPlayerScores.find((ps)=>ps.player.name === selector.name);\n        // --- Scenario 1: Top Player Head-to-Head ---\n        if (!settings.powerScoreOnly && percentageRoll < settings.topPlayerPercent) {\n            console.log(`Attempting Top Player H2H suggestion... (Roll: ${percentageRoll.toFixed(1)} < ${settings.topPlayerPercent}%)`);\n            const sortedByScore = [\n                ...poolPlayerScores\n            ].sort((a, b)=>b.score - a.score);\n            const top4PlayersData = sortedByScore.slice(0, 4);\n            if (top4PlayersData.length === 4 && top4PlayersData.some((ps)=>ps.player.name === selector.name)) {\n                const males = top4PlayersData.filter((ps)=>ps.player.gender === 'M').length;\n                const females = top4PlayersData.filter((ps)=>ps.player.gender === 'F').length;\n                if (!(males === 3 && females === 1) && !(males === 1 && females === 3)) {\n                    console.log(\"Top Player H2H applied.\");\n                    const suggestion = findBestCombination(top4PlayersData);\n                    return {\n                        suggestion: suggestion,\n                        type: 'topPlayer'\n                    }; // Return type\n                } else console.log(\"Top Player H2H skipped due to 3:1 gender split.\");\n            } else console.log(\"Top Player H2H skipped: Selector not in top 4 or not enough players.\");\n        } else if (!settings.powerScoreOnly) console.log(`Top Player H2H skipped (Roll: ${percentageRoll.toFixed(1)} >= ${settings.topPlayerPercent}%)`);\n        // --- Scenario 2: Frequent Opponent ---\n        // Check only if Top Player wasn't triggered. Use the *same* percentageRoll.\n        if (!settings.powerScoreOnly && percentageRoll >= settings.topPlayerPercent && percentageRoll < settings.topPlayerPercent + settings.frequentOpponentPercent) {\n            console.log(`Attempting Frequent Opponent suggestion... (Roll: ${percentageRoll.toFixed(1)} in range)`);\n            const frequentOpponentName = findFrequentOpponent(selector.name, state.gameHistory);\n            const opponentInPool = poolPlayerScores.find((ps)=>ps.player.name === frequentOpponentName);\n            if (opponentInPool) {\n                console.log(`Frequent Opponent (${frequentOpponentName}) found in pool. Applying.`);\n                let selection = [\n                    selector,\n                    opponentInPool.player\n                ];\n                let remainingForBalance = poolPlayerScores.filter((ps)=>ps.player.name !== selector.name && ps.player.name !== opponentInPool.player.name).map((ps)=>ps.player);\n                if (remainingForBalance.length >= 2) {\n                    // Fill remaining 2 spots using standard balance logic (mixed aim, ignore least playtime here)\n                    const finalTwo = findBestBalancingPlayers(selection, remainingForBalance, 2, poolPlayerScores, false, 'mixed', selector.gender, opponentInPool.player.gender);\n                    if (finalTwo && finalTwo.length === 2) {\n                        selection.push(...finalTwo);\n                        if (selection.length === 4) {\n                            const finalScores = poolPlayerScores.filter((ps)=>selection.some((p)=>p.name === ps.player.name));\n                            const suggestion = findBestCombination(finalScores);\n                            return {\n                                suggestion: suggestion,\n                                type: 'frequentOpponent'\n                            }; // Return type\n                        }\n                    } else console.log(\"Frequent Opponent skipped: Could not find 2 balanced players to complete the team.\");\n                } else console.log(\"Frequent Opponent skipped: Not enough remaining players.\");\n            } else console.log(\"Frequent Opponent skipped: Opponent not found or not frequent enough.\");\n        } else if (!settings.powerScoreOnly) console.log(`Frequent Opponent skipped (Roll: ${percentageRoll.toFixed(1)} not in range or Top Player triggered)`);\n        // --- Scenario 3: Weak Player Grouping ---\n        // Check only if previous scenarios weren't triggered. Use the *same* percentageRoll.\n        const weakPlayerUpperBoundary = settings.topPlayerPercent + settings.frequentOpponentPercent + settings.weakPlayerPercent;\n        if (!settings.powerScoreOnly && percentageRoll >= settings.topPlayerPercent + settings.frequentOpponentPercent && percentageRoll < weakPlayerUpperBoundary) {\n            console.log(`Attempting Weak Player Grouping suggestion... (Roll: ${percentageRoll.toFixed(1)} in range)`);\n            if (!selectorScoreData) console.log(\"Weak Player Grouping skipped: Selector score data missing.\");\n            else {\n                const selectorIsWeak = isWeakPlayer(selectorScoreData.score, settings.weakPlayerThreshold);\n                if (selectorIsWeak) {\n                    const otherWeakPlayers = poolPlayerScores.filter((ps)=>ps.player.name !== selector.name && isWeakPlayer(ps.score, settings.weakPlayerThreshold));\n                    if (otherWeakPlayers.length >= 3) {\n                        otherWeakPlayers.sort((a, b)=>a.score - b.score); // Sort weakest first\n                        const weakFoursomeData = [\n                            selectorScoreData,\n                            ...otherWeakPlayers.slice(0, 3)\n                        ];\n                        const males = weakFoursomeData.filter((ps)=>ps.player.gender === 'M').length;\n                        const females = weakFoursomeData.filter((ps)=>ps.player.gender === 'F').length;\n                        if (!(males === 3 && females === 1) && !(males === 1 && females === 3)) {\n                            console.log(\"Weak Player Grouping applied.\");\n                            const suggestion = findBestCombination(weakFoursomeData);\n                            return {\n                                suggestion: suggestion,\n                                type: 'weakPlayer'\n                            }; // Return type\n                        } else console.log(\"Weak Player Grouping skipped due to 3:1 gender split.\");\n                    } else console.log(\"Weak Player Grouping skipped: Not enough other weak players available.\");\n                } else console.log(\"Weak Player Grouping skipped: Selector is not weak.\");\n            }\n        } else if (!settings.powerScoreOnly) console.log(`Weak Player Grouping skipped (Roll: ${percentageRoll.toFixed(1)} not in range or previous triggered)`);\n        // --- Scenario 4: Standard Balancing Logic (Fallback) ---\n        console.log(\"Falling back to Standard Balancing Logic.\");\n        let selectedPlayers = [\n            selector\n        ];\n        let remainingPool = [\n            ...poolPlayerScores.filter((ps)=>ps.player.name !== selector.name)\n        ];\n        // --- Least Playtime Selection (incorporating 100% gender preference) ---\n        if (settings.prioritizeLeastPlaytime && !settings.powerScoreOnly && remainingPool.length > 0) {\n            let targetGenderForLeastPlaytime = null;\n            const isFemaleSelector = selector.gender === 'F';\n            const availableFemalesInPool = remainingPool.filter((ps)=>ps.player.gender === 'F').length;\n            const availableMalesInPool = remainingPool.filter((ps)=>ps.player.gender === 'M').length;\n            const playersNeededForFullTeam = 3;\n            if (isFemaleSelector && settings.femaleRatioPercent === 100 && availableFemalesInPool >= playersNeededForFullTeam) targetGenderForLeastPlaytime = 'F';\n            else if (!isFemaleSelector && settings.maleRatioPercent === 100 && availableMalesInPool >= playersNeededForFullTeam) targetGenderForLeastPlaytime = 'M';\n            let poolForLeastPlaytime = remainingPool;\n            if (targetGenderForLeastPlaytime) {\n                const filteredPool = remainingPool.filter((ps)=>ps.player.gender === targetGenderForLeastPlaytime);\n                if (filteredPool.length > 0) poolForLeastPlaytime = filteredPool;\n                else console.warn(`Standard Balance: 100% ${targetGenderForLeastPlaytime === 'F' ? 'Female' : 'Male'} preference set, but no matching players in pool.`);\n            }\n            let minPlaytime = Infinity;\n            let leastPlayedPlayerScoreObj = null;\n            poolForLeastPlaytime.forEach((ps)=>{\n                const playtime = playerPlaytimes[ps.player.name]?.totalDurationMs || 0;\n                if (playtime < minPlaytime) {\n                    minPlaytime = playtime;\n                    leastPlayedPlayerScoreObj = ps;\n                } else if (playtime === minPlaytime && leastPlayedPlayerScoreObj) {\n                    const currentIndex = remainingPool.findIndex((rp)=>rp.player.name === ps.player.name);\n                    const currentBestIndex = remainingPool.findIndex((rp)=>rp.player.name === leastPlayedPlayerScoreObj.player.name);\n                    if (currentIndex < currentBestIndex) leastPlayedPlayerScoreObj = ps;\n                }\n            });\n            if (leastPlayedPlayerScoreObj) {\n                selectedPlayers.push(leastPlayedPlayerScoreObj.player);\n                remainingPool = remainingPool.filter((ps)=>ps.player.name !== leastPlayedPlayerScoreObj.player.name);\n            }\n        }\n        // --- End Least Playtime ---\n        // --- Select Remaining Players ---\n        const playersNeeded = 4 - selectedPlayers.length;\n        if (remainingPool.length < playersNeeded) {\n            console.warn(\"Standard Balance: Not enough players remaining after least playtime selection.\");\n            // Try to form best possible team with what's left\n            const finalGroup = [\n                ...selectedPlayers,\n                ...remainingPool.map((ps)=>ps.player)\n            ];\n            const finalGroupScores = poolPlayerScores.filter((ps)=>finalGroup.some((p)=>p.name === ps.player.name));\n            if (finalGroupScores.length >= 2) {\n                const suggestion = findBestCombination(finalGroupScores); // May return fewer than 4\n                return {\n                    suggestion: suggestion,\n                    type: 'standard'\n                };\n            } else return {\n                suggestion: null,\n                type: null\n            }; // Cannot form even a pair\n        }\n        let finalPlayersToAdd = [];\n        if (settings.powerScoreOnly) finalPlayersToAdd = findBestBalancingPlayers(selectedPlayers, remainingPool.map((ps)=>ps.player), playersNeeded, poolPlayerScores, true);\n        else {\n            // Determine gender aim based on ratios\n            let aimForGender = 'mixed';\n            const isFemaleSelector = selector.gender === 'F';\n            // Use Math.random here for the ratio check, as the initial percentageRoll was for overrides\n            const genderRoll = Math.random() * 100;\n            const currentAvailableFemales = remainingPool.filter((ps)=>ps.player.gender === 'F').length;\n            const currentAvailableMales = remainingPool.filter((ps)=>ps.player.gender === 'M').length;\n            if (isFemaleSelector && currentAvailableFemales >= playersNeeded) {\n                if (genderRoll < settings.femaleRatioPercent) aimForGender = 'female';\n            } else if (!isFemaleSelector && currentAvailableMales >= playersNeeded) {\n                if (genderRoll < settings.maleRatioPercent) aimForGender = 'male';\n            }\n            const secondPlayerGender = selectedPlayers.length > 1 ? selectedPlayers[1].gender : null;\n            finalPlayersToAdd = findBestBalancingPlayers(selectedPlayers, remainingPool.map((ps)=>ps.player), playersNeeded, poolPlayerScores, false, aimForGender, selector.gender, secondPlayerGender);\n        }\n        // --- Final Assembly ---\n        if (finalPlayersToAdd && finalPlayersToAdd.length === playersNeeded) selectedPlayers.push(...finalPlayersToAdd);\n        else {\n            console.warn(\"Standard Balance: findBestBalancingPlayers did not return enough players.\");\n            // Attempt with remaining pool if findBestBalancingPlayers failed\n            selectedPlayers.push(...remainingPool.slice(0, playersNeeded).map((ps)=>ps.player));\n        }\n        if (selectedPlayers.length === 4) {\n            const finalPlayerScores = poolPlayerScores.filter((ps)=>selectedPlayers.some((p)=>p.name === ps.player.name));\n            const suggestion = findBestCombination(finalPlayerScores);\n            return {\n                suggestion: suggestion,\n                type: 'standard'\n            };\n        } else {\n            console.error(\"Standard balance failed definitively to select 4 players.\");\n            // Attempt to return the most balanced group possible even if not 4\n            const finalScores = poolPlayerScores.filter((ps)=>selectedPlayers.some((p)=>p.name === ps.player.name));\n            if (finalScores.length >= 2) {\n                const suggestion = findBestCombination(finalScores);\n                return {\n                    suggestion: suggestion,\n                    type: 'standard'\n                };\n            } else return {\n                suggestion: null,\n                type: null\n            };\n        }\n    }\n    // NEW Helper Function: Finds the best players to add for balance\n    // Helper Function: Finds the best players to add for balance (Corrected for strict 100% aim)\n    function findBestBalancingPlayers(currentSelection, pool, count, allPlayerScores, powerScoreOnly = false, aimGender = 'mixed', selectorGender = null, secondPlayerGender = null) {\n        let bestCombination = [];\n        let minDiff = Infinity;\n        let bestOverallBalance = Infinity;\n        const combinations = getCombinations(pool, count);\n        combinations.forEach((combo)=>{\n            const potentialFoursome = [\n                ...currentSelection,\n                ...combo\n            ];\n            if (potentialFoursome.length !== 4) return; // Only consider full foursomes\n            const potentialFoursomeNames = potentialFoursome.map((p)=>p.name);\n            if (powerScoreOnly) {\n                // Power score only logic (remains unchanged)\n                const males = potentialFoursome.filter((p)=>p.gender === 'M').length;\n                const females = potentialFoursome.filter((p)=>p.gender === 'F').length;\n                // CRITICAL: Never allow 3:1 gender splits\n                if (males === 3 && females === 1 || males === 1 && females === 3) return; // Skip this combination entirely\n                const foursomeScores = allPlayerScores.filter((ps)=>potentialFoursomeNames.includes(ps.player.name));\n                if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\n                const teamSplit = findBestCombination(foursomeScores);\n                if (!teamSplit) return;\n                const team1Score = teamSplit.team1.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                const team2Score = teamSplit.team2.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                const diff = Math.abs(team1Score - team2Score);\n                if (diff < bestOverallBalance) {\n                    bestOverallBalance = diff;\n                    bestCombination = combo;\n                }\n            } else {\n                // Gender Balancing Logic\n                const males = potentialFoursome.filter((p)=>p.gender === 'M').length;\n                const females = potentialFoursome.filter((p)=>p.gender === 'F').length;\n                // CRITICAL: Never allow 3:1 gender splits\n                if (males === 3 && females === 1 || males === 1 && females === 3) return; // Skip this combination entirely\n                let isMatch = false;\n                // --- START CORRECTION ---\n                // Be strict when aiming for a single gender\n                if (aimGender === 'female') {\n                    if (females === 4) isMatch = true;\n                } else if (aimGender === 'male') {\n                    if (males === 4) isMatch = true;\n                } else {\n                    // Prefer 2M/2F for mixed, but allow 4M or 4F as fallback *if aiming for mixed initially*\n                    if (males === 2 && females === 2) isMatch = true;\n                    else if (aimGender === 'mixed' && (males === 4 || females === 4)) isMatch = true; // Allow single-gender only if original aim was mixed\n                }\n                // --- END CORRECTION ---\n                if (isMatch) {\n                    // Calculate power score difference for this valid gender combination\n                    const foursomeScores = allPlayerScores.filter((ps)=>potentialFoursomeNames.includes(ps.player.name));\n                    if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\n                    const teamSplit = findBestCombination(foursomeScores);\n                    if (!teamSplit) return;\n                    const team1Score = teamSplit.team1.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                    const team2Score = teamSplit.team2.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                    const diff = Math.abs(team1Score - team2Score);\n                    // Update bestCombination only if this matching gender combo has better balance\n                    if (diff < minDiff) {\n                        minDiff = diff;\n                        bestCombination = combo;\n                    }\n                }\n            }\n        });\n        // Fallback: If NO combination met the strict gender goal (or power score goal), find the *most* balanced overall valid foursome\n        if (bestCombination.length === 0 && combinations.length > 0) {\n            console.warn(\"Suggestion fallback: No combination met the primary goal, selecting most balanced valid foursome overall.\");\n            let fallbackMinDiff = Infinity;\n            combinations.forEach((combo)=>{\n                const potentialFoursome = [\n                    ...currentSelection,\n                    ...combo\n                ];\n                if (potentialFoursome.length !== 4) return; // Ensure fallback also considers only foursomes\n                // Rule: Avoid 3:1 gender splits even in fallback\n                const males = potentialFoursome.filter((p)=>p.gender === 'M').length;\n                const females = potentialFoursome.filter((p)=>p.gender === 'F').length;\n                // CRITICAL: Never allow 3:1 gender splits\n                if (males === 3 && females === 1 || males === 1 && females === 3) return; // Skip this combination entirely\n                const potentialFoursomeNames = potentialFoursome.map((p)=>p.name);\n                const foursomeScores = allPlayerScores.filter((ps)=>potentialFoursomeNames.includes(ps.player.name));\n                if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\n                const teamSplit = findBestCombination(foursomeScores);\n                if (!teamSplit) return;\n                const team1Score = teamSplit.team1.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                const team2Score = teamSplit.team2.reduce((sum, p)=>sum + allPlayerScores.find((ps)=>ps.player.name === p.name).score, 0);\n                const diff = Math.abs(team1Score - team2Score);\n                if (diff < fallbackMinDiff) {\n                    fallbackMinDiff = diff;\n                    bestCombination = combo;\n                }\n            });\n            // If still no combo after fallback (e.g., all valid combos were skipped?), return empty\n            if (bestCombination.length === 0) console.error(\"Suggestion Error: Could not find any valid foursome combination in fallback.\");\n        }\n        return bestCombination;\n    }\n    // NEW Helper function to generate combinations\n    function getCombinations(arr, k) {\n        if (k < 0 || k > arr.length) return [];\n        if (k === 0) return [\n            []\n        ];\n        if (k === arr.length) return [\n            arr\n        ];\n        if (k === 1) return arr.map((e)=>[\n                e\n            ]);\n        const combs = [];\n        for(let i = 0; i < arr.length - k + 1; i++){\n            const head = arr.slice(i, i + 1);\n            const tailCombs = getCombinations(arr.slice(i + 1), k - 1);\n            for(let j = 0; j < tailCombs.length; j++)combs.push(head.concat(tailCombs[j]));\n        }\n        return combs;\n    }\n    // Helper function to find the best team combination within a group of 4 players\n    function findBestCombination(fourPlayers) {\n        let bestCombination = null;\n        let minDiff = Infinity;\n        const combinations = [\n            [\n                [\n                    0,\n                    1\n                ],\n                [\n                    2,\n                    3\n                ]\n            ],\n            [\n                [\n                    0,\n                    2\n                ],\n                [\n                    1,\n                    3\n                ]\n            ],\n            [\n                [\n                    0,\n                    3\n                ],\n                [\n                    1,\n                    2\n                ]\n            ]\n        ];\n        combinations.forEach((combo)=>{\n            const team1 = combo[0].map((i)=>fourPlayers[i]);\n            const team2 = combo[1].map((i)=>fourPlayers[i]);\n            const team1Score = team1.reduce((sum, p)=>sum + p.score, 0);\n            const team2Score = team2.reduce((sum, p)=>sum + p.score, 0);\n            const diff = Math.abs(team1Score - team2Score);\n            if (diff < minDiff) {\n                minDiff = diff;\n                bestCombination = {\n                    team1: team1.map((p)=>p.player),\n                    team2: team2.map((p)=>p.player)\n                };\n            }\n        });\n        return bestCombination;\n    }\n    function clearSuggestionHighlights() {\n        // Clear the active suggestion from the state\n        delete state.activeSuggestion;\n        // THIS IS THE FIX: Clear the player selection array\n        state.selection.players = [];\n        // Re-render the UI to remove all highlights and deactivate court selection\n        render();\n        // After rendering, ensure the animations are correctly hidden\n        ensureCourtSelectionAnimation();\n    }\n    function renderTeamHistory() {\n        const teamStats = calculateTeamStats(state.gameHistory);\n        const teamHistoryList = document.getElementById('team-history-list');\n        teamHistoryList.innerHTML = \"\";\n        let teamsWithStats = Object.values(teamStats).filter((team)=>{\n            if (state.statsFilter.teamGender === 'all') return true;\n            return team.type.toLowerCase() === state.statsFilter.teamGender;\n        });\n        // --- H2H FILTERING LOGIC ---\n        if (state.comparison.active && state.comparison.items.length === 1) {\n            const selectedTeamKey = state.comparison.items[0];\n            teamsWithStats = teamsWithStats.filter((team)=>{\n                const teamKey = [\n                    ...team.players\n                ].sort().join(' & ');\n                // Filter the list to only include the selected team and its opponents\n                return teamKey === selectedTeamKey || state.comparison.opponents.has(teamKey);\n            });\n        }\n        // --- END H2H FILTERING ---\n        teamsWithStats.sort((a, b)=>{\n            const statA = a;\n            const statB = b;\n            let compareValue = 0;\n            if (state.statsFilter.sortKey === 'name') compareValue = a.players.join(',').localeCompare(b.players.join(','));\n            else compareValue = (statB[state.statsFilter.sortKey] || 0) - (statA[state.statsFilter.sortKey] || 0);\n            return state.statsFilter.sortOrder === 'asc' ? -compareValue : compareValue;\n        });\n        const genderFilterHTML = `\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\n                <div class=\"radio-group\">\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"all\" ${state.statsFilter.teamGender === 'all' ? 'checked' : ''}> All </label>\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"men\" ${state.statsFilter.teamGender === 'men' ? 'checked' : ''}> Men </label>\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"women\" ${state.statsFilter.teamGender === 'women' ? 'checked' : ''}> Women </label>\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"mixed\" ${state.statsFilter.teamGender === 'mixed' ? 'checked' : ''}> Mixed </label>\n                </div>\n            </div>`;\n        if (teamsWithStats.length === 0) teamHistoryList.innerHTML = genderFilterHTML + '<p style=\"text-align: center; color: #6c757d;\">No team stats available for the selected filter.</p>';\n        else {\n            const getSortIcon = (key)=>state.statsFilter.sortKey !== key ? ' ' : state.statsFilter.sortOrder === 'asc' ? \" \\uD83D\\uDD3C\" : \" \\uD83D\\uDD3D\";\n            const tableHeader = `\n                <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\n                    <div class=\"stats-grid-row\">\n                        <button class=\"sort-btn\" data-sort-key=\"name\" style=\"text-align: left; background: none; border: none; font-weight: bold; cursor: pointer;\">Team${getSortIcon('name')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"played\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Played${getSortIcon('played')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"won\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Won %${getSortIcon('won')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"totalDurationMs\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Time${getSortIcon('totalDurationMs')}</button>\n                    </div>\n                </div>`;\n            const teamRows = teamsWithStats.map((team)=>{\n                const winPercentage = formatWinPercentage(team.played, team.won);\n                const teamNameHTML = team.players.map((name)=>`<span>${name}</span>`).join('');\n                const teamKey = [\n                    ...team.players\n                ].sort().join(' & ');\n                let rowClass = '';\n                if (state.comparison.items.includes(teamKey)) rowClass = 'selected-for-comparison';\n                return `\n                    <div class=\"history-item ${rowClass}\" data-name=\"${teamKey}\" data-type=\"team\">\n                        <div class=\"stats-grid-row\">\n                            <span class=\"team-name-stacked\">${teamNameHTML}</span>\n                            <span>${team.played}</span>\n                            <span>${winPercentage}</span>\n                            <span>${formatDuration(team.totalDurationMs)}</span>\n                        </div>\n                    </div>`;\n            }).join('');\n            teamHistoryList.innerHTML = genderFilterHTML + tableHeader + teamRows;\n        }\n        teamHistoryList.querySelectorAll('input[name=\"team-gender-filter\"]').forEach((radio)=>radio.addEventListener('change', handleTeamStatsFilterChange));\n        teamHistoryList.querySelectorAll('.sort-btn').forEach((btn)=>btn.addEventListener('click', handleSortClick));\n        // Apply comparison styling immediately after render\n        if (state.comparison.active && state.comparison.type === 'team') {\n            const teamItems = teamHistoryList.querySelectorAll('.history-item[data-type=\"team\"]');\n            teamItems.forEach((item)=>{\n                const teamKey = item.dataset.name;\n                if (state.comparison.items.includes(teamKey)) item.classList.add('selected-for-comparison');\n            });\n        }\n    }\n    function handleTeamStatsFilterChange(e) {\n        state.statsFilter.teamGender = e.target.value;\n        saveState();\n        renderTeamHistory();\n    }\n    // --- NEW COMPARISON MODAL FUNCTIONS ---\n    function calculateComparisonStats() {\n        const { type, items, timeFrame } = state.comparison;\n        if (items.length < 2) return null;\n        const item1Name = items[0];\n        const item2Name = items[1];\n        const games = state.gameHistory.filter((game)=>isGameInTimeFrame(game, timeFrame));\n        let headToHeadGames = [];\n        if (type === 'player') headToHeadGames = games.filter((game)=>{\n            const team1Players = game.teams.team1;\n            const team2Players = game.teams.team2;\n            const item1OnTeam1 = team1Players.includes(item1Name);\n            const item2OnTeam1 = team1Players.includes(item2Name);\n            const item1OnTeam2 = team2Players.includes(item1Name);\n            const item2OnTeam2 = team2Players.includes(item2Name);\n            return item1OnTeam1 && item2OnTeam2 || item1OnTeam2 && item2OnTeam1;\n        });\n        else headToHeadGames = games.filter((game)=>{\n            const team1Key = [\n                ...game.teams.team1\n            ].sort().join(' & ');\n            const team2Key = [\n                ...game.teams.team2\n            ].sort().join(' & ');\n            return team1Key === item1Name && team2Key === item2Name || team1Key === item2Name && team2Key === item1Name;\n        });\n        const uniqueDays = new Set(headToHeadGames.map((game)=>new Date(game.endTime).toISOString().split('T')[0]));\n        const totalDaysPlayed = uniqueDays.size;\n        if (headToHeadGames.length === 0) return {\n            totalSets: 0,\n            totalTimeMs: 0,\n            totalDaysPlayed: 0,\n            item1: {\n                name: item1Name,\n                setsWon: 0,\n                gamesWon: 0\n            },\n            item2: {\n                name: item2Name,\n                setsWon: 0,\n                gamesWon: 0\n            }\n        };\n        let totalTimeMs = 0;\n        let item1SetsWon = 0;\n        let item2SetsWon = 0;\n        let item1GamesWon = 0;\n        let item2GamesWon = 0;\n        headToHeadGames.forEach((game)=>{\n            const [h, m] = game.duration.split('h').map((s)=>parseInt(s.replace('m', ''), 10));\n            totalTimeMs += h * 3600000 + m * 60000;\n            if (game.winner === 'skipped') return;\n            const isItem1Winner = game.winner === 'team1' && (type === 'player' ? game.teams.team1.includes(item1Name) : [\n                ...game.teams.team1\n            ].sort().join(' & ') === item1Name) || game.winner === 'team2' && (type === 'player' ? game.teams.team2.includes(item1Name) : [\n                ...game.teams.team2\n            ].sort().join(' & ') === item1Name);\n            if (isItem1Winner) item1SetsWon++;\n            else item2SetsWon++;\n            if (game.score) {\n                const team1Score = game.score.team1 || 0;\n                const team2Score = game.score.team2 || 0;\n                const isItem1OnTeam1 = type === 'player' ? game.teams.team1.includes(item1Name) : [\n                    ...game.teams.team1\n                ].sort().join(' & ') === item1Name;\n                if (isItem1OnTeam1) {\n                    item1GamesWon += team1Score;\n                    item2GamesWon += team2Score;\n                } else {\n                    item1GamesWon += team2Score;\n                    item2GamesWon += team1Score;\n                }\n            }\n        });\n        return {\n            totalSets: headToHeadGames.length,\n            totalTimeMs: totalTimeMs,\n            totalDaysPlayed: totalDaysPlayed,\n            item1: {\n                name: item1Name,\n                setsWon: item1SetsWon,\n                gamesWon: item1GamesWon\n            },\n            item2: {\n                name: item2Name,\n                setsWon: item2SetsWon,\n                gamesWon: item2GamesWon\n            }\n        };\n    }\n    function renderComparisonModal() {\n        const stats = calculateComparisonStats();\n        if (!stats) {\n            comparisonContent.innerHTML = \"<p>Error calculating stats.</p>\";\n            return;\n        }\n        const { totalSets, totalTimeMs, totalDaysPlayed, item1, item2 } = stats;\n        const item1WinPct = totalSets > 0 ? Math.round(item1.setsWon / totalSets * 100) : 0;\n        const item2WinPct = totalSets > 0 ? Math.round(item2.setsWon / totalSets * 100) : 0;\n        const totalGamesPlayed = item1.gamesWon + item2.gamesWon;\n        const item1GamesWinPct = totalGamesPlayed > 0 ? Math.round(item1.gamesWon / totalGamesPlayed * 100) : 0;\n        const item2GamesWinPct = totalGamesPlayed > 0 ? Math.round(item2.gamesWon / totalGamesPlayed * 100) : 0;\n        // --- UPDATED: Determine winner and loser classes for styling ---\n        let item1SetsNameClass = '', item2SetsNameClass = '';\n        if (item1.setsWon > item2.setsWon) {\n            item1SetsNameClass = 'h2h-winner-text';\n            item2SetsNameClass = 'h2h-loser-text'; // Loser\n        } else if (item2.setsWon > item1.setsWon) {\n            item1SetsNameClass = 'h2h-loser-text'; // Loser\n            item2SetsNameClass = 'h2h-winner-text';\n        }\n        let item1SetsBgClass = '', item2SetsBgClass = '';\n        if (item1.setsWon > item2.setsWon) {\n            item1SetsBgClass = 'h2h-winner-bg';\n            item2SetsBgClass = 'h2h-loser-bg';\n        } else if (item2.setsWon > item1.setsWon) {\n            item1SetsBgClass = 'h2h-loser-bg';\n            item2SetsBgClass = 'h2h-winner-bg';\n        }\n        let item1GamesBgClass = '', item2GamesBgClass = '';\n        if (item1.gamesWon > item2.gamesWon) {\n            item1GamesBgClass = 'h2h-winner-bg';\n            item2GamesBgClass = 'h2h-loser-bg';\n        } else if (item2.gamesWon > item1.gamesWon) {\n            item1GamesBgClass = 'h2h-loser-bg';\n            item2GamesBgClass = 'h2h-winner-bg';\n        }\n        comparisonTitle.textContent = `Head-to-Head: ${state.comparison.type === 'player' ? 'Players' : 'Teams'}`;\n        comparisonFilterContainer.innerHTML = createGameHistoryFilters();\n        comparisonFilterContainer.querySelectorAll('input[name=\"game-time-filter\"]').forEach((radio)=>{\n            radio.addEventListener('change', (e)=>{\n                state.comparison.timeFrame = e.target.value;\n                renderComparisonModal();\n            });\n        });\n        const activeRadio = comparisonFilterContainer.querySelector(`input[value=\"${state.comparison.timeFrame}\"]`);\n        if (activeRadio) activeRadio.checked = true;\n        comparisonContent.innerHTML = `\n            <div class=\"comparison-grid-content\">\n                <div class=\"comparison-column\">\n                    <div class=\"comparison-header ${item1SetsNameClass}\">${item1.name.replace(/ \\& /g, '<br>')}</div>\n                    <div class=\"comparison-stat-card ${item1SetsBgClass}\">\n                        <div class=\"label\">Sets Won</div>\n                        <div class=\"value\">${item1.setsWon}</div>\n                        <div class=\"win-percentage\">${item1WinPct}% of sets</div>\n                    </div>\n                    <div class=\"comparison-stat-card ${item1GamesBgClass}\">\n                        <div class=\"label\">Games Won</div>\n                        <div class=\"value\">${item1.gamesWon}</div>\n                        <div class=\"win-percentage\">${item1GamesWinPct}% of games</div>\n                    </div>\n                </div>\n\n                <div class=\"comparison-column\">\n                    <div class=\"comparison-header ${item2SetsNameClass}\">${item2.name.replace(/ \\& /g, '<br>')}</div>\n                    <div class=\"comparison-stat-card ${item2SetsBgClass}\">\n                        <div class=\"label\">Sets Won</div>\n                        <div class=\"value\">${item2.setsWon}</div>\n                        <div class=\"win-percentage\">${item2WinPct}% of sets</div>\n                    </div>\n                    <div class=\"comparison-stat-card ${item2GamesBgClass}\">\n                        <div class=\"label\">Games Won</div>\n                        <div class=\"value\">${item2.gamesWon}</div>\n                        <div class=\"win-percentage\">${item2GamesWinPct}% of games</div>\n                    </div>\n                </div>\n\n                <div class=\"comparison-summary-row\">\n                    <div class=\"comparison-summary-card\">\n                        <div class=\"label\">Total Days Played</div>\n                        <div class=\"value\">${totalDaysPlayed}</div>\n                    </div>\n                    <div class=\"comparison-summary-card\">\n                        <div class=\"label\">Total Time on Court</div>\n                        <div class=\"value\">${formatDuration(totalTimeMs)}</div>\n                    </div>\n                </div>\n\n                <div class=\"comparison-summary-row\">\n                    <div class=\"comparison-summary-card\">\n                        <div class=\"label\">Total Sets Played</div>\n                        <div class=\"value\">${totalSets}</div>\n                    </div>\n                    <div class=\"comparison-summary-card\">\n                        <div class=\"label\">Total Games Played</div>\n                        <div class=\"value\">${totalGamesPlayed}</div>\n                    </div>\n                </div>\n            </div>\n        `;\n        historyPage.classList.add('hidden');\n        comparisonModal.classList.remove('hidden');\n    }\n    function resetComparisonState() {\n        state.comparison = {\n            active: false,\n            type: null,\n            items: [],\n            timeFrame: 'Total',\n            opponents: new Set()\n        };\n        document.querySelectorAll('.selected-for-comparison').forEach((el)=>el.classList.remove('selected-for-comparison'));\n        document.querySelectorAll('.not-a-match').forEach((el)=>el.classList.remove('not-a-match'));\n        saveState(); // Add this line\n    }\n    // --- NEW FUNCTION TO RESET FILTERS ---\n    function resetStatsFilters() {\n        state.statsFilter = {\n            gender: 'all',\n            teamGender: 'all',\n            sortKey: 'totalDurationMs',\n            sortOrder: 'desc'\n        };\n        state.gameHistoryFilter = {\n            timeFrame: 'Total',\n            gameType: 'all'\n        };\n        state.historySort = {\n            key: 'endTime',\n            order: 'desc'\n        };\n        saveState(); // Save the reset state\n    }\n    // Helper function to check if a game falls within the selected time frame\n    function isGameInTimeFrame(game, timeFrame) {\n        const gameDate = new Date(game.endTime);\n        const now = new Date();\n        const gameYear = gameDate.getFullYear();\n        const currentYear = now.getFullYear();\n        switch(timeFrame){\n            case 'Today':\n                return gameDate.toISOString().split('T')[0] === now.toISOString().split('T')[0];\n            case 'Month':\n                return gameYear === currentYear && gameDate.getMonth() === now.getMonth();\n            case 'Year':\n                return gameYear === currentYear;\n            case 'Total':\n            default:\n                return true;\n        }\n    }\n    // Handler for the time frame filter change\n    function handleGameTimeFilterChange(e) {\n        state.gameHistoryFilter.timeFrame = e.target.value;\n        saveState();\n        renderGameHistory();\n    }\n    // Handler for the game type filter change\n    function handleGameTypeFilterChange(e) {\n        state.gameHistoryFilter.gameType = e.target.value;\n        saveState();\n        renderGameHistory();\n    }\n    function handleHistorySortClick(e) {\n        const key = e.target.dataset.sortKey;\n        if (!key) return;\n        if (state.historySort.key === key) state.historySort.order = state.historySort.order === 'asc' ? 'desc' : 'asc';\n        else {\n            state.historySort.key = key;\n            state.historySort.order = 'desc'; // Default to descending for any new column\n        }\n        renderGameHistory(); // Re-render just the game history list\n        saveState();\n    }\n    function createCourtCard(court) {\n        const requiredPlayers = state.selection.gameMode === \"doubles\" ? 4 : 2;\n        const playersSelected = state.selection.players.length;\n        const selectionComplete = playersSelected === requiredPlayers;\n        const isCollapsed = court.isCollapsed;\n        const isModeOverlayActive = court.isModeOverlayActive === true;\n        const courtMode = court.courtMode || 'doubles';\n        const bodyClass = isCollapsed ? 'is-collapsed' : '';\n        const iconClass = isCollapsed ? 'mdi-chevron-down' : 'mdi-chevron-up';\n        // --- CORE LOGIC FOR RESERVED / SELECTABLE STATES ---\n        let isReservedSelectable = false;\n        let isGreenBallSelectable = false;\n        // Selection logic only runs if enough players are selected to potentially start *a game* (2 players).\n        if (court.status === 'available' && playersSelected >= 2) {\n            // CRITERIA FOR RED BALL (Reserved/Exclusionary)\n            if (courtMode === 'league' && selectionComplete) isReservedSelectable = true;\n            else if (courtMode === 'singles' && playersSelected === 4) isReservedSelectable = true;\n            else if (requiredPlayers === 2 && (courtMode === 'doubles' || courtMode === 'league' || courtMode === 'rookie')) isReservedSelectable = true;\n            // CRITERIA FOR GREEN BALL (Selectable for Play)\n            if (!isReservedSelectable && selectionComplete) {\n                if (requiredPlayers === 2) // User selected 2 players (Singles Mode)\n                {\n                    if (courtMode === 'singles') isGreenBallSelectable = true;\n                } else if (requiredPlayers === 4) // User selected 4 players (Doubles Mode)\n                {\n                    if (courtMode === 'doubles' || courtMode === 'rookie') isGreenBallSelectable = true;\n                }\n            }\n        }\n        const isSelectable = isGreenBallSelectable || isReservedSelectable;\n        const selectionMinimumMet = playersSelected >= 2;\n        const finalIsSelectable = selectionMinimumMet && isSelectable;\n        const reservedClass = isReservedSelectable && !isGreenBallSelectable ? 'is-reserved-only' : '';\n        const isSelected = court.id === state.selection.courtId;\n        let statusText;\n        let isLeagueReserved = false;\n        let isRookieMode = courtMode === 'rookie';\n        if (isSelected) statusText = 'SELECTED';\n        else if (court.status === 'available' && courtMode === 'league') {\n            statusText = 'League';\n            isLeagueReserved = true;\n        } else if (court.status === 'available' && isRookieMode) statusText = 'Rookie';\n        else statusText = court.status.replace(/_/g, ' ');\n        const courtCard = document.createElement('div');\n        let modeClass = '';\n        if (court.status === 'available') {\n            if (isLeagueReserved) modeClass = 'is-league-reserved';\n            else if (isRookieMode) modeClass = 'is-rookie-mode';\n        }\n        courtCard.className = `court-card status-${court.status} ${isSelected ? 'selected' : ''} ${finalIsSelectable ? 'selectable' : ''} ${bodyClass} ${reservedClass} ${modeClass}`;\n        courtCard.dataset.courtId = court.id;\n        if (isModeOverlayActive) courtCard.dataset.modeOverlayActive = 'true';\n        let cancelBtnHTML = '';\n        let editBtnHTML = '';\n        if (court.status !== 'available' && !isSelected) cancelBtnHTML = `<button class=\"cancel-game-btn on-court\" title=\"Cancel Game\" data-action=\"cancel-game-setup\">X</button>`;\n        // --- UPDATED: Always show pencil icon for in-progress games ---\n        if (court.status === 'in_progress') // Always show the edit/manage players button (pencil icon)\n        editBtnHTML = `<button class=\"edit-game-btn on-court\" title=\"Manage Players\" data-action=\"edit-game\"><i class=\"mdi mdi-pencil\"></i></button>`;\n        else if (court.status === 'game_pending' && court.teamsSet === false) // For pending doubles games that need teams chosen, still show team icon\n        editBtnHTML = `<button class=\"edit-game-btn on-court\" title=\"Set Teams\" data-action=\"choose-teams\"><i class=\"mdi mdi-account-group-outline\"></i></button>`;\n        // --- END UPDATED ---\n        const moreOptionsBtnHTML = `\n            <button class=\"more-options-btn on-court\" title=\"More Options\" data-action=\"more-options\" data-court-id=\"${court.id}\">\n                <i class=\"mdi mdi-dots-horizontal\"></i>\n            </button>\n        `;\n        const modeOverlayHTML = `\n            <div class=\"mode-selection-overlay\" data-court-id=\"${court.id}\">\n                <button class=\"mode-btn-overlay doubles-mode\" data-action=\"set-court-mode\" data-mode=\"doubles\">Doubles</button>\n                <button class=\"mode-btn-overlay singles-mode\" data-action=\"set-court-mode\" data-mode=\"singles\">Singles</button>\n                <button class=\"mode-btn-overlay beginner-mode\" data-action=\"set-court-mode\" data-mode=\"rookie\">Rookie</button>\n                <button class=\"mode-btn-overlay league-mode\" data-action=\"set-court-mode\" data-mode=\"league\">League</button>\n            </div>\n        `;\n        const courtIndex = COURT_HIERARCHY.indexOf(court.id);\n        const staticStaggerMs = courtIndex >= 0 ? courtIndex * 500 : 0;\n        let animationDurationMs = 4000;\n        if (courtMode === 'rookie') animationDurationMs = 8000;\n        const elapsedTime = Date.now() - state.pongAnimationOffset;\n        const currentOffsetMs = (elapsedTime + staticStaggerMs) % animationDurationMs;\n        const delayStyle = `animation-delay: -${(currentOffsetMs / 1000).toFixed(3)}s;`;\n        const pongAnimationSinglesHTML = `\n            <div class=\"pong-animation-container\" data-mode=\"singles\">\n                <div class=\"pong-paddle top-paddle\" style=\"animation-name: pong-top-move; ${delayStyle}\"></div>\n                <div class=\"pong-paddle bottom-paddle\" style=\"animation-name: pong-bottom-move; ${delayStyle}\"></div>\n                <div class=\"pong-ball\" style=\"${delayStyle}\"></div>\n            </div>\n        `;\n        const pongAnimationDoublesHTML = `\n            <div class=\"pong-animation-container\" data-mode=\"doubles\">\n                <div class=\"pong-paddle double dl top-paddle\" style=\"animation-name: pong-move-tl; ${delayStyle}\"></div>\n                <div class=\"pong-paddle double dr top-paddle\" style=\"animation-name: pong-move-tr; ${delayStyle}\"></div>\n                <div class=\"pong-paddle double dl bottom-paddle\" style=\"animation-name: pong-move-bl; ${delayStyle}\"></div>\n                <div class=\"pong-paddle double dr bottom-paddle\" style=\"animation-name: pong-move-br; ${delayStyle}\"></div>\n                <div class=\"pong-ball\" style=\"${delayStyle}\"></div>\n            </div>\n        `;\n        const pongAnimationRedBallHTML = `\n            <div class=\"pong-animation-container\" data-mode=\"in_progress\">\n                <div class=\"pong-ball red-ball-in-progress\" style=\"${delayStyle}\"></div>\n            </div>\n        `;\n        let bodyTimerHTML = '';\n        if (court.status === 'in_progress' || court.status === 'game_pending') bodyTimerHTML = `<div class=\"court-body-timer status-${court.status}\" id=\"timer-${court.id}\"></div>`;\n        const formatName = (playerObj)=>playerObj ? playerObj.name.split(' ')[0] : '';\n        let playerSpotsHTML = '';\n        let coreReserveTextHTML = '';\n        let animationHTML = '';\n        let matchModeDisplayHTML = '';\n        if ((court.status === 'in_progress' || court.status === 'game_pending') && court.matchMode) {\n            let text = '';\n            if (court.matchMode === 'fast') text = `Fast Play (${court.fastPlayGames} games)`;\n            else if (court.matchMode === '1set') text = '1 Set Match';\n            else if (court.matchMode === '3set') text = '3 Set Match';\n            if (text) matchModeDisplayHTML = `<div class=\"match-mode-display\">${text}</div>`;\n        }\n        // --- DRAGGABLE PLAYER NAMES ---\n        const makeDraggable = court.status === 'in_progress' || court.status === 'game_pending';\n        const draggableAttr = makeDraggable ? 'draggable=\"true\"' : '';\n        const draggableClass = makeDraggable ? 'draggable-player' : '';\n        if (court.status !== 'available') {\n            if (court.gameMode === 'singles') playerSpotsHTML = `\n                    <div class=\"player-spot single-player top-row\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[0]?.name || ''}\" data-player-pos=\"top\">\n                        <span class=\"${draggableClass}\">${formatName(court.teams.team1[0])}</span>\n                    </div>\n                    <div class=\"player-spot single-player bottom-row\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[0]?.name || ''}\" data-player-pos=\"bottom\">\n                        <span class=\"${draggableClass}\">${formatName(court.teams.team2[0])}</span>\n                    </div>\n                `;\n            else if (court.teamsSet === false) playerSpotsHTML = `\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[0]?.name || ''}\" data-team=\"unset\">\n                            <span class=\"${draggableClass}\">${formatName(court.players[0])}</span>\n                        </div>\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[1]?.name || ''}\" data-team=\"unset\">\n                            <span class=\"${draggableClass}\">${formatName(court.players[1])}</span>\n                        </div>\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[2]?.name || ''}\" data-team=\"unset\">\n                            <span class=\"${draggableClass}\">${formatName(court.players[2])}</span>\n                        </div>\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[3]?.name || ''}\" data-team=\"unset\">\n                            <span class=\"${draggableClass}\">${formatName(court.players[3])}</span>\n                        </div>\n                    `;\n            else playerSpotsHTML = `\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[0]?.name || ''}\" data-team=\"team1\">\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team1[0])}</span>\n                        </div>\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[1]?.name || ''}\" data-team=\"team1\">\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team1[1])}</span>\n                        </div>\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[0]?.name || ''}\" data-team=\"team2\">\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team2[0])}</span>\n                        </div>\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[1]?.name || ''}\" data-team=\"team2\">\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team2[1])}</span>\n                        </div>\n                    `;\n            if (court.status === 'in_progress') animationHTML = pongAnimationRedBallHTML;\n        }\n        // --- END DRAGGABLE PLAYER NAMES ---\n        let overlayHTML = '';\n        if (isSelected) {\n            const readyClass = selectionComplete ? 'is-ready' : '';\n            overlayHTML = `\n                <div class=\"confirmation-overlay\">\n                    <button class=\"court-confirm-btn cancel\" data-action=\"cancel-selection\">Cancel</button>\n                    <button class=\"court-confirm-btn confirm ${readyClass}\" data-action=\"confirm-selection\">Confirm</button>\n                </div>\n            `;\n        } else if (finalIsSelectable) {\n            const ballClass = isReservedSelectable ? 'reserved-ball' : '';\n            const isEligibleForSelection = isGreenBallSelectable ? '' : 'data-reserved-only=\"true\"';\n            const disabledAttr = isReservedSelectable || isLeagueReserved ? 'disabled' : '';\n            const buttonText = isReservedSelectable || isLeagueReserved ? '' : `SELECT<br>COURT ${court.id}`;\n            overlayHTML = `\n                <div class=\"court-selection-overlay\">\n                    <button class=\"court-confirm-btn select-court ${ballClass}\" data-action=\"select-court-action\" ${isEligibleForSelection} ${disabledAttr}>${buttonText}</button>\n                </div>\n            `;\n        } else if (court.status === 'selecting_teams') overlayHTML = `\n                <div class=\"team-selection-overlay\">\n                    <button class=\"court-confirm-btn randomize\" data-action=\"randomize-teams\">Randomize Teams</button>\n                    <button class=\"court-confirm-btn choose\" data-action=\"choose-teams\">Choose Teams</button>\n                    <button class=\"court-confirm-btn choose-later\" data-action=\"choose-later\">Choose Later</button>\n                </div>\n            `;\n        else if (court.status === 'game_pending') overlayHTML = `\n                <div class=\"game-action-overlay\">\n                    <button class=\"court-confirm-btn select-court\" data-action=\"start-game\">START MATCH</button>\n                </div>\n            `;\n        else if (court.status === 'in_progress') {\n            const ballClass = court.isNewGame ? 'animate-in' : 'visible';\n            overlayHTML = `\n                <div class=\"game-action-overlay\">\n                    <button class=\"court-confirm-btn end-game-ball ${ballClass}\" data-action=\"end-game\">END<br>MATCH</button>\n                </div>\n            `;\n        }\n        let reserveTextHTML = coreReserveTextHTML;\n        if (court.status === 'available') {\n            reserveTextHTML = '';\n            if (courtMode === 'league') playerSpotsHTML = `<div class=\"league-reserved-icon-container\"></div>`;\n            else if (courtMode === 'singles') playerSpotsHTML = pongAnimationSinglesHTML;\n            else if (courtMode === 'doubles' || courtMode === 'rookie') playerSpotsHTML = pongAnimationDoublesHTML;\n            else playerSpotsHTML = '';\n        }\n        const light = state.lightSettings.courts[court.id];\n        const isLightManaged = light && light.isManaged;\n        const lightIconClass = isLightManaged && light.isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline';\n        const lightDisabledAttr = isLightManaged ? '' : 'disabled';\n        const lightBtnHTML = `\n            <button class=\"light-toggle-btn on-court\" title=\"Toggle Lights\" data-action=\"toggle-light\" data-court-id=\"${court.id}\" ${lightDisabledAttr}>\n                <i class=\"mdi ${lightIconClass}\"></i>\n            </button>\n        `;\n        courtCard.innerHTML = `\n            <div class=\"card-header header-status-${court.status}\">\n                <h3>Court ${court.id}</h3>\n                <div class=\"header-controls\">\n                    <span class=\"status-tag\">${statusText}</span>\n                    <button class=\"settings-btn summary-toggle-btn\" data-court-id=\"${court.id}\" data-card-type=\"court\" title=\"Toggle Details\">\n                        <i class=\"mdi ${iconClass}\"></i>\n                    </button>\n                </div>\n            </div>\n            <div class=\"card-body\">\n                <div class=\"court-inner\">\n                    ${bodyTimerHTML}\n                    <div class=\"center-service-line\"></div>\n                    ${playerSpotsHTML}\n                    ${animationHTML}\n                    ${overlayHTML}\n                    ${reserveTextHTML}\n                    ${matchModeDisplayHTML}\n                    ${modeOverlayHTML}\n                </div>\n                ${cancelBtnHTML}\n                ${editBtnHTML}\n                ${moreOptionsBtnHTML}\n                ${lightBtnHTML}\n            </div>`;\n        return courtCard;\n    }\n    // NEW FUNCTION: Calculate the players with the highest stats overall\n    function calculateStarPlayers() {\n        // --- THIS IS THE NEW LOGIC ---\n        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format\n        const todaysGames = state.gameHistory.filter((game)=>{\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\n            return gameDate === today;\n        });\n        const stats = calculatePlayerStats(todaysGames); // Calculate stats for ONLY today's games\n        // --- END OF NEW LOGIC ---\n        const allPlayers = getAllKnownPlayers();\n        let king = {\n            name: null,\n            wp: -1,\n            duration: -1\n        };\n        let queen = {\n            name: null,\n            wp: -1,\n            duration: -1\n        };\n        for(const name in stats){\n            const playerStats = stats[name];\n            const playerObj = allPlayers.find((p)=>p.name === name);\n            // Skip players who opted out of the leaderboard, have no stats, or lack gender info\n            if (!playerObj || playerStats.played === 0 || playerObj.onLeaderboard === false || !playerObj.gender) continue;\n            const winPercentage = playerStats.won / playerStats.played;\n            if (playerObj.gender === 'M') {\n                if (winPercentage > king.wp) king = {\n                    name: name,\n                    wp: winPercentage,\n                    duration: playerStats.totalDurationMs\n                };\n                else if (winPercentage === king.wp && playerStats.totalDurationMs > king.duration) king = {\n                    name: name,\n                    wp: winPercentage,\n                    duration: playerStats.totalDurationMs\n                };\n            } else if (playerObj.gender === 'F') {\n                if (winPercentage > queen.wp) queen = {\n                    name: name,\n                    wp: winPercentage,\n                    duration: playerStats.totalDurationMs\n                };\n                else if (winPercentage === queen.wp && playerStats.totalDurationMs > queen.duration) queen = {\n                    name: name,\n                    wp: winPercentage,\n                    duration: playerStats.totalDurationMs\n                };\n            }\n        }\n        return {\n            kingOfTheCourt: king.name,\n            queenOfTheCourt: queen.name\n        };\n    }\n    // END NEW FUNCTION\n    function createSummaryCard() {\n        const total = totalPlayersAtClub();\n        const available = getActivePlayerCount();\n        const onCourt = total - available;\n        const availableCourtsCount = state.courts.filter((c)=>state.courtSettings.visibleCourts.includes(c.id) && c.status === 'available').length;\n        const totalVisibleCourts = state.courtSettings.visibleCourts.length;\n        const onDutyName = state.onDuty === 'None' ? 'Nobody' : state.onDuty;\n        const dutyLabel = state.onDuty === 'None' ? 'Call Any Committee Member!' : 'Is On Duty. Call Me!';\n        const { kingOfTheCourt, queenOfTheCourt } = calculateStarPlayers();\n        let matchModeText = '';\n        if (state.matchSettings.matchMode === '1set') matchModeText = '1 Set Game Mode';\n        else if (state.matchSettings.matchMode === '3set') matchModeText = '3 Set Game Mode';\n        else matchModeText = `Fast Play ${state.matchSettings.fastPlayGames} Game Mode`;\n        const availableCourts = state.courts.filter((c)=>c.status === 'available' && state.courtSettings.visibleCourts.includes(c.id));\n        const doublesAvailable = availableCourts.filter((c)=>c.courtMode === 'doubles').length;\n        const singlesAvailable = availableCourts.filter((c)=>c.courtMode === 'singles').length;\n        const rookieAvailable = availableCourts.filter((c)=>c.courtMode === 'rookie').length;\n        const isExpanded = state.mobileControls.isSummaryExpanded;\n        const bodyClass = isExpanded ? '' : 'is-collapsed';\n        const iconClass = isExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down';\n        return `\n            <div class=\"summary-card ${bodyClass}\" data-card-type=\"summary\">\n                <div class=\"card-header\">\n                    <h3>Information</h3>\n                    <div class=\"header-controls\">\n                        <button class=\"settings-btn summary-toggle-btn\" data-card-type=\"summary\" title=\"Toggle Details\">\n                            <i class=\"mdi ${iconClass}\"></i>\n                        </button>\n                        <button class=\"settings-btn\" id=\"notify-now-btn\" title=\"Force Notification Now\">\\u{1F4E2}</button>\n                        <button class=\"settings-btn\" id=\"settings-btn\" title=\"Admin Settings\">\\u{2699}\\u{FE0F}</button>\n                    </div>\n                </div>\n                <div class=\"card-body summary-body\">\n                    <div class=\"on-duty-section\">\n                        <div class=\"duty-info-container\">\n                            <button id=\"call-duty-btn\" class=\"duty-image-placeholder\" title=\"Call On-Duty Member\">\n                                <i class=\"mdi mdi-phone duty-icon\"></i>\n                                <span class=\"duty-text\">PRESS</span>\n                            </button>\n                            <div class=\"duty-info\">\n                                <p class=\"duty-name\">${onDutyName}</p>\n                                <p class=\"duty-label\">${dutyLabel}</p>\n                            </div>\n                        </div>\n                        <span id=\"alert-status-display\"></span>\n                    </div>\n\n                    <div class=\"summary-match-mode\">\n                        <p>\n                            <span class=\"match-mode-label\">Match Mode:</span>\n                            <span class=\"match-mode-value\">${matchModeText}</span>\n                        </p>\n                    </div>\n\n                    <div class=\"summary-stats\">\n                        <div class=\"summary-stats-grid\">\n                            <div class=\"stats-column\">\n                                <div><span>Players:</span> <strong>${total}</strong></div>\n                                <div><span>Queueing:</span> <strong class=\"available-value\">${available}</strong></div>\n                                <div><span>On Court:</span> <strong class=\"on-court-value\">${onCourt}</strong></div>\n                            </div>\n                            <div class=\"stats-column\">\n                                <div><span>Courts:</span> <strong>${availableCourtsCount} / ${totalVisibleCourts}</strong></div>\n                                <div><span>Availability:</span> <strong>D:${doublesAvailable} S:${singlesAvailable} R:${rookieAvailable}</strong></div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"summary-extra-stats\">\n                        <div>\n                            <span class=\"stat-label\">King of the Court!</span>\n                            <strong class=\"stat-value\">\\u{1F451} ${kingOfTheCourt || 'N/A'}</strong>\n                        </div>\n                        <div>\n                            <span class=\"stat-label\">Queen of the Court!</span>\n                            <strong class=\"stat-value\">\\u{1F451} ${queenOfTheCourt || 'N/A'}</strong>\n                        </div>\n                    </div>\n\n                    <div class=\"quote-section\">\n                        <p id=\"quote-text\" class=\"quote-text\"></p>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n    function updateGameModeBasedOnPlayerCount() {\n        const availableCount = getActivePlayerCount();\n        let newMode = state.selection.gameMode;\n        let modeChanged = false;\n        if (availableCount < 4) newMode = 'singles';\n        else if (availableCount >= 4) newMode = 'doubles';\n        if (newMode !== state.selection.gameMode) {\n            state.selection.gameMode = newMode;\n            modeChanged = true;\n        }\n        const requiredPlayers = newMode === 'doubles' ? 4 : 2;\n        if (modeChanged || state.selection.players.length > requiredPlayers) {\n            state.selection.players = [];\n            state.selection.courtId = null;\n        }\n    }\n    // --- NEW FUNCTION: Dynamically sets game mode based on player selection ---\n    function updateGameModeBasedOnSelection() {\n        const { players: selectedPlayers } = state.selection;\n        const isSinglesCourtAvailable = state.courts.some((c)=>c.status === 'available' && c.courtMode === 'singles' && state.courtSettings.visibleCourts.includes(c.id));\n        // If 2 players are selected AND a singles court is free, switch to singles mode\n        if (selectedPlayers.length === 2 && isSinglesCourtAvailable) {\n            if (state.selection.gameMode !== 'singles') state.selection.gameMode = 'singles';\n        } else // In all other cases (more players selected, or no singles court), default to doubles\n        if (state.selection.gameMode !== 'doubles') state.selection.gameMode = 'doubles';\n    }\n    // --- NEW HELPER FUNCTION ---\n    function getLastCheckInForChild(childFullName) {\n        let latestCheckIn = 0;\n        // Iterate through all history entries\n        state.juniorClub.history.forEach((historyEntry)=>{\n            // Check if the child attended this session (childFullName is in the childNames array)\n            if (historyEntry.childNames && historyEntry.childNames.includes(childFullName)) // The historyEntry.id is the timestamp of the session check-in\n            {\n                if (historyEntry.id > latestCheckIn) latestCheckIn = historyEntry.id;\n            }\n        });\n        return latestCheckIn; // Returns 0 if no history found\n    }\n    // --- NEW HELPER FUNCTION ---\n    function getLastCheckInForChild(childFullName) {\n        let latestCheckIn = 0;\n        // Iterate through all history entries\n        state.juniorClub.history.forEach((historyEntry)=>{\n            // FIX 1: Trim the lookup key (childFullName) before checking inclusion.\n            if (historyEntry.childNames && historyEntry.childNames.includes(childFullName.trim())) // The historyEntry.id is the timestamp of the session check-in\n            {\n                if (historyEntry.id > latestCheckIn) latestCheckIn = historyEntry.id;\n            }\n        });\n        return latestCheckIn; // Returns 0 if no history found\n    }\n    // --- ADDED HELPER FUNCTION ---\n    function createPlayerListItem(player, index, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase = false, sliceEnd = 8, specialHighlightIndex = -1, isSelector = false, inGroup = false) {\n        const li = document.createElement(\"li\");\n        const playerName = player.name;\n        let statusText;\n        // *** MODIFIED STATUS TEXT LOGIC ***\n        if (player.guest) {\n            // If it's a guest AND they have a specific type (Junior, Adult, etc.)\n            if (player.type) statusText = `${player.type} Guest`; // e.g., \"Adult Guest\"\n            else statusText = 'Guest'; // Fallback if type is missing\n        } else if (player.committee) statusText = `Committee ${player.committee}`; //\n        else // For members, use their type from the master list if available, otherwise default\n        statusText = player.type ? `${player.type} Member` : 'Member'; //\n        // *** END MODIFIED LOGIC ***\n        let priorityText = '';\n        let priorityClass = 'player-status'; // Use player-status by default\n        if (playerName === state.onDuty) {\n            priorityText = 'Low Priority'; //\n            priorityClass = 'player-priority'; //\n        }\n        let iconHtml = '';\n        const isKing = playerName === starPlayers.kingOfTheCourt;\n        const isQueen = playerName === starPlayers.queenOfTheCourt;\n        const isHeartbreaker = playerName === heartbreakerName;\n        const streak = winningStreaks[playerName] || 0;\n        const statusFaderItems = [\n            statusText\n        ]; // Start fader items with the primary status\n        let statusHTML;\n        if (isKing || isQueen) {\n            iconHtml += '<span style=\"color: gold; margin-left: 5px;\">\\uD83D\\uDC51</span>'; //\n            statusFaderItems.push(isKing ? \"King of the Court\" : \"Queen of the Court\"); //\n        }\n        if (streak >= 3) {\n            iconHtml += `<span title=\"${streak} wins in a row!\" style=\"margin-left: 5px;\">\\u{1F3B2}</span>`; //\n            statusFaderItems.push(\"On a roll!\"); //\n        }\n        if (isHeartbreaker) {\n            iconHtml += `<span title=\"Heartbreaker!\" style=\"margin-left: 5px;\">\\u{1F494}</span>`; //\n            statusFaderItems.push(\"So Close!\"); //\n        }\n        // Generate status HTML, handling the fader if needed\n        if (statusFaderItems.length > 1) {\n            statusHTML = `<div class=\"player-status-fader\">`; //\n            // Add the primary status text first (which now includes the type for guests)\n            statusHTML += `<span class=\"status-text is-visible ${priorityClass}\">${priorityText || statusText}</span>`; //\n            // Add other fading statuses (King/Queen, On a Roll, etc.)\n            statusFaderItems.slice(1).forEach((text)=>{\n                statusHTML += `<span class=\"status-text\">${text}</span>`; //\n            });\n            statusHTML += `</div>`;\n        } else // If only one status, display it directly\n        statusHTML = `<span class=\"${priorityClass}\">${priorityText || statusText}</span>`; //\n        const isPaused = player.isPaused;\n        const pauseIcon = isPaused ? 'mdi-play' : 'mdi-pause'; //\n        const pauseAction = isPaused ? 'resume' : 'pause'; //\n        let playtimeHTML;\n        if (isPaused && player.pauseTime) {\n            const TEN_MINUTES_MS = 600000;\n            const elapsed = Date.now() - player.pauseTime;\n            const remaining = Math.max(0, TEN_MINUTES_MS - elapsed);\n            const minutes = Math.floor(remaining / 60000);\n            const seconds = Math.floor(remaining % 60000 / 1000);\n            const timeString = `${String(minutes).padStart(2, \"0\")}m${String(seconds).padStart(2, \"0\")}s`;\n            playtimeHTML = `<span class=\"player-playtime player-pause-cooldown\" data-pause-time=\"${player.pauseTime}\">${timeString}</span>`; //\n        } else {\n            const playtime = playerStats[playerName] ? formatDuration(playerStats[playerName].totalDurationMs) : '00h00m';\n            playtimeHTML = `<span class=\"player-playtime\">${playtime}</span>`; //\n        }\n        let suggestionButtonHTML = '<div class=\"suggestion-icon-wrapper\"></div>'; // Placeholder for alignment\n        if (isSelector && getActivePlayerCount() >= 5) suggestionButtonHTML = `<div class=\"suggestion-icon-wrapper\"><button class=\"suggestion-btn\" title=\"Suggest a balanced game\">\\u{1F4A1}</button></div>`; //\n        li.innerHTML = `\n            <div class=\"player-details\">\n                <div class=\"player-name-container\">\n                    <span class=\"player-name\">${playerName}</span>\n                    ${iconHtml}\n                </div>\n                ${statusHTML}\n            </div>\n            <div class=\"player-stats\">\n                ${suggestionButtonHTML}\n                <button class=\"pause-toggle-btn\" data-player-name=\"${playerName}\" data-action=\"${pauseAction}\" title=\"${isPaused ? 'Resume Game Play' : 'Pause Game Play'}\">\n                    <i class=\"mdi ${pauseIcon}\"></i>\n                </button>\n                <div class=\"gender-container gender-${player.gender}\">\n                    <span class=\"player-gender\">${player.gender}</span>\n                </div>\n                ${playtimeHTML}\n            </div>\n        `; //\n        li.dataset.playerName = playerName; //\n        // Apply suggestion classes if a suggestion is active\n        if (state.activeSuggestion) {\n            const { team1, team2 } = state.activeSuggestion;\n            if (team1.some((p)=>p.name === playerName)) li.classList.add('suggested-partner'); //\n            else if (team2.some((p)=>p.name === playerName)) li.classList.add('suggested-opponent'); //\n        }\n        if (player.isPaused) li.classList.add(\"paused-player\"); //\n        if (selectedPlayerNames.includes(playerName)) li.classList.add(\"selected\"); //\n        else {\n            const isSelectionFull = selectedPlayerNames.length >= 4; // Check if 4 players already selected\n            let isDisabled = false;\n            if (isSpecialCase) {\n                if (index >= sliceEnd) isDisabled = true;\n            } else if (index >= sliceEnd) isDisabled = true;\n             //\n            if (player.isPaused) isDisabled = true; //\n            if (index === specialHighlightIndex) isDisabled = false; //\n            // Disable if selection is full OR if player is beyond the selectable range/paused\n            if (isSelectionFull || isDisabled) li.classList.add(\"disabled\"); //\n        }\n        if (isSelector) li.classList.add(\"first-player\"); //\n        // This handles the case where the paused player at index 0 makes the next available player the 'first-player' visually\n        if (!isSelector && index === state.availablePlayers.findIndex((p)=>!p.isPaused)) li.classList.add(\"first-player\"); //\n        return li;\n    }\n    function handleOnDutyChange(e) {\n        state.onDuty = e.target.value;\n        saveState();\n        enforceQueueLogic(); // --- THIS IS THE FIX ---\n        render();\n    }\n    // NEW FUNCTION: Check if on-duty member is being selected for a game\n    function checkOnDutyMemberInSelection(selectedPlayerNames) {\n        if (state.onDuty === 'None') return false;\n        return selectedPlayerNames.includes(state.onDuty);\n    }\n    // NEW FUNCTION: Show temporary duty handover modal\n    function showTempDutyHandoverModal(callback) {\n        tempDutyHandoverList.innerHTML = '';\n        tempDutyCurrentMember.textContent = state.onDuty;\n        // Get all committee members who are currently checked in\n        const checkedInCommitteeMembers = [\n            ...state.availablePlayers.filter((p)=>p.committee),\n            ...state.courts.flatMap((c)=>c.players).filter((p)=>p.committee)\n        ];\n        const selectedPlayerNames = new Set(state.selection.players);\n        // Remove the current on-duty member and filter for those NOT on court\n        const availableCommitteeMembers = state.availablePlayers.filter((p)=>p.committee && p.name !== state.onDuty && !selectedPlayerNames.has(p.name)).sort((a, b)=>a.name.localeCompare(b.name));\n        // Add \"None\" option first\n        const noneOption = document.createElement('li');\n        noneOption.className = 'committee-member';\n        noneOption.innerHTML = `\n            <label>\n                <input type=\"radio\" name=\"tempDutyMember\" value=\"None\">\n                <div class=\"member-details\">\n                    <span class=\"member-name\">None</span>\n                    <span class=\"member-designation\">No temporary replacement</span>\n                </div>\n            </label>\n        `;\n        tempDutyHandoverList.appendChild(noneOption);\n        // Add available committee members\n        if (availableCommitteeMembers.length === 0) {\n            const noMembersLi = document.createElement('li');\n            noMembersLi.style.justifyContent = 'center';\n            noMembersLi.style.color = 'var(--neutral-color)';\n            noMembersLi.textContent = 'No other committee members available';\n            tempDutyHandoverList.appendChild(noMembersLi);\n        } else availableCommitteeMembers.forEach((member)=>{\n            const li = document.createElement('li');\n            li.className = 'committee-member';\n            li.innerHTML = `\n                    <label>\n                        <input type=\"radio\" name=\"tempDutyMember\" value=\"${member.name}\">\n                        <div class=\"member-details\">\n                            <span class=\"member-name\">${member.name}</span>\n                            <span class=\"member-designation\">${member.committee}</span>\n                        </div>\n                    </label>\n                `;\n            tempDutyHandoverList.appendChild(li);\n        });\n        // Store the callback to execute on confirm\n        tempDutyHandoverModal.dataset.callback = 'pending';\n        tempDutyHandoverModal.callback = callback;\n        tempDutyConfirmBtn.disabled = true;\n        // Enable confirm button when a selection is made\n        tempDutyHandoverList.querySelectorAll('input[name=\"tempDutyMember\"]').forEach((radio)=>{\n            radio.addEventListener('change', ()=>{\n                tempDutyConfirmBtn.disabled = false;\n            });\n        });\n        tempDutyHandoverModal.classList.remove('hidden');\n    }\n    // NEW FUNCTION: Handle temporary duty handover confirmation\n    function handleTempDutyHandoverConfirm() {\n        const selectedMember = tempDutyHandoverList.querySelector('input[name=\"tempDutyMember\"]:checked');\n        if (!selectedMember) return;\n        const newTempDuty = selectedMember.value;\n        const originalDuty = state.onDuty;\n        // Store the original on-duty member\n        if (!state.tempDutyHandover) state.tempDutyHandover = {\n            originalMember: originalDuty,\n            tempMember: newTempDuty,\n            timestamp: Date.now()\n        };\n        // Update the on-duty member\n        state.onDuty = newTempDuty;\n        // Announce the change - using pronounceable names\n        const originalDutyPronounceable = getPronounceableName(originalDuty);\n        if (newTempDuty === 'None') playAlertSound(`There will be nobody on duty while ${originalDutyPronounceable} is in a match.`);\n        else {\n            const newTempDutyPronounceable = getPronounceableName(newTempDuty);\n            playAlertSound(`${newTempDutyPronounceable} is temporarily on duty while ${originalDutyPronounceable} is in a match.`);\n        }\n        tempDutyHandoverModal.classList.add('hidden');\n        // Execute the stored callback (continue with game setup)\n        if (tempDutyHandoverModal.callback) {\n            tempDutyHandoverModal.callback();\n            tempDutyHandoverModal.callback = null;\n        }\n        saveState();\n        render();\n    }\n    // NEW FUNCTION: Restore original duty member after game ends\n    function restoreOriginalDutyMember() {\n        if (state.tempDutyHandover && state.tempDutyHandover.originalMember) {\n            state.onDuty = state.tempDutyHandover.originalMember;\n            state.tempDutyHandover = null;\n            saveState();\n            render();\n        }\n    }\n    // --- CUSTOM ANNOUNCEMENT FUNCTIONS ---\n    function handleTtsIntervalChange(direction) {\n        // --- THIS IS THE FIX ---\n        // Ensure currentInterval is a number, defaulting to 30 if it's not.\n        const currentInterval = Number(state.customAnnouncementState.ttsIntervalMins) || 30;\n        // --- END OF FIX ---\n        let newInterval = currentInterval;\n        if (direction === 'increase') newInterval += 15;\n        else if (direction === 'decrease') newInterval -= 15;\n        // Set a minimum of 15 minutes\n        state.customAnnouncementState.ttsIntervalMins = Math.max(15, newInterval);\n        document.getElementById('tts-interval-display').textContent = `${state.customAnnouncementState.ttsIntervalMins} min`;\n    }\n    function showAnnouncementsModal() {\n        announcementList.innerHTML = ''; // Clear existing list\n        // --- THIS IS THE FIX ---\n        // Ensure the interval defaults to 30 if it's not already a number.\n        const interval = Number(state.customAnnouncementState.ttsIntervalMins) || 30;\n        document.getElementById('tts-interval-display').textContent = `${interval} min`;\n        // --- END OF FIX ---\n        const renderItem = (announcement = {\n            text: '',\n            tts: false\n        }, index, isLast = false)=>{\n            const li = document.createElement('li');\n            const uniqueId = `tts-${Date.now()}-${Math.random()}`;\n            li.innerHTML = `\n                <input type=\"text\" value=\"${announcement.text}\" placeholder=\"Enter announcement text...\">\n                <label for=\"${uniqueId}\" class=\"tts-checkbox-label\">\n                    <input type=\"checkbox\" id=\"${uniqueId}\" ${announcement.tts ? 'checked' : ''}> TTS\n                </label>\n                ${isLast ? '<span class=\"add-announcement-btn\" title=\"Add another message\">+</span>' : ''}\n                <span class=\"action-icon remove\" data-index=\"${index}\" title=\"Remove message\">&times;</span>\n            `;\n            announcementList.appendChild(li);\n        };\n        if (state.announcements.length === 0) renderItem(undefined, 0, true);\n        else state.announcements.forEach((ann, index)=>{\n            renderItem(ann, index, index === state.announcements.length - 1);\n        });\n        adminSettingsModal.classList.add('hidden');\n        customAnnouncementModal.classList.remove('hidden');\n    }\n    function handleAnnouncementsSave() {\n        const newAnnouncements = [];\n        announcementList.querySelectorAll('li').forEach((li)=>{\n            const textInput = li.querySelector('input[type=\"text\"]');\n            const ttsCheckbox = li.querySelector('input[type=\"checkbox\"]');\n            if (textInput && textInput.value.trim() !== '') newAnnouncements.push({\n                text: textInput.value.trim(),\n                tts: ttsCheckbox.checked\n            });\n        });\n        state.announcements = newAnnouncements;\n        saveState();\n        customAnnouncementModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n        // --- THIS IS THE FIX ---\n        // Restart the animation and scheduler to apply all changes immediately.\n        startHeaderTextAnimation();\n        startCustomTtsScheduler();\n    // --- END OF FIX ---\n    }\n    function startHeaderTextAnimation() {\n        // 1. Stop any pending animation cycle\n        if (window.headerAnimationInterval) clearTimeout(window.headerAnimationInterval);\n        // 2. Immediately reset the UI to a clean, default state\n        const announcementContainer = document.getElementById('announcement-container');\n        if (announcementContainer) announcementContainer.innerHTML = ''; // Remove any active scrolling elements\n        const clock = document.getElementById('header-clock');\n        if (clock) clock.style.opacity = 1; // Force the clock to be visible immediately\n        // 3. Exit if there's nothing to animate\n        if (!clock || !announcementContainer || state.announcements.length === 0) return;\n        let currentIndex = 0;\n        const cycleAnimation = ()=>{\n            const announcement = state.announcements[currentIndex];\n            if (!announcement) {\n                clock.style.opacity = 1;\n                window.headerAnimationInterval = setTimeout(cycleAnimation, 10000); // 10-second pause between cycles\n                return;\n            }\n            clock.style.opacity = 0; // Fade out clock\n            setTimeout(()=>{\n                const announcementEl = document.createElement('h1');\n                announcementEl.className = 'scrolling-announcement';\n                // --- START MODIFICATION ---\n                // Use innerHTML to add images\n                announcementEl.innerHTML = `\n                    <span class=\"scrolling-ball\"><span>\\u{1F94E}</span></span>\n                    <span class=\"scrolling-flame\">\\u{1F525}</span>\n                    ${announcement.text}\n\n                `;\n                // --- END MODIFICATION ---\n                announcementContainer.appendChild(announcementEl);\n                const containerWidth = announcementContainer.offsetWidth;\n                // --- START MODIFICATION ---\n                // Need a slight delay for image loading and accurate width calculation\n                requestAnimationFrame(()=>{\n                    requestAnimationFrame(()=>{\n                        const textWidth = announcementEl.offsetWidth;\n                        const scrollDistance = containerWidth + textWidth;\n                        const scrollSpeed = 100; // pixels per second\n                        const duration = scrollDistance / scrollSpeed;\n                        // Set animation duration for the ball spin\n                        announcementEl.querySelectorAll('.scrolling-ball > span').forEach((innerSpan)=>{\n                            innerSpan.style.animationDuration = '1s';\n                        });\n                        announcementEl.style.transform = `translateX(${containerWidth}px)`;\n                        announcementEl.classList.add('is-visible');\n                        announcementEl.getBoundingClientRect(); // Force browser repaint\n                        announcementEl.style.transition = `transform ${duration}s linear`;\n                        announcementEl.style.transform = `translateX(-${textWidth}px)`;\n                        announcementEl.addEventListener('transitionend', ()=>{\n                            announcementEl.remove();\n                            clock.style.opacity = 1; // Fade in clock\n                            currentIndex = (currentIndex + 1) % state.announcements.length;\n                            // Schedule the NEXT cycle after the 10-second pause\n                            window.headerAnimationInterval = setTimeout(cycleAnimation, 10000);\n                        }, {\n                            once: true\n                        });\n                    });\n                });\n            }, 500); // Wait for clock fade-out\n        };\n        // Start the first cycle after a brief delay\n        window.headerAnimationInterval = setTimeout(cycleAnimation, 1000);\n    }\n    function startCustomTtsScheduler() {\n        // THIS IS THE FIX: Use the value from the state\n        const ANNOUNCEMENT_CYCLE_MS = state.customAnnouncementState.ttsIntervalMins * 60000;\n        const ANNOUNCEMENT_INTERVAL_MS = 300000;\n        if (state.customAnnouncementState.scheduler) clearInterval(state.customAnnouncementState.scheduler);\n        const ttsAnnouncements = state.announcements.filter((a)=>a.tts);\n        if (ttsAnnouncements.length === 0) return;\n        const scheduleNextAnnouncement = ()=>{\n            const mainAlertRemaining = alertScheduleTime > 0 ? alertScheduleTime - Date.now() : ANNOUNCEMENT_CYCLE_MS;\n            const midwayPoint = mainAlertRemaining / 2;\n            state.customAnnouncementState.nextAnnouncementTime = Date.now() + midwayPoint;\n        };\n        const runScheduler = ()=>{\n            const now = Date.now();\n            const isGamePending = state.courts.some((c)=>c.status === 'game_pending');\n            if (isGamePending || state.customAnnouncementState.isPaused) return;\n            if (now >= state.customAnnouncementState.nextAnnouncementTime) {\n                const announcement = ttsAnnouncements[state.customAnnouncementState.currentIndex];\n                if (announcement) playCustomTTS(announcement.text);\n                state.customAnnouncementState.currentIndex = (state.customAnnouncementState.currentIndex + 1) % ttsAnnouncements.length;\n                const nextDelay = state.customAnnouncementState.currentIndex === 0 ? ANNOUNCEMENT_CYCLE_MS : ANNOUNCEMENT_INTERVAL_MS;\n                state.customAnnouncementState.nextAnnouncementTime = now + nextDelay;\n            }\n        };\n        scheduleNextAnnouncement();\n        state.customAnnouncementState.scheduler = setInterval(runScheduler, 5000);\n    }\n    // --- EVENT LISTENERS FOR ANNOUNCEMENTS ---\n    customAnnouncementBtn.addEventListener('click', showAnnouncementsModal);\n    announcementSaveBtn.addEventListener('click', handleAnnouncementsSave);\n    announcementCancelBtn.addEventListener('click', ()=>{\n        customAnnouncementModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    announcementList.addEventListener('click', (e)=>{\n        // Check if the add button was clicked\n        if (e.target.classList.contains('add-announcement-btn')) {\n            // --- ADD LOGIC ---\n            const parentLi = e.target.closest('li');\n            if (parentLi) e.target.remove(); // Remove the '+' from the current last item\n            // Create a new, empty list item with the plus button\n            const newLi = document.createElement('li');\n            const newUniqueId = `tts-${Date.now()}-${Math.random()}`;\n            newLi.innerHTML = `\n                <input type=\"text\" value=\"\" placeholder=\"Enter announcement text...\">\n                <label for=\"${newUniqueId}\" class=\"tts-checkbox-label\">\n                    <input type=\"checkbox\" id=\"${newUniqueId}\"> TTS\n                </label>\n                <span class=\"add-announcement-btn\" title=\"Add another message\">+</span>\n                <span class=\"action-icon remove\" title=\"Remove message\">&times;</span>\n            `;\n            announcementList.appendChild(newLi); // Append the new item\n        } else if (e.target.classList.contains('remove')) {\n            // --- REMOVE LOGIC ---\n            const liToRemove = e.target.closest('li');\n            if (liToRemove) liToRemove.remove();\n            // If it was the last item, we need to ensure the new last item gets a plus button.\n            // The easiest way is to re-render the list from the current state of the inputs.\n            const currentAnnouncements = [];\n            announcementList.querySelectorAll('li').forEach((li)=>{\n                const textInput = li.querySelector('input[type=\"text\"]');\n                const ttsCheckbox = li.querySelector('input[type=\"checkbox\"]');\n                currentAnnouncements.push({\n                    text: textInput.value,\n                    tts: ttsCheckbox.checked\n                });\n            });\n            state.announcements = currentAnnouncements;\n            showAnnouncementsModal();\n        }\n    });\n    function render() {\n        autoAssignCourtModes();\n        const gameModeContainer = document.getElementById('game-mode-container');\n        const availablePlayersSectionEl = document.getElementById('availablePlayersSection');\n        if (gameModeContainer && availablePlayersSectionEl) {\n            const showSelector = state.courtSettings.showGameModeSelector;\n            gameModeContainer.style.display = showSelector ? 'block' : 'none';\n            availablePlayersSectionEl.classList.toggle('mode-selector-hidden', !showSelector);\n        }\n        const { gameMode, players: selectedPlayerNames, courtId: selectedCourtId } = state.selection;\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\n        const playerStats = calculatePlayerPlaytime();\n        const starPlayers = calculateStarPlayers();\n        const winningStreaks = calculateWinningStreaks();\n        const heartbreakerName = calculateHeartbreaker(); // <-- ADD THIS LINE\n        autoAssignMatchMode();\n        runAutoMinimizeLogic();\n        availablePlayersList.innerHTML = \"\";\n        let sliceStart = 0;\n        let selectorPlayer = state.availablePlayers[0];\n        if (selectorPlayer && selectorPlayer.isPaused) {\n            const firstUnpausedIndex = state.availablePlayers.findIndex((p)=>!p.isPaused);\n            if (firstUnpausedIndex !== -1) {\n                sliceStart = firstUnpausedIndex;\n                selectorPlayer = state.availablePlayers[firstUnpausedIndex];\n            } else selectorPlayer = null;\n        }\n        const renderQueue = state.availablePlayers;\n        if (renderQueue.length === 0 && selectedPlayerNames.length === 0) {\n            const li = document.createElement(\"li\");\n            li.className = \"waiting-message\";\n            li.textContent = totalPlayersAtClub() > 0 ? \"All players are on court.\" : \"Waiting For Players To Check In...\";\n            availablePlayersList.appendChild(li);\n        } else {\n            let isSpecialCase = false;\n            let specialHighlightIndex = -1;\n            let nextPlayerSliceEnd = renderQueue.length;\n            const selectableGroupBaseSize = 7;\n            if (selectorPlayer && renderQueue.length - sliceStart - 1 >= selectableGroupBaseSize) {\n                const selectorGender = selectorPlayer.gender;\n                const playersAfterSelector = renderQueue.slice(sliceStart + 1);\n                const availableInSelectableRange = playersAfterSelector.filter((p)=>!p.isPaused).slice(0, selectableGroupBaseSize);\n                if (availableInSelectableRange.length > 0) {\n                    const sameGenderCountInRange = availableInSelectableRange.filter((p)=>p.gender === selectorGender).length;\n                    const lastPlayerInRange = availableInSelectableRange[availableInSelectableRange.length - 1];\n                    const endOfRangeIndex = renderQueue.findIndex((p)=>p.name === lastPlayerInRange.name);\n                    if (sameGenderCountInRange === 0) {\n                        isSpecialCase = true;\n                        nextPlayerSliceEnd = endOfRangeIndex;\n                        const searchPool = renderQueue.slice(endOfRangeIndex);\n                        const foundPlayerIndexInPool = searchPool.findIndex((p)=>p.gender === selectorGender && !p.isPaused);\n                        if (foundPlayerIndexInPool !== -1) specialHighlightIndex = endOfRangeIndex + foundPlayerIndexInPool;\n                        else {\n                            isSpecialCase = false;\n                            nextPlayerSliceEnd = endOfRangeIndex + 1;\n                        }\n                    } else {\n                        isSpecialCase = false;\n                        specialHighlightIndex = -1;\n                        nextPlayerSliceEnd = endOfRangeIndex + 1;\n                    }\n                }\n            }\n            if (renderQueue.length > 0) {\n                const playersBeforeSelector = renderQueue.slice(0, sliceStart);\n                playersBeforeSelector.forEach((player, index)=>{\n                    // MODIFIED THIS LINE\n                    const li = createPlayerListItem(player, index, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, false);\n                    availablePlayersList.appendChild(li);\n                });\n                if (selectorPlayer) {\n                    const selectorIndex = sliceStart;\n                    // MODIFIED THIS LINE\n                    const liSelector = createPlayerListItem(selectorPlayer, selectorIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, true, false);\n                    availablePlayersList.appendChild(liSelector);\n                }\n                const orangeGroupPlayers = renderQueue.slice(sliceStart + 1, nextPlayerSliceEnd);\n                if (orangeGroupPlayers.length > 0) {\n                    const groupDiv = document.createElement('div');\n                    groupDiv.className = 'next-players-group';\n                    orangeGroupPlayers.forEach((player, index)=>{\n                        const playerIndex = sliceStart + 1 + index;\n                        // MODIFIED THIS LINE\n                        const playerLi = createPlayerListItem(player, playerIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, true);\n                        groupDiv.appendChild(playerLi);\n                    });\n                    availablePlayersList.appendChild(groupDiv);\n                }\n                const playersAfterOrangeGroup = renderQueue.slice(nextPlayerSliceEnd);\n                playersAfterOrangeGroup.forEach((player, index)=>{\n                    const playerIndex = nextPlayerSliceEnd + index;\n                    // MODIFIED THIS LINE\n                    const playerLi = createPlayerListItem(player, playerIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, false);\n                    if (playerIndex === specialHighlightIndex) {\n                        const groupDiv = document.createElement('div');\n                        groupDiv.className = 'next-players-group';\n                        groupDiv.appendChild(playerLi);\n                        availablePlayersList.appendChild(groupDiv);\n                    } else availablePlayersList.appendChild(playerLi);\n                });\n            }\n        }\n        if (renderQueue.length > 0 && renderQueue.length < 4) {\n            const li = document.createElement(\"li\");\n            li.textContent = \"Waiting For More Players...\";\n            li.className = \"waiting-message\";\n            availablePlayersList.appendChild(li);\n        }\n        const playersToggleIcon = document.querySelector('#players-toggle-btn i');\n        if (playersToggleIcon) {\n            const isExpanded = state.mobileControls.isPlayersExpanded;\n            playersToggleIcon.className = `mdi ${isExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down'}`;\n        }\n        availablePlayersSection.classList.toggle('is-collapsed', !state.mobileControls.isPlayersExpanded);\n        courtGrid.innerHTML = \"\";\n        courtGrid.insertAdjacentHTML('afterbegin', createSummaryCard());\n        alertStatusDisplay = document.getElementById('alert-status-display');\n        state.courts.filter((court)=>state.courtSettings.visibleCourts.includes(court.id)).forEach((court)=>{\n            const card = createCourtCard(court);\n            courtGrid.appendChild(card);\n        });\n        // ← ADD THIS LINE:\n        setupCourtLightLongPress();\n        // ================================\n        // STEP 16: ATTACH DRAG & DROP EVENT LISTENERS\n        // ================================\n        // Attach drag & drop listeners to player spots on courts\n        document.querySelectorAll('.player-spot[draggable=\"true\"]').forEach((spot)=>{\n            spot.addEventListener('dragstart', handlePlayerDragStart);\n            spot.addEventListener('dragend', handlePlayerDragEnd);\n            spot.addEventListener('dragover', handlePlayerDragOver);\n            spot.addEventListener('dragleave', handlePlayerDragLeave);\n            spot.addEventListener('drop', handlePlayerDrop);\n            spot.addEventListener('dblclick', handlePlayerDoubleClick); // Add double-click handler\n        });\n        // Attach drag listeners to available players list for substitution drops\n        const availablePlayersListEl = document.getElementById('availablePlayersList');\n        if (availablePlayersListEl) {\n            // Remove old listeners to prevent duplicates (if any)\n            availablePlayersListEl.removeEventListener('dragover', handlePlayerDragOver);\n            availablePlayersListEl.removeEventListener('dragleave', handlePlayerDragLeave);\n            availablePlayersListEl.removeEventListener('drop', handlePlayerDrop);\n            // Add new listeners\n            availablePlayersListEl.addEventListener('dragover', handlePlayerDragOver);\n            availablePlayersListEl.addEventListener('dragleave', handlePlayerDragLeave);\n            availablePlayersListEl.addEventListener('drop', handlePlayerDrop);\n        }\n        // ================================\n        // END STEP 16\n        // ================================\n        const courtInSetup = state.courts.find((c)=>c.status === \"selecting_teams\" || c.status === \"game_pending\");\n        const firstAvailablePlayer = selectorPlayer ? selectorPlayer.name : null;\n        const remainingToSelect = requiredPlayers - selectedPlayerNames.length;\n        const allCourtsBusy = state.courts.filter((c)=>state.courtSettings.visibleCourts.includes(c.id)).every((c)=>c.status !== \"available\");\n        infoBar.classList.remove(\"blue-theme\", \"green-theme\", \"yellow-theme\", \"red-theme\", \"hidden\");\n        if (courtInSetup) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"yellow-theme\");\n            infoBarText.textContent = `Court ${courtInSetup.id}: Choose how to form teams on the court card.`;\n        } else if (renderQueue.length === 0 && totalPlayersAtClub() > 0) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"blue-theme\");\n            infoBarText.textContent = \"All Players are on Court...\";\n        } else if (selectedPlayerNames.length === 0 && totalPlayersAtClub() < 2) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"red-theme\");\n            infoBarText.textContent = \"Waiting For Players To Check In...\";\n        } else if (selectedPlayerNames.length === 0 && allCourtsBusy) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"red-theme\");\n            infoBarText.textContent = \"Please wait for a court to become available.\";\n        } else if (selectedPlayerNames.length === 0 && firstAvailablePlayer) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"green-theme\");\n            infoBarText.textContent = `${firstAvailablePlayer.split(' ')[0]}, please select players for a game.`;\n        } else if (selectedPlayerNames.length > 0 && selectedPlayerNames.length < requiredPlayers) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"green-theme\");\n            infoBarText.textContent = `Please select ${remainingToSelect} more player(s).`;\n        } else if (selectedPlayerNames.length === requiredPlayers && !selectedCourtId) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"green-theme\");\n            infoBarText.textContent = \"Please select an available court.\";\n        } else if (selectedPlayerNames.length === requiredPlayers && selectedCourtId) {\n            infoBar.classList.remove(\"hidden\");\n            infoBar.classList.add(\"yellow-theme\");\n            infoBarText.textContent = `Court ${selectedCourtId} selected. Confirm on the court card below.`;\n        } else infoBar.classList.add(\"hidden\");\n        modeDoublesBtn.classList.toggle(\"active\", gameMode === \"doubles\");\n        modeSinglesBtn.classList.toggle(\"active\", gameMode === \"singles\");\n        modeDoublesBtn.disabled = renderQueue.length < 4;\n        availablePlayersSection.classList.toggle(\"locked\", !!courtInSetup || selectedPlayerNames.length === 0 && allCourtsBusy);\n        updateTimers();\n        initSummaryCardElements();\n        setTimeout(setPlayerListHeight, 0);\n        requestAnimationFrame(setActiveCardForMobileScroll);\n    }\n    // NEW FUNCTION: Resets collapse state when screen is wide (desktop/tablet)\n    function resetCollapseOnResize() {\n        // Breakpoint for switching from stacked to two-column layout\n        const DESKTOP_BREAKPOINT = 900;\n        // We only need to reset the state if the window is wider than the mobile/stacked breakpoint\n        if (window.innerWidth > DESKTOP_BREAKPOINT) {\n            let stateChanged = false;\n            if (!state.mobileControls.isSummaryExpanded) {\n                state.mobileControls.isSummaryExpanded = true;\n                stateChanged = true;\n            }\n            if (!state.mobileControls.isPlayersExpanded) {\n                state.mobileControls.isPlayersExpanded = true;\n                stateChanged = true;\n            }\n            state.courts.forEach((court)=>{\n                if (court.isCollapsed) {\n                    court.isCollapsed = false;\n                    stateChanged = true;\n                }\n            });\n            if (stateChanged) {\n                // Save the state immediately and re-render the UI\n                saveState();\n                render();\n            }\n        }\n    }\n    // UTILITY: Finds the ID of the first available and visible court based on hierarchy\n    function findNextAvailableCourtId() {\n        for (const id of COURT_HIERARCHY){\n            const court = state.courts.find((c)=>c.id === id);\n            // Check if court exists, is visible, and is available\n            if (court && state.courtSettings.visibleCourts.includes(id) && court.status === 'available') return id;\n        }\n        return null;\n    }\n    // REPLACE this function\n    function handleModeOptionsClick(courtId1) {\n        // If an admin session is already active, just perform the action.\n        if (adminSessionActive) {\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (court) {\n                court.isModeOverlayActive = !court.isModeOverlayActive;\n                if (court.isModeOverlayActive) state.courts.forEach((c)=>{\n                    if (c.id !== courtId1) c.isModeOverlayActive = false;\n                });\n                render();\n                saveState();\n            }\n            return;\n        }\n        // Otherwise, store the action and show the dedicated court mode keypad.\n        courtModeAction = ()=>{\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (court) {\n                court.isModeOverlayActive = !court.isModeOverlayActive;\n                if (court.isModeOverlayActive) state.courts.forEach((c)=>{\n                    if (c.id !== courtId1) c.isModeOverlayActive = false;\n                });\n                render();\n                saveState();\n            }\n        };\n        showCourtModeKeypad();\n    }\n    function handleMatchModeChange(e) {\n        const newMode = e.target.value;\n        state.matchSettings.matchMode = newMode;\n        saveState();\n        // Toggle visibility of the Fast Play Games selector in the admin modal\n        const fastPlaySelector = document.querySelector('.fast-play-games-selector');\n        if (fastPlaySelector) fastPlaySelector.style.display = newMode === 'fast' ? '' : 'none';\n        render(); // <-- ADD THIS LINE to refresh the UI\n    }\n    function handleFastPlayGamesChange(e) {\n        state.matchSettings.fastPlayGames = parseInt(e.target.value, 10);\n        saveState();\n        render(); // <-- ADD THIS LINE\n    }\n    // NEW FUNCTION: Sets the court mode and closes the mode overlay\n    function handleSetCourtMode(courtId1, newMode) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (court) {\n            court.courtMode = newMode;\n            court.isModeOverlayActive = false; // Always close the overlay after selection\n            // Preserve the existing player selection and re-render the court grid.\n            render();\n            saveState();\n            // CRITICAL FIX: After the render cycle, use requestAnimationFrame\n            // to guarantee that the animation is restored to all now-selectable courts.\n            requestAnimationFrame(ensureCourtSelectionAnimation);\n        }\n    }\n    function handleCourtGridClick(e) {\n        const courtCard = e.target.closest(\".court-card\");\n        if (!courtCard) return;\n        // Find the closest element with a data-action, not just the direct click target.\n        const actionTarget = e.target.closest('[data-action]');\n        const action = actionTarget ? actionTarget.dataset.action : null;\n        const courtId1 = courtCard.dataset.courtId;\n        const teamsNotSet = e.target.closest(\".teams-not-set\");\n        if (teamsNotSet) // Ignore click if it's the non-clickable 'Reserved For X' text\n        {\n            if (teamsNotSet.style.cursor !== 'default') {\n                handleChooseTeams(courtId1);\n                return;\n            }\n        }\n        if (action === 'more-options') {\n            handleModeOptionsClick(courtId1);\n            return;\n        }\n        if (action === 'set-court-mode') {\n            handleSetCourtMode(courtId1, actionTarget.dataset.mode);\n            return;\n        }\n        if (action === 'edit-game') {\n            showManageCourtPlayersModal(courtId1);\n            return;\n        }\n        if (action === 'toggle-light') {\n            handleLightToggleChange(e);\n            return;\n        }\n        if (action === 'randomize-teams') {\n            handleRandomizeTeams(courtId1);\n            return;\n        }\n        if (action === 'choose-later') {\n            handleChooseLater(courtId1);\n            return;\n        }\n        if (action === 'choose-teams') {\n            // --- THIS IS THE FIX ---\n            const court = state.courts.find((c)=>c.id === courtId1);\n            // If the game is already in progress, pass a special context.\n            if (court && court.status === 'in_progress') handleChooseTeams(courtId1, 'in_progress');\n            else handleChooseTeams(courtId1);\n            // --- END OF FIX ---\n            return;\n        }\n        if (action === 'cancel-game-setup') {\n            handleCancelGame(courtId1);\n            return;\n        }\n        if (action === 'start-game') {\n            handleStartGame(courtId1);\n            return;\n        }\n        if (action === 'end-game') {\n            const button = e.target.closest('.end-game-ball');\n            if (button) {\n                button.classList.remove('animate-in');\n                button.classList.add('hide-anim');\n                setTimeout(()=>{\n                    handleEndGame(courtId1);\n                }, 1500);\n            } else handleEndGame(courtId1);\n            return;\n        }\n        if (action === 'select-court-action') {\n            const clickedButton = e.target.closest('.court-confirm-btn');\n            if (!clickedButton) return;\n            // 🔴 EXCLUSION LOGIC: Block selection if the court is only marked as reserved\n            if (clickedButton.dataset.reservedOnly === 'true') {\n                playCustomTTS(\"This court is reserved for a different type of match.\");\n                return;\n            }\n            const allSelectableButtons = document.querySelectorAll('.court-card.selectable .court-confirm-btn.select-court');\n            clickedButton.classList.remove('serve-in');\n            clickedButton.classList.add('hide-anim');\n            let delay = 0;\n            allSelectableButtons.forEach((button)=>{\n                if (button !== clickedButton) {\n                    setTimeout(()=>{\n                        button.classList.remove('serve-in');\n                        button.classList.add('serve-out');\n                    }, delay);\n                    delay += 200;\n                }\n            });\n            setTimeout(()=>{\n                const { players: selectedPlayerNames, gameMode } = state.selection;\n                const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\n                if (selectedPlayerNames.length !== requiredPlayers || !courtId1) return;\n                // NEW: Check if on-duty member is in the selection BEFORE setting up the court\n                if (checkOnDutyMemberInSelection(selectedPlayerNames)) {\n                    showTempDutyHandoverModal(()=>{\n                        // This callback continues the game setup after duty handover\n                        proceedWithCourtSelection(selectedPlayerNames, courtId1, gameMode);\n                    });\n                    return;\n                }\n                // If on-duty member is not selected, proceed normally\n                proceedWithCourtSelection(selectedPlayerNames, courtId1, gameMode);\n            }, 2000);\n            return;\n        }\n    }\n    // NEW FUNCTION: Extracted court selection logic\n    function proceedWithCourtSelection(selectedPlayerNames, courtId1, gameMode) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        // --- THIS IS THE FIX ---\n        // The snapshot is now taken BEFORE any players are removed from the available list.\n        court.queueSnapshot = JSON.parse(JSON.stringify(state.availablePlayers));\n        // --- END OF FIX ---\n        // If a suggestion is active, use its teams and bypass player selection\n        if (state.activeSuggestion) {\n            court.players = [\n                ...state.activeSuggestion.team1,\n                ...state.activeSuggestion.team2\n            ];\n            court.teams.team1 = state.activeSuggestion.team1;\n            court.teams.team2 = state.activeSuggestion.team2;\n            court.teamsSet = true;\n            court.gameMode = 'doubles'; // Suggestion is always for doubles\n            state.availablePlayers = state.availablePlayers.filter((p)=>!court.players.some((p2)=>p2.name === p.name));\n            clearSuggestionHighlights(); // Clear highlights and stored suggestion\n        } else {\n            const selectedPlayerObjects = selectedPlayerNames.map((name)=>getPlayerByName(name));\n            court.players = [\n                ...selectedPlayerObjects\n            ];\n            court.gameMode = gameMode;\n            if (gameMode === 'doubles') {\n                court.status = \"selecting_teams\";\n                court.teams.team1 = [];\n                court.teams.team2 = [];\n            } else {\n                court.teams.team1 = [\n                    selectedPlayerObjects[0]\n                ];\n                court.teams.team2 = [\n                    selectedPlayerObjects[1]\n                ];\n            }\n            state.availablePlayers = state.availablePlayers.filter((p)=>!selectedPlayerNames.includes(p.name));\n        }\n        // The rest of the original function remains the same\n        court.status = court.status === \"selecting_teams\" ? \"selecting_teams\" : \"game_pending\";\n        if (court.status === \"game_pending\") {\n            court.autoStartTimeTarget = Date.now() + 60000;\n            court.autoStartTimer = setTimeout(()=>handleStartGame(courtId1), 60000);\n        }\n        // --- ADD THIS BLOCK ---\n        // Clear the stored suggestion outcome for the next turn\n        state.currentSuggestionOutcome = null;\n        state.currentSuggestionType = null;\n        // --- END ADD ---\n        state.selection = {\n            gameMode: state.selection.gameMode,\n            players: [],\n            courtId: null\n        };\n        updateGameModeBasedOnPlayerCount();\n        enforceDutyPosition();\n        render();\n        saveState();\n    }\n    function formatDuration(ms) {\n        if (ms === 0) return \"00h00m\";\n        const totalMinutes = Math.floor(ms / 60000);\n        const hours = Math.floor(totalMinutes / 60);\n        const minutes = totalMinutes % 60;\n        return `${String(hours).padStart(2, \"0\")}h${String(minutes).padStart(2, \"0\")}m`;\n    }\n    function calculatePlayerStats(gamesToProcess) {\n        const stats = {};\n        gamesToProcess.forEach((game)=>{\n            const allPlayersInGame = [\n                ...game.teams.team1,\n                ...game.teams.team2\n            ];\n            // Find the player objects to check their leaderboard preference\n            const allPlayerObjects = allPlayersInGame.map((name)=>getPlayerByName(name));\n            // If ANY player in the game has opted out, the game does not count for anyone's stats\n            if (allPlayerObjects.some((p)=>p.onLeaderboard === false)) return; // Skip this game\n            const allPlayers = [\n                ...game.teams.team1,\n                ...game.teams.team2\n            ];\n            const [hStr, mStr] = game.duration.split('h').map((s)=>s.replace('m', ''));\n            const gameDuration = parseInt(hStr, 10) * 3600000 + parseInt(mStr, 10) * 60000;\n            allPlayers.forEach((player)=>{\n                stats[player] = stats[player] || {\n                    played: 0,\n                    won: 0,\n                    totalDurationMs: 0\n                };\n                stats[player].totalDurationMs += gameDuration;\n            });\n            if (game.winner !== 'skipped') {\n                const winnerTeam = game.winner === \"team1\" ? game.teams.team1 : game.teams.team2;\n                if (game.score) {\n                    const loserTeam = game.winner === \"team1\" ? game.teams.team2 : game.teams.team1;\n                    const winnerScore = game.score.team1 > game.score.team2 ? game.score.team1 : game.score.team2;\n                    const loserScore = game.score.team1 > game.score.team2 ? game.score.team2 : game.score.team1;\n                    allPlayers.forEach((player)=>{\n                        if (winnerTeam.includes(player)) {\n                            stats[player].played += winnerScore + loserScore;\n                            stats[player].won += winnerScore;\n                        } else if (loserTeam.includes(player)) {\n                            stats[player].played += winnerScore + loserScore;\n                            stats[player].won += loserScore;\n                        }\n                    });\n                } else allPlayers.forEach((player)=>{\n                    stats[player].played += 1;\n                    if (winnerTeam.includes(player)) stats[player].won += 1;\n                });\n            }\n        });\n        return stats;\n    }\n    function formatWinPercentage(played, won) {\n        return played === 0 ? \"N/A\" : `${Math.round(won / played * 100)}%`;\n    }\n    // ADD NEW FUNCTION: Pause/Resume game play click handler\n    //    function handlePauseToggleClick(e) {\n    //       const button = e.target.closest(\".pause-toggle-btn\");\n    //        // We know button exists because it was checked in handlePlayerClick\n    //        \n    //        const playerName = button.dataset.playerName;\n    //        const action = button.dataset.action; // 'pause' or 'resume'\n    //        const playerObj = state.availablePlayers.find(p => p.name === playerName);\n    //\n    //        if (!playerObj) return;\n    //\n    //       const verb = action === 'pause' ? 'pause' : 'resume';\n    //       const message = action === 'pause' \n    //            ? `Are you sure you want to pause your game play? You will remain in position #${state.availablePlayers.indexOf(playerObj) + 1} until you resume.` \n    //            : `Are you sure you want to resume your game play? You will be immediately restored to position #${state.availablePlayers.indexOf(playerObj) + 1}.`;\n    ////\n    //        cancelConfirmModal.querySelector(\"h3\").textContent = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;\n    //        cancelConfirmModal.querySelector(\"p\").textContent = message;\n    //        modalBtnYesConfirm.textContent = verb.charAt(0).toUpperCase() + verb.slice(1);\n    //        modalBtnNo.textContent = \"Close\";\n    //        \n    //       cancelConfirmModal.dataset.mode = \"pauseToggle\";\n    //        cancelConfirmModal.dataset.player = playerName;\n    //        cancelConfirmModal.dataset.verb = action;\n    //\n    //        cancelConfirmModal.classList.remove(\"hidden\");\n    //    }\n    // ADD NEW FUNCTION: Pause/Resume game play click handler (IMMEDIATE ACTION)\n    //    function handlePauseToggleClick(e) {\n    //        const button = e.target.closest(\".pause-toggle-btn\");\n    //        if (!button) return;\n    //        \n    //        const playerName = button.dataset.playerName;\n    //        const action = button.dataset.action;\n    //        const playerObj = state.availablePlayers.find(p => p.name === playerName);\n    //\n    //        if (playerObj) {\n    //            // IMMEDIATE ACTION: Toggle the paused state\n    //            playerObj.isPaused = (action === 'pause');\n    //            \n    //            // Re-run necessary updates\n    //            updateGameModeBasedOnPlayerCount();\n    //            enforceDutyPosition();\n    //            render();\n    //            saveState();\n    //            checkAndPlayAlert(false);\n    //        }\n    //    }\n    function handleSort(key) {\n        if (state.statsFilter.sortKey === key) state.statsFilter.sortOrder = state.statsFilter.sortOrder === 'asc' ? 'desc' : 'asc';\n        else {\n            state.statsFilter.sortKey = key;\n            state.statsFilter.sortOrder = key === 'name' ? 'asc' : 'desc';\n        }\n        renderHistory();\n        saveState();\n    }\n    function renderHistory() {\n        const historyListEl = document.getElementById('history-list');\n        const teamHistoryListEl = document.getElementById('team-history-list');\n        const historyTitle = document.querySelector(\"#history-page h3\");\n        const historyToggleViewBtn = document.getElementById('history-toggle-view');\n        const historyToggleTeamsBtn = document.getElementById('history-toggle-teams-btn');\n        // Hide all lists initially\n        historyListEl.style.display = 'none';\n        teamHistoryListEl.style.display = 'none';\n        setActiveMobileMenuItem('mobile-history-btn');\n        if (state.historyViewMode === \"stats\") {\n            historyTitle.textContent = \"Player Stats\";\n            historyToggleViewBtn.textContent = \"Game History\";\n            historyToggleTeamsBtn.textContent = \"Team Stats\";\n            historyListEl.style.display = ''; // Show the player stats/game history list\n            renderPlayerHistory(); // A new function for just the player stats part\n        } else if (state.historyViewMode === \"teams\") {\n            historyTitle.textContent = \"Team Stats\";\n            historyToggleViewBtn.textContent = \"Player Stats\";\n            historyToggleTeamsBtn.textContent = \"Game History\";\n            teamHistoryListEl.style.display = '';\n            state.statsFilter.teamGender = 'all'; // <-- ADD THIS LINE\n            renderTeamHistory();\n        } else {\n            historyTitle.textContent = \"Game History\";\n            historyToggleViewBtn.textContent = \"Player Stats\";\n            historyToggleTeamsBtn.textContent = \"Team Stats\";\n            historyListEl.style.display = ''; // Show the player stats/game history list\n            renderGameHistory(); // A new function for just the game history part\n        }\n    }\n    function renderPlayerHistory() {\n        const stats = calculatePlayerStats(state.gameHistory);\n        const allKnownPlayers = getAllKnownPlayers();\n        const historyListEl = document.getElementById('history-list');\n        historyListEl.innerHTML = \"\";\n        let playersWithStats = Object.keys(stats).filter((name)=>{\n            const playerObj = allKnownPlayers.find((p)=>p.name === name);\n            if (!playerObj || playerObj.onLeaderboard === false) return false;\n            if (state.statsFilter.gender === 'all') return true;\n            return playerObj.gender === state.statsFilter.gender;\n        });\n        // --- H2H FILTERING LOGIC ---\n        if (state.comparison.active && state.comparison.items.length === 1) {\n            const selectedPlayer = state.comparison.items[0];\n            // Filter the list to only include the selected player and their opponents\n            playersWithStats = playersWithStats.filter((name)=>name === selectedPlayer || state.comparison.opponents.has(name));\n        }\n        // --- END H2H FILTERING ---\n        playersWithStats.sort((a, b)=>{\n            const statA = stats[a];\n            const statB = stats[b];\n            let compareValue = 0;\n            if (state.statsFilter.sortKey === 'name') compareValue = a.localeCompare(b);\n            else compareValue = (statB[state.statsFilter.sortKey] || 0) - (statA[state.statsFilter.sortKey] || 0);\n            return state.statsFilter.sortOrder === 'asc' ? -compareValue : compareValue;\n        });\n        const genderFilterHTML = `\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\n                <div class=\"radio-group\">\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"all\" ${state.statsFilter.gender === 'all' ? 'checked' : ''}> All </label>\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"M\" ${state.statsFilter.gender === 'M' ? 'checked' : ''}> Men </label>\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"F\" ${state.statsFilter.gender === 'F' ? 'checked' : ''}> Women </label>\n                </div>\n            </div>`;\n        if (playersWithStats.length === 0) historyListEl.innerHTML = genderFilterHTML + '<p style=\"text-align: center; color: #6c757d;\">No stats available for the selected filter.</p>';\n        else {\n            const getSortIcon = (key)=>state.statsFilter.sortKey !== key ? ' ' : state.statsFilter.sortOrder === 'asc' ? \" \\uD83D\\uDD3C\" : \" \\uD83D\\uDD3D\";\n            const tableHeader = `\n                <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\n                    <div class=\"stats-grid-row\">\n                        <button class=\"sort-btn\" data-sort-key=\"name\" style=\"text-align: left; background: none; border: none; font-weight: bold; cursor: pointer;\">Player${getSortIcon('name')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"played\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Played${getSortIcon('played')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"won\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Won %${getSortIcon('won')}</button>\n                        <button class=\"sort-btn\" data-sort-key=\"totalDurationMs\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Time${getSortIcon('totalDurationMs')}</button>\n                    </div>\n                </div>`;\n            const playerRows = playersWithStats.map((name)=>{\n                const playerStats = stats[name];\n                const winPercentage = formatWinPercentage(playerStats.played, playerStats.won);\n                let rowClass = '';\n                if (state.comparison.items.includes(name)) rowClass = 'selected-for-comparison';\n                return `\n                    <div class=\"history-item ${rowClass}\" data-name=\"${name}\" data-type=\"player\">\n                        <div class=\"stats-grid-row\">\n                            <span>${name}</span>\n                            <span>${playerStats.played}</span>\n                            <span>${winPercentage}</span>\n                            <span>${formatDuration(playerStats.totalDurationMs)}</span>\n                        </div>\n                    </div>`;\n            }).join('');\n            historyListEl.innerHTML = genderFilterHTML + tableHeader + playerRows;\n        }\n        historyListEl.querySelectorAll('input[name=\"stats-gender-filter\"]').forEach((radio)=>radio.addEventListener('change', handleStatsFilterChange));\n        historyListEl.querySelectorAll('.sort-btn').forEach((btn)=>btn.addEventListener('click', handleSortClick));\n    }\n    function renderGameHistory() {\n        const historyListEl = document.getElementById('history-list');\n        historyListEl.innerHTML = \"\";\n        if (state.gameHistory.length === 0) {\n            // Include the filters even when empty\n            const emptyFilters = createGameHistoryFilters();\n            historyListEl.innerHTML = emptyFilters + '<p style=\"text-align: center; color: #6c757d;\">No games have been completed yet.</p>';\n            // Re-attach listeners even to the empty version\n            attachGameHistoryFilterListeners();\n            return;\n        }\n        // --- FILTERING LOGIC ---\n        const filteredByTime = state.gameHistory.filter((game)=>isGameInTimeFrame(game, state.gameHistoryFilter.timeFrame));\n        const filteredHistory = filteredByTime.filter((game)=>{\n            if (state.gameHistoryFilter.gameType === 'all') return true;\n            return game.teams.team1.length === (state.gameHistoryFilter.gameType === 'doubles' ? 2 : 1);\n        });\n        // --- Sorting Logic ---\n        const sortedHistory = [\n            ...filteredHistory\n        ].sort((a, b)=>{\n            // ... (existing sorting logic remains here) ...\n            const { key, order } = state.historySort;\n            let valA, valB;\n            if (key === 'score') {\n                // If score is null (skipped game), treat as 0 for sorting purposes\n                valA = a.score ? Math.max(a.score.team1, a.score.team2) : 0;\n                valB = b.score ? Math.max(b.score.team1, b.score.team2) : 0;\n            } else if (key === 'court') {\n                // Sorting by court (A, B, C...)\n                valA = a.court || '';\n                valB = b.court || '';\n            } else {\n                // Default to sorting by endTime if other key is not found or is 'endTime'\n                valA = a.endTime || 0;\n                valB = b.endTime || 0;\n            }\n            // For 'score' and 'endTime', default order is usually desc. For 'court' it is asc.\n            const defaultOrder = key === 'score' || key === 'endTime' ? 'desc' : 'asc';\n            const finalOrder = order || defaultOrder;\n            if (valA < valB) return finalOrder === 'asc' ? -1 : 1;\n            if (valA > valB) return finalOrder === 'asc' ? 1 : -1;\n            return 0;\n        });\n        // --- HEADER GENERATION ---\n        const getSortIcon = (key)=>state.historySort.key !== key ? ' ' : state.historySort.order === 'asc' ? \" \\uD83D\\uDD3C\" : \" \\uD83D\\uDD3D\";\n        const headerHTML = `\n            <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\n                <div class=\"game-history-grid\">\n                    <button class=\"sort-btn game-time-cell\" data-sort-key=\"endTime\">${'Time'}${getSortIcon('endTime')}</button>\n                    <button class=\"sort-btn game-duration-cell\" data-sort-key=\"court\">Game Info${getSortIcon('court')}</button>\n                    <div class=\"teams-header game-teams-cell\">Teams</div>\n                    <button class=\"sort-btn game-score-cell\" data-sort-key=\"score\">${'Score'}${getSortIcon('score')}</button>\n                </div>\n            </div>\n        `;\n        // --- GAME ROWS GENERATION (Existing Logic) ---\n        const gamesHTML = sortedHistory.map((game)=>{\n            // ... (existing game row rendering logic) ...\n            const gameDate = new Date(game.endTime);\n            const time = gameDate.toLocaleTimeString([], {\n                hour: '2-digit',\n                minute: '2-digit',\n                hourCycle: 'h23'\n            });\n            const date = gameDate.toLocaleDateString('en-GB', {\n                day: '2-digit',\n                month: '2-digit',\n                year: '2-digit'\n            });\n            const isResultSkipped = game.winner === 'skipped';\n            let team1Class = isResultSkipped ? '' : game.winner === \"team1\" ? 'winner' : 'loser';\n            let team2Class = isResultSkipped ? '' : game.winner === \"team1\" ? 'loser' : 'winner';\n            const team1HTML = game.teams.team1.map((player)=>`<p class=\"${team1Class}\">${player}</p>`).join('');\n            const team2HTML = game.teams.team2.map((player)=>`<p class=\"${team2Class}\">${player}</p>`).join('');\n            let scoreDisplayHTML;\n            if (isResultSkipped) scoreDisplayHTML = '<p>Skipped</p>';\n            else if (!game.score) scoreDisplayHTML = 'N/A';\n            else {\n                const winningScore = game.winner === 'team1' ? game.score.team1 : game.score.team2;\n                const losingScore = game.winner === 'team1' ? game.score.team2 : game.score.team1;\n                scoreDisplayHTML = `<p><span class=\"winner\">${winningScore}</span> - <span class=\"loser\">${losingScore}</span></p>`;\n                if (game.score.tiebreak1 !== null && game.score.tiebreak2 !== null) {\n                    const winnerTiebreak = game.winner === 'team1' ? game.score.tiebreak1 : game.score.tiebreak2;\n                    const loserTiebreak = game.winner === 'team1' ? game.score.tiebreak2 : game.score.tiebreak1;\n                    const tiebreakHTML = `(<span class=\"winner\">${winnerTiebreak}</span> - <span class=\"loser\">${loserTiebreak}</span>)`;\n                    scoreDisplayHTML += `<p style=\"font-size: 0.9em; color: var(--neutral-color);\">${tiebreakHTML}</p>`;\n                }\n            }\n            const courtDisplay = game.court === 'Manual' ? `${game.teams.team1.length === 2 ? 'Doubles' : 'Singles'}` : `Court ${game.court}`;\n            // MODIFIED DURATION CELL\n            return `\n                <div class=\"history-item\" data-game-id=\"${game.id}\"> \n                    <div class=\"game-history-grid\">\n                        <div class=\"game-time-cell\" style=\"display: flex; flex-direction: column; line-height: 1.2;\">\n                            <span>${time}</span>\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${date}</span>\n                        </div>\n                        <div class=\"game-duration-cell\" style=\"display: flex; flex-direction: column; line-height: 1.2;\">\n                            <span>${courtDisplay}</span>\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${game.duration}</span>\n                        </div>\n                        <div class=\"game-teams-cell\">\n                            ${team1HTML}\n                            ${team2HTML}\n                        </div>\n                        <div class=\"game-score-cell\">\n                            ${scoreDisplayHTML}\n                        </div>\n                    </div>\n                </div>\n            `;\n        }).join('');\n        // --- ASSEMBLE FINAL HTML ---\n        historyListEl.innerHTML = createGameHistoryFilters() + headerHTML + gamesHTML;\n        // --- RE-ATTACH LISTENERS ---\n        historyListEl.querySelectorAll('.sort-btn').forEach((btn)=>{\n            btn.addEventListener('click', handleHistorySortClick);\n        });\n        attachGameHistoryFilterListeners();\n    }\n    function createGameHistoryFilters() {\n        const { timeFrame, gameType } = state.gameHistoryFilter;\n        return `\n            <div class=\"game-history-filter-container\">\n                <div class=\"gender-selector\" style=\"justify-content: center;\">\n                    <div class=\"radio-group\">\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Today\" ${timeFrame === 'Today' ? 'checked' : ''}> Today </label>\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Month\" ${timeFrame === 'Month' ? 'checked' : ''}> Month </label>\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Year\" ${timeFrame === 'Year' ? 'checked' : ''}> Year </label>\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Total\" ${timeFrame === 'Total' ? 'checked' : ''}> Total </label>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n    function attachGameHistoryFilterListeners() {\n        // Time Frame Filter\n        document.querySelectorAll('input[name=\"game-time-filter\"]').forEach((radio)=>{\n            radio.removeEventListener('change', handleGameTimeFilterChange);\n            radio.addEventListener('change', handleGameTimeFilterChange);\n        });\n        // Game Type Filter\n        document.querySelectorAll('input[name=\"game-type-filter\"]').forEach((radio)=>{\n            radio.removeEventListener('change', handleGameTypeFilterChange);\n            radio.addEventListener('change', handleGameTypeFilterChange);\n        });\n    }\n    function renderReorderHistory() {\n        reorderHistoryList.innerHTML = \"\";\n        if (state.reorderHistory.length === 0) {\n            reorderHistoryList.innerHTML = '<p style=\"text-align: center; color: #6c757d; padding: 2rem;\">No queue reorder actions have been logged.</p>';\n            return;\n        }\n        // Iterate through history, newest first\n        [\n            ...state.reorderHistory\n        ].reverse().forEach((entry)=>{\n            const dateTime = new Date(entry.endTime).toLocaleString();\n            let playersHtml = '';\n            // Iterate through players involved in this session\n            for (const [name, log] of Object.entries(entry.players))// Only display players who actually moved (start position !== current position)\n            if (log.startPosition !== log.currentPosition) playersHtml += `\n                        <p style=\"margin: 0.25rem 0; font-size: 0.95rem; display: flex; justify-content: space-between;\">\n                            <span style=\"font-weight: 500;\">${name}</span>\n                            <span style=\"color: var(--primary-blue);\">Moved from #${log.startPosition + 1} to #${log.currentPosition + 1}</span>\n                        </p>\n                    `;\n            // Only render the entry if at least one player moved\n            if (playersHtml) {\n                const details = document.createElement('div');\n                details.className = 'history-item';\n                details.style.textAlign = 'left';\n                details.innerHTML = `\n                    <div class=\"history-details\" style=\"margin-bottom: 0.75rem;\">\n                        <span style=\"color: var(--primary-blue);\">${entry.adminAction} (${dateTime})</span>\n                    </div>\n                    <div style=\"padding-left: 1rem;\">\n                        ${playersHtml}\n                    </div>\n                `;\n                reorderHistoryList.appendChild(details);\n            }\n        });\n    }\n    function handleStatsFilterChange(e) {\n        state.statsFilter.gender = e.target.value;\n        saveState();\n        renderHistory();\n    }\n    function handleSortClick(e) {\n        const key = e.target.dataset.sortKey;\n        if (key) handleSort(key);\n    }\n    // Player selection and game setup functions (no alert calls here)\n    function handleCancelSelection() {\n        // This is the corrected logic. It preserves the selected players\n        // and only nullifies the court selection before re-rendering.\n        state.selection.courtId = null;\n        // Note: We do NOT clear currentSuggestionOutcome here\n        // This prevents gaming the system by cancelling court selection to get different results\n        render();\n        saveState();\n    }\n    function handleModeChange(mode) {\n        // 1. Unconditionally preserve the current selection at the start.\n        const playersToPreserve = [\n            ...state.selection.players\n        ];\n        state.selection.gameMode = mode;\n        state.selection.courtId = null;\n        const newRequiredPlayers = mode === \"doubles\" ? 4 : 2;\n        // 2. Decide whether to keep or clear the preserved players.\n        // This logic correctly handles switching from a 4-player selection to Singles.\n        if (newRequiredPlayers === 2 && playersToPreserve.length > 2) state.selection.players = [];\n        else state.selection.players = playersToPreserve;\n        // 3. Rebuild the UI.\n        render();\n        // 4. CRITICAL FIX: Schedule the animation to run after the next browser paint.\n        // This guarantees that the '.selectable' courts exist in the DOM before we try to animate them.\n        requestAnimationFrame(()=>{\n            // This second frame is a failsafe to ensure the paint has completed.\n            requestAnimationFrame(ensureCourtSelectionAnimation);\n        });\n        saveState();\n    }\n    function ensureCourtSelectionAnimation() {\n        const { players: selectedPlayerNames, gameMode } = state.selection;\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\n        if (selectedPlayerNames.length === requiredPlayers) {\n            const selectableCourts = document.querySelectorAll('.court-card.selectable .court-confirm-btn.select-court');\n            selectableCourts.forEach((button)=>{\n                // Unconditionally add the class to make the ball visible\n                button.classList.add('serve-in');\n            });\n        } else {\n            // If the selection is not complete, ensure the class is removed from all buttons.\n            const allCourts = document.querySelectorAll('.court-confirm-btn.select-court');\n            allCourts.forEach((button)=>{\n                button.classList.remove('serve-in');\n            });\n        }\n    }\n    function handlePlayerClick(e) {\n        const suggestionBtn = e.target.closest('.suggestion-btn');\n        if (suggestionBtn) {\n            // If a suggestion is already active *on the screen* (highlighted), clear it.\n            if (state.activeSuggestion) clearSuggestionHighlights();\n            else {\n                const selector = state.availablePlayers.find((p)=>!p.isPaused);\n                if (!selector) return; // No selector\n                const available = state.availablePlayers.filter((p)=>p.name !== selector.name);\n                let suggestionOutcome;\n                // Check if we already have a stored outcome for this turn\n                if (state.currentSuggestionOutcome) {\n                    console.log(\"Using stored suggestion type:\", state.currentSuggestionType);\n                    suggestionOutcome = state.currentSuggestionOutcome;\n                } else {\n                    // If not, roll the dice and store the result\n                    console.log(\"Generating new suggestion outcome...\");\n                    // This now receives the { suggestion, type } object\n                    suggestionOutcome = findMostBalancedGame(selector, available);\n                    state.currentSuggestionOutcome = suggestionOutcome; // Store the whole object\n                    state.currentSuggestionType = suggestionOutcome.type; // Store just the type\n                }\n                // Now, use the suggestion part of the outcome\n                const actualSuggestion = suggestionOutcome.suggestion; // This is { team1, team2 } or null\n                if (actualSuggestion && actualSuggestion.team1 && actualSuggestion.team2) {\n                    // Populate the main selection array\n                    state.selection.players = [\n                        ...actualSuggestion.team1.map((p)=>p.name),\n                        ...actualSuggestion.team2.map((p)=>p.name)\n                    ];\n                    state.activeSuggestion = actualSuggestion; // Store the { team1, team2 } part for highlighting\n                    render(); // Re-render the UI with the new state\n                    // Trigger the court selection animations\n                    requestAnimationFrame(()=>{\n                        requestAnimationFrame(ensureCourtSelectionAnimation);\n                    });\n                } else {\n                    console.error(\"Suggestion logic failed to return a valid suggestion.\");\n                    playCustomTTS(\"Could not find a balanced game with the current players.\");\n                }\n            }\n            return; // Stop further execution\n        }\n        const pauseButton = e.target.closest(\".pause-toggle-btn\");\n        if (pauseButton) {\n            handlePauseToggleClick(pauseButton);\n            return;\n        }\n        // If a player is clicked manually, clear any active suggestion highlights\n        if (state.activeSuggestion) clearSuggestionHighlights();\n        // Note: We do NOT clear currentSuggestionOutcome here\n        // This prevents gaming the system by clicking players to get different results\n        const li = e.target.closest(\"li\");\n        let firstAvailablePlayer = state.availablePlayers[0] ? state.availablePlayers[0].name : null;\n        if (state.availablePlayers[0] && state.availablePlayers[0].isPaused) {\n            const firstUnpaused = state.availablePlayers.find((p)=>!p.isPaused);\n            firstAvailablePlayer = firstUnpaused ? firstUnpaused.name : null;\n        }\n        if (li && li.dataset.playerName === firstAvailablePlayer) return;\n        if (!li || li.classList.contains(\"disabled\") || li.classList.contains(\"waiting-message\") || state.availablePlayers.length === 0) return;\n        const playerName = li.dataset.playerName;\n        const { players: selectedPlayerNames } = state.selection;\n        if (selectedPlayerNames.length === 0) {\n            if (playerName !== firstAvailablePlayer) selectedPlayerNames.push(firstAvailablePlayer, playerName);\n            else selectedPlayerNames.push(playerName);\n        } else {\n            if (selectedPlayerNames.includes(playerName)) {\n                selectedPlayerNames.splice(selectedPlayerNames.indexOf(playerName), 1);\n                if (selectedPlayerNames.length === 1) state.selection.players = [];\n            } else if (selectedPlayerNames.length < 4) selectedPlayerNames.push(playerName);\n        }\n        updateGameModeBasedOnSelection();\n        render();\n        saveState();\n        const requiredPlayers = state.selection.gameMode === \"doubles\" ? 4 : 2;\n        if (state.selection.players.length === requiredPlayers) {\n            scrollToFirstAvailableCourt();\n            collapsePlayerListOnMobile();\n        }\n        requestAnimationFrame(()=>{\n            requestAnimationFrame(ensureCourtSelectionAnimation);\n        });\n    }\n    function handleConfirmSelection() {\n        const { players: selectedPlayerNames, courtId: courtId1, gameMode } = state.selection;\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\n        if (selectedPlayerNames.length !== requiredPlayers || !courtId1) return;\n        // This function is now only called from the confirmation overlay\n        // which means it's an alternative flow, but we still need the same check\n        if (checkOnDutyMemberInSelection(selectedPlayerNames)) {\n            showTempDutyHandoverModal(()=>{\n                proceedWithCourtSelection(selectedPlayerNames, courtId1, gameMode);\n            });\n            return;\n        }\n        proceedWithCourtSelection(selectedPlayerNames, courtId1, gameMode);\n    }\n    // NEW FUNCTION: Extracted game setup logic\n    function proceedWithGameSetup(selectedPlayerNames, courtId1, gameMode) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        const selectedPlayerObjects = selectedPlayerNames.map((name)=>getPlayerByName(name));\n        court.queueSnapshot = JSON.parse(JSON.stringify(state.availablePlayers));\n        court.players = [\n            ...selectedPlayerObjects\n        ];\n        court.gameMode = gameMode;\n        // --- NEW LOGIC: Snapshot the match settings for this game ---\n        court.matchMode = state.matchSettings.matchMode;\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\n        // --- END NEW LOGIC ---\n        if (gameMode === 'doubles') {\n            court.status = \"selecting_teams\";\n            court.teams.team1 = [];\n            court.teams.team2 = [];\n        } else {\n            court.teams.team1 = [\n                selectedPlayerObjects[0]\n            ];\n            court.teams.team2 = [\n                selectedPlayerObjects[1]\n            ];\n            court.status = \"game_pending\";\n            court.autoStartTimeTarget = Date.now() + 60000;\n            court.autoStartTimer = setTimeout(()=>handleStartGame(courtId1), 60000);\n        }\n        state.availablePlayers = state.availablePlayers.filter((p)=>!selectedPlayerNames.includes(p.name));\n        state.selection = {\n            gameMode: state.selection.gameMode,\n            players: [],\n            courtId: null\n        };\n        updateGameModeBasedOnPlayerCount();\n        enforceDutyPosition();\n        autoAssignCourtModes();\n        render();\n        saveState();\n    }\n    function handleCheckout(playerObject) {\n        // This function decides which modal to show.\n        if (playerObject.onLeaderboard === true) // If the player opted IN, show the modal with stats.\n        // This now passes the full object as required by the updated function.\n        showCheckoutThanksModal(playerObject);\n        else // If the player opted OUT, show the new modal without stats.\n        showCheckoutThanksModalNoStats(playerObject);\n    }\n    function handleChooseLater(courtId1) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        court.status = \"game_pending\";\n        court.teamsSet = false;\n        court.matchMode = state.matchSettings.matchMode;\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\n        court.autoStartTimeTarget = Date.now() + 60000;\n        court.autoStartTimer = setTimeout(()=>handleStartGame(courtId1), 60000);\n        render();\n        saveState();\n    }\n    function handleRandomizeTeams(courtId1) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court || court.players.length !== 4) return;\n        const men = court.players.filter((p)=>p.gender === 'M');\n        const women = court.players.filter((p)=>p.gender === 'F');\n        // --- THIS IS THE NEW LOGIC ---\n        // If it's a 2-man, 2-woman group, create mixed teams\n        if (men.length === 2 && women.length === 2) {\n            // Shuffle each gender group\n            const shuffledMen = men.sort(()=>0.5 - Math.random());\n            const shuffledWomen = women.sort(()=>0.5 - Math.random());\n            // Create mixed teams\n            court.teams.team1 = [\n                shuffledMen[0],\n                shuffledWomen[0]\n            ];\n            court.teams.team2 = [\n                shuffledMen[1],\n                shuffledWomen[1]\n            ];\n        } else {\n            // Fallback to the original complete shuffle for any other combination\n            let players = [\n                ...court.players\n            ].sort(()=>0.5 - Math.random());\n            court.teams.team1 = [\n                players[0],\n                players[1]\n            ];\n            court.teams.team2 = [\n                players[2],\n                players[3]\n            ];\n        }\n        // --- END OF NEW LOGIC ---\n        court.status = \"game_pending\";\n        court.matchMode = state.matchSettings.matchMode;\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\n        court.teamsSet = true;\n        court.autoStartTimeTarget = Date.now() + 60000;\n        court.autoStartTimer = setTimeout(()=>handleStartGame(courtId1), 60000);\n        render();\n        saveState();\n    }\n    function handleModalConfirm() {\n        const courtId1 = chooseTeamsModal.dataset.courtId;\n        const openedFrom = chooseTeamsModal.dataset.openedFrom;\n        const team1Names = Array.from(modalPlayerList.querySelectorAll(\".selected\")).map((el)=>el.dataset.player);\n        if (team1Names.length !== 2) {\n            alert(\"Please select exactly 2 players for Team 1.\");\n            return;\n        }\n        const allPlayerNames = JSON.parse(chooseTeamsModal.dataset.playerNames || '[]');\n        const allPlayerObjects = allPlayerNames.map((name)=>getPlayerByName(name));\n        const team1Players = team1Names.map((name)=>getPlayerByName(name));\n        const team2Players = allPlayerObjects.filter((player)=>!team1Names.includes(player.name));\n        chooseTeamsModal.classList.add(\"hidden\");\n        delete chooseTeamsModal.dataset.openedFrom;\n        delete chooseTeamsModal.dataset.playerNames;\n        delete chooseTeamsModal.dataset.courtId;\n        if (openedFrom === 'manual') {\n            const manualGameData = {\n                players: allPlayerObjects,\n                gameMode: 'doubles',\n                teamsSet: true,\n                teams: {\n                    team1: team1Players,\n                    team2: team2Players\n                }\n            };\n            // Re-call handleEndGame with the completed data to show the results modal\n            handleEndGame(null, null, manualGameData);\n        } else {\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (court) {\n                court.teams.team1 = team1Players;\n                court.teams.team2 = team2Players;\n                court.teamsSet = true;\n                court.matchMode = state.matchSettings.matchMode;\n                court.fastPlayGames = state.matchSettings.fastPlayGames;\n                if (openedFrom === 'in_progress') {\n                    // If teams were set during an active game, re-render and return to manage modal\n                    render();\n                    saveState();\n                    // Reopen the manage players modal\n                    showManageCourtPlayersModal(courtId1);\n                    return; // Exit early so we don't fall through to the saveState below\n                } else if (openedFrom === 'endgame') handleEndGame(courtId1); // Re-enter to show results modal\n                else {\n                    court.status = \"game_pending\";\n                    court.autoStartTimeTarget = Date.now() + 60000;\n                    court.autoStartTimer = setTimeout(()=>handleStartGame(courtId1), 60000);\n                    render(); // <-- THIS IS THE FIX\n                }\n                saveState();\n            }\n        }\n    }\n    function handleChooseTeams(courtId1, openedFrom = 'setup', players = null) {\n        chooseTeamsModal.classList.remove(\"hidden\");\n        chooseTeamsModal.dataset.openedFrom = openedFrom;\n        modalPlayerList.innerHTML = \"\";\n        modalPlayerList.classList.remove('two-row-grid');\n        document.getElementById('modal-confirm-teams-btn').textContent = \"Confirm\";\n        document.getElementById('modal-cancel-btn').textContent = \"Close\";\n        const court = courtId1 ? state.courts.find((c)=>c.id === courtId1) : null;\n        const playersToDisplay = players || (court ? court.players : []);\n        if (playersToDisplay.length > 0) {\n            if (playersToDisplay.length === 4) modalPlayerList.classList.add('two-row-grid');\n            playersToDisplay.forEach((player)=>{\n                const div = document.createElement(\"div\");\n                div.className = \"modal-player\";\n                div.textContent = player.name;\n                div.dataset.player = player.name;\n                modalPlayerList.appendChild(div);\n            });\n            // Store reference to the players being configured\n            chooseTeamsModal.dataset.playerNames = JSON.stringify(playersToDisplay.map((p)=>p.name));\n            if (courtId1) chooseTeamsModal.dataset.courtId = courtId1;\n        }\n        modalConfirmBtn.disabled = true;\n        modalConfirmBtn.classList.remove('modal-confirm-ready');\n        modalPlayerList.addEventListener('click', ()=>{\n            const selectedCount = modalPlayerList.querySelectorAll(\".selected\").length;\n            if (selectedCount === 2) {\n                modalConfirmBtn.disabled = false;\n                modalConfirmBtn.classList.add('modal-confirm-ready');\n            } else {\n                modalConfirmBtn.disabled = true;\n                modalConfirmBtn.classList.remove('modal-confirm-ready');\n            }\n        });\n    }\n    function handleModalPlayerClick(e) {\n        if (e.target.classList.contains(\"modal-player\")) {\n            const selectedCount = modalPlayerList.querySelectorAll(\".selected\").length;\n            if (e.target.classList.contains(\"selected\")) e.target.classList.remove(\"selected\");\n            else if (selectedCount < 2) e.target.classList.add(\"selected\");\n        }\n    }\n    function handleStartGame(courtId1) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court) return;\n        const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId1}\"]`);\n        const startButton = courtCardEl ? courtCardEl.querySelector('[data-action=\"start-game\"]') : null;\n        if (startButton) startButton.classList.add('start-game-hop');\n        setTimeout(()=>{\n            if (court.autoStartTimer) {\n                clearTimeout(court.autoStartTimer);\n                court.autoStartTimer = null;\n            }\n            court.status = \"in_progress\";\n            court.gameStartTime = Date.now();\n            court.autoStartTimeTarget = null;\n            court.isNewGame = true;\n            const team1Names = getPlayerNames(court.teams.team1);\n            const team2Names = getPlayerNames(court.teams.team2);\n            let announcementMessage;\n            // Updated formatTeamNames to use getPronounceableName\n            const formatTeamNames = (names)=>{\n                const pronounceableNames = names.map(getPronounceableName); // Use helper here\n                if (pronounceableNames.length === 1) return pronounceableNames[0];\n                if (pronounceableNames.length === 2) return `${pronounceableNames[0]} and ${pronounceableNames[1]}`;\n                return pronounceableNames.slice(0, -1).join(', ') + ` and ${pronounceableNames.slice(-1)[0]}`;\n            };\n            const formattedCourtId = formatCourtIdForTTS(court.id);\n            // --- NEW ANNOUNCEMENT LOGIC ---\n            let matchModeAnnouncement = '';\n            if (court.matchMode === 'fast') matchModeAnnouncement = `... a Fast Play match, first to ${court.fastPlayGames} games`;\n            else if (court.matchMode === '3set') matchModeAnnouncement = '... a 3 set match';\n            // --- END NEW LOGIC ---\n            if (court.gameMode === 'singles') // Use pronounceable names for singles\n            announcementMessage = `${getPronounceableName(team1Names[0])}, and ${getPronounceableName(team2Names[0])} ...are on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\n            else if (court.teamsSet === false) {\n                const playerNames = getPlayerNames(court.players);\n                const namesList = formatTeamNames(playerNames); // Uses pronounceable names via helper\n                announcementMessage = `It's ${namesList}, on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\n            } else {\n                const team1String = formatTeamNames(team1Names); // Uses pronounceable names via helper\n                const team2String = formatTeamNames(team2Names); // Uses pronounceable names via helper\n                announcementMessage = `It's team ${team1String}, versus team ${team2String} ...on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\n            }\n            playAlertSound(announcementMessage, null);\n            // --- THIS IS THE MODIFIED LOGIC ---\n            // 1. Scroll back to the summary card on mobile.\n            scrollToSummaryCard();\n            // 2. Expand the player list so it's ready for the next selection.\n            expandPlayerListOnMobile(); // <-- ADD THIS LINE\n            // 3. Render the final UI state.\n            render();\n            court.isNewGame = false;\n            saveState();\n            resetAlertSchedule();\n            checkAndPlayAlert(false);\n        }, 2000);\n    }\n    // ADD THIS NEW FUNCTION\n    function renderManualSelectedPlayers(container) {\n        container.innerHTML = '';\n        const { players } = state.manualEntry;\n        if (players.length === 0) container.innerHTML = '<p style=\"color: var(--neutral-color); margin: 0; text-align: center; width: 100%;\">No players selected yet.</p>';\n        else players.forEach((playerName)=>{\n            const chip = document.createElement('div');\n            chip.className = 'selected-player-chip';\n            chip.textContent = playerName.split(' ')[0]; // This is the fix for first names\n            chip.dataset.playerName = playerName;\n            chip.title = 'Click to remove';\n            container.appendChild(chip);\n        });\n    }\n    // ADD THIS NEW FUNCTION\n    function handleRemoveManualPlayer(playerName) {\n        state.manualEntry.players = state.manualEntry.players.filter((p)=>p !== playerName);\n        // Check which modal is currently visible to refresh the correct view\n        if (!manualEntryModal.classList.contains('hidden')) showManualPlayerSelectionModal();\n        else if (!outsidePlayerModal.classList.contains('hidden')) showOutsidePlayerModal();\n    }\n    // ADD THIS NEW FUNCTION\n    function openManualPlayerSelectionModal() {\n        state.manualEntry.players = []; // Clear state ONLY when opening fresh.\n        showManualPlayerSelectionModal(); // Now call the render function.\n    }\n    // REPLACE this function\n    function showManualPlayerSelectionModal() {\n        historyPage.classList.add('hidden');\n        manualEntryModal.classList.remove('hidden');\n        renderManualSelectedPlayers(manualSelectedPlayersContainer);\n        const playersOnCourt = state.courts.flatMap((c)=>c.players);\n        const allPlayersAtClub = [\n            ...state.availablePlayers,\n            ...playersOnCourt\n        ];\n        const uniquePlayers = Array.from(new Map(allPlayersAtClub.map((p)=>[\n                p.name,\n                p\n            ])).values()).filter((p)=>!state.manualEntry.players.includes(p.name)).sort((a, b)=>a.name.localeCompare(b.name));\n        manualPlayerList.innerHTML = '';\n        if (uniquePlayers.length === 0) manualPlayerList.innerHTML = '<li class=\"waiting-message\">All checked-in players have been selected.</li>';\n        else uniquePlayers.forEach((player)=>{\n            const li = document.createElement('li');\n            li.innerHTML = `\n                    <span style=\"flex-grow: 1;\">${player.name}</span>\n                    <span class=\"action-icon add\" data-player-name=\"${player.name}\">+</span>\n                `;\n            li.dataset.playerName = player.name;\n            manualPlayerList.appendChild(li);\n        });\n        setupListWithIndex(uniquePlayers, manualPlayerList, document.getElementById('manual-player-abc-index'));\n        const count = state.manualEntry.players.length;\n        const isValid = count === 2 || count === 4;\n        manualEntryConfirmBtn.disabled = !isValid;\n        manualEntryConfirmBtn.style.backgroundColor = isValid ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    // REPLACE this function\n    function handleManualPlayerClick(e) {\n        const addIcon = e.target.closest('.action-icon.add');\n        if (addIcon) {\n            const playerName = addIcon.dataset.playerName;\n            if (state.manualEntry.players.length < 4) {\n                state.manualEntry.players.push(playerName);\n                showManualPlayerSelectionModal(); // This is the fix\n            } else playCustomTTS(\"You can select a maximum of 4 players.\");\n        }\n    }\n    // REPLACE this function\n    function showOutsidePlayerModal() {\n        manualEntryModal.classList.add('hidden');\n        outsidePlayerModal.classList.remove('hidden');\n        renderManualSelectedPlayers(outsideSelectedPlayersContainer);\n        const playersOnCourt = state.courts.flatMap((c)=>c.players.map((p)=>p.name));\n        const availablePlayerNames = state.availablePlayers.map((p)=>p.name);\n        const checkedInNames = new Set([\n            ...playersOnCourt,\n            ...availablePlayerNames\n        ]);\n        const outsideMembers = MASTER_MEMBER_LIST.filter((m)=>!checkedInNames.has(m.name));\n        const returningGuests = state.guestHistory.filter((g)=>!checkedInNames.has(g.name));\n        const allOutsidePlayers = [\n            ...outsideMembers,\n            ...returningGuests\n        ].filter((p)=>!state.manualEntry.players.includes(p.name)).sort((a, b)=>a.name.localeCompare(b.name));\n        outsidePlayerList.innerHTML = '';\n        if (allOutsidePlayers.length === 0) outsidePlayerList.innerHTML = '<li class=\"waiting-message\">All other players have been selected.</li>';\n        else allOutsidePlayers.forEach((player)=>{\n            const li = document.createElement('li');\n            li.innerHTML = `\n                    <span style=\"flex-grow: 1;\">${player.name}</span>\n                    <span class=\"action-icon add\" data-player-name=\"${player.name}\">+</span>\n                `;\n            li.dataset.playerName = player.name;\n            outsidePlayerList.appendChild(li);\n        });\n        setupListWithIndex(allOutsidePlayers, outsidePlayerList, document.getElementById('outside-player-abc-index'));\n        // Logic for the new confirm button\n        const count = state.manualEntry.players.length;\n        const isValid = count === 2 || count === 4;\n        outsidePlayerConfirmBtn.disabled = !isValid;\n        outsidePlayerConfirmBtn.style.backgroundColor = isValid ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    // REPLACE this function\n    function handleOutsidePlayerClick(e) {\n        const addIcon = e.target.closest('.action-icon.add');\n        if (addIcon) {\n            const playerName = addIcon.dataset.playerName;\n            if (state.manualEntry.players.length < 4) {\n                state.manualEntry.players.push(playerName);\n                showOutsidePlayerModal(); // Re-render this view\n            } else playCustomTTS(\"You have already selected the maximum of 4 players.\");\n        }\n    }\n    // ADD THIS NEW FUNCTION\n    function handleConfirmManualPlayers() {\n        const { players } = state.manualEntry;\n        if (players.length !== 2 && players.length !== 4) return;\n        const playerObjects = players.map((name)=>getPlayerByName(name));\n        const gameMode = players.length === 2 ? 'singles' : 'doubles';\n        // Create a temporary object to mimic a court for the endGame flow\n        const manualGameData = {\n            players: playerObjects,\n            gameMode: gameMode,\n            teamsSet: false,\n            teams: {\n                team1: [],\n                team2: []\n            }\n        };\n        if (gameMode === 'singles') {\n            manualGameData.teamsSet = true;\n            manualGameData.teams.team1 = [\n                playerObjects[0]\n            ];\n            manualGameData.teams.team2 = [\n                playerObjects[1]\n            ];\n        }\n        // --- FIX: Ensure both player selection modals are closed ---\n        manualEntryModal.classList.add('hidden');\n        outsidePlayerModal.classList.add('hidden');\n        // --- END FIX ---\n        handleEndGame(null, null, manualGameData); // Pass the manual data object\n    }\n    // REPLACE this function\n    function handleEndGame(courtId1, editGameId = null, manualEntryData = null) {\n        resetEndGameModal();\n        let matchModeDetails = {\n            matchMode: '1set',\n            fastPlayGames: 4\n        };\n        if (manualEntryData) {\n            if (manualEntryData.teamsSet) {\n                endGameModal.dataset.manualEntry = JSON.stringify(manualEntryData.players.map((p)=>p.name));\n                endGameTimestamp.textContent = `Manual Entry - ${new Date().toLocaleString('en-ZA')}`;\n                const team1Names = getPlayerNames(manualEntryData.teams.team1).join(\" & \");\n                const team2Names = getPlayerNames(manualEntryData.teams.team2).join(\" & \");\n                endGameTeams.innerHTML = `\n                    <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\n                    <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\n                `;\n            } else {\n                handleChooseTeams(null, 'manual', manualEntryData.players);\n                return;\n            }\n        } else if (editGameId) {\n            const gameToEdit = state.gameHistory.find((g)=>g.id == editGameId);\n            if (!gameToEdit) return;\n            endGameModal.dataset.editGameId = editGameId;\n            endGameTimestamp.textContent = `Editing Game from: ${new Date(gameToEdit.endTime).toLocaleString()}`;\n            const team1Names = gameToEdit.teams.team1.join(\" & \");\n            const team2Names = gameToEdit.teams.team2.join(\" & \");\n            endGameTeams.innerHTML = `\n                <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\n                <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\n            `;\n        } else if (courtId1) {\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (!court) return;\n            if (court.teamsSet === false) {\n                handleChooseTeams(courtId1, 'endgame');\n                return;\n            }\n            endGameModal.dataset.courtId = courtId1;\n            matchModeDetails = {\n                matchMode: court.matchMode,\n                fastPlayGames: court.fastPlayGames\n            };\n            const now = new Date();\n            endGameTimestamp.textContent = `Completed: ${now.toLocaleDateString('en-ZA', {\n                day: 'numeric',\n                month: 'short'\n            })} at ${now.toLocaleTimeString([], {\n                hour: '2-digit',\n                minute: '2-digit'\n            })}`;\n            const team1Names = getPlayerNames(court.teams.team1).join(\" & \");\n            const team2Names = getPlayerNames(court.teams.team2).join(\" & \");\n            endGameTeams.innerHTML = `\n                <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\n                <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\n            `;\n        }\n        endGameModal.dataset.matchMode = matchModeDetails.matchMode;\n        endGameModal.dataset.fastPlayGames = matchModeDetails.fastPlayGames;\n        const skipBtn = document.getElementById('end-game-skip-btn');\n        endGameTeams.querySelectorAll('.team-selection').forEach((el)=>el.addEventListener('click', (e)=>{\n                const selectedTeam = e.currentTarget.dataset.team;\n                endGameModal.dataset.winner = selectedTeam;\n                endGameTeams.querySelectorAll('.team-selection').forEach((teamEl)=>{\n                    teamEl.classList.toggle('winner', teamEl.dataset.team === selectedTeam);\n                    teamEl.classList.toggle('loser', teamEl.dataset.team !== selectedTeam);\n                });\n                scoreSection.classList.remove('hidden');\n                skipBtn.textContent = 'Skip Scores';\n                skipBtn.dataset.action = 'skip-scores';\n                validateEndGameForm();\n            }));\n        // --- THIS IS THE FIX ---\n        // Define keypad rules based on the current game's mode\n        let winKeypadConfig = {};\n        let loseKeypadConfig = {};\n        if (matchModeDetails.matchMode === 'fast') {\n            winKeypadConfig = {\n                maxLength: 2,\n                maxValue: matchModeDetails.fastPlayGames\n            };\n            loseKeypadConfig = {\n                maxLength: 2,\n                maxValue: matchModeDetails.fastPlayGames - 1\n            };\n        } else {\n            winKeypadConfig = {\n                maxLength: 1,\n                maxValue: 7\n            };\n            loseKeypadConfig = {\n                maxLength: 1,\n                maxValue: 7\n            };\n        }\n        // Dynamically wire up the score inputs to use these specific rules for this session\n        wireScoreInputToKeypad(winningScoreInput, winKeypadConfig);\n        wireScoreInputToKeypad(losingScoreInput, loseKeypadConfig);\n        // --- END OF FIX ---\n        endGameModal.classList.remove(\"hidden\");\n    }\n    function handleCancelGame(courtId1) {\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Cancellation\";\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to cancel this game? Players will be returned to their original queue positions.\";\n        modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\n        modalBtnNo.textContent = \"Close\"; // Standardized Text\n        cancelConfirmModal.dataset.mode = \"cancelGame\";\n        cancelConfirmModal.dataset.courtId = courtId1;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // FIX 1: Add checkAndPlayAlert(false) to trigger re-evaluation after game cancellation\n    function executeGameCancellation() {\n        const courtId1 = cancelConfirmModal.dataset.courtId;\n        if (!courtId1) return;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (court) {\n            if (court.autoStartTimer) clearTimeout(court.autoStartTimer);\n            // --- THIS IS THE FIX ---\n            // Instead of re-selecting players, we clear the selection entirely.\n            state.selection.players = [];\n            state.selection.courtId = null;\n            // --- END OF FIX ---\n            if (court.queueSnapshot) // Restore the available players list to exactly how it was before the game was made.\n            state.availablePlayers = court.queueSnapshot;\n            else {\n                // Fallback: If for some reason there's no snapshot, return players to the front.\n                const playersToRequeue = court.players.filter((p)=>!p.guest);\n                state.availablePlayers = [\n                    ...playersToRequeue,\n                    ...state.availablePlayers\n                ];\n            }\n            court.becameAvailableAt = Date.now();\n            court.status = \"available\";\n            court.players = [];\n            court.teams = {\n                team1: [],\n                team2: []\n            };\n            court.gameMode = null;\n            court.autoStartTimer = null;\n            court.gameStartTime = null;\n            court.queueSnapshot = null;\n            court.teamsSet = null;\n            cancelConfirmModal.classList.add(\"hidden\");\n            updateGameModeBasedOnPlayerCount();\n            enforceDutyPosition();\n            autoAssignCourtModes();\n            render();\n            saveState();\n            checkAndPlayAlert(false);\n            requestAnimationFrame(()=>{\n                requestAnimationFrame(ensureCourtSelectionAnimation);\n            });\n        }\n    }\n    function executePlayerCheckIn() {\n        const playerToCheckInName = cancelConfirmModal.dataset.player;\n        if (playerToCheckInName) {\n            const playerObject = state.clubMembers.find((p)=>p.name === playerToCheckInName);\n            if (playerObject) {\n                // Show leaderboard confirmation instead of directly checking in\n                leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\n                leaderboardConfirmModal.classList.remove('hidden');\n                cancelConfirmModal.classList.add('hidden');\n                checkInModal.classList.add('hidden');\n            }\n        }\n    }\n    // Helper function to complete the check-in process\n    // in script.js\n    // Helper function to complete the check-in process\n    function finishCheckIn(playerObject) {\n        if (!state.availablePlayers.some((p)=>p.name === playerObject.name)) {\n            state.availablePlayers.push(playerObject);\n            state.clubMembers = state.clubMembers.filter((p)=>p.name !== playerObject.name);\n        }\n        // Hide the leaderboard/guest modals\n        leaderboardConfirmModal.classList.add('hidden');\n        guestNameModal.classList.add('hidden');\n        // Repopulate the check-in list with the remaining members\n        populateCheckInModal();\n        // --- THIS IS THE KEY CHANGE ---\n        // Re-open the check-in modal instead of going to the main screen\n        checkInModal.classList.remove('hidden');\n        // Reset the guest form fields for the next potential entry\n        guestNameInput.value = '';\n        guestSurnameInput.value = '';\n        guestConfirmBtn.disabled = true;\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\n        // Update the main application state in the background\n        updateGameModeBasedOnPlayerCount();\n        autoAssignCourtModes();\n        render();\n        saveState();\n        checkAndPlayAlert(false);\n    }\n    function executePlayerCheckOut() {\n        const playerToCheckOutName = cancelConfirmModal.dataset.player;\n        if (playerToCheckOutName) {\n            // --- THIS IS THE FIX ---\n            // Check if the player checking out is the first one in the queue.\n            if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerToCheckOutName) // If so, reset the alert timer and count for the next player.\n            resetAlertSchedule();\n            // --- END OF FIX ---\n            const playerObject = state.availablePlayers.find((p)=>p.name === playerToCheckOutName);\n            if (playerObject) {\n                if (playerObject.isJunior) state.juniorClub.activeChildren = state.juniorClub.active - children.filter((child)=>child.name !== playerToCheckOutName);\n                if (!playerObject.guest) {\n                    state.clubMembers.push(playerObject);\n                    state.clubMembers.sort((a, b)=>a.name.localeCompare(b.name));\n                }\n            }\n            state.availablePlayers = state.availablePlayers.filter((p)=>p.name !== playerToCheckOutName);\n            cancelConfirmModal.classList.add(\"hidden\");\n            populateCheckOutModal();\n            checkOutModal.classList.remove(\"hidden\");\n            updateGameModeBasedOnPlayerCount();\n            autoAssignCourtModes();\n            render();\n            saveState();\n        // The render() function now triggers the necessary alert checks automatically.\n        }\n    }\n    // ADD THIS NEW FUNCTION\n    function resetEndGameModal() {\n        endGameModal.classList.add(\"hidden\");\n        // Clear all data attributes\n        delete endGameModal.dataset.courtId;\n        delete endGameModal.dataset.editGameId;\n        delete endGameModal.dataset.winner;\n        // Clear dynamic content\n        endGameTeams.innerHTML = '';\n        // Hide optional sections\n        scoreSection.classList.add('hidden');\n        tieBreakerArea.classList.add('hidden');\n        // Clear input values\n        winningScoreInput.value = '';\n        losingScoreInput.value = '';\n        winnerTiebreakInput.value = '';\n        loserTiebreakInput.value = '';\n        // Reset the confirm button to its default disabled/orange state\n        endGameConfirmBtn.disabled = true;\n        endGameConfirmBtn.style.backgroundColor = 'var(--inactive-color)';\n        endGameConfirmBtn.style.borderColor = 'var(--inactive-color)';\n        // Reset the skip button's text and action\n        const skipBtn = document.getElementById('end-game-skip-btn');\n        skipBtn.textContent = 'Skip Result';\n        skipBtn.dataset.action = 'skip-result';\n    }\n    // REPLACE this function\n    function confirmEndGame() {\n        const editGameId = endGameModal.dataset.editGameId;\n        const manualPlayerNamesJSON = endGameModal.dataset.manualEntry;\n        const now = Date.now(); // Get current time once\n        const winnerValue = endGameModal.dataset.winner; // Get winner from modal data\n        // --- Score Processing (Common Logic) ---\n        let score1 = null, score2 = null, tiebreak1 = null, tiebreak2 = null;\n        const finalWinningScore = parseInt(winningScoreInput.value, 10);\n        const finalLosingScore = parseInt(losingScoreInput.value, 10);\n        // Only process scores if they are valid numbers\n        if (!isNaN(finalWinningScore) && !isNaN(finalLosingScore)) {\n            if (winnerValue === 'team1') {\n                score1 = finalWinningScore;\n                score2 = finalLosingScore;\n            } else {\n                score1 = finalLosingScore;\n                score2 = finalWinningScore;\n            }\n            // Process tiebreak only if the area is visible and scores are entered\n            if (!tieBreakerArea.classList.contains('hidden')) {\n                const finalWinnerTiebreak = parseInt(winnerTiebreakInput.value, 10);\n                const finalLoserTiebreak = parseInt(loserTiebreakInput.value, 10);\n                if (!isNaN(finalWinnerTiebreak) && !isNaN(finalLoserTiebreak)) {\n                    if (winnerValue === 'team1') {\n                        tiebreak1 = finalWinnerTiebreak;\n                        tiebreak2 = finalLoserTiebreak;\n                    } else {\n                        tiebreak1 = finalLoserTiebreak;\n                        tiebreak2 = finalWinnerTiebreak;\n                    }\n                }\n            }\n        }\n        // --- End Score Processing ---\n        if (manualPlayerNamesJSON) {\n            // --- MANUAL ENTRY LOGIC ---\n            const manualPlayerNames = JSON.parse(manualPlayerNamesJSON);\n            const team1Selection = endGameTeams.querySelector('.team-selection[data-team=\"team1\"] span').textContent;\n            const team2Selection = endGameTeams.querySelector('.team-selection[data-team=\"team2\"] span').textContent;\n            // Reconstruct teams based on modal display (handles names with '&')\n            const team1NamesManual = team1Selection.split(' & ');\n            const team2NamesManual = team2Selection.split(' & ');\n            const manualGame = {\n                id: now,\n                court: 'Manual',\n                startTime: now - 3600000,\n                endTime: now,\n                duration: '01h00m',\n                teams: {\n                    team1: team1NamesManual,\n                    team2: team2NamesManual\n                },\n                // Include score object only if scores were entered\n                score: score1 !== null && score2 !== null ? {\n                    team1: score1,\n                    team2: score2,\n                    tiebreak1: tiebreak1,\n                    tiebreak2: tiebreak2\n                } : null,\n                winner: winnerValue\n            };\n            state.gameHistory.push(manualGame);\n            // Clear manual entry state\n            state.manualEntry.players = [];\n            delete endGameModal.dataset.manualEntry; // Clean up dataset\n            // --- FIX: Close end game modal and SHOW history ---\n            endGameModal.classList.add(\"hidden\");\n            historyPage.classList.remove(\"hidden\"); // Re-show history\n            renderGameHistory(); // Re-render history list\n            saveState();\n            resetEndGameModal();\n            // --- END FIX ---\n            return; // Exit after handling manual entry\n        } else if (editGameId) {\n            // --- EDIT GAME LOGIC ---\n            const gameIndex = state.gameHistory.findIndex((g)=>g.id == editGameId);\n            if (gameIndex > -1) {\n                state.gameHistory[gameIndex].winner = winnerValue;\n                // Update score only if valid scores were entered\n                if (score1 !== null && score2 !== null) state.gameHistory[gameIndex].score = {\n                    team1: score1,\n                    team2: score2,\n                    tiebreak1: tiebreak1,\n                    tiebreak2: tiebreak2\n                };\n                else state.gameHistory[gameIndex].score = null; // Clear score if invalid/skipped\n            }\n            delete endGameModal.dataset.editGameId; // Clean up dataset\n            endGameModal.classList.add(\"hidden\");\n            historyPage.classList.remove(\"hidden\"); // Re-show history\n            renderGameHistory(); // Re-render history list\n            saveState();\n            resetEndGameModal();\n            return; // Exit after handling edit\n        } else {\n            // --- REGULAR GAME END LOGIC ---\n            const courtId1 = endGameModal.dataset.courtId;\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (!court) return;\n            const team1Names = getPlayerNames(court.teams.team1);\n            const team2Names = getPlayerNames(court.teams.team2);\n            const newGame = {\n                id: now,\n                court: court.id,\n                startTime: court.gameStartTime,\n                endTime: now,\n                duration: document.getElementById(`timer-${court.id}`).textContent,\n                teams: {\n                    team1: team1Names,\n                    team2: team2Names\n                },\n                // Include score object only if scores were entered\n                score: score1 !== null && score2 !== null ? {\n                    team1: score1,\n                    team2: score2,\n                    tiebreak1: tiebreak1,\n                    tiebreak2: tiebreak2\n                } : null,\n                winner: winnerValue\n            };\n            state.gameHistory.push(newGame);\n            const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\n            const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\n            const playersToRequeue = [\n                ...winningPlayers,\n                ...losingPlayers\n            ].filter((p)=>!p.guest);\n            state.availablePlayers.push(...playersToRequeue);\n            court.becameAvailableAt = now;\n            // Grace period check logic remains the same...\n            const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\n            if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\n                // Find court ID *after* resetting current one (but before calling resetCourtAfterGame)\n                const tempAvailableCourtId = findNextAvailableCourtIdAfterReset(courtId1);\n                const firstPlayerFullName = getFirstAvailablePlayerNameAfterRequeue(playersToRequeue); // Get name *after* adding players back\n                const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\n                if (firstPlayerPronounceableName) {\n                    const openCourtMessage = tempAvailableCourtId ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(tempAvailableCourtId)} is available.` : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\n                    playAlertSound(openCourtMessage);\n                }\n            } else console.log(\"Skipped game end announcement due to grace period.\");\n            resetCourtAfterGame(courtId1); // This calls render() and saveState()\n            resetEndGameModal();\n        }\n    }\n    // --- NEW HELPER FUNCTIONS FOR GRACE PERIOD ---\n    // Finds the next available court *assuming* the current court (courtIdToReset) is reset\n    function findNextAvailableCourtIdAfterReset(courtIdToReset) {\n        for (const id of COURT_HIERARCHY){\n            const court = state.courts.find((c)=>c.id === id);\n            if (court && state.courtSettings.visibleCourts.includes(id)) {\n                // Consider the court being reset as available, or check its actual status\n                if (id === courtIdToReset || court.status === 'available') return id;\n            }\n        }\n        return null;\n    }\n    // Finds the first available player *assuming* the playersToRequeue have been added\n    function getFirstAvailablePlayerNameAfterRequeue(playersToRequeue) {\n        // Simulate adding players to the end for the check\n        const simulatedAvailablePlayers = [\n            ...state.availablePlayers,\n            ...playersToRequeue\n        ];\n        const selectorPlayer = simulatedAvailablePlayers.find((p)=>!p.isPaused);\n        return selectorPlayer ? selectorPlayer.name : null;\n    }\n    // --- END NEW HELPER FUNCTIONS ---\n    // REPLACE this function\n    function confirmSkipResult() {\n        const courtId1 = endGameModal.dataset.courtId;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court) return;\n        const now = Date.now(); // Get current time\n        // ... (game history logging remains the same) ...\n        const team1Names = getPlayerNames(court.teams.team1);\n        const team2Names = getPlayerNames(court.teams.team2);\n        const newGame = {\n            id: now,\n            court: court.id,\n            startTime: court.gameStartTime,\n            endTime: now,\n            duration: document.getElementById(`timer-${court.id}`).textContent,\n            teams: {\n                team1: team1Names,\n                team2: team2Names\n            },\n            score: null,\n            winner: 'skipped'\n        };\n        state.gameHistory.push(newGame);\n        // ... (rest of history logging) ...\n        const playersToRequeue = [\n            ...court.players\n        ].filter((p)=>!p.guest);\n        state.availablePlayers.push(...playersToRequeue);\n        // --- GRACE PERIOD CHECK ---\n        const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\n        if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\n            const nextAvailableCourtId = findNextAvailableCourtId(); // Find court ID *after* resetting current one\n            const firstPlayerFullName = getFirstAvailablePlayerName(); // Get name *after* requeuing\n            const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\n            if (firstPlayerPronounceableName) {\n                const openCourtMessage = nextAvailableCourtId ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(nextAvailableCourtId)} is available.` : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\n                playAlertSound(openCourtMessage);\n            }\n        } else console.log(\"Skipped skip result announcement due to grace period.\");\n        // --- END GRACE PERIOD CHECK ---\n        resetCourtAfterGame(court.id); // This calls render() and saveState()\n        endGameModal.classList.add(\"hidden\");\n    // checkAndPlayAlert(false); // No longer needed here, resetCourtAfterGame handles it\n    }\n    // REPLACE this function\n    function confirmSkipScores() {\n        const courtId1 = endGameModal.dataset.courtId;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        const winnerValue = endGameModal.dataset.winner;\n        if (!court || !winnerValue) return;\n        const now = Date.now(); // Get current time\n        // ... (game history logging remains the same) ...\n        const team1Names = getPlayerNames(court.teams.team1);\n        const team2Names = getPlayerNames(court.teams.team2);\n        const newGame = {\n            id: now,\n            court: court.id,\n            startTime: court.gameStartTime,\n            endTime: now,\n            duration: document.getElementById(`timer-${court.id}`).textContent,\n            teams: {\n                team1: team1Names,\n                team2: team2Names\n            },\n            score: null,\n            winner: winnerValue\n        };\n        state.gameHistory.push(newGame);\n        // ... (rest of history logging) ...\n        const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\n        const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\n        const playersToRequeue = [\n            ...winningPlayers,\n            ...losingPlayers\n        ].filter((p)=>!p.guest);\n        state.availablePlayers.push(...playersToRequeue);\n        // --- GRACE PERIOD CHECK ---\n        const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\n        if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\n            const nextAvailableCourtId = findNextAvailableCourtId(); // Find court ID *after* resetting current one\n            const firstPlayerFullName = getFirstAvailablePlayerName(); // Get name *after* requeuing\n            const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\n            if (firstPlayerPronounceableName) {\n                const openCourtMessage = nextAvailableCourtId ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(nextAvailableCourtId)} is available.` : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\n                playAlertSound(openCourtMessage);\n            }\n        } else console.log(\"Skipped skip scores announcement due to grace period.\");\n        // --- END GRACE PERIOD CHECK ---\n        resetCourtAfterGame(court.id); // This calls render() and saveState()\n        endGameModal.classList.add(\"hidden\");\n    // checkAndPlayAlert(false); // No longer needed here, resetCourtAfterGame handles it\n    }\n    function checkAndShowTieBreak() {\n        const matchMode = endGameModal.dataset.matchMode || '1set';\n        // --- THIS IS THE FIX ---\n        // Never show tie-break for Fast Play mode\n        if (matchMode === 'fast') {\n            tieBreakerArea.classList.add('hidden');\n            winnerTiebreakInput.value = '';\n            loserTiebreakInput.value = '';\n            return;\n        }\n        // --- END OF FIX ---\n        const winScore = parseInt(winningScoreInput.value, 10);\n        const loseScore = parseInt(losingScoreInput.value, 10);\n        if (winScore === 7 && loseScore === 6) tieBreakerArea.classList.remove('hidden');\n        else {\n            tieBreakerArea.classList.add('hidden');\n            winnerTiebreakInput.value = '';\n            loserTiebreakInput.value = '';\n        }\n    }\n    // NOTE: Score validation logic is correct for standard tennis rules (6-0 to 6-4, 7-5, 7-6 + tiebreak).\n    function validateEndGameForm() {\n        const winnerSelected = !!endGameModal.dataset.winner;\n        if (!winnerSelected) {\n            endGameConfirmBtn.disabled = true;\n            return;\n        }\n        const matchMode = endGameModal.dataset.matchMode || '1set'; // Get match mode\n        const fastPlayGames = parseInt(endGameModal.dataset.fastPlayGames, 10) || 4; // Get fast play games\n        const winScoreVal = winningScoreInput.value;\n        const loseScoreVal = losingScoreInput.value;\n        const winScore = parseInt(winScoreVal, 10);\n        const loseScore = parseInt(loseScoreVal, 10);\n        let scoresValid = false;\n        if (winScoreVal !== '' && loseScoreVal !== '') {\n            if (matchMode === 'fast') {\n                if (winScore === fastPlayGames && loseScore < fastPlayGames) scoresValid = true;\n            } else {\n                if (winScore === 6 && loseScore >= 0 && loseScore <= 4) scoresValid = true;\n                if (winScore === 7 && loseScore === 5) scoresValid = true;\n                if (winScore === 7 && loseScore === 6) scoresValid = true;\n            }\n        }\n        if (!scoresValid) {\n            endGameConfirmBtn.disabled = true;\n            endGameConfirmBtn.style.backgroundColor = 'var(--inactive-color)';\n            endGameConfirmBtn.style.borderColor = 'var(--inactive-color)';\n            return;\n        }\n        let tiebreakValid = true;\n        if (!tieBreakerArea.classList.contains('hidden')) {\n            const tbWinnerVal = winnerTiebreakInput.value;\n            const tbLoserVal = loserTiebreakInput.value;\n            if (tbWinnerVal === '' || tbLoserVal === '') tiebreakValid = false;\n            else {\n                const numTbWinner = parseInt(tbWinnerVal, 10);\n                const numTbLoser = parseInt(tbLoserVal, 10);\n                tiebreakValid = numTbWinner >= 7 && numTbWinner - numTbLoser >= 2 || numTbLoser >= 7 && numTbLoser - numTbWinner >= 2;\n            }\n        }\n        const isReady = winnerSelected && scoresValid && tiebreakValid;\n        endGameConfirmBtn.disabled = !isReady;\n        endGameConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n        endGameConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    /**\r\n     * Converts a single-letter court ID to a phonetic spelling for clearer TTS.\r\n     * @param {string} courtId The court ID (e.g., 'A', 'B').\r\n     * @returns {string} The phonetic spelling (e.g., 'AYY', 'Bee').\r\n     */ function formatCourtIdForTTS(courtId1) {\n        if (!courtId1) return '';\n        switch(courtId1.toUpperCase()){\n            case 'A':\n                return 'AYY';\n            case 'B':\n                return 'Bee';\n            case 'C':\n                return 'See';\n            case 'D':\n                return 'Dee';\n            case 'E':\n                return 'EE';\n            default:\n                return courtId1; // Fallback for any other court names\n        }\n    }\n    /**\r\n     * Helper to configure a SpeechSynthesisUtterance object with voice settings.\r\n     * @param {string} message The message for the utterance.\r\n     * @returns {SpeechSynthesisUtterance|null} Configured utterance object or null if not supported.\r\n     */ function getUtterance(message) {\n        if (!('speechSynthesis' in window)) return null;\n        const utterance = new SpeechSynthesisUtterance(message);\n        // TTS VOICE SELECTION (Prioritizing clear English, checking for SA English)\n        const voices = window.speechSynthesis.getVoices();\n        // THIS IS THE LINE THAT SELECTS THE en-ZA VOICE\n        let preferredVoice = voices.find((voice)=>voice.lang === 'en-ZA');\n        // This part is a fallback in case an en-ZA voice is not found\n        if (!preferredVoice) preferredVoice = voices.find((voice)=>voice.lang.startsWith('en-') && voice.name.includes('Google'));\n        if (preferredVoice) utterance.voice = preferredVoice;\n        utterance.rate = 0.85;\n        utterance.pitch = 0.95;\n        return utterance;\n    }\n    /**\r\n     * Executes the Text-to-Speech call for a single, independent message.\r\n     * This function immediately cancels any existing speech before speaking.\r\n     * @param {string} message The message to be spoken.\r\n     */ function playCustomTTS(message) {\n        // NEW: Check if all notifications are muted OR if TTS is disabled\n        if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\n        const utterance = getUtterance(message);\n        if (utterance) {\n            // Ensure no pending TTS is running before starting the new one\n            if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();\n            window.speechSynthesis.speak(utterance);\n        }\n    }\n    /**\r\n     * Calculates the age of a person in full years from a date string (YYYY-MM-DD).\r\n     * @param {string} dateString The birth date in 'YYYY-MM-DD' format.\r\n     * @returns {number|null} The age in years, or null if the date is invalid.\r\n     */ function calculateAge(dateString) {\n        if (!dateString) return null;\n        const today = new Date();\n        const birthDate = new Date(dateString);\n        if (isNaN(birthDate)) return null;\n        let age = today.getFullYear() - birthDate.getFullYear();\n        const m = today.getMonth() - birthDate.getMonth();\n        if (m < 0 || m === 0 && today.getDate() < birthDate.getDate()) age--;\n        return age;\n    }\n    // NEW FUNCTION: Function that handles the actual sound + TTS sequence for a single item\n    function _playAnnouncementSequence(item, callback) {\n        isAnnouncementPlaying = true;\n        const { msg1, msg2, soundFile } = item;\n        const playSequencedTTS = (msg1, msg2, onDone)=>{\n            if (state.notificationControls.isTTSDisabled) return onDone();\n            if (!msg1 && !msg2) return onDone();\n            const utterance1 = getUtterance(msg1 || msg2);\n            if (!utterance1) return onDone();\n            utterance1.onend = ()=>{\n                if (msg1 && msg2) {\n                    const utterance2 = getUtterance(msg2);\n                    if (utterance2) {\n                        utterance2.onend = onDone; // Call final callback after the second message\n                        window.speechSynthesis.speak(utterance2);\n                    } else onDone();\n                } else onDone(); // Done after the first message\n            };\n            // Ensure no pending TTS is running before starting the new sequence.\n            if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();\n            window.speechSynthesis.speak(utterance1);\n        };\n        if (state.notificationControls.isTTSDisabled) {\n            // If TTS is disabled, we only worry about the audio playing, then call back.\n            if (!soundFile) return callback();\n        }\n        // Stop previous sound\n        if (currentAudio) {\n            currentAudio.pause();\n            currentAudio.currentTime = 0;\n        }\n        // CRITICAL FIX: Cancel any existing speech NOW before starting audio/TTS.\n        if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();\n        if (!soundFile) {\n            playSequencedTTS(msg1, msg2, callback);\n            return;\n        }\n        // NEW LOGIC: If a sound is about to play for this item, suppress the sound\n        // for all subsequent announcements currently waiting in the queue.\n        announcementQueue.forEach((queuedItem)=>{\n            queuedItem.soundFile = null;\n        });\n        const audioPath = `source/${soundFile}`;\n        currentAudio = new Audio(audioPath);\n        // Wait for sound to finish, then start TTS sequence\n        currentAudio.addEventListener('playing', function onSoundPlaying() {\n            currentAudio.removeEventListener('playing', onSoundPlaying);\n            currentAudio.addEventListener('ended', function onSoundEnd() {\n                currentAudio.removeEventListener('ended', onSoundEnd);\n                // Play sequenced TTS, passing the main callback as the final onDone\n                playSequencedTTS(msg1, msg2, callback);\n            });\n        });\n        currentAudio.play().catch((error)=>{\n            console.error(`Error playing alert sound ${audioPath}: `, error);\n            // Fallback: Play sequenced TTS immediately if sound fails\n            playSequencedTTS(msg1, msg2, callback);\n        });\n    }\n    // NEW FUNCTION: Function that processes the queue\n    function processAnnouncementQueue() {\n        if (isAnnouncementPlaying && announcementQueue.length === 0) {\n            isAnnouncementPlaying = false;\n            return;\n        }\n        if (announcementQueue.length === 0) return;\n        if (!isAnnouncementPlaying) {\n            isAnnouncementPlaying = true;\n            const firstItem = announcementQueue[0];\n            if (!firstItem.soundFile) announcementQueue.unshift({\n                msg1: null,\n                msg2: null,\n                soundFile: state.selectedAlertSound\n            });\n        }\n        const nextItem = announcementQueue.shift();\n        _playAnnouncementSequence(nextItem, processAnnouncementQueue);\n    }\n    // PUBLIC INTERFACE (Replaces old playAlertSound)\n    function playAlertSound(courtMessage = null, dutyMessage = null, soundFileNameOverride = null) {\n        // Check if all notifications are muted\n        if (state.notificationControls.isMuted) return;\n        // 1. Add the new announcement to the queue\n        announcementQueue.push({\n            msg1: courtMessage,\n            msg2: dutyMessage,\n            // CRITICAL: Standard alerts are now TTS-only. Sound is only included if it is an OVERRIDE (e.g., CommitteeCall)\n            soundFile: soundFileNameOverride || null\n        });\n        // 2. Start the queue processor if it's not already running\n        if (!isAnnouncementPlaying) processAnnouncementQueue();\n    }\n    // PUBLIC INTERFACE (Replaces old playCustomTTS)\n    function playCustomTTS(message) {\n        // Check if all notifications are muted OR if TTS is disabled\n        if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\n        const utterance = getUtterance(message);\n        if (utterance) // Push to queue with no sound and no second message, preserving the null sound file for TTS-only announcements\n        playAlertSound(message, null, null);\n    }\n    // NEW HELPER FUNCTION: Finds the name of the first available, non-paused player\n    function getFirstAvailablePlayerName() {\n        const selectorPlayer = state.availablePlayers.find((p)=>!p.isPaused);\n        return selectorPlayer ? selectorPlayer.name : null;\n    }\n    // UPDATED FUNCTION: Logic maintains alertScheduleTime unless overridden or conditions are missed.\n    // @param {boolean} forceCheck - If true, triggers the alert/sound/TTS immediately and resets the timer.\n    function checkAndPlayAlert(forceCheck = false) {\n        const availablePlayerCount = state.availablePlayers.length;\n        const TWO_MINUTES_MS = 120000;\n        const FIVE_MINUTES_MS = 300000;\n        const now = Date.now();\n        const hasEnoughPlayers = availablePlayerCount >= 4;\n        const availableCourtId = findNextAvailableCourtId();\n        const conditionMet = hasEnoughPlayers && availableCourtId;\n        const firstPlayerFullName = getFirstAvailablePlayerName(); // Get the full name first\n        if (!conditionMet || !firstPlayerFullName) {\n            resetAlertSchedule();\n            return;\n        }\n        const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName); // Get pronounceable name\n        const formattedCourtId = formatCourtIdForTTS(availableCourtId);\n        // Use pronounceable name in the message\n        let standardMessage = `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formattedCourtId} is available.`;\n        if (forceCheck) {\n            playAlertSound(standardMessage);\n            return;\n        }\n        if (alertState === 'initial_check') {\n            const firstInterval = state.notificationControls.isMinimized ? TWO_MINUTES_MS : FIVE_MINUTES_MS;\n            alertScheduleTime = now + firstInterval;\n            alertState = '2_min_countdown';\n            state.currentAlertCount = 1;\n            return;\n        }\n        if (now >= alertScheduleTime) {\n            if (state.currentAlertCount >= 2) {\n                // Find the index of the first active (not paused) player. This is our target.\n                const playerToMoveIndex = state.availablePlayers.findIndex((p)=>!p.isPaused);\n                if (playerToMoveIndex !== -1 && state.availablePlayers.length > 1) {\n                    // Remove that specific player from their current position in the array.\n                    const [playerToMove] = state.availablePlayers.splice(playerToMoveIndex, 1);\n                    // --- THIS IS THE FIX ---\n                    // We want to insert them at position #9.\n                    // We calculate how many paused players are \"in front of\" our target insertion point.\n                    const targetPosition = 8;\n                    const pausedPlayersBeforeTarget = state.availablePlayers.slice(0, targetPosition).filter((p)=>p.isPaused).length;\n                    // The actual index in the array is the target position plus the number of paused players.\n                    const insertionIndex = Math.min(targetPosition + pausedPlayersBeforeTarget, state.availablePlayers.length);\n                    // --- END OF FIX ---\n                    state.availablePlayers.splice(insertionIndex, 0, playerToMove);\n                    enforceQueueLogic(); // Re-apply all queue rules after the move\n                    // Clear any stored suggestion since the selector has changed\n                    state.currentSuggestionOutcome = null;\n                    state.currentSuggestionType = null;\n                    if (state.activeSuggestion) clearSuggestionHighlights();\n                    const newFirstPlayerFullName = getFirstAvailablePlayerName();\n                    // Use pronounceable names in the swap message\n                    const playerToMovePronounceable = getPronounceableName(playerToMove.name);\n                    const newFirstPlayerPronounceable = getPronounceableName(newFirstPlayerFullName);\n                    const swapMessage = `${playerToMovePronounceable} has been moved down. ${newFirstPlayerPronounceable}, please select your match on court ${formattedCourtId}.`;\n                    playAlertSound(swapMessage);\n                    render();\n                    saveState();\n                    resetAlertSchedule();\n                    return;\n                }\n            // --- END OF FIX ---\n            }\n            // --- THIS IS THE FIX ---\n            // If this is the second alert (count is 1 before increment), add the \"last call\" message.\n            if (state.currentAlertCount === 1) standardMessage += \" This is your last call.\";\n            // --- END OF FIX ---\n            playAlertSound(standardMessage);\n            state.currentAlertCount++;\n            const nextInterval = state.notificationControls.isMinimized ? TWO_MINUTES_MS : FIVE_MINUTES_MS;\n            alertScheduleTime = now + nextInterval;\n            alertState = '5_min_repeat';\n        }\n    }\n    function initQuoteRotator() {\n        const quoteTextEl = document.getElementById('quote-text');\n        if (!quoteTextEl || quoteTextEl.dataset.initialized === 'true') return;\n        quoteTextEl.textContent = `\"${state.tennisQuotes[state.currentQuoteIndex]}\"`;\n        // Only set the interval once\n        if (!window.quoteInterval) window.quoteInterval = setInterval(()=>{\n            quoteTextEl.classList.add('fading');\n            setTimeout(()=>{\n                state.currentQuoteIndex = (state.currentQuoteIndex + 1) % state.tennisQuotes.length;\n                // Ensure element exists before updating, as it might be destroyed during a render cycle\n                const currentQuoteEl = document.getElementById('quote-text');\n                if (currentQuoteEl) {\n                    currentQuoteEl.textContent = `\"${state.tennisQuotes[state.currentQuoteIndex]}\"`;\n                    currentQuoteEl.classList.remove('fading');\n                }\n            }, 1000);\n        }, 12000);\n        quoteTextEl.dataset.initialized = 'true';\n    }\n    // REPLACE this function\n    function getAdminPasscode() {\n        const today = new Date();\n        const dayOfMonth = String(today.getDate()).padStart(2, '0');\n        return `${ADMIN_PIN_BASE}${dayOfMonth}`;\n    }\n    // REPLACE this function\n    function handleAdminLogin() {\n        if (adminSessionActive) {\n            // If session is active, PAUSE the timer by clearing it.\n            if (adminSessionTimer) {\n                clearTimeout(adminSessionTimer);\n                adminSessionTimer = null;\n            }\n            showAdminModal(); // And go directly to the modal\n            return;\n        }\n        // If no session is active, prompt for the PIN using the original admin keypad\n        showKeypad(null, {\n            mode: 'admin',\n            maxLength: 6,\n            title: 'Enter Admin Passcode'\n        });\n    }\n    // REPLACE this function\n    function checkAdminPasscode() {\n        const enteredCode = keypadDisplay.dataset.hiddenValue;\n        const expectedCode = getAdminPasscode();\n        if (enteredCode === expectedCode) {\n            hideKeypad();\n            adminSessionActive = true;\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\n            adminSessionTimer = setTimeout(()=>{\n                adminSessionActive = false;\n                adminSessionTimer = null;\n                state.courts.forEach((c)=>c.isModeOverlayActive = false);\n                render();\n                playAlertSound(null, null, 'Alert7.mp3');\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\n            }, 60000); // 1 minute\n            showAdminModal();\n        } else {\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\n            keypadContent.classList.add('shake');\n            setTimeout(()=>{\n                keypadContent.classList.remove('shake');\n                keypadDisplay.textContent = '';\n                if (keypadDisplay.dataset.hiddenValue) keypadDisplay.dataset.hiddenValue = '';\n                if (activeInput) activeInput.value = '';\n                keypadConfirmBtn.disabled = true;\n            }, 820);\n        }\n    }\n    function checkUndoPasscode() {\n        const enteredPin = keypadDisplay.dataset.hiddenValue || '';\n        const actionIndex = parseInt(customKeypadModal.dataset.undoActionIndex);\n        // Get the correct PIN (0308 + DD)\n        const correctPin = getAdminPasscode();\n        console.log('=== UNDO PIN CHECK ===');\n        console.log('Entered PIN:', enteredPin);\n        console.log('Correct PIN:', correctPin);\n        console.log('Match:', enteredPin === correctPin);\n        if (enteredPin === correctPin) {\n            hideKeypad();\n            executeUndoAction(actionIndex);\n            delete customKeypadModal.dataset.undoActionIndex;\n            delete customKeypadModal.dataset.undoActionDescription;\n        } else {\n            // Shake animation instead of alert\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\n            keypadContent.classList.add('shake');\n            // Clear the display\n            keypadDisplay.textContent = '';\n            delete keypadDisplay.dataset.hiddenValue;\n            keypadConfirmBtn.disabled = true;\n            // Remove shake class after animation completes\n            setTimeout(()=>{\n                keypadContent.classList.remove('shake');\n            }, 820);\n        }\n    }\n    // ADD THIS NEW FUNCTION\n    function showCourtModeKeypad() {\n        courtModeKeypadDisplay.textContent = '';\n        delete courtModeKeypadDisplay.dataset.hiddenValue;\n        courtModeKeypadConfirmBtn.disabled = true;\n        courtModeKeypadModal.classList.remove('hidden');\n    }\n    // ADD THIS NEW FUNCTION\n    function hideCourtModeKeypad() {\n        courtModeKeypadModal.classList.add('hidden');\n        courtModeAction = null; // Clear the stored action\n    }\n    // ADD THIS NEW FUNCTION\n    function checkCourtModePasscode() {\n        const enteredCode = courtModeKeypadDisplay.dataset.hiddenValue;\n        const expectedCode = getAdminPasscode();\n        if (enteredCode === expectedCode) {\n            hideCourtModeKeypad();\n            adminSessionActive = true;\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\n            adminSessionTimer = setTimeout(()=>{\n                adminSessionActive = false;\n                adminSessionTimer = null;\n                state.courts.forEach((c)=>c.isModeOverlayActive = false);\n                render();\n                playAlertSound(null, null, 'Alert7.mp3');\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\n            }, 60000); // 1 minute\n            if (courtModeAction) courtModeAction();\n        } else {\n            const keypadContent = courtModeKeypadModal.querySelector('.keypad-content');\n            keypadContent.classList.add('shake');\n            setTimeout(()=>{\n                keypadContent.classList.remove('shake');\n                courtModeKeypadDisplay.textContent = '';\n                if (courtModeKeypadDisplay.dataset.hiddenValue) courtModeKeypadDisplay.dataset.hiddenValue = '';\n                courtModeKeypadConfirmBtn.disabled = true;\n            }, 820);\n        }\n    }\n    function runAutoMinimizeLogic() {\n        if (!state.notificationControls.autoMinimize) return; // Do nothing if the feature is turned off\n        // 1. Count only the courts available for social play (not reserved for league or turned off)\n        const socialCourts = state.courts.filter((c)=>state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league');\n        const socialCourtCount = socialCourts.length;\n        // 2. Get the total number of players currently at the club\n        const totalPlayerCount = totalPlayersAtClub();\n        // 3. Define the threshold based on the available social courts\n        // This is the max capacity of social courts for doubles, plus a waiting queue of 4.\n        const minimizeThreshold = socialCourtCount * 4 + 4;\n        // 4. Apply the new logic\n        // Condition for quick turnaround (2-minute timer):\n        if (totalPlayerCount >= minimizeThreshold) {\n            if (!state.notificationControls.isMinimized) {\n                state.notificationControls.isMinimized = true;\n                // --- THIS IS THE FIX ---\n                if (!state.matchSettings.autoMatchModes) playCustomTTS(\"Switching to 2-minute alerts.\");\n                // --- END OF FIX ---\n                updateNotificationIcons();\n                saveState();\n            }\n        } else if (state.notificationControls.isMinimized) {\n            state.notificationControls.isMinimized = false;\n            if (!state.matchSettings.autoMatchModes) playCustomTTS(\"Switching to 5-minute alerts.\");\n            updateNotificationIcons();\n            saveState();\n        }\n    }\n    function handleNotifyNow() {\n        const availablePlayerCount = state.availablePlayers.length;\n        const hasEnoughPlayers = availablePlayerCount >= 4;\n        const isAnyCourtAvailable = findNextAvailableCourtId();\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Announcement\";\n        modalBtnYesConfirm.textContent = \"Confirm\";\n        modalBtnNo.textContent = \"Close\";\n        if (!hasEnoughPlayers) {\n            cancelConfirmModal.querySelector(\"p\").textContent = \"There are not enough players for a doubles match. Announce to waiting players?\";\n            cancelConfirmModal.dataset.mode = \"forceAnnouncementNotEnoughPlayers\";\n            cancelConfirmModal.classList.remove(\"hidden\");\n            return;\n        }\n        if (!isAnyCourtAvailable) {\n            // This is a hard stop, so a simple alert is appropriate.\n            alert(\"Notification cannot be sent: No courts are available.\");\n            return;\n        }\n        // This is the standard case where everything is ready.\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to force a player announcement now?\";\n        cancelConfirmModal.dataset.mode = \"forceAnnouncement\";\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    function initSummaryCardElements() {\n        // 1. Re-bind the settings button listener\n        const settingsBtn = document.getElementById('settings-btn');\n        if (settingsBtn) {\n            settingsBtn.removeEventListener('click', handleAdminLogin); // Prevent multiple bindings\n            settingsBtn.addEventListener('click', handleAdminLogin);\n        }\n        // 2. REVISED LISTENER BINDING for the notify button\n        const notifyNowBtn = document.getElementById('notify-now-btn');\n        if (notifyNowBtn) {\n            // Ensure any previous listener is removed before adding the new one\n            notifyNowBtn.removeEventListener('click', handleNotifyNow);\n            notifyNowBtn.addEventListener('click', handleNotifyNow);\n        }\n        // 3. ADDED LISTENER for the new call duty button\n        const callDutyBtn = document.getElementById('call-duty-btn');\n        if (callDutyBtn) {\n            callDutyBtn.removeEventListener('click', handleCallDuty);\n            callDutyBtn.addEventListener('click', handleCallDuty);\n        }\n        // 4. Re-start the quote rotator\n        initQuoteRotator();\n    }\n    // NEW FUNCTION: Updates the icons on the sound selection modal based on state\n    function updateNotificationIcons() {\n        // Ensure buttons exist before querying for icons\n        if (!muteBtn || !minimizeNotificationsBtn || !noSpeechBtn) return;\n        const muteIcon = muteBtn.querySelector('i');\n        const minimizeIcon = minimizeNotificationsBtn.querySelector('i');\n        const noSpeechIcon = noSpeechBtn.querySelector('i');\n        if (muteIcon) muteIcon.className = state.notificationControls.isMuted ? 'mdi mdi-volume-off' : 'mdi mdi-volume-high';\n        if (minimizeIcon) minimizeIcon.className = state.notificationControls.isMinimized ? 'mdi mdi-arrow-collapse-vertical' : 'mdi mdi-arrow-expand-vertical';\n        if (noSpeechIcon) noSpeechIcon.className = state.notificationControls.isTTSDisabled ? 'mdi mdi-microphone-off' : 'mdi mdi-microphone-message';\n    }\n    function showAdminModal() {\n        // Populate Committee Member List (Assuming this logic is correct from your file)\n        committeeMemberList.innerHTML = '';\n        const committeeMembers = MASTER_MEMBER_LIST.filter((m)=>m.committee);\n        const noneOption = document.createElement('li');\n        noneOption.innerHTML = `\n            <label>\n                <input type=\"radio\" name=\"onDutyMember\" value=\"None\" ${state.onDuty === 'None' ? 'checked' : ''}>\n                <div class=\"member-details\">\n                    <span class=\"member-name\">None</span>\n                    <span class=\"member-designation\">No assigned member</span>\n                </div>\n            </label>\n        `;\n        committeeMemberList.appendChild(noneOption);\n        committeeMembers.sort((a, b)=>a.name.localeCompare(b.name)).forEach((member)=>{\n            const li = document.createElement('li');\n            li.className = 'committee-member';\n            li.innerHTML = `\n                <label>\n                    <input type=\"radio\" name=\"onDutyMember\" value=\"${member.name}\" ${state.onDuty === member.name ? 'checked' : ''}>\n                    <div class=\"member-details\">\n                        <span class=\"member-name\">${member.name}</span>\n                        <span class=\"member-designation\">${member.committee}</span>\n                    </div>\n                </label>\n            `;\n            committeeMemberList.appendChild(li);\n        });\n        committeeMemberList.querySelectorAll('input[name=\"onDutyMember\"]').forEach((radio)=>{\n            radio.removeEventListener('change', handleOnDutyChange); // Prevent duplicates\n            radio.addEventListener('change', handleOnDutyChange);\n        });\n        // Populate Court Availability List\n        courtAvailabilityList.innerHTML = '';\n        // --- Render the global Toggles First ---\n        const togglesLi = document.createElement('li');\n        togglesLi.className = 'court-availability-item';\n        // Removed inline styles, assuming CSS handles layout\n        togglesLi.innerHTML = `\n            <label style=\"flex-grow: 1;\">Auto Court Modes</label>\n            <label class=\"switch\">\n                <input type=\"checkbox\" id=\"auto-assign-toggle\" ${state.courtSettings.autoAssignModes ? 'checked' : ''}>\n                <span class=\"slider\"></span>\n            </label>\n            <label style=\"flex-grow: 1; margin-left: 1rem;\">Show Mode Selector</label>\n            <label class=\"switch\">\n                <input type=\"checkbox\" id=\"show-mode-selector-toggle\" ${state.courtSettings.showGameModeSelector ? 'checked' : ''}>\n                <span class=\"slider\"></span>\n            </label>\n        `;\n        courtAvailabilityList.appendChild(togglesLi);\n        // --- Render Match Mode Settings ---\n        const matchModeSettingsHtml = `\n            <li class=\"court-availability-item\" style=\"border-top: 1px dashed var(--border-color); padding-top: 1rem; margin-top: 0.5rem; flex-direction: column; align-items: stretch;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;\">\n                     <label style=\"flex-grow: 1;\">Auto Match Modes</label>\n                     <label class=\"switch\">\n                         <input type=\"checkbox\" id=\"auto-match-mode-toggle\" ${state.matchSettings.autoMatchModes ? 'checked' : ''}>\n                         <span class=\"slider\"></span>\n                     </label>\n                </div>\n                <div id=\"match-mode-selector-admin\" class=\"match-mode-selector\" style=\"${state.matchSettings.autoMatchModes ? 'display: none;' : ''}\">\n                    <label>\n                        <input type=\"radio\" name=\"match-mode\" value=\"1set\" ${state.matchSettings.matchMode === '1set' ? 'checked' : ''}> 1 Set\n                    </label>\n                    <label>\n                        <input type=\"radio\" name=\"match-mode\" value=\"3set\" ${state.matchSettings.matchMode === '3set' ? 'checked' : ''}> 3 Sets\n                    </label>\n                    <label>\n                        <input type=\"radio\" name=\"match-mode\" value=\"fast\" ${state.matchSettings.matchMode === 'fast' ? 'checked' : ''}> Fast Play\n                    </label>\n                </div>\n                <div class=\"fast-play-games-selector\" style=\"${state.matchSettings.matchMode !== 'fast' || state.matchSettings.autoMatchModes ? 'display: none;' : ''}\">\n                    <label>Fast Play Games (First to):</label>\n                    <div class=\"radio-group\">\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"3\" ${state.matchSettings.fastPlayGames === 3 ? 'checked' : ''}> 3 </label>\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"4\" ${state.matchSettings.fastPlayGames === 4 ? 'checked' : ''}> 4 </label>\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"5\" ${state.matchSettings.fastPlayGames === 5 ? 'checked' : ''}> 5 </label>\n                    </div>\n                </div>\n            </li>\n        `;\n        courtAvailabilityList.insertAdjacentHTML('beforeend', matchModeSettingsHtml);\n        // --- Court List Rendering (MODIFIED for click delegation) ---\n        state.courts.forEach((court)=>{\n            const li = document.createElement('li');\n            li.className = 'court-availability-item';\n            // li.style.cursor = 'pointer'; // Keep removed\n            li.dataset.courtId = court.id;\n            const isVisible = state.courtSettings.visibleCourts.includes(court.id);\n            const light = state.lightSettings.courts ? state.lightSettings.courts[court.id] : null;\n            const isLightManaged = light && light.isManaged;\n            const isLightActive = isLightManaged && light.isActive;\n            const lightIconClass = isLightActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline';\n            const lightDisabledAttr = isLightManaged ? '' : 'disabled';\n            // --- REVISED li.innerHTML ---\n            li.innerHTML = `\n                    <span style=\"font-weight: 500; margin-right: auto;\">${court.id}</span> <button class=\"light-toggle-btn\" data-court-id=\"${court.id}\" title=\"Toggle Court ${court.id} Lights\" ${lightDisabledAttr} style=\"flex-shrink: 0;\"> <i class=\"mdi ${lightIconClass}\"></i>\n                    </button>\n                    <label class=\"switch\" style=\"flex-shrink: 0; width: 50px\"> <input type=\"checkbox\" data-court-id=\"${court.id}\" ${isVisible ? 'checked' : ''}>\n                        <span class=\"slider\"></span>\n                    </label>\n                `;\n            // --- END REVISED li.innerHTML ---\n            courtAvailabilityList.appendChild(li);\n        });\n        // --- Event Listener Delegation (MODIFIED) ---\n        courtAvailabilityList.removeEventListener('click', handleAdminCourtListClick); // Remove previous listener if exists\n        courtAvailabilityList.addEventListener('click', handleAdminCourtListClick); // Add new delegated listener\n        // --- Attach Listeners for Toggles & Match Mode ---\n        document.getElementById('auto-assign-toggle')?.addEventListener('change', (e)=>{\n            state.courtSettings.autoAssignModes = e.target.checked;\n            saveState();\n            autoAssignCourtModes(); // Run the logic immediately\n            render(); // Re-render to show/hide court modes if needed\n        });\n        document.getElementById('show-mode-selector-toggle')?.addEventListener('change', (e)=>{\n            state.courtSettings.showGameModeSelector = e.target.checked;\n            saveState();\n            render(); // Re-render to show/hide the main selector\n        });\n        document.getElementById('auto-match-mode-toggle')?.addEventListener('change', (e)=>{\n            state.matchSettings.autoMatchModes = e.target.checked;\n            // Show/hide manual selectors\n            document.getElementById('match-mode-selector-admin').style.display = e.target.checked ? 'none' : '';\n            document.querySelector('.fast-play-games-selector').style.display = e.target.checked || state.matchSettings.matchMode !== 'fast' ? 'none' : '';\n            saveState();\n            autoAssignMatchMode(); // Run the logic immediately\n            render(); // Re-render summary card\n        });\n        document.querySelectorAll('input[name=\"match-mode\"]').forEach((radio)=>radio.addEventListener('change', handleMatchModeChange));\n        document.querySelectorAll('input[name=\"fast-play-games\"]').forEach((radio)=>radio.addEventListener('change', handleFastPlayGamesChange));\n        updateLightIcon(); // Update admin header light icon\n        adminSettingsModal.classList.remove('hidden');\n    }\n    // --- NEW Delegated Click Handler for Admin Court List ---\n    function handleAdminCourtListClick(e) {\n        const lightButton = e.target.closest('.light-toggle-btn');\n        const visibilityToggleInput = e.target.closest('.switch input[type=\"checkbox\"]'); // Target the input directly\n        const courtLabelButton = e.target.closest('.court-label-button'); // Target the new label span\n        if (lightButton) // Clicked the light icon button\n        handleLightToggleChange(e);\n        else if (visibilityToggleInput) // Clicked the visibility toggle switch's input\n        handleCourtVisibilityChange({\n            target: visibilityToggleInput\n        }); // Pass the input as the target\n    // Clicks elsewhere within the li (like empty space) are ignored\n    }\n    // --- NEW: Light Settings Modal Functions (Consolidated) ---\n    function showLightSettingsCourtModal(courtId1) {\n        // Ensure lightSettings structure exists\n        if (!state.lightSettings) {\n            console.error(\"state.lightSettings is missing!\");\n            return; // Or initialize it here\n        }\n        const court = state.lightSettings.courts ? state.lightSettings.courts[courtId1] : null;\n        if (!court) {\n            console.error(`Court settings for ${courtId1} not found!`);\n            return;\n        }\n        const modal = document.getElementById('light-settings-court-modal');\n        modal.dataset.editingCourtId = courtId1;\n        document.getElementById('light-settings-court-title').textContent = `Edit Light Settings for Court ${courtId1}`;\n        // ++ POPULATE GLOBAL FIELDS ++\n        document.getElementById('light-setting-base-url').value = state.lightSettings.shellyBaseUrl || '';\n        document.getElementById('light-setting-auth-key').value = state.lightSettings.shellyAuthKey || '';\n        // ++ END POPULATE GLOBAL FIELDS ++\n        // == POPULATE COURT-SPECIFIC FIELDS ==\n        document.getElementById('light-setting-label').value = court.label || `Court ${courtId1} Lights`;\n        document.getElementById('light-setting-cloud-id').value = court.shellyCloudId || '';\n        document.getElementById('light-setting-local-ip').value = court.shellyDeviceId || '';\n        // Default 'isManaged' to true if it's undefined in the state\n        document.getElementById('light-setting-managed').checked = court.isManaged !== false;\n        adminSettingsModal.classList.add('hidden');\n        modal.classList.remove('hidden');\n        // Wire up global keyboard for ALL inputs inside this modal\n        wireGlobalKeypadToInput(document.getElementById('light-setting-base-url'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-auth-key'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-label'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-cloud-id'));\n        wireGlobalKeypadToInput(document.getElementById('light-setting-local-ip'));\n    }\n    function saveLightSettingsCourtModal() {\n        const modal = document.getElementById('light-settings-court-modal');\n        const courtId1 = modal.dataset.editingCourtId;\n        if (!courtId1 || !state.lightSettings?.courts?.[courtId1]) {\n            console.error(`Cannot save: Court ${courtId1} not found!`);\n            return;\n        }\n        // Save GLOBAL settings (shared by all courts)\n        state.lightSettings.shellyBaseUrl = document.getElementById('light-setting-base-url').value.trim();\n        state.lightSettings.shellyAuthKey = document.getElementById('light-setting-auth-key').value.trim();\n        // Save COURT-SPECIFIC settings\n        const court = state.lightSettings.courts[courtId1];\n        court.label = document.getElementById('light-setting-label').value.trim() || `Court ${courtId1} Lights`;\n        court.shellyCloudId = document.getElementById('light-setting-cloud-id').value.trim();\n        court.shellyDeviceId = document.getElementById('light-setting-local-ip').value.trim();\n        court.isManaged = document.getElementById('light-setting-managed').checked;\n        court.toggleAfter = 0; // ← IMPORTANT: Permanent toggle, no auto-off\n        if (!court.isManaged) {\n            court.shellyCloudId = '';\n            court.shellyDeviceId = '';\n            court.isActive = false;\n        }\n        console.log(`[Light Settings] Saved Court ${courtId1}:`, court);\n        saveState();\n        modal.classList.add('hidden');\n        render(); // ← ADD THIS LINE\n        playCustomTTS(`Court ${courtId1} light settings saved.`);\n    }\n    // --- NEW: Click and Hold Paste Functionality ---\n    function setupLongPressPaste() {\n        const pasteTargets = document.querySelectorAll('.long-press-paste');\n        let pressTimer = null;\n        let isLongPress = false;\n        pasteTargets.forEach((input)=>{\n            // Remove previous listeners to prevent duplicates if called multiple times\n            input.removeEventListener('pointerdown', handlePointerDown);\n            input.removeEventListener('pointerup', handlePointerUp);\n            input.removeEventListener('pointerleave', handlePointerLeave);\n            input.removeEventListener('contextmenu', handleContextMenu);\n            // Add new listeners\n            input.addEventListener('pointerdown', handlePointerDown);\n            input.addEventListener('pointerup', handlePointerUp);\n            input.addEventListener('pointerleave', handlePointerLeave); // Handle finger sliding off\n            input.addEventListener('contextmenu', handleContextMenu); // Prevent default right-click menu\n        });\n        function handlePointerDown(e) {\n            const input = e.target;\n            isLongPress = false; // Reset flag\n            // --- ADD THIS LINE ---\n            // If a short click timer is running for this input, cancel it because a long press is starting.\n            if (input._clickTimeoutId) {\n                clearTimeout(input._clickTimeoutId);\n                input._clickTimeoutId = null;\n            }\n            // --- END ADD ---\n            // Start timer\n            pressTimer = setTimeout(async ()=>{\n                isLongPress = true; // Mark as long press\n                console.log('Long press detected on:', input.id);\n                input.style.backgroundColor = '#a8d5ff'; // Highlight during paste attempt\n                try {\n                    // Check for clipboard permission first\n                    const permission = await navigator.permissions.query({\n                        name: 'clipboard-read'\n                    });\n                    if (permission.state === 'granted' || permission.state === 'prompt') {\n                        const text = await navigator.clipboard.readText();\n                        if (text) {\n                            input.value = text;\n                            // Manually trigger 'input' event if needed by other logic\n                            input.dispatchEvent(new Event('input', {\n                                bubbles: true\n                            }));\n                            console.log('Pasted successfully!');\n                            playCustomTTS(\"Pasted from clipboard.\"); // Optional feedback\n                        } else {\n                            console.log('Clipboard is empty.');\n                            playCustomTTS(\"Clipboard is empty.\");\n                        }\n                    } else {\n                        console.error('Clipboard read permission denied.');\n                        playCustomTTS(\"Could not paste. Please allow clipboard permissions.\");\n                        alert('Clipboard access denied. Please allow clipboard permissions in your browser settings for this site.');\n                    }\n                } catch (err) {\n                    console.error('Failed to read clipboard contents:', err);\n                    playCustomTTS(\"Could not paste.\");\n                    alert('Failed to paste from clipboard. Error: ' + err.message);\n                } finally{\n                    // Reset background color slightly later to keep visual feedback\n                    setTimeout(()=>{\n                        input.style.backgroundColor = '';\n                    }, 300);\n                    pressTimer = null; // Clear timer ID after execution\n                }\n            }, 750); // 750ms for long press\n        }\n        function handlePointerUp(e) {\n            if (pressTimer) {\n                clearTimeout(pressTimer);\n                pressTimer = null;\n            }\n            // Reset background immediately ONLY if it wasn't a completed long press action\n            if (!isLongPress) e.target.style.backgroundColor = '';\n        // If it *was* a long press, the background reset is handled in the timer's finally block\n        }\n        function handlePointerLeave(e) {\n            // If pointer leaves element during press, cancel the timer\n            if (pressTimer) {\n                clearTimeout(pressTimer);\n                pressTimer = null;\n                isLongPress = false;\n                e.target.style.backgroundColor = ''; // Reset background\n            }\n        }\n        function handleContextMenu(e) {\n            // Prevent the default right-click menu, especially on desktop\n            e.preventDefault();\n        }\n    }\n    function showSuggestionSettingsModal() {\n        // Set initial values from state\n        femaleRatioSlider.value = state.suggestionSettings.femaleRatioPercent;\n        updateFemaleRatioDisplay();\n        maleRatioSlider.value = state.suggestionSettings.maleRatioPercent;\n        updateMaleRatioDisplay();\n        leastPlaytimeToggle.checked = state.suggestionSettings.prioritizeLeastPlaytime;\n        powerScoreOnlyToggle.checked = state.suggestionSettings.powerScoreOnly;\n        // --- ADD THESE LINES ---\n        topPlayerSlider.value = state.suggestionSettings.topPlayerPercent;\n        updateTopPlayerDisplay();\n        frequentOpponentSlider.value = state.suggestionSettings.frequentOpponentPercent;\n        updateFrequentOpponentDisplay();\n        weakPlayerSlider.value = state.suggestionSettings.weakPlayerPercent;\n        updateWeakPlayerDisplay();\n        // --- END ADD ---\n        // Apply initial disabled/fade state based on powerScoreOnly\n        toggleSuggestionOptionsAvailability(state.suggestionSettings.powerScoreOnly);\n        adminSettingsModal.classList.add('hidden');\n        suggestionSettingsModal.classList.remove('hidden');\n    }\n    function updateFemaleRatioDisplay() {\n        const value = femaleRatioSlider.value;\n        femaleRatioDisplay.textContent = `${value}% All Female`;\n    }\n    function updateMaleRatioDisplay() {\n        const value = maleRatioSlider.value;\n        maleRatioDisplay.textContent = `${value}% All Male`;\n    }\n    function handleFemaleRatioChange() {\n        state.suggestionSettings.femaleRatioPercent = parseInt(femaleRatioSlider.value, 10);\n        updateFemaleRatioDisplay();\n        saveState();\n    }\n    function handleMaleRatioChange() {\n        state.suggestionSettings.maleRatioPercent = parseInt(maleRatioSlider.value, 10);\n        updateMaleRatioDisplay();\n        saveState();\n    }\n    function handleLeastPlaytimeToggleChange() {\n        state.suggestionSettings.prioritizeLeastPlaytime = leastPlaytimeToggle.checked;\n        saveState();\n    }\n    // Function to visually disable/enable other options\n    function toggleSuggestionOptionsAvailability(isDisabled) {\n        // Toggle the 'disabled' class on container elements\n        leastPlaytimeContainer.classList.toggle('disabled', isDisabled);\n        femaleRatioContainer.classList.toggle('disabled', isDisabled);\n        maleRatioContainer.classList.toggle('disabled', isDisabled);\n        // Explicitly enable/disable controls within the containers\n        leastPlaytimeToggle.disabled = isDisabled;\n        femaleRatioSlider.disabled = isDisabled;\n        maleRatioSlider.disabled = isDisabled;\n        // --- ADD THESE LINES ---\n        topPlayerContainer.classList.toggle('disabled', isDisabled);\n        frequentOpponentContainer.classList.toggle('disabled', isDisabled);\n        weakPlayerContainer.classList.toggle('disabled', isDisabled);\n        topPlayerSlider.disabled = isDisabled;\n        frequentOpponentSlider.disabled = isDisabled;\n        weakPlayerSlider.disabled = isDisabled;\n    // --- END ADD ---\n    }\n    function handlePowerScoreOnlyToggleChange() {\n        const isEnabled = powerScoreOnlyToggle.checked;\n        state.suggestionSettings.powerScoreOnly = isEnabled;\n        // Call the function to update UI based on the new state\n        toggleSuggestionOptionsAvailability(isEnabled);\n        saveState();\n    }\n    function updateTopPlayerDisplay() {\n        const value = topPlayerSlider.value;\n        topPlayerDisplay.textContent = `${value}% Top Player H2H`;\n    }\n    function handleTopPlayerChange() {\n        state.suggestionSettings.topPlayerPercent = parseInt(topPlayerSlider.value, 10);\n        updateTopPlayerDisplay();\n        saveState();\n    }\n    function updateFrequentOpponentDisplay() {\n        const value = frequentOpponentSlider.value;\n        frequentOpponentDisplay.textContent = `${value}% Frequent Opponent`;\n    }\n    function handleFrequentOpponentChange() {\n        state.suggestionSettings.frequentOpponentPercent = parseInt(frequentOpponentSlider.value, 10);\n        updateFrequentOpponentDisplay();\n        saveState();\n    }\n    function updateWeakPlayerDisplay() {\n        const value = weakPlayerSlider.value;\n        weakPlayerDisplay.textContent = `${value}% Weak Player Group`;\n    }\n    function handleWeakPlayerChange() {\n        state.suggestionSettings.weakPlayerPercent = parseInt(weakPlayerSlider.value, 10);\n        updateWeakPlayerDisplay();\n        saveState();\n    }\n    // FIX 5: Add checkAndPlayAlert(false) to trigger re-evaluation after court visibility change\n    function handleCourtVisibilityChange(e) {\n        const courtId1 = e.target.dataset.courtId;\n        const isVisible = e.target.checked;\n        if (isVisible) {\n            if (!state.courtSettings.visibleCourts.includes(courtId1)) {\n                state.courtSettings.visibleCourts.push(courtId1);\n                state.courtSettings.visibleCourts.sort();\n            }\n        } else state.courtSettings.visibleCourts = state.courtSettings.visibleCourts.filter((id)=>id !== courtId1);\n        saveState();\n        render();\n        checkAndPlayAlert(false); // Re-evaluate logic immediately\n    }\n    function logPlayerSwap(playerName, oldIndex, newIndex) {\n        if (oldIndex === newIndex) return;\n        // Initialize sessionLog on tempPlayerOrder if it doesn't exist\n        tempPlayerOrder.sessionLog = tempPlayerOrder.sessionLog || {};\n        let sessionLog = tempPlayerOrder.sessionLog;\n        // Initialize or get the player's log\n        let playerLog = sessionLog[playerName] || {\n            startPosition: oldIndex,\n            currentPosition: oldIndex,\n            movements: []\n        };\n        // Record the atomic movement\n        playerLog.movements.push({\n            from: oldIndex,\n            to: newIndex,\n            timestamp: Date.now()\n        });\n        // Update the player's final position for this session\n        playerLog.currentPosition = newIndex;\n        sessionLog[playerName] = playerLog;\n        tempPlayerOrder.sessionLog = sessionLog;\n    }\n    function showReorderModal() {\n        if (state.availablePlayers.length < 2) {\n            alert(\"At least two players must be available to reorder the queue.\");\n            return;\n        }\n        tempPlayerOrder = [\n            ...state.availablePlayers\n        ];\n        renderReorderList();\n        adminSettingsModal.classList.add('hidden');\n        reorderPlayersModal.classList.remove('hidden');\n    }\n    function renderReorderList() {\n        reorderPlayersList.innerHTML = \"\";\n        tempPlayerOrder.forEach((player, index)=>{\n            const li = document.createElement('li');\n            const isFirst = index === 0;\n            const isLast = index === tempPlayerOrder.length - 1;\n            li.innerHTML = `\n                <span class=\"reorder-position\" data-player-name=\"${player.name}\" data-current-index=\"${index}\">${index + 1}</span>\n                <span>${player.name}</span>\n                <div class=\"reorder-controls\">\n                    <button class=\"reorder-btn\" data-player-name=\"${player.name}\" data-direction=\"up\" ${isFirst ? 'disabled' : ''}>\\u{2191}</button>\n                    <button class=\"reorder-btn\" data-player-name=\"${player.name}\" data-direction=\"down\" ${isLast ? 'disabled' : ''}>\\u{2193}</button>\n                </div>\n            `;\n            reorderPlayersList.appendChild(li);\n        });\n    }\n    function handleReorderClick(e) {\n        const button = e.target.closest('.reorder-btn');\n        const positionEl = e.target.closest('.reorder-position');\n        if (button) {\n            const playerName = button.dataset.playerName;\n            const direction = button.dataset.direction;\n            const currentIndex = tempPlayerOrder.findIndex((p)=>p.name === playerName);\n            if (currentIndex === -1) return;\n            let newIndex = currentIndex;\n            if (direction === 'up' && currentIndex > 0) newIndex = currentIndex - 1;\n            else if (direction === 'down' && currentIndex < tempPlayerOrder.length - 1) newIndex = currentIndex + 1;\n            if (newIndex !== currentIndex) {\n                const [playerToMove] = tempPlayerOrder.splice(currentIndex, 1);\n                tempPlayerOrder.splice(newIndex, 0, playerToMove);\n            // Note: We don't need to log the swap here, it will be logged when the position is changed.\n            }\n            renderReorderList();\n        } else if (positionEl) showKeypad(positionEl, {\n            title: `Set new position for ${positionEl.dataset.playerName}`,\n            maxLength: 2\n        });\n    }\n    // NEW FUNCTION: Sound selection modal logic\n    function handleSoundSelectionModal() {\n        tempSelectedSound = state.selectedAlertSound;\n        updateNotificationIcons();\n        // Set the state of the new toggle switch\n        const autoMinimizeToggle = document.getElementById('auto-minimize-toggle');\n        if (autoMinimizeToggle) autoMinimizeToggle.checked = state.notificationControls.autoMinimize;\n        renderSoundList();\n        adminSettingsModal.classList.add('hidden');\n        soundSelectionModal.classList.remove('hidden');\n    }\n    // NEW FUNCTION: Render the sound list\n    function renderSoundList() {\n        soundSelectionList.innerHTML = '';\n        alertSounds.forEach((soundFile)=>{\n            const li = document.createElement('li');\n            li.className = 'sound-selection-item';\n            const isSelected = soundFile === tempSelectedSound;\n            // Extract the number from the filename for display\n            const displayName = soundFile.replace('.mp3', '').replace('Alert', 'Alert ');\n            li.innerHTML = `\n                <label class=\"sound-selection-label\">\n                    <input type=\"radio\" name=\"alertSound\" value=\"${soundFile}\" ${isSelected ? 'checked' : ''}>\n                    ${displayName}\n                </label>\n                <button class=\"sound-preview-btn\" data-sound-file=\"${soundFile}\">\\u{25B6}</button>\n            `;\n            soundSelectionList.appendChild(li);\n        });\n        // Set initial state of confirm button\n        soundConfirmBtn.disabled = !tempSelectedSound;\n        soundConfirmBtn.style.backgroundColor = tempSelectedSound ? 'var(--confirm-color)' : 'var(--inactive-color)';\n        soundConfirmBtn.style.borderColor = tempSelectedSound ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    // NEW FUNCTION: Handle radio button selection in sound modal\n    function handleSoundSelection(e) {\n        if (e.target.type === 'radio' && e.target.name === 'alertSound') {\n            tempSelectedSound = e.target.value;\n            soundConfirmBtn.disabled = false;\n            soundConfirmBtn.style.backgroundColor = 'var(--confirm-color)';\n            soundConfirmBtn.style.borderColor = 'var(--confirm-color)';\n        }\n    }\n    // NEW FUNCTION: Handle sound preview button click\n    function handleSoundPreview(e) {\n        const button = e.target.closest('.sound-preview-btn');\n        if (!button) return;\n        const soundFile = button.dataset.soundFile;\n        // FIX: Stop previous sound before playing the new one\n        if (currentAudio) {\n            currentAudio.pause();\n            currentAudio.currentTime = 0;\n        }\n        const audioPath = `source/${soundFile}`;\n        currentAudio = new Audio(audioPath);\n        currentAudio.play().catch((error)=>{\n            console.warn(`Could not play audio from source/${soundFile}. Error: `, error);\n        // Optional: alert(`Preview for ${soundFile} failed. Check file existence in the 'source' directory.`);\n        });\n    }\n    // NEW FUNCTION: Confirm and save sound selection\n    function confirmSoundSelection() {\n        state.selectedAlertSound = tempSelectedSound;\n        saveState();\n        soundSelectionModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    }\n    // NEW FUNCTION: Cancel sound selection\n    function cancelSoundSelection() {\n        soundSelectionModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    }\n    function resetAlertSchedule() {\n        alertScheduleTime = 0;\n        alertState = 'initial_check';\n        state.currentAlertCount = 0; // <-- ADD THIS NEW LINE\n    }\n    /* =================================\r\n        Screensaver FUNCTIONS (NEW)\r\n    ================================= */ function resetAlertSchedule() {\n        alertScheduleTime = 0;\n        alertState = 'initial_check';\n        state.currentAlertCount = 0; // <-- ADD THIS NEW LINE\n    }\n    // --- NEW: Screensaver Functions ---\n    function startScreensaver() {\n        // Don't start if already active or on mobile\n        if (!screensaverOverlay.classList.contains('hidden') || window.innerWidth <= 900) return;\n        console.log(\"Starting screensaver...\");\n        screensaverOverlay.classList.remove('hidden'); // Fade in overlay container\n        isShowingScreensaverEvent = true; // Reset state: Start by showing an event\n        screensaverCurrentIndex = 0; // Reset index to the first event\n        // Clear any previous interval to prevent duplicates\n        if (screensaverCycleInterval) {\n            clearInterval(screensaverCycleInterval);\n            screensaverCycleInterval = null; // Ensure it's cleared\n        }\n        // Function to display the next item (event or app view)\n        // SCREENSAVER CYCLING LOGIC:\n        // - Event View: Shows event details with overlay background\n        // - Main App View: Makes overlay transparent so you can see courts/players/main app\n        // - Cycles every 15 seconds between these two states\n        // - This allows monitoring courts while still promoting events\n        const displayNextScreensaverItem = ()=>{\n            const activeEvents = state.events.filter((event)=>event.isActive);\n            // --- FADE OUT ---\n            screensaverContent.classList.remove('visible');\n            screensaverOverlay.classList.remove('show-main-app');\n            // --- Remove existing overlay button ---\n            const existingOverlayBtn = document.getElementById('screensaver-interested-btn-overlay');\n            if (existingOverlayBtn) existingOverlayBtn.remove();\n            setTimeout(()=>{\n                if (isShowingScreensaverEvent && activeEvents.length > 0) {\n                    // --- SHOW EVENT ---\n                    const eventIndexToShow = screensaverCurrentIndex % activeEvents.length;\n                    const event = activeEvents[eventIndexToShow];\n                    // --- Format Date (Removed weekday) ---\n                    const eventDateFormatted = event.eventDate ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString('en-ZA', {\n                        year: 'numeric',\n                        month: 'long',\n                        day: 'numeric'\n                    }) // Removed weekday:'long'\n                     : 'Date TBC';\n                    // --- Format Time (Added AM/PM) ---\n                    let eventTimeFormatted = 'Time TBC';\n                    if (event.startTime) try {\n                        const [hours, minutes] = event.startTime.split(':');\n                        const hourInt = parseInt(hours, 10);\n                        const minuteInt = parseInt(minutes, 10);\n                        const ampm = hourInt >= 12 ? 'PM' : 'AM';\n                        const hour12 = hourInt % 12 || 12; // Convert 0 hour to 12\n                        eventTimeFormatted = `${hour12}:${String(minuteInt).padStart(2, '0')} ${ampm}`;\n                    } catch (e) {\n                        console.error(\"Error formatting event time:\", e);\n                        eventTimeFormatted = event.startTime; // Fallback to original if parsing fails\n                    }\n                    // --- END Time Formatting ---\n                    const rsvpDateFormatted = event.rsvpDate ? new Date(event.rsvpDate + 'T00:00:00').toLocaleDateString('en-ZA', {\n                        day: 'numeric',\n                        month: 'short',\n                        year: 'numeric'\n                    }) : 'N/A';\n                    // Build images HTML\n                    let imagesHTML = '';\n                    if (event.image1Filename && event.image1Filename !== 'None') imagesHTML += `<img src=\"source/screensaver/${event.image1Filename}\" alt=\"Event Image 1\" class=\"screensaver-event-image\">`;\n                    if (event.image2Filename && event.image2Filename !== 'None') imagesHTML += `<img src=\"source/screensaver/${event.image2Filename}\" alt=\"Event Image 2\" class=\"screensaver-event-image\">`;\n                    // Build cost display\n                    let costHTML = '';\n                    if (event.costAdult > 0 || event.costChild > 0) {\n                        const adultCost = event.costAdult > 0 ? `Adult: R${event.costAdult}` : '';\n                        const childCost = event.costChild > 0 ? `Child: R${event.costChild}` : '';\n                        const separator = adultCost && childCost ? ' | ' : '';\n                        costHTML = `<p class=\"screensaver-cost\">${adultCost}${separator}${childCost}</p>`;\n                        if (event.participationDiscount > 0) costHTML += `<p class=\"screensaver-discount\">Club Champ Participants get R${event.participationDiscount} off</p>`;\n                    }\n                    // Build RSVP section\n                    let rsvpHTML = '';\n                    if (rsvpDateFormatted && rsvpDateFormatted !== 'N/A') {\n                        let rsvpText = `RSVP BY ${rsvpDateFormatted.toUpperCase()}`;\n                        if (event.volunteersNeeded) rsvpText += ' - VOLUNTEER COOKS NEEDED';\n                        rsvpHTML = `<p class=\"screensaver-rsvp\"><strong>${rsvpText}</strong></p>`;\n                    } else if (event.volunteersNeeded) rsvpHTML = `<p class=\"screensaver-rsvp\"><strong>VOLUNTEER COOKS NEEDED</strong></p>`;\n                    // Build contact info HTML\n                    let contactHTML = '';\n                    if (event.phone || event.email || event.website) {\n                        contactHTML = '<div class=\"screensaver-contact-bar\">';\n                        if (event.phone) contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">\\u{1F4DE}</span><span class=\"contact-text\">${event.phone}</span></div>`;\n                        if (event.email) contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">\\u{2709}</span><span class=\"contact-text\">${event.email}</span></div>`;\n                        if (event.website) contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">\\u{1F310}</span><span class=\"contact-text\">${event.website}</span></div>`;\n                        contactHTML += '</div>';\n                    }\n                    // Build open to text\n                    let openToText = event.openTo || 'All Members';\n                    if (event.isOpenToGuests) openToText += ' and Invited Guests';\n                    const openBannerHTML = `<div class=\"screensaver-open-banner\">EVENT OPEN TO ${openToText.toUpperCase()}</div>`;\n                    // --- Build the HTML content for the event (RSVP Moved) ---\n                    screensaverContent.innerHTML = `\n                    <div class=\"screensaver-event-layout\">\n                        <div class=\"screensaver-left-column\">\n                            ${imagesHTML || '<div class=\"screensaver-placeholder-image\"></div>'}\n                        </div>\n\n                        <div class=\"screensaver-right-column\">\n                            <div class=\"screensaver-right-column-main-content\">\n                                <img src=\"source/mzansi-court-q-logo.png\" alt=\"Eldoraigne Tennis\" class=\"screensaver-club-logo\">\n\n                                <h1 class=\"screensaver-event-heading\">${event.heading || 'Club Event'}</h1>\n\n                                <div class=\"screensaver-datetime-row\">\n                                    <div class=\"screensaver-date\">\n                                        <div class=\"date-value\">${eventDateFormatted}</div>\n                                    </div>\n                                    ${eventTimeFormatted && eventTimeFormatted !== 'Time TBC' ? `\n                                    <div class=\"screensaver-trophy\"><img src=\"source/tennis-ball.png\" alt=\"Tennis Ball\"></div>\n                                    <div class=\"screensaver-time\">\n                                        <div class=\"time-value\">${eventTimeFormatted} TO CLOSING</div>\n                                    </div>\n                                    ` : ''}\n                                </div>\n\n                                <div class=\"screensaver-body-text\">\n                                    ${event.body1 ? `<p>${event.body1}</p>` : ''}\n                                    ${event.body2 ? `<p>${event.body2}</p>` : ''}\n                                </div>\n\n                                ${costHTML}\n\n                                <button id=\"screensaver-interested-btn\" data-event-id=\"${event.id}\">I am interested</button>\n                            </div>\n\n                            ${rsvpHTML}\n                            ${contactHTML}\n                            ${openBannerHTML}\n                        </div>\n                    </div>\n                `;\n                    // Clear any background images\n                    screensaverContent.style.backgroundImage = 'none';\n                    screensaverContent.style.display = 'flex';\n                    screensaverContent.classList.add('visible');\n                    isShowingScreensaverEvent = false;\n                } else {\n                    // --- SHOW MAIN APP VIEW (Logic Unchanged) ---\n                    screensaverContent.style.display = 'none';\n                    screensaverContent.classList.remove('visible');\n                    screensaverOverlay.classList.add('show-main-app');\n                    isShowingScreensaverEvent = true;\n                    if (activeEvents.length > 0) screensaverCurrentIndex++;\n                }\n            }, 1000);\n        };\n        displayNextScreensaverItem(); // Display the first item immediately\n        screensaverCycleInterval = setInterval(displayNextScreensaverItem, SCREENSAVER_INTERVAL_MS); // Cycle every 15 seconds\n    }\n    function stopScreensaver() {\n        if (screensaverOverlay.classList.contains('hidden')) return; // Already stopped\n        console.log(\"Stopping screensaver...\");\n        screensaverOverlay.classList.add('hidden'); // Fade out overlay\n        screensaverContent.classList.remove('visible'); // Hide content immediately\n        screensaverOverlay.classList.remove('show-main-app'); // Reset view class\n        screensaverContent.style.display = 'flex'; // Reset display for next time\n        screensaverContent.style.backgroundImage = 'none'; // Clear background images\n        if (screensaverCycleInterval) {\n            clearInterval(screensaverCycleInterval);\n            screensaverCycleInterval = null;\n        }\n        resetInactivityTimer(); // Start monitoring inactivity again\n    }\n    // --- NEW FUNCTION: Add player to event interest list ---\n    function addInterestedPlayer(playerName, eventId) {\n        if (!playerName || !eventId) return;\n        // Find the event in the state\n        const event = state.events.find((ev)=>ev.id == eventId); // Use == for potential type coercion if IDs are numbers/strings\n        if (event) {\n            // Initialize interestedPlayers array if it doesn't exist\n            event.interestedPlayers = event.interestedPlayers || [];\n            // Add player name if not already in the list\n            if (!event.interestedPlayers.includes(playerName)) {\n                event.interestedPlayers.push(playerName);\n                saveState();\n                console.log(`${playerName} added to interest list for event ID ${eventId}`);\n            // Optional: Brief confirmation feedback\n            // playCustomTTS(`${getPronounceableName(playerName)} added to interest list.`);\n            } else console.log(`${playerName} is already on the interest list for event ID ${eventId}`);\n        } else console.error(\"Could not find event with ID:\", eventId);\n        // Close the check-in modal and clean up context/styling\n        checkInModal.classList.add(\"hidden\");\n        checkInModal.style.zIndex = ''; // Reset z-index\n        delete checkInModal.dataset.screensaverEventId; // Remove context\n    }\n    // --- END NEW FUNCTION ---\n    // --- NEW FUNCTION: Show Event List Modal ---\n    // --- NEW FUNCTION: Delete Event with Confirmation ---\n    function deleteEvent(eventId) {\n        const event = state.events.find((ev)=>ev.id == eventId);\n        if (!event) return;\n        const eventName = event.heading || 'this event';\n        const confirmDelete = confirm(`Are you sure you want to delete \"${eventName}\"?\\n\\nThis action cannot be undone.`);\n        if (confirmDelete) {\n            // Remove the event from state\n            state.events = state.events.filter((ev)=>ev.id != eventId);\n            saveState();\n            // Refresh the event list display\n            showEventListModal();\n            // If screensaver is running and this was an active event, refresh it\n            const screensaverOverlay = document.getElementById('screensaver-overlay');\n            if (!screensaverOverlay.classList.contains('hidden')) {\n                stopScreensaver();\n                resetInactivityTimer();\n            }\n        }\n    }\n    // --- END NEW FUNCTION ---\n    function showEventListModal() {\n        // Find or create the necessary elements if not already done\n        const eventList = document.getElementById('event-list');\n        const eventListModal = document.getElementById('event-list-modal');\n        if (!eventList || !eventListModal) return; // Basic safety check\n        eventList.innerHTML = ''; // Clear previous list\n        if (state.events.length === 0) eventList.innerHTML = '<li style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No events created yet.</li>';\n        else {\n            // Sort events, maybe newest first? (Optional)\n            const sortedEvents = [\n                ...state.events\n            ].sort((a, b)=>(b.eventDate || '').localeCompare(a.eventDate || '') || b.id - a.id);\n            sortedEvents.forEach((event)=>{\n                const li = document.createElement('li');\n                li.className = 'event-list-item';\n                li.dataset.eventId = event.id; // Store event ID\n                const eventDateStr = event.eventDate ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString('en-ZA', {\n                    year: 'numeric',\n                    month: 'short',\n                    day: 'numeric'\n                }) : 'Date TBC';\n                li.innerHTML = `\n                    <div class=\"event-summary\">\n                        <span class=\"event-heading\">${event.heading || 'Untitled Event'}</span>\n                        <span class=\"event-date\">${eventDateStr}</span>\n                    </div>\n                    <div class=\"event-controls\">\n                        <button class=\"action-btn edit-event-btn\" data-action=\"edit\">Edit</button>\n                        <span class=\"action-icon remove delete-event-btn\" data-action=\"delete\" title=\"Delete Event\">&times;</span>\n                        <label class=\"switch\" title=\"Show in Screensaver\">\n                            <input type=\"checkbox\" class=\"event-active-toggle\" ${event.isActive ? 'checked' : ''}>\n                            <span class=\"slider\"></span>\n                        </label>\n                    </div>\n                `;\n                eventList.appendChild(li);\n            });\n        }\n        adminSettingsModal.classList.add('hidden'); // Hide admin settings\n        eventListModal.classList.remove('hidden'); // Show event list\n    }\n    // --- END NEW FUNCTION ---\n    // --- NEW FUNCTION: Load available screensaver images ---\n    async function loadScreensaverImages() {\n        try {\n            // Try to load images.json file first (recommended method)\n            const response = await fetch('source/screensaver/images.json');\n            if (response.ok) {\n                const data = await response.json();\n                if (data.images && Array.isArray(data.images) && data.images.length > 0) {\n                    console.log('Loaded images from images.json:', data.images);\n                    return [\n                        'None',\n                        ...data.images\n                    ];\n                }\n            }\n        } catch (error) {\n            console.log('images.json not found, trying directory listing...');\n        }\n        // Fallback: Try directory listing (may not work on all servers)\n        try {\n            const response = await fetch('source/screensaver/');\n            if (response.ok) {\n                const text = await response.text();\n                const imageRegex = /<a href=\"([^\"]+\\.(?:jpg|jpeg|png|gif|webp))\"/gi;\n                const matches = [\n                    ...text.matchAll(imageRegex)\n                ];\n                const images = matches.map((match)=>match[1]);\n                if (images.length > 0) {\n                    console.log('Loaded images from directory listing:', images);\n                    return [\n                        'None',\n                        ...images\n                    ];\n                }\n            }\n        } catch (error) {\n            console.log('Directory listing not available');\n        }\n        // Final fallback: Return default list\n        console.warn('Using default image list - please create source/screensaver/images.json');\n        return [\n            'None',\n            'Trophy.jpg',\n            'Potjiekos.jpg',\n            'Tennis.jpg',\n            'Braai.jpg',\n            'Rugby.jpg',\n            'F1.jpg',\n            'ClubChamps.jpg'\n        ];\n    }\n    // --- NEW FUNCTION: Populate image dropdowns ---\n    async function populateImageDropdowns() {\n        const images = await loadScreensaverImages();\n        const dropdown1 = document.getElementById('event-image1');\n        const dropdown2 = document.getElementById('event-image2');\n        if (dropdown1 && dropdown2) {\n            // Save current selections\n            const currentValue1 = dropdown1.value;\n            const currentValue2 = dropdown2.value;\n            // Clear and repopulate\n            dropdown1.innerHTML = '';\n            dropdown2.innerHTML = '';\n            images.forEach((img)=>{\n                const option1 = document.createElement('option');\n                option1.value = img;\n                option1.textContent = img === 'None' ? 'None' : img.replace(/\\.[^.]+$/, ''); // Remove extension for display\n                dropdown1.appendChild(option1);\n                const option2 = document.createElement('option');\n                option2.value = img;\n                option2.textContent = img === 'None' ? 'None' : img.replace(/\\.[^.]+$/, '');\n                dropdown2.appendChild(option2);\n            });\n            // Restore selections if they still exist\n            if ([\n                ...dropdown1.options\n            ].some((opt)=>opt.value === currentValue1)) dropdown1.value = currentValue1;\n            if ([\n                ...dropdown2.options\n            ].some((opt)=>opt.value === currentValue2)) dropdown2.value = currentValue2;\n        }\n    }\n    // --- END NEW FUNCTIONS ---\n    // --- NEW/MODIFIED FUNCTION: Show Event Create/Edit Modal ---\n    async function showEventCreateEditModal(eventId = null) {\n        const modal = document.getElementById('event-create-edit-modal');\n        // Populate image dropdowns with available files\n        await populateImageDropdowns();\n        const title = document.getElementById('event-modal-title');\n        const form = modal.querySelector('.event-form-grid');\n        const interestedSection = document.getElementById('interested-players-section');\n        const interestedList = document.getElementById('interested-players-list');\n        // Reset form fields\n        form.querySelectorAll('input, select').forEach((el)=>{\n            if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;\n            else if (el.type === 'range') el.value = el.min || 0; // Reset sliders to min\n            else el.value = '';\n        });\n        // Reset specific defaults\n        document.getElementById('event-type').value = 'Social';\n        document.querySelector('input[name=\"event-open-to\"][value=\"All Members\"]').checked = true;\n        document.getElementById('event-image1').value = 'None';\n        document.getElementById('event-image2').value = 'None';\n        // Clear interested list\n        interestedList.innerHTML = '';\n        interestedSection.style.display = 'none';\n        if (eventId) {\n            // --- EDIT MODE ---\n            const event = state.events.find((ev)=>ev.id == eventId);\n            if (!event) {\n                console.error(\"Event not found for editing:\", eventId);\n                // Optionally show event list modal again or an error\n                showEventListModal();\n                return;\n            }\n            modal.dataset.editingEventId = eventId; // Store ID for saving\n            title.textContent = 'Edit Event';\n            // Populate form fields\n            document.getElementById('event-type').value = event.eventType || 'Social';\n            document.getElementById('event-heading').value = event.heading || '';\n            document.getElementById('event-date').value = event.eventDate || '';\n            document.getElementById('event-rsvp-date').value = event.rsvpDate || '';\n            document.getElementById('event-start-time').value = event.startTime || '';\n            document.getElementById('event-body1').value = event.body1 || '';\n            document.getElementById('event-body2').value = event.body2 || '';\n            document.getElementById('event-cost-adult').value = event.costAdult || 0;\n            document.getElementById('event-cost-child').value = event.costChild || 0;\n            document.getElementById('event-participation-discount').value = event.participationDiscount || event.participationDiscountPercent || 0;\n            document.getElementById('event-volunteers').checked = event.volunteersNeeded || false;\n            document.getElementById('event-phone').value = event.phone || '';\n            document.getElementById('event-email').value = event.email || '';\n            document.getElementById('event-website').value = event.website || '';\n            const openToRadio = form.querySelector(`input[name=\"event-open-to\"][value=\"${event.openTo || 'All Members'}\"]`);\n            if (openToRadio) openToRadio.checked = true;\n            document.getElementById('event-open-guests').checked = event.isOpenToGuests || false;\n            document.getElementById('event-image1').value = event.image1Filename || 'None';\n            document.getElementById('event-image2').value = event.image2Filename || 'None';\n            // Populate Interested Players List\n            event.interestedPlayers = event.interestedPlayers || []; // Ensure array exists\n            if (event.interestedPlayers.length > 0) {\n                event.interestedPlayers.forEach((playerName)=>{\n                    const li = document.createElement('li');\n                    li.innerHTML = `\n                        <span>${playerName}</span>\n                        <span class=\"action-icon remove\" data-player-name=\"${playerName}\" title=\"Remove player\">&times;</span>\n                    `;\n                    interestedList.appendChild(li);\n                });\n                interestedSection.style.display = 'block'; // Show the section\n            } else {\n                interestedList.innerHTML = '<li style=\"color: var(--neutral-color); justify-content: center;\">No players currently interested.</li>';\n                interestedSection.style.display = 'block'; // Still show section, but with message\n            }\n        } else {\n            // --- CREATE MODE ---\n            delete modal.dataset.editingEventId; // Ensure no ID is stored\n            title.textContent = 'Create New Event';\n            interestedSection.style.display = 'none'; // Hide interested list\n        }\n        // Update slider display values\n        updateAllSliderDisplays();\n        modal.classList.remove('hidden');\n    }\n    // --- END NEW/MODIFIED FUNCTION ---\n    // --- NEW HELPER: Update Slider Value Displays ---\n    function updateSliderDisplay(sliderId) {\n        const slider = document.getElementById(sliderId);\n        const displaySpan = slider.previousElementSibling?.querySelector('.slider-value'); // Find span in label before slider\n        if (!slider || !displaySpan) return;\n        let prefix = '';\n        let suffix = '';\n        if (sliderId.includes('cost')) prefix = 'R';\n        if (sliderId.includes('discount')) suffix = '%';\n        displaySpan.textContent = `${prefix}${slider.value}${suffix}`;\n    }\n    // --- NEW HELPER: Update All Sliders ---\n    function updateAllSliderDisplays() {\n        updateSliderDisplay('event-cost-adult');\n        updateSliderDisplay('event-cost-child');\n        updateSliderDisplay('event-participation-discount');\n    }\n    // --- END NEW HELPERS ---\n    // --- NEW FUNCTION: Remove player from interest list (Admin) ---\n    function removeInterestedPlayer(playerName, eventId) {\n        if (!playerName || !eventId) return;\n        const event = state.events.find((ev)=>ev.id == eventId);\n        if (event && event.interestedPlayers) {\n            const initialLength = event.interestedPlayers.length;\n            event.interestedPlayers = event.interestedPlayers.filter((p)=>p !== playerName);\n            if (event.interestedPlayers.length < initialLength) {\n                saveState();\n                // Re-render just the interested list within the modal\n                const interestedList = document.getElementById('interested-players-list');\n                interestedList.innerHTML = ''; // Clear\n                if (event.interestedPlayers.length > 0) event.interestedPlayers.forEach((pName)=>{\n                    const li = document.createElement('li');\n                    li.innerHTML = `\n                            <span>${pName}</span>\n                            <span class=\"action-icon remove\" data-player-name=\"${pName}\" title=\"Remove player\">&times;</span>\n                         `;\n                    interestedList.appendChild(li);\n                });\n                else interestedList.innerHTML = '<li style=\"color: var(--neutral-color); justify-content: center;\">No players currently interested.</li>';\n                console.log(`${playerName} removed from interest list for event ID ${eventId}`);\n            }\n        }\n    }\n    // --- END NEW FUNCTION ---\n    // --- NEW FUNCTION: Save Event (Create or Update) ---\n    function saveEvent() {\n        const modal = document.getElementById('event-create-edit-modal');\n        const eventIdToEdit = modal.dataset.editingEventId;\n        const isEditing = !!eventIdToEdit;\n        // --- Gather data from form fields ---\n        const eventType = document.getElementById('event-type').value;\n        const heading = document.getElementById('event-heading').value.trim();\n        const eventDate = document.getElementById('event-date').value;\n        const rsvpDate = document.getElementById('event-rsvp-date').value;\n        const startTime = document.getElementById('event-start-time').value;\n        const body1 = document.getElementById('event-body1').value.trim();\n        const body2 = document.getElementById('event-body2').value.trim();\n        const costAdult = parseInt(document.getElementById('event-cost-adult').value, 10) || 0;\n        const costChild = parseInt(document.getElementById('event-cost-child').value, 10) || 0;\n        let participationDiscountPercent = 0;\n        if (eventType === 'Club Champs' || eventType === 'League') participationDiscountPercent = parseInt(document.getElementById('event-participation-discount').value, 10) || 0;\n        const volunteersNeeded = document.getElementById('event-volunteers').checked;\n        const phone = document.getElementById('event-phone').value.trim();\n        const email = document.getElementById('event-email').value.trim();\n        const website = document.getElementById('event-website').value.trim();\n        const openToRadio = modal.querySelector('input[name=\"event-open-to\"]:checked');\n        const openTo = openToRadio ? openToRadio.value : 'All Members'; // Default if none selected\n        const isOpenToGuests = document.getElementById('event-open-guests').checked;\n        const image1Filename = document.getElementById('event-image1').value;\n        const image2Filename = document.getElementById('event-image2').value;\n        // Basic Validation (e.g., heading is required)\n        if (!heading) {\n            alert(\"Please enter an Event Heading.\");\n            return; // Stop saving\n        }\n        if (!eventDate) {\n            alert(\"Please select an Event Date.\");\n            return;\n        }\n        // --- Create or Update Event Object ---\n        let eventData = {\n            eventType,\n            heading,\n            eventDate,\n            rsvpDate,\n            startTime,\n            body1,\n            body2,\n            costAdult,\n            costChild,\n            participationDiscountPercent,\n            participationDiscount: parseInt(document.getElementById('event-participation-discount').value, 10) || 0,\n            volunteersNeeded,\n            phone,\n            email,\n            website,\n            openTo,\n            isOpenToGuests,\n            image1Filename,\n            image2Filename\n        };\n        if (isEditing) {\n            // Find existing event and update it\n            const eventIndex = state.events.findIndex((ev)=>ev.id == eventIdToEdit);\n            if (eventIndex > -1) {\n                // Merge new data, preserving ID, active status, and interested players\n                state.events[eventIndex] = {\n                    ...state.events[eventIndex],\n                    ...eventData // Overwrite with new form data\n                };\n                console.log(\"Event updated:\", eventIdToEdit);\n            } else {\n                console.error(\"Failed to find event to update:\", eventIdToEdit);\n                return; // Stop if event not found\n            }\n        } else {\n            // Create new event\n            eventData.id = Date.now(); // Generate unique ID\n            eventData.isActive = false; // New events default to inactive\n            eventData.interestedPlayers = []; // Initialize empty interest list\n            state.events.push(eventData);\n            console.log(\"New event created:\", eventData.id);\n        }\n        // --- Finish Up ---\n        saveState(); // Save the updated events array\n        modal.classList.add('hidden'); // Hide the create/edit modal\n        showEventListModal(); // Show the updated event list\n        // If screensaver is running, stop and reset to reflect potential changes\n        if (!screensaverOverlay.classList.contains('hidden')) {\n            stopScreensaver();\n            resetInactivityTimer();\n        }\n    }\n    // --- END NEW FUNCTION ---\n    function resetInactivityTimer() {\n        // Always clear any existing timer first\n        clearTimeout(inactivityTimer);\n        inactivityTimer = null; // Clear the timer ID\n        // Check if there are any active events\n        const hasActiveEvents = state.events.some((event)=>event.isActive);\n        // Only start the inactivity timer if there's at least one active event\n        // AND we are not on mobile (screensaver disabled on mobile)\n        if (hasActiveEvents && window.innerWidth > 900) // console.log(\"Resetting inactivity timer (active events found)...\"); // Optional logging\n        // Set the timeout again for 5 minutes (INACTIVITY_TIMEOUT_MS is already defined as 5 * 60 * 1000)\n        inactivityTimer = setTimeout(startScreensaver, INACTIVITY_TIMEOUT_MS);\n        else // console.log(\"Inactivity timer NOT reset (no active events or mobile view).\"); // Optional logging\n        // Ensure screensaver is stopped if it somehow got started without active events\n        stopScreensaver(); // Call stopScreensaver here to ensure it's hidden if conditions aren't met\n    }\n    // --- END: Screensaver Functions ---\n    // --- NEW: Screensaver Activity Listeners ---\n    document.addEventListener('click', resetInactivityTimer);\n    document.addEventListener('touchstart', resetInactivityTimer);\n    document.addEventListener('mousemove', resetInactivityTimer);\n    document.addEventListener('keydown', resetInactivityTimer);\n    // Call it once on load to start the timer initially if conditions are met\n    resetInactivityTimer();\n    /* =================================\r\n        END Screensaver FUNCTIONS (NEW)\r\n    ================================= */ function renderReorderHistory() {\n        reorderHistoryList.innerHTML = \"\";\n        if (state.reorderHistory.length === 0) {\n            reorderHistoryList.innerHTML = '<p style=\"text-align: center; color: #6c757d; padding: 2rem;\">No queue reorder actions have been logged.</p>';\n            return;\n        }\n        // Iterate through history, newest first\n        [\n            ...state.reorderHistory\n        ].reverse().forEach((entry)=>{\n            const dateTime = new Date(entry.endTime).toLocaleString();\n            let playersHtml = '';\n            // Iterate through players involved in this session\n            for (const [name, log] of Object.entries(entry.players))// Only display players who actually moved (start position !== current position)\n            if (log.startPosition !== log.currentPosition) playersHtml += `\n                        <p style=\"margin: 0.25rem 0; font-size: 0.95rem; display: flex; justify-content: space-between;\">\n                            <span style=\"font-weight: 500;\">${name}</span>\n                            <span style=\"color: var(--primary-blue);\">Moved from #${log.startPosition + 1} to #${log.currentPosition + 1}</span>\n                        </p>\n                    `;\n            // Only render the entry if at least one player moved\n            if (playersHtml) {\n                const details = document.createElement('div');\n                details.className = 'history-item';\n                details.style.textAlign = 'left';\n                details.innerHTML = `\n                    <div class=\"history-details\" style=\"margin-bottom: 0.75rem;\">\n                        <span style=\"color: var(--primary-blue);\">${entry.adminAction} (${dateTime})</span>\n                    </div>\n                    <div style=\"padding-left: 1rem;\">\n                        ${playersHtml}\n                    </div>\n                `;\n                reorderHistoryList.appendChild(details);\n            }\n        });\n    }\n    // --- ADMIN MANAGEMENT FUNCTIONS (REFACTORED FOR 3-CARD FLOW) ---\n    // Card 1: Court Selection View\n    function showCourtSelectionCard() {\n        const { adminCourtManagement } = state;\n        // Reset temporary state and mode\n        adminCourtManagement.mode = 'card1_select_court';\n        adminCourtManagement.courtId = null;\n        adminCourtManagement.currentCourtPlayers = [];\n        adminCourtManagement.removedPlayers = [];\n        adminCourtManagement.addedPlayers = [];\n        document.getElementById('manage-court-players-instructions').textContent = \"Select a court with an active game.\";\n        // Set data attribute for CSS\n        manageModalActions.dataset.cardMode = 'card1';\n        // Show Card 1 list, hide Card 2 & 3 lists\n        courtListForManagement.classList.remove('hidden');\n        removePlayersList.classList.add('hidden');\n        addPlayersList.classList.add('hidden');\n        // Button visibility for Card 1\n        managePlayersBackBtn.classList.add('hidden');\n        managePlayersAddBtn.classList.add('hidden');\n        managePlayersConfirmBtn.classList.add('hidden');\n        managePlayersCloseBtn.textContent = 'Close';\n        courtListForManagement.innerHTML = '';\n        const activeCourts = state.courts.filter((c)=>c.status === 'in_progress' && state.courtSettings.visibleCourts.includes(c.id));\n        if (activeCourts.length === 0) courtListForManagement.innerHTML = '<li style=\"justify-content: center; color: #6c757d;\">No games are currently in progress on visible courts.</li>';\n        else activeCourts.forEach((court)=>{\n            const li = document.createElement('li');\n            li.className = 'court-select-item';\n            const playerNames = getPlayerNames(court.players).map((name)=>name.split(' ')[0]).join(' / ');\n            li.innerHTML = `\n                    <span style=\"flex-grow: 1;\">Court ${court.id}</span>\n                    <span style=\"margin-right: 1rem; color: #6c757d; font-size: 0.9em;\">(${playerNames})</span>\n                    <span class=\"action-icon add\" data-court-id=\"${court.id}\" data-action=\"select-court\" style=\"font-size: 1.2rem;\">&gt;</span>\n                `;\n            courtListForManagement.appendChild(li);\n        });\n        adminSettingsModal.classList.add('hidden');\n        manageCourtPlayersModal.classList.remove('hidden');\n    }\n    // Original entry point, now just calls Card 1 function\n    function showManageCourtPlayersModal(courtId1) {\n        // 1. Safety check for any pending additions from a previous unfinished session\n        const { addedPlayers } = state.adminCourtManagement;\n        if (addedPlayers.length > 0) {\n            state.availablePlayers = [\n                ...addedPlayers,\n                ...state.availablePlayers\n            ];\n            state.adminCourtManagement.addedPlayers = [];\n        }\n        // 2. Clear any old state before starting\n        state.adminCourtManagement = {\n            mode: 'card1_select_court',\n            courtId: null,\n            currentCourtPlayers: [],\n            removedPlayers: [],\n            addedPlayers: []\n        };\n        // 3. Directly call the function to show the \"Remove Players\" card\n        showRemovePlayerCard(courtId1);\n        // 4. Show the main modal container\n        manageCourtPlayersModal.classList.remove('hidden');\n    }\n    // Card 2: Remove Player View\n    function showRemovePlayerCard(courtId1) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court || court.status !== 'in_progress') return showCourtSelectionCard();\n        const { adminCourtManagement } = state;\n        // Initialize/switch to Card 2 mode\n        adminCourtManagement.mode = 'card2_remove_players';\n        adminCourtManagement.courtId = courtId1;\n        // If coming from Card 1 (no players loaded yet), set the initial list\n        if (adminCourtManagement.currentCourtPlayers.length === 0) // Deep copy of player objects to manipulate locally\n        adminCourtManagement.currentCourtPlayers = JSON.parse(JSON.stringify(court.players));\n        // Update header text based on game mode\n        const headerText = court.gameMode === 'doubles' ? `Court ${courtId1}: Manage Players` : `Court ${courtId1}: Remove players from the game.`;\n        document.getElementById('manage-court-players-instructions').textContent = headerText;\n        // Add action buttons to the main modal header\n        const modalHeader = manageCourtPlayersModal.querySelector('.modal-header-with-actions h3');\n        if (modalHeader) {\n            // Remove any existing action buttons\n            const existingSwapBtn = manageCourtPlayersModal.querySelector('.header-swap-player-btn');\n            const existingTeamBtn = manageCourtPlayersModal.querySelector('.header-team-select-btn');\n            if (existingSwapBtn) existingSwapBtn.remove();\n            if (existingTeamBtn) existingTeamBtn.remove();\n            // Create button container\n            const buttonContainer = document.createElement('div');\n            buttonContainer.className = 'modal-header-actions';\n            // Add swap player button (always visible for in-progress games)\n            const swapBtn = document.createElement('button');\n            swapBtn.className = 'header-swap-player-btn';\n            swapBtn.title = 'Swap with Player on Another Court';\n            swapBtn.innerHTML = '<i class=\"mdi mdi-account-switch\"></i>';\n            swapBtn.onclick = ()=>{\n                showSwapPlayerModal(courtId1);\n            };\n            buttonContainer.appendChild(swapBtn);\n            // Add team selection button (only for doubles)\n            if (court.gameMode === 'doubles') {\n                const teamSelectBtn = document.createElement('button');\n                teamSelectBtn.className = 'header-team-select-btn';\n                teamSelectBtn.title = court.teamsSet ? 'Reselect Teams' : 'Set Teams';\n                teamSelectBtn.innerHTML = '<i class=\"mdi mdi-account-group-outline\"></i>';\n                teamSelectBtn.onclick = ()=>{\n                    manageCourtPlayersModal.classList.add('hidden');\n                    handleChooseTeams(courtId1, 'in_progress');\n                };\n                buttonContainer.appendChild(teamSelectBtn);\n            }\n            // Append button container to header\n            modalHeader.parentElement.appendChild(buttonContainer);\n        }\n        // Set data attribute for CSS\n        manageModalActions.dataset.cardMode = 'card2';\n        // Hide all lists except Card 2 list\n        courtListForManagement.classList.add('hidden');\n        removePlayersList.classList.remove('hidden');\n        addPlayersList.classList.add('hidden');\n        // Button visibility for Card 2\n        managePlayersBackBtn.classList.remove('hidden'); // Back to Card 1\n        managePlayersAddBtn.classList.remove('hidden'); // Go to Card 3\n        managePlayersConfirmBtn.classList.add('hidden');\n        managePlayersCloseBtn.textContent = 'Close';\n        // Enable/Disable Add Player button based on changes\n        const hasChanges = adminCourtManagement.removedPlayers.length > 0 || adminCourtManagement.addedPlayers.length > 0;\n        managePlayersAddBtn.disabled = !hasChanges;\n        managePlayersAddBtn.style.backgroundColor = hasChanges ? 'var(--confirm-color)' : 'var(--neutral-color)';\n        renderRemovePlayersList(courtId1);\n    }\n    function renderRemovePlayersList(courtId1) {\n        const { currentCourtPlayers, removedPlayers } = state.adminCourtManagement;\n        removePlayersList.innerHTML = '';\n        // 1. Render players still on the court (currentCourtPlayers - removedPlayers)\n        // Find which players are on court (currentCourtPlayers) but NOT in the removed list\n        const playersOnCourt = currentCourtPlayers.filter((p)=>!removedPlayers.some((rp)=>rp.name === p.name));\n        if (playersOnCourt.length === 0 && removedPlayers.length === 0) removePlayersList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No players remaining. Must add players or go back.</li>';\n        else playersOnCourt.forEach((player)=>{\n            const li = document.createElement('li');\n            const displayName = player.guest ? `${player.name} (Guest)` : player.name;\n            li.innerHTML = `\n                    <span style=\"flex-grow: 1;\">${displayName}</span>\n                    <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span>\n                    <span class=\"action-icon remove\" data-player=\"${player.name}\" data-court-id=\"${courtId1}\" data-action=\"remove-player-temp\" title=\"Remove Player\">&times;</span>\n                `;\n            removePlayersList.appendChild(li);\n        });\n        // 2. Render temporary removed players in the main list.\n        if (removedPlayers.length > 0) {\n            removePlayersList.innerHTML += '<li style=\"justify-content: center; background-color: #f0f0f0; margin-top: 1rem; color: var(--dark-text); font-weight: 500;\">Removed Players (Click  to return to court):</li>';\n            removedPlayers.forEach((player)=>{\n                const li = document.createElement('li');\n                li.style.backgroundColor = '#fbe9eb';\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\n                li.innerHTML = `\n                    <span style=\"flex-grow: 1; color: var(--cancel-color); font-weight: 500;\">${displayName}</span>\n                    <span class=\"action-icon add\" data-player=\"${player.name}\" data-court-id=\"${courtId1}\" data-action=\"return-player-temp\" title=\"Keep on Court\">+</span>\n                `;\n                removePlayersList.appendChild(li);\n            });\n        }\n    }\n    // Card 3: Add Player View\n    function showAddPlayerCard(courtId1) {\n        const { adminCourtManagement } = state;\n        // Switch to Card 3 mode\n        adminCourtManagement.mode = 'card3_add_players';\n        document.getElementById('manage-court-players-instructions').textContent = `Court ${courtId1}: Select player(s) to add (Max 7 available).`;\n        // Set data attribute for CSS\n        manageModalActions.dataset.cardMode = 'card3';\n        // Hide all lists except Card 3 list\n        courtListForManagement.classList.add('hidden');\n        removePlayersList.classList.add('hidden');\n        addPlayersList.classList.remove('hidden');\n        // Button visibility for Card 3\n        managePlayersBackBtn.classList.remove('hidden'); // Back to Card 2\n        managePlayersAddBtn.classList.add('hidden');\n        managePlayersConfirmBtn.classList.remove('hidden'); // Confirm button is here\n        managePlayersCloseBtn.textContent = 'Close';\n        renderAddPlayersList(courtId1);\n    }\n    function renderAddPlayersList(courtId1) {\n        const { addedPlayers, removedPlayers } = state.adminCourtManagement;\n        addPlayersList.innerHTML = '';\n        // We'll show the top 7 available players as potential additions.\n        const availableForAdding = state.availablePlayers.slice(0, 7);\n        if (availableForAdding.length === 0) addPlayersList.innerHTML = '<li style=\"justify-content: center; color: #6c757d;\">No players are currently available to add.</li>';\n        else availableForAdding.forEach((player)=>{\n            const isAlreadyAdded = addedPlayers.some((ap)=>ap.name === player.name);\n            const li = document.createElement('li');\n            const displayName = player.guest ? `${player.name} (Guest)` : player.name;\n            if (isAlreadyAdded) {\n                // Style for players who are marked to be added\n                li.style.backgroundColor = 'var(--light-blue)';\n                li.innerHTML = `\n                        <span style=\"flex-grow: 1; color: var(--primary-blue); font-weight: 500;\">${displayName}</span>\n                        <span class=\"action-icon remove\" data-player=\"${player.name}\" data-court-id=\"${courtId1}\" data-action=\"undo-add-player-temp\" title=\"Undo Add\">&times;</span>\n                    `;\n            } else // Style for players who are available to be added\n            li.innerHTML = `\n                        <span style=\"flex-grow: 1;\">${displayName}</span>\n                        <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span>\n                        <span class=\"action-icon add\" data-player=\"${player.name}\" data-court-id=\"${courtId1}\" data-action=\"add-player-temp\" title=\"Add Player\">+</span>\n                    `;\n            addPlayersList.appendChild(li);\n        });\n        // Enable the confirm button only if there are changes to be made\n        const hasChanges = addedPlayers.length > 0 || removedPlayers.length > 0;\n        managePlayersConfirmBtn.disabled = !hasChanges;\n        managePlayersConfirmBtn.style.backgroundColor = hasChanges ? 'var(--confirm-color)' : 'var(--inactive-color)';\n        managePlayersConfirmBtn.style.borderColor = hasChanges ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    // --- Navigation/Action Handlers ---\n    // Handles Close button on Card 1, 2, or 3\n    function handleManageClose() {\n        // Simply reset the temporary state and close the modal.\n        // No players need to be returned to the queue as they were never removed.\n        state.adminCourtManagement = {\n            mode: 'card1_select_court',\n            courtId: null,\n            currentCourtPlayers: [],\n            removedPlayers: [],\n            addedPlayers: []\n        };\n        manageCourtPlayersModal.classList.add('hidden');\n        updateGameModeBasedOnPlayerCount();\n        render();\n        saveState();\n        checkAndPlayAlert(false);\n    }\n    // Handles Back button on Card 2 (to Card 1) or Card 3 (to Card 2)\n    function handleManageBack() {\n        const { mode, courtId: courtId1 } = state.adminCourtManagement;\n        if (mode === 'card2_remove_players') // Back from \"Remove\" to \"Select Court\". All temporary changes are discarded.\n        showCourtSelectionCard();\n        else if (mode === 'card3_add_players') {\n            // Back from \"Add\" to \"Remove\". Discard only the 'added' players list.\n            state.adminCourtManagement.addedPlayers = [];\n            showRemovePlayerCard(courtId1);\n        }\n        updateGameModeBasedOnPlayerCount();\n        render();\n        saveState();\n        checkAndPlayAlert(false);\n    }\n    // Handles Confirm button on Card 3 (Final Save)\n    function handleManageConfirm() {\n        const { courtId: courtId1, removedPlayers, addedPlayers } = state.adminCourtManagement;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court || court.status !== 'in_progress') return handleManageClose();\n        // (Position-Aware Swap Logic and Queue Swap Logic remain the same...)\n        let newCourtPlayers = [\n            ...court.players\n        ];\n        const removedPlayerNames = new Set(removedPlayers.map((p)=>p.name));\n        let playersToAdd = [\n            ...addedPlayers\n        ];\n        const vacantIndices = [];\n        newCourtPlayers.forEach((player, index)=>{\n            if (removedPlayerNames.has(player.name)) vacantIndices.push(index);\n        });\n        vacantIndices.forEach((index)=>{\n            if (playersToAdd.length > 0) newCourtPlayers[index] = playersToAdd.shift();\n            else newCourtPlayers[index] = null;\n        });\n        newCourtPlayers = newCourtPlayers.filter((p)=>p !== null);\n        if (playersToAdd.length > 0) newCourtPlayers.push(...playersToAdd);\n        let playersToRequeueInQueue = [\n            ...removedPlayers\n        ];\n        const addedPlayerNamesInQueue = new Set(addedPlayers.map((p)=>p.name));\n        let newAvailablePlayers = state.availablePlayers.map((playerInQueue)=>{\n            if (addedPlayerNamesInQueue.has(playerInQueue.name)) {\n                if (playersToRequeueInQueue.length > 0) return playersToRequeueInQueue.shift();\n                else return null;\n            }\n            return playerInQueue;\n        });\n        newAvailablePlayers = newAvailablePlayers.filter((p)=>p !== null);\n        if (playersToRequeueInQueue.length > 0) newAvailablePlayers.push(...playersToRequeueInQueue);\n        state.availablePlayers = newAvailablePlayers;\n        // --- UPDATED ANNOUNCEMENT LOGIC ---\n        const newGameMode = newCourtPlayers.length === 2 ? 'singles' : 'doubles';\n        // Use the new helper function here\n        const formattedCourtId = formatCourtIdForTTS(courtId1);\n        if (newCourtPlayers.length < 2) {\n            if (court.autoStartTimer) clearTimeout(court.autoStartTimer);\n            state.availablePlayers.push(...court.players.filter((p)=>!p.guest));\n            court.becameAvailableAt = Date.now();\n            court.status = \"available\";\n            court.players = [];\n            court.teams = {\n                team1: [],\n                team2: []\n            };\n            court.gameMode = null;\n            court.gameStartTime = null;\n            playCustomTTS(`Attention: Game on Court ${formattedCourtId} has been cancelled due to insufficient players.`);\n        } else {\n            court.gameMode = newGameMode;\n            court.players = newCourtPlayers;\n            if (newGameMode === 'singles') {\n                court.teams.team1 = [\n                    newCourtPlayers[0]\n                ];\n                court.teams.team2 = [\n                    newCourtPlayers[1]\n                ];\n            } else {\n                const teamSize = Math.ceil(newCourtPlayers.length / 2);\n                court.teams.team1 = newCourtPlayers.slice(0, teamSize);\n                court.teams.team2 = newCourtPlayers.slice(teamSize);\n            }\n            const removedNamesStr = removedPlayers.map((p)=>p.name).join(' and ');\n            const addedNamesStr = addedPlayers.map((p)=>p.name).join(' and ');\n            let announcementPart1 = `Attention on Court ${formattedCourtId}. Player substitution complete.`;\n            let announcementPart2 = null;\n            if (removedPlayers.length > 0 && addedPlayers.length > 0) announcementPart2 = `${addedNamesStr} will be filling in for ${removedNamesStr}.`;\n            else if (removedPlayers.length > 0) announcementPart1 = `Attention on Court ${formattedCourtId}: ${removedNamesStr} have left the game.`;\n            else if (addedPlayers.length > 0) announcementPart1 = `Attention on Court ${formattedCourtId}: ${addedNamesStr} have joined the game.`;\n            playAlertSound(announcementPart1, announcementPart2);\n        }\n        // --- END UPDATED LOGIC ---\n        state.adminCourtManagement = {\n            mode: 'card1_select_court',\n            courtId: null,\n            currentCourtPlayers: [],\n            removedPlayers: [],\n            addedPlayers: []\n        };\n        manageCourtPlayersModal.classList.add('hidden');\n        updateGameModeBasedOnPlayerCount();\n        enforceDutyPosition();\n        autoAssignCourtModes();\n        render();\n        saveState();\n        resetAlertSchedule();\n        checkAndPlayAlert(false);\n    }\n    function handleKeypadClick(e) {\n        const key = e.target.dataset.key;\n        const { mode, maxLength, maxValue } = keypadConfig;\n        let displayValue = mode === 'admin' || mode === 'reset' || mode === 'undo' ? keypadDisplay.dataset.hiddenValue || '' : keypadDisplay.textContent;\n        if (e.target.id === 'keypad-confirm-btn') {\n            if (e.target.disabled) return;\n            switch(mode){\n                case 'admin':\n                    checkAdminPasscode();\n                    break;\n                case 'reset':\n                    checkResetPasscode();\n                    break;\n                case 'undo':\n                    checkUndoPasscode();\n                    break;\n                case 'addStock':\n                    confirmBallStockUpdate();\n                    break;\n                case 'returnStock':\n                    confirmBallStockReturn();\n                    break;\n                case 'returnUsed':\n                    confirmUsedBallReturn();\n                    break;\n                case 'signOut':\n                    confirmSignOutQuantity();\n                    break;\n                default:\n                    if (activeInput && activeInput.classList.contains('reorder-position')) handleReorderPositionChange(keypadDisplay.textContent);\n                    else if (activeInput) activeInput.dispatchEvent(new Event('input'));\n                    hideKeypad();\n                    break;\n            }\n            return;\n        }\n        if (key === 'backspace') displayValue = displayValue.slice(0, -1);\n        else if (key === 'clear') displayValue = '';\n        else if (/[0-9]/.test(key)) {\n            if (maxLength && displayValue.length >= maxLength) return;\n            const potentialValue = displayValue + key;\n            if (maxValue !== undefined && parseInt(potentialValue, 10) > maxValue) return;\n            displayValue += key;\n        }\n        if (mode === 'admin' || mode === 'reset' || mode === 'undo') {\n            keypadDisplay.dataset.hiddenValue = displayValue;\n            keypadDisplay.textContent = '*'.repeat(displayValue.length);\n        } else {\n            keypadDisplay.textContent = displayValue;\n            if (activeInput && !activeInput.classList.contains('reorder-position')) {\n                activeInput.value = displayValue;\n                activeInput.dispatchEvent(new Event('input'));\n            }\n        }\n        keypadConfirmBtn.disabled = displayValue.length === 0;\n    }\n    // MODIFIED: Added data-mode to display and adjusted placeholder logic for admin mode\n    function showKeypad(input, config = {}) {\n        activeInput = input;\n        keypadConfig = config;\n        const { mode, title } = config;\n        keypadDisplay.textContent = '';\n        delete keypadDisplay.dataset.hiddenValue;\n        if (mode === 'admin' || mode === 'reset' || mode === 'undo') {\n            keypadDisplay.setAttribute('data-mode', mode);\n            // Don't show placeholder for undo mode\n            if (mode === 'undo') keypadDisplay.removeAttribute('data-placeholder');\n            else keypadDisplay.setAttribute('data-placeholder', title || 'Enter PIN');\n            keypadCancelBtn.classList.remove('hidden');\n            keypadConfirmBtn.classList.remove('wide-full');\n            keypadConfirmBtn.classList.add('wide-half');\n        } else {\n            keypadDisplay.removeAttribute('data-mode');\n            if (title) keypadDisplay.setAttribute('data-placeholder', title);\n            else keypadDisplay.removeAttribute('data-placeholder');\n            keypadCancelBtn.classList.add('hidden');\n            keypadConfirmBtn.classList.remove('wide-half');\n            keypadConfirmBtn.classList.add('wide-full');\n        }\n        customKeypadModal.classList.remove('hidden');\n        keypadConfirmBtn.disabled = keypadDisplay.textContent.length === 0;\n    }\n    function hideKeypad() {\n        customKeypadModal.classList.add('hidden');\n        keypadConfig = {};\n        activeInput = null;\n    }\n    function wireScoreInputToKeypad(input, config = {}) {\n        input.readOnly = true;\n        // Remove any old listener attached to this input to prevent duplicates\n        if (input._keypadListener) input.removeEventListener('click', input._keypadListener);\n        // Define the new listener with the current game's rules\n        const newListener = (e)=>{\n            e.preventDefault(); // Prevent native keyboards on mobile\n            showKeypad(e.target, config);\n        };\n        // Add the new listener\n        input.addEventListener('click', newListener);\n        // Store a reference to the new listener so it can be removed later\n        input._keypadListener = newListener;\n    }\n    // --- ALPHA KEYPAD CORE DATA (Required for alphabetical input) ---\n    const QWERTY_LAYOUT = [\n        [\n            'Q',\n            'W',\n            'E',\n            'R',\n            'T',\n            'Y',\n            'U',\n            'I',\n            'O',\n            'P'\n        ],\n        [\n            'A',\n            'S',\n            'D',\n            'F',\n            'G',\n            'H',\n            'J',\n            'K',\n            'L'\n        ],\n        [\n            'Z',\n            'X',\n            'C',\n            'V',\n            'B',\n            'N',\n            'M'\n        ]\n    ];\n    function generateAlphaKeypad() {\n        const displayValue = alphaKeypadDisplay.textContent;\n        alphaKeypadGrid.innerHTML = '';\n        QWERTY_LAYOUT.forEach((row, index)=>{\n            const rowDiv = document.createElement('div');\n            rowDiv.className = `key-row-${index + 1}`;\n            row.forEach((key)=>{\n                const button = document.createElement('button');\n                button.className = 'keypad-btn';\n                button.dataset.key = key;\n                let char = key;\n                if (displayValue.length === 0 || displayValue.slice(-1) === ' ') char = key.toUpperCase();\n                else char = key.toLowerCase();\n                button.textContent = char;\n                rowDiv.appendChild(button);\n            });\n            alphaKeypadGrid.appendChild(rowDiv);\n        });\n        const lastRowDiv = document.createElement('div');\n        lastRowDiv.className = `key-row-4`;\n        const spaceBtn = document.createElement('button');\n        spaceBtn.className = 'keypad-btn wide-control control';\n        spaceBtn.dataset.key = 'space';\n        spaceBtn.textContent = 'Space';\n        lastRowDiv.appendChild(spaceBtn);\n        const backspace = document.createElement('button');\n        backspace.className = 'keypad-btn control';\n        backspace.dataset.key = 'backspace';\n        backspace.textContent = \"\\u232B\";\n        lastRowDiv.appendChild(backspace);\n        const done = document.createElement('button');\n        done.className = 'keypad-btn wide-control confirm';\n        done.id = 'alpha-keypad-confirm-btn';\n        done.textContent = 'Done';\n        lastRowDiv.appendChild(done);\n        alphaKeypadGrid.appendChild(lastRowDiv);\n        document.querySelectorAll('#custom-alpha-keypad-modal .keypad-btn').forEach((button)=>{\n            button.removeEventListener('click', handleAlphaKeypadClick);\n            button.addEventListener('click', handleAlphaKeypadClick);\n        });\n    }\n    function handleAlphaKeypadClick(e) {\n        const key = e.target.dataset.key;\n        let displayValue = alphaKeypadDisplay.textContent;\n        if (!activeAlphaInput) return;\n        if (key === 'backspace') displayValue = displayValue.slice(0, -1);\n        else if (key === 'space') {\n            if (displayValue.length > 0 && displayValue.slice(-1) !== ' ') displayValue += ' ';\n        } else if (e.target.id === 'alpha-keypad-confirm-btn') {\n            hideAlphaKeypad();\n            return;\n        } else {\n            let char = key;\n            if (displayValue.length === 0 || displayValue.slice(-1) === ' ') char = key.toUpperCase();\n            else char = key.toLowerCase();\n            displayValue += char;\n        }\n        alphaKeypadDisplay.textContent = displayValue;\n        activeAlphaInput.value = displayValue;\n        generateAlphaKeypad();\n        // --- FIX: Manually dispatch 'input' event to trigger listeners (autofill & validation) ---\n        if (activeAlphaInput.closest('#new-parent-modal')) activeAlphaInput.dispatchEvent(new Event('input'));\n        // --- END FIX ---\n        validateGuestForm();\n    }\n    function showAlphaKeypad(input) {\n        activeAlphaInput = input;\n        alphaKeypadDisplay.textContent = activeAlphaInput.value;\n        generateAlphaKeypad();\n        customAlphaKeypadModal.classList.remove('hidden');\n        guestNameModal.classList.add('hidden');\n        // Check if the input is a child's name field and hide the original new parent modal\n        if (input.closest('#new-parent-modal')) document.getElementById('new-parent-modal').classList.add('hidden');\n    }\n    function hideAlphaKeypad() {\n        customAlphaKeypadModal.classList.add('hidden');\n        // Restore the correct parent modal (either guestNameModal or newParentModal)\n        if (activeAlphaInput && activeAlphaInput.closest('#new-parent-modal')) {\n            document.getElementById('new-parent-modal').classList.remove('hidden');\n            // --- FIX: Manually dispatch 'input' event on close for final validation/autofill ---\n            activeAlphaInput.dispatchEvent(new Event('input'));\n        // --- END FIX ---\n        } else guestNameModal.classList.remove('hidden');\n        activeAlphaInput = null;\n        validateGuestForm();\n    }\n    // --- Adjust wireGlobalKeypadToInput to store timeout ID ---\n    function wireGlobalKeypadToInput(input, validationCallback = null) {\n        if (!input) return; // Add safety check\n        input.readOnly = true;\n        const handleClick = (e)=>{\n            // Clear any previous timeout ID stored on this input\n            if (input._clickTimeoutId) clearTimeout(input._clickTimeoutId);\n            // Set timeout and store ID on the input element itself\n            input._clickTimeoutId = setTimeout(()=>{\n                // Ensure the modal containing this input is still visible\n                const parentModal = input.closest('.modal-overlay');\n                if (parentModal && !parentModal.classList.contains('hidden')) showGlobalKeyboard(input); // Pass the original input\n                input._clickTimeoutId = null; // Clear ID after execution or check\n            }, 150); // 150ms delay\n        };\n        // Remove previous listener if it exists\n        if (input._globalKeypadClickListener) input.removeEventListener('click', input._globalKeypadClickListener);\n        // Add the new listener\n        input.addEventListener('click', handleClick);\n        input._globalKeypadClickListener = handleClick; // Store reference\n        // Optional: Add input listener if validation callback provided\n        if (validationCallback && typeof validationCallback === 'function') {\n            if (input._globalKeypadInputListener) input.removeEventListener('input', input._globalKeypadInputListener);\n            input.addEventListener('input', validationCallback);\n            input._globalKeypadInputListener = validationCallback;\n        }\n    }\n    function validateGuestForm() {\n        const name = guestNameInput.value.trim();\n        const surname = guestSurnameInput.value.trim();\n        const genderSelected = !!document.querySelector('input[name=\"guest-gender\"]:checked'); // Check if gender is selected\n        const ageTypeSelected = !!document.querySelector('input[name=\"age-type\"]:checked'); // *** NEW: Check if age type is selected ***\n        const isReady = name.length > 0 && surname.length > 0 && genderSelected && ageTypeSelected; // *** Added ageTypeSelected ***\n        guestConfirmBtn.disabled = !isReady;\n        guestConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n        guestConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    }\n    // REVISED function to handle different contexts\n    function handleGuestCheckIn() {\n        const firstName = guestNameInput.value.trim();\n        const lastName = guestSurnameInput.value.trim();\n        const gender = document.querySelector('input[name=\"guest-gender\"]:checked').value;\n        const guestType = document.querySelector('input[name=\"player-type\"]:checked').value; // Guest or Member\n        const ageType = document.querySelector('input[name=\"age-type\"]:checked').value; // *** NEW: Read age type ***\n        const isGuest = guestType === 'guest';\n        const context = guestNameModal.dataset.context; // Get the context\n        // Always enable the 'member' radio button after use, regardless of context\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\n        if (memberRadio) memberRadio.disabled = false;\n        if (!firstName || !lastName) return;\n        const formatCase = (str)=>str.split(' ').map((w)=>w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');\n        const formattedPlayerName = `${formatCase(firstName)} ${formatCase(lastName)}`;\n        let playerObject;\n        // --- Logic based on context and player type ---\n        if (context === 'purchaser') {\n            // Purchaser flow - always treat as guest, add/update history\n            playerObject = {\n                name: formattedPlayerName,\n                gender: gender,\n                guest: true,\n                type: ageType,\n                isPaused: false\n            }; // *** Store ageType ***\n            updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\n            guestNameModal.classList.add('hidden');\n            delete guestNameModal.dataset.context;\n            confirmPurchaser(formattedPlayerName, 'new_guest');\n            resetGuestForm(); // Reset form after use\n            return; // Exit purchaser flow\n        } else if (context === 'manual-entry') {\n            // Manual entry flow - always treat as guest, add to history AND manual selection\n            playerObject = {\n                name: formattedPlayerName,\n                gender: gender,\n                guest: true,\n                type: ageType,\n                isPaused: false\n            }; // *** Store ageType ***\n            updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\n            // Add directly to manual entry selection if not already there and space permits\n            if (state.manualEntry.players.length < 4 && !state.manualEntry.players.includes(playerObject.name)) state.manualEntry.players.push(playerObject.name);\n            guestNameModal.classList.add('hidden');\n            delete guestNameModal.dataset.context;\n            showManualPlayerSelectionModal(); // Re-show and update the manual entry modal\n            resetGuestForm(); // Reset form after use\n            saveState(); // Save guest history update\n            return; // Exit manual entry flow\n        } else {\n            // Standard check-in flow\n            if (isGuest) {\n                playerObject = {\n                    name: formattedPlayerName,\n                    gender: gender,\n                    guest: true,\n                    type: ageType,\n                    isPaused: false\n                }; // *** Store ageType ***\n                updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\n            } else {\n                // Member check-in\n                playerObject = MASTER_MEMBER_LIST.find((p)=>p.name.toLowerCase() === formattedPlayerName.toLowerCase());\n                if (playerObject) {\n                    // If found in master list, update its type property (if it exists) or add it\n                    playerObject.type = ageType; // *** Store ageType for existing member ***\n                    state.clubMembers = state.clubMembers.filter((p)=>p.name.toLowerCase() !== formattedPlayerName.toLowerCase());\n                } else {\n                    // If member not found, treat as guest (but mark as member type internally)\n                    playerObject = {\n                        name: formattedPlayerName,\n                        gender: gender,\n                        guest: false,\n                        type: ageType,\n                        isPaused: false\n                    }; // *** Mark guest:false, Store ageType ***\n                    updateGuestHistory(playerObject.name, playerObject.gender); // Still track visits for potential future guest status? Or skip? Let's track.\n                }\n            }\n            // Proceed to leaderboard confirmation for standard check-in\n            leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\n            leaderboardConfirmModal.classList.remove('hidden');\n            guestNameModal.classList.add('hidden');\n        // Form reset is handled within finishCheckIn for this flow\n        }\n    }\n    // --- NEW HELPER: Add/Update Guest History ---\n    function updateGuestHistory(guestName, guestGender) {\n        const guestIndex = state.guestHistory.findIndex((g)=>g.name === guestName);\n        const today = new Date().toISOString().split('T')[0];\n        if (guestIndex > -1) {\n            // Update existing guest gender if needed\n            state.guestHistory[guestIndex].gender = guestGender;\n            // Increment visits only if last visit wasn't today\n            if (state.guestHistory[guestIndex].lastCheckIn !== today) {\n                state.guestHistory[guestIndex].daysVisited = (state.guestHistory[guestIndex].daysVisited || 0) + 1;\n                state.guestHistory[guestIndex].lastCheckIn = today;\n            }\n        } else // Add new guest\n        state.guestHistory.push({\n            name: guestName,\n            gender: guestGender,\n            daysVisited: 1,\n            lastCheckIn: today\n        });\n    }\n    // --- NEW HELPER: Reset Guest Form ---\n    function resetGuestForm() {\n        guestNameInput.value = '';\n        guestSurnameInput.value = '';\n        guestConfirmBtn.disabled = true;\n        document.querySelector('input[name=\"guest-gender\"][value=\"M\"]').checked = true; // Default gender to M\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true; // Default type to Guest\n        document.querySelector('input[name=\"age-type\"][value=\"Adult\"]').checked = true; // *** NEW: Default age type to Adult ***\n        // Ensure member radio is re-enabled if it was disabled\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\n        if (memberRadio) memberRadio.disabled = false;\n    }\n    function resetConfirmModal() {\n        setTimeout(()=>{\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Action\";\n            cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure?\";\n            modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\n            modalBtnNo.textContent = \"Close\"; // Standardized Text\n        }, 300);\n    }\n    function populateCheckInModal() {\n        checkInList.innerHTML = \"\";\n        const checkedInPlayerNames = new Set([\n            ...state.availablePlayers.map((p)=>p.name),\n            ...state.courts.flatMap((c)=>c.players).map((p)=>p.name)\n        ]);\n        const membersAvailableToCheckIn = state.clubMembers.filter((member)=>!checkedInPlayerNames.has(member.name));\n        // --- THIS IS THE FIX ---\n        // Sort the members alphabetically by name before rendering.\n        membersAvailableToCheckIn.sort((a, b)=>a.name.localeCompare(b.name));\n        // --- END OF FIX ---\n        if (membersAvailableToCheckIn.length === 0) {\n            const li = document.createElement(\"li\");\n            li.textContent = \"All club members are currently checked in.\";\n            li.style.justifyContent = \"center\";\n            checkInList.appendChild(li);\n        } else membersAvailableToCheckIn.forEach((player)=>{\n            const li = document.createElement(\"li\");\n            const displayName = player.guest ? `${player.name} (Guest)` : player.name;\n            li.innerHTML = ` <span style=\"flex-grow: 1;\">${displayName}</span> <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span> <span class=\"action-icon add\" data-player=\"${player.name}\">+</span> `;\n            li.dataset.playerName = player.name;\n            checkInList.appendChild(li);\n        });\n        setupListWithIndex(membersAvailableToCheckIn, checkInList, document.getElementById('check-in-abc-index'));\n    }\n    function populateCheckOutModal() {\n        checkOutList.innerHTML = \"\";\n        if (state.availablePlayers.length === 0) {\n            const li = document.createElement(\"li\");\n            li.textContent = \"There are no players currently checked in.\";\n            li.style.justifyContent = \"center\";\n            checkOutList.appendChild(li);\n        } else {\n            // --- THIS IS THE FIX ---\n            // Create a sorted copy of the array for display purposes only.\n            // This does NOT change the actual queue order in state.availablePlayers.\n            const sortedPlayers = [\n                ...state.availablePlayers\n            ].sort((a, b)=>a.name.localeCompare(b.name));\n            // --- END OF FIX ---\n            sortedPlayers.forEach((player)=>{\n                const li = document.createElement(\"li\");\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\n                li.innerHTML = ` <span style=\"flex-grow: 1;\">${displayName}</span> <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span> <span class=\"action-icon remove\" data-player=\"${player.name}\">&times;</span> `;\n                li.dataset.playerName = player.name;\n                checkOutList.appendChild(li);\n            });\n            setupListWithIndex(sortedPlayers, checkOutList, document.getElementById('check-out-abc-index'));\n        }\n    }\n    function executeCheckout(playerName) {\n        if (!playerName) return;\n        if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerName) resetAlertSchedule();\n        const playerObject = state.availablePlayers.find((p)=>p.name === playerName);\n        if (playerObject) {\n            if (playerObject.isJunior) state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter((child)=>child.name !== playerName);\n            if (!playerObject.guest) {\n                state.clubMembers.push(playerObject);\n                state.clubMembers.sort((a, b)=>a.name.localeCompare(b.name));\n            }\n        }\n        state.availablePlayers = state.availablePlayers.filter((p)=>p.name !== playerName);\n        // Hide both modals, just in case\n        document.getElementById('checkout-thanks-modal').classList.add(\"hidden\");\n        document.getElementById('checkout-thanks-no-stats-modal').classList.add(\"hidden\");\n        populateCheckOutModal();\n        checkOutModal.classList.remove(\"hidden\");\n        updateGameModeBasedOnPlayerCount();\n        autoAssignCourtModes();\n        render();\n        saveState();\n    }\n    // REPLACE your existing 'showCheckoutThanksModal' function with this one\n    function showCheckoutThanksModalNoStats(playerObject) {\n        if (!playerObject) return;\n        const playerName = playerObject.name;\n        const firstName = playerName.split(' ')[0];\n        document.getElementById('checkout-thanks-no-stats-title').textContent = `Thanks for joining us, ${firstName}!`;\n        const today = new Date();\n        const dayOfWeek = today.getDay();\n        let nextSocialDay, nextSocialTime;\n        if (dayOfWeek < 3 || dayOfWeek === 3 && today.getHours() < 17) {\n            nextSocialDay = \"this coming Wednesday\";\n            nextSocialTime = \"17h30\";\n        } else if (dayOfWeek < 6 || dayOfWeek === 6 && today.getHours() < 13) {\n            nextSocialDay = \"this coming Saturday\";\n            nextSocialTime = \"13h00\";\n        } else {\n            nextSocialDay = \"next Wednesday\";\n            nextSocialTime = \"17h30\";\n        }\n        const message = `We hope you had a great day on the courts. Please join us for our next social on ${nextSocialDay}, starting at ${nextSocialTime}.`;\n        document.getElementById('checkout-thanks-no-stats-message').textContent = message;\n        const modal = document.getElementById('checkout-thanks-no-stats-modal');\n        modal.dataset.player = playerName;\n        checkOutModal.classList.add('hidden');\n        modal.classList.remove('hidden');\n    }\n    function showCheckoutThanksModal(playerObject) {\n        if (!playerObject) return;\n        const playerName = playerObject.name;\n        const firstName = playerName.split(' ')[0];\n        document.getElementById('checkout-thanks-title').textContent = `Thanks for joining us, ${firstName}!`;\n        const statsContainer = document.getElementById('checkout-player-stats');\n        statsContainer.classList.add('hidden');\n        if (playerObject.onLeaderboard === true) {\n            const todaysGames = state.gameHistory.filter((game)=>new Date(game.endTime).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]);\n            const playerStatsToday = calculatePlayerStats(todaysGames)[playerName];\n            // This is the key change: We no longer check if games have been played.\n            // We only check if the stats object exists, which it will for any checked-in player.\n            if (playerStatsToday) {\n                const rank = getPlayerRank(playerName, playerObject.gender);\n                const winPercentage = formatWinPercentage(playerStatsToday.played, playerStatsToday.won);\n                const { best, worst } = findBestAndWorstMatches(playerName);\n                const allTimeStats = calculatePlayerStats(state.gameHistory);\n                const allTimeDurationMs = allTimeStats[playerName] ? allTimeStats[playerName].totalDurationMs : 0;\n                document.getElementById('stat-rank').textContent = rank ? `#${rank}` : 'N/A';\n                document.getElementById('stat-win-percentage').textContent = winPercentage;\n                document.getElementById('stat-games-played').textContent = playerStatsToday.played;\n                document.getElementById('stat-games-won').textContent = playerStatsToday.won;\n                document.getElementById('stat-time-today').textContent = formatDuration(playerStatsToday.totalDurationMs);\n                document.getElementById('stat-total-time').textContent = formatDuration(allTimeDurationMs);\n                document.getElementById('best-match-highlight').innerHTML = `<strong>Best Match:</strong> ${best || 'N/A'}`;\n                document.getElementById('worst-match-highlight').innerHTML = `<strong>Toughest Match:</strong> ${worst || 'N/A'}`;\n                statsContainer.classList.remove('hidden');\n            }\n        }\n        const today = new Date();\n        const dayOfWeek = today.getDay();\n        let nextSocialDay, nextSocialTime;\n        if (dayOfWeek < 3 || dayOfWeek === 3 && today.getHours() < 17) {\n            nextSocialDay = \"this coming Wednesday\";\n            nextSocialTime = \"17h30\";\n        } else if (dayOfWeek < 6 || dayOfWeek === 6 && today.getHours() < 13) {\n            nextSocialDay = \"this coming Saturday\";\n            nextSocialTime = \"13h00\";\n        } else {\n            nextSocialDay = \"next Wednesday\";\n            nextSocialTime = \"17h30\";\n        }\n        const message = `We hope you had a great day on the courts. Please join us for our next social on ${nextSocialDay}, starting at ${nextSocialTime}.`;\n        document.getElementById('checkout-thanks-message').textContent = message;\n        const modal = document.getElementById('checkout-thanks-modal');\n        modal.dataset.player = playerName;\n        checkOutModal.classList.add('hidden');\n        modal.classList.remove('hidden');\n    }\n    // NEW, DECOUPLED FUNCTION: Handles only the Committee Call announcement sequence\n    function playUntimedCall(ttsMessage) {\n        // 1. Check if all notifications are muted or TTS is disabled\n        if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\n        const utterance = getUtterance(ttsMessage);\n        if (!utterance) return;\n        // 2. CRITICAL FIX: Cancel any existing speech NOW before starting audio/TTS.\n        if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();\n        // 3. Stop previous audio\n        if (currentAudio) {\n            currentAudio.pause();\n            currentAudio.currentTime = 0;\n        }\n        // 4. Create new audio object\n        const customAudio = new Audio('source/CommitteeCall.mp3');\n        // --- DEFINITIVE FIX: Use the 'playing' event to reliably attach the 'ended' listener ---\n        // Stage 1: Attach listener for when audio STARTs playing\n        customAudio.addEventListener('playing', function onSoundPlaying() {\n            customAudio.removeEventListener('playing', onSoundPlaying);\n            // Stage 2: Only now attach the listener for when the audio ENDS\n            customAudio.addEventListener('ended', function onSoundEnd() {\n                customAudio.removeEventListener('ended', onSoundEnd);\n                // Play TTS only AFTER the audio ends\n                window.speechSynthesis.speak(utterance);\n            });\n        });\n        // 5. Play the sound (no promise chain)\n        customAudio.play().catch((error)=>{\n            console.error(`Error playing custom sound: `, error);\n            // Fallback: Play TTS immediately if sound fails\n            window.speechSynthesis.speak(utterance);\n        });\n    }\n    function handleCallDuty() {\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Call\";\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to call the committee member on duty?\";\n        modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\n        modalBtnNo.textContent = \"Close\"; // Standardized Text\n        cancelConfirmModal.dataset.mode = \"callDuty\";\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    function executeCallDuty() {\n        const onDutyName = state.onDuty;\n        let isPlaying = false;\n        if (onDutyName !== 'None') isPlaying = state.courts.some((court)=>court.players.some((p)=>p.name === onDutyName));\n        let ttsMessage;\n        if (onDutyName === 'None' || isPlaying) // User's preferred general message\n        ttsMessage = \"Committee member required. Please report to your station for assistance.\";\n        else {\n            // Targeted message - Use pronounceable name\n            const firstNamePronounceable = getPronounceableName(onDutyName);\n            ttsMessage = `${firstNamePronounceable}, please report to your station for assistance.`;\n        }\n        // 1. Synchronous Fix: Reset the main alert timer schedule.\n        //resetAlertSchedule(); // <-- COMMENTED OUT AS REQUESTED\n        // 2. Use the main system's stable alert function (playAlertSound),\n        //    passing the special sound name as an override.\n        playAlertSound(ttsMessage, null, 'CommitteeCall.mp3'); // <-- NEW, CORRECT CALL\n        // 3. Close modal\n        cancelConfirmModal.classList.add(\"hidden\");\n    }\n    // ADD NEW FUNCTION: Execute the actual pause/resume state change\n    function executePauseToggle() {\n        const playerName = cancelConfirmModal.dataset.player;\n        const verb = cancelConfirmModal.dataset.verb;\n        const playerObj = state.availablePlayers.find((p)=>p.name === playerName);\n        if (playerObj) {\n            const currentSelectorFullName = getFirstAvailablePlayerName(); // Get full name\n            const wasPlayerHoldingSwapFlag = playerObj.isHoldingDutySwap;\n            const isPlayerPausing = verb === 'pause';\n            if (verb === 'resume' && wasPlayerHoldingSwapFlag) {\n                const cmIndex = state.availablePlayers.findIndex((p)=>p.name === state.onDuty);\n                const playerAtPos2Index = 1;\n                if (cmIndex > playerAtPos2Index) {\n                    const playerToSwapWith = state.availablePlayers[playerAtPos2Index];\n                    state.availablePlayers[playerAtPos2Index] = state.availablePlayers[cmIndex];\n                    state.availablePlayers[cmIndex] = playerToSwapWith;\n                }\n                playerObj.isHoldingDutySwap = false;\n            }\n            // --- THIS IS THE NEW/MODIFIED LOGIC ---\n            playerObj.isPaused = isPlayerPausing;\n            if (isPlayerPausing) playerObj.pauseTime = Date.now(); // Set the pause timestamp\n            else delete playerObj.pauseTime; // Remove timestamp on resume\n            // --- END OF NEW LOGIC ---\n            if (verb === 'pause') {\n                const firstActiveIndex = state.availablePlayers.findIndex((p)=>!p.isPaused);\n                if (firstActiveIndex === state.availablePlayers.indexOf(playerObj)) playerObj.isHoldingDutySwap = true;\n                else playerObj.isHoldingDutySwap = false;\n            }\n            enforceQueueLogic(); // --- THIS IS THE FIX ---\n            const fullPlayerName = playerObj.name;\n            const pronounceablePlayerName = getPronounceableName(fullPlayerName); // Get pronounceable name\n            let firstMessage = '';\n            let secondMessage = null;\n            if (playerObj.isPaused) {\n                // Use pronounceable name\n                firstMessage = `${pronounceablePlayerName} is now taking a well-deserved break.`;\n                if (fullPlayerName === currentSelectorFullName) {\n                    const nextSelectorFullName = getFirstAvailablePlayerName();\n                    if (nextSelectorFullName) {\n                        // Use pronounceable name for the next selector\n                        const nextSelectorPronounceable = getPronounceableName(nextSelectorFullName);\n                        secondMessage = `${nextSelectorPronounceable}, please select players for a game.`;\n                    }\n                }\n            } else // Use pronounceable name\n            firstMessage = `${pronounceablePlayerName} is back on court and ready to play.`;\n            playAlertSound(firstMessage, secondMessage);\n            cancelConfirmModal.classList.add(\"hidden\");\n            updateGameModeBasedOnPlayerCount();\n            render();\n            saveState();\n            checkAndPlayAlert(false);\n        }\n    }\n    function showCooldownModal(remainingMs) {\n        if (cooldownTimerInterval) clearInterval(cooldownTimerInterval);\n        const endTime = Date.now() + remainingMs;\n        function updateCountdown() {\n            const now = Date.now();\n            const timeLeft = endTime - now;\n            if (timeLeft <= 0) {\n                clearInterval(cooldownTimerInterval);\n                cooldownModal.classList.add('hidden');\n                return;\n            }\n            const minutes = Math.floor(timeLeft / 60000);\n            const seconds = Math.floor(timeLeft % 60000 / 1000);\n            cooldownTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\n        }\n        updateCountdown(); // Initial call to display time immediately\n        cooldownTimerInterval = setInterval(updateCountdown, 1000);\n        cooldownModal.classList.remove('hidden');\n    }\n    function handlePauseToggleClick(button) {\n        const playerName = button.dataset.playerName;\n        const action = button.dataset.action; // 'pause' or 'resume'\n        const playerObj = state.availablePlayers.find((p)=>p.name === playerName);\n        if (!playerObj) return;\n        if (action === 'resume') {\n            const TEN_MINUTES_MS = 600000;\n            if (playerObj.pauseTime && Date.now() - playerObj.pauseTime < TEN_MINUTES_MS) {\n                const remainingMs = TEN_MINUTES_MS - (Date.now() - playerObj.pauseTime);\n                showCooldownModal(remainingMs); // <-- This is the change\n                return;\n            }\n        }\n        const verb = action === 'pause' ? 'pause' : 'resume';\n        const message = action === 'pause' ? `Are you sure you want to pause your game play? You will be paused for a minimum of 10 minutes and will remain in position #${state.availablePlayers.indexOf(playerObj) + 1} until you resume.` : `Are you sure you want to resume your game play? You will be immediately restored to position #${state.availablePlayers.indexOf(playerObj) + 1}.`;\n        cancelConfirmModal.querySelector(\"h3\").textContent = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;\n        cancelConfirmModal.querySelector(\"p\").textContent = message;\n        modalBtnYesConfirm.textContent = verb.charAt(0).toUpperCase() + verb.slice(1);\n        modalBtnNo.textContent = \"Close\";\n        cancelConfirmModal.dataset.mode = \"pauseToggle\";\n        cancelConfirmModal.dataset.player = playerName;\n        cancelConfirmModal.dataset.verb = action;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    }\n    // --- ADDED FUNCTION ---\n    function enforceDutyPosition() {\n        if (state.availablePlayers.length < 2 || state.onDuty === 'None') return;\n        const players = state.availablePlayers;\n        // Find the index of the player who is currently the ACTIVE selector (first non-paused player)\n        const firstActiveIndex = players.findIndex((p)=>!p.isPaused);\n        // If no active players exist, or the CM is not the active player, exit.\n        if (firstActiveIndex === -1 || players[firstActiveIndex].name !== state.onDuty) return;\n        // --- CM IS THE EFFECTIVE SELECTOR (players[firstActiveIndex]) ---\n        // Find the index of the FIRST suitable (available, non-paused, non-duty) player to swap with.\n        // Start searching immediately after the CM's position.\n        const targetSwapIndex = players.findIndex((p, index)=>index > firstActiveIndex && // Must be after the CM\n            !p.isPaused && // Must be available/unpaused\n            p.name !== state.onDuty // Must not be the CM (safety check)\n        );\n        // If a suitable player is found, perform the swap.\n        if (targetSwapIndex !== -1) {\n            const cmPlayer = players[firstActiveIndex];\n            const targetPlayer = players[targetSwapIndex];\n            // Perform the clean swap\n            [players[firstActiveIndex], players[targetSwapIndex]] = [\n                targetPlayer,\n                cmPlayer\n            ];\n        }\n    }\n    // Track last announcement times to prevent duplicates\n    let lastFastPlayAnnouncement = 0;\n    let last1SetAnnouncement = 0;\n    const ANNOUNCEMENT_COOLDOWN = 5000; // 5 seconds cooldown between same announcements\n    function autoAssignMatchMode() {\n        if (!state.matchSettings.autoMatchModes) return; // Do nothing if the feature is turned off\n        const socialCourts = state.courts.filter((c)=>state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league');\n        const socialCourtCount = socialCourts.length;\n        const totalPlayerCount = totalPlayersAtClub();\n        const fastPlayThreshold = socialCourtCount * 4 + 4;\n        const TWO_MINUTES_MS = 120000;\n        if (totalPlayerCount >= fastPlayThreshold) {\n            if (state.matchSettings.matchMode !== 'fast') {\n                state.matchSettings.matchMode = 'fast';\n                state.matchSettings.fastPlayGames = 4;\n                // Only announce if cooldown period has passed\n                const now = Date.now();\n                if (now - lastFastPlayAnnouncement > ANNOUNCEMENT_COOLDOWN) {\n                    playCustomTTS(\"There is currently a high demand. Switching to Fast Play mode and 2-minute alerts.\");\n                    lastFastPlayAnnouncement = now;\n                }\n                // If an alert is scheduled for more than 2 minutes away, reset it to 2 minutes.\n                const remainingTime = alertScheduleTime - Date.now();\n                if (alertState !== 'initial_check' && remainingTime > TWO_MINUTES_MS) {\n                    alertScheduleTime = Date.now() + TWO_MINUTES_MS;\n                    playCustomTTS(\"Alert timer accelerated.\");\n                }\n            }\n        } else if (state.matchSettings.matchMode !== '1set') {\n            state.matchSettings.matchMode = '1set';\n            // Only announce if cooldown period has passed\n            const now2 = Date.now();\n            if (now2 - last1SetAnnouncement > ANNOUNCEMENT_COOLDOWN) {\n                playCustomTTS(\"Player queue is reduced. Switching to standard 1 Set matches and 5-minute alerts.\");\n                last1SetAnnouncement = now2;\n            }\n        }\n    }\n    function autoAssignCourtModes() {\n        // 1. Check if the feature is enabled in admin settings\n        if (!state.courtSettings.autoAssignModes) return;\n        // 2. Perform Calculations\n        const visibleSocialCourts = state.courts.filter((c)=>state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league');\n        const visibleSocialCourtCount = visibleSocialCourts.length;\n        const activeLeagueCourts = state.courts.filter((c)=>c.courtMode === 'league' && c.status === 'in_progress').length;\n        const socialPlayersOnCourt = state.courts.filter((c)=>c.courtMode !== 'league').reduce((sum, court)=>sum + court.players.length, 0);\n        const totalSocialPlayers = state.availablePlayers.length + socialPlayersOnCourt;\n        // Filter for courts that are available, visible, and not league courts\n        const courtsToModify = state.courts.filter((c)=>c.status === 'available' && state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league');\n        // 3. Apply Prioritized Rules\n        // Rule 1: League Priority\n        if (activeLeagueCourts >= 2) courtsToModify.forEach((court)=>{\n            if (court.courtMode !== 'doubles') court.courtMode = 'doubles';\n        });\n        else if (totalSocialPlayers >= visibleSocialCourtCount * 4) courtsToModify.forEach((court)=>{\n            if (court.courtMode !== 'doubles') court.courtMode = 'doubles';\n        });\n        else if (totalSocialPlayers >= (visibleSocialCourtCount - 1) * 4) courtsToModify.forEach((court)=>{\n            if (court.id === 'A' && court.courtMode !== 'doubles') court.courtMode = 'doubles';\n            else if (court.id === 'E' && court.courtMode !== 'rookie') court.courtMode = 'rookie';\n        });\n        else courtsToModify.forEach((court)=>{\n            if (court.id === 'A' && court.courtMode !== 'singles') court.courtMode = 'singles';\n            else if (court.id === 'E' && court.courtMode !== 'rookie') court.courtMode = 'rookie';\n        });\n        saveState(); // Save any changes made to court modes\n    }\n    // --- ADDED FUNCTION ---\n    function handleReorderPositionChange(newPositionStr) {\n        if (!activeInput || !activeInput.dataset.playerName) return;\n        const playerName = activeInput.dataset.playerName;\n        const oldIndex = parseInt(activeInput.dataset.currentIndex, 10);\n        const newIndex = parseInt(newPositionStr, 10) - 1;\n        if (isNaN(newIndex) || newIndex < 0 || newIndex >= tempPlayerOrder.length) {\n            alert(`Invalid position. Please enter a number between 1 and ${tempPlayerOrder.length}.`);\n            return;\n        }\n        const [playerToMove] = tempPlayerOrder.splice(oldIndex, 1);\n        tempPlayerOrder.splice(newIndex, 0, playerToMove);\n        logPlayerSwap(playerName, oldIndex, newIndex);\n        renderReorderList();\n    }\n    // --- ADDED FUNCTION ---\n    function confirmSkipScores() {\n        const courtId1 = endGameModal.dataset.courtId;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        const winnerValue = endGameModal.dataset.winner;\n        if (!court || !winnerValue) return;\n        const team1Names = getPlayerNames(court.teams.team1);\n        const team2Names = getPlayerNames(court.teams.team2);\n        const newGame = {\n            id: Date.now(),\n            court: court.id,\n            startTime: court.gameStartTime,\n            endTime: Date.now(),\n            duration: document.getElementById(`timer-${court.id}`).textContent,\n            teams: {\n                team1: team1Names,\n                team2: team2Names\n            },\n            score: null,\n            winner: winnerValue\n        };\n        state.gameHistory.push(newGame);\n        const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\n        const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\n        const playersToRequeue = [\n            ...winningPlayers,\n            ...losingPlayers\n        ].filter((p)=>!p.guest);\n        state.availablePlayers.push(...playersToRequeue);\n        // Reset the court and close modal\n        resetCourtAfterGame(court.id);\n        endGameModal.classList.add(\"hidden\");\n        checkAndPlayAlert(false);\n    }\n    // REPLACE this function (minor change to call checkAndPlayAlert correctly)\n    function resetCourtAfterGame(courtId1) {\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court) return;\n        court.status = \"available\";\n        court.players = [];\n        court.teams = {\n            team1: [],\n            team2: []\n        };\n        court.gameMode = null;\n        court.gameStartTime = null;\n        court.queueSnapshot = null;\n        court.becameAvailableAt = Date.now(); // Ensure this is set when becoming available\n        // NEW: Check if we need to restore the original duty member\n        if (state.tempDutyHandover && state.tempDutyHandover.originalMember) {\n            // Check if the original duty member's game has ended\n            const originalMemberStillOnCourt = state.courts.some((c)=>c.status === 'in_progress' && c.players.some((p)=>p.name === state.tempDutyHandover.originalMember));\n            if (!originalMemberStillOnCourt) restoreOriginalDutyMember(); // This will call render() internally\n        }\n        updateGameModeBasedOnPlayerCount();\n        enforceDutyPosition();\n        autoAssignCourtModes();\n        render(); // Render the UI update first\n        saveState();\n        // --- THIS IS THE FIX ---\n        // Call checkAndPlayAlert *after* render and save, so it evaluates the new state.\n        // Pass false so it doesn't force an immediate alert, but resets timer if needed.\n        checkAndPlayAlert(false);\n    // --- END OF FIX ---\n    }\n    function confirmSkipResult() {\n        const courtId1 = endGameModal.dataset.courtId;\n        const court = state.courts.find((c)=>c.id === courtId1);\n        if (!court) return;\n        const team1Names = getPlayerNames(court.teams.team1);\n        const team2Names = getPlayerNames(court.teams.team2);\n        const newGame = {\n            id: Date.now(),\n            court: court.id,\n            startTime: court.gameStartTime,\n            endTime: Date.now(),\n            duration: document.getElementById(`timer-${court.id}`).textContent,\n            teams: {\n                team1: team1Names,\n                team2: team2Names\n            },\n            score: null,\n            winner: 'skipped'\n        };\n        state.gameHistory.push(newGame);\n        const playersToRequeue = [\n            ...court.players\n        ].filter((p)=>!p.guest);\n        state.availablePlayers.push(...playersToRequeue);\n        // Reset the court and close modal\n        resetCourtAfterGame(court.id);\n        endGameModal.classList.add(\"hidden\");\n        checkAndPlayAlert(false);\n    }\n    // REPLACE this function\n    function handleSkipButtonClick() {\n        const skipBtn = document.getElementById('end-game-skip-btn');\n        const action = skipBtn.dataset.action;\n        if (action === 'skip-scores') confirmSkipScores();\n        else confirmSkipResult();\n    }\n    // --- ADDED FUNCTION ---\n    // Triggers the keypad for the reset confirmation\n    function handleResetAppClick() {\n        showKeypad(null, {\n            mode: 'reset',\n            maxLength: 5,\n            title: 'Enter Reset PIN'\n        });\n    }\n    // --- ADDED FUNCTION ---\n    // Checks the entered PIN against the hardcoded value\n    function checkResetPasscode() {\n        const enteredCode = keypadDisplay.dataset.hiddenValue;\n        const expectedCode = \"30221\"; // The hardcoded reset PIN\n        if (enteredCode === expectedCode) {\n            // If correct, show a final confirmation before resetting\n            hideKeypad();\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Final Confirmation\";\n            cancelConfirmModal.querySelector(\"p\").textContent = \"WARNING: This will erase all game history and check out all players. Are you absolutely sure?\";\n            modalBtnYesConfirm.textContent = \"Yes, Reset\";\n            modalBtnNo.textContent = \"Cancel\";\n            cancelConfirmModal.dataset.mode = \"executeReset\";\n            cancelConfirmModal.classList.remove(\"hidden\");\n        } else {\n            // If incorrect, shake the keypad and clear it\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\n            keypadContent.classList.add('shake');\n            setTimeout(()=>{\n                keypadContent.classList.remove('shake');\n                keypadDisplay.textContent = '';\n                if (keypadDisplay.dataset.hiddenValue) keypadDisplay.dataset.hiddenValue = '';\n                keypadConfirmBtn.disabled = true;\n            }, 820);\n        }\n    }\n    // --- ADDED FUNCTION ---\n    // The core function that resets the application state\n    function executeAppReset() {\n        // --- ADD THIS BLOCK AT THE BEGINNING ---\n        // Save the final state of the checklist for the day *before* resetting\n        saveChecklistHistory();\n        // Force the checklist to reset its 'checked' status immediately\n        resetChecklistForNewDay(true); // Pass true to force reset regardless of date\n        // --- END ADD ---\n        // Reset all player locations\n        state.clubMembers = [\n            ...MASTER_MEMBER_LIST\n        ].sort((a, b)=>a.name.localeCompare(b.name));\n        state.availablePlayers = [];\n        // ... (rest of the reset logic for courts, history, etc.) ...\n        // Clear all history (game, reorder)\n        state.gameHistory = [];\n        state.reorderHistory = [];\n        // DO NOT CLEAR state.checklistHistory here - we want to keep past checklists\n        // ... (reset other relevant states like onDuty, selection) ...\n        // Close all modals\n        adminSettingsModal.classList.add('hidden');\n        cancelConfirmModal.classList.add('hidden');\n        // Save the new, clean state and re-render the UI\n        saveState();\n        autoAssignCourtModes();\n        render();\n        alert(\"Application has been reset. Checklist state for the previous session (if applicable) has been archived.\");\n    }\n    function formatCase(str) {\n        return str.split(' ').map((w)=>w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');\n    }\n    // --- ADDED FUNCTION: Wrapper for the Add Child button click ---\n    function addChild() {\n        generateChildField();\n    }\n    // --- JUNIOR CLUB FUNCTIONS (RESTORED) ---\n    function generateChildField() {\n        // --- DEBUG LOG ---\n        console.log(\"--- generateChildField START ---\");\n        const groupId = Date.now();\n        const fieldGroup = document.createElement('div');\n        fieldGroup.className = 'child-field-group';\n        fieldGroup.dataset.groupId = groupId;\n        fieldGroup.dataset.complete = 'false'; // Start as incomplete\n        // --- DEBUG LOG ---\n        console.log(\"generateChildField: Created fieldGroup element:\", fieldGroup);\n        const currentParentSurname = parentSurnameInput.value.trim(); // Get current parent surname\n        // --- UPDATED HTML with stacked fields and labels ---\n        fieldGroup.innerHTML = `\n            <div class=\"child-collapsed-display collapsed-area hidden\"></div>\n            <div class=\"child-expanded-fields\">\n                <div style=\"display: block;\">\n                    <div class=\"child-name-input score-input-area\" style=\"flex-direction: column; align-items: stretch; width: 100%;\">\n                        <label for=\"child-name-${groupId}\">Child First Name:</label>\n                        <input type=\"text\" id=\"child-name-${groupId}\" name=\"childName\" readonly placeholder=\"Tap to enter name\" style=\"width: 100%;\">\n                    </div>\n                    <div class=\"child-surname-container score-input-area\" style=\"flex-direction: column; align-items: stretch; width: 100%;\">\n                        <label for=\"child-surname-${groupId}\">Child Surname:</label>\n                        <input type=\"text\" id=\"child-surname-${groupId}\" name=\"childSurname\" readonly placeholder=\"Tap to enter surname\" style=\"width: 100%;\" data-autofill-surname=\"${currentParentSurname}\">\n                    </div>\n                </div>\n                <div style=\"display: flex; gap: 0.75rem; margin-top: 0.5rem; width: 100%;\">\n                    <div class=\"child-dob-input score-input-area\" style=\"flex-direction: column; align-items: stretch; flex: 1; min-width: 0; position: relative;\">\n                        <label for=\"child-dob-${groupId}\">Birth Date:</label>\n                        <div class=\"date-time-input-wrapper\">\n                            <input type=\"date\" id=\"child-dob-${groupId}\" name=\"childBirthDate\">\n                            <div class=\"date-time-overlay\" id=\"child-dob-${groupId}-overlay\">\n                                <span class=\"part empty\" data-part=\"YYYY\">yyyy</span><span class=\"separator\">/</span><span class=\"part empty\" data-part=\"MM\">mm</span><span class=\"separator\">/</span><span class=\"part empty\" data-part=\"DD\">dd</span>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"gender-selector score-input-area\" style=\"flex-direction: column; align-items: stretch; flex: 1; min-width: 0;\">\n                        <label>Gender:</label>\n                        <div class=\"radio-group\" style=\"background-color: transparent; border: 1px solid var(--border-color); border-radius: 5px; height: 100%; box-sizing: border-box; display: flex; align-items: center; justify-content: space-around; padding: 0.25rem 0.5rem;\">\n                            <label><input type=\"radio\" name=\"child-gender-${groupId}\" value=\"M\"> Male</label>\n                            <label><input type=\"radio\" name=\"child-gender-${groupId}\" value=\"F\"> Female</label>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n        // --- Get Input References ---\n        const childNameInput = fieldGroup.querySelector('[name=\"childName\"]');\n        const childSurnameInput = fieldGroup.querySelector('[name=\"childSurname\"]');\n        const childDobInput = fieldGroup.querySelector('[name=\"childBirthDate\"]');\n        // --- Attach Global Keyboard Listeners ---\n        childNameInput.addEventListener('click', (e)=>showGlobalKeyboard(e.target, 'LetterPad', ''));\n        childSurnameInput.addEventListener('click', (e)=>showGlobalKeyboard(e.target, 'LetterPad', ''));\n        // Update overlay when date value changes\n        childDobInput.addEventListener('change', function(e) {\n            const overlay = fieldGroup.querySelector(`#child-dob-${groupId}-overlay`);\n            if (!overlay) return;\n            const value = e.target.value; // Format: YYYY-MM-DD\n            if (value) {\n                const [year, month, day] = value.split('-');\n                const parts = overlay.querySelectorAll('.part');\n                parts[0].textContent = year;\n                parts[0].classList.remove('empty');\n                parts[0].classList.add('filled');\n                parts[1].textContent = month;\n                parts[1].classList.remove('empty');\n                parts[1].classList.add('filled');\n                parts[2].textContent = day;\n                parts[2].classList.remove('empty');\n                parts[2].classList.add('filled');\n            }\n        });\n        // --- Define Validation Handler for this specific group ---\n        const validationHandlerForGroup = ()=>{\n            checkAndCollapseChild(fieldGroup); // Check if this specific group is complete\n            validateNewParentForm(false); // Validate parent form buttons (don't re-render parent)\n            renderChildFields(); // Re-render child fields to update collapse state\n        };\n        // --- Attach Input/Change Listeners ---\n        childNameInput.addEventListener('input', validationHandlerForGroup);\n        childSurnameInput.addEventListener('input', validationHandlerForGroup);\n        childDobInput.addEventListener('change', validationHandlerForGroup); // Date uses 'change'\n        fieldGroup.querySelectorAll(`input[name^=\"child-gender\"]`).forEach((radio)=>{\n            radio.addEventListener('change', validationHandlerForGroup);\n        });\n        // --- Autofill Logic (Remains the same) ---\n        childNameInput.addEventListener('input', ()=>{\n            const surnameToAutofill = childSurnameInput.dataset.autofillSurname;\n            if (surnameToAutofill && childNameInput.value.trim().length > 0 && childSurnameInput.value.trim().length === 0) {\n                childSurnameInput.value = surnameToAutofill;\n                // Dispatch an input event manually AFTER setting the value\n                childSurnameInput.dispatchEvent(new Event('input', {\n                    bubbles: true\n                }));\n            } else if (childNameInput.value.trim().length === 0) {\n                childSurnameInput.value = '';\n                childSurnameInput.dispatchEvent(new Event('input', {\n                    bubbles: true\n                }));\n            }\n        // No need for validationHandlerForGroup() here, the 'input' event on childSurnameInput handles it\n        });\n        // --- Add listener to collapsed area to re-expand ---\n        const collapsedDisplay = fieldGroup.querySelector('.child-collapsed-display');\n        collapsedDisplay.addEventListener('click', (e)=>{\n            if (e.target.closest('.collapsed-area') || e.target.closest('.edit-icon')) {\n                fieldGroup.dataset.complete = 'false';\n                renderChildFields(); // Re-render to show expanded view\n            }\n        });\n        collapsedDisplay.dataset.listenerBound = 'true'; // Mark as bound\n        // --- Append to Container ---\n        const childrenContainerElement = document.getElementById('children-container');\n        if (childrenContainerElement) {\n            console.log(\"generateChildField: Appending fieldGroup to #children-container:\", childrenContainerElement);\n            childrenContainerElement.appendChild(fieldGroup);\n        } else console.error(\"generateChildField: #children-container NOT FOUND!\");\n        // --- DEBUG LOG ---\n        console.log(\"--- generateChildField END ---\");\n        // Initial validation call for the new field AFTER appending\n        validationHandlerForGroup();\n    }\n    function showEditParentModal(parent) {\n        // 1. Set the modal to 'edit' mode and store the parent's original ID.\n        newParentModal.querySelector('h3').textContent = 'Edit Parent Profile';\n        newParentModal.dataset.mode = 'edit';\n        newParentModal.dataset.originalParentId = parent.id;\n        newParentConfirmBtn.textContent = 'Save Changes';\n        // 2. Populate the main parent fields.\n        parentNameInput.value = parent.name;\n        parentSurnameInput.value = parent.surname;\n        parentPhoneInput.value = parent.phone || '';\n        // 3. Clear any old child forms.\n        childrenContainer.innerHTML = '';\n        // 4. Loop through the existing children and create a pre-filled form for each.\n        parent.registeredChildren.forEach((child)=>{\n            // Creates a new, empty child form group.\n            generateChildField();\n            // Get a reference to the form we just created.\n            const lastChildGroup = childrenContainer.lastElementChild;\n            if (lastChildGroup) {\n                // Populate the fields of that form with the child's data.\n                lastChildGroup.querySelector('[name=\"childName\"]').value = child.name;\n                lastChildGroup.querySelector('[name=\"childSurname\"]').value = child.surname;\n                lastChildGroup.querySelector('[name=\"childBirthDate\"]').value = child.birthDate;\n                const genderRadio = lastChildGroup.querySelector(`input[name^=\"child-gender\"][value=\"${child.gender}\"]`);\n                if (genderRadio) genderRadio.checked = true;\n                // --- THIS IS THE CRITICAL FIX ---\n                // Manually run the check to mark this pre-filled form as \"complete\".\n                checkAndCollapseChild(lastChildGroup);\n            // --- END OF FIX ---\n            }\n        });\n        // 5. Set the initial state to show the form as already collapsed.\n        state.juniorClub.registrationFlow = {\n            parentCollapsed: true,\n            childrenExpanded: true\n        };\n        // 6. Show the modal.\n        juniorClubModal.classList.add('hidden');\n        newParentModal.classList.remove('hidden');\n        // 7. Render the form. Because we fixed the \"complete\" state in step 4,\n        // this will now correctly render the collapsed summary view.\n        renderParentForm();\n    }\n    function showJuniorClubRosterModal() {\n        renderJuniorClubRoster(); // Renders with default/last applied sort\n        juniorClubModal.classList.add('hidden');\n        juniorClubRosterModal.classList.remove('hidden');\n    }\n    function showRosterDetailModal(item) {\n        rosterDetailContent.innerHTML = '';\n        // Ensure the detail modal content container is visible\n        rosterDetailModal.classList.add('hidden');\n        if (item.isParent) {\n            // --- PARENT DETAIL VIEW: List Children ---\n            rosterDetailTitle.textContent = `${item.name} ${item.surname}'s Registered Children`;\n            // ADDED STYLE: Compact Title\n            rosterDetailTitle.style.marginTop = '0';\n            rosterDetailTitle.style.marginBottom = '0.5rem';\n            if (item.children && item.children.length > 0) {\n                const ul = document.createElement('ul');\n                ul.style.listStyleType = 'none';\n                ul.style.padding = '0';\n                ul.style.margin = '0.5rem 0';\n                item.children.forEach((childName)=>{\n                    const childLastCheckInMs = getLastCheckInForChild(childName);\n                    const checkInDisplay = childLastCheckInMs > 0 ? new Date(childLastCheckInMs).toLocaleDateString('en-ZA') : 'Never Checked In';\n                    const li = document.createElement('li');\n                    li.innerHTML = `\n                        <div style=\"display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #eee;\">\n                            <span style=\"font-weight: 500; color: var(--dark-text);\">${childName}</span>\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${checkInDisplay}</span>\n                        </div>\n                    `;\n                    ul.appendChild(li);\n                });\n                rosterDetailContent.appendChild(ul);\n            } else // MODIFIED STYLE: Compact margin for empty state\n            rosterDetailContent.innerHTML = '<p style=\"text-align: center; color: var(--neutral-color); margin-top: 1rem; margin-bottom: 0;\">No children currently registered under this parent.</p>';\n        } else {\n            // --- CHILD DETAIL VIEW: Show Parent in list style ---\n            rosterDetailTitle.textContent = `${item.name} ${item.surname}'s Parent`;\n            // ADDED STYLE: Compact Title\n            rosterDetailTitle.style.marginTop = '0';\n            rosterDetailTitle.style.marginBottom = '0.5rem';\n            const ul = document.createElement('ul');\n            ul.style.listStyleType = 'none';\n            ul.style.padding = '0';\n            ul.style.margin = '0.5rem 0';\n            // Find the parent object to get their last check-in details\n            const parent = state.juniorClub.parents.find((p)=>`${p.name} ${p.surname}` === item.parentName);\n            let parentLastCheckInDisplay = 'Never Checked In';\n            if (parent) {\n                // Re-use the existing logic to find the parent's most recent check-in through children\n                let latestParentChildrenCheckIn = 0;\n                parent.registeredChildren.forEach((child)=>{\n                    const childFullName = `${child.name} ${child.surname}`;\n                    const childCheckIn = getLastCheckInForChild(childFullName);\n                    if (childCheckIn > latestParentChildrenCheckIn) latestParentChildrenCheckIn = childCheckIn;\n                });\n                if (latestParentChildrenCheckIn > 0) parentLastCheckInDisplay = new Date(latestParentChildrenCheckIn).toLocaleDateString('en-ZA');\n            }\n            const li = document.createElement('li');\n            li.innerHTML = `\n                <div style=\"display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #eee;\">\n                    <span style=\"font-weight: 500; color: var(--dark-text);\">Parent: ${item.parentName}</span>\n                    <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${parentLastCheckInDisplay}</span>\n                </div>\n            `;\n            ul.appendChild(li);\n            rosterDetailContent.appendChild(ul);\n        }\n        // Hide the roster modal and show the detail modal\n        juniorClubRosterModal.classList.add('hidden');\n        rosterDetailModal.classList.remove('hidden');\n    }\n    function renderJuniorClubRoster() {\n        juniorClubRosterList.innerHTML = ''; // Clear previous content\n        const { sortKey, sortOrder, type } = state.juniorClub.rosterFilter;\n        let finalRoster = [];\n        // --- Populate finalRoster based on 'type' filter ---\n        if (type === 'parents') state.juniorClub.parents.forEach((parent)=>{\n            let latestChildCheckIn = 0;\n            // Find the latest check-in time among all children of this parent\n            parent.registeredChildren.forEach((child)=>{\n                const childFullName = `${child.name} ${child.surname}`.trim();\n                const childCheckIn = getLastCheckInForChild(childFullName);\n                if (childCheckIn > latestChildCheckIn) latestChildCheckIn = childCheckIn;\n            });\n            // Add parent data, including email\n            finalRoster.push({\n                isParentOnlyView: true,\n                id: parent.id,\n                name: `${parent.name} ${parent.surname}`,\n                phone: parent.phone || 'N/A',\n                email: parent.email || 'N/A',\n                lastCheckInMs: latestChildCheckIn\n            });\n        });\n        else if (type === 'all') // Logic for 'all' view (unchanged)\n        state.juniorClub.parents.forEach((parent)=>{\n            parent.registeredChildren.forEach((child)=>{\n                const childFullName = `${child.name} ${child.surname}`.trim();\n                const childAge = calculateAge(child.birthDate);\n                finalRoster.push({\n                    isAllView: true,\n                    id: childFullName,\n                    parentName: `${parent.name} ${parent.surname}`,\n                    childData: {\n                        name: childFullName,\n                        age: childAge,\n                        ageDisplay: childAge !== null ? `${childAge}y` : 'N/A',\n                        gender: child.gender || '?'\n                    },\n                    lastCheckInMs: getLastCheckInForChild(childFullName)\n                });\n            });\n        });\n        else // Logic for 'children' view (unchanged)\n        state.juniorClub.parents.forEach((parent)=>{\n            parent.registeredChildren.forEach((child)=>{\n                const childFullName = `${child.name} ${child.surname}`.trim();\n                const childAge = calculateAge(child.birthDate);\n                finalRoster.push({\n                    isChildrenView: true,\n                    id: childFullName,\n                    name: `${child.name} ${child.surname}`,\n                    age: childAge,\n                    ageDisplay: childAge !== null ? `${childAge}y` : 'N/A',\n                    gender: child.gender || '?',\n                    lastCheckInMs: getLastCheckInForChild(childFullName)\n                });\n            });\n        });\n        // --- Sorting Logic (unchanged) ---\n        let uniqueRoster = finalRoster; // Assuming filtering for uniqueness isn't needed here currently\n        uniqueRoster.sort((a, b)=>{\n            let compareValue = 0;\n            // Determine name based on view type for sorting\n            const nameA = a.isParentOnlyView ? a.name : a.isAllView ? a.childData.name : a.name;\n            const nameB = b.isParentOnlyView ? b.name : b.isAllView ? b.childData.name : b.name;\n            if (sortKey === 'name') compareValue = nameA.localeCompare(nameB);\n            else if (sortKey === 'last_checkin') compareValue = a.lastCheckInMs - b.lastCheckInMs;\n            else if (sortKey === 'age') ;\n            else sortKey;\n            return sortOrder === 'asc' ? compareValue : -compareValue;\n        });\n        // --- Filter HTML Injection (unchanged) ---\n        const filterHTML = `\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\n                <div class=\"radio-group\" id=\"roster-type-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"all\" ${type === 'all' ? 'checked' : ''}> All</label>\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"parents\" ${type === 'parents' ? 'checked' : ''}> Parents Only</label>\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"children\" ${type === 'children' ? 'checked' : ''}> Children Only</label>\n                </div>\n            </div>\n        `;\n        juniorClubRosterList.insertAdjacentHTML('afterbegin', filterHTML);\n        // Re-attach listener\n        juniorClubRosterList.querySelector('#roster-type-filter-group').addEventListener('change', handleRosterTypeFilterChange);\n        // --- Prepare for List Rendering ---\n        const indexList = uniqueRoster.map((item)=>({\n                name: item.isParentOnlyView ? item.name : item.isAllView ? item.childData.name : item.name\n            }));\n        if (uniqueRoster.length === 0) {\n            document.getElementById('junior-club-roster-abc-index').innerHTML = ''; // Clear index\n            juniorClubRosterList.insertAdjacentHTML('beforeend', '<li class=\"waiting-message\">No members match the current filters.</li>');\n            return; // Exit if no items\n        }\n        juniorClubRosterList.rosterData = uniqueRoster; // Store data for detail view clicks\n        const getSortIcon = (key)=>state.juniorClub.rosterFilter.sortKey !== key ? ' ' : sortOrder === 'asc' ? \" \\uD83D\\uDD3C\" : \" \\uD83D\\uDD3D\";\n        const buttonStyle = \"background: none; color: var(--dark-text); border: none; padding: 0.5rem; min-width: 0; line-height: 1.2; font-weight: bold; font-size: calc(0.8rem * var(--font-size-multiplier));\"; // Shared style\n        let headerHTML = '';\n        // --- Header Generation based on 'type' ---\n        if (type === 'parents') // *** UPDATED HEADER for Parents Only view ***\n        headerHTML = `<div class=\"history-item roster-header\" style=\"padding: 0.5rem 1rem;\">\n                <div class=\"roster-row\">\n                    <button class=\"action-btn roster-sort-btn roster-col-name\" data-sort-key=\"name\" style=\"${buttonStyle} flex: 2.5; text-align: left;\">Parent Name${getSortIcon('name')}</button>\n                    <span class=\"roster-col-contact\" style=\"color: var(--dark-text); font-weight: bold; flex: 1; text-align: center; font-size: calc(0.8rem * var(--font-size-multiplier));\">Contact</span>\n                    <span class=\"roster-col-email\" style=\"color: var(--dark-text); font-weight: bold; flex: 1.5; text-align: center; font-size: calc(0.8rem * var(--font-size-multiplier));\">Email</span>\n                    <button class=\"action-btn roster-sort-btn roster-col-checkin\" data-sort-key=\"last_checkin\" style=\"${buttonStyle} flex: 1; text-align: center;\">Last<br>Check-In${getSortIcon('last_checkin')}</button>\n                </div></div>`;\n        else headerHTML = `<div class=\"history-item roster-header\" style=\"padding: 0.5rem 1rem;\">\n                <div class=\"roster-row\">\n                    <button class=\"action-btn roster-sort-btn roster-col-name\" data-sort-key=\"name\" style=\"${buttonStyle} flex: 2.5; text-align: left;\">${type === 'all' ? 'Parent / Child' : 'Name'}${getSortIcon('name')}</button>\n                    <button class=\"action-btn roster-sort-btn roster-col-gender\" data-sort-key=\"gender\" style=\"${buttonStyle} flex: 1; text-align: center;\">Gender${getSortIcon('gender')}</button>\n                    <button class=\"action-btn roster-sort-btn roster-col-age\" data-sort-key=\"age\" style=\"${buttonStyle} flex: 1; text-align: center;\">Age${getSortIcon('age')}</button>\n                    <button class=\"action-btn roster-sort-btn roster-col-checkin\" data-sort-key=\"last_checkin\" style=\"${buttonStyle} flex: 1; text-align: center;\">Last<br>Check-In${getSortIcon('last_checkin')}</button>\n                </div></div>`;\n        juniorClubRosterList.insertAdjacentHTML('beforeend', headerHTML); // Add header\n        // --- List Item Generation ---\n        uniqueRoster.forEach((item, index)=>{\n            const li = document.createElement('li');\n            li.className = 'roster-item';\n            li.dataset.rosterIndex = index; // For detail view click\n            // Name used for ABC index mapping\n            const nameToIndex = item.isParentOnlyView ? item.name : item.isAllView ? item.childData.name : item.name;\n            li.dataset.playerName = nameToIndex;\n            const lastCheckInDate = item.lastCheckInMs > 0 ? new Date(item.lastCheckInMs).toLocaleDateString('en-ZA') : 'N/A';\n            const itemStyle = \"min-width: 0; text-align: center;\"; // Base style for columns\n            // Populate innerHTML based on view type\n            if (item.isParentOnlyView) // *** UPDATED ITEM for Parents Only view ***\n            li.innerHTML = `<div class=\"roster-row\">\n                        <span class=\"roster-col-name\" style=\"font-weight: 700; color: var(--primary-blue); flex: 2.5; text-align: left;\">${item.name}</span>\n                        <span class=\"roster-col-contact\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.phone}</span>\n                        <span class=\"roster-col-email\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${item.email}</span>\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\n                    </div>`;\n            else if (item.isAllView) li.innerHTML = `<div class=\"roster-row\">\n                        <div class=\"roster-col-name\" style=\"display: flex; flex-direction: column; flex: 2.5; text-align: left;\">\n                            <span style=\"font-weight: 700; color: var(--primary-blue);\">${item.parentName}</span>\n                            <span style=\"font-size: 0.9em; color: var(--dark-text); padding-left: 1rem;\">${item.childData.name}</span>\n                        </div>\n                        <span class=\"roster-col-gender\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.childData.gender}</span>\n                        <span class=\"roster-col-age\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.childData.ageDisplay}</span>\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\n                    </div>`;\n            else {\n                li.style.padding = '0.8rem 1rem'; // Specific padding for children view\n                li.innerHTML = `<div class=\"roster-row\">\n                        <span class=\"roster-col-name\" style=\"font-weight: 700; color: var(--dark-text); flex: 2.5; text-align: left;\">${item.name}</span>\n                        <span class=\"roster-col-gender\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.gender}</span>\n                        <span class=\"roster-col-age\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.ageDisplay}</span>\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\n                    </div>`;\n            }\n            juniorClubRosterList.appendChild(li); // Add item to list\n        });\n        // Re-attach sort listeners to header buttons\n        juniorClubRosterList.querySelectorAll('.roster-sort-btn').forEach((btn)=>{\n            btn.removeEventListener('click', handleRosterSortClick); // Prevent duplicates\n            btn.addEventListener('click', handleRosterSortClick);\n        });\n        // Setup ABC Index\n        setupListWithIndex(indexList, juniorClubRosterList, document.getElementById('junior-club-roster-abc-index'));\n    }\n    // New handler for the radio buttons\n    function handleRosterTypeFilterChange(e) {\n        state.juniorClub.rosterFilter.type = e.target.value;\n        saveState();\n        renderJuniorClubRoster();\n    }\n    // New handler function for sort button clicks (The correct and final version)\n    function handleRosterSortClick(e) {\n        // Find the button element by traversing up from the click target\n        const button = e.target.closest('[data-sort-key]');\n        if (!button) return;\n        const key = button.dataset.sortKey;\n        if (key) {\n            if (state.juniorClub.rosterFilter.sortKey === key) state.juniorClub.rosterFilter.sortOrder = state.juniorClub.rosterFilter.sortOrder === 'asc' ? 'desc' : 'asc';\n            else {\n                state.juniorClub.rosterFilter.sortKey = key;\n                state.juniorClub.rosterFilter.sortOrder = key === 'name' ? 'asc' : 'desc';\n            }\n            saveState();\n            renderJuniorClubRoster();\n        }\n    }\n    function isChildFieldComplete(group) {\n        const childName = group.querySelector('[name=\"childName\"]').value.trim();\n        const childSurname = group.querySelector('[name=\"childSurname\"]').value.trim();\n        const childDob = group.querySelector('[name=\"childBirthDate\"]').value;\n        const childGender = group.querySelector(`input[name^=\"child-gender\"]:checked`);\n        return childName.length > 0 && childSurname.length > 0 && !!childDob && !!childGender;\n    }\n    function checkAndCollapseChild(group) {\n        const isComplete = isChildFieldComplete(group);\n        group.dataset.complete = isComplete ? 'true' : 'false';\n    }\n    function showChildSelectionModal(parent) {\n        attendingChildrenList.innerHTML = \"\";\n        childSelectionModal.dataset.parentId = parent.id;\n        childSelectionModal.querySelector('h3').textContent = `${parent.name} ${parent.surname}'s Children`;\n        // NEW: Compile a set of all currently checked-in junior players\n        const allCheckedInJuniorNames = new Set([\n            ...state.availablePlayers.filter((p)=>p.isJunior).map((p)=>p.name),\n            ...state.courts.flatMap((c)=>c.players).filter((p)=>p.isJunior).map((p)=>p.name),\n            // CRITICAL ADDITION: Include activeChildren from the junior club state\n            ...state.juniorClub.activeChildren.map((c)=>c.name)\n        ]);\n        parent.registeredChildren.forEach((child)=>{\n            const li = document.createElement('li');\n            // FIX 1: Trim the reconstructed full name string for the checkbox value.\n            const childFullName = `${child.name} ${child.surname}`.trim();\n            li.innerHTML = `\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\n                    <input type=\"checkbox\" name=\"attendingChild\" value=\"${childFullName}\" data-child-name=\"${child.name}\" style=\"margin-right: 1rem;\">\n                    <div style=\"flex-grow: 1;\">\n                        <span style=\"font-weight: 500;\">${child.name} ${child.surname}</span>\n                    </div>\n                </label>\n            `;\n            attendingChildrenList.appendChild(li);\n        });\n        childSelectionConfirmBtn.disabled = true;\n        childSelectionConfirmBtn.textContent = 'Check In (0 Children)';\n        juniorClubModal.classList.add('hidden');\n        childSelectionModal.classList.remove('hidden');\n    }\n    /**\r\n     * Renders the main Junior Club check-in list, dynamically switching between\r\n     * Parent Name and Child Name display based on state.juniorClub.checkInFilter.displayMode.\r\n     */ function renderJuniorClubCheckInList() {\n        juniorClubList.innerHTML = \"\";\n        const displayMode = state.juniorClub.checkInFilter.displayMode;\n        // --- START OF NEW FILTER HTML INJECTION ---\n        const filterHTML = `\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\n                <div class=\"radio-group\" id=\"junior-club-name-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\n                    <label> <input type=\"radio\" name=\"junior-club-name-filter\" value=\"parent\" ${displayMode === 'parent' ? 'checked' : ''}> Parent Name</label>\n                    <label> <input type=\"radio\" name=\"junior-club-name-filter\" value=\"child\" ${displayMode === 'child' ? 'checked' : ''}> Child Name</label>\n                </div>\n            </div>\n        `;\n        juniorClubList.insertAdjacentHTML('afterbegin', filterHTML);\n        // RE-ATTACH LISTENER to the newly injected radio group\n        juniorClubList.querySelector('#junior-club-name-filter-group').addEventListener('change', handleJuniorClubNameFilterChange);\n        // --- END OF NEW FILTER HTML INJECTION ---\n        // 1. Get a list of all player names currently at the club (available or on court)\n        const checkedInPlayerNames = new Set(state.juniorClub.activeChildren.map((c)=>c.name));\n        let finalListItems = [];\n        state.juniorClub.parents.forEach((parent)=>{\n            parent.registeredChildren.forEach((child)=>{\n                const childFullName = `${child.name} ${child.surname}`.trim();\n                const isCheckedIn = checkedInPlayerNames.has(childFullName);\n                const age = calculateAge(child.birthDate);\n                const gender = child.gender || '?';\n                const ageDisplay = age !== null ? `${age}y` : 'N/A';\n                const item = {\n                    parent: parent,\n                    childFullName: childFullName,\n                    childName: child.name,\n                    childSurname: child.surname,\n                    childDisplay: `${child.name.split(' ')[0]} (${ageDisplay} ${gender})`,\n                    canCheckIn: !isCheckedIn,\n                    sortKey: displayMode === 'parent' ? parent.name : child.name\n                };\n                finalListItems.push(item);\n            });\n        });\n        let renderedList = [];\n        if (displayMode === 'parent') {\n            // Find all parents who have at least one child available for check-in. This now works correctly.\n            const availableParents = state.juniorClub.parents.filter((parent)=>parent.registeredChildren.some((child)=>!checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim()))).sort((a, b)=>a.name.localeCompare(b.name));\n            renderedList = availableParents.map((parent)=>{\n                // Find the first child who is NOT checked in to display their details\n                const firstAvailableChild = parent.registeredChildren.find((child)=>!checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim())) || parent.registeredChildren[0];\n                const age = calculateAge(firstAvailableChild.birthDate);\n                const gender = firstAvailableChild.gender || '?';\n                const ageDisplay = age !== null ? `${age}y` : 'N/A';\n                // Count how many children are NOT checked in for this parent\n                const availableChildCount = parent.registeredChildren.filter((child)=>!checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim())).length;\n                return {\n                    parent: parent,\n                    primaryDisplay: `${parent.name} ${parent.surname}`,\n                    secondaryDisplay: `${firstAvailableChild.name.split(' ')[0]} (${ageDisplay} ${gender})`,\n                    childCount: availableChildCount,\n                    sortKey: parent.name,\n                    canCheckIn: true\n                };\n            });\n        } else // Filter to show only children who are NOT checked in. This also works correctly now.\n        renderedList = finalListItems.filter((item)=>item.canCheckIn).sort((a, b)=>a.sortKey.localeCompare(b.sortKey)).map((item)=>({\n                parent: item.parent,\n                primaryDisplay: `${item.childName} ${item.childSurname}`,\n                secondaryDisplay: `Parent: ${item.parent.name} ${item.parent.surname}`,\n                sortKey: item.sortKey,\n                canCheckIn: true\n            }));\n        if (renderedList.length === 0) {\n            const li = document.createElement(\"li\");\n            li.style.justifyContent = \"center\";\n            li.style.textAlign = \"center\";\n            li.style.color = \"#6c757d\";\n            li.textContent = \"All junior players are currently checked in.\";\n            juniorClubList.appendChild(li);\n        } else renderedList.forEach((item)=>{\n            const parent = item.parent;\n            const li = document.createElement(\"li\");\n            // This logic correctly determines if the parent has ANY child left to check in\n            const canCheckIn = parent.registeredChildren.some((child)=>!checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim()));\n            const childCountDisplay = displayMode === 'parent' && item.childCount > 0 ? `${item.childCount} Child${item.childCount === 1 ? '' : 'ren'}` : '';\n            // Set opacity to 0.5 if no children are available for check-in\n            const checkInIcon = canCheckIn ? `<span class=\"action-icon add\" data-parent-id=\"${parent.id}\">+</span>` : `<span class=\"action-icon\" data-parent-id=\"${parent.id}\" style=\"color: var(--neutral-color); opacity: 0.5;\">+</span>`;\n            const displayContainerStyle = \"flex-grow: 1; font-weight: 500; display: flex; flex-direction: column;\";\n            li.innerHTML = `\n                    <span style=\"${displayContainerStyle}\">\n                        <span style=\"font-weight: 500;\">${item.primaryDisplay}</span>\n                        <span style=\"font-size: 0.9em; color: #6c757d;\">${item.secondaryDisplay}</span>\n                    </span>\n                    <span style=\"margin-right: 1rem; color: #6c757d; min-width: 70px; text-align: right;\">${childCountDisplay}</span>\n                    <span class=\"action-icon edit\" data-parent-id=\"${parent.id}\" title=\"Edit Parent\"><i class=\"mdi mdi-pencil\"></i></span>\n                    ${checkInIcon}\n                `;\n            li.dataset.parentId = parent.id;\n            li.dataset.playerName = item.primaryDisplay; // CRITICAL: Set for indexing\n            juniorClubList.appendChild(li);\n        });\n        // CRITICAL: Setup the index\n        const indexList = renderedList.map((item)=>({\n                name: item.primaryDisplay\n            }));\n        setupListWithIndex(indexList, juniorClubList, document.getElementById('junior-club-abc-index'));\n    }\n    // New wrapper function to update the entire modal display\n    function showJuniorClubModal() {\n        // Render the list with the current filter settings\n        renderJuniorClubCheckInList();\n        setActiveMobileMenuItem('mobile-junior-club-btn');\n        juniorClubModal.classList.remove('hidden');\n    }\n    // Function to handle filter change\n    function handleJuniorClubNameFilterChange(e) {\n        state.juniorClub.checkInFilter.displayMode = e.target.value;\n        saveState();\n        renderJuniorClubCheckInList();\n    }\n    function showChildSelectionModal(parent) {\n        attendingChildrenList.innerHTML = \"\";\n        childSelectionModal.dataset.parentId = parent.id;\n        childSelectionModal.querySelector('h3').textContent = `${parent.name} ${parent.surname}'s Children`;\n        // NEW: Compile a set of all currently checked-in junior players\n        const allCheckedInJuniorNames = new Set([\n            ...state.availablePlayers.filter((p)=>p.isJunior).map((p)=>p.name),\n            ...state.courts.flatMap((c)=>c.players).filter((p)=>p.isJunior).map((p)=>p.name),\n            // CRITICAL ADDITION: Include activeChildren from the junior club state\n            ...state.juniorClub.activeChildren.map((c)=>c.name)\n        ]);\n        parent.registeredChildren.forEach((child)=>{\n            const li = document.createElement('li');\n            // FIX 1: Trim the reconstructed full name string for the checkbox value.\n            const childFullName = `${child.name} ${child.surname}`.trim();\n            li.innerHTML = `\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\n                    <input type=\"checkbox\" name=\"attendingChild\" value=\"${childFullName}\" data-child-name=\"${child.name}\" style=\"margin-right: 1rem;\">\n                    <div style=\"flex-grow: 1;\">\n                        <span style=\"font-weight: 500;\">${child.name} ${child.surname}</span>\n                    </div>\n                </label>\n            `;\n            attendingChildrenList.appendChild(li);\n        });\n        childSelectionConfirmBtn.disabled = true;\n        childSelectionConfirmBtn.textContent = 'Check In (0 Children)';\n        juniorClubModal.classList.add('hidden');\n        childSelectionModal.classList.remove('hidden');\n    }\n    function validateNewParentForm(shouldRender = true) {\n        const parentName = parentNameInput.value.trim();\n        const parentSurname = parentSurnameInput.value.trim();\n        const parentEmail = parentEmailInput.value.trim(); // <-- ADDED email input reading\n        const parentPhone = parentPhoneInput.value.trim();\n        // Basic email validation: check if it contains @ and has text before and after\n        const isEmailValid = parentEmail.includes('@') && parentEmail.indexOf('@') > 0 && parentEmail.indexOf('@') < parentEmail.length - 1; // <-- ADDED email validation\n        // FIX: Changed phone validation from >= 9 to >= 8 and ADDED email check\n        const parentFieldsValid = parentName.length > 0 && parentSurname.length > 0 && isEmailValid && parentPhone.length >= 8; // <-- UPDATED condition\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\n        let allChildrenComplete = childGroups.length > 0; // Assume complete if > 0 children exist initially\n        const addChildBtn = document.getElementById('add-child-btn');\n        const removeChildBtn = document.getElementById('remove-child-btn-main'); // Ensure this ID matches your HTML\n        const lastChildGroup = childGroups.length > 0 ? childGroups[childGroups.length - 1] : null;\n        childGroups.forEach((group)=>{\n            // Check each child group; if ANY are incomplete, set allChildrenComplete to false\n            if (!isChildFieldComplete(group)) allChildrenComplete = false;\n        });\n        const shouldParentBeCollapsed = parentFieldsValid;\n        const shouldChildrenBeExpanded = parentFieldsValid; // Children section expands when parent is valid\n        // Update the state based on validation results\n        state.juniorClub.registrationFlow.parentCollapsed = shouldParentBeCollapsed;\n        state.juniorClub.registrationFlow.childrenExpanded = shouldChildrenBeExpanded;\n        // Can add a child if parent is valid AND (either no children exist OR the last child is complete)\n        const canAddChild = parentFieldsValid && (!lastChildGroup || isChildFieldComplete(lastChildGroup));\n        // Can remove a child only if there's more than one child group present\n        const canRemoveChild = childGroups.length > 1; // Simplified this condition\n        // Show/hide/disable Add Child button\n        if (addChildBtn) {\n            addChildBtn.style.display = shouldChildrenBeExpanded ? 'block' : 'none'; // Only show if children section is expanded\n            addChildBtn.disabled = !canAddChild;\n        }\n        // Show/hide/disable Remove Child button\n        if (removeChildBtn) {\n            removeChildBtn.style.display = shouldChildrenBeExpanded && childGroups.length > 0 ? 'block' : 'none'; // Show if children expanded and > 0 exist\n            removeChildBtn.disabled = !canRemoveChild;\n        }\n        // Determine if the final Confirm button should be enabled\n        const isConfirmReady = parentFieldsValid && allChildrenComplete;\n        newParentConfirmBtn.disabled = !isConfirmReady;\n        // Update Confirm button styling based on readiness\n        if (isConfirmReady) {\n            newParentConfirmBtn.style.setProperty('background-color', 'var(--confirm-color)', 'important');\n            newParentConfirmBtn.style.setProperty('border-color', 'var(--confirm-color)', 'important');\n        } else {\n            newParentConfirmBtn.style.setProperty('background-color', 'var(--inactive-color)', 'important');\n            newParentConfirmBtn.style.setProperty('border-color', 'var(--inactive-color)', 'important');\n        }\n        // Render the parent form UI based on the updated state if requested\n        if (shouldRender) renderParentForm();\n    }\n    function registerNewParent() {\n        const parentName = formatCase(parentNameInput.value.trim());\n        const parentSurname = formatCase(parentSurnameInput.value.trim());\n        const parentEmail = parentEmailInput.value.trim().toLowerCase(); // <-- Store email lowercase\n        const parentPhone = parentPhoneInput.value.trim();\n        // Get country code and create full phone number\n        const countryCode = document.getElementById('parent-country-code')?.value || '+27';\n        const fullPhone = countryCode + parentPhone; // No leading zero needed with country code\n        // Determine mode and parent ID\n        const currentMode = newParentModal.dataset.mode || 'new'; // 'new' or 'edit'\n        const newParentId = parentName + parentSurname; // Potential new ID based on current name/surname\n        // 1. Collect all child data\n        const children1 = [];\n        childrenContainer.querySelectorAll('.child-field-group').forEach((group)=>{\n            const childName = formatCase(group.querySelector('[name=\"childName\"]').value.trim());\n            const childSurname = formatCase(group.querySelector('[name=\"childSurname\"]').value.trim());\n            const childBirthDate = group.querySelector('[name=\"childBirthDate\"]').value;\n            const childGenderChecked = group.querySelector('input[type=\"radio\"]:checked');\n            const childGender = childGenderChecked ? childGenderChecked.value : '?';\n            // Ensure all child fields are actually filled before adding\n            if (childName && childSurname && childBirthDate && childGender !== '?') children1.push({\n                name: childName,\n                surname: childSurname,\n                gender: childGender,\n                birthDate: childBirthDate\n            });\n        });\n        // Basic validation: Must have filled parent details and at least one complete child\n        const parentFieldsValid = parentName.length > 0 && parentSurname.length > 0 && parentEmail.includes('@') && parentPhone.length >= 8;\n        if (!parentFieldsValid || children1.length === 0) {\n            playCustomTTS(\"Please complete all parent and child details before confirming.\");\n            return; // Stop if validation fails\n        }\n        // 2. Check for duplicate Parent ID during NEW registration\n        //    (Only check if it's NOT edit mode AND the potential new ID already exists)\n        if (currentMode !== 'edit' && state.juniorClub.parents.some((p)=>p.id === newParentId)) {\n            playCustomTTS(\"A parent with this name is already registered.\");\n            return;\n        }\n        let parentToUpdate = null;\n        if (currentMode === 'edit') {\n            // In Edit mode, find the original parent entry using the stored original ID\n            const originalId = newParentModal.dataset.originalParentId;\n            parentToUpdate = state.juniorClub.parents.find((p)=>p.id === originalId);\n            if (!parentToUpdate) {\n                console.error(\"Error editing parent: Original parent not found with ID\", originalId);\n                playCustomTTS(\"Error finding parent profile to update.\");\n                return; // Stop if original parent not found\n            }\n        }\n        // 3. Create or Update Parent Object\n        if (parentToUpdate) {\n            // --- EDIT MODE: Update existing parent ---\n            parentToUpdate.name = parentName;\n            parentToUpdate.surname = parentSurname;\n            parentToUpdate.phone = fullPhone;\n            parentToUpdate.email = parentEmail; // <-- SAVING EMAIL\n            parentToUpdate.id = newParentId; // Update ID in case name/surname changed\n            parentToUpdate.registeredChildren = children1; // Overwrite children list\n            playCustomTTS(`${parentName}'s profile has been successfully updated.`);\n        } else {\n            // --- NEW REGISTRATION MODE ---\n            parentToUpdate = {\n                id: newParentId,\n                name: parentName,\n                surname: parentSurname,\n                phone: fullPhone,\n                email: parentEmail,\n                registeredChildren: children1\n            };\n            state.juniorClub.parents.push(parentToUpdate);\n            playCustomTTS(`${parentName} successfully registered.`);\n        }\n        // 4. Clean up state and UI\n        state.juniorClub.parents.sort((a, b)=>a.name.localeCompare(b.name)); // Keep sorted\n        // Restore default modal state for next use\n        newParentModal.classList.add('hidden');\n        newParentModal.querySelector('h3').textContent = 'New Parent Registration';\n        newParentModal.dataset.mode = ''; // Clear mode\n        delete newParentModal.dataset.originalParentId; // Clear original ID\n        newParentConfirmBtn.textContent = 'Confirm Registration';\n        parentNameInput.value = '';\n        parentSurnameInput.value = '';\n        parentPhoneInput.value = '';\n        parentEmailInput.value = ''; // Clear email input\n        childrenContainer.innerHTML = '';\n        document.getElementById('parent-collapsed-display').innerHTML = ''; // Clear summary display\n        // Reset the flow state\n        state.juniorClub.registrationFlow = {\n            parentCollapsed: false,\n            childrenExpanded: false\n        };\n        // 5. If it was a NEW registration, proceed to check-in. If it was an EDIT, return to the main list.\n        if (currentMode === 'edit') showJuniorClubModal(); // Show updated main list\n        else showChildSelectionModal(parentToUpdate); // Proceed to check-in modal\n        saveState(); // Save changes\n    }\n    function showRemoveChildSelectionModal() {\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\n        if (childGroups.length <= 1) return; // Should be disabled if only one remains\n        childrenForRemovalList.innerHTML = '';\n        removeChildSelectionModal.dataset.selectedGroups = '';\n        childGroups.forEach((group, index)=>{\n            const groupId = group.dataset.groupId;\n            const childName = group.querySelector('[name=\"childName\"]').value.trim();\n            const childSurname = group.querySelector('[name=\"childSurname\"]').value.trim();\n            const displayName = childName || childSurname ? `${childName} ${childSurname}`.trim() : `Child ${index + 1} (Empty)`;\n            const li = document.createElement('li');\n            li.innerHTML = `\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\n                    <input type=\"checkbox\" name=\"childToRemove\" value=\"${groupId}\" style=\"margin-right: 1rem;\">\n                    <div style=\"flex-grow: 1;\">\n                        <span style=\"font-weight: 500;\">${displayName}</span>\n                    </div>\n                </label>\n            `;\n            childrenForRemovalList.appendChild(li);\n        });\n        // Reset Confirm button state\n        removeChildSelectionConfirmBtn.disabled = true;\n        removeChildSelectionConfirmBtn.textContent = 'Remove Selected (0 Children)';\n        newParentModal.classList.add('hidden');\n        removeChildSelectionModal.classList.remove('hidden');\n    }\n    function executeRemoveSingleChild() {\n        const groupId = cancelConfirmModal.dataset.childGroupId;\n        const groupToRemove = document.querySelector(`.child-field-group[data-group-id=\"${groupId}\"]`);\n        if (groupToRemove) groupToRemove.remove();\n        // If that was the last child, add a new empty form to start over\n        if (childrenContainer.querySelectorAll('.child-field-group').length === 0) generateChildField();\n        cancelConfirmModal.classList.add(\"hidden\");\n        newParentModal.classList.remove('hidden'); // Re-show the parent registration form\n        validateNewParentForm();\n        resetConfirmModal();\n    }\n    // --- NEW FUNCTION: Executes the removal of selected child fields ---\n    function executeRemoveChild() {\n        const selectedIds = Array.from(childrenForRemovalList.querySelectorAll('input[name=\"childToRemove\"]:checked')).map((cb)=>cb.value);\n        if (selectedIds.length === 0) return;\n        selectedIds.forEach((id)=>{\n            const groupToRemove = document.querySelector(`.child-field-group[data-group-id=\"${id}\"]`);\n            if (groupToRemove) groupToRemove.remove();\n        });\n        // --- START OF FIX ---\n        // After removal, check if any child groups are left.\n        const remainingChildGroups = childrenContainer.querySelectorAll('.child-field-group').length;\n        if (remainingChildGroups === 0) // If no children are left, automatically add a new, empty child field.\n        generateChildField();\n        // --- END OF FIX ---\n        removeChildSelectionModal.classList.add('hidden');\n        newParentModal.classList.remove('hidden');\n        validateNewParentForm();\n    }\n    // TEMPORARY DUTY HANDOVER LISTENERS\n    tempDutyCancelBtn.addEventListener('click', ()=>{\n        tempDutyHandoverModal.classList.add('hidden');\n        tempDutyHandoverModal.callback = null;\n    });\n    tempDutyConfirmBtn.addEventListener('click', handleTempDutyHandoverConfirm);\n    // New Parent Modal: Handle the main Remove Child button click\n    document.getElementById('remove-child-btn-main').addEventListener('click', ()=>{\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\n        if (childGroups.length > 1) // If more than one child exists, show the selection modal as before.\n        showRemoveChildSelectionModal();\n        else if (childGroups.length === 1) {\n            // --- NEW LOGIC ---\n            // If exactly one child exists, show a direct confirmation prompt.\n            const childToRemove = childGroups[0];\n            const childName = childToRemove.querySelector('[name=\"childName\"]').value.trim() || 'this child';\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Removal\";\n            cancelConfirmModal.querySelector(\"p\").textContent = `Are you sure you want to remove ${childName}?`;\n            modalBtnYesConfirm.textContent = \"Confirm\";\n            modalBtnNo.textContent = \"Close\";\n            // Set a new mode for our confirmation logic\n            cancelConfirmModal.dataset.mode = \"removeSingleChild\";\n            cancelConfirmModal.dataset.childGroupId = childToRemove.dataset.groupId;\n            newParentModal.classList.add('hidden'); // Hide the parent form temporarily\n            cancelConfirmModal.classList.remove(\"hidden\"); // Show the confirmation\n        }\n    });\n    // Remove Child Selection Modal Listeners\n    removeChildSelectionBackBtn.addEventListener('click', ()=>{\n        removeChildSelectionModal.classList.add('hidden');\n        newParentModal.classList.remove('hidden');\n    });\n    removeChildSelectionConfirmBtn.addEventListener('click', executeRemoveChild);\n    // Update Confirm button on selection change\n    childrenForRemovalList.addEventListener('change', ()=>{\n        const checkedCount = childrenForRemovalList.querySelectorAll('input[name=\"childToRemove\"]:checked').length;\n        const isReady = checkedCount > 0;\n        removeChildSelectionConfirmBtn.disabled = !isReady;\n        removeChildSelectionConfirmBtn.textContent = `Remove Selected (${checkedCount} Child${checkedCount === 1 ? '' : 'ren'})`;\n        // --- START OF RESTRUCTURED CODE ---\n        if (isReady) {\n            // When ready, style as a white button with blue text and border\n            removeChildSelectionConfirmBtn.style.setProperty('background-color', 'white', 'important');\n            removeChildSelectionConfirmBtn.style.setProperty('color', 'var(--primary-blue)', 'important');\n            removeChildSelectionConfirmBtn.style.setProperty('border', '2px solid var(--primary-blue)', 'important');\n        } else {\n            // When disabled, revert to a neutral grey style\n            removeChildSelectionConfirmBtn.style.setProperty('background-color', 'var(--neutral-color)', 'important');\n            removeChildSelectionConfirmBtn.style.setProperty('color', 'white', 'important');\n            removeChildSelectionConfirmBtn.style.setProperty('border', '2px solid var(--neutral-color)', 'important');\n        }\n    // --- END OF RESTRUCTURED CODE ---\n    });\n    function handleChildSelectionConfirm() {\n        const parentId = childSelectionModal.dataset.parentId;\n        const parent = state.juniorClub.parents.find((p)=>p.id === parentId);\n        if (!parent) return;\n        const attendingCheckboxes = attendingChildrenList.querySelectorAll('input[name=\"attendingChild\"]:checked');\n        const attendingChildrenNames = Array.from(attendingCheckboxes).map((cb)=>cb.value);\n        if (attendingChildrenNames.length === 0) return;\n        const attendingChildren = parent.registeredChildren.filter((child)=>attendingChildrenNames.includes(`${child.name} ${child.surname}`.trim())).map((child)=>({\n                name: `${child.name} ${child.surname}`.trim(),\n                gender: child.gender,\n                guest: true,\n                isJunior: true,\n                parentName: parent.name + ' ' + parent.surname\n            }));\n        const allCheckedInNames = new Set([\n            ...state.availablePlayers.map((p)=>p.name),\n            ...state.courts.flatMap((c)=>c.players).map((p)=>p.name),\n            ...state.juniorClub.activeChildren.map((c)=>c.name)\n        ]);\n        const newChildren = attendingChildren.filter((c)=>!allCheckedInNames.has(c.name));\n        if (newChildren.length === 0) {\n            // playCustomTTS(\"All selected children are already checked in.\");\n            childSelectionModal.classList.add('hidden');\n            showJuniorClubModal(); // Show the main junior list again\n            return;\n        }\n        state.juniorClub.activeChildren.push(...newChildren);\n        const newHistoryEntry = {\n            id: Date.now(),\n            parentId: parent.id,\n            parentName: `${parent.name} ${parent.surname}`,\n            childNames: newChildren.map((c)=>c.name),\n            date: new Date().toISOString().split('T')[0],\n            isPaid: false\n        };\n        state.juniorClub.history.push(newHistoryEntry);\n        // --- START OF CHANGE ---\n        // The following block that pushes children to the main availablePlayers list has been removed.\n        // --- END OF CHANGE ---\n        childSelectionModal.classList.add('hidden');\n        const numCheckedIn = newChildren.length;\n        const childString = numCheckedIn === 1 ? 'child' : 'children';\n        // playCustomTTS(`${numCheckedIn} ${childString} checked in for ${parent.name}.`);\n        // Refresh the junior club list to show the updated check-in status\n        showJuniorClubModal();\n        saveState();\n    }\n    function formatChildNames(childNames) {\n        return childNames.join(', ');\n    }\n    function showJuniorClubStatsModal() {\n        juniorClubModal.classList.add('hidden');\n        juniorClubStatsModal.classList.remove('hidden');\n        // Reset the 'details' button state\n        juniorClubStatsDetailsBtn.disabled = true;\n        juniorClubStatsDetailsBtn.style.backgroundColor = 'var(--inactive-color)';\n        // Render the list based on the current filter settings\n        renderJuniorClubHistory();\n    }\n    function renderJuniorClubHistory() {\n        juniorClubHistoryList.innerHTML = '';\n        const filter = state.juniorClub.statsFilter.paid;\n        // --- START OF NEW FILTER HTML INJECTION ---\n        const filterHTML = `\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\n                <div class=\"radio-group\" id=\"payment-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"all\" ${filter === 'all' ? 'checked' : ''}> All</label>\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"paid\" ${filter === 'paid' ? 'checked' : ''}> Paid</label>\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"unpaid\" ${filter === 'unpaid' ? 'checked' : ''}> Unpaid</label>\n                </div>\n            </div>\n        `;\n        juniorClubHistoryList.insertAdjacentHTML('afterbegin', filterHTML);\n        // RE-ATTACH LISTENER to the newly injected radio group\n        juniorClubHistoryList.querySelector('#payment-filter-group').addEventListener('change', handlePaymentFilterChange);\n        // --- END OF NEW FILTER HTML INJECTION ---\n        const filteredHistory = state.juniorClub.history.filter((entry)=>{\n            if (filter === 'all') return true;\n            if (filter === 'paid') return entry.isPaid === true;\n            if (filter === 'unpaid') return entry.isPaid === false;\n            return true;\n        }).sort((a, b)=>b.id - a.id);\n        // --- NEW LOGIC FOR ABC INDEXING ---\n        const indexList = filteredHistory.map((entry)=>({\n                name: entry.parentName\n            }));\n        if (filteredHistory.length === 0) {\n            document.getElementById('junior-club-history-abc-index').innerHTML = '';\n            juniorClubHistoryList.insertAdjacentHTML('beforeend', '<li class=\"waiting-message\">No history matches the current filter.</li>');\n            return;\n        }\n        filteredHistory.forEach((entry)=>{\n            const li = document.createElement('li');\n            li.className = 'history-item';\n            li.dataset.entryId = entry.id;\n            li.dataset.playerName = entry.parentName; // For ABC index\n            const paymentStatusText = entry.isPaid ? 'Paid' : 'Unpaid';\n            const paymentStatusClass = entry.isPaid ? 'paid' : 'unpaid';\n            const childNamesStr = entry.childNames.join(', ');\n            const date = new Date(entry.id).toLocaleDateString('en-ZA');\n            // --- CORRECTED HTML STRUCTURE (No outer wrapper div) ---\n            li.innerHTML = `\n                <div class=\"name-col\">\n                    <span style=\"font-weight: 500; color: var(--dark-text);\">${entry.parentName}</span>\n                    <span style=\"font-weight: 400; color: var(--dark-text); font-size: 0.95em; padding-left: 1rem;\">${childNamesStr}</span>\n                </div>\n                <div class=\"status-col\">\n                    <span class=\"payment-status ${paymentStatusClass}\">${paymentStatusText}</span>\n                    <span class=\"payment-date-text\" style=\"font-size: 0.85em; color: var(--neutral-color); display: block;\">${date}</span>\n                </div>\n            `;\n            // --- END CORRECTION ---\n            juniorClubHistoryList.appendChild(li);\n        });\n        // CRITICAL: Setup the index\n        setupListWithIndex(indexList, juniorClubHistoryList, document.getElementById('junior-club-history-abc-index'));\n    }\n    function updateDateDisplay(inputElement) {\n        const displayId = `date-display-${inputElement.id.split('-').pop()}`;\n        const displayElement = document.getElementById(displayId);\n        if (!displayElement) return;\n        const mask = \"YYYY/MM/DD\";\n        const cleanValue = inputElement.value.replace(/\\D/g, ''); // Raw numbers (e.g., \"202510\")\n        let formattedValue = '';\n        let valueIndex = 0;\n        for(let i = 0; i < mask.length; i++){\n            if (valueIndex >= cleanValue.length) {\n                // If out of numbers, show the rest of the mask as a faint placeholder\n                formattedValue += `<span class=\"date-placeholder\">${mask.substring(i)}</span>`;\n                break;\n            }\n            if (mask[i].match(/[YMD]/)) {\n                formattedValue += cleanValue[valueIndex];\n                valueIndex++;\n            } else // Automatically add the '/' separator\n            if (cleanValue.length > valueIndex) formattedValue += mask[i];\n            else {\n                formattedValue += `<span class=\"date-placeholder\">${mask.substring(i)}</span>`;\n                break;\n            }\n        }\n        displayElement.innerHTML = formattedValue;\n    }\n    function handleDateInput(currentFormattedValue, key) {\n        let rawNumbers = (currentFormattedValue || '').replace(/\\D/g, '');\n        if (key === 'backspace') rawNumbers = rawNumbers.slice(0, -1);\n        else if (key === 'clear') rawNumbers = '';\n        else if (key.match(/[0-9]/) && rawNumbers.length < 8) rawNumbers += key;\n        let formatted = rawNumbers;\n        if (rawNumbers.length > 4) formatted = `${rawNumbers.slice(0, 4)}/${rawNumbers.slice(4)}`;\n        if (rawNumbers.length > 6) formatted = `${formatted.slice(0, 7)}/${rawNumbers.slice(7)}`;\n        return formatted;\n    }\n    function handleJuniorClubHistoryClick(e) {\n        const li = e.target.closest('.history-item');\n        if (!li) return;\n        // Deselect all others\n        juniorClubHistoryList.querySelectorAll('.history-item').forEach((item)=>{\n            item.style.backgroundColor = 'transparent';\n        });\n        // Select the clicked one\n        li.style.backgroundColor = '#f1f1f1';\n        // Store the selected entry ID\n        juniorClubStatsModal.dataset.selectedEntryId = li.dataset.entryId;\n        // Enable button\n        juniorClubStatsDetailsBtn.disabled = false;\n        juniorClubStatsDetailsBtn.style.backgroundColor = 'var(--confirm-color)';\n        juniorClubStatsDetailsBtn.style.borderColor = 'var(--confirm-color)';\n    }\n    function renderParentForm() {\n        const { parentCollapsed, childrenExpanded } = state.juniorClub.registrationFlow;\n        console.log('Rendering Form - State Read:', {\n            parentCollapsed,\n            childrenExpanded\n        }); // You should see {true, true}\n        const parentFieldsEl = document.getElementById('parent-fields');\n        const parentCollapseEl = document.getElementById('parent-collapsed-display');\n        const childrenHeader = newParentModal.querySelector('h4'); // Assuming this selects the \"Children Details\" header\n        const childrenContainerWrapper = document.getElementById('children-container-wrapper');\n        const childrenContainer = document.getElementById('children-container'); // Make sure this is selected too\n        // --- Parent Section ---\n        if (parentCollapseEl) {\n            const shouldHideSummary = !parentCollapsed;\n            console.log(`Parent Summary (#parent-collapsed-display): Setting hidden=${shouldHideSummary}`);\n            parentCollapseEl.classList.toggle('hidden', shouldHideSummary);\n            // Verify style after toggle\n            requestAnimationFrame(()=>console.log(`Parent Summary computed display: ${window.getComputedStyle(parentCollapseEl).display}`));\n        } else console.error(\"ELEMENT NOT FOUND: #parent-collapsed-display\");\n        if (parentFieldsEl) {\n            const newParentFieldsDisplay = parentCollapsed ? 'none' : 'block';\n            console.log(`Parent Fields (#parent-fields): Setting display=${newParentFieldsDisplay}`);\n            parentFieldsEl.style.display = newParentFieldsDisplay;\n            // Verify style after setting\n            requestAnimationFrame(()=>console.log(`Parent Fields computed display: ${window.getComputedStyle(parentFieldsEl).display}`));\n        } else console.error(\"ELEMENT NOT FOUND: #parent-fields\");\n        // --- Populate Parent Summary (Only if collapsed and element exists) ---\n        if (parentCollapsed && parentCollapseEl) {\n            console.log(\"Populating parent summary...\");\n            const parentName = document.getElementById('parent-name-input')?.value.trim(); // Use safe navigation ?.\n            const parentSurname = document.getElementById('parent-surname-input')?.value.trim();\n            const parentEmail = document.getElementById('parent-email-input')?.value.trim();\n            const parentPhone = document.getElementById('parent-phone-input')?.value.trim();\n            parentCollapseEl.innerHTML = `\n                <div class=\"collapsed-summary\">\n                    <span>${parentName || '?'} ${parentSurname || '?'}</span>\n                    <span>${parentEmail || '?'} | ${parentPhone || '?'}</span>\n                </div>\n                <i class=\"mdi mdi-pencil edit-icon\"></i>\n            `;\n            // Re-attach listener logic here...\n            if (!parentCollapseEl.dataset.listenerBound) {\n                parentCollapseEl.addEventListener('click', (e)=>{\n                    if (e.target.closest('.collapsed-summary') || e.target.closest('.edit-icon')) {\n                        state.juniorClub.registrationFlow.parentCollapsed = false;\n                        renderParentForm();\n                    }\n                });\n                parentCollapseEl.dataset.listenerBound = 'true';\n            }\n        }\n        // --- Children Section ---\n        if (childrenHeader) {\n            const shouldHideHeader = !childrenExpanded;\n            console.log(`Children Header (h4): Setting hidden=${shouldHideHeader}`);\n            childrenHeader.classList.toggle('hidden', shouldHideHeader);\n        } else console.warn(\"Children header (h4) not found within newParentModal.\");\n        if (childrenContainerWrapper) {\n            const newWrapperDisplay = childrenExpanded ? 'block' : 'none';\n            console.log(`Children Wrapper (#children-container-wrapper): Setting display=${newWrapperDisplay}`); // Should log 'block'\n            childrenContainerWrapper.style.display = newWrapperDisplay;\n            // Verify style after setting\n            requestAnimationFrame(()=>console.log(`Children Wrapper computed display: ${window.getComputedStyle(childrenContainerWrapper).display}`));\n        } else console.error(\"ELEMENT NOT FOUND: #children-container-wrapper\");\n        // --- Generate First Child / Render Children ---\n        if (childrenExpanded) {\n            if (!childrenContainer) console.error(\"ELEMENT NOT FOUND: #children-container. Cannot add child fields.\");\n            else {\n                const childGroupCount = childrenContainer.querySelectorAll('.child-field-group').length;\n                console.log(`Checking if first child needed. childrenExpanded=${childrenExpanded}, childGroupCount=${childGroupCount}, parentCollapsed=${parentCollapsed}`);\n                if (childGroupCount === 0 && parentCollapsed) {\n                    console.log(\"Condition met: Generating first child field...\");\n                    generateChildField();\n                } else if (childGroupCount === 0 && !parentCollapsed) console.log(\"Skipping child generation: Parent not collapsed yet.\");\n                else console.log(\"Skipping child generation: Child fields already exist.\");\n                renderChildFields();\n            }\n        } else console.log(\"Skipping child generation/rendering: childrenExpanded is false.\");\n    }\n    // NEW FUNCTION: Renders each individual child field group (called by renderParentForm)\n    function renderChildFields() {\n        // --- Find the container once ---\n        const container = document.getElementById('children-container');\n        if (!container) {\n            console.error(\"renderChildFields: #children-container not found!\");\n            return;\n        }\n        const childGroups = container.querySelectorAll('.child-field-group');\n        console.log(`--- renderChildFields START --- Found ${childGroups.length} child groups.`);\n        childGroups.forEach((group, index)=>{\n            const isComplete = group.dataset.complete === 'true';\n            const collapsedDisplay = group.querySelector('.child-collapsed-display');\n            const expandedFields = group.querySelector('.child-expanded-fields');\n            console.log(`Group ${index + 1}: isComplete=${isComplete}`);\n            if (!collapsedDisplay) console.error(`Group ${index + 1}: '.child-collapsed-display' element NOT FOUND!`);\n            if (!expandedFields) console.error(`Group ${index + 1}: '.child-expanded-fields' element NOT FOUND!`);\n            // --- Toggle Visibility Logic ---\n            if (collapsedDisplay) collapsedDisplay.classList.toggle('hidden', !isComplete);\n            if (expandedFields) {\n                if (isComplete) {\n                    console.log(`Group ${index + 1}: Hiding expanded fields.`);\n                    expandedFields.style.display = 'none';\n                } else {\n                    console.log(`Group ${index + 1}: Setting expanded fields display to 'block'.`);\n                    expandedFields.style.display = 'block'; // Ensure it's 'block'\n                    // Log computed style AFTER setting it, wrapped in requestAnimationFrame\n                    requestAnimationFrame(()=>{\n                        const computedDisplay = window.getComputedStyle(expandedFields).display;\n                        console.log(`Group ${index + 1} expanded computed display: ${computedDisplay}`);\n                        if (computedDisplay !== 'block') console.warn(`CSS might be overriding display for Group ${index + 1}`);\n                    });\n                }\n            }\n            // --- Populate Collapsed Display (Only if complete) ---\n            if (isComplete && collapsedDisplay) {\n                // Safely get values from inputs within this specific group\n                const childName = group.querySelector('[name=\"childName\"]')?.value.trim();\n                const childSurname = group.querySelector('[name=\"childSurname\"]')?.value.trim();\n                const childDob = group.querySelector('[name=\"childBirthDate\"]')?.value;\n                const childGenderChecked = group.querySelector(`input[name^=\"child-gender\"]:checked`);\n                const childGender = childGenderChecked ? childGenderChecked.value : '?';\n                const childAge = calculateAge(childDob);\n                const genderDisplay = childGender === 'M' ? 'Male' : childGender === 'F' ? 'Female' : 'N/A';\n                const ageDisplay = childAge !== null ? `${childAge}y` : 'N/A';\n                collapsedDisplay.innerHTML = `\n                    <span class=\"collapsed-title\">${childName || '?'} ${childSurname || '?'}</span>\n                    <span class=\"collapsed-detail\">${ageDisplay} (${genderDisplay})</span>\n                    <i class=\"mdi mdi-pencil edit-icon\"></i>\n                `;\n                // Re-attach listener if needed (check if already bound)\n                if (!collapsedDisplay.dataset.listenerBound) {\n                    collapsedDisplay.addEventListener('click', (e)=>{\n                        if (e.target.closest('.collapsed-area') || e.target.closest('.edit-icon')) {\n                            group.dataset.complete = 'false';\n                            renderChildFields();\n                        }\n                    });\n                    collapsedDisplay.dataset.listenerBound = 'true';\n                }\n            }\n        }); // End forEach\n        console.log(\"--- renderChildFields END ---\");\n        // Revalidate parent form buttons without causing infinite render loop\n        validateNewParentForm(false);\n    }\n    // MODIFIED: Entry point for the New Parent Modal\n    function showNewParentModal() {\n        juniorClubModal.classList.add('hidden');\n        // --- THIS IS THE FIX ---\n        // 1. Reset the modal's title and mode\n        newParentModal.querySelector('h3').textContent = 'New Parent Registration';\n        newParentModal.dataset.mode = 'new'; // Explicitly set mode to 'new'\n        // 2. Reset the confirm button text\n        newParentConfirmBtn.textContent = 'Confirm Registration';\n        // --- END OF FIX ---\n        newParentModal.classList.remove('hidden');\n        // Reset/Initialize the form flow state\n        state.juniorClub.registrationFlow = {\n            parentCollapsed: false,\n            childrenExpanded: false\n        };\n        // --- AGGRESSIVE FIELD CLEARING ---\n        childrenContainer.innerHTML = '';\n        parentNameInput.value = '';\n        parentSurnameInput.value = '';\n        parentEmailInput.value = '';\n        parentPhoneInput.value = '';\n        // Clear the collapsed display element's content as well\n        document.getElementById('parent-collapsed-display').innerHTML = '';\n        // CRITICAL FIX: Ensure Parent Fields start visible, and Children start hidden\n        document.getElementById('parent-fields').style.display = 'block'; // Ensures expanded fields are visible\n        document.getElementById('children-container-wrapper').style.display = 'none'; // Ensures children start hidden\n        // DON'T add child field yet - wait for parent fields to be filled\n        // generateChildField(); \n        validateNewParentForm();\n        renderParentForm(); // Start the rendering process\n    }\n    function handlePaymentFilterChange(e) {\n        state.juniorClub.statsFilter.paid = e.target.value;\n        renderJuniorClubHistory();\n        saveState();\n    }\n    function showJuniorClubDetailModal() {\n        const entryId = juniorClubStatsModal.dataset.selectedEntryId;\n        const entry = state.juniorClub.history.find((e)=>e.id == entryId);\n        if (!entry) return;\n        document.getElementById('detail-parent-name').textContent = entry.parentName;\n        document.getElementById('detail-date').textContent = new Date(entry.id).toLocaleString('en-ZA');\n        document.getElementById('detail-children-list').innerHTML = entry.childNames.map((name)=>`<li><span>${name}</span></li>`).join('');\n        updateDetailModalButton(entry);\n        juniorClubStatsModal.classList.add('hidden');\n        juniorClubDetailModal.classList.remove('hidden');\n    }\n    function updateDetailModalButton(entry) {\n        const isPaid = entry.isPaid;\n        detailTogglePaidBtn.textContent = isPaid ? 'Mark as Unpaid' : 'Mark as Paid';\n        detailTogglePaidBtn.style.backgroundColor = isPaid ? 'var(--cancel-color)' : 'var(--confirm-color)';\n    }\n    function handleDetailTogglePaid() {\n        const entryId = juniorClubStatsModal.dataset.selectedEntryId;\n        const entry = state.juniorClub.history.find((e)=>e.id == entryId);\n        if (!entry) return;\n        // Toggle the status\n        entry.isPaid = !entry.isPaid;\n        const isNowPaid = entry.isPaid;\n        const childrenNames = entry.childNames;\n        const parent = state.juniorClub.parents.find((p)=>p.id === entry.parentId);\n        if (isNowPaid) {\n            // MARKED AS PAID -> CHECK OUT\n            // --- START FIX ---\n            // Also remove these children from the activeChildren list to prevent re-check-in issues\n            state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter((child)=>!childrenNames.includes(child.name));\n            // --- END FIX ---\n            const checkedOutChildren = state.availablePlayers.filter((p)=>childrenNames.includes(p.name));\n            state.availablePlayers = state.availablePlayers.filter((p)=>!childrenNames.includes(p.name));\n            checkedOutChildren.length;\n        } else // ... (rest of the function for marking as unpaid is correct)\n        // MARKED AS UNPAID -> CHECK BACK IN\n        if (parent) {\n            const checkedInPlayerNames = new Set([\n                ...state.availablePlayers.map((p)=>p.name),\n                ...state.courts.flatMap((c)=>c.players).map((p)=>p.name)\n            ]);\n            const childrenToReCheckIn = [];\n            entry.childNames.forEach((childName)=>{\n                if (!checkedInPlayerNames.has(childName)) {\n                    const childDetails = parent.registeredChildren.find((c)=>`${c.name} ${c.surname}` === childName);\n                    if (childDetails) childrenToReCheckIn.push({\n                        name: childName,\n                        gender: childDetails.gender || '?',\n                        guest: true,\n                        isJunior: true,\n                        isPaused: false\n                    });\n                    else childrenToReCheckIn.push({\n                        name: childName,\n                        gender: '?',\n                        guest: true,\n                        isJunior: true,\n                        isPaused: false\n                    });\n                }\n            });\n            state.availablePlayers.push(...childrenToReCheckIn);\n            if (childrenToReCheckIn.length > 0) {\n                const names = childrenToReCheckIn.map((c)=>c.name).join(' and ');\n            // playCustomTTS(`${names} checked back in as ${entry.parentName}'s session is marked unpaid.`);\n            }\n        }\n        updateDetailModalButton(entry);\n        // playCustomTTS(`${entry.parentName}'s session on ${new Date(entry.id).toLocaleDateString('en-ZA')} marked as ${entry.isPaid ? 'paid' : 'unpaid'}.`);\n        saveState();\n        renderJuniorClubHistory();\n        updateGameModeBasedOnPlayerCount();\n        enforceDutyPosition();\n        render();\n        checkAndPlayAlert(false);\n    }\n    // --- END JUNIOR CLUB HISTORY & STATS FUNCTIONS ---\n    // --- NEW: Screensaver Activity Listeners ---\n    document.addEventListener('click', resetInactivityTimer);\n    document.addEventListener('touchstart', resetInactivityTimer);\n    document.addEventListener('mousemove', resetInactivityTimer);\n    document.addEventListener('keydown', resetInactivityTimer);\n    // Listener specifically for the screensaver overlay\n    screensaverOverlay.addEventListener('click', (e)=>{\n        // Stop screensaver ONLY if the click wasn't on the \"I am interested\" button\n        if (!e.target.closest('#screensaver-interested-btn')) stopScreensaver(); // This correctly stops it\n        else {\n            // --- MODIFIED BLOCK ---\n            const button = e.target.closest('#screensaver-interested-btn');\n            const eventId = button ? button.dataset.eventId : null; // Get eventId from button\n            if (eventId) {\n                populateCheckInModal(); // Populate with members\n                checkInModal.style.zIndex = 10000; // Ensure it's above screensaver\n                checkInModal.classList.remove('hidden');\n                // Store event ID context specifically for screensaver interest\n                checkInModal.dataset.screensaverEventId = eventId;\n            }\n        // --- END MODIFIED BLOCK ---\n        }\n    });\n    // --- NEW: Event List Modal Listeners ---\n    document.getElementById('manage-events-btn')?.addEventListener('click', showEventListModal);\n    document.getElementById('close-event-list-btn')?.addEventListener('click', ()=>{\n        document.getElementById('event-list-modal')?.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden'); // Go back to admin settings\n    });\n    document.getElementById('create-new-event-btn')?.addEventListener('click', ()=>{\n        document.getElementById('event-list-modal')?.classList.add('hidden');\n        showEventCreateEditModal(); // Open edit modal in 'create' mode\n    });\n    // Use event delegation for edit buttons and toggles within the list\n    document.getElementById('event-list')?.addEventListener('click', (e)=>{\n        const button = e.target.closest('.edit-event-btn');\n        const deleteButton = e.target.closest('.delete-event-btn');\n        const toggle = e.target.closest('.event-active-toggle');\n        const listItem = e.target.closest('.event-list-item');\n        const eventId = listItem ? listItem.dataset.eventId : null;\n        if (button && eventId) {\n            // Edit button clicked\n            document.getElementById('event-list-modal')?.classList.add('hidden');\n            showEventCreateEditModal(eventId); // Open edit modal in 'edit' mode\n        } else if (deleteButton && eventId) // Delete button clicked\n        deleteEvent(eventId);\n        else if (toggle && eventId) {\n            // Active toggle changed\n            const event = state.events.find((ev)=>ev.id == eventId);\n            if (event) {\n                event.isActive = toggle.checked;\n                saveState();\n                // Optional: Provide feedback or maybe restart screensaver if it was running?\n                // If screensaver is currently running, stopping it will force a refresh next time\n                if (!screensaverOverlay.classList.contains('hidden')) {\n                    stopScreensaver();\n                    resetInactivityTimer(); // Start timer again\n                }\n            }\n        }\n    });\n    // --- NEW: Add listener to header logo for manual screensaver start ---\n    const headerLogoElement = document.getElementById('header-logo');\n    if (headerLogoElement) headerLogoElement.addEventListener('click', ()=>{\n        // Clear any pending inactivity timer first\n        clearTimeout(inactivityTimer);\n        inactivityTimer = null; // Clear the timer ID\n        // Start the screensaver immediately\n        startScreensaver();\n    });\n    // --- END: Header logo listener ---\n    // --- END: Event List Listeners ---\n    // --- END: Screensaver Listeners ---\n    // --- INITIALIZATION ---\n    async function initializeApp() {\n        try {\n            const response = await fetch('source/members.csv');\n            if (!response.ok) throw new Error('Could not load member list from members.csv.');\n            const csvText = await response.text();\n            MASTER_MEMBER_LIST = parseCSV(csvText);\n            // Now that we have the member list, we can proceed\n            await loadState(MASTER_MEMBER_LIST);\n            // --- ADD THIS LINE ---\n            resetChecklistForNewDay(); // Check if checklist needs reset for the current day\n            // --- END ADD ---\n            state.clubMembers = [\n                ...MASTER_MEMBER_LIST\n            ].sort((a, b)=>a.name.localeCompare(b.name));\n            updateGameModeBasedOnPlayerCount();\n            autoAssignCourtModes();\n            render();\n            // Real-time sync setup\n            API.onStateUpdate((updatedState)=>{\n                console.log(\"\\uD83D\\uDD04 Real-time update received!\");\n                // IGNORE updates if we're making a local change\n                if (localChangeInProgress) {\n                    console.log(\"\\u23F8\\uFE0F Ignoring update - local change in progress\");\n                    return;\n                }\n                // Set flag to prevent saveState during this update\n                state._isReceivingUpdate = true;\n                const localUIState = {\n                    mobileControls: state.mobileControls,\n                    notificationControls: state.notificationControls,\n                    uiSettings: state.uiSettings\n                };\n                state = {\n                    ...state,\n                    ...updatedState\n                };\n                state.mobileControls = localUIState.mobileControls;\n                state.notificationControls = localUIState.notificationControls;\n                state.uiSettings = localUIState.uiSettings;\n                state._isReceivingUpdate = true; // Restore flag after merge\n                const checkedInNames = new Set();\n                if (Array.isArray(state.availablePlayers)) state.availablePlayers.forEach((p)=>checkedInNames.add(p.name));\n                state.courts.forEach((court)=>{\n                    if (Array.isArray(court.players)) court.players.forEach((p)=>checkedInNames.add(p.name));\n                });\n                state.clubMembers = MASTER_MEMBER_LIST.filter((p)=>!checkedInNames.has(p.name));\n                state.clubMembers.sort((a, b)=>a.name.localeCompare(b.name));\n                render();\n                // Clear flag after render completes\n                setTimeout(()=>{\n                    state._isReceivingUpdate = false;\n                }, 100);\n                console.log(\"\\u2705 UI updated\");\n            });\n            resetInactivityTimer(); // Start the inactivity timer when the app loads\n            // CRITICAL FIX: Ensure animations are restored on page load if a selection is active.\n            setTimeout(ensureCourtSelectionAnimation, 50);\n            updateNotificationIcons();\n            applyFontSize();\n            applyDisplaySize();\n            fetchWeather();\n            updateLightIcon();\n            if (!state.pongAnimationOffset) state.pongAnimationOffset = Date.now();\n            // START 1-second timers for display updates\n            setInterval(()=>{\n                updateTimers();\n            }, 1000);\n            // Start repeating check for alert condition\n            const LOGIC_CHECK_INTERVAL_MS = 10000;\n            checkAndPlayAlert(false);\n            setInterval(checkAndPlayAlert, LOGIC_CHECK_INTERVAL_MS);\n            // NEW: Interval timer for the \"On a Roll\" text fader\n            if (!window.statusFaderInterval) window.statusFaderInterval = setInterval(()=>{\n                const faders = document.querySelectorAll('.player-status-fader');\n                faders.forEach((fader)=>{\n                    const statusTexts = Array.from(fader.querySelectorAll('.status-text'));\n                    const currentlyVisibleIndex = statusTexts.findIndex((el)=>el.classList.contains('is-visible'));\n                    if (currentlyVisibleIndex !== -1) {\n                        // Hide the current text\n                        statusTexts[currentlyVisibleIndex].classList.remove('is-visible');\n                        // Calculate the index of the next text to show\n                        const nextIndex = (currentlyVisibleIndex + 1) % statusTexts.length;\n                        // Show the next text\n                        statusTexts[nextIndex].classList.add('is-visible');\n                    }\n                });\n            }, 3000); // Fades every 3 seconds\n            let wasMobile = window.innerWidth <= 900; // Initial check\n            window.addEventListener('resize', ()=>{\n                const isMobile = window.innerWidth <= 900;\n                // Reload only if the state changes (crossed the 900px boundary)\n                if (isMobile !== wasMobile) location.reload();\n                // Update the state for the next resize event\n                wasMobile = isMobile;\n            });\n            // Start Custom Announcement Features\n            setupLongPressPaste();\n            startHeaderTextAnimation();\n            startCustomTtsScheduler();\n            saveChecklistHistory(); // Attempt save on load\n        } catch (error) {\n            console.error('Failed to initialize application:', error);\n            alert('Error: Could not load master member list. Please ensure \"public/source/members.csv\" exists and is formatted correctly. The application cannot start.');\n        }\n    }\n    initializeApp();\n    function populateReturningGuestModal() {\n        const returningGuestList = document.getElementById('returning-guest-list');\n        returningGuestList.innerHTML = \"\";\n        // --- THIS IS THE NEW LOGIC (Mirrors the fix in the other function) ---\n        const checkedInPlayerNames = new Set([\n            ...state.availablePlayers.map((p)=>p.name),\n            ...state.courts.flatMap((c)=>c.players).map((p)=>p.name)\n        ]);\n        const availableGuests = state.guestHistory.filter((g)=>!checkedInPlayerNames.has(g.name));\n        // --- END OF NEW LOGIC ---\n        if (availableGuests.length === 0) {\n            const li = document.createElement(\"li\");\n            li.textContent = \"All previous guests are checked in or there is no guest history.\";\n            li.style.justifyContent = \"center\";\n            returningGuestList.appendChild(li);\n        } else {\n            availableGuests.sort((a, b)=>a.name.localeCompare(b.name));\n            availableGuests.forEach((guest)=>{\n                const li = document.createElement(\"li\");\n                const visits = guest.daysVisited || 1;\n                const plural = visits === 1 ? '' : 's';\n                li.innerHTML = `\n                    <div style=\"display: flex; flex-direction: column; flex-grow: 1;\">\n                        <span>${guest.name}</span>\n                        <span style=\"font-size: 0.8em; color: #6c757d;\">${visits} visit${plural}</span>\n                    </div>\n                    <span style=\"margin-right: 1rem; color: #6c757d;\">${guest.gender}</span>\n                    <span class=\"action-icon add\" data-player=\"${guest.name}\">+</span>\n                `;\n                li.dataset.playerName = guest.name;\n                returningGuestList.appendChild(li);\n            });\n        }\n        setupListWithIndex(availableGuests, returningGuestList, document.getElementById('returning-guest-abc-index'));\n    }\n    function handleReturningGuestCheckIn(playerName) {\n        const guestData = state.guestHistory.find((g)=>g.name === playerName);\n        if (!guestData) return;\n        const returningGuestModal = document.getElementById('returning-guest-modal');\n        const context = returningGuestModal.dataset.context;\n        const today = new Date().toISOString().split('T')[0];\n        // Only increment daysVisited if it's their first check-in/sale of the day\n        if (guestData.lastCheckIn !== today) {\n            guestData.daysVisited = (guestData.daysVisited || 0) + 1;\n            guestData.lastCheckIn = today;\n        }\n        if (context === 'purchaser') {\n            delete returningGuestModal.dataset.context;\n            confirmPurchaser(playerName, 'returning_guest');\n            return;\n        }\n        const playerObject = {\n            ...guestData,\n            isPaused: false\n        };\n        state.availablePlayers.push(playerObject);\n        returningGuestModal.classList.add('hidden');\n        // FIXED: Re-open the check-in modal after adding the returning guest\n        populateCheckInModal(); // Refresh the check-in list\n        checkInModal.classList.remove('hidden'); // Re-open check-in modal\n        updateGameModeBasedOnPlayerCount();\n        autoAssignCourtModes();\n        render();\n        saveState();\n        checkAndPlayAlert(false);\n    }\n    // BIND ALL INITIAL DOM LISTENERS\n    // Undo History Listeners\n    document.getElementById('undo-history-btn')?.addEventListener('click', showUndoHistoryModal);\n    document.getElementById('undo-history-close-btn').addEventListener('click', ()=>{\n        document.getElementById('undo-history-modal').classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    // Mobile Menu Bar Event Listeners\n    if (document.getElementById('mobile-menu-bar')) {\n        document.getElementById('mobile-junior-club-btn').addEventListener('click', ()=>{\n            checkInModal.classList.add('hidden');\n            checkOutModal.classList.add('hidden');\n            showJuniorClubModal();\n        });\n        document.getElementById('mobile-history-btn').addEventListener('click', ()=>{\n            state.historyViewMode = 'games';\n            renderHistory();\n            historyPage.classList.remove(\"hidden\");\n        });\n        document.getElementById('mobile-notify-btn').addEventListener('click', handleNotifyNow);\n        document.getElementById('mobile-settings-btn').addEventListener('click', handleAdminLogin);\n    }\n    // --- LISTENERS FOR PULL DOWN HEADER ---\n    // Attach event listeners\n    window.addEventListener('scroll', handleScroll, {\n        passive: true\n    });\n    document.addEventListener('touchstart', handleTouchStart, {\n        passive: true\n    });\n    document.addEventListener('touchmove', handleTouchMove, {\n        passive: true\n    });\n    document.addEventListener('touchend', handleTouchEnd, {\n        passive: true\n    });\n    document.addEventListener('mousedown', handleMouseDown);\n    document.addEventListener('mousemove', handleMouseMove);\n    document.addEventListener('mouseup', handleMouseUp);\n    // Start the auto-hide timer on page load\n    startHeaderHideTimer();\n    updateOverlaySpacers();\n    window.addEventListener('resize', setPlayerListHeight);\n    modeDoublesBtn.addEventListener(\"click\", ()=>handleModeChange(\"doubles\"));\n    modeSinglesBtn.addEventListener(\"click\", ()=>handleModeChange(\"singles\"));\n    availablePlayersList.addEventListener(\"click\", handlePlayerClick);\n    courtGrid.addEventListener(\"click\", handleCourtGridClick);\n    modalConfirmBtn.addEventListener(\"click\", handleModalConfirm);\n    modalCancelBtn.addEventListener(\"click\", ()=>{\n        const openedFrom = chooseTeamsModal.dataset.openedFrom;\n        const courtId1 = chooseTeamsModal.dataset.courtId;\n        chooseTeamsModal.classList.add(\"hidden\");\n        delete chooseTeamsModal.dataset.openedFrom; // Clean up context\n        if (openedFrom === 'endgame' && courtId1) {\n            // If cancelling from the end game flow, restore the end game button animation\n            const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId1}\"]`);\n            const button = courtCardEl ? courtCardEl.querySelector('.end-game-ball') : null;\n            if (button) {\n                // Reset the button's state and re-apply the appear animation\n                button.classList.remove('hide-anim', 'animate-in');\n                setTimeout(()=>{\n                    button.classList.add('animate-in');\n                }, 50);\n            }\n        }\n    });\n    modalPlayerList.addEventListener(\"click\", handleModalPlayerClick);\n    historyBtn.addEventListener(\"click\", ()=>{\n        state.historyViewMode = 'games'; // Always start on the game history view\n        renderHistory();\n        historyPage.classList.remove(\"hidden\");\n    });\n    historyCloseBtn.addEventListener(\"click\", ()=>{\n        historyPage.classList.add(\"hidden\");\n    });\n    historyToggleViewBtn.addEventListener(\"click\", ()=>{\n        // RESET filters and comparison state before switching views\n        resetComparisonState();\n        resetStatsFilters();\n        if (state.historyViewMode === 'stats') state.historyViewMode = \"games\";\n        else state.historyViewMode = \"stats\";\n        renderHistory();\n        saveState();\n    });\n    document.getElementById('history-toggle-teams-btn').addEventListener('click', ()=>{\n        // RESET filters and comparison state before switching views\n        resetComparisonState();\n        resetStatsFilters();\n        if (state.historyViewMode === 'teams') state.historyViewMode = 'games';\n        else state.historyViewMode = 'teams';\n        renderHistory();\n        saveState();\n    });\n    checkInBtn.addEventListener(\"click\", ()=>{\n        populateCheckInModal(), checkInModal.classList.remove(\"hidden\");\n    });\n    checkInCancelBtn.addEventListener(\"click\", ()=>{\n        checkInModal.classList.add(\"hidden\");\n        // --- NEW: Reset z-index and context on close ---\n        checkInModal.style.zIndex = ''; // Reset to default CSS value\n        delete checkInModal.dataset.screensaverEventId;\n    // --- END NEW ---\n    });\n    // --- NEW: Event Create/Edit Modal Listeners ---\n    document.getElementById('cancel-event-edit-btn')?.addEventListener('click', ()=>{\n        document.getElementById('event-create-edit-modal')?.classList.add('hidden');\n        showEventListModal(); // Go back to the event list\n    });\n    // --- THIS LINE ---\n    document.getElementById('save-event-btn')?.addEventListener('click', saveEvent);\n    // --- END THIS LINE ---\n    // Wire up text inputs to alpha keypad\n    wireGlobalKeypadToInput(document.getElementById('event-heading'));\n    wireGlobalKeypadToInput(document.getElementById('event-body1'));\n    wireGlobalKeypadToInput(document.getElementById('event-body2'));\n    // --- NEW: Wire Body Text inputs to the Global Keyboard ---\n    // Note: We create a custom listener instead of using wireAlphaKeypadToInput\n    document.getElementById('event-body1')?.addEventListener('click', (e)=>showGlobalKeyboard(e.target));\n    document.getElementById('event-body2')?.addEventListener('click', (e)=>showGlobalKeyboard(e.target));\n    // --- NEW: Wire phone, email, website fields to Global Keyboard ---\n    document.getElementById('event-phone')?.addEventListener('click', function() {\n        showGlobalKeyboard(this, 'NumberPad');\n    });\n    document.getElementById('event-email')?.addEventListener('click', function() {\n        showGlobalKeyboard(this, 'LetterPad');\n    });\n    document.getElementById('event-website')?.addEventListener('click', function() {\n        showGlobalKeyboard(this, 'LetterPad');\n    });\n    // --- END NEW ---\n    // Listeners for sliders to update display\n    document.getElementById('event-cost-adult')?.addEventListener('input', ()=>updateSliderDisplay('event-cost-adult'));\n    document.getElementById('event-cost-child')?.addEventListener('input', ()=>updateSliderDisplay('event-cost-child'));\n    document.getElementById('event-participation-discount')?.addEventListener('input', ()=>updateSliderDisplay('event-participation-discount'));\n    // Delegate clicks for removing interested players\n    document.getElementById('interested-players-list')?.addEventListener('click', (e)=>{\n        const removeButton = e.target.closest('.action-icon.remove');\n        const playerName = removeButton?.dataset.playerName;\n        const modal = document.getElementById('event-create-edit-modal');\n        const eventId = modal?.dataset.editingEventId;\n        if (playerName && eventId) removeInterestedPlayer(playerName, eventId);\n    });\n    // --- END: Event Create/Edit Listeners ---\n    document.getElementById('end-game-skip-btn').addEventListener('click', handleSkipButtonClick);\n    document.getElementById('reset-app-btn').addEventListener('click', handleResetAppClick);\n    // --- REVISED GLOBAL CLICK LISTENER FOR ALL CARD TOGGLES ---\n    document.addEventListener('click', (e)=>{\n        const toggleButton = e.target.closest('.summary-toggle-btn');\n        if (!toggleButton) return;\n        const cardType = toggleButton.dataset.cardType;\n        const courtId1 = toggleButton.dataset.courtId;\n        let stateChanged = false;\n        // Find the parent card element\n        const cardElement = toggleButton.closest('.court-card, .summary-card, #availablePlayersSection');\n        if (!cardElement) return;\n        // Find the icon to toggle\n        const icon = toggleButton.querySelector('i');\n        // Toggle the visual state directly in the DOM\n        cardElement.classList.toggle('is-collapsed');\n        if (icon) {\n            icon.classList.toggle('mdi-chevron-up');\n            icon.classList.toggle('mdi-chevron-down');\n        }\n        // Update the application's internal state so it's remembered\n        if (cardType === 'summary') {\n            state.mobileControls.isSummaryExpanded = !state.mobileControls.isSummaryExpanded;\n            stateChanged = true;\n        } else if (cardType === 'players') {\n            state.mobileControls.isPlayersExpanded = !state.mobileControls.isPlayersExpanded;\n            stateChanged = true;\n        } else if (cardType === 'court' && courtId1) {\n            const court = state.courts.find((c)=>c.id === courtId1);\n            if (court) {\n                court.isCollapsed = !court.isCollapsed;\n                stateChanged = true;\n            }\n        }\n        // Save the new state, but DO NOT call render()\n        if (stateChanged) saveState();\n    });\n    // --- JUNIOR CLUB LISTENERS (Re-added to DOMContentLoaded) ---\n    juniorClubBtn.addEventListener('click', ()=>{\n        checkInModal.classList.add('hidden');\n        checkOutModal.classList.add('hidden');\n        showJuniorClubModal(); // Calls the new wrapper function\n    });\n    juniorClubCloseBtn.addEventListener('click', ()=>{\n        // Aggressively clear the sub-modal state before closing the main modal\n        childrenContainer.innerHTML = '';\n        parentNameInput.value = '';\n        parentSurnameInput.value = '';\n        parentPhoneInput.value = '';\n        document.getElementById('parent-collapsed-display').innerHTML = '';\n        // Reset flow state before closing\n        state.juniorClub.registrationFlow = {\n            parentCollapsed: false,\n            childrenExpanded: false\n        };\n        juniorClubModal.classList.add('hidden');\n    });\n    // New Parent Registration Flow (Corrected Cancel Listener)\n    newParentBtn.addEventListener('click', ()=>{\n        // showNewParentModal is called here, which handles all clearing and initial setup\n        showNewParentModal();\n    });\n    newParentCancelBtn.addEventListener('click', ()=>{\n        // --- CANCEL ACTION: Aggressively clear all fields and state ---\n        childrenContainer.innerHTML = '';\n        parentNameInput.value = '';\n        parentSurnameInput.value = '';\n        parentPhoneInput.value = '';\n        document.getElementById('parent-collapsed-display').innerHTML = '';\n        // Reset flow state before closing\n        state.juniorClub.registrationFlow = {\n            parentCollapsed: false,\n            childrenExpanded: false\n        };\n        newParentModal.classList.add('hidden');\n        juniorClubModal.classList.remove('hidden'); // Return to main junior club list\n    });\n    newParentConfirmBtn.addEventListener('click', registerNewParent);\n    rosterDetailCloseBtn.addEventListener('click', ()=>{\n        rosterDetailModal.classList.add('hidden');\n        juniorClubRosterModal.classList.remove('hidden'); // Return to the roster list\n    });\n    // --- NEW LISTENER: Click delegation for Roster Items ---\n    juniorClubRosterList.addEventListener('click', (e)=>{\n        const itemEl = e.target.closest('.roster-item');\n        const sortBtn = e.target.closest('.roster-sort-btn');\n        // Ignore clicks on the sort buttons\n        if (sortBtn) return;\n        if (!itemEl) return;\n        const index = parseInt(itemEl.dataset.rosterIndex, 10);\n        const rosterData = juniorClubRosterList.rosterData; // Retrieve stored data\n        if (rosterData && rosterData[index]) showRosterDetailModal(rosterData[index]);\n    });\n    // NEW LISTENER: Filter toggle\n    if (juniorClubNameFilterGroup) juniorClubNameFilterGroup.addEventListener('change', handleJuniorClubNameFilterChange);\n    // Child Fields\n    addChildBtn.addEventListener('click', addChild);\n    newParentModal.addEventListener('click', (e)=>{\n        if (e.target.closest('[data-action=\"match-surname\"]')) handleMatchSurname(e);\n        else if (e.target.closest('[data-action=\"remove-child\"]')) removeChild(e);\n    });\n    juniorClubModal.addEventListener('click', (e)=>{\n        // 1. Handle Header Icon Clicks (Roster and History)\n        if (e.target.closest('#junior-club-roster-btn')) {\n            showJuniorClubRosterModal();\n            return;\n        }\n        if (e.target.closest('#junior-club-history-btn')) {\n            showJuniorClubStatsModal();\n            return;\n        }\n        // 2. Handle List Item Clicks (Check-In/Edit)\n        const checkInTarget = e.target.closest('.action-icon.add');\n        const editTarget = e.target.closest('.action-icon.edit');\n        const listItem = e.target.closest('#junior-club-list li');\n        if (!listItem) return;\n        // --- Logic for the 'Add' (+) button (Check In) ---\n        if (checkInTarget) {\n            const parentId = checkInTarget.dataset.parentId;\n            const parent = state.juniorClub.parents.find((p)=>p.id === parentId);\n            // Proceed only if the parent is found and the button is not disabled\n            if (parent && checkInTarget.style.opacity !== '0.5') {\n                const displayMode = state.juniorClub.checkInFilter.displayMode;\n                // If in 'Child Name' view, check in the specific child directly (This part was already working)\n                if (displayMode === 'child') {\n                    const childFullName = listItem.querySelector('span:first-child span:first-child').textContent.trim();\n                    const attendingChildren = parent.registeredChildren.filter((child)=>`${child.name} ${child.surname}`.trim() === childFullName).map((child)=>({\n                            name: `${child.name} ${child.surname}`.trim(),\n                            gender: child.gender,\n                            guest: true,\n                            isJunior: true,\n                            parentName: parent.name + ' ' + parent.surname\n                        }));\n                    if (attendingChildren.length > 0) {\n                        const newChildren = attendingChildren;\n                        state.juniorClub.activeChildren.push(...newChildren);\n                        const newHistoryEntry = {\n                            id: Date.now(),\n                            parentId: parent.id,\n                            parentName: `${parent.name} ${parent.surname}`,\n                            childNames: newChildren.map((c)=>c.name),\n                            date: new Date().toISOString().split('T')[0],\n                            isPaid: false\n                        };\n                        state.juniorClub.history.push(newHistoryEntry);\n                        // playCustomTTS(`${newChildren.length} child checked in for ${parent.name}.`);\n                        saveState();\n                        renderJuniorClubCheckInList(); // Refresh the list\n                        return;\n                    }\n                }\n                // --- THIS IS THE MISSING LOGIC FOR THE PLUS ICON IN PARENT VIEW ---\n                // If in 'Parent Name' view, show the child selection modal\n                showChildSelectionModal(parent);\n            }\n        } else if (editTarget) {\n            const parentId = editTarget.dataset.parentId;\n            const parentToEdit = state.juniorClub.parents.find((p)=>p.id === parentId);\n            if (parentToEdit) // This now correctly calls the function to open the edit modal\n            showEditParentModal(parentToEdit);\n        }\n    });\n    // Child Selection Modal\n    childSelectionBackBtn.addEventListener('click', ()=>{\n        childSelectionModal.classList.add('hidden');\n        juniorClubModal.classList.remove('hidden');\n    });\n    childSelectionConfirmBtn.addEventListener('click', handleChildSelectionConfirm);\n    // Child Fields\n    addChildBtn.addEventListener('click', addChild);\n    newParentModal.addEventListener('click', (e)=>{\n        if (e.target.closest('[data-action=\"match-surname\"]')) handleMatchSurname(e);\n        else if (e.target.closest('[data-action=\"remove-child\"]')) removeChild(e);\n    });\n    juniorClubModal.addEventListener('click', (e)=>{\n        // 1. Handle Header Icon Clicks (Roster and History)\n        if (e.target.closest('#junior-club-roster-btn')) {\n            showJuniorClubRosterModal();\n            return;\n        }\n        if (e.target.closest('#junior-club-history-btn')) {\n            showJuniorClubStatsModal();\n            return;\n        }\n        // 2. Handle List Item Clicks (Check-In/Edit)\n        const checkInTarget = e.target.closest('.action-icon.add');\n        const editTarget = e.target.closest('.action-icon.edit');\n        const listItem = e.target.closest('#junior-club-list li');\n        if (!listItem) return;\n        // --- Logic for the 'Add' (+) button (Check In) ---\n        if (checkInTarget) {\n            const parentId = checkInTarget.dataset.parentId;\n            const parent = state.juniorClub.parents.find((p)=>p.id === parentId);\n            // Proceed only if the parent is found and the button is not disabled\n            if (parent && checkInTarget.style.opacity !== '0.5') {\n                const displayMode = state.juniorClub.checkInFilter.displayMode;\n                // If in 'Child Name' view, check in the specific child directly (This part was already working)\n                if (displayMode === 'child') {\n                    const childFullName = listItem.querySelector('span:first-child span:first-child').textContent.trim();\n                    const attendingChildren = parent.registeredChildren.filter((child)=>`${child.name} ${child.surname}`.trim() === childFullName).map((child)=>({\n                            name: `${child.name} ${child.surname}`.trim(),\n                            gender: child.gender,\n                            guest: true,\n                            isJunior: true,\n                            parentName: parent.name + ' ' + parent.surname\n                        }));\n                    if (attendingChildren.length > 0) {\n                        const newChildren = attendingChildren;\n                        state.juniorClub.activeChildren.push(...newChildren);\n                        const newHistoryEntry = {\n                            id: Date.now(),\n                            parentId: parent.id,\n                            parentName: `${parent.name} ${parent.surname}`,\n                            childNames: newChildren.map((c)=>c.name),\n                            date: new Date().toISOString().split('T')[0],\n                            isPaid: false\n                        };\n                        state.juniorClub.history.push(newHistoryEntry);\n                        playCustomTTS(`${newChildren.length} child checked in for ${parent.name}.`);\n                        saveState();\n                        renderJuniorClubCheckInList(); // Refresh the list\n                        return;\n                    }\n                }\n                // --- THIS IS THE MISSING LOGIC FOR THE PLUS ICON IN PARENT VIEW ---\n                // If in 'Parent Name' view, show the child selection modal\n                showChildSelectionModal(parent);\n            }\n        } else if (editTarget) {\n            const parentId = editTarget.dataset.parentId;\n            const parentToEdit = state.juniorClub.parents.find((p)=>p.id === parentId);\n            if (parentToEdit) // This now correctly calls the function to open the edit modal\n            showEditParentModal(parentToEdit);\n        }\n    });\n    // Child Selection Modal\n    childSelectionBackBtn.addEventListener('click', ()=>{\n        childSelectionModal.classList.add('hidden');\n        juniorClubModal.classList.remove('hidden');\n    });\n    childSelectionConfirmBtn.addEventListener('click', handleChildSelectionConfirm);\n    // Child Selection validation (updates button text/state)\n    attendingChildrenList.addEventListener('change', ()=>{\n        const checkedCount = attendingChildrenList.querySelectorAll('input[name=\"attendingChild\"]:checked').length;\n        const isReady = checkedCount > 0;\n        childSelectionConfirmBtn.disabled = !isReady;\n        // --- START OF CHANGE ---\n        const childString = checkedCount === 1 ? 'child' : 'children';\n        childSelectionConfirmBtn.textContent = `Check In (${checkedCount} ${childString})`;\n        // --- END OF CHANGE ---\n        childSelectionConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n        childSelectionConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\n    });\n    // Event Listeners to insert at line 2011\n    // Junior Club History/Stats Listeners\n    // Event Listeners to insert at line 2011\n    // Junior Club History/Stats Listeners\n    juniorClubHistoryBtn.addEventListener('click', showJuniorClubStatsModal);\n    juniorClubStatsBackBtn.addEventListener('click', ()=>{\n        juniorClubStatsModal.classList.add('hidden');\n        showJuniorClubModal(); // <-- MODIFIED: Ensure list is re-rendered on return\n    });\n    juniorClubHistoryList.addEventListener('click', handleJuniorClubHistoryClick);\n    // NOTE: document.getElementById('payment-filter-group').addEventListener('change', handlePaymentFilterChange); is now handled inside renderJuniorClubHistory\n    juniorClubStatsDetailsBtn.addEventListener('click', showJuniorClubDetailModal);\n    // Junior Club Detail Modal Listeners\n    detailCloseBtn.addEventListener('click', ()=>{\n        juniorClubDetailModal.classList.add('hidden');\n        showJuniorClubStatsModal(); // <-- MODIFIED: Ensure history is re-rendered on return\n    });\n    detailTogglePaidBtn.addEventListener('click', handleDetailTogglePaid);\n    cooldownCloseBtn.addEventListener('click', ()=>{\n        if (cooldownTimerInterval) clearInterval(cooldownTimerInterval);\n        cooldownModal.classList.add('hidden');\n    });\n    // ADDED WINDOW RESIZE LISTENER FOR AUTOMATIC EXPANSION\n    window.addEventListener('resize', resetCollapseOnResize);\n    // UPDATED: Bypasses the confirmation modal for a direct check-in flow\n    checkInList.addEventListener(\"click\", (e)=>{\n        if (e.target.classList.contains(\"add\")) {\n            const playerName = e.target.dataset.player;\n            // --- NEW CONTEXT CHECK ---\n            const screensaverEventId = checkInModal.dataset.screensaverEventId;\n            if (screensaverEventId) // If opened from screensaver, add to interest list instead of checking in\n            addInterestedPlayer(playerName, screensaverEventId);\n            else {\n                // --- Original Check-in Logic ---\n                const playerObject = state.clubMembers.find((p)=>p.name === playerName);\n                if (playerObject) {\n                    leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\n                    leaderboardConfirmModal.classList.remove('hidden');\n                    checkInModal.classList.add('hidden');\n                }\n            // --- End Original Logic ---\n            }\n        // --- END NEW CONTEXT CHECK ---\n        }\n    });\n    checkOutBtn.addEventListener(\"click\", ()=>{\n        populateCheckOutModal(), checkOutModal.classList.remove(\"hidden\");\n    });\n    checkOutCloseBtn.addEventListener(\"click\", ()=>checkOutModal.classList.add(\"hidden\"));\n    // MODIFIED: This now calls the new handleCheckout function\n    checkOutList.addEventListener(\"click\", (e)=>{\n        if (e.target.classList.contains(\"remove\")) {\n            const playerName = e.target.dataset.player;\n            const playerObject = state.availablePlayers.find((p)=>p.name === playerName);\n            if (playerObject) // Instead of showing a modal directly, call the new handler function\n            handleCheckout(playerObject);\n        }\n    });\n    // Listener for the ORIGINAL modal (with stats)\n    document.getElementById('checkout-thanks-confirm-btn').addEventListener('click', ()=>{\n        const modal = document.getElementById('checkout-thanks-modal');\n        executeCheckout(modal.dataset.player);\n    });\n    // NEW: Listener for the NEW modal (no stats)\n    document.getElementById('checkout-thanks-no-stats-confirm-btn').addEventListener('click', ()=>{\n        const modal = document.getElementById('checkout-thanks-no-stats-modal');\n        executeCheckout(modal.dataset.player);\n    });\n    // NEW: Listener for the branded checkout modal confirmation\n    // On the Thank You (with stats) modal, go back to the Check-out list\n    document.getElementById('checkout-thanks-back-btn').addEventListener('click', ()=>{\n        document.getElementById('checkout-thanks-modal').classList.add('hidden');\n        checkOutModal.classList.remove('hidden');\n    });\n    // On the Thank You (no stats) modal, go back to the Check-out list\n    document.getElementById('checkout-thanks-no-stats-back-btn').addEventListener('click', ()=>{\n        document.getElementById('checkout-thanks-no-stats-modal').classList.add('hidden');\n        checkOutModal.classList.remove('hidden');\n    });\n    document.getElementById('checkout-thanks-confirm-btn').addEventListener('click', ()=>{\n        const modal = document.getElementById('checkout-thanks-modal');\n        const playerToCheckOutName = modal.dataset.player;\n        if (playerToCheckOutName) {\n            // --- This is the same core logic from executePlayerCheckOut ---\n            if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerToCheckOutName) resetAlertSchedule();\n            const playerObject = state.availablePlayers.find((p)=>p.name === playerToCheckOutName);\n            if (playerObject) {\n                if (playerObject.isJunior) state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter((child)=>child.name !== playerToCheckOutName);\n                if (!playerObject.guest) {\n                    state.clubMembers.push(playerObject);\n                    state.clubMembers.sort((a, b)=>a.name.localeCompare(b.name));\n                }\n            }\n            state.availablePlayers = state.availablePlayers.filter((p)=>p.name !== playerToCheckOutName);\n            // Hide the thanks modal\n            modal.classList.add(\"hidden\");\n            // Repopulate and show the original checkout modal again\n            populateCheckOutModal();\n            checkOutModal.classList.remove(\"hidden\");\n            // Update the main state\n            updateGameModeBasedOnPlayerCount();\n            autoAssignCourtModes();\n            render();\n            saveState();\n        }\n    });\n    // REPLACE this event listener\n    endGameCancelBtn.addEventListener(\"click\", ()=>{\n        const courtId1 = endGameModal.dataset.courtId;\n        const editGameId = endGameModal.dataset.editGameId;\n        if (editGameId) {\n            // If we were editing, close the end game modal and re-open the history page\n            delete endGameModal.dataset.editGameId;\n            endGameModal.classList.add(\"hidden\");\n            historyPage.classList.remove(\"hidden\"); // <-- THIS IS THE FIX\n            return;\n        }\n        if (courtId1) {\n            const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId1}\"]`);\n            const button = courtCardEl ? courtCardEl.querySelector('.end-game-ball') : null;\n            if (button) {\n                button.classList.remove('hide-anim', 'animate-in');\n                setTimeout(()=>{\n                    button.classList.add('animate-in');\n                }, 50);\n            }\n        }\n        endGameModal.classList.add(\"hidden\");\n    });\n    endGameConfirmBtn.addEventListener(\"click\", confirmEndGame);\n    // MODIFIED: No button now handles closing and restoring the correct modal\n    modalBtnNo.addEventListener(\"click\", ()=>{\n        const mode = cancelConfirmModal.dataset.mode;\n        cancelConfirmModal.classList.add(\"hidden\");\n        // Logic to return to the correct modal after cancellation\n        if (mode === \"checkInPlayer\") checkInModal.classList.remove(\"hidden\");\n        else if (mode === \"checkOutPlayer\") checkOutModal.classList.remove(\"hidden\");\n        else if (mode === \"addBallStock\" || mode === \"returnBallStock\" || mode === \"signOutBalls\") ballManagementModal.classList.remove(\"hidden\");\n        else if (mode === \"removeSingleChild\") newParentModal.classList.remove(\"hidden\"); // This correctly returns to the registration form.\n        // --- END OF FIX ---\n        resetConfirmModal();\n    });\n    // MODIFIED: Yes button now handles check-in/out and the force announcement\n    // MODIFIED: Yes button now handles check-in/out and the force announcement\n    modalBtnYesConfirm.addEventListener(\"click\", ()=>{\n        const mode = cancelConfirmModal.dataset.mode;\n        if (mode === \"removeSingleChild\") executeRemoveSingleChild();\n        else if (mode === \"confirmEditGame\") {\n            const gameId = cancelConfirmModal.dataset.gameId;\n            cancelConfirmModal.classList.add(\"hidden\");\n            resetConfirmModal();\n            handleEndGame(null, gameId);\n        } else if (mode === \"checkOutPlayer\") executePlayerCheckOut();\n        else if (mode === \"checkInPlayer\") executePlayerCheckIn();\n        else if (mode === \"cancelGame\") executeGameCancellation();\n        else if (mode === \"callDuty\") executeCallDuty();\n        else if (mode === \"executeReset\") executeAppReset();\n        else if (mode === \"pauseToggle\") executePauseToggle();\n        else if (mode === \"addBallStock\") executeAddBallStock();\n        else if (mode === \"returnBallStock\") executeReturnBallStock();\n        else if (mode === \"returnUsedBalls\") executeUsedBallReturn();\n        else if (mode === \"signOutBalls\") executeSignOutBalls();\n        else if (mode === \"forceAnnouncement\") {\n            cancelConfirmModal.classList.add(\"hidden\");\n            checkAndPlayAlert(true);\n            resetConfirmModal();\n        } else if (mode === \"forceAnnouncementNotEnoughPlayers\") {\n            const now = Date.now();\n            const FIVE_MINUTES_MS = 300000;\n            if (state.notificationControls.isMinimized) {\n                alertScheduleTime = 0;\n                alertState = 'initial_check';\n            } else {\n                alertScheduleTime = now + FIVE_MINUTES_MS;\n                alertState = '5_min_repeat';\n            }\n            const availablePlayerCount = state.availablePlayers.length;\n            const playerNames = state.availablePlayers.map((p)=>p.name).join(' and ');\n            const playersNeeded = 4 - availablePlayerCount;\n            const pluralS = playersNeeded > 1 ? 's' : '';\n            let message = `Attention ${playerNames}, we are waiting for ${playersNeeded} more player${pluralS} before we can start a match.`;\n            if (availablePlayerCount >= 2) message += \" or start a singles game in the meantime.\";\n            playAlertSound(message);\n            cancelConfirmModal.classList.add(\"hidden\");\n            resetConfirmModal();\n        }\n    });\n    // Undo Toast Listeners\n    document.getElementById('undo-toast-dismiss').addEventListener('click', hideUndoToast);\n    document.getElementById('undo-toast-btn').addEventListener('click', ()=>{\n        if (state.undoHistory.currentToast && state.undoHistory.currentToast.undoAction) {\n            state.undoHistory.currentToast.undoAction();\n            hideUndoToast();\n        }\n    });\n    // Add generic listeners that trigger validation whenever an input's value changes.\n    const scoreInputs = [\n        winningScoreInput,\n        losingScoreInput,\n        winnerTiebreakInput,\n        loserTiebreakInput\n    ];\n    scoreInputs.forEach((input)=>{\n        input.addEventListener(\"input\", ()=>{\n            checkAndShowTieBreak();\n            validateEndGameForm();\n        });\n    });\n    // Wire up the keypad for the tie-break inputs, which have no special max value rules.\n    // The main score inputs are now wired up dynamically inside handleEndGame().\n    wireScoreInputToKeypad(winnerTiebreakInput);\n    wireScoreInputToKeypad(loserTiebreakInput);\n    // REPLACE this event listener\n    courtModeKeypadButtons.forEach((button)=>{\n        button.addEventListener('click', (e)=>{\n            const key = e.target.dataset.key;\n            let displayValue = courtModeKeypadDisplay.dataset.hiddenValue || '';\n            if (e.target.id === 'court-mode-keypad-confirm-btn') {\n                if (e.target.disabled) return;\n                checkCourtModePasscode();\n                return;\n            }\n            if (key === 'backspace') displayValue = displayValue.slice(0, -1);\n            else if (key === 'clear') displayValue = '';\n            else if (/[0-9]/.test(key)) {\n                if (displayValue.length >= 6) return; // Max length for PIN\n                displayValue += key;\n            }\n            courtModeKeypadDisplay.dataset.hiddenValue = displayValue;\n            courtModeKeypadDisplay.textContent = '*'.repeat(displayValue.length);\n            // --- THIS IS THE FIX ---\n            // The button is only enabled when exactly 6 digits are entered.\n            const isReady = displayValue.length === 6;\n            courtModeKeypadConfirmBtn.disabled = !isReady;\n        // --- END OF FIX ---\n        });\n    });\n    courtModeKeypadCancelBtn.addEventListener('click', hideCourtModeKeypad);\n    keypadButtons.forEach((button)=>{\n        button.addEventListener('click', handleKeypadClick);\n    });\n    keypadCancelBtn.addEventListener('click', ()=>{\n        // Check if we're canceling from undo mode\n        if (keypadConfig.mode === 'undo') {\n            hideKeypad();\n            delete customKeypadModal.dataset.undoActionIndex;\n            delete customKeypadModal.dataset.undoActionDescription;\n            // Return to undo history modal\n            document.getElementById('undo-history-modal').classList.remove('hidden');\n        } else hideKeypad();\n    });\n    document.getElementById('add-new-player-btn').addEventListener(\"click\", ()=>{\n        checkInModal.classList.add('hidden');\n        guestNameModal.classList.remove('hidden');\n        guestNameInput.value = '';\n        guestSurnameInput.value = '';\n        document.querySelector('input[name=\"guest-gender\"][value=\"M\"]').checked = true;\n        validateGuestForm();\n    });\n    document.getElementById('returning-guest-btn').addEventListener(\"click\", ()=>{\n        checkInModal.classList.add('hidden');\n        populateReturningGuestModal();\n        document.getElementById('returning-guest-modal').classList.remove('hidden');\n    });\n    document.getElementById('returning-guest-cancel-btn').addEventListener(\"click\", ()=>{\n        document.getElementById('returning-guest-modal').classList.add('hidden');\n        checkInModal.classList.remove('hidden');\n    });\n    document.getElementById('returning-guest-list').addEventListener(\"click\", (e)=>{\n        if (e.target.classList.contains(\"add\")) {\n            const playerName = e.target.dataset.player;\n            handleReturningGuestCheckIn(playerName);\n        }\n    });\n    guestCancelBtn.addEventListener(\"click\", ()=>{\n        const context = guestNameModal.dataset.context; // Get context\n        guestNameModal.classList.add('hidden');\n        delete guestNameModal.dataset.context; // Clear context after use\n        // --- NEW CONDITIONAL LOGIC ---\n        if (context === 'manual-entry') manualEntryModal.classList.remove('hidden'); // Return to manual entry\n        else checkInModal.classList.remove('hidden'); // Default return to check-in\n        // --- END NEW LOGIC ---\n        // Also ensure the member radio button is re-enabled on cancel\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\n        if (memberRadio) memberRadio.disabled = false;\n        resetGuestForm(); // Reset form fields\n    });\n    guestConfirmBtn.addEventListener(\"click\", handleGuestCheckIn);\n    guestGenderRadios.forEach((radio)=>radio.addEventListener('change', validateGuestForm));\n    const wireNameInputToKeypad = (input)=>{\n        input.readOnly = true;\n        input.addEventListener('click', (e)=>{\n            showAlphaKeypad(e.target);\n        });\n    };\n    wireNameInputToKeypad(guestNameInput);\n    wireNameInputToKeypad(guestSurnameInput);\n    adminCloseBtn.addEventListener('click', ()=>{\n        adminSettingsModal.classList.add('hidden');\n        if (adminSessionActive) {\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\n            adminSessionTimer = setTimeout(()=>{\n                adminSessionActive = false;\n                adminSessionTimer = null;\n                state.courts.forEach((c)=>c.isModeOverlayActive = false);\n                render();\n                playAlertSound(null, null, 'Alert7.mp3');\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\n            }, 60000); // 1 minute\n        }\n    });\n    reorderPlayersBtn.addEventListener('click', showReorderModal);\n    reorderPlayersList.addEventListener('click', handleReorderClick);\n    reorderCancelBtn.addEventListener('click', ()=>{\n        reorderPlayersModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n        tempPlayerOrder = [];\n    });\n    reorderSaveBtn.addEventListener('click', ()=>{\n        state.availablePlayers = tempPlayerOrder;\n        // --- THIS IS THE FIX ---\n        enforceQueueLogic(); // Re-apply all queue rules after the admin reorder\n        if (tempPlayerOrder.sessionLog && Object.keys(tempPlayerOrder.sessionLog).length > 0) {\n            const movedPlayers = Object.fromEntries(Object.entries(tempPlayerOrder.sessionLog).filter(([name, log])=>log.startPosition !== log.currentPosition));\n            if (Object.keys(movedPlayers).length > 0) {\n                const historyEntry = {\n                    id: Date.now(),\n                    adminAction: 'Queue Reorder',\n                    players: movedPlayers,\n                    endTime: Date.now()\n                };\n                state.reorderHistory.push(historyEntry);\n            }\n        }\n        // --- ANNOUNCEMENT: Admin action confirmation ---\n        playAlertSound(\"Players have been re-ordered by the Admin.\", null);\n        // --- END ANNOUNCEMENT ---\n        enforceDutyPosition();\n        reorderPlayersModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n        tempPlayerOrder = [];\n        render();\n        saveState();\n    });\n    viewReorderLogBtn.addEventListener('click', ()=>{\n        renderReorderHistory();\n        adminSettingsModal.classList.add('hidden');\n        reorderLogModal.classList.remove('hidden');\n    });\n    reorderLogBackBtn.addEventListener('click', ()=>{\n        reorderLogModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    // Helper function to call both validation and rendering\n    function validateParentAndRender() {\n        validateNewParentForm(); // First, update the state based on input\n        renderParentForm(); // Then, update the UI based on the new state\n    }\n    // Attach the helper function to the 'input' event for each field\n    if (parentNameInput) {\n        parentNameInput.removeEventListener('input', validateParentAndRender); // Prevent duplicates\n        parentNameInput.addEventListener('input', validateParentAndRender);\n    }\n    if (parentSurnameInput) {\n        parentSurnameInput.removeEventListener('input', validateParentAndRender);\n        parentSurnameInput.addEventListener('input', validateParentAndRender);\n    }\n    if (parentEmailInput) {\n        parentEmailInput.removeEventListener('input', validateParentAndRender);\n        parentEmailInput.addEventListener('input', validateParentAndRender);\n    }\n    if (parentPhoneInput) {\n        parentPhoneInput.removeEventListener('input', validateParentAndRender);\n        parentPhoneInput.addEventListener('input', validateParentAndRender);\n    }\n    // --- ROSTER MODAL LISTENERS (RE-VERIFIED AND ENSURED) ---\n    if (juniorClubRosterBtn) juniorClubRosterBtn.addEventListener('click', showJuniorClubRosterModal);\n    if (rosterCloseBtn) rosterCloseBtn.addEventListener('click', ()=>{\n        juniorClubRosterModal.classList.add('hidden');\n        juniorClubModal.classList.remove('hidden'); // Return to main junior club list\n    });\n    if (rosterTypeFilterGroup) rosterTypeFilterGroup.addEventListener('change', handleRosterTypeFilterChange);\n    // --- WEATHER MODAL LISTENERS ---\n    document.getElementById('weather-display').addEventListener('click', ()=>{\n        if (currentWeatherModal) currentWeatherModal.classList.remove('hidden');\n    });\n    document.getElementById('cw-close-btn').addEventListener('click', ()=>{\n        if (currentWeatherModal) currentWeatherModal.classList.add('hidden');\n    });\n    document.getElementById('cw-more-details-btn').addEventListener('click', ()=>{\n        if (currentWeatherModal) currentWeatherModal.classList.add('hidden');\n        if (detailedWeatherModal) detailedWeatherModal.classList.remove('hidden');\n    });\n    document.getElementById('dw-close-btn').addEventListener('click', ()=>{\n        if (detailedWeatherModal) detailedWeatherModal.classList.add('hidden');\n    });\n    // Event Delegation for the Day/Morning/Afternoon tabs\n    if (detailedWeatherModal) detailedWeatherModal.addEventListener('click', (e)=>{\n        const tab = e.target.closest('.tab');\n        if (tab) {\n            state.detailedWeatherView = tab.dataset.view;\n            renderDetailedWeatherModal();\n        }\n    });\n    // EVENT LISTENER FOR GAME HISTORY\n    historyList.addEventListener('click', (e)=>{\n        // --- ADD THIS BLOCK ---\n        if (e.target.closest('.sort-btn')) return; // Do nothing if a sort button was clicked\n        // --- END BLOCK ---\n        const historyItem = e.target.closest('.history-item');\n        if (!historyItem || !historyItem.dataset.gameId) return;\n        const gameId = historyItem.dataset.gameId;\n        // Show a confirmation modal before starting the edit\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Edit Game Results\";\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to edit the results for this game?\";\n        modalBtnYesConfirm.textContent = \"Yes, Edit\";\n        modalBtnNo.textContent = \"Cancel\";\n        cancelConfirmModal.dataset.mode = \"confirmEditGame\";\n        cancelConfirmModal.dataset.gameId = gameId;\n        cancelConfirmModal.classList.remove(\"hidden\");\n    });\n    // EVENT LISTENERS FOR LEADERBOARD AND DISCLAIMER MODALS\n    // On the Rules/Leaderboard modal, go back to the Check-in list\n    document.getElementById('leaderboard-back-btn').addEventListener('click', ()=>{\n        leaderboardConfirmModal.classList.add('hidden');\n        checkInModal.classList.remove('hidden');\n    });\n    document.getElementById('leaderboard-btn-yes').addEventListener('click', ()=>{\n        const player = JSON.parse(leaderboardConfirmModal.dataset.player);\n        player.onLeaderboard = true;\n        finishCheckIn(player);\n    });\n    document.getElementById('leaderboard-btn-no').addEventListener('click', ()=>{\n        const player = JSON.parse(leaderboardConfirmModal.dataset.player);\n        player.onLeaderboard = false;\n        finishCheckIn(player);\n    });\n    document.getElementById('disclaimer-btn').addEventListener('click', ()=>{\n        disclaimerModal.classList.remove('hidden');\n    });\n    document.getElementById('disclaimer-close-btn').addEventListener('click', ()=>{\n        disclaimerModal.classList.add('hidden');\n    });\n    // Event listener for the new Auto-Minimize toggle\n    document.getElementById('auto-minimize-toggle').addEventListener('change', (e)=>{\n        state.notificationControls.autoMinimize = e.target.checked;\n        if (state.notificationControls.autoMinimize) runAutoMinimizeLogic(); // Immediately run the logic when turned on\n        saveState();\n    });\n    // We also need to call the auto-minimize logic whenever players or courts change state\n    // For example, at the end of these functions:\n    // (You will need to find these functions and add the call)\n    // In executeGameCancellation() -> right before saveState()\n    runAutoMinimizeLogic();\n    // In executePlayerCheckIn() -> right before saveState()\n    runAutoMinimizeLogic();\n    // In executePlayerCheckOut() -> right before saveState()\n    runAutoMinimizeLogic();\n    // In finishCheckIn() -> right before saveState()\n    runAutoMinimizeLogic();\n    // In resetCourtAfterGame() -> right before saveState()\n    runAutoMinimizeLogic();\n    // EVENT LISTENERS FOR SOUND SELECTION\n    selectSoundBtn.addEventListener('click', handleSoundSelectionModal);\n    soundSelectionList.addEventListener('change', handleSoundSelection);\n    soundSelectionList.addEventListener('click', handleSoundPreview);\n    soundConfirmBtn.addEventListener('click', confirmSoundSelection);\n    soundCancelBtn.addEventListener('click', cancelSoundSelection);\n    // EVENT LISTENERS FOR STYLE EDITOR\n    editStylesBtn.addEventListener('click', showEditStylesModal);\n    editStylesCloseBtn.addEventListener('click', ()=>{\n        editStylesModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    // EVENT LISTENER FOR NEW FONT SIZE BUTTONS\n    document.getElementById('font-size-selector').addEventListener('click', (e)=>{\n        if (e.target.tagName === 'BUTTON') {\n            const newSize = parseFloat(e.target.dataset.size);\n            handleFontSizeChange(newSize);\n        }\n    });\n    // EVENT LISTENER FOR NEW DISPLAY SIZE BUTTONS\n    document.getElementById('display-size-selector').addEventListener('click', (e)=>{\n        if (e.target.tagName === 'BUTTON') {\n            const newSize = parseFloat(e.target.dataset.size);\n            handleDisplaySizeChange(newSize);\n        }\n    });\n    // EVENT LISTENERS FOR NOTIFICATION CONTROLS\n    muteBtn.addEventListener('click', ()=>{\n        state.notificationControls.isMuted = !state.notificationControls.isMuted;\n        if (state.notificationControls.isMuted) state.notificationControls.isTTSDisabled = true; // Mute implies TTS disabled\n        saveState();\n        updateNotificationIcons();\n        checkAndPlayAlert(false);\n    });\n    minimizeNotificationsBtn.addEventListener('click', ()=>{\n        state.notificationControls.isMinimized = !state.notificationControls.isMinimized;\n        // If minimizing, reset the alert timer to initial check state\n        if (state.notificationControls.isMinimized) resetAlertSchedule();\n        saveState();\n        updateNotificationIcons();\n        checkAndPlayAlert(false);\n    });\n    noSpeechBtn.addEventListener('click', ()=>{\n        state.notificationControls.isTTSDisabled = !state.notificationControls.isTTSDisabled;\n        // If TTS is disabled, we cannot be globally muted (unless actively pressed Mute)\n        if (!state.notificationControls.isTTSDisabled && state.notificationControls.isMuted) state.notificationControls.isMuted = false;\n        saveState();\n        updateNotificationIcons();\n    });\n    // EVENT LISTENERS FOR BALL MANAGEMENT (FIXED: Event Delegation)\n    ballManagementBtn.addEventListener('click', showBallManagementModal);\n    ballManagementCloseBtn.addEventListener('click', ()=>{\n        ballManagementModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden');\n    });\n    addStockBtn.addEventListener('click', handleAddStock);\n    returnStockBtn.addEventListener('click', handleReturnStock);\n    returnUsedBallsBtn.addEventListener('click', handleReturnUsedBalls); // <-- ADD THIS LINE\n    ballHistoryBtn.addEventListener('click', showBallHistoryModal);\n    ballHistoryCloseBtn.addEventListener('click', ()=>{\n        ballHistoryModal.classList.add('hidden');\n        ballManagementModal.classList.remove('hidden');\n    });\n    ballDetailCloseBtn.addEventListener('click', ()=>{\n        ballHistoryDetailModal.classList.add('hidden');\n        ballHistoryModal.classList.remove('hidden'); // Go back to the list\n    });\n    // Use event delegation for the sign out buttons\n    signOutOptions.addEventListener('click', handleSignOut);\n    // FIX: Individual listener binding to guarantee button functionality\n    //document.querySelectorAll('.sign-out-btn').forEach(button => {\n    // Ensure we don't double-bind if the script is reloaded\n    //    button.removeEventListener('click', handleSignOut);\n    //    button.addEventListener('click', handleSignOut);\n    //});\n    // --- NEW EVENT LISTENERS FOR BALL SALES FLOW ---\n    // 0. Listener to handle Sale Type selection on Ball Management Modal\n    ballManagementModal.addEventListener('click', (e)=>{\n        if (e.target.closest('.sign-out-btn') && e.target.closest('.sign-out-btn').dataset.category === 'Sale') // Redirect to handleSignOut, which has been modified to start the sale flow\n        handleSignOut(e);\n    });\n    // 1. Sale Stock Type Modal\n    saleTypeCansBtn.addEventListener('click', ()=>handleSaleStockTypeSelection('cans'));\n    saleTypeSinglesBtn.addEventListener('click', ()=>handleSaleStockTypeSelection('singles'));\n    saleTypeCancelBtn.addEventListener('click', ()=>{\n        ballSaleTypeModal.classList.add('hidden');\n        ballManagementModal.classList.remove('hidden');\n    });\n    // 2. Purchaser Selection Modal\n    purchaserMemberList.addEventListener('click', (e)=>{\n        const li = e.target.closest('li');\n        if (li && li.querySelector('input[name=\"purchaserMember\"]')) {\n            const radio = li.querySelector('input[name=\"purchaserMember\"]');\n            radio.checked = true; // Select the radio button\n            const purchaserName = radio.value;\n            const purchaserType = li.querySelector('.member-designation').textContent.toLowerCase().includes('guest') ? 'guest' : 'member';\n            purchaserSelectionModal.classList.add('hidden'); // Close the list modal\n            confirmPurchaser(purchaserName, purchaserType);\n        }\n    });\n    document.getElementById('purchaser-new-guest-btn').addEventListener('click', ()=>{\n        // Use the existing guest name modal logic, but with a new 'purchaser' context\n        guestNameModal.dataset.context = 'purchaser';\n        purchaserSelectionModal.classList.add('hidden');\n        // The guest name modal's confirm button will now call confirmPurchaser upon completion\n        guestNameModal.classList.remove('hidden');\n        // Ensure guest form is reset for new guest entry\n        guestNameInput.value = '';\n        guestSurnameInput.value = '';\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\n        document.querySelector('input[name=\"player-type\"][value=\"member\"]').disabled = true; // Disable member option here\n        validateGuestForm();\n    });\n    document.getElementById('purchaser-returning-guest-btn').addEventListener('click', ()=>{\n        document.getElementById('returning-guest-modal').dataset.context = 'purchaser';\n        purchaserSelectionModal.classList.add('hidden');\n        populateReturningGuestModal();\n        document.getElementById('returning-guest-modal').classList.remove('hidden');\n    });\n    document.getElementById('purchaser-cancel-btn').addEventListener('click', ()=>{\n        purchaserSelectionModal.classList.add('hidden');\n        // Clear temporary state and go back to committee member selection modal\n        state.ballManagement.tempSale = {\n            stockType: null,\n            memberSignOut: null,\n            purchaserName: null\n        };\n        // The only way to get here is from a sale, so re-open the committee member list\n        handleSignOut({\n            target: document.querySelector('.sign-out-btn[data-category=\"Sale\"]')\n        });\n    });\n    // --- RE-ADD LISTENER FOR RETURNING GUEST BACK BUTTON IN PURCHASER CONTEXT ---\n    document.getElementById('returning-guest-cancel-btn').addEventListener(\"click\", (e)=>{\n        const returningGuestModal = document.getElementById('returning-guest-modal');\n        if (returningGuestModal.dataset.context === 'purchaser') {\n            e.preventDefault(); // Stop default action\n            returningGuestModal.classList.add('hidden');\n            // Show the purchaser modal again (which auto-populates the list)\n            purchaserSelectionModal.classList.remove('hidden');\n            delete returningGuestModal.dataset.context;\n        }\n    });\n    // NEW EVENT LISTENERS FOR SIGN-OUT MEMBER MODAL\n    signOutMemberConfirmBtn.addEventListener('click', handleMemberSelectionConfirm);\n    signOutMemberCancelBtn.addEventListener('click', ()=>{\n        signOutMemberModal.classList.add('hidden');\n        ballManagementModal.classList.remove('hidden');\n    });\n    // EVENT LISTENERS FOR MANUAL GAME ENTRY (Consolidated and Corrected)\n    document.getElementById('manual-entry-btn').addEventListener('click', openManualPlayerSelectionModal);\n    manualPlayerList.addEventListener('click', handleManualPlayerClick);\n    manualEntryCancelBtn.addEventListener('click', ()=>{\n        manualEntryModal.classList.add('hidden');\n        historyPage.classList.remove('hidden'); // Return to history\n    });\n    manualEntryConfirmBtn.addEventListener('click', handleConfirmManualPlayers);\n    addOutsidePlayerBtn.addEventListener('click', showOutsidePlayerModal);\n    outsidePlayerList.addEventListener('click', handleOutsidePlayerClick);\n    outsidePlayerConfirmBtn.addEventListener('click', handleConfirmManualPlayers);\n    outsidePlayerBackBtn.addEventListener('click', ()=>{\n        outsidePlayerModal.classList.add('hidden');\n        showManualPlayerSelectionModal(); // Go back and re-render the main selection modal\n    });\n    document.getElementById('manual-add-guest-btn').addEventListener('click', ()=>{\n        // Use the existing guest name modal logic, but set context\n        guestNameModal.dataset.context = 'manual-entry';\n        manualEntryModal.classList.add('hidden'); // Hide manual entry temporarily\n        // Ensure guest form is reset for new guest entry\n        guestNameInput.value = '';\n        guestSurnameInput.value = '';\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\n        // Disable selecting 'member' when adding guest from manual entry\n        document.querySelector('input[name=\"player-type\"][value=\"member\"]').disabled = true;\n        validateGuestForm();\n        guestNameModal.classList.remove('hidden');\n    });\n    // Listener for removing a player from the \"Selected\" area in the main modal\n    manualSelectedPlayersContainer.addEventListener('click', (e)=>{\n        const chip = e.target.closest('.selected-player-chip');\n        if (chip) handleRemoveManualPlayer(chip.dataset.playerName);\n    });\n    // Listener for removing a player from the \"Selected\" area in the outside player modal\n    outsideSelectedPlayersContainer.addEventListener('click', (e)=>{\n        const chip = e.target.closest('.selected-player-chip');\n        if (chip) handleRemoveManualPlayer(chip.dataset.playerName);\n    });\n    // EVENT LISTENERS FOR ADMIN COURT MANAGEMENT\n    managePlayersCloseBtn.addEventListener('click', handleManageClose);\n    managePlayersBackBtn.addEventListener('click', handleManageBack);\n    managePlayersConfirmBtn.addEventListener('click', handleManageConfirm);\n    managePlayersAddBtn.addEventListener('click', ()=>{\n        const { removedPlayers, addedPlayers, courtId: courtId1 } = state.adminCourtManagement;\n        const hasChanges = removedPlayers.length > 0 || addedPlayers.length > 0;\n        if (hasChanges) showAddPlayerCard(courtId1);\n    });\n    manageCourtPlayersModal.addEventListener('click', (e)=>{\n        const target = e.target.closest('.action-icon');\n        if (!target) return;\n        const courtId1 = target.dataset.courtId;\n        const action = target.dataset.action;\n        const playerName = target.dataset.player;\n        const { adminCourtManagement } = state;\n        if (action === 'select-court') showRemovePlayerCard(courtId1);\n        else if (action === 'remove-player-temp') {\n            const playerObject = adminCourtManagement.currentCourtPlayers.find((p)=>p.name === playerName);\n            if (playerObject && !adminCourtManagement.removedPlayers.some((p)=>p.name === playerName)) {\n                adminCourtManagement.removedPlayers.push(playerObject);\n                showRemovePlayerCard(adminCourtManagement.courtId);\n            }\n        } else if (action === 'return-player-temp') {\n            adminCourtManagement.removedPlayers = adminCourtManagement.removedPlayers.filter((p)=>p.name !== playerName);\n            showRemovePlayerCard(adminCourtManagement.courtId);\n        } else if (action === 'add-player-temp') {\n            // Corrected: Just add to the temp list. Do NOT modify state.availablePlayers here.\n            const playerObject = state.availablePlayers.find((p)=>p.name === playerName);\n            if (playerObject && !adminCourtManagement.addedPlayers.some((p)=>p.name === playerName)) {\n                adminCourtManagement.addedPlayers.push(playerObject);\n                renderAddPlayersList(adminCourtManagement.courtId);\n            }\n        } else if (action === 'undo-add-player-temp') {\n            // Corrected: Just remove from the temp list.\n            adminCourtManagement.addedPlayers = adminCourtManagement.addedPlayers.filter((p)=>p.name !== playerName);\n            renderAddPlayersList(adminCourtManagement.courtId);\n        }\n        updateGameModeBasedOnPlayerCount();\n        saveState();\n    });\n    // --- START OF NEW KEYBOARD BINDING LOGIC ---\n    document.addEventListener('keydown', (e)=>{\n        // Determine which modal is active\n        const isNumericKeypadActive = !customKeypadModal.classList.contains('hidden');\n        const isAlphaKeypadActive = !customAlphaKeypadModal.classList.contains('hidden');\n        const isGlobalKeyboardActive = !globalKeyboardModal.classList.contains('hidden'); // <-- NEW CHECK\n        // First, check if the numeric keypad is active\n        if (isNumericKeypadActive) {\n            e.preventDefault();\n            // ... (numeric keypad logic remains the same) ...\n            let targetButton;\n            const key = e.key;\n            if (key >= '0' && key <= '9') targetButton = customKeypadModal.querySelector(`.keypad-btn[data-key=\"${key}\"]`);\n            else if (key === 'Backspace') targetButton = customKeypadModal.querySelector('.keypad-btn[data-key=\"backspace\"]');\n            else if (key === 'Enter') targetButton = document.getElementById('keypad-confirm-btn');\n            else if (key.toLowerCase() === 'c') targetButton = customKeypadModal.querySelector('.keypad-btn[data-key=\"clear\"]');\n            if (targetButton && !targetButton.disabled) targetButton.click();\n        } else if (isAlphaKeypadActive) {\n            e.preventDefault();\n            // ... (alpha keypad logic remains the same) ...\n            let targetButton;\n            const key = e.key;\n            if (key.length === 1 && key.match(/[a-zA-Z]/i)) // Find letter buttons (case-insensitive)\n            targetButton = customAlphaKeypadModal.querySelector(`.keypad-btn[data-key=\"${key.toUpperCase()}\"]`);\n            else if (key === ' ') targetButton = customAlphaKeypadModal.querySelector('.keypad-btn[data-key=\"space\"]');\n            else if (key === 'Backspace') targetButton = customAlphaKeypadModal.querySelector('.keypad-btn[data-key=\"backspace\"]');\n            else if (key === 'Enter') targetButton = document.getElementById('alpha-keypad-confirm-btn');\n            if (targetButton && !targetButton.disabled) targetButton.click();\n        } else if (isGlobalKeyboardActive) {\n            e.preventDefault(); // Prevent default typing behavior\n            const key = e.key;\n            const code = e.code; // Use e.code for more reliable layout-independent key identification\n            const isShiftPressed = e.shiftKey;\n            let characterToInsert = null;\n            let actionToPerform = null;\n            // --- 1. Determine Character or Action ---\n            // Handle letters first (respecting physical shift)\n            if (code.startsWith('Key') && key.length === 1 && key.match(/[a-zA-Z]/i)) characterToInsert = isShiftPressed ? key.toUpperCase() : key.toLowerCase();\n            else if (code === 'Backspace') actionToPerform = 'BACK';\n            else if (code === 'Enter') actionToPerform = 'ENTER';\n            else if (code === 'Space') actionToPerform = 'SPACE';\n            else if (code === 'ShiftLeft' || code === 'ShiftRight') actionToPerform = 'SHIFT';\n            else if (key.length === 1 && !key.match(/[a-zA-Z]/i)) {\n                // Check if it's a standard symbol first\n                const standardSymbols = \"!@#$%^&*()_+{}|:\\\"<>?~`-=[]\\\\;',./\";\n                if (standardSymbols.includes(key)) characterToInsert = key; // Use the symbol directly reported by e.key\n                else if (key >= '0' && key <= '9' && !isShiftPressed) characterToInsert = key;\n                else if (isShiftPressed) switch(code){\n                    case 'Digit1':\n                        characterToInsert = '!';\n                        break;\n                    case 'Digit2':\n                        characterToInsert = '@';\n                        break;\n                    case 'Digit3':\n                        characterToInsert = '#';\n                        break;\n                    case 'Digit4':\n                        characterToInsert = '$';\n                        break;\n                    case 'Digit5':\n                        characterToInsert = '%';\n                        break;\n                    case 'Digit6':\n                        characterToInsert = '^';\n                        break;\n                    case 'Digit7':\n                        characterToInsert = '&';\n                        break;\n                    case 'Digit8':\n                        characterToInsert = '*';\n                        break;\n                    case 'Digit9':\n                        characterToInsert = '(';\n                        break;\n                    case 'Digit0':\n                        characterToInsert = ')';\n                        break;\n                    case 'Minus':\n                        characterToInsert = '_';\n                        break;\n                    case 'Equal':\n                        characterToInsert = '+';\n                        break;\n                }\n                else switch(code){\n                    case 'Minus':\n                        characterToInsert = '-';\n                        break;\n                    case 'Equal':\n                        characterToInsert = '=';\n                        break;\n                    case 'BracketLeft':\n                        characterToInsert = '[';\n                        break;\n                    case 'BracketRight':\n                        characterToInsert = ']';\n                        break;\n                    case 'Backslash':\n                        characterToInsert = '\\\\';\n                        break;\n                    case 'Semicolon':\n                        characterToInsert = ';';\n                        break;\n                    case 'Quote':\n                        characterToInsert = '\\'';\n                        break;\n                    case 'Comma':\n                        characterToInsert = ',';\n                        break;\n                    case 'Period':\n                        characterToInsert = '.';\n                        break;\n                    case 'Slash':\n                        characterToInsert = '/';\n                        break;\n                    case 'Backquote':\n                        characterToInsert = '`';\n                        break;\n                }\n            } // End of single character key handling\n            // --- 2. Handle Navigation Keys (Use button clicks for page changes) ---\n            // (Navigation logic remains the same - finding button by text content)\n            const navKeyMap = {\n            };\n            if (navKeyMap[key] || navKeyMap[code]) {\n                actionToPerform = navKeyMap[key] || navKeyMap[code];\n                characterToInsert = null;\n            }\n            // --- 3. Perform Action or Insert Character ---\n            let currentValue = globalKeyboardDisplay.textContent;\n            if (characterToInsert !== null) {\n                currentValue += characterToInsert;\n                if (globalKeyboardState.case === 'shift') {\n                    globalKeyboardState.case = 'lower';\n                    if (globalKeyboardState.currentPage === 'LetterPad') renderGlobalKeyboard();\n                }\n            } else if (actionToPerform) {\n                let targetButton;\n                switch(actionToPerform){\n                    case 'SPACE':\n                        currentValue += ' ';\n                        break;\n                    case 'BACK':\n                        currentValue = currentValue.slice(0, -1);\n                        break;\n                    case 'ENTER':\n                        currentValue += '\\n';\n                        targetButton = globalKeyboardModal.querySelector('.global-keypad-btn[data-key=\"ENTER\"]');\n                        break;\n                    case 'SHIFT':\n                        targetButton = globalKeyboardModal.querySelector('.global-keypad-btn[data-key=\"SHIFT\"]');\n                        break;\n                    case '?123':\n                    case 'ABC':\n                    case '1234':\n                    case '!@#':\n                        targetButton = Array.from(globalKeyboardModal.querySelectorAll('.global-keypad-btn.key-special')).find((btn)=>btn.textContent.trim() === actionToPerform);\n                        break;\n                }\n                if (targetButton && !targetButton.disabled) targetButton.click();\n            }\n            // --- 4. Update Display and Input ---\n            if (characterToInsert !== null || [\n                'SPACE',\n                'BACK',\n                'ENTER'\n            ].includes(actionToPerform)) {\n                globalKeyboardDisplay.textContent = currentValue;\n                if (activeGlobalInput) {\n                    activeGlobalInput.value = currentValue;\n                    activeGlobalInput.dispatchEvent(new Event('input'));\n                }\n                globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight;\n            }\n        }\n    // --- END REVISED BLOCK ---\n    });\n    // --- START OF NEW VISIBILITY CHANGE LOGIC ---\n    document.addEventListener('visibilitychange', ()=>{\n        // Check if the page has become visible\n        if (document.visibilityState === 'visible') // Re-run the function that applies the court selection animations\n        ensureCourtSelectionAnimation();\n    });\n    // --- END OF NEW VISIBILITY CHANGE LOGIC ---\n    function getTeamKeyFromElement(item) {\n        const teamNameSpan = item.querySelector('.team-name-stacked');\n        if (teamNameSpan) {\n            const playerSpans = teamNameSpan.querySelectorAll('span');\n            const players = Array.from(playerSpans).map((span)=>span.textContent.trim());\n            return players.sort().join(' & ');\n        }\n        return item.dataset.name; // Fallback to data attribute\n    }\n    // --- NEW: COMPARISON MODAL LISTENERS (Event Delegation) ---\n    function handleHistoryItemClick(e) {\n        const item = e.target.closest('.history-item');\n        if (!item || e.target.closest('.sort-btn') || e.target.closest('.radio-group')) return;\n        let type = item.dataset.type;\n        let name = item.dataset.name;\n        // If no dataset, determine from current view\n        if (!type) {\n            if (state.historyViewMode === 'teams') {\n                type = 'team';\n                name = getTeamKeyFromElement(item); // Use helper\n            } else if (state.historyViewMode === 'stats') {\n                type = 'player';\n                const nameSpan = item.querySelector('.stats-grid-row span:first-child');\n                if (nameSpan) name = nameSpan.textContent.trim();\n            }\n        }\n        if (!name || !type) return;\n        if (state.comparison.active && state.comparison.type !== type) resetComparisonState();\n        state.comparison.active = true;\n        state.comparison.type = type;\n        const itemIndex = state.comparison.items.indexOf(name);\n        if (itemIndex > -1) state.comparison.items.splice(itemIndex, 1);\n        else if (state.comparison.items.length < 2) state.comparison.items.push(name);\n        if (state.comparison.items.length === 1) {\n            const selectedName = state.comparison.items[0];\n            const opponents = new Set();\n            state.gameHistory.forEach((game)=>{\n                const team1Players = game.teams.team1;\n                const team2Players = game.teams.team2;\n                if (type === 'player') {\n                    const isOnTeam1 = team1Players.includes(selectedName);\n                    const isOnTeam2 = team2Players.includes(selectedName);\n                    if (isOnTeam1) team2Players.forEach((p)=>opponents.add(p));\n                    else if (isOnTeam2) team1Players.forEach((p)=>opponents.add(p));\n                } else {\n                    const team1Key = [\n                        ...team1Players\n                    ].sort().join(' & ');\n                    const team2Key = [\n                        ...team2Players\n                    ].sort().join(' & ');\n                    if (team1Key === selectedName) opponents.add(team2Key);\n                    else if (team2Key === selectedName) opponents.add(team1Key);\n                }\n            });\n            state.comparison.opponents = opponents;\n        } else if (state.comparison.items.length === 0) resetComparisonState();\n        if (type === 'player') renderPlayerHistory();\n        else renderTeamHistory();\n        saveState(); // Add this\n        if (state.comparison.items.length === 2) renderComparisonModal();\n    }\n    // Replace with a single delegated listener on the parent container:\n    historyPage.addEventListener('click', (e)=>{\n        // Check if click is within either stats list\n        const historyItem = e.target.closest('#history-list .history-item, #team-history-list .history-item');\n        if (!historyItem) return;\n        // Prevent action on sort buttons\n        if (e.target.closest('.sort-btn') || e.target.closest('.radio-group')) return;\n        handleHistoryItemClick(e);\n    });\n    comparisonCloseBtn.addEventListener('click', ()=>{\n        comparisonModal.classList.add('hidden');\n        historyPage.classList.remove('hidden');\n        resetComparisonState();\n        resetStatsFilters();\n        renderHistory(); // This will render based on current state.historyViewMode\n        saveState(); // Add this to persist the state\n    });\n    // --- SUGGESTION SETTINGS MODAL LISTENERS ---\n    suggestionSettingsBtn.addEventListener('click', showSuggestionSettingsModal);\n    suggestionSettingsCloseBtn.addEventListener('click', ()=>{\n        suggestionSettingsModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden'); // Return to main admin modal\n    });\n    femaleRatioSlider.addEventListener('input', handleFemaleRatioChange);\n    maleRatioSlider.addEventListener('input', handleMaleRatioChange);\n    leastPlaytimeToggle.addEventListener('change', handleLeastPlaytimeToggleChange);\n    powerScoreOnlyToggle.addEventListener('change', handlePowerScoreOnlyToggleChange);\n    topPlayerSlider.addEventListener('input', handleTopPlayerChange);\n    frequentOpponentSlider.addEventListener('input', handleFrequentOpponentChange);\n    weakPlayerSlider.addEventListener('input', handleWeakPlayerChange);\n    // --- ADMIN CHECKLIST MODAL LISTENERS ---\n    checklistBtn.addEventListener('click', showChecklistModal);\n    checklistCloseBtn.addEventListener('click', ()=>{\n        checklistModal.classList.add('hidden');\n        adminSettingsModal.classList.remove('hidden'); // Return to admin modal\n    });\n    // Use event delegation for checkboxes\n    checklistContent.addEventListener('change', handleChecklistChange); // Target the new container\n    // --- CHECKLIST HISTORY LISTENERS ---\n    // --- ADD THIS LISTENER ---\n    checklistHistoryBtn.addEventListener('click', showChecklistHistoryModal);\n    // --- END ADD ---\n    checklistHistoryCloseBtn.addEventListener('click', ()=>{\n        checklistHistoryModal.classList.add('hidden');\n        // Decide where to return: main checklist or admin settings\n        if (!checklistModal.classList.contains('hidden')) ;\n        else adminSettingsModal.classList.remove('hidden'); // Default return to admin\n        state.selectedChecklistHistoryDate = null; // Clear selected date\n    });\n    // Delegate clicks within the history date list\n    checklistHistoryList.addEventListener('click', (e)=>{\n        const li = e.target.closest('li[data-date]');\n        if (li) showChecklistHistoryDetail(li.dataset.date);\n    });\n    // Back button in the detail view\n    checklistHistoryBackBtn.addEventListener('click', ()=>{\n        checklistHistoryDetailView.classList.add('hidden');\n        checklistHistoryListView.classList.remove('hidden');\n        checklistHistoryBackBtn.classList.add('hidden'); // Hide back button again\n        checklistHistoryTitle.textContent = 'Checklist History'; // Reset title\n        state.selectedChecklistHistoryDate = null; // Clear selected date\n    });\n    // Listener to close the Global Keyboard when clicking outside (or on the DONE button if we add one)\n    globalKeyboardModal.addEventListener('click', (e)=>{\n        // Only hide if the click is directly on the modal background/content, not a key\n        if (!e.target.closest('.global-keypad-btn') && !e.target.closest('.keyboard-content')) hideGlobalKeyboard();\n    });\n    // --- NEW: Wire Date Inputs to Global Keyboard (NumberPad on Click) ---\n    const eventDateInput = document.getElementById('event-date');\n    const eventRsvpDateInput = document.getElementById('event-rsvp-date');\n    const eventStartTimeInput = document.getElementById('event-start-time');\n    const dateInputClickListener = (e)=>{\n        const targetInputElement = e.target;\n        // Check if click was on the calendar/clock icon\n        // These icons are positioned on the right side of the input\n        const inputRect = targetInputElement.getBoundingClientRect();\n        const clickX = e.clientX;\n        const iconWidth = 30; // Approximate width of the icon area\n        const isIconClick = clickX > inputRect.right - iconWidth;\n        // If icon was clicked, allow native picker\n        if (isIconClick) // Don't prevent default - let the native picker open\n        return;\n        // Otherwise, prevent native picker and show custom keypad\n        e.preventDefault();\n        // Add class to indicate using custom keypad\n        targetInputElement.classList.add('using-custom-keypad');\n        // Get the overlay element\n        const overlayId = targetInputElement.id + '-overlay';\n        const overlay = document.getElementById(overlayId);\n        if (overlay) targetInputElement.dataset.overlayId = overlayId;\n        // Initialize date part tracking (start with YYYY)\n        if (targetInputElement.type === 'date') {\n            targetInputElement.dataset.currentDatePart = 'YYYY';\n            targetInputElement.dataset.partialValue = '';\n        } else if (targetInputElement.type === 'time') {\n            targetInputElement.dataset.currentDatePart = 'HH';\n            targetInputElement.dataset.partialValue = '';\n        }\n        // Don't pre-fill keypad display, let user type directly into date input\n        const initialKeypadValue = ''; // Start keypad display empty\n        // Show keypad, passing the *target* date input\n        showGlobalKeyboard(targetInputElement, 'NumberPad', initialKeypadValue); // Pass empty initial value\n    };\n    if (eventDateInput) eventDateInput.addEventListener('click', dateInputClickListener);\n    if (eventRsvpDateInput) eventRsvpDateInput.addEventListener('click', dateInputClickListener);\n    if (eventStartTimeInput) eventStartTimeInput.addEventListener('click', dateInputClickListener);\n    // --- END NEW ---\n    // --- Parent Registration Field Listeners ---\n    if (parentNameInput) parentNameInput.addEventListener('click', (e)=>{\n        showGlobalKeyboard(e.target, 'LetterPad', '');\n    });\n    if (parentSurnameInput) parentSurnameInput.addEventListener('click', (e)=>{\n        showGlobalKeyboard(e.target, 'LetterPad', '');\n    });\n    if (parentPhoneInput) parentPhoneInput.addEventListener('click', (e)=>{\n        showGlobalKeyboard(e.target, 'NumberPad', '');\n    });\n    if (parentEmailInput) parentEmailInput.addEventListener('click', (e)=>{\n        showGlobalKeyboard(e.target, 'LetterPad', '');\n    });\n    // Swap Player Modal Listeners\n    document.getElementById('swap-player-back-btn').addEventListener('click', ()=>{\n        document.getElementById('swap-player-modal').classList.add('hidden');\n        manageCourtPlayersModal.classList.remove('hidden');\n    });\n    document.getElementById('swap-confirm-back-btn').addEventListener('click', ()=>{\n        document.getElementById('swap-confirm-modal').classList.add('hidden');\n        document.getElementById('swap-player-modal').classList.remove('hidden');\n    });\n    document.getElementById('swap-confirm-execute-btn').addEventListener('click', ()=>{\n        executePlayerSwap();\n    });\n    // --- NEW EVENT LISTENERS FOR TTS INTERVAL ---\n    document.getElementById('tts-interval-increase').addEventListener('click', ()=>handleTtsIntervalChange('increase'));\n    document.getElementById('tts-interval-decrease').addEventListener('click', ()=>handleTtsIntervalChange('decrease'));\n    // --- Event Listeners for Consolidated Light Settings Modal ---\n    // Court settings modal buttons\n    document.getElementById('light-settings-court-cancel-btn')?.addEventListener('click', ()=>{\n        document.getElementById('light-settings-court-modal').classList.add('hidden');\n        showAdminModal(); // Re-show admin modal\n    });\n    document.getElementById('light-settings-court-save-btn')?.addEventListener('click', saveLightSettingsCourtModal);\n    // ============================================================================\n    // EVENT LISTENERS - Add these in your DOMContentLoaded section\n    // ============================================================================\n    // Setup long-press for both gate buttons\n    setupGateButtonLongPress('pedestrian');\n    setupGateButtonLongPress('parking');\n    // Pedestrian gate settings modal\n    document.getElementById('pedestrian-gate-settings-save-btn')?.addEventListener('click', ()=>{\n        saveGateSettings('pedestrian');\n    });\n    document.getElementById('pedestrian-gate-settings-cancel-btn')?.addEventListener('click', ()=>{\n        document.getElementById('pedestrian-gate-settings-modal').classList.add('hidden');\n    });\n    // Parking gate settings modal\n    document.getElementById('parking-gate-settings-save-btn')?.addEventListener('click', ()=>{\n        saveGateSettings('parking');\n    });\n    document.getElementById('parking-gate-settings-cancel-btn')?.addEventListener('click', ()=>{\n        document.getElementById('parking-gate-settings-modal').classList.add('hidden');\n    });\n});\n\n//# sourceMappingURL=public.ad6f3c9d.js.map\n","console.log(\"--- script.js started ---\");\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n\r\n    const ADMIN_PIN_BASE = \"0308\"; // <-- ADD THIS NEW LINE\r\n    let MASTER_MEMBER_LIST = []; // Will be populated from the CSV file\r\n\r\n    // --- NEW HELPER FUNCTION TO PARSE CSV DATA ---\r\n    function parseCSV(csvText) {\r\n        const lines = csvText.trim().split('\\n');\r\n        if (!lines[0]) return []; // Handle empty file\r\n        // Updated headers to include 'phonetic spelling'\r\n        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());\r\n        const result = [];\r\n        for (let i = 1; i < lines.length; i++) {\r\n            if (!lines[i]) continue; // Skip blank lines\r\n\r\n            // Split line, handling potential commas within quoted fields if needed (simple split for now)\r\n            const values = lines[i].split(',').map(v => v.trim());\r\n\r\n            // --- THIS IS THE FIX: Allow for variable column length ---\r\n            // We expect at least Name, Gender, Type (3 columns).\r\n            // Committee and Phonetic Spelling might be missing or empty.\r\n            if (values.length < 3) continue; // Skip lines with insufficient basic data\r\n            // --- END OF FIX ---\r\n\r\n            const entry = {};\r\n\r\n            headers.forEach((header, index) => {\r\n                // Ensure we don't try to access an index that doesn't exist\r\n                if (index >= values.length) return;\r\n\r\n                const value = values[index];\r\n                if (!value) return; // Skip if the value is empty\r\n\r\n                if (header === 'gender') {\r\n                    entry[header] = value.charAt(0).toUpperCase();\r\n                } else if (header === 'phonetic spelling') { // New: Read phonetic spelling\r\n                    entry['phoneticName'] = value; // Store under phoneticName key\r\n                } else if (header === 'guest' || header === 'isPaused') {\r\n                    entry[header] = (value.toLowerCase() === 'true');\r\n                } else {\r\n                    entry[header] = value;\r\n                }\r\n            });\r\n\r\n\r\n            if (!entry.name) continue; // Skip entries without a name\r\n\r\n            // Add the default values that are not in the CSV\r\n            entry.guest = entry.guest || false; // Keep existing guest status if loaded\r\n            entry.isPaused = entry.isPaused || false; // Keep existing pause status\r\n            result.push(entry);\r\n        }\r\n        return result;\r\n    }\r\n    // --- NEW HELPER FUNCTION: Gets the name to use for TTS ---\r\n    // --- UPDATED HELPER FUNCTION: Gets the name to use for TTS (Phonetic First + Surname) ---\r\n    function getPronounceableName(playerName) {\r\n        if (!playerName) return ''; // Handle null or empty input\r\n\r\n        // Find the player object in the master list or current state\r\n        const playerObj = MASTER_MEMBER_LIST.find(p => p.name === playerName)\r\n                       || state.availablePlayers.find(p => p.name === playerName)\r\n                       || state.courts.flatMap(c => c.players).find(p => p.name === playerName);\r\n\r\n        // Extract surname (assuming name format is \"FirstName LastName\" or similar)\r\n        const nameParts = playerName.split(' ');\r\n        const surname = nameParts.length > 1 ? nameParts.slice(1).join(' ') : ''; // Get everything after the first space\r\n\r\n        // Use phonetic first name + surname if available, otherwise default to full name\r\n        if (playerObj && playerObj.phoneticName && surname) {\r\n            // Combine phonetic first name with the regular surname\r\n            return `${playerObj.phoneticName} ${surname}`;\r\n        } else if (playerObj && playerObj.phoneticName) {\r\n            // If only a phonetic first name exists (maybe single-name entry?), use just that\r\n            return playerObj.phoneticName;\r\n        } else {\r\n            // Fallback to the full original name if no phonetic spelling exists\r\n            return playerName;\r\n        }\r\n    }\r\n    // --- END UPDATED HELPER ---\r\n    // --- END NEW HELPER ---\r\n\r\n    \r\n    // Define the preferred court hierarchy\r\n    const COURT_HIERARCHY = ['B', 'C', 'D', 'A', 'E'];\r\n\r\n    // --- STATE MANAGEMENT ---\r\n\r\n\r\n    let state = {\r\n\r\n        undoHistory: {\r\n            actions: [], // Array of undo-able actions\r\n            maxHistory: 10 // Keep last 10 actions\r\n        },\r\n\r\n        juniorClub: {\r\n            // Master list of all registered parents/children\r\n            parents: [], \r\n            // Children currently checked into the club (will be returned to queue later)\r\n            activeChildren: [], \r\n            // History logs check-in sessions for payment tracking\r\n            history: [], // { id, parentId, parentName, childNames: [], date, isPaid }\r\n            \r\n            // --- FIX: Corrected the object structure ---\r\n            statsFilter: { // This is for the History/Payment modal\r\n                parent: 'all',\r\n                paid: 'all', // 'all', 'paid', 'unpaid'\r\n            }, // <-- CORRECTED CLOSING BRACE\r\n\r\n            \r\n            rosterFilter: { // This is for the new Roster modal\r\n                sortKey: 'name',         // 'name' or 'last_checkin'\r\n                sortOrder: 'asc',        // 'asc' or 'desc'\r\n                type: 'all',              // 'all', 'parents', 'children' <-- NEW PROPERTY\r\n \r\n            },\r\n            // NEW: State for the main check-in list filter\r\n            checkInFilter: {\r\n                displayMode: 'parent', // 'parent' or 'child'\r\n            },\r\n\r\n            // NEW STATE FOR DYNAMIC FORM FLOW\r\n            registrationFlow: {\r\n                parentCollapsed: false,\r\n                childrenExpanded: false,\r\n            }\r\n        },\r\n\r\n        // --- NEW: Event Management & Screensaver State ---\r\n        events: [], // Array to hold event objects\r\n        // Structure for each event object:\r\n        // {\r\n        //  id: Date.now(), // Unique ID\r\n        //  eventType: 'Social', // 'Social', 'Club Champs', 'League', 'Other'\r\n        //  heading: '',\r\n        //  eventDate: '', // YYYY-MM-DD\r\n        //  rsvpDate: '',   // YYYY-MM-DD\r\n        //  startTime: '', // HH:MM\r\n        //  body1: '',\r\n        //  body2: '',\r\n        //  costAdult: 0,\r\n        //  costChild: 0,\r\n        //  participationDiscountPercent: 0, // 0-100\r\n        //  rsvpText: '',\r\n        //  volunteersNeeded: false,\r\n        //  contactDetails: '',\r\n        //  openTo: 'All Members', // 'Full Members', 'Social Members', 'All Members'\r\n        //  isOpenToGuests: false,\r\n        //  image1Filename: 'None', // e.g., 'Braai.jpg', 'None'\r\n        //  image2Filename: 'None',\r\n        //  isActive: false, // Controls screensaver visibility\r\n        //  interestedPlayers: [] // Array of player names\r\n        // }\r\n        // --- END: Event Management ---\r\n\r\n        uiSettings: {\r\n            fontSizeMultiplier: 1.0, // 1.0 is the default (100%)\r\n            displaySizeMultiplier: 1.0 // Add this line\r\n        },\r\n\r\n        detailedWeatherView: 'day', // 'day', 'morning', 'afternoon'\r\n        weatherData: null,\r\n        pongAnimationOffset: 0,\r\n\r\n        clubMembers: [...MASTER_MEMBER_LIST].sort((a, b) => a.name.localeCompare(b.name)),\r\n        availablePlayers: [],\r\n        courts: [\r\n            // ADD isCollapsed: false to each court object\r\n            { id: 'A', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n            { id: 'B', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n            { id: 'C', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n            { id: 'D', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n            { id: 'E', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n        ],\r\n        courtSettings: {\r\n            visibleCourts: ['A', 'B', 'C', 'D', 'E'],\r\n            autoAssignModes: true,\r\n            showGameModeSelector: false // <-- ADD THIS LINE\r\n        },\r\n\r\n    // NEW MATCH SETTINGS BLOCK\r\n        matchSettings: {\r\n            matchMode: '1set',    // '1set', '3set', 'fast'\r\n            fastPlayGames: 4,     // 3, 4, or 5\r\n            autoMatchModes: true  // Auto-assign match modes\r\n        },\r\n\r\n        mobileControls: {\r\n            isSummaryExpanded: true,\r\n            isPlayersExpanded: true,\r\n        },\r\n\r\n        selection: {\r\n            gameMode: 'doubles',\r\n            players: [],\r\n            courtId: null\r\n        },\r\n\r\n        historySort: {\r\n            key: 'endTime',\r\n            order: 'desc'\r\n        },\r\n\r\n        gameHistoryFilter: {\r\n            timeFrame: 'Total', // 'Today', 'Month', 'Year', 'Total'\r\n            gameType: 'all'     // 'all', 'doubles', 'singles'\r\n        },\r\n\r\n        guestHistory: [], // NEW: To store guest data\r\n        gameHistory: [],\r\n        reorderHistory: [],\r\n        historyViewMode: 'games',\r\n        statsFilter: {\r\n            gender: 'all',\r\n            teamGender: 'all', // <-- ADD THIS LINE\r\n            sortKey: 'totalDurationMs',\r\n            sortOrder: 'desc'\r\n        },\r\n        // NEW COMPARISON MODAL STATE\r\n        comparison: {\r\n            active: false,\r\n            type: null, // 'player' or 'team'\r\n            items: [], // Names of the two players/teams\r\n            timeFrame: 'Total',\r\n            opponents: new Set() // <-- ADD THIS LINE\r\n        },\r\n        // NEW ANNOUNCEMENT STATE\r\n        announcements: [], // { text: \"message\", tts: true }\r\n        customAnnouncementState: {\r\n            scheduler: null,\r\n            nextAnnouncementTime: 0,\r\n            currentIndex: 0,\r\n            isPaused: false,\r\n            ttsIntervalMins: 30 // <-- ADD THIS LINE (default is 30 mins)\r\n        },\r\n        powerScoreSort: {\r\n                key: 'finalScore',\r\n                order: 'desc'\r\n            },\r\n        suggestionSettings: {\r\n            femaleRatioPercent: 50,\r\n            maleRatioPercent: 70,\r\n            prioritizeLeastPlaytime: true,\r\n            powerScoreOnly: false,\r\n            // --- NEW SETTINGS ---\r\n\r\n            topPlayerPercent: 35,       // Default 35%\r\n            frequentOpponentPercent: 35, // Default 35%\r\n            weakPlayerPercent: 35,      // Default 35%\r\n            weakPlayerThreshold: -0.1,   // Example threshold (lower scores are weaker)\r\n            \r\n            // --- END NEW ---\r\n        },\r\n\r\n        currentSuggestionType: null, // Stores the type ('topPlayer', 'frequentOpponent', 'weakPlayer', 'standard')\r\n        currentSuggestionOutcome: null, // Stores the resulting { team1, team2 } object\r\n\r\n        adminChecklist: {\r\n            arrival: [\r\n                { id: 'arrUnlockTuckshop', text: 'Unlock Tuckshop & Setup POS', checked: false },\r\n                { id: 'arrUnlockCloakrooms', text: 'Unlock Cloakrooms', checked: false }, // Added\r\n                { id: 'arrMainTv', text: 'Main TV: On & Sport Channel', checked: false },\r\n                { id: 'arrTuckshopTv', text: 'Tuckshop TV: On & Music Videos', checked: false },\r\n                { id: 'arrAmpAux', text: 'Amp: Aux Analog', checked: false }, // Mutually exclusive\r\n                { id: 'arrAmpOptical', text: 'Amp: Optical/Main TV', checked: false }, // Mutually exclusive\r\n                { id: 'arrOpenCurtains', text: 'Open Curtains & Sliding Door', checked: false },\r\n                { id: 'arrPutCushions', text: 'Put Out Bench Cushions', checked: false },\r\n                { id: 'arrSignOutBalls', text: 'Sign Out Social Balls (via Ball Mgmt)', checked: false },\r\n                { id: 'arrEmptyDishwasher', text: 'Empty Dishwasher & Check Dishes', checked: false },\r\n                { id: 'arrCheckFridge', text: 'Check Fridge for Expired Products', checked: false },\r\n                { id: 'arrEmptyBins', text: 'Empty Full Bins & Replace Liners', checked: false },\r\n                { id: 'arrManStation', text: 'Man Duty Station (Busy Times)', checked: false },\r\n                { id: 'arrAssistApp', text: 'Assist Members with App', checked: false },\r\n                { id: 'arrRemindAccounts', text: 'Remind Members re: Tuck Shop Accounts', checked: false }\r\n            ],\r\n            departure: [\r\n                { id: 'depReturnBalls', text: 'Return Social Balls & Sign In (via Ball Mgmt)', checked: false },\r\n                { id: 'depCheckOutApp', text: 'Ensure All Players Checked Out on App', checked: false },\r\n                { id: 'depLoadDishes', text: 'Load/Wash Dishes', checked: false },\r\n                { id: 'depReturnCushions', text: 'Return Bench Cushions', checked: false },\r\n                { id: 'depTurnOffTvAmp', text: 'Turn Off TVs & Amp', checked: false },\r\n                { id: 'depWipeBar', text: 'Wipe Down Bar Counter', checked: false },\r\n                { id: 'depEmptyIceBucket', text: 'Empty & Wash Ice Bucket', checked: false },\r\n                { id: 'depWipeKitchen', text: 'Wipe Down Kitchen Counter', checked: false },\r\n                { id: 'depTrashOut', text: 'Take Inside Trash to Outside Bins', checked: false },\r\n                { id: 'depLockBarStore', text: 'Lock Bar & Storeroom', checked: false },\r\n                { id: 'depCloseCurtains', text: 'Close Sliding Door & Curtains', checked: false },\r\n                { id: 'depLockClubhouseAlarm', text: 'Lock Clubhouse & Set Alarm', checked: false },\r\n                { id: 'depLockCloakrooms', text: 'Lock Cloakrooms', checked: false }, // Added\r\n                { id: 'depLockGates', text: 'Check & Lock Pedestrian Gates', checked: false }\r\n            ]\r\n        },\r\n\r\n    checklistHistory: [], // NEW: { date: 'YYYY-MM-DD', checklist: { arrival: [...], departure: [...] } }\r\n    selectedChecklistHistoryDate: null, // NEW\r\n\r\n        onDuty: 'None',\r\n        selectedAlertSound: 'Alert1.mp3', // Default sound\r\n        // NEW NOTIFICATION CONTROL STATES\r\n        notificationControls: {\r\n            isMuted: false,        // Mute All Sounds\r\n            isMinimized: false,    // Minimize Notifications (Only initial alert)\r\n            isTTSDisabled: false,   // Turn Off Speech Only\r\n            autoMinimize: true    // <-- ADD THIS NEW LINE\r\n        },\r\n        currentQuoteIndex: 0,\r\n        currentAlertCount: 0, // <-- ADD THIS NEW LINE\r\n        tennisQuotes: [\r\n            \"You only live once, but you get to serve twice.\", \"Tennis is a perfect combination of violent action taking place in an atmosphere of total tranquility.\",\r\n            \"The serve is the only shot you have 100% control over.\", \"Losing is not my enemy, fear of losing is my enemy.\",\r\n            \"My motto is: I'm alive, so I have to live it.\", \"Tennis uses the language of life. Advantage, service, fault, break, love.\",\r\n            \"It's one-on-one out there, man. There ain't no hiding.\", \"The fifth set is not about tennis, it's about nerves.\",\r\n            \"What is the single most important quality in a tennis champion? I would have to say desire.\", \"Success is a journey, not a destination.\",\r\n            \"If you can keep your head when all about you are losing theirs, it's just possible you haven't grasped the situation.\", \"I fear no one, but I respect everyone.\",\r\n            \"Tennis is mostly mental. You win or lose the match before you even go out there.\", \"A champion is afraid of losing. Everyone else is afraid of winning.\",\r\n            \"The difference between involvement and commitment is like ham and eggs. The chicken is involved; the pig is committed.\", \"You've got to get to the stage in life where going for it is more important than winning or losing.\",\r\n            \"I'm not the best, but I'm capable of beating the best on any given day.\", \"When you do something best in life, you don't really want to give that up.\",\r\n            \"The mark of a great champion is to be able to win when you are not playing your best.\", \"Every point is a new opportunity.\",\r\n            \"Just go out there and do what you have to do.\", \"Tennis is a game of inches. And sometimes, those inches are in your head.\",\r\n            \"It’s not whether you get knocked down, it’s whether you get up.\", \"Hard work beats talent when talent doesn't work hard.\",\r\n            \"Don't practice until you get it right. Practice until you can't get it wrong.\", \"Play each point like your life depends on it.\",\r\n            \"Champions keep playing until they get it right.\", \"I never look back, I look forward.\",\r\n            \"The harder the battle, the sweeter the victory.\", \"You are never a loser until you quit trying.\",\r\n            \"To be a great champion you must believe you are the best. If you are not, pretend you are.\", \"The pain you feel today will be the strength you feel tomorrow.\",\r\n            \"If it doesn’t challenge you, it won’t change you.\", \"Victory is sweetest when you’ve known defeat.\",\r\n            \"What seems hard now will one day be your warm-up.\", \"I've failed over and over and over again in my life. And that is why I succeed.\",\r\n            \"Tennis is life.\", \"Keep calm and play tennis.\",\r\n            \"Tennis: the only place where love means nothing.\", \"I play each point as if it were the last point of the match.\",\r\n            \"Never give up on a dream just because of the time it will take to accomplish it.\", \"It's not the will to win that matters—everyone has that. It's the will to prepare to win that matters.\",\r\n            \"Pressure is a privilege.\", \"One point at a time.\",\r\n            \"Control the controllables.\", \"Tennis requires agility, mental and physical.\",\r\n            \"My backhand is my weapon.\", \"A perfect volley is a work of art.\",\r\n            \"There's no place like the court.\", \"Tennis is a dance between two players.\"\r\n        ],\r\n        // NEW ADMIN COURT MANAGEMENT STATE\r\n        adminCourtManagement: {\r\n            mode: 'card1_select_court', // card1_select_court, card2_remove_players, card3_add_players\r\n            courtId: null,\r\n            // The list of players currently on court (Card 2) after initialization, excluding temporary removals.\r\n            currentCourtPlayers: [], \r\n            // Players marked for removal from the court on Card 2 (will go to bottom of queue on confirm)\r\n            removedPlayers: [], \r\n            // Players selected to be added to the court on Card 3 (consumed from available queue on confirm)\r\n            addedPlayers: [] \r\n        },\r\n        // NEW LIGHT MANAGEMENT STATE (Local RPC Method)\r\n        lightSettings: {\r\n            shellyBaseUrl: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch', // Keep this for local fallback base\r\n            shellyAuthKey: 'MzEyNDRhdWlk4A2C89A1B41C12C193A1BF0978CB3C8D7891CD751D3C578EDA094C05D1DB4E618708AE34BCD86240', // Store your actual auth key here\r\n            courts: {\r\n                'A': { id: 'A', label: 'Court A Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.0.15', shellyCloudId: 'YOUR_COURT_A_CLOUD_ID', toggleAfter: 0 }, // Replace placeholder\r\n                'B': { id: 'B', label: 'Court B Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.0.147', shellyCloudId: 'YOUR_COURT_B_CLOUD_ID', toggleAfter: 0 }, // Replace placeholder\r\n                'C': { id: 'C', label: 'Court C Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.0.130', shellyCloudId: 'YOUR_COURT_C_CLOUD_ID', toggleAfter: 0 }, // Replace placeholder\r\n                'D': { id: 'D', label: 'Court D Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.0.179', shellyCloudId: 'YOUR_COURT_D_CLOUD_ID', toggleAfter: 0 }, // Replace placeholder\r\n                // Court E for testing - Use its actual Cloud ID\r\n                'E': { id: 'E', label: 'Court E Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.88.74', shellyCloudId: '2cbcbb2fb26c' } // Use the actual Cloud ID here\r\n            },\r\n            general: {\r\n                'clubhouse': { id: 'clubhouse', label: 'Clubhouse Lights', isManaged: true, isActive: false, shellyDeviceId: '192.168.0.100', shellyCloudId: 'YOUR_CLUBHOUSE_CLOUD_ID' } // Replace placeholder\r\n            }\r\n        },\r\n\r\n        gateSettings: {\r\n            pedestrian: {\r\n                label: 'Pedestrian Gate',\r\n                shellyCloudId: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch',  // Device ID for cloud\r\n                shellyDeviceId: '',  // Local IP\r\n                isManaged: false,\r\n                toggleAfter: 1  // 1 second pulse\r\n            },\r\n            parking: {\r\n                label: 'Parking Lot Gate',\r\n                shellyCloudId: 'https://shelly-180-eu.shelly.cloud/v2/devices/api/set/switch',  // Device ID for cloud\r\n                shellyDeviceId: '',  // Local IP\r\n                isManaged: false,\r\n                toggleAfter: 1  // 1 second pulse\r\n            }\r\n        },  \r\n\r\n        manualEntry: {\r\n            players: [], // Holds names of players selected for manual entry\r\n        },       \r\n\r\n        // NEW BALL MANAGEMENT STATE (ADD THIS BLOCK - Updated to CANS)\r\n        ballManagement: {\r\n            stock: 0, // Total number of CANS\r\n            usedStock: 0, // Total number of USED individual balls\r\n            // History logs the member, category, and number of CANS.\r\n            history: [], // { timestamp, action: 'in' | 'out', category: 'purchase' | 'league' | 'sale', count: CANS, member: name }\r\n            historyFilter: 'all',\r\n            \r\n            // NEW: Temporary state for multi-step sale flow\r\n            tempSale: {\r\n                stockType: null, // 'cans' or 'singles'\r\n                memberSignOut: null, // Name of the committee member who signed out\r\n                purchaserName: null, // Name of the final purchaser\r\n            }\r\n        }\r\n    };\r\n\r\n    // Drag & Drop State\r\n    let draggedPlayer = null;\r\n    let draggedFromCourt = null;\r\n    let draggedPlayerPosition = null;\r\n    let dragOverTarget = null;\r\n    let activeDraggablePlayer = null; // Track which player is currently enabled for dragging\r\n\r\n    // Track long-press state\r\n    let gateButtonPressTimer = null;\r\n    let gateButtonIsLongPress = false;\r\n\r\n    // ============================================================================\r\n    // COURT LIGHT LONG-PRESS SETUP\r\n    // ============================================================================\r\n\r\n    let lightIconPressTimer = null;\r\n    let lightIconIsLongPress = false;\r\n\r\n    // Undo system - separate from state because functions can't be serialized\r\n    let currentUndoAction = null;\r\n    let currentUndoTimeout = null;\r\n    let localChangeInProgress = false; // Prevent WebSocket from overwriting local changes\r\n    //NEW SLIDE HEADER\r\n    // --- HEADER & TIME OVERLAY SLIDE-DOWN FUNCTIONALITY ---\r\n    let headerTimeout = null;\r\n    const header = document.querySelector('header');\r\n    const timeOverlay = document.getElementById('time-overlay');\r\n    const headerPullTab = document.getElementById('header-pull-tab');\r\n    let touchStartY = 0;\r\n    let isDragging = false;\r\n    let lastScrollY = 0;\r\n    //NEW PAUSE COOLDOWN TIMER\r\n    let cooldownTimerInterval = null;\r\n\r\n    // NEW/ADJUSTED STATE VARIABLES FOR ALERT SCHEDULING\r\n    let alertScheduleTime = 0; // Timestamp of the next alert fire time\r\n    let currentAudio = null; // Track the currently playing audio object\r\n    // Tracks the state of the alert cycle: 'initial_check' -> '2_min_countdown' -> '5_min_repeat'\r\n    let alertState = 'initial_check'; \r\n    // NEW: Announcement Queue System\r\n    let announcementQueue = [];\r\n    let isAnnouncementPlaying = false;\r\n    // NEW: Admin timer\r\n    let adminSessionActive = false; // NEW: Track admin login state\r\n    let adminSessionTimer = null;   // NEW: Timer for admin session timeout\r\n\r\n    // --- NEW: Screensaver Variables ---\r\n    let inactivityTimer = null;\r\n    let screensaverCycleInterval = null;\r\n    const INACTIVITY_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes\r\n    const SCREENSAVER_INTERVAL_MS = 15 * 1000; // 15 seconds per view (event or app)\r\n    let screensaverCurrentIndex = 0;\r\n    let isShowingScreensaverEvent = true; // Start by showing an event first\r\n    const screensaverOverlay = document.getElementById('screensaver-overlay');\r\n    const screensaverContent = document.getElementById('screensaver-content');\r\n    // --- END: Screensaver Variables ---\r\n\r\n    const ANNOUNCEMENT_GRACE_PERIOD_MS = 30 * 1000; // 30 seconds\r\n    const leaderboardConfirmModal = document.getElementById('leaderboard-confirm-modal');\r\n    const disclaimerModal = document.getElementById('disclaimer-modal');\r\n\r\n    // NEW ELEMENTS: Weather Modals\r\n    const currentWeatherModal = document.getElementById('current-weather-modal');\r\n    const detailedWeatherModal = document.getElementById('detailed-weather-modal');\r\n    // JUNIOR CLUB:\r\n    // --- NEW ELEMENTS: Junior Club Modals (Required for listeners and utility calls) ---\r\n    const juniorClubModal = document.getElementById('junior-club-modal');\r\n    const juniorClubList = document.getElementById('junior-club-list');\r\n    const juniorClubCloseBtn = document.getElementById('junior-club-close-btn');\r\n    const newParentBtn = document.getElementById('new-parent-btn');\r\n    const newParentModal = document.getElementById('new-parent-modal');\r\n    const newParentCancelBtn = document.getElementById('new-parent-cancel-btn');\r\n    const newParentConfirmBtn = document.getElementById('new-parent-confirm-btn');\r\n    const parentNameInput = document.getElementById('parent-name-input');\r\n    const parentSurnameInput = document.getElementById('parent-surname-input');\r\n    const childrenContainer = document.getElementById('children-container');\r\n    const addChildBtn = document.getElementById('add-child-btn');\r\n    const parentPhoneInput = document.getElementById('parent-phone-input'); // <-- NEW REFERENCE\r\n    parentPhoneInput.addEventListener('input', function(e) {\r\n        let value = e.target.value;\r\n        \r\n        // Remove leading zero if it's the first character\r\n        if (value.startsWith('0')) {\r\n            e.target.value = value.substring(1);\r\n        }\r\n    });\r\n    const parentEmailInput = document.getElementById('parent-email-input'); // <-- NEW EMAIL INPUT\r\n    const removeChildSelectionModal = document.getElementById('remove-child-selection-modal');\r\n    const childrenForRemovalList = document.getElementById('children-for-removal-list');\r\n    const removeChildSelectionBackBtn = document.getElementById('remove-child-selection-back-btn');\r\n    const removeChildSelectionConfirmBtn = document.getElementById('remove-child-selection-confirm-btn');\r\n\r\n    const childSelectionModal = document.getElementById('child-selection-modal');\r\n    const childSelectionConfirmBtn = document.getElementById('child-selection-confirm-btn');\r\n    const childSelectionBackBtn = document.getElementById('child-selection-back-btn');\r\n    const attendingChildrenList = document.getElementById('attending-children-list');\r\n\r\n    const juniorClubHistoryBtn = document.getElementById('junior-club-history-btn');\r\n    const juniorClubStatsModal = document.getElementById('junior-club-stats-modal');\r\n    const juniorClubHistoryList = document.getElementById('junior-club-history-list');\r\n    const juniorClubStatsBackBtn = document.getElementById('junior-club-stats-back-btn');\r\n    const juniorClubStatsDetailsBtn = document.getElementById('junior-club-stats-details-btn');\r\n    const juniorClubDetailModal = document.getElementById('junior-club-detail-modal');\r\n    const detailCloseBtn = document.getElementById('detail-close-btn');\r\n    const detailTogglePaidBtn = document.getElementById('detail-toggle-paid-btn');\r\n    const juniorClubBtn = document.getElementById('junior-club-btn');\r\n    // NEW: Reference to the filter group element\r\n    const juniorClubNameFilterGroup = document.getElementById('junior-club-name-filter-group');\r\n    const removeChildBtn = document.getElementById('remove-child-btn-main');\r\n\r\n    // --- NEW ELEMENTS FOR ROSTER MODAL ---\r\n    const juniorClubRosterBtn = document.getElementById('junior-club-roster-btn');\r\n    const juniorClubRosterModal = document.getElementById('junior-club-roster-modal');\r\n    const juniorClubRosterList = document.getElementById('junior-club-roster-list');\r\n    const rosterCloseBtn = document.getElementById('roster-close-btn');\r\n    const rosterTypeFilterGroup = document.getElementById('roster-type-filter-group'); // <-- NEW ELEMENT\r\n\r\n    // CRITICAL FIX: Add the missing gender filter element reference\r\n    const rosterGenderFilterGroup = document.getElementById('roster-gender-filter-group');\r\n\r\n    // TEMPORARY DUTY HANDOVER ELEMENTS\r\n    const tempDutyHandoverModal = document.getElementById('temp-duty-handover-modal');\r\n    const tempDutyHandoverList = document.getElementById('temp-duty-handover-list');\r\n    const tempDutyCurrentMember = document.getElementById('temp-duty-current-member');\r\n    const tempDutyCancelBtn = document.getElementById('temp-duty-cancel-btn');\r\n    const tempDutyConfirmBtn = document.getElementById('temp-duty-confirm-btn');\r\n\r\n    // NEW ELEMENTS FOR MANUAL GAME ENTRY\r\n    const manualEntryModal = document.getElementById('manual-entry-modal');\r\n    const manualPlayerList = document.getElementById('manual-player-list');\r\n    const manualEntryConfirmBtn = document.getElementById('manual-entry-confirm-btn');\r\n    const manualEntryCancelBtn = document.getElementById('manual-entry-cancel-btn');\r\n    const addOutsidePlayerBtn = document.getElementById('add-outside-player-btn');\r\n    const outsidePlayerModal = document.getElementById('outside-player-modal');\r\n    const outsidePlayerList = document.getElementById('outside-player-list');\r\n    const outsidePlayerBackBtn = document.getElementById('outside-player-back-btn');\r\n    // ADD THESE TWO LINES\r\n    const manualSelectedPlayersContainer = document.getElementById('manual-selected-players');\r\n    const outsideSelectedPlayersContainer = document.getElementById('outside-selected-players');\r\n    const outsidePlayerConfirmBtn = document.getElementById('outside-player-confirm-btn');\r\n    \r\n\r\n    // --- NEW ELEMENTS FOR ROSTER DETAIL MODAL ---\r\n    const rosterDetailModal = document.getElementById('roster-detail-modal');\r\n    const rosterDetailTitle = document.getElementById('roster-detail-title');\r\n    const rosterDetailContent = document.getElementById('roster-detail-content');\r\n    const rosterDetailCloseBtn = document.getElementById('roster-detail-close-btn');\r\n    // --- END NEW ELEMENTS ---\r\n    // --- DOM ELEMENTS ---\r\n    const headerClock = document.getElementById('header-clock');\r\n    const availablePlayersSection = document.getElementById('availablePlayersSection');\r\n    const availablePlayersList = document.getElementById('availablePlayersList');\r\n    const courtGrid = document.getElementById('court-grid');\r\n    const infoBar = document.getElementById('info-bar');\r\n    const infoBarText = document.getElementById('info-bar-text');\r\n    const modeDoublesBtn = document.getElementById('mode-doubles');\r\n    const modeSinglesBtn = document.getElementById('mode-singles');\r\n    const chooseTeamsModal = document.getElementById('choose-teams-modal');\r\n    const modalPlayerList = document.getElementById('modal-player-list');\r\n    const modalConfirmBtn = document.getElementById('modal-confirm-teams-btn');\r\n    const modalCancelBtn = document.getElementById('modal-cancel-btn');\r\n    const cancelConfirmModal = document.getElementById('cancel-confirm-modal');\r\n    const modalBtnYesConfirm = document.getElementById('modal-btn-yes-confirm');\r\n    const modalBtnNo = document.getElementById('modal-btn-no');\r\n    const checkInModal = document.getElementById('check-in-modal');\r\n    const checkInList = document.getElementById('check-in-list');\r\n    const checkInCancelBtn = document.getElementById('check-in-cancel-btn');\r\n    const checkInBtn = document.getElementById('checkInBtn');\r\n    const checkOutModal = document.getElementById('check-out-modal');\r\n    const checkOutList = document.getElementById('check-out-list');\r\n    const checkOutBtn = document.getElementById('checkOutBtn');\r\n    const checkOutCloseBtn = document.getElementById('check-out-cancel-btn');\r\n    const historyBtn = document.getElementById('historyBtn');\r\n    const historyPage = document.getElementById('history-page');\r\n    const historyList = document.getElementById('history-list');\r\n    const historyToggleViewBtn = document.getElementById('history-toggle-view');\r\n    const historyCloseBtn = document.getElementById('history-close-btn');\r\n    const endGameModal = document.getElementById('end-game-modal');\r\n    const endGameTeams = document.getElementById('end-game-teams');\r\n    const endGameConfirmBtn = document.getElementById('end-game-confirm-btn');\r\n    const endGameCancelBtn = document.getElementById('end-game-cancel-btn');\r\n    const tieBreakerArea = document.getElementById('tie-breaker-area');\r\n    const scoreSection = document.getElementById('score-section');\r\n    const winningScoreInput = document.getElementById('winning-score');\r\n    const losingScoreInput = document.getElementById('losing-score');\r\n    const winnerTiebreakInput = document.getElementById('winner-tiebreak');\r\n    const loserTiebreakInput = document.getElementById('loser-tiebreak');\r\n    const endGameTimestamp = document.getElementById('end-game-timestamp');\r\n\r\n    // NEW ELEMENTS: Style Editor\r\n    const editStylesBtn = document.getElementById('edit-styles-btn');\r\n    const editStylesModal = document.getElementById('edit-styles-modal');\r\n    const editStylesCloseBtn = document.getElementById('edit-styles-close-btn');\r\n    const fontSizeSlider = document.getElementById('font-size-slider');\r\n    \r\n    // KEYPAD ELEMENTS AND STATE\r\n    const customKeypadModal = document.getElementById('custom-keypad-modal');\r\n    const keypadDisplay = document.getElementById('keypad-display');\r\n    const keypadButtons = customKeypadModal.querySelectorAll('.keypad-btn');\r\n    const keypadConfirmBtn = document.getElementById('keypad-confirm-btn');\r\n    const keypadCancelBtn = document.getElementById('keypad-cancel-btn');\r\n    let activeInput = null;\r\n    let keypadConfig = {};\r\n\r\n    // GUEST/ALPHA KEYPAD ELEMENTS\r\n    const addGuestBtn = document.getElementById('add-guest-btn');\r\n    const guestNameModal = document.getElementById('guest-name-modal');\r\n    const guestNameInput = document.getElementById('guest-name-input');\r\n    const guestSurnameInput = document.getElementById('guest-surname-input');\r\n    const guestGenderRadios = document.querySelectorAll('input[name=\"guest-gender\"]');\r\n    const guestConfirmBtn = document.getElementById('guest-confirm-btn');\r\n    const guestCancelBtn = document.getElementById('guest-cancel-btn');\r\n    \r\n    const customAlphaKeypadModal = document.getElementById('custom-alpha-keypad-modal');\r\n    const alphaKeypadDisplay = document.getElementById('alpha-keypad-display');\r\n    const alphaKeypadGrid = document.getElementById('alpha-keypad-grid');\r\n    let activeAlphaInput = null;\r\n\r\n    // --- NEW GLOBAL KEYBOARD REFERENCES ---\r\n    const globalKeyboardModal = document.getElementById('global-keyboard-modal');\r\n    const globalKeyboardDisplay = document.getElementById('global-keyboard-display');\r\n    const globalKeyboardGrid = document.getElementById('global-keyboard-grid');\r\n    const emojiSearchInput = document.getElementById('emoji-search-input');\r\n    const emojiSearchContainer = document.getElementById('emoji-search-container');\r\n    let activeGlobalInput = null;\r\n    // --- END GLOBAL KEYBOARD REFERENCES ---\r\n\r\n    // --- GLOBAL KEYBOARD STATE ---\r\n    let globalKeyboardState = {\r\n        currentPage: 'LetterPad', // 'LetterPad', 'SymbolsP1', 'SymbolsP2', 'NumberPad', 'EmojiPage'\r\n        case: 'lower', // 'lower', 'upper', 'shift'\r\n        longPressTimer: null,\r\n    };\r\n    // --- END GLOBAL KEYBOARD STATE ---\r\n\r\n    // --- GLOBAL KEYBOARD DATA ---\r\n\r\n    // Keys are mapped to their display text or special action/page codes\r\n    const KEYBOARD_LAYOUTS = {\r\n        'LetterPad': [\r\n            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],\r\n            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],\r\n            ['SHIFT', 'z', 'x', 'c', 'v', 'b', 'n', 'm', 'BACK'],\r\n            ['?123', 'GLOBE', 'SPACE', ', / 😀', 'ENTER']\r\n        ],\r\n        'SymbolsP1': [\r\n            ['[', ']', '{', '}', '#', '%', '^', '*', '+', '='],\r\n            ['_', '\\\\', '|', '~', '<', '>', '€', '£', '¥', '•'],\r\n            ['ABC', '.', ',', '?', '!', \"'\", '\"', 'BACK'],\r\n            ['1234', 'GLOBE', 'SPACE', '!@#', 'ENTER']\r\n        ],\r\n        'SymbolsP2': [\r\n            ['`', '´', '¨', 'ç', 'ñ', 'æ', 'œ', 'ß', '÷', '¿'],\r\n            ['@', '$', '&', '/', '(', ')', '“', '”', '…', '®'],\r\n            ['ABC', '.', ',', '?', '!', \"'\", '\"', 'BACK'],\r\n            ['?123', 'GLOBE', 'SPACE', '!@#', 'ENTER'] // Note: ?123 maps to SymbolsP1\r\n        ],\r\n        'NumberPad': [ // REPLACED: Redefined to match calculator layout\r\n            // Row 0: %, 1, 2, 3, + (5 keys)\r\n            ['PERCENT', '1', '2', '3', '+'],\r\n            // Row 1: SPACE, 4, 5, 6, - (5 keys)\r\n            ['SPACE', '4', '5', '6', '-'],\r\n            // Row 2: BACK, 7, 8, 9, * (5 keys)\r\n            ['BACK', '7', '8', '9', '*'],\r\n            // Row 3: abc, comma, ?123, 0, =, period, return (7 keys)\r\n            ['ABC', 'COMMA', '?123', '0', '=', 'DOT', 'ENTER']\r\n        ]\r\n    };\r\n\r\n\r\n    const EMOJI_LIST = [\r\n        // This should be loaded dynamically, but for simplicity, use a sample array\r\n        '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '😉', '😌', '😍', '😘', '😗', '😙', '😚',\r\n        '😋', '😛', '😜', '🤪', '😝', '🤗', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '🤧', '😩', '😫',\r\n        '😤', '😡', '😠', '🤬', '😷', '🤒', '🤕', '🤢', '🤮', '🤯', '🥳', '😎', '🤓', '🧐', '😕', '😟', '🙁', '😮',\r\n        '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😰', '😥', '😢', '😭', '😱', '😖', '😩', '😫', '😴', '🤤', '😪',\r\n        // Add more emojis here...\r\n    ];\r\n    // --- END GLOBAL KEYBOARD DATA ---\r\n\r\n\r\n    // ADMIN MODAL ELEMENTS\r\n    const adminSettingsModal = document.getElementById('admin-settings-modal');\r\n    const committeeMemberList = document.getElementById('committee-member-list');\r\n    const courtAvailabilityList = document.getElementById('court-availability-list');\r\n    const adminCloseBtn = document.getElementById('admin-close-btn');\r\n    const reorderPlayersModal = document.getElementById('reorder-players-modal');\r\n    const reorderPlayersList = document.getElementById('reorder-players-list');\r\n    const reorderPlayersBtn = document.getElementById('reorder-players-btn');\r\n    const reorderSaveBtn = document.getElementById('reorder-save-btn');\r\n    const reorderCancelBtn = document.getElementById('reorder-cancel-btn');\r\n    const reorderLogModal = document.getElementById('reorder-log-modal');\r\n    const reorderHistoryList = document.getElementById('reorder-history-list');\r\n    const viewReorderLogBtn = document.getElementById('view-reorder-log-btn');\r\n    const reorderLogCloseBtn = document.getElementById('reorder-log-close-btn');\r\n    const reorderLogBackBtn = document.getElementById('reorder-log-back-btn'); // NEW ELEMENT\r\n    let tempPlayerOrder = [];\r\n\r\n    // SOUND SELECTION ELEMENTS\r\n    const selectSoundBtn = document.getElementById('select-sound-btn');\r\n    const soundSelectionModal = document.getElementById('sound-selection-modal');\r\n    const soundSelectionList = document.getElementById('sound-selection-list');\r\n    const soundConfirmBtn = document.getElementById('sound-confirm-btn');\r\n    const soundCancelBtn = document.getElementById('sound-cancel-btn');\r\n    const alertSounds = Array.from({ length: 17 }, (_, i) => `Alert${i + 1}.mp3`);\r\n    let tempSelectedSound = ''; // Temporary selection in the modal\r\n    \r\n    // NEW ELEMENTS: Notification Control Buttons\r\n    const muteBtn = document.getElementById('mute-btn');\r\n    const minimizeNotificationsBtn = document.getElementById('minimize-notifications-btn');\r\n    const noSpeechBtn = document.getElementById('no-speech-btn');\r\n    let alertStatusDisplay; \r\n\r\n    // NEW COURT MODE KEYPAD ELEMENTS\r\n    const courtModeKeypadModal = document.getElementById('court-mode-keypad-modal');\r\n    const courtModeKeypadDisplay = document.getElementById('court-mode-keypad-display');\r\n    const courtModeKeypadButtons = courtModeKeypadModal.querySelectorAll('.keypad-btn');\r\n    const courtModeKeypadConfirmBtn = document.getElementById('court-mode-keypad-confirm-btn');\r\n    const courtModeKeypadCancelBtn = document.getElementById('court-mode-keypad-cancel-btn');\r\n    let courtModeAction = null; // To store the action after PIN entry\r\n\r\n    // NEW ELEMENTS: Admin Court Player Management (REFACTORED)\r\n    const manageCourtPlayersBtn = document.getElementById('manage-court-players-btn');\r\n    const manageCourtPlayersModal = document.getElementById('manage-court-players-modal');\r\n    const courtListForManagement = document.getElementById('court-list-for-management'); // Card 1\r\n    const removePlayersList = document.getElementById('remove-players-list'); // Card 2 - Players currently on court\r\n    const addPlayersList = document.getElementById('add-players-list'); // Card 3 - Available players to add\r\n    const managePlayersCloseBtn = document.getElementById('manage-players-close-btn'); \r\n    const managePlayersBackBtn = document.getElementById('manage-players-back-btn');\r\n    const managePlayersAddBtn = document.getElementById('manage-players-add-btn'); \r\n    const managePlayersConfirmBtn = document.getElementById('manage-players-confirm-btn'); // Card 3 Confirm\r\n    // NEW: Reference to the modal-actions div for setting the data-card-mode\r\n    const manageModalActions = manageCourtPlayersModal.querySelector('.modal-actions'); \r\n\r\n    // NEW ELEMENTS CUSTOM ANNOUNCEMENTS\r\n    const customAnnouncementModal = document.getElementById('custom-announcement-modal');\r\n    const announcementList = document.getElementById('announcement-list');\r\n    const announcementSaveBtn = document.getElementById('announcement-save-btn');\r\n    const announcementCancelBtn = document.getElementById('announcement-cancel-btn');\r\n    const customAnnouncementBtn = document.getElementById('custom-announcement-btn');\r\n\r\n\r\n    // NEW ELEMENTS: Ball Management (ADD THIS BLOCK)\r\n    const ballManagementBtn = document.getElementById('ball-management-btn');\r\n    const ballManagementModal = document.getElementById('ball-management-modal');\r\n    const ballManagementCloseBtn = document.getElementById('ball-management-close-btn');\r\n    const ballStockCount = document.getElementById('ball-stock-count');\r\n    const usedBallStockCount = document.getElementById('used-ball-stock-count'); // <-- ADD THIS\r\n    const addStockBtn = document.getElementById('add-stock-btn');\r\n    const signOutOptions = document.getElementById('sign-out-options');\r\n    const signOutMemberModal = document.getElementById('sign-out-member-modal');\r\n    const signOutMemberList = document.getElementById('sign-out-member-list');\r\n    const signOutMemberConfirmBtn = document.getElementById('sign-out-member-confirm-btn');\r\n    const signOutMemberCancelBtn = document.getElementById('sign-out-member-cancel-btn');\r\n    const returnStockBtn = document.getElementById('return-stock-btn');\r\n    const returnUsedBallsBtn = document.getElementById('return-used-balls-btn'); // <-- ADD THIS\r\n    const ballHistoryBtn = document.getElementById('ball-history-btn');\r\n    const ballHistoryModal = document.getElementById('ball-history-modal');\r\n\r\n    // NEW ELEMENTS: Ball History Detail Modal\r\n    const ballHistoryDetailModal = document.getElementById('ball-history-detail-modal');\r\n    const ballDetailContent = document.getElementById('ball-detail-content');\r\n    const detailStockType = document.getElementById('detail-stock-type');\r\n    const detailCategory = document.getElementById('detail-category');\r\n    const detailDatetime = document.getElementById('detail-datetime');\r\n    const detailCount = document.getElementById('detail-count');\r\n    const detailCommitteeMember = document.getElementById('detail-committee-member');\r\n    const detailPurchaser = document.getElementById('detail-purchaser');\r\n    const detailStockBefore = document.getElementById('detail-stock-before');\r\n    const detailStockChange = document.getElementById('detail-stock-change');\r\n    const detailStockAfter = document.getElementById('detail-stock-after');\r\n    const ballDetailCloseBtn = document.getElementById('ball-detail-close-btn');  \r\n\r\n    // --- NEW ELEMENTS FOR BALL SALES FLOW ---\r\n    const ballSaleTypeModal = document.getElementById('ball-sale-type-modal');\r\n    const saleTypeCansBtn = document.getElementById('sale-type-cans-btn');\r\n    const saleTypeSinglesBtn = document.getElementById('sale-type-singles-btn');\r\n    const saleTypeCancelBtn = document.getElementById('sale-type-cancel-btn');\r\n    const purchaserSelectionModal = document.getElementById('purchaser-selection-modal');\r\n    const purchaserMemberList = document.getElementById('purchaser-member-list');\r\n    const purchaserSelectionPrompt = document.getElementById('purchaser-selection-prompt');\r\n\r\n    const ballHistoryList = document.getElementById('ball-history-list');\r\n    const ballHistoryCloseBtn = document.getElementById('ball-history-close-btn'); \r\n    const signOutMemberPrompt = document.getElementById('sign-out-member-prompt');\r\n\r\n    const cooldownModal = document.getElementById('cooldown-modal');\r\n    const cooldownTimer = document.getElementById('cooldown-timer');\r\n    const cooldownCloseBtn = document.getElementById('cooldown-close-btn');\r\n\r\n    // NEW: Comparison Modal Elements\r\n    const comparisonModal = document.getElementById('comparison-modal');\r\n    const comparisonTitle = document.getElementById('comparison-title');\r\n    const comparisonContent = document.getElementById('comparison-content');\r\n    const comparisonFilterContainer = document.getElementById('comparison-filter-container');\r\n    const comparisonCloseBtn = document.getElementById('comparison-close-btn');\r\n\r\n    // NEW: Powerscore modal elements\r\n    const powerScoreModal = document.getElementById('power-score-modal');\r\n    const powerScoreList = document.getElementById('power-score-list');\r\n    const powerScoreBtn = document.getElementById('power-score-btn');\r\n    const powerScoreCloseBtn = document.getElementById('power-score-close-btn');\r\n\r\n\r\n    // NEW ELEMENTS: Suggestion Settings Modal\r\n    const suggestionSettingsBtn = document.getElementById('suggestion-settings-btn');\r\n    const suggestionSettingsModal = document.getElementById('suggestion-settings-modal');\r\n    const suggestionSettingsCloseBtn = document.getElementById('suggestion-settings-close-btn');\r\n    const femaleRatioSlider = document.getElementById('female-ratio-slider');\r\n    const femaleRatioDisplay = document.getElementById('female-ratio-display');\r\n    const maleRatioSlider = document.getElementById('male-ratio-slider');\r\n    const maleRatioDisplay = document.getElementById('male-ratio-display');\r\n    const leastPlaytimeToggle = document.getElementById('least-playtime-toggle');\r\n    const powerScoreOnlyToggle = document.getElementById('power-score-only-toggle');\r\n    const topPlayerSlider = document.getElementById('top-player-slider');\r\n    const topPlayerDisplay = document.getElementById('top-player-display');\r\n    const frequentOpponentSlider = document.getElementById('frequent-opponent-slider');\r\n    const frequentOpponentDisplay = document.getElementById('frequent-opponent-display');\r\n    const weakPlayerSlider = document.getElementById('weak-player-slider');\r\n    const weakPlayerDisplay = document.getElementById('weak-player-display');\r\n    // References to new containers for disabling\r\n    const topPlayerContainer = document.querySelector('.top-player-container');\r\n    const frequentOpponentContainer = document.querySelector('.frequent-opponent-container');\r\n    const weakPlayerContainer = document.querySelector('.weak-player-container');\r\n\r\n    // NEW ELEMENTS: Admin Checklist Modal\r\n    const checklistBtn = document.getElementById('checklist-btn');\r\n    const checklistModal = document.getElementById('checklist-modal');\r\n    const checklistList = document.getElementById('checklist-list');\r\n    const checklistCloseBtn = document.getElementById('checklist-close-btn');\r\n    const checklistContent = document.getElementById('checklist-content'); // New container\r\n    const checklistHistoryBtn = document.getElementById('checklist-history-btn');\r\n    const checklistHistoryModal = document.getElementById('checklist-history-modal');\r\n    const checklistHistoryListView = document.getElementById('checklist-history-list-view');\r\n    const checklistHistoryDetailView = document.getElementById('checklist-history-detail-view');\r\n    const checklistHistoryList = document.getElementById('checklist-history-list');\r\n    const checklistHistoryDetail = document.getElementById('checklist-history-detail');\r\n    const checklistHistoryTitle = document.getElementById('checklist-history-title');\r\n    const checklistDetailDate = document.getElementById('checklist-detail-date');\r\n    const checklistHistoryBackBtn = document.getElementById('checklist-history-back-btn');\r\n    const checklistHistoryCloseBtn = document.getElementById('checklist-history-close-btn');\r\n    \r\n    // References to the container elements for fade effect\r\n    const leastPlaytimeContainer = document.querySelector('.least-playtime-toggle-container');\r\n    const femaleRatioContainer = document.querySelector('.female-ratio-container');\r\n    const maleRatioContainer = document.querySelector('.male-ratio-container');\r\n\r\n\r\n\r\n    // --- SLIDE DOWN HEADER ---\r\n    // Auto-hide header (and time overlay) after 3 seconds of no interaction\r\n\r\n        function hideHeader() {\r\n            if (window.innerWidth > 900) return; // <-- ADD THIS LINE\r\n            header.classList.add('header-hidden');\r\n            timeOverlay.classList.add('header-hidden'); // Add this line\r\n            clearTimeout(headerTimeout);\r\n        }\r\n\r\n        function startHeaderHideTimer() {\r\n            if (window.innerWidth > 900) return; // <-- ADD THIS LINE\r\n            clearTimeout(headerTimeout);\r\n            headerTimeout = setTimeout(hideHeader, 3000); // Correctly calls the function\r\n        }\r\n\r\n        // Show header (and time overlay)\r\n        function showHeader() {\r\n            if (window.innerWidth > 900) return; // <-- ADD THIS LINE\r\n            header.classList.remove('header-hidden');\r\n            timeOverlay.classList.remove('header-hidden'); // Add this line\r\n            startHeaderHideTimer();\r\n        }\r\n\r\n\r\n\r\n    // Handle scroll to show/hide header\r\n    let ticking = false;\r\n    function handleScroll() {\r\n        if (!ticking) {\r\n            window.requestAnimationFrame(() => {\r\n                const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;\r\n                \r\n                // Scrolling up - show header\r\n                if (currentScrollY < lastScrollY) {\r\n                    showHeader();\r\n                }\r\n                // Scrolling down - hide header (after delay)\r\n                else if (currentScrollY > lastScrollY && currentScrollY > 100) {\r\n                    clearTimeout(headerTimeout);\r\n                    headerTimeout = setTimeout(hideHeader, 1000); // Correctly calls the function\r\n                }\r\n                \r\n                lastScrollY = currentScrollY;\r\n                ticking = false;\r\n            });\r\n            ticking = true;\r\n        }\r\n    }\r\n\r\n    // Touch/drag functionality for mobile\r\n    function handleTouchStart(e) {\r\n        touchStartY = e.touches[0].clientY;\r\n        isDragging = true;\r\n    }\r\n\r\n    function handleTouchMove(e) {\r\n        if (!isDragging) return;\r\n        \r\n        const touchY = e.touches[0].clientY;\r\n        const deltaY = touchY - touchStartY;\r\n        \r\n        // Dragging down from top - show header\r\n        if (deltaY > 50 && touchStartY < 50) {\r\n            showHeader();\r\n            isDragging = false;\r\n        }\r\n    }\r\n\r\n    function handleTouchEnd() {\r\n        isDragging = false;\r\n    }\r\n\r\n    // Mouse drag functionality for desktop\r\n    let mouseStartY = 0;\r\n    let isMouseDragging = false;\r\n\r\n    function handleMouseDown(e) {\r\n        mouseStartY = e.clientY;\r\n        isMouseDragging = true;\r\n    }\r\n\r\n    function handleMouseMove(e) {\r\n        if (!isMouseDragging) return;\r\n        \r\n        const mouseY = e.clientY;\r\n        const deltaY = mouseY - mouseStartY;\r\n        \r\n        // Dragging down from top - show header\r\n        if (deltaY > 50 && mouseStartY < 50) {\r\n            showHeader();\r\n            isMouseDragging = false;\r\n        }\r\n    }\r\n\r\n    function handleMouseUp() {\r\n        isMouseDragging = false;\r\n    }\r\n\r\n    // Pull tab click\r\n    if (headerPullTab) {\r\n        headerPullTab.addEventListener('click', showHeader);\r\n    }\r\n\r\n    // Header mouse enter - keep visible\r\n    if (header) {\r\n        header.addEventListener('mouseenter', () => {\r\n            clearTimeout(headerTimeout);\r\n            header.classList.remove('header-hidden');\r\n        });\r\n        \r\n        header.addEventListener('mouseleave', startHeaderHideTimer);\r\n    }\r\n\r\n    // Time overlay mouse enter - keep visible\r\n    if (timeOverlay) {\r\n        timeOverlay.addEventListener('mouseenter', () => {\r\n            clearTimeout(headerTimeout);\r\n            header.classList.remove('header-hidden');\r\n        });\r\n        \r\n        timeOverlay.addEventListener('mouseleave', startHeaderHideTimer);\r\n    } \r\n\r\n    // --- NEW: DRAG-TO-SCROLL FOR HORIZONTAL COURT LIST ---\r\n    const scrollContainer = document.getElementById('courtsSection');\r\n\r\n    if (scrollContainer) {\r\n        let isDown = false;\r\n        let startX;\r\n        let scrollLeft;\r\n\r\n        // Mouse Events for Desktop\r\n        scrollContainer.addEventListener('mousedown', (e) => {\r\n            isDown = true;\r\n            scrollContainer.style.cursor = 'grabbing';\r\n            startX = e.pageX - scrollContainer.offsetLeft;\r\n            scrollLeft = scrollContainer.scrollLeft;\r\n        });\r\n\r\n        scrollContainer.addEventListener('mouseleave', () => {\r\n            isDown = false;\r\n            scrollContainer.style.cursor = 'grab';\r\n        });\r\n\r\n        scrollContainer.addEventListener('mouseup', () => {\r\n            isDown = false;\r\n            scrollContainer.style.cursor = 'grab';\r\n        });\r\n\r\n        scrollContainer.addEventListener('mousemove', (e) => {\r\n            if (!isDown) return;\r\n            e.preventDefault();\r\n            const x = e.pageX - scrollContainer.offsetLeft;\r\n            const walk = (x - startX) * 2; // The multiplier '2' makes the scroll faster\r\n            scrollContainer.scrollLeft = scrollLeft - walk;\r\n        });\r\n\r\n        // Touch Events for Mobile\r\n        scrollContainer.addEventListener('touchstart', (e) => {\r\n            isDown = true;\r\n            startX = e.touches[0].pageX - scrollContainer.offsetLeft;\r\n            scrollLeft = scrollContainer.scrollLeft;\r\n        }, { passive: true }); // Use passive listener for better scroll performance\r\n\r\n        scrollContainer.addEventListener('touchend', () => {\r\n            isDown = false;\r\n        });\r\n\r\n        scrollContainer.addEventListener('touchmove', (e) => {\r\n            if (!isDown) return;\r\n            const x = e.touches[0].pageX - scrollContainer.offsetLeft;\r\n            const walk = (x - startX) * 2;\r\n            scrollContainer.scrollLeft = scrollLeft - walk;\r\n        }, { passive: true });\r\n    }\r\n\r\n    function setActiveMobileMenuItem(buttonId) {\r\n        if (window.innerWidth > 900) return; // Only on mobile\r\n        \r\n        document.querySelectorAll('.mobile-menu-btn').forEach(btn => {\r\n            btn.classList.remove('active');\r\n        });\r\n        \r\n        const activeBtn = document.getElementById(buttonId);\r\n        if (activeBtn) {\r\n            activeBtn.classList.add('active');\r\n        }\r\n    }\r\n\r\n\r\n    // --- MODIFIED: ACTIVE CARD STYLING ON HORIZONTAL SCROLL ---\r\n    const scrollSnapContainer = document.getElementById('courtsSection');\r\n    if (scrollSnapContainer) {\r\n        let scrollTimeout;\r\n\r\n        // Set the active card on initial load\r\n        setTimeout(setActiveCardForMobileScroll, 200); \r\n\r\n        scrollSnapContainer.addEventListener('scroll', () => {\r\n            clearTimeout(scrollTimeout);\r\n            // Run the logic only after the user has stopped scrolling (snapped to a card)\r\n            scrollTimeout = setTimeout(setActiveCardForMobileScroll, 150);\r\n        });\r\n    }\r\n\r\n    // --- NEW: REUSABLE FUNCTION TO SET THE ACTIVE SCROLLING CARD ---\r\n        function setActiveCardForMobileScroll() {\r\n            const scrollSnapContainer = document.getElementById('courtsSection');\r\n            if (!scrollSnapContainer) return;\r\n\r\n            // Check if the screen is in mobile view (where this feature is active)\r\n            if (window.innerWidth >= 900) {\r\n                // On desktop, ensure all cards are reset to their normal state\r\n                const cards = scrollSnapContainer.querySelectorAll('.summary-card, .court-card');\r\n                cards.forEach(card => card.classList.remove('is-active-card'));\r\n                return;\r\n            }\r\n\r\n            const containerRect = scrollSnapContainer.getBoundingClientRect();\r\n            const containerCenter = containerRect.left + containerRect.width / 2;\r\n            \r\n            let closestCard = null;\r\n            let minDistance = Infinity;\r\n\r\n            const cards = scrollSnapContainer.querySelectorAll('.summary-card, .court-card');\r\n            cards.forEach(card => {\r\n                const cardRect = card.getBoundingClientRect();\r\n                const cardCenter = cardRect.left + cardRect.width / 2;\r\n                const distance = Math.abs(containerCenter - cardCenter);\r\n\r\n                if (distance < minDistance) {\r\n                    minDistance = distance;\r\n                    closestCard = card;\r\n                }\r\n            });\r\n            \r\n            if (closestCard) {\r\n                // Remove active class from all other cards\r\n                cards.forEach(card => card.classList.remove('is-active-card'));\r\n                \r\n                // Add active class to the new card\r\n                closestCard.classList.add('is-active-card');\r\n            }\r\n        }\r\n\r\n    // --- NEW FUNCTION: Scrolls to the first available court ---\r\n    function scrollToFirstAvailableCourt() {\r\n        // Only run this logic on mobile view where horizontal scrolling is active\r\n        if (window.innerWidth >= 900) {\r\n            return;\r\n        }\r\n\r\n        const courtId = findNextAvailableCourtId(); // Uses your existing hierarchy logic\r\n        if (courtId) {\r\n            const courtCard = document.querySelector(`.court-card[data-court-id=\"${courtId}\"]`);\r\n            if (courtCard) {\r\n                // Smoothly scroll the found court card to the center of the view\r\n                courtCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    function scrollToSummaryCard() {\r\n        // Only run this logic on mobile view\r\n        if (window.innerWidth < 900) {\r\n            const summaryCard = document.querySelector('.summary-card');\r\n            if (summaryCard) {\r\n                // Smoothly scroll the summary card to the start of the view\r\n                summaryCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- NEW FUNCTION: Automatically expands the player list on mobile ---\r\n    function expandPlayerListOnMobile() {\r\n        // Only run this logic on mobile view if the list is currently collapsed\r\n        if (window.innerWidth < 900 && !state.mobileControls.isPlayersExpanded) {\r\n            state.mobileControls.isPlayersExpanded = true; // Update the state\r\n\r\n            // Directly manipulate the DOM to trigger the expansion\r\n            const playersSection = document.getElementById('availablePlayersSection');\r\n            const playersToggleIcon = document.querySelector('#players-toggle-btn i');\r\n\r\n            if (playersSection) {\r\n                playersSection.classList.remove('is-collapsed');\r\n            }\r\n            if (playersToggleIcon) {\r\n                playersToggleIcon.className = 'mdi mdi-chevron-up';\r\n            }\r\n            saveState(); // Save the new expanded state\r\n        }\r\n    }\r\n\r\n    // --- NEW FUNCTION: Automatically collapses the player list on mobile when selection is complete ---\r\n    function collapsePlayerListOnMobile() {\r\n        // Only run this logic on mobile view\r\n        if (window.innerWidth < 900 && state.mobileControls.isPlayersExpanded) {\r\n            state.mobileControls.isPlayersExpanded = false; // Update the state\r\n            \r\n            // Directly manipulate the DOM to trigger the collapse\r\n            const playersSection = document.getElementById('availablePlayersSection');\r\n            const playersToggleIcon = document.querySelector('#players-toggle-btn i');\r\n            \r\n            if (playersSection) {\r\n                playersSection.classList.add('is-collapsed');\r\n            }\r\n            if (playersToggleIcon) {\r\n                playersToggleIcon.className = 'mdi mdi-chevron-down';\r\n            }\r\n            saveState(); // Save the new collapsed state\r\n        }\r\n    }\r\n\r\n    // --- NEW: Central function to enforce all queue logic (Duty & Gender) ---\r\n    function enforceQueueLogic() {\r\n        if (state.availablePlayers.length < 2) {\r\n            return; // Not enough players for any logic to apply.\r\n        }\r\n\r\n        const players = state.availablePlayers;\r\n\r\n        // --- PART 1: On-Duty Member Logic (Existing Logic) ---\r\n        if (state.onDuty !== 'None') {\r\n            const firstActiveIndex = players.findIndex(p => !p.isPaused);\r\n            if (firstActiveIndex !== -1 && players[firstActiveIndex].name === state.onDuty) {\r\n                const targetSwapIndex = players.findIndex((p, index) => \r\n                    index > firstActiveIndex && !p.isPaused && p.name !== state.onDuty\r\n                );\r\n                if (targetSwapIndex !== -1) {\r\n                    // Perform the swap\r\n                    [players[firstActiveIndex], players[targetSwapIndex]] = [players[targetSwapIndex], players[firstActiveIndex]];\r\n                }\r\n            }\r\n        }\r\n\r\n        // --- PART 2: Gender Balancing Logic (New & Improved Logic) ---\r\n        const selectorPlayer = players.find(p => !p.isPaused);\r\n        if (!selectorPlayer) return; // No active selector\r\n\r\n        const selectableGroupBaseSize = 7;\r\n        const selectorIndex = players.indexOf(selectorPlayer);\r\n\r\n        // Check if there are enough players after the selector to form a group\r\n        if ((players.length - 1 - selectorIndex) >= selectableGroupBaseSize) {\r\n            const playersAfterSelector = players.slice(selectorIndex + 1);\r\n            const availableInSelectableRange = playersAfterSelector.filter(p => !p.isPaused).slice(0, selectableGroupBaseSize);\r\n            \r\n            const sameGenderCountInRange = availableInSelectableRange.filter(p => p.gender === selectorPlayer.gender).length;\r\n\r\n            // IF a gender imbalance is detected (0 or 1 same-gender players in the next 7)...\r\n            if (sameGenderCountInRange <= 1) {\r\n                const endOfRangeIndex = players.indexOf(availableInSelectableRange[availableInSelectableRange.length - 1]);\r\n                \r\n                // Search for the next available, non-paused, same-gender player *after* the current selection box\r\n                const searchPool = players.slice(endOfRangeIndex + 1);\r\n                const nextSuitablePlayerIndexInPool = searchPool.findIndex(p => p.gender === selectorPlayer.gender && !p.isPaused);\r\n\r\n                if (nextSuitablePlayerIndexInPool !== -1) {\r\n                    // We found a player to move!\r\n                    const originalIndexOfPlayerToMove = endOfRangeIndex + 1 + nextSuitablePlayerIndexInPool;\r\n                    const [playerToMove] = players.splice(originalIndexOfPlayerToMove, 1);\r\n\r\n                    // Insert them at the end of the orange selection box (position #8, which is index 7 relative to the selector)\r\n                    const insertionIndex = Math.min(selectorIndex + 1 + selectableGroupBaseSize, players.length);\r\n                    players.splice(insertionIndex, 0, playerToMove);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    // --- DYNAMIC HEIGHT FUNCTION ---\r\n    function setPlayerListHeight() {\r\n        const courtGridEl = document.getElementById('court-grid');\r\n        const referenceCard = courtGridEl.querySelector('.court-card, .summary-card');\r\n        const courtGridStyles = window.getComputedStyle(courtGridEl);\r\n        // Determine the number of columns currently being used by the grid.\r\n        const courtColumnCount = courtGridStyles.gridTemplateColumns.split(' ').length;\r\n        \r\n        // If no reference card is found, or if the layout is stacked (1 column or fewer than 2), \r\n        // set height to auto and exit.\r\n        if (!referenceCard || courtColumnCount < 2) {\r\n            availablePlayersSection.style.height = 'auto';\r\n            return;\r\n        }\r\n\r\n        // Measure the actual height of the court grid container.\r\n        // This accurately captures the total space of all cards + gaps now that CSS forces equal rows.\r\n        const totalHeight = courtGridEl.offsetHeight; \r\n        \r\n        // Set the available players section height to match.\r\n        availablePlayersSection.style.height = `${totalHeight}px`;\r\n    }\r\n\r\n    // --- CORE FUNCTIONS ---\r\n    function getAllKnownPlayers() { const playersOnCourt = state.courts.flatMap(court => court.players); const allPlayers = [ ...state.clubMembers, ...state.availablePlayers, ...playersOnCourt ]; const uniquePlayers = Array.from(new Map(allPlayers.map(p => [p.name, p])).values()); state.gameHistory.forEach(game => { [...game.teams.team1, ...game.teams.team2].forEach(name => { if (!uniquePlayers.some(p => p.name === name)) { uniquePlayers.push({ name: name, gender: '?', guest: true }); } }); }); return uniquePlayers; }\r\n\r\n    function getPlayerRank(playerName, playerGender) {\r\n        const todaysGames = state.gameHistory.filter(game => {\r\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\r\n            return gameDate === new Date().toISOString().split('T')[0];\r\n        });\r\n        const allStats = calculatePlayerStats(todaysGames);\r\n        const allPlayers = getAllKnownPlayers();\r\n\r\n        const leaderboardPlayers = Object.keys(allStats)\r\n            .map(name => {\r\n                const player = allPlayers.find(p => p.name === name);\r\n                return {\r\n                    name,\r\n                    ...allStats[name],\r\n                    gender: player ? player.gender : '?',\r\n                    onLeaderboard: player ? player.onLeaderboard : false\r\n                };\r\n            })\r\n            .filter(p => p.onLeaderboard && p.gender === playerGender)\r\n            .sort((a, b) => {\r\n                const winPctA = a.played > 0 ? a.won / a.played : 0;\r\n                const winPctB = b.played > 0 ? b.won / b.played : 0;\r\n                if (winPctB !== winPctA) return winPctB - winPctA;\r\n                return b.totalDurationMs - a.totalDurationMs;\r\n            });\r\n\r\n        const rank = leaderboardPlayers.findIndex(p => p.name === playerName) + 1;\r\n        return rank > 0 ? rank : null;\r\n    }\r\n\r\n    function findBestAndWorstMatches(playerName) {\r\n        const todaysGames = state.gameHistory.filter(game => {\r\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\r\n            return gameDate === new Date().toISOString().split('T')[0];\r\n        });\r\n\r\n        const playerGames = todaysGames.filter(game =>\r\n            (game.teams.team1.includes(playerName) || game.teams.team2.includes(playerName)) && game.score\r\n        );\r\n\r\n        if (playerGames.length === 0) return { best: null, worst: null };\r\n\r\n        let bestMatch = { scoreDiff: -Infinity, text: '' };\r\n        let worstMatch = { scoreDiff: Infinity, text: '' };\r\n\r\n        playerGames.forEach(game => {\r\n            const isTeam1 = game.teams.team1.includes(playerName);\r\n            const playerScore = isTeam1 ? game.score.team1 : game.score.team2;\r\n            const opponentScore = isTeam1 ? game.score.team2 : game.score.team1;\r\n            const scoreDiff = playerScore - opponentScore;\r\n            const outcome = scoreDiff > 0 ? 'Won' : 'Lost';\r\n            const scoreText = `${outcome} ${playerScore}-${opponentScore}`;\r\n\r\n            if (scoreDiff > bestMatch.scoreDiff) {\r\n                bestMatch = { scoreDiff, text: scoreText };\r\n            }\r\n            if (scoreDiff < worstMatch.scoreDiff) {\r\n                worstMatch = { scoreDiff, text: scoreText };\r\n            }\r\n        });\r\n\r\n        return {\r\n            best: bestMatch.text,\r\n            worst: worstMatch.text\r\n        };\r\n    }\r\n    \r\n    /**\r\n     * Finds the opponent a player has played against most frequently.\r\n     * @param {string} playerName The name of the player.\r\n     * @param {Array} gameHistory The game history array.\r\n     * @returns {string|null} The name of the most frequent opponent, or null if none found.\r\n     */\r\n    function findFrequentOpponent(playerName, gameHistory) {\r\n        const opponentCounts = {};\r\n        let maxCount = 0;\r\n        let frequentOpponent = null;\r\n\r\n        gameHistory.forEach(game => {\r\n            // Skip skipped games or games without teams\r\n            if (game.winner === 'skipped' || !game.teams.team1 || !game.teams.team2) return;\r\n\r\n            const team1 = game.teams.team1;\r\n            const team2 = game.teams.team2;\r\n\r\n            let opponents = [];\r\n            if (team1.includes(playerName)) {\r\n                opponents = team2;\r\n            } else if (team2.includes(playerName)) {\r\n                opponents = team1;\r\n            }\r\n\r\n            opponents.forEach(opponentName => {\r\n                opponentCounts[opponentName] = (opponentCounts[opponentName] || 0) + 1;\r\n                if (opponentCounts[opponentName] > maxCount) {\r\n                    maxCount = opponentCounts[opponentName];\r\n                    frequentOpponent = opponentName;\r\n                }\r\n            });\r\n        });\r\n\r\n        // Require a minimum number of games against an opponent to consider them \"frequent\"\r\n        return maxCount >= 2 ? frequentOpponent : null;\r\n    }\r\n\r\n    /**\r\n     * Determines if a player is considered \"weak\" based on their power score.\r\n     * @param {number} playerScore The player's calculated power score.\r\n     * @param {number} threshold The power score threshold from settings.\r\n     * @returns {boolean} True if the player's score is below the threshold.\r\n     */\r\n    function isWeakPlayer(playerScore, threshold) {\r\n        return playerScore < threshold;\r\n    }\r\n\r\n    function getPlayerByName(name) { \r\n        let player = state.availablePlayers.find(p => p.name === name); \r\n        if (player) return player; \r\n        player = MASTER_MEMBER_LIST.find(p => p.name === name); \r\n        if (player) return player; \r\n        for (const court of state.courts) { \r\n            player = court.players.find(p => p.name === name); \r\n            if (player) return player; \r\n        } \r\n        return { name: name, gender: '?', guest: true, isPaused: false }; \r\n    }\r\n    function getPlayerNames(playerObjects) { return playerObjects.map(p => p.name); }\r\n    function totalPlayersAtClub(){ let total = state.availablePlayers.length; state.courts.forEach(court => { if (court.players) { total += court.players.length; } }); return total; }\r\n    // Helper function to count only active (non-paused) players\r\n    function getActivePlayerCount() {\r\n        return state.availablePlayers.filter(p => !p.isPaused).length;\r\n    }\r\n\r\n    // Modified to use API instead of localStorage\r\n    async function saveState() { \r\n        // Don't save if we're currently receiving an update from WebSocket\r\n        if (state._isReceivingUpdate) {\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            await API.saveState(state);\r\n            console.log('State saved to server');\r\n        } catch (error) {\r\n            console.error('Failed to save state:', error);\r\n        }\r\n    }\r\n\r\n    // ================================\r\n    // UNDO SYSTEM FUNCTIONS\r\n    // ================================\r\n    function showUndoToast(message, undoAction) {\r\n        const undoToast = document.getElementById('undo-toast');\r\n        const undoToastMessage = document.getElementById('undo-toast-message');\r\n        const undoToastBtn = document.getElementById('undo-toast-btn');\r\n        const undoToastTimer = document.getElementById('undo-toast-timer');\r\n        \r\n        // Clear any existing toast\r\n        hideUndoToast();\r\n        \r\n        // Set message\r\n        undoToastMessage.textContent = message;\r\n        \r\n        // Store the undo action OUTSIDE of state (functions can't be serialized)\r\n        currentUndoAction = undoAction;\r\n        \r\n        // Show toast\r\n        undoToast.classList.remove('hidden');\r\n        \r\n        // Reset timer animation\r\n        undoToastTimer.style.transition = 'none';\r\n        undoToastTimer.style.width = '100%';\r\n        setTimeout(() => {\r\n            undoToastTimer.style.transition = 'width 10s linear';\r\n            undoToastTimer.style.width = '0';\r\n        }, 50);\r\n        \r\n        // Auto-hide after 10 seconds\r\n        currentUndoTimeout = setTimeout(() => {\r\n            hideUndoToast();\r\n        }, 10000);\r\n        \r\n        // Attach undo handler\r\n        undoToastBtn.onclick = () => {\r\n            if (currentUndoAction && typeof currentUndoAction === 'function') {\r\n                currentUndoAction();\r\n                hideUndoToast();\r\n            }\r\n        };\r\n    }\r\n\r\n    function hideUndoToast() {\r\n        const undoToast = document.getElementById('undo-toast');\r\n        \r\n        if (currentUndoTimeout) {\r\n            clearTimeout(currentUndoTimeout);\r\n            currentUndoTimeout = null;\r\n        }\r\n        \r\n        undoToast.classList.add('hidden');\r\n        currentUndoAction = null;\r\n    }\r\n\r\n    function addToUndoHistory(actionType, actionData, undoFunction) {\r\n        const action = {\r\n            type: actionType,\r\n            data: actionData,\r\n            timestamp: Date.now(),\r\n            undo: undoFunction\r\n        };\r\n        \r\n        state.undoHistory.actions.unshift(action);\r\n        \r\n        // Keep only last N actions\r\n        if (state.undoHistory.actions.length > state.undoHistory.maxHistory) {\r\n            state.undoHistory.actions = state.undoHistory.actions.slice(0, state.undoHistory.maxHistory);\r\n        }\r\n        \r\n        saveState();\r\n    }\r\n\r\n    // ================================\r\n    // SWAP PLAYER MODAL FUNCTIONS\r\n    // ================================\r\n\r\n    function showSwapPlayerModal(sourceCourt) {\r\n        const court = state.courts.find(c => c.id === sourceCourt);\r\n        if (!court || court.status !== 'in_progress') return;\r\n        \r\n        const swapPlayerModal = document.getElementById('swap-player-modal');\r\n        const swapSourcePlayer = document.getElementById('swap-source-player');\r\n        const swapTargetList = document.getElementById('swap-target-list');\r\n        const swapInstructions = document.getElementById('swap-player-instructions');\r\n        \r\n        // Store source court in modal data\r\n        swapPlayerModal.dataset.sourceCourt = sourceCourt;\r\n        \r\n        // Show source court players\r\n        swapInstructions.textContent = `Select a player from Court ${sourceCourt} to swap:`;\r\n        swapSourcePlayer.innerHTML = '';\r\n        \r\n        court.players.forEach(player => {\r\n            const playerDiv = document.createElement('div');\r\n            playerDiv.className = 'swap-player-option';\r\n            playerDiv.innerHTML = `\r\n                <div class=\"player-info\">${player.name}</div>\r\n                <div class=\"court-info\">Court ${sourceCourt} • ${player.gender}</div>\r\n            `;\r\n            playerDiv.onclick = () => showSwapTargetSelection(sourceCourt, player);\r\n            playerDiv.style.cursor = 'pointer';\r\n            playerDiv.style.padding = '0.75rem';\r\n            playerDiv.style.margin = '0.5rem 0';\r\n            playerDiv.style.borderRadius = '6px';\r\n            playerDiv.style.transition = 'background-color 0.2s';\r\n            playerDiv.onmouseenter = () => playerDiv.style.backgroundColor = '#d0e7ff';\r\n            playerDiv.onmouseleave = () => playerDiv.style.backgroundColor = 'transparent';\r\n            \r\n            swapSourcePlayer.appendChild(playerDiv);\r\n        });\r\n        \r\n        // Hide the manage players modal\r\n        manageCourtPlayersModal.classList.add('hidden');\r\n        \r\n        // Show swap modal\r\n        swapPlayerModal.classList.remove('hidden');\r\n    }\r\n\r\n    function showSwapTargetSelection(sourceCourt, sourcePlayer) {\r\n        const swapPlayerModal = document.getElementById('swap-player-modal');\r\n        const swapSourcePlayer = document.getElementById('swap-source-player');\r\n        const swapTargetList = document.getElementById('swap-target-list');\r\n        const swapInstructions = document.getElementById('swap-player-instructions');\r\n        \r\n        // Update instructions\r\n        swapInstructions.textContent = `Swap ${sourcePlayer.name} with:`;\r\n        \r\n        // Show selected source player\r\n        swapSourcePlayer.innerHTML = `\r\n            <div class=\"player-info\">${sourcePlayer.name}</div>\r\n            <div class=\"court-info\">Court ${sourceCourt} • ${sourcePlayer.gender}</div>\r\n        `;\r\n        \r\n        // Store source player in modal data\r\n        swapPlayerModal.dataset.sourcePlayer = JSON.stringify(sourcePlayer);\r\n        \r\n        // Get all players from other in-progress courts\r\n        swapTargetList.innerHTML = '';\r\n        \r\n        const otherCourts = state.courts.filter(c => \r\n            c.id !== sourceCourt && \r\n            c.status === 'in_progress' && \r\n            c.players.length > 0\r\n        );\r\n        \r\n        if (otherCourts.length === 0) {\r\n            swapTargetList.innerHTML = '<li style=\"justify-content: center; color: var(--neutral-color);\">No other courts in progress</li>';\r\n            return;\r\n        }\r\n        \r\n        otherCourts.forEach(court => {\r\n            court.players.forEach(player => {\r\n                const li = document.createElement('li');\r\n                li.innerHTML = `\r\n                    <span class=\"player-name\">${player.name}</span>\r\n                    <span class=\"gender-label\">${player.gender}</span>\r\n                    <span class=\"court-label\">Court ${court.id}</span>\r\n                `;\r\n                li.onclick = () => confirmPlayerSwap(sourceCourt, sourcePlayer, court.id, player);\r\n                swapTargetList.appendChild(li);\r\n            });\r\n        });\r\n    }\r\n\r\n    function confirmPlayerSwap(sourceCourt, sourcePlayer, targetCourtId, targetPlayer) {\r\n        const swapConfirmModal = document.getElementById('swap-confirm-modal');\r\n        const swapConfirmDetails = document.getElementById('swap-confirm-details');\r\n        \r\n        // Store swap data\r\n        swapConfirmModal.dataset.swapData = JSON.stringify({\r\n            sourceCourt,\r\n            sourcePlayer,\r\n            targetCourt: targetCourtId,\r\n            targetPlayer\r\n        });\r\n        \r\n        // Show confirmation details\r\n        swapConfirmDetails.innerHTML = `\r\n            <div class=\"swap-row\">\r\n                <div class=\"player-card\">\r\n                    <div class=\"name\">${sourcePlayer.name}</div>\r\n                    <div class=\"court\">Court ${sourceCourt}</div>\r\n                </div>\r\n                <div class=\"swap-arrow\">⇄</div>\r\n                <div class=\"player-card\">\r\n                    <div class=\"name\">${targetPlayer.name}</div>\r\n                    <div class=\"court\">Court ${targetCourtId}</div>\r\n                </div>\r\n            </div>\r\n        `;\r\n        \r\n        // Hide swap player modal, show confirmation\r\n        document.getElementById('swap-player-modal').classList.add('hidden');\r\n        swapConfirmModal.classList.remove('hidden');\r\n    }\r\n\r\n    function executePlayerSwap() {\r\n        const swapConfirmModal = document.getElementById('swap-confirm-modal');\r\n        const swapData = JSON.parse(swapConfirmModal.dataset.swapData);\r\n        \r\n        const { sourceCourt, sourcePlayer, targetCourt, targetPlayer } = swapData;\r\n        \r\n        const sourceCourtObj = state.courts.find(c => c.id === sourceCourt);\r\n        const targetCourtObj = state.courts.find(c => c.id === targetCourt);\r\n        \r\n        if (!sourceCourtObj || !targetCourtObj) return;\r\n        \r\n        // Find player indices\r\n        const sourcePlayerIndex = sourceCourtObj.players.findIndex(p => p.name === sourcePlayer.name);\r\n        const targetPlayerIndex = targetCourtObj.players.findIndex(p => p.name === targetPlayer.name);\r\n        \r\n        if (sourcePlayerIndex === -1 || targetPlayerIndex === -1) return;\r\n        \r\n        // Store original state for undo\r\n        const originalSourcePlayers = JSON.parse(JSON.stringify(sourceCourtObj.players));\r\n        const originalTargetPlayers = JSON.parse(JSON.stringify(targetCourtObj.players));\r\n        const originalSourceTeams = JSON.parse(JSON.stringify(sourceCourtObj.teams));\r\n        const originalTargetTeams = JSON.parse(JSON.stringify(targetCourtObj.teams));\r\n        \r\n        // Perform the swap\r\n        const tempPlayer = sourceCourtObj.players[sourcePlayerIndex];\r\n        sourceCourtObj.players[sourcePlayerIndex] = targetCourtObj.players[targetPlayerIndex];\r\n        targetCourtObj.players[targetPlayerIndex] = tempPlayer;\r\n        \r\n        // Update teams if they are set\r\n        if (sourceCourtObj.teamsSet) {\r\n            updateTeamsAfterSwap(sourceCourtObj, sourcePlayer.name, targetPlayer.name);\r\n        }\r\n        if (targetCourtObj.teamsSet) {\r\n            updateTeamsAfterSwap(targetCourtObj, targetPlayer.name, sourcePlayer.name);\r\n        }\r\n        \r\n        // Create undo function\r\n        const undoFunction = () => {\r\n            console.log('=== EXECUTING UNDO ===');\r\n            \r\n            // Set flag to prevent WebSocket interference\r\n            localChangeInProgress = true;\r\n            \r\n            // Find the court fresh from state\r\n            const courtToRestore = state.courts.find(c => c.id === courtId);\r\n            if (!courtToRestore) {\r\n                console.error('Court not found for undo!');\r\n                localChangeInProgress = false;\r\n                return;\r\n            }\r\n            \r\n            console.log('Before restore:', JSON.parse(JSON.stringify(courtToRestore)));\r\n            console.log('Restoring to:', originalPlayers, originalTeams);\r\n            \r\n            // Restore the original state\r\n            courtToRestore.players = JSON.parse(JSON.stringify(originalPlayers));\r\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalTeams));\r\n            \r\n            console.log('After restore:', JSON.parse(JSON.stringify(courtToRestore)));\r\n            \r\n            render();\r\n            saveState();\r\n            \r\n            // Clear flag after a short delay to allow saveState to complete\r\n            setTimeout(() => {\r\n                localChangeInProgress = false;\r\n                console.log('Undo complete - flag cleared');\r\n            }, 500);\r\n        };\r\n        \r\n        // Add to undo history\r\n        addToUndoHistory('player_swap', swapData, undoFunction);\r\n        \r\n        // Show undo toast\r\n        showUndoToast(\r\n            `Swapped ${sourcePlayer.name} (Court ${sourceCourt}) ↔ ${targetPlayer.name} (Court ${targetCourt})`,\r\n            undoFunction\r\n        );\r\n        \r\n        // Close modals and update UI\r\n        swapConfirmModal.classList.add('hidden');\r\n        render();\r\n        saveState();\r\n    }\r\n\r\n    function updateTeamsAfterSwap(court, oldPlayerName, newPlayerName) {\r\n        // Find which team the old player was on and replace with new player\r\n        const team1Index = court.teams.team1.findIndex(p => p.name === oldPlayerName);\r\n        const team2Index = court.teams.team2.findIndex(p => p.name === oldPlayerName);\r\n        \r\n        const newPlayerObj = court.players.find(p => p.name === newPlayerName);\r\n        \r\n        if (team1Index !== -1) {\r\n            court.teams.team1[team1Index] = newPlayerObj;\r\n        } else if (team2Index !== -1) {\r\n            court.teams.team2[team2Index] = newPlayerObj;\r\n        }\r\n    }\r\n\r\n    // ================================\r\n    // DRAG & DROP HANDLER FUNCTIONS\r\n    // ================================\r\n\r\n    function handlePlayerDragStart(e) {\r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        if (!playerSpot) return;\r\n        \r\n        // Only allow drag if this player was double-clicked (enabled)\r\n        if (!playerSpot.classList.contains('drag-enabled')) {\r\n            e.preventDefault();\r\n            return;\r\n        }\r\n        \r\n        draggedPlayer = {\r\n            name: playerSpot.dataset.playerName,\r\n            courtId: playerSpot.dataset.courtId,\r\n            position: playerSpot.dataset.playerPos,\r\n            team: playerSpot.dataset.team || null\r\n        };\r\n        \r\n        playerSpot.classList.add('dragging');\r\n        \r\n        // Set drag data\r\n        e.dataTransfer.effectAllowed = 'move';\r\n        e.dataTransfer.setData('text/plain', draggedPlayer.name);\r\n        \r\n        // Make drag image semi-transparent\r\n        if (e.dataTransfer.setDragImage) {\r\n            const dragImage = playerSpot.cloneNode(true);\r\n            dragImage.style.opacity = '0.7';\r\n            document.body.appendChild(dragImage);\r\n            e.dataTransfer.setDragImage(dragImage, 0, 0);\r\n            setTimeout(() => document.body.removeChild(dragImage), 0);\r\n        }\r\n    }\r\n\r\n    function handlePlayerDoubleClick(e) {\r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        if (!playerSpot) return;\r\n        \r\n        // Clear any previously enabled player\r\n        document.querySelectorAll('.player-spot.drag-enabled').forEach(spot => {\r\n            spot.classList.remove('drag-enabled');\r\n        });\r\n        \r\n        // If clicking the same player that was already enabled, disable it\r\n        if (activeDraggablePlayer === playerSpot) {\r\n            activeDraggablePlayer = null;\r\n            return;\r\n        }\r\n        \r\n        // Enable this player for dragging\r\n        playerSpot.classList.add('drag-enabled');\r\n        activeDraggablePlayer = playerSpot;\r\n        \r\n        // Auto-disable after 10 seconds if not used\r\n        setTimeout(() => {\r\n            if (playerSpot.classList.contains('drag-enabled')) {\r\n                playerSpot.classList.remove('drag-enabled');\r\n                if (activeDraggablePlayer === playerSpot) {\r\n                    activeDraggablePlayer = null;\r\n                }\r\n            }\r\n        }, 10000);\r\n    }\r\n\r\n    function handlePlayerDragEnd(e) {\r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        if (playerSpot) {\r\n            playerSpot.classList.remove('dragging');\r\n            playerSpot.classList.remove('drag-enabled'); // Clear enabled state after drag\r\n        }\r\n        \r\n        // Clear all drag-over highlights\r\n        document.querySelectorAll('.drag-over, .drag-over-invalid').forEach(el => {\r\n            el.classList.remove('drag-over', 'drag-over-invalid');\r\n        });\r\n        \r\n        draggedPlayer = null;\r\n        dragOverTarget = null;\r\n        activeDraggablePlayer = null; // Clear active draggable\r\n    }\r\n\r\n    function handlePlayerDragOver(e) {\r\n        e.preventDefault(); // Allow drop\r\n        \r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\r\n        \r\n        if (!draggedPlayer) return;\r\n        \r\n        // --- SCENARIO 1: Dragging over another player on a court ---\r\n        if (playerSpot && playerSpot.dataset.playerName) {\r\n            const targetCourtId = playerSpot.dataset.courtId;\r\n            const targetPlayerName = playerSpot.dataset.playerName;\r\n            \r\n            // Don't allow dropping on self\r\n            if (targetPlayerName === draggedPlayer.name) {\r\n                e.dataTransfer.dropEffect = 'none';\r\n                return;\r\n            }\r\n            \r\n            const sameCourt = targetCourtId === draggedPlayer.courtId;\r\n            \r\n            if (sameCourt) {\r\n                // Team reselection within same court\r\n                playerSpot.classList.add('drag-over');\r\n                playerSpot.classList.remove('drag-over-invalid');\r\n                e.dataTransfer.dropEffect = 'move';\r\n            } else {\r\n                // Player swap between courts\r\n                const targetCourt = state.courts.find(c => c.id === targetCourtId);\r\n                const sourceCourt = state.courts.find(c => c.id === draggedPlayer.courtId);\r\n                \r\n                // Only allow if both courts are in_progress\r\n                if (targetCourt?.status === 'in_progress' && sourceCourt?.status === 'in_progress') {\r\n                    playerSpot.classList.add('drag-over');\r\n                    playerSpot.classList.remove('drag-over-invalid');\r\n                    e.dataTransfer.dropEffect = 'move';\r\n                } else {\r\n                    playerSpot.classList.add('drag-over-invalid');\r\n                    playerSpot.classList.remove('drag-over');\r\n                    e.dataTransfer.dropEffect = 'none';\r\n                }\r\n            }\r\n            \r\n            dragOverTarget = playerSpot;\r\n        }\r\n        // --- SCENARIO 2: Dragging over available player (substitution) ---\r\n        else if (availablePlayerLi && !availablePlayerLi.classList.contains('waiting-message')) {\r\n            const targetPlayerName = availablePlayerLi.dataset.playerName;\r\n            \r\n            // Don't allow if dragging from available to available\r\n            if (!draggedPlayer.courtId) {\r\n                availablePlayerLi.classList.add('drag-over-invalid');\r\n                e.dataTransfer.dropEffect = 'none';\r\n                return;\r\n            }\r\n            \r\n            // Check if court is in_progress\r\n            const sourceCourt = state.courts.find(c => c.id === draggedPlayer.courtId);\r\n            if (sourceCourt?.status === 'in_progress') {\r\n                availablePlayerLi.classList.add('drag-over');\r\n                availablePlayerLi.classList.remove('drag-over-invalid');\r\n                e.dataTransfer.dropEffect = 'move';\r\n            } else {\r\n                availablePlayerLi.classList.add('drag-over-invalid');\r\n                availablePlayerLi.classList.remove('drag-over');\r\n                e.dataTransfer.dropEffect = 'none';\r\n            }\r\n            \r\n            dragOverTarget = availablePlayerLi;\r\n        }\r\n    }\r\n\r\n    function handlePlayerDragLeave(e) {\r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\r\n        \r\n        if (playerSpot) {\r\n            playerSpot.classList.remove('drag-over', 'drag-over-invalid');\r\n        }\r\n        if (availablePlayerLi) {\r\n            availablePlayerLi.classList.remove('drag-over', 'drag-over-invalid');\r\n        }\r\n    }\r\n\r\n    function handlePlayerDrop(e) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        \r\n        if (!draggedPlayer) return;\r\n        \r\n        const playerSpot = e.target.closest('.player-spot[draggable=\"true\"]');\r\n        const availablePlayerLi = e.target.closest('#availablePlayersList li');\r\n        \r\n        // Clear highlights\r\n        document.querySelectorAll('.drag-over, .drag-over-invalid').forEach(el => {\r\n            el.classList.remove('drag-over', 'drag-over-invalid');\r\n        });\r\n        \r\n        // --- SCENARIO 1: Dropped on another player on a court ---\r\n        if (playerSpot && playerSpot.dataset.playerName) {\r\n            const targetCourtId = playerSpot.dataset.courtId;\r\n            const targetPlayerName = playerSpot.dataset.playerName;\r\n            const sameCourt = targetCourtId === draggedPlayer.courtId;\r\n            \r\n            if (targetPlayerName === draggedPlayer.name) return; // Same player\r\n            \r\n            if (sameCourt) {\r\n                // Team reselection - swap positions within same court\r\n                executeTeamReselectionSwap(draggedPlayer.courtId, draggedPlayer.name, targetPlayerName);\r\n            } else {\r\n                // Player swap between different courts\r\n                const targetCourt = state.courts.find(c => c.id === targetCourtId);\r\n                const sourceCourt = state.courts.find(c => c.id === draggedPlayer.courtId);\r\n                \r\n                if (targetCourt?.status === 'in_progress' && sourceCourt?.status === 'in_progress') {\r\n                    executePlayerSwapBetweenCourts(draggedPlayer.courtId, draggedPlayer.name, targetCourtId, targetPlayerName);\r\n                }\r\n            }\r\n        }\r\n        // --- SCENARIO 2: Dropped on available player (substitution) ---\r\n        else if (availablePlayerLi && !availablePlayerLi.classList.contains('waiting-message')) {\r\n            const targetPlayerName = availablePlayerLi.dataset.playerName;\r\n            const sourceCourt = state.courts.find(c => c.id === draggedPlayer.courtId);\r\n            \r\n            if (sourceCourt?.status === 'in_progress') {\r\n                executePlayerSubstitution(draggedPlayer.courtId, draggedPlayer.name, targetPlayerName);\r\n            }\r\n        }\r\n        \r\n        draggedPlayer = null;\r\n        dragOverTarget = null;\r\n    }\r\n\r\n    // ================================\r\n    // DRAG & DROP EXECUTION FUNCTIONS\r\n    // ================================\r\n\r\n    function executeTeamReselectionSwap(courtId, player1Name, player2Name) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court) return;\r\n        \r\n        // Store original state for undo\r\n        const originalPlayers = JSON.parse(JSON.stringify(court.players));\r\n        const originalTeams = JSON.parse(JSON.stringify(court.teams));\r\n        \r\n        // Find player indices\r\n        const player1Index = court.players.findIndex(p => p.name === player1Name);\r\n        const player2Index = court.players.findIndex(p => p.name === player2Name);\r\n        \r\n        if (player1Index === -1 || player2Index === -1) return;\r\n        \r\n        // Swap players in main array\r\n        const temp = court.players[player1Index];\r\n        court.players[player1Index] = court.players[player2Index];\r\n        court.players[player2Index] = temp;\r\n        \r\n        // Update teams if they're set\r\n        if (court.teamsSet) {\r\n            // Find which teams these players are on and swap them\r\n            let player1Team = null, player1TeamIndex = -1;\r\n            let player2Team = null, player2TeamIndex = -1;\r\n            \r\n            court.teams.team1.forEach((p, i) => {\r\n                if (p.name === player1Name) { player1Team = 'team1'; player1TeamIndex = i; }\r\n                if (p.name === player2Name) { player2Team = 'team1'; player2TeamIndex = i; }\r\n            });\r\n            \r\n            court.teams.team2.forEach((p, i) => {\r\n                if (p.name === player1Name) { player1Team = 'team2'; player1TeamIndex = i; }\r\n                if (p.name === player2Name) { player2Team = 'team2'; player2TeamIndex = i; }\r\n            });\r\n            \r\n            // Swap in teams\r\n            if (player1Team && player2Team) {\r\n                const p1 = court.teams[player1Team][player1TeamIndex];\r\n                const p2 = court.teams[player2Team][player2TeamIndex];\r\n                \r\n                court.teams[player1Team][player1TeamIndex] = p2;\r\n                court.teams[player2Team][player2TeamIndex] = p1;\r\n            }\r\n        }\r\n        \r\n        // Create undo function\r\n        const undoFunction = () => {\r\n            console.log('=== EXECUTING UNDO ===');\r\n            \r\n            // Set flag to prevent WebSocket interference\r\n            localChangeInProgress = true;\r\n            \r\n            // Find the court fresh from state\r\n            const courtToRestore = state.courts.find(c => c.id === courtId);\r\n            if (!courtToRestore) {\r\n                console.error('Court not found for undo!');\r\n                localChangeInProgress = false;\r\n                return;\r\n            }\r\n            \r\n            console.log('Before restore:', JSON.parse(JSON.stringify(courtToRestore)));\r\n            console.log('Restoring to:', originalPlayers, originalTeams);\r\n            \r\n            // Restore the original state\r\n            courtToRestore.players = JSON.parse(JSON.stringify(originalPlayers));\r\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalTeams));\r\n            \r\n            console.log('After restore:', JSON.parse(JSON.stringify(courtToRestore)));\r\n            \r\n            render();\r\n            saveState();\r\n            \r\n            // Clear flag after a short delay to allow saveState to complete\r\n            setTimeout(() => {\r\n                localChangeInProgress = false;\r\n                console.log('Undo complete - flag cleared');\r\n            }, 500);\r\n        };\r\n        \r\n        // Add to undo history\r\n        addToUndoHistory('team_reselection', { courtId, player1Name, player2Name }, undoFunction);\r\n        \r\n        // Show undo toast\r\n        showUndoToast(\r\n            `Swapped ${player1Name.split(' ')[0]} ↔ ${player2Name.split(' ')[0]} on Court ${courtId}`,\r\n            undoFunction\r\n        );\r\n        \r\n        render();\r\n        saveState();\r\n    }\r\n\r\n    function executePlayerSwapBetweenCourts(sourceCourtId, sourcePlayerName, targetCourtId, targetPlayerName) {\r\n        const sourceCourt = state.courts.find(c => c.id === sourceCourtId);\r\n        const targetCourt = state.courts.find(c => c.id === targetCourtId);\r\n        \r\n        if (!sourceCourt || !targetCourt) return;\r\n        \r\n        // Store original state for undo\r\n        const originalSourcePlayers = JSON.parse(JSON.stringify(sourceCourt.players));\r\n        const originalTargetPlayers = JSON.parse(JSON.stringify(targetCourt.players));\r\n        const originalSourceTeams = JSON.parse(JSON.stringify(sourceCourt.teams));\r\n        const originalTargetTeams = JSON.parse(JSON.stringify(targetCourt.teams));\r\n        \r\n        // Find player indices\r\n        const sourcePlayerIndex = sourceCourt.players.findIndex(p => p.name === sourcePlayerName);\r\n        const targetPlayerIndex = targetCourt.players.findIndex(p => p.name === targetPlayerName);\r\n        \r\n        if (sourcePlayerIndex === -1 || targetPlayerIndex === -1) return;\r\n        \r\n        // Perform the swap\r\n        const tempPlayer = sourceCourt.players[sourcePlayerIndex];\r\n        sourceCourt.players[sourcePlayerIndex] = targetCourt.players[targetPlayerIndex];\r\n        targetCourt.players[targetPlayerIndex] = tempPlayer;\r\n        \r\n        // Update teams if they are set\r\n        if (sourceCourt.teamsSet) {\r\n            updateTeamsAfterSwap(sourceCourt, sourcePlayerName, targetPlayerName);\r\n        }\r\n        if (targetCourt.teamsSet) {\r\n            updateTeamsAfterSwap(targetCourt, targetPlayerName, sourcePlayerName);\r\n        }\r\n        \r\n        // Create undo function\r\n        const undoFunction = () => {\r\n            console.log('=== EXECUTING UNDO - Court Swap ===');\r\n            \r\n            // Set flag to prevent WebSocket interference\r\n            localChangeInProgress = true;\r\n            \r\n            // Find both courts fresh from state\r\n            const sourceCourtToRestore = state.courts.find(c => c.id === sourceCourtId);\r\n            const targetCourtToRestore = state.courts.find(c => c.id === targetCourtId);\r\n            \r\n            if (!sourceCourtToRestore || !targetCourtToRestore) {\r\n                console.error('Courts not found for undo!');\r\n                localChangeInProgress = false;\r\n                return;\r\n            }\r\n            \r\n            console.log('Restoring source court:', sourceCourtId);\r\n            console.log('Restoring target court:', targetCourtId);\r\n            \r\n            // Restore the original state\r\n            sourceCourtToRestore.players = JSON.parse(JSON.stringify(originalSourcePlayers));\r\n            targetCourtToRestore.players = JSON.parse(JSON.stringify(originalTargetPlayers));\r\n            sourceCourtToRestore.teams = JSON.parse(JSON.stringify(originalSourceTeams));\r\n            targetCourtToRestore.teams = JSON.parse(JSON.stringify(originalTargetTeams));\r\n            \r\n            render();\r\n            saveState();\r\n            \r\n            // Clear flag after a short delay to allow saveState to complete\r\n            setTimeout(() => {\r\n                localChangeInProgress = false;\r\n                console.log('Undo complete - flag cleared');\r\n            }, 500);\r\n        };\r\n        \r\n        // Add to undo history\r\n        addToUndoHistory('court_swap', { sourceCourtId, sourcePlayerName, targetCourtId, targetPlayerName }, undoFunction);\r\n        \r\n        // Show undo toast\r\n        showUndoToast(\r\n            `Swapped ${sourcePlayerName.split(' ')[0]} (Court ${sourceCourtId}) ↔ ${targetPlayerName.split(' ')[0]} (Court ${targetCourtId})`,\r\n            undoFunction\r\n        );\r\n        \r\n        render();\r\n        saveState();\r\n    }\r\n\r\n    function executePlayerSubstitution(courtId, courtPlayerName, availablePlayerName) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court || court.status !== 'in_progress') return;\r\n        \r\n        // Find players\r\n        const courtPlayerIndex = court.players.findIndex(p => p.name === courtPlayerName);\r\n        const availablePlayer = state.availablePlayers.find(p => p.name === availablePlayerName);\r\n        const courtPlayer = court.players[courtPlayerIndex];\r\n        \r\n        if (courtPlayerIndex === -1 || !availablePlayer) return;\r\n        \r\n        // Store original state for undo\r\n        const originalCourtPlayers = JSON.parse(JSON.stringify(court.players));\r\n        const originalCourtTeams = JSON.parse(JSON.stringify(court.teams));\r\n        const originalAvailablePlayers = JSON.parse(JSON.stringify(state.availablePlayers));\r\n        \r\n        // Perform substitution\r\n        court.players[courtPlayerIndex] = availablePlayer;\r\n        \r\n        // Update teams if set\r\n        if (court.teamsSet) {\r\n            updateTeamsAfterSwap(court, courtPlayerName, availablePlayerName);\r\n        }\r\n        \r\n        // Update available players list\r\n        state.availablePlayers = state.availablePlayers.filter(p => p.name !== availablePlayerName);\r\n        state.availablePlayers.push(courtPlayer);\r\n        \r\n        // Create undo function\r\n        const undoFunction = () => {\r\n            console.log('=== EXECUTING UNDO - Substitution ===');\r\n            \r\n            // Set flag to prevent WebSocket interference\r\n            localChangeInProgress = true;\r\n            \r\n            // Find the court fresh from state\r\n            const courtToRestore = state.courts.find(c => c.id === courtId);\r\n            \r\n            if (!courtToRestore) {\r\n                console.error('Court not found for undo!');\r\n                localChangeInProgress = false;\r\n                return;\r\n            }\r\n            \r\n            console.log('Restoring court:', courtId);\r\n            \r\n            // Restore the original state\r\n            courtToRestore.players = JSON.parse(JSON.stringify(originalCourtPlayers));\r\n            courtToRestore.teams = JSON.parse(JSON.stringify(originalCourtTeams));\r\n            state.availablePlayers = JSON.parse(JSON.stringify(originalAvailablePlayers));\r\n            \r\n            render();\r\n            saveState();\r\n            \r\n            // Clear flag after a short delay to allow saveState to complete\r\n            setTimeout(() => {\r\n                localChangeInProgress = false;\r\n                console.log('Undo complete - flag cleared');\r\n            }, 500);\r\n        };\r\n                \r\n        // Add to undo history\r\n        addToUndoHistory('substitution', { courtId, courtPlayerName, availablePlayerName }, undoFunction);\r\n        \r\n        // Show undo toast\r\n        showUndoToast(\r\n            `Substituted ${courtPlayerName.split(' ')[0]} → ${availablePlayerName.split(' ')[0]} on Court ${courtId}`,\r\n            undoFunction\r\n        );\r\n        \r\n        render();\r\n        saveState();\r\n    }\r\n\r\n    // ================================\r\n    // UNDO HISTORY MODAL FUNCTIONS\r\n    // ================================\r\n\r\n    function showUndoHistoryModal() {\r\n        const undoHistoryModal = document.getElementById('undo-history-modal');\r\n        const undoHistoryList = document.getElementById('undo-history-list');\r\n        \r\n        undoHistoryList.innerHTML = '';\r\n        \r\n        if (state.undoHistory.actions.length === 0) {\r\n            const li = document.createElement('li');\r\n            li.className = 'empty-history';\r\n            li.textContent = 'No recent actions to undo';\r\n            undoHistoryList.appendChild(li);\r\n        } else {\r\n            state.undoHistory.actions.forEach((action, index) => {\r\n                const li = document.createElement('li');\r\n                \r\n                const actionDiv = document.createElement('div');\r\n                actionDiv.className = 'undo-history-action';\r\n                actionDiv.textContent = getActionDescription(action);\r\n                \r\n                const timestampDiv = document.createElement('div');\r\n                timestampDiv.className = 'undo-history-timestamp';\r\n                timestampDiv.textContent = getTimeAgo(action.timestamp);\r\n                \r\n                li.appendChild(actionDiv);\r\n                li.appendChild(timestampDiv);\r\n                \r\n                li.onclick = () => promptUndoWithPin(action, index);\r\n                \r\n                undoHistoryList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        adminSettingsModal.classList.add('hidden');\r\n        undoHistoryModal.classList.remove('hidden');\r\n    }\r\n\r\n    function getActionDescription(action) {\r\n        switch (action.type) {\r\n            case 'team_reselection':\r\n                return `Team Reselection: ${action.data.player1Name.split(' ')[0]} ↔ ${action.data.player2Name.split(' ')[0]} (Court ${action.data.courtId})`;\r\n            case 'court_swap':\r\n                return `Court Swap: ${action.data.sourcePlayerName.split(' ')[0]} (Court ${action.data.sourceCourtId}) ↔ ${action.data.targetPlayerName.split(' ')[0]} (Court ${action.data.targetCourtId})`;\r\n            case 'substitution':\r\n                return `Substitution: ${action.data.courtPlayerName.split(' ')[0]} → ${action.data.availablePlayerName.split(' ')[0]} (Court ${action.data.courtId})`;\r\n            case 'player_swap':\r\n                return `Player Swap: ${action.data.sourcePlayer.name.split(' ')[0]} (Court ${action.data.sourceCourt}) ↔ ${action.data.targetPlayer.name.split(' ')[0]} (Court ${action.data.targetCourt})`;\r\n            default:\r\n                return 'Unknown action';\r\n        }\r\n    }\r\n\r\n    function getTimeAgo(timestamp) {\r\n        const seconds = Math.floor((Date.now() - timestamp) / 1000);\r\n        \r\n        if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;\r\n        \r\n        const minutes = Math.floor(seconds / 60);\r\n        if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;\r\n        \r\n        const hours = Math.floor(minutes / 60);\r\n        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;\r\n    }\r\n\r\n    function promptUndoWithPin(action, actionIndex) {\r\n        // CRITICAL: Validate that undo is still safe to perform\r\n        const validationResult = validateUndoAction(action);\r\n        \r\n        if (!validationResult.isValid) {\r\n            alert(`Cannot undo this action:\\n\\n${validationResult.reason}\\n\\nThe game state has changed too much since this action occurred.`);\r\n            return;\r\n        }\r\n        \r\n        // Hide undo history modal\r\n        document.getElementById('undo-history-modal').classList.add('hidden');\r\n        \r\n        // Store the action index in a way the keypad system can access it\r\n        customKeypadModal.dataset.undoActionIndex = actionIndex;\r\n        customKeypadModal.dataset.undoActionDescription = getActionDescription(action);\r\n        \r\n        // Show the existing keypad in undo mode (no placeholder text)\r\n        showKeypad(null, { \r\n            mode: 'undo', \r\n            title: 'Enter Admin PIN to Undo' \r\n        });\r\n    }\r\n\r\n    function validateUndoAction(action) {\r\n        const { type, data } = action;\r\n        \r\n        // Check based on action type\r\n        switch (type) {\r\n            case 'team_reselection': {\r\n                const { courtId, player1Name, player2Name } = data;\r\n                const court = state.courts.find(c => c.id === courtId);\r\n                \r\n                // Court must still exist and be in progress\r\n                if (!court) {\r\n                    return { isValid: false, reason: 'Court no longer exists' };\r\n                }\r\n                if (court.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${courtId} game has ended` };\r\n                }\r\n                \r\n                // Both players must still be on this court\r\n                const hasPlayer1 = court.players.some(p => p.name === player1Name);\r\n                const hasPlayer2 = court.players.some(p => p.name === player2Name);\r\n                \r\n                if (!hasPlayer1 || !hasPlayer2) {\r\n                    return { isValid: false, reason: 'One or both players have left this court' };\r\n                }\r\n                \r\n                return { isValid: true };\r\n            }\r\n            \r\n            case 'court_swap': {\r\n                const { sourceCourtId, sourcePlayerName, targetCourtId, targetPlayerName } = data;\r\n                const sourceCourt = state.courts.find(c => c.id === sourceCourtId);\r\n                const targetCourt = state.courts.find(c => c.id === targetCourtId);\r\n                \r\n                // Both courts must still be in progress\r\n                if (!sourceCourt || sourceCourt.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${sourceCourtId} game has ended` };\r\n                }\r\n                if (!targetCourt || targetCourt.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${targetCourtId} game has ended` };\r\n                }\r\n                \r\n                // Both players must still be on their respective courts\r\n                const hasSourcePlayer = sourceCourt.players.some(p => p.name === sourcePlayerName);\r\n                const hasTargetPlayer = targetCourt.players.some(p => p.name === targetPlayerName);\r\n                \r\n                if (!hasSourcePlayer) {\r\n                    return { isValid: false, reason: `${sourcePlayerName.split(' ')[0]} is no longer on Court ${sourceCourtId}` };\r\n                }\r\n                if (!hasTargetPlayer) {\r\n                    return { isValid: false, reason: `${targetPlayerName.split(' ')[0]} is no longer on Court ${targetCourtId}` };\r\n                }\r\n                \r\n                return { isValid: true };\r\n            }\r\n            \r\n            case 'substitution': {\r\n                const { courtId, courtPlayerName, availablePlayerName } = data;\r\n                const court = state.courts.find(c => c.id === courtId);\r\n                \r\n                // Court must still be in progress\r\n                if (!court || court.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${courtId} game has ended` };\r\n                }\r\n                \r\n                // The substituted player must still be on the court\r\n                const hasSubstitutedPlayer = court.players.some(p => p.name === availablePlayerName);\r\n                \r\n                if (!hasSubstitutedPlayer) {\r\n                    return { isValid: false, reason: `${availablePlayerName.split(' ')[0]} is no longer on Court ${courtId}` };\r\n                }\r\n                \r\n                // The original player should be in available players or on another court\r\n                const originalPlayerAvailable = state.availablePlayers.some(p => p.name === courtPlayerName);\r\n                const originalPlayerOnOtherCourt = state.courts.some(c => \r\n                    c.id !== courtId && c.players.some(p => p.name === courtPlayerName)\r\n                );\r\n                \r\n                if (!originalPlayerAvailable && !originalPlayerOnOtherCourt) {\r\n                    return { isValid: false, reason: `${courtPlayerName.split(' ')[0]} has checked out` };\r\n                }\r\n                \r\n                return { isValid: true };\r\n            }\r\n            \r\n            case 'player_swap': {\r\n                // This is from the modal swap (not drag & drop)\r\n                const { sourceCourt, sourcePlayer, targetCourt, targetPlayer } = data;\r\n                const sourceCourtObj = state.courts.find(c => c.id === sourceCourt);\r\n                const targetCourtObj = state.courts.find(c => c.id === targetCourt);\r\n                \r\n                if (!sourceCourtObj || sourceCourtObj.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${sourceCourt} game has ended` };\r\n                }\r\n                if (!targetCourtObj || targetCourtObj.status !== 'in_progress') {\r\n                    return { isValid: false, reason: `Court ${targetCourt} game has ended` };\r\n                }\r\n                \r\n                const hasSourcePlayer = sourceCourtObj.players.some(p => p.name === sourcePlayer.name);\r\n                const hasTargetPlayer = targetCourtObj.players.some(p => p.name === targetPlayer.name);\r\n                \r\n                if (!hasSourcePlayer || !hasTargetPlayer) {\r\n                    return { isValid: false, reason: 'One or both players have moved to different courts' };\r\n                }\r\n                \r\n                return { isValid: true };\r\n            }\r\n            \r\n            default:\r\n                return { isValid: false, reason: 'Unknown action type' };\r\n        }\r\n    }\r\n\r\n    function executeUndoAction(actionIndex) {\r\n        // Get the action\r\n        const action = state.undoHistory.actions[actionIndex];\r\n        if (!action) return;\r\n        \r\n        // Set flag to prevent WebSocket interference\r\n        localChangeInProgress = true;\r\n        \r\n        // Execute undo\r\n        if (action.undo) {\r\n            action.undo();\r\n        }\r\n        \r\n        // Remove from history\r\n        state.undoHistory.actions.splice(actionIndex, 1);\r\n        saveState();\r\n        \r\n        // Clean up modal data\r\n        delete customKeypadModal.dataset.context;\r\n        delete customKeypadModal.dataset.actionIndex;\r\n        delete customKeypadModal.dataset.actionDescription;\r\n        \r\n        // Clear flag after a short delay to allow saveState to complete\r\n        setTimeout(() => {\r\n            localChangeInProgress = false;\r\n        }, 500);\r\n        \r\n        // Show success message\r\n        showUndoToast('Action undone successfully', null);\r\n    }\r\n\r\n// COMPLETE CORRECTED loadState FUNCTION\r\n    async function loadState(MASTER_MEMBER_LIST) {\r\n        try {\r\n            const loaded = await API.loadState();\r\n\r\n            if (loaded) {\r\n                // Merge loaded announcement state with default\r\n                if (loaded.customAnnouncementState) {\r\n                    loaded.customAnnouncementState = { ...state.customAnnouncementState, ...loaded.customAnnouncementState };\r\n                }\r\n\r\n                // Perform the general merge first\r\n                state = { ...state, ...loaded };\r\n\r\n                // FIX: Reinitialize courts if loaded array is empty\r\n                if (!state.courts || state.courts.length === 0) {\r\n                    console.log(\"Empty courts array detected, reinitializing courts...\");\r\n                    state.courts = [\r\n                        { id: 'A', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n                        { id: 'B', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n                        { id: 'C', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n                        { id: 'D', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' },\r\n                        { id: 'E', status: 'available', players: [], teams: { team1: [], team2: [] }, autoStartTimer: null, gameMode: null, gameStartTime: null, autoStartTimeTarget: null, becameAvailableAt: Date.now(), isCollapsed: false, isModeOverlayActive: false, courtMode: 'doubles' }\r\n                    ];\r\n                }\r\n\r\n                // Check and fix adminChecklist structure if outdated\r\n                if (typeof state.adminChecklist !== 'object' || !Array.isArray(state.adminChecklist.arrival)) {\r\n                    console.warn(\"Outdated adminChecklist structure found. Resetting to default.\");\r\n                    state.adminChecklist = {\r\n                        arrival: [\r\n                            { id: 'arrUnlockTuckshop', text: 'Unlock Tuckshop & Setup POS', checked: false },\r\n                            { id: 'arrUnlockCloakrooms', text: 'Unlock Cloakrooms', checked: false },\r\n                            { id: 'arrMainTv', text: 'Main TV: On & Sport Channel', checked: false },\r\n                            { id: 'arrTuckshopTv', text: 'Tuckshop TV: On & Music Videos', checked: false },\r\n                            { id: 'arrAmpAux', text: 'Amp: Aux Analog', checked: false },\r\n                            { id: 'arrAmpOptical', text: 'Amp: Optical/Main TV', checked: false },\r\n                            { id: 'arrOpenCurtains', text: 'Open Curtains & Sliding Door', checked: false },\r\n                            { id: 'arrPutCushions', text: 'Put Out Bench Cushions', checked: false },\r\n                            { id: 'arrSignOutBalls', text: 'Sign Out Social Balls (via Ball Mgmt)', checked: false },\r\n                            { id: 'arrEmptyDishwasher', text: 'Empty Dishwasher & Check Dishes', checked: false },\r\n                            { id: 'arrCheckFridge', text: 'Check Fridge for Expired Products', checked: false },\r\n                            { id: 'arrEmptyBins', text: 'Empty Full Bins & Replace Liners', checked: false },\r\n                            { id: 'arrManStation', text: 'Man Duty Station (Busy Times)', checked: false },\r\n                            { id: 'arrAssistApp', text: 'Assist Members with App', checked: false },\r\n                            { id: 'arrRemindAccounts', text: 'Remind Members re: Tuck Shop Accounts', checked: false }\r\n                        ],\r\n                        departure: [\r\n                            { id: 'depReturnBalls', text: 'Return Social Balls & Sign In (via Ball Mgmt)', checked: false },\r\n                            { id: 'depCheckOutApp', text: 'Ensure All Players Checked Out on App', checked: false },\r\n                            { id: 'depLoadDishes', text: 'Load/Wash Dishes', checked: false },\r\n                            { id: 'depReturnCushions', text: 'Return Bench Cushions', checked: false },\r\n                            { id: 'depTurnOffTvAmp', text: 'Turn Off TVs & Amp', checked: false },\r\n                            { id: 'depWipeBar', text: 'Wipe Down Bar Counter', checked: false },\r\n                            { id: 'depEmptyIceBucket', text: 'Empty & Wash Ice Bucket', checked: false },\r\n                            { id: 'depWipeKitchen', text: 'Wipe Down Kitchen Counter', checked: false },\r\n                            { id: 'depTrashOut', text: 'Take Inside Trash to Outside Bins', checked: false },\r\n                            { id: 'depLockBarStore', text: 'Lock Bar & Storeroom', checked: false },\r\n                            { id: 'depCloseCurtains', text: 'Close Sliding Door & Curtains', checked: false },\r\n                            { id: 'depLockClubhouseAlarm', text: 'Lock Clubhouse & Set Alarm', checked: false },\r\n                            { id: 'depLockCloakrooms', text: 'Lock Cloakrooms', checked: false },\r\n                            { id: 'depLockGates', text: 'Check & Lock Pedestrian Gates', checked: false }\r\n                        ]\r\n                    };\r\n                }\r\n\r\n                // Ensure uiSettings and its properties exist\r\n                if (!state.uiSettings) {\r\n                    state.uiSettings = { fontSizeMultiplier: 1.0, displaySizeMultiplier: 1.0 };\r\n                } else {\r\n                    if (state.uiSettings.displaySizeMultiplier === undefined) state.uiSettings.displaySizeMultiplier = 1.0;\r\n                    if (state.uiSettings.fontSizeMultiplier === undefined) state.uiSettings.fontSizeMultiplier = 1.0; // Ensure font multiplier exists\r\n                }\r\n\r\n                // Ensure courtSettings and its properties exist\r\n                if (!state.courtSettings) {\r\n                    state.courtSettings = { visibleCourts: ['A', 'B', 'C', 'D', 'E'], autoAssignModes: true, showGameModeSelector: false };\r\n                } else {\r\n                     if (state.courtSettings.autoAssignModes === undefined) state.courtSettings.autoAssignModes = true;\r\n                     if (state.courtSettings.showGameModeSelector === undefined) state.courtSettings.showGameModeSelector = false;\r\n                     if (!Array.isArray(state.courtSettings.visibleCourts)) state.courtSettings.visibleCourts = ['A', 'B', 'C', 'D', 'E']; // Ensure visibleCourts is an array\r\n                }\r\n\r\n                // Ensure matchSettings and its properties exist\r\n                if (!state.matchSettings) {\r\n                    state.matchSettings = { matchMode: '1set', fastPlayGames: 4, autoMatchModes: true };\r\n                } else {\r\n                     if (state.matchSettings.autoMatchModes === undefined) state.matchSettings.autoMatchModes = true;\r\n                     if (state.matchSettings.matchMode === undefined) state.matchSettings.matchMode = '1set';\r\n                     if (state.matchSettings.fastPlayGames === undefined) state.matchSettings.fastPlayGames = 4;\r\n                }\r\n\r\n                 // Ensure juniorClub and its nested properties exist\r\n                 if (!state.juniorClub) {\r\n                     state.juniorClub = { parents: [], activeChildren: [], history: [], statsFilter: { parent: 'all', paid: 'all' }, rosterFilter: { sortKey: 'name', sortOrder: 'asc', type: 'all' }, checkInFilter: { displayMode: 'parent' }, registrationFlow: { parentCollapsed: false, childrenExpanded: false } };\r\n                 } else {\r\n                     if (!state.juniorClub.checkInFilter) state.juniorClub.checkInFilter = { displayMode: 'parent' };\r\n                     if (!state.juniorClub.rosterFilter) state.juniorClub.rosterFilter = { sortKey: 'name', sortOrder: 'asc', type: 'all' };\r\n                     if (!state.juniorClub.registrationFlow) state.juniorClub.registrationFlow = { parentCollapsed: false, childrenExpanded: false };\r\n                     if (!state.juniorClub.statsFilter) state.juniorClub.statsFilter = { parent: 'all', paid: 'all' };\r\n                     else if (state.juniorClub.statsFilter.paid === undefined) state.juniorClub.statsFilter.paid = 'all';\r\n                 }\r\n\r\n                state.gameHistory = state.gameHistory || [];\r\n                state.reorderHistory = state.reorderHistory || [];\r\n                state.guestHistory = state.guestHistory || [];\r\n\r\n                state.statsFilter = state.statsFilter || { gender: 'all', teamGender: 'all', sortKey: 'totalDurationMs', sortOrder: 'desc' };\r\n                 if (state.statsFilter.teamGender === undefined) state.statsFilter.teamGender = 'all';\r\n\r\n                state.selectedAlertSound = state.selectedAlertSound || 'Alert1.mp3';\r\n\r\n                if (!state.mobileControls) state.mobileControls = { isSummaryExpanded: true, isPlayersExpanded: true };\r\n\r\n                if (!state.notificationControls) {\r\n                    state.notificationControls = { isMuted: false, isMinimized: false, isTTSDisabled: false, autoMinimize: true };\r\n                } else if (state.notificationControls.autoMinimize === undefined) state.notificationControls.autoMinimize = true;\r\n\r\n                if (!state.adminCourtManagement) {\r\n                    state.adminCourtManagement = { mode: 'card1_select_court', courtId: null, currentCourtPlayers: [], removedPlayers: [], addedPlayers: [] };\r\n                }\r\n\r\n                 if (!state.ballManagement) {\r\n                    state.ballManagement = { stock: 0, usedStock: 0, history: [], historyFilter: 'all', tempSale: { stockType: null, memberSignOut: null, purchaserName: null, purchaserType: null } };\r\n                 } else {\r\n                    if (state.ballManagement.usedStock === undefined) state.ballManagement.usedStock = 0;\r\n                    if (!state.ballManagement.historyFilter) state.ballManagement.historyFilter = 'all';\r\n                    if (!state.ballManagement.tempSale) state.ballManagement.tempSale = { stockType: null, memberSignOut: null, purchaserName: null, purchaserType: null };\r\n                    else if (state.ballManagement.tempSale.purchaserType === undefined) state.ballManagement.tempSale.purchaserType = null;\r\n                 }\r\n\r\n                 // Ensure lightSettings structure exists and has basic global keys\r\n                 if (!state.lightSettings || typeof state.lightSettings !== 'object') {\r\n                     state.lightSettings = { shellyBaseUrl: '', shellyAuthKey: '', courts: {}, general: {} };\r\n                 }\r\n                 if (state.lightSettings.shellyBaseUrl === undefined) state.lightSettings.shellyBaseUrl = '';\r\n                 if (state.lightSettings.shellyAuthKey === undefined) state.lightSettings.shellyAuthKey = '';\r\n                 if (!state.lightSettings.courts || typeof state.lightSettings.courts !== 'object') state.lightSettings.courts = {};\r\n                 if (!state.lightSettings.general || typeof state.lightSettings.general !== 'object') state.lightSettings.general = {};\r\n\r\n                 // Ensure default court settings exist if missing after load\r\n                 const defaultCourtIds = ['A', 'B', 'C', 'D', 'E'];\r\n                 defaultCourtIds.forEach(id => {\r\n                     if (!state.lightSettings.courts[id]) {\r\n                         state.lightSettings.courts[id] = { id: id, label: `Court ${id} Lights`, isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n                     } else {\r\n                        // Ensure all properties exist even if the court object was loaded partially\r\n                        state.lightSettings.courts[id].id = state.lightSettings.courts[id].id || id;\r\n                        state.lightSettings.courts[id].label = state.lightSettings.courts[id].label || `Court ${id} Lights`;\r\n                        state.lightSettings.courts[id].isManaged = state.lightSettings.courts[id].isManaged !== undefined ? state.lightSettings.courts[id].isManaged : false;\r\n                        state.lightSettings.courts[id].isActive = state.lightSettings.courts[id].isActive || false;\r\n                        state.lightSettings.courts[id].shellyDeviceId = state.lightSettings.courts[id].shellyDeviceId || '';\r\n                        state.lightSettings.courts[id].shellyCloudId = state.lightSettings.courts[id].shellyCloudId || '';\r\n                     }\r\n                 });\r\n                 // Ensure default general light settings exist if missing\r\n                 if (!state.lightSettings.general['clubhouse']) {\r\n                      state.lightSettings.general['clubhouse'] = { id: 'clubhouse', label: 'Clubhouse Lights', isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n                 }\r\n\r\n                 // Ensure suggestionSettings and its properties exist\r\n                 if (!state.suggestionSettings) {\r\n                    state.suggestionSettings = { femaleRatioPercent: 50, maleRatioPercent: 70, prioritizeLeastPlaytime: true, powerScoreOnly: false, topPlayerPercent: 35, frequentOpponentPercent: 35, weakPlayerPercent: 35, weakPlayerThreshold: -0.1 };\r\n                 } else {\r\n                     // Add new properties if they are missing from older saved states\r\n                    if (state.suggestionSettings.topPlayerPercent === undefined) state.suggestionSettings.topPlayerPercent = 35;\r\n                    if (state.suggestionSettings.frequentOpponentPercent === undefined) state.suggestionSettings.frequentOpponentPercent = 35;\r\n                    if (state.suggestionSettings.weakPlayerPercent === undefined) state.suggestionSettings.weakPlayerPercent = 35;\r\n                    if (state.suggestionSettings.weakPlayerThreshold === undefined) state.suggestionSettings.weakPlayerThreshold = -0.1;\r\n                 }\r\n\r\n                state.checklistHistory = state.checklistHistory || [];\r\n                state.selectedChecklistHistoryDate = state.selectedChecklistHistoryDate || null;\r\n                state.undoHistory = state.undoHistory || { actions: [], maxHistory: 10 }; // Ensure undo history exists\r\n\r\n\r\n                // Function to ensure player objects have needed properties\r\n                const ensurePlayerObjects = (playerList, defaultList) => {\r\n                     if (!Array.isArray(playerList)) return [];\r\n                     return playerList.map(player => {\r\n                        if (typeof player === 'string') {\r\n                            const defaultPlayer = defaultList.find(p => p.name === player);\r\n                            // Ensure default guest object includes type\r\n                            return defaultPlayer || { name: player, gender: '?', guest: true, type: 'Adult', isPaused: false, onLeaderboard: true };\r\n                        }\r\n                         player.isPaused = player.isPaused || false;\r\n                         player.onLeaderboard = player.onLeaderboard === undefined ? true : player.onLeaderboard;\r\n                         // Ensure type exists, default to Adult if missing\r\n                         player.type = player.type || 'Adult';\r\n                        return player;\r\n                    });\r\n                };\r\n\r\n                // Re-calculate clubMembers based on who is checked in\r\n                const checkedInNames = new Set();\r\n                 if (Array.isArray(state.availablePlayers)) {\r\n                    state.availablePlayers.forEach(p => checkedInNames.add(p.name));\r\n                 }\r\n                state.courts.forEach(court => {\r\n                    if (Array.isArray(court.players)) {\r\n                        court.players.forEach(p => checkedInNames.add(p.name));\r\n                    }\r\n                });\r\n\r\n                state.clubMembers = MASTER_MEMBER_LIST.filter(p => !checkedInNames.has(p.name));\r\n                state.clubMembers.sort((a,b) => a.name.localeCompare(b.name));\r\n\r\n                // Process availablePlayers and players on court\r\n                state.availablePlayers = ensurePlayerObjects(state.availablePlayers, MASTER_MEMBER_LIST);\r\n\r\n                state.courts.forEach(court => {\r\n                    if (court.status === 'available' && court.becameAvailableAt === undefined) {\r\n                        court.becameAvailableAt = Date.now();\r\n                    }\r\n                    court.isCollapsed = court.isCollapsed === undefined ? false : court.isCollapsed;\r\n                    court.isModeOverlayActive = court.isModeOverlayActive === undefined ? false : court.isModeOverlayActive;\r\n                    court.courtMode = court.courtMode || 'doubles';\r\n                    court.teamsSet = court.teamsSet === undefined ? null : court.teamsSet; // null indicates unset for doubles\r\n\r\n                    court.players = ensurePlayerObjects(court.players, MASTER_MEMBER_LIST);\r\n                     if (!court.teams) {\r\n                        court.teams = { team1: [], team2: [] };\r\n                     } else {\r\n                        court.teams.team1 = ensurePlayerObjects(court.teams.team1, MASTER_MEMBER_LIST);\r\n                        court.teams.team2 = ensurePlayerObjects(court.teams.team2, MASTER_MEMBER_LIST);\r\n                     }\r\n\r\n                    // Restart timers if needed\r\n                    if (court.status === \"game_pending\" && court.autoStartTimeTarget) {\r\n                        const delay = court.autoStartTimeTarget - Date.now();\r\n                        if (delay > 0) {\r\n                            if (court.autoStartTimer) clearTimeout(court.autoStartTimer);\r\n                            // IMPORTANT: Ensure handleStartGame is defined correctly\r\n                            court.autoStartTimer = setTimeout(() => handleStartGame(court.id), delay);\r\n                        } else {\r\n                            // If delay is negative, start immediately\r\n                             handleStartGame(court.id);\r\n                        }\r\n                    } else if (court.autoStartTimer) { // Clear timer if status isn't pending anymore\r\n                         clearTimeout(court.autoStartTimer);\r\n                         court.autoStartTimer = null;\r\n                    }\r\n                });\r\n\r\n                console.log('State loaded from server successfully');\r\n            } else {\r\n                 console.log(\"No saved state found on server, using initial state.\");\r\n                 // Ensure lightSettings exists even with initial state\r\n                  if (!state.lightSettings) {\r\n                     state.lightSettings = { shellyBaseUrl: '', shellyAuthKey: '', courts: {}, general: {} };\r\n                     // Populate initial default courts if needed\r\n                     const defaultCourtIds = ['A', 'B', 'C', 'D', 'E'];\r\n                     defaultCourtIds.forEach(id => {\r\n                         state.lightSettings.courts[id] = { id: id, label: `Court ${id} Lights`, isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n                     });\r\n                     state.lightSettings.general['clubhouse'] = { id: 'clubhouse', label: 'Clubhouse Lights', isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n                  }\r\n            }\r\n        } catch (error) {\r\n            console.error('Error loading state:', error);\r\n            console.log(\"Using initial state due to error.\");\r\n             // Ensure lightSettings exists even on error\r\n              if (!state.lightSettings) {\r\n                 state.lightSettings = { shellyBaseUrl: '', shellyAuthKey: '', courts: {}, general: {} };\r\n                  // Populate initial default courts if needed\r\n                 const defaultCourtIds = ['A', 'B', 'C', 'D', 'E'];\r\n                 defaultCourtIds.forEach(id => {\r\n                     state.lightSettings.courts[id] = { id: id, label: `Court ${id} Lights`, isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n                 });\r\n                 state.lightSettings.general['clubhouse'] = { id: 'clubhouse', label: 'Clubhouse Lights', isManaged: false, isActive: false, shellyDeviceId: '', shellyCloudId: '' };\r\n              }\r\n        }\r\n    }\r\n\r\n    function updateHeaderClock(){ \r\n        const date = new Date();\r\n        const weekday = date.toLocaleDateString(\"en-ZA\", { weekday: \"long\" });\r\n        const day = String(date.getDate()).padStart(2, '0');\r\n\r\n        // Get 24-hour time parts\r\n        const hour24 = String(date.getHours()).padStart(2, '0');\r\n        const minutes = String(date.getMinutes()).padStart(2, '0');\r\n        const seconds = String(date.getSeconds()).padStart(2, '0');\r\n\r\n        // Determine am/pm for the tag\r\n        const ampm = date.getHours() >= 12 ? 'pm' : 'am';\r\n\r\n        // Construct the custom time string\r\n        const time = `${hour24}:${minutes}:${seconds} ${ampm}`;\r\n\r\n        headerClock.textContent = `${weekday} ${day}, ${time}`; \r\n    }\r\n\r\n    function updateOverlaySpacers() {\r\n        const headerLogo = document.getElementById('header-logo');\r\n        const leftSpacer = document.getElementById('left-spacer');\r\n        const rightSpacer = document.getElementById('right-spacer');\r\n\r\n        if (!headerLogo || !leftSpacer || !rightSpacer) return;\r\n\r\n        // Get the logo's width\r\n        const logoWidth = headerLogo.offsetWidth;\r\n\r\n        // Apply the logo's width to both the left and right spacers\r\n        leftSpacer.style.width = `${logoWidth}px`;\r\n        rightSpacer.style.width = `${logoWidth}px`;\r\n    }\r\n\r\n    function updateTimers(){\r\n        updateHeaderClock();\r\n        state.courts.forEach(court => {\r\n            const timerEl = document.getElementById(`timer-${court.id}`);\r\n            if (timerEl) {\r\n                if (court.status === 'in_progress' && court.gameStartTime) {\r\n                    const elapsed = Date.now() - court.gameStartTime;\r\n                    const hours = Math.floor(elapsed / 3600000);\r\n                    const minutes = Math.floor((elapsed % 3600000) / 60000);\r\n                    timerEl.textContent = `${String(hours).padStart(2, \"0\")}h${String(minutes).padStart(2, \"0\")}m`;\r\n                } else if (court.status === 'game_pending' && court.autoStartTimeTarget) {\r\n                    const remaining = court.autoStartTimeTarget - Date.now();\r\n                    if (remaining < 0) {\r\n                        timerEl.textContent = \"00:00\";\r\n                        return;\r\n                    }\r\n                    const minutes = Math.floor(remaining / 60000);\r\n                    const seconds = Math.floor((remaining % 60000) / 1000);\r\n                    timerEl.textContent = `${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}`;\r\n                } else {\r\n                    timerEl.textContent = '';\r\n                }\r\n            }\r\n        });\r\n\r\n        document.querySelectorAll('.player-pause-cooldown').forEach(timerEl => {\r\n            const pauseTime = parseInt(timerEl.dataset.pauseTime, 10);\r\n            if (pauseTime) {\r\n                const TEN_MINUTES_MS = 10 * 60 * 1000;\r\n                const elapsed = Date.now() - pauseTime;\r\n                const remaining = Math.max(0, TEN_MINUTES_MS - elapsed);\r\n                \r\n                if (remaining === 0) {\r\n                    timerEl.textContent = \"00m00s\";\r\n                    timerEl.classList.remove('player-pause-cooldown');\r\n                } else {\r\n                    const minutes = Math.floor(remaining / 60000);\r\n                    const seconds = Math.floor((remaining % 60000) / 1000);\r\n                    // --- THIS IS THE FORMAT CHANGE ---\r\n                    timerEl.textContent = `${String(minutes).padStart(2, \"0\")}m${String(seconds).padStart(2, \"0\")}s`;\r\n                }\r\n            }\r\n        });\r\n\r\n        updateAlertStatusTimer();\r\n    }\r\n\r\n\r\n    // --- NEW: Global Keyboard Control Functions ---\r\n\r\n\r\n    // --- MODIFIED: Ensure initialValue parameter exists ---\r\n    function showGlobalKeyboard(inputElement, startingPage = 'LetterPad', initialValue = '') { // <-- Added initialValue parameter\r\n        console.log('showGlobalKeyboard called for:', inputElement.id, 'Parent modal visible:', !document.getElementById('new-parent-modal').classList.contains('hidden'));\r\n        activeGlobalInput = inputElement;\r\n        globalKeyboardState.currentPage = startingPage;\r\n\r\n        // For date/time inputs, show partial value or empty, otherwise use actual value\r\n        if (inputElement.type === 'date' || inputElement.type === 'time') {\r\n            // *** CHANGE textContent to value ***\r\n            globalKeyboardDisplay.value = inputElement.dataset.partialValue || ''; //\r\n        } else {\r\n            // Use initialValue if provided, otherwise use inputElement.value\r\n            // *** CHANGE textContent to value ***\r\n            globalKeyboardDisplay.value = initialValue || activeGlobalInput.value; //\r\n        }\r\n\r\n        // *** CHANGE scrollTop to scrollHeight ***\r\n        globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight; //\r\n\r\n        customAlphaKeypadModal.classList.add('hidden');\r\n        customKeypadModal.classList.add('hidden');\r\n        globalKeyboardModal.classList.remove('hidden');\r\n\r\n        renderGlobalKeyboard();\r\n        // *** NEW: Focus the textarea when shown ***\r\n        globalKeyboardDisplay.focus(); //\r\n        // Move cursor to the end\r\n        globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = globalKeyboardDisplay.value.length; //\r\n    }\r\n\r\n    function hideGlobalKeyboard() {\r\n        // Clear partial value data attribute if it exists\r\n        if (activeGlobalInput && activeGlobalInput.dataset.partialValue !== undefined) {\r\n            delete activeGlobalInput.dataset.partialValue;\r\n        }\r\n        \r\n        globalKeyboardModal.classList.add('hidden');\r\n        activeGlobalInput = null;\r\n        globalKeyboardState.currentPage = 'LetterPad';\r\n        globalKeyboardState.case = 'lower';\r\n        clearTimeout(globalKeyboardState.longPressTimer);\r\n    }\r\n    // --- END NEW: Global Keyboard Control Functions ---\r\n\r\n    // --- NEW: Function to update the overlay display ---\r\n    function updateOverlayDisplay(inputElement, overlay, partialValue) {\r\n        const isDate = inputElement.type === 'date';\r\n        const currentPart = inputElement.dataset.currentDatePart;\r\n        \r\n        if (isDate) {\r\n            // Extract parts from partial value (YYYYMMDD)\r\n            const year = partialValue.slice(0, 4).padEnd(4, 'y');\r\n            const month = partialValue.slice(4, 6).padEnd(2, 'm');\r\n            const day = partialValue.slice(6, 8).padEnd(2, 'd');\r\n            \r\n            // Update each part in the overlay\r\n            const parts = overlay.querySelectorAll('.part');\r\n            parts[0].textContent = year.replace(/y/g, (match, offset) => 'yyyy'[offset]);\r\n            parts[0].classList.toggle('filled', partialValue.length > 0);\r\n            parts[0].classList.toggle('empty', partialValue.length === 0);\r\n            parts[0].classList.toggle('active', currentPart === 'YYYY');\r\n            \r\n            parts[1].textContent = month.replace(/m/g, (match, offset) => 'mm'[offset]);\r\n            parts[1].classList.toggle('filled', partialValue.length > 4);\r\n            parts[1].classList.toggle('empty', partialValue.length <= 4);\r\n            parts[1].classList.toggle('active', currentPart === 'MM');\r\n            \r\n            parts[2].textContent = day.replace(/d/g, (match, offset) => 'dd'[offset]);\r\n            parts[2].classList.toggle('filled', partialValue.length > 6);\r\n            parts[2].classList.toggle('empty', partialValue.length <= 6);\r\n            parts[2].classList.toggle('active', currentPart === 'DD');\r\n        } else {\r\n            // Time input (HHMM)\r\n            const hour = partialValue.slice(0, 2).padEnd(2, '-');\r\n            const minute = partialValue.slice(2, 4).padEnd(2, '-');\r\n            \r\n            // Update each part in the overlay\r\n            const parts = overlay.querySelectorAll('.part');\r\n            parts[0].textContent = hour;\r\n            parts[0].classList.toggle('filled', partialValue.length > 0);\r\n            parts[0].classList.toggle('empty', partialValue.length === 0);\r\n            parts[0].classList.toggle('active', currentPart === 'HH');\r\n            \r\n            parts[1].textContent = minute;\r\n            parts[1].classList.toggle('filled', partialValue.length > 2);\r\n            parts[1].classList.toggle('empty', partialValue.length <= 2);\r\n            parts[1].classList.toggle('active', currentPart === 'MM');\r\n        }\r\n    }\r\n    // --- END NEW ---\r\n\r\n    // --- NEW: Global Keyboard Rendering and Logic ---\r\n\r\n    // Helper to get the correct character based on case\r\n    function getCharForCase(key) {\r\n        if (globalKeyboardState.case === 'upper' || globalKeyboardState.case === 'shift') {\r\n            return key.toUpperCase();\r\n        }\r\n        return key.toLowerCase();\r\n    }\r\n\r\n    // Helper to switch the keyboard page\r\n    function switchGlobalKeyboardPage(newPage) {\r\n        if (newPage === 'LetterPad') {\r\n            // When returning to letter pad, reset to initial case state\r\n            globalKeyboardState.case = 'lower'; \r\n        }\r\n        globalKeyboardState.currentPage = newPage;\r\n        renderGlobalKeyboard();\r\n    }\r\n\r\n    function renderGlobalKeyboard(searchTerm = '') {\r\n        const currentPage = globalKeyboardState.currentPage;\r\n        const layout = KEYBOARD_LAYOUTS[currentPage];\r\n        globalKeyboardGrid.innerHTML = '';\r\n        globalKeyboardGrid.classList.remove('emoji-grid');\r\n\r\n        // --- Control visibility of the search container ---\r\n        if (currentPage === 'EmojiPage') {\r\n            emojiSearchContainer.classList.add('active-page');\r\n            emojiSearchContainer.classList.remove('hidden');\r\n        } else {\r\n            emojiSearchContainer.classList.remove('active-page');\r\n            emojiSearchContainer.classList.add('hidden');\r\n        }\r\n\r\n        if (currentPage === 'EmojiPage') {\r\n            globalKeyboardGrid.classList.add('emoji-grid');\r\n            renderEmojiPage(searchTerm);\r\n            return;\r\n        }\r\n\r\n        // --- Set page attribute for CSS targeting ---\r\n        // Find the .keyboard-content container (parent of globalKeyboardGrid)\r\n        const keyboardContent = globalKeyboardGrid.closest('.keyboard-content');\r\n        if (keyboardContent) {\r\n            keyboardContent.setAttribute('data-page', currentPage);\r\n        }\r\n\r\n        layout.forEach((rowKeys, rowIndex) => {\r\n            const rowDiv = document.createElement('div');\r\n            rowDiv.className = `keyboard-row row-${rowIndex}`;\r\n\r\n            let isNavigationRow = false;\r\n\r\n            // --- Apply custom row layout for Letter/Symbol pages ---\r\n            if (currentPage !== 'NumberPad') {\r\n                if (currentPage === 'LetterPad' && rowIndex === 1) {\r\n                    // Row 1 (A-L): 9 keys centered\r\n                    rowDiv.style.gridTemplateColumns = 'repeat(9, 1fr)';\r\n                    rowDiv.style.width = '90%';\r\n                    rowDiv.style.margin = '0 auto';\r\n                } else if (currentPage === 'LetterPad' && rowIndex === 2) {\r\n                    // Row 2 (Shift ZXC...): Custom fractions\r\n                    rowDiv.style.gridTemplateColumns = '1.5fr repeat(7, 1fr) 1.5fr';\r\n                } else if (rowIndex === layout.length - 1) {\r\n                    // Last Row (NAV): Custom fractions\r\n                    rowDiv.style.gridTemplateColumns = '1.5fr 1fr 5fr 1fr 1.5fr';\r\n                    isNavigationRow = true;\r\n                } else {\r\n                    // Default 10 columns for QWERTY and Symbols P1/P2\r\n                    rowDiv.style.gridTemplateColumns = 'repeat(10, 1fr)';\r\n                }\r\n            }\r\n            // --- Apply custom row layout for NumberPad ---\r\n            else { // currentPage === 'NumberPad'\r\n                // Row 0, 1, 2: 5 equal columns (full width)\r\n                if (rowIndex < 3) {\r\n                    rowDiv.style.gridTemplateColumns = 'repeat(5, 1fr)';\r\n                    rowDiv.style.width = '100%';\r\n                } \r\n                // Row 3: 7 equal columns (full width)\r\n                else if (rowIndex === 3) {\r\n                    // Use 7 equal columns for all 7 keys\r\n                    rowDiv.style.gridTemplateColumns = 'repeat(7, 1fr)';\r\n                    rowDiv.style.width = '100%';\r\n                    isNavigationRow = true;\r\n                }\r\n            }\r\n\r\n            rowKeys.forEach(key => {\r\n                const button = document.createElement('button');\r\n                button.className = 'global-keypad-btn';\r\n                button.dataset.key = key;\r\n\r\n                let displayChar = getCharForCase(key);\r\n                let isActionOrSpecial = false;\r\n\r\n                // --- NumberPad Specific Styling (NO GRID SPANNING) ---\r\n                if (currentPage === 'NumberPad') {\r\n                    if (key === 'ENTER') { \r\n                        // MODIFIED: Use standard Unicode character for Return/Enter key\r\n                        displayChar = '\\u23CE'; // Return Symbol (⏎)\r\n                        button.classList.add('key-action');\r\n                        isActionOrSpecial = true;\r\n                    } else if (key === 'BACK') {\r\n                        displayChar = '⌫';\r\n                        button.classList.add('key-action');\r\n                        isActionOrSpecial = true;\r\n                    } else if (key === 'DOT') {\r\n                        displayChar = '.';\r\n                    } else if (key === 'PERCENT') {\r\n                        displayChar = '%';\r\n                    } else if (key === 'COMMA') {\r\n                        displayChar = ',';\r\n                    } else if (['+', '-', '*', '='].includes(key)) {\r\n                        button.classList.add('key-special');\r\n                        isActionOrSpecial = true;\r\n                    } else if (key === 'SPACE') {\r\n                        displayChar = 'space';\r\n                        button.classList.add('key-special');\r\n                        isActionOrSpecial = true;\r\n                    } else if (key === '?123') {\r\n                        displayChar = '?123';\r\n                        button.classList.add('key-special');\r\n                        isActionOrSpecial = true;\r\n                    } else if (key === 'ABC') {\r\n                        displayChar = 'ABC';\r\n                        button.classList.add('key-special');\r\n                        isActionOrSpecial = true;\r\n                    }\r\n\r\n                    // CRITICAL: DO NOT use gridColumn span for NumberPad Row 3\r\n                    // The fractional grid layout handles the sizing automatically\r\n                    // Remove all gridColumn assignments for NumberPad keys\r\n                }\r\n                \r\n                // --- General Key Handling ---\r\n                if (key === 'SHIFT') {\r\n                    displayChar = (globalKeyboardState.case === 'upper' || globalKeyboardState.case === 'shift') ? '⇧' : 'Caps';\r\n                    button.classList.add('key-special');\r\n                    isActionOrSpecial = true;\r\n                    if (globalKeyboardState.case === 'upper') {\r\n                        button.classList.add('active'); \r\n                    }\r\n                } else if (key === 'BACK' && currentPage !== 'NumberPad') {\r\n                    displayChar = '⌫';\r\n                    button.classList.add('key-action');\r\n                    isActionOrSpecial = true;\r\n                } else if (key === 'ENTER') {\r\n                    // MODIFIED: Use standard Unicode character for Return/Enter key\r\n                    displayChar = '\\u23CE'; // Return Symbol (⏎)\r\n                    button.classList.add('key-action');\r\n                    isActionOrSpecial = true;\r\n                } else if (key === 'SPACE' && currentPage !== 'NumberPad') {\r\n                    displayChar = 'space';\r\n                } else if (key === 'GLOBE' || key === 'MIC') {\r\n                    displayChar = (key === 'GLOBE') ? '🌐' : '🎙️';\r\n                    button.classList.add('key-special');\r\n                    isActionOrSpecial = true;\r\n                } else if (['?123', 'ABC', '1234', '!@#'].includes(key) && currentPage !== 'NumberPad') {\r\n                    displayChar = key;\r\n                    button.classList.add('key-special');\r\n                    isActionOrSpecial = true;\r\n                }\r\n\r\n                // Custom override for `, / 😀` button appearance\r\n                if (key === ', / 😀') {\r\n                    displayChar = (currentPage === 'LetterPad') ? ', / 😀' : ',';\r\n                    button.classList.remove('key-special');\r\n                    isActionOrSpecial = false;\r\n                }\r\n\r\n                button.textContent = displayChar;\r\n                button.addEventListener('click', handleGlobalKeypadClick);\r\n\r\n                // Add long press listener for the Emoji key on LetterPad\r\n                if (currentPage === 'LetterPad' && key === ', / 😀') {\r\n                    // ... (long press logic remains the same) ...\r\n                }\r\n\r\n                rowDiv.appendChild(button);\r\n            });\r\n            globalKeyboardGrid.appendChild(rowDiv);\r\n        });\r\n    }\r\n\r\n    // Simplified Emoji Renderer (needs work if implementing full scrollable list)\r\n    function renderEmojiPage(searchTerm) {\r\n        // Search container visibility is now controlled by renderGlobalKeyboard()\r\n        globalKeyboardGrid.style.gridTemplateColumns = 'repeat(7, 1fr)'; // 7 columns for emoji grid\r\n\r\n        const filteredEmojis = EMOJI_LIST.filter(e => !searchTerm || e.toLowerCase().includes(searchTerm.toLowerCase()));\r\n\r\n        // Add the bottom navigation bar for the Emoji Page first\r\n        const navRow = document.createElement('div');\r\n        navRow.className = 'keyboard-row row-nav';\r\n        navRow.style.gridTemplateColumns = '1.5fr 1fr 1fr 1.5fr'; \r\n        \r\n        // ABC (Back to LetterPad)\r\n        let btnABC = document.createElement('button');\r\n        btnABC.className = 'global-keypad-btn key-special';\r\n        btnABC.textContent = 'ABC';\r\n        btnABC.dataset.key = 'ABC';\r\n        btnABC.addEventListener('click', handleGlobalKeypadClick);\r\n        navRow.appendChild(btnABC);\r\n\r\n        // Globe (Placeholder/Future use)\r\n        let btnGlobe = document.createElement('button');\r\n        btnGlobe.className = 'global-keypad-btn key-special';\r\n        btnGlobe.textContent = '🌐';\r\n        btnGlobe.dataset.key = 'GLOBE';\r\n        navRow.appendChild(btnGlobe);\r\n        \r\n        // Mic (Placeholder/Future use)\r\n        let btnMic = document.createElement('button');\r\n        btnMic.className = 'global-keypad-btn key-special';\r\n        btnMic.textContent = '🎙️';\r\n        btnMic.dataset.key = 'MIC';\r\n        navRow.appendChild(btnMic);\r\n        \r\n        // !@# (Symbols P1)\r\n        let btnSymbols = document.createElement('button');\r\n        btnSymbols.className = 'global-keypad-btn key-special';\r\n        btnSymbols.textContent = '!@#';\r\n        btnSymbols.dataset.key = '!@#';\r\n        btnSymbols.addEventListener('click', handleGlobalKeypadClick);\r\n        navRow.appendChild(btnSymbols);\r\n\r\n        globalKeyboardGrid.appendChild(navRow);\r\n        \r\n        // Render the Emojis\r\n        filteredEmojis.forEach(emoji => {\r\n            const button = document.createElement('button');\r\n            button.className = 'global-keypad-btn key-emoji';\r\n            button.dataset.key = emoji;\r\n            button.textContent = emoji;\r\n            button.addEventListener('click', handleGlobalKeypadClick);\r\n            globalKeyboardGrid.appendChild(button);\r\n        });\r\n    }\r\n\r\n\r\n    // Main click handler for the Global Keyboard\r\n    function handleGlobalKeypadClick(e) {\r\n        e.preventDefault();\r\n        const key = e.target.dataset.key;\r\n        // *** CHANGE textContent to value ***\r\n        let currentValue = globalKeyboardDisplay.value; // Get value from textarea\r\n        const isTargetDateInput = activeGlobalInput && activeGlobalInput.type === 'date';\r\n        const isTargetTimeInput = activeGlobalInput && activeGlobalInput.type === 'time';\r\n        const isTargetDateOrTimeInput = isTargetDateInput || isTargetTimeInput;\r\n\r\n        // *** NEW: Get current cursor position ***\r\n        const start = globalKeyboardDisplay.selectionStart; //\r\n        const end = globalKeyboardDisplay.selectionEnd; //\r\n        // *** END NEW ***\r\n\r\n        clearTimeout(globalKeyboardState.longPressTimer);\r\n\r\n        // --- Navigation Logic (Remains the same) ---\r\n        // ... (if/else if blocks for '?123', 'ABC', etc.) ...\r\n\r\n        // --- Character Input / Special Actions ---\r\n\r\n        // Handle BACKSPACE\r\n        if (key === 'BACK') {\r\n            if (isTargetDateOrTimeInput) {\r\n                // ... (Date/Time backspace logic remains the same, using partialValue) ...\r\n            } else {\r\n                // *** MODIFIED: Handle backspace with cursor position ***\r\n                if (start === end && start > 0) { // Single character delete\r\n                    currentValue = currentValue.substring(0, start - 1) + currentValue.substring(end); //\r\n                    globalKeyboardDisplay.value = currentValue; // Update value\r\n                    globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start - 1; // Move cursor back\r\n                } else if (start !== end) { // Selection delete\r\n                    currentValue = currentValue.substring(0, start) + currentValue.substring(end); //\r\n                    globalKeyboardDisplay.value = currentValue; // Update value\r\n                    globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start; // Move cursor to start of deletion\r\n                }\r\n                // *** END MODIFIED ***\r\n            }\r\n        }\r\n        // Handle ENTER/DONE\r\n        else if (key === 'ENTER' || key === 'RETURN_KEY') {\r\n            if (isTargetDateOrTimeInput) {\r\n                // ... (Date/Time Enter logic remains the same) ...\r\n            } else {\r\n                // *** MODIFIED: Insert newline at cursor ***\r\n                const newline = '\\n';\r\n                currentValue = currentValue.substring(0, start) + newline + currentValue.substring(end); //\r\n                globalKeyboardDisplay.value = currentValue; // Update value\r\n                globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + newline.length; // Move cursor after newline\r\n                // *** END MODIFIED ***\r\n            }\r\n        }\r\n        // Handle SHIFT (no change needed here)\r\n        else if (key === 'SHIFT') { /* ... */ globalKeyboardState.case === 'lower' ? (globalKeyboardState.case = 'shift') : (globalKeyboardState.case === 'shift' ? globalKeyboardState.case = 'upper' : globalKeyboardState.case = 'lower'); renderGlobalKeyboard(); return; } // Simplified shift logic\r\n\r\n        // Handle SPACE\r\n        else if (key === 'SPACE') { // *** MODIFIED: Insert space at cursor ***\r\n            const space = ' ';\r\n            currentValue = currentValue.substring(0, start) + space + currentValue.substring(end); //\r\n            globalKeyboardDisplay.value = currentValue; // Update value\r\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + space.length; // Move cursor after space\r\n        }\r\n        // Handle other special/navigation keys (no change needed for page switching logic)\r\n        else if (key === ', / 😀' || key === 'COMMA') {\r\n             const char = (globalKeyboardState.currentPage === 'LetterPad' && globalKeyboardState.case === 'lower') ? ',' : ',';\r\n             currentValue = currentValue.substring(0, start) + char + currentValue.substring(end);\r\n             globalKeyboardDisplay.value = currentValue;\r\n             globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length;\r\n        } else if (key === 'GLOBE' || key === 'MIC') { /* ... */ return; }\r\n        else if (key === 'DOT' || key === '.') {\r\n             const char = '.';\r\n             currentValue = currentValue.substring(0, start) + char + currentValue.substring(end);\r\n             globalKeyboardDisplay.value = currentValue;\r\n             globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length;\r\n        }\r\n        // ... (Handle other non-character keys like +/-, %, operators if needed) ...\r\n\r\n        // Handle NUMBER keys (0-9) - REVISED LOGIC (Date/Time logic remains the same)\r\n        else if (key >= '0' && key <= '9') {\r\n             if (isTargetDateInput || isTargetTimeInput) {\r\n                 // ... (Date/Time number input logic remains the same) ...\r\n             } else {\r\n                 // *** MODIFIED: Insert digit at cursor ***\r\n                 currentValue = currentValue.substring(0, start) + key + currentValue.substring(end); //\r\n                 globalKeyboardDisplay.value = currentValue; // Update value\r\n                 globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + 1; // Move cursor after digit\r\n                 // *** END MODIFIED ***\r\n             }\r\n        }\r\n\r\n        // Handle regular character keys (Letters, non-date symbols)\r\n        else {\r\n            if (isTargetDateOrTimeInput) return; // Ignore letters/symbols for date/time input\r\n\r\n            const char = getCharForCase(key);\r\n            // *** MODIFIED: Insert character at cursor ***\r\n            currentValue = currentValue.substring(0, start) + char + currentValue.substring(end); //\r\n            globalKeyboardDisplay.value = currentValue; // Update value\r\n            globalKeyboardDisplay.selectionStart = globalKeyboardDisplay.selectionEnd = start + char.length; // Move cursor after character\r\n            // *** END MODIFIED ***\r\n\r\n            if (globalKeyboardState.case === 'shift') {\r\n                globalKeyboardState.case = 'lower';\r\n                renderGlobalKeyboard();\r\n            }\r\n        }\r\n\r\n        // --- Update non-date input fields and dispatch event ---\r\n        if (!isTargetDateOrTimeInput && activeGlobalInput) {\r\n            // *** CHANGE textContent to value ***\r\n            activeGlobalInput.value = globalKeyboardDisplay.value; // Sync original input\r\n            activeGlobalInput.dispatchEvent(new Event('input'));\r\n        }\r\n        // Scroll keypad display if needed\r\n        globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight; //\r\n        // *** NEW: Refocus the textarea after button click ***\r\n        globalKeyboardDisplay.focus(); //\r\n    }\r\n\r\n    // --- END NEW: Global Keyboard Rendering and Logic ---\r\n\r\n    // Wire up search bar listener for emoji filtering\r\n    emojiSearchInput?.addEventListener('input', (e) => {\r\n        renderGlobalKeyboard(e.target.value);\r\n    });\r\n\r\n\r\n    function applyFontSize() {\r\n        document.body.style.setProperty('--font-size-multiplier', state.uiSettings.fontSizeMultiplier);\r\n    }\r\n\r\n    function applyDisplaySize() {\r\n        document.body.style.setProperty('--display-size-multiplier', state.uiSettings.displaySizeMultiplier);\r\n    }\r\n\r\n    function showEditStylesModal() {\r\n        // Logic to update the Font Size buttons\r\n        const currentFontMultiplier = state.uiSettings.fontSizeMultiplier;\r\n        const fontSelector = document.getElementById('font-size-selector');\r\n        if (fontSelector) {\r\n            fontSelector.querySelectorAll('button').forEach(btn => {\r\n                // Use parseFloat to ensure a proper number comparison\r\n                const btnSize = parseFloat(btn.dataset.size);\r\n                btn.classList.toggle('active', btnSize === currentFontMultiplier);\r\n            });\r\n        }\r\n\r\n        // Logic to update the Display Size buttons\r\n        const currentDisplayMultiplier = state.uiSettings.displaySizeMultiplier;\r\n        const displaySelector = document.getElementById('display-size-selector');\r\n        if (displaySelector) {\r\n            displaySelector.querySelectorAll('button').forEach(btn => {\r\n                btn.classList.toggle('active', parseFloat(btn.dataset.size) === currentDisplayMultiplier);\r\n            });\r\n        }\r\n\r\n        // Hide the admin modal and show the styles modal\r\n        adminSettingsModal.classList.add('hidden');\r\n        editStylesModal.classList.remove('hidden');\r\n    }\r\n\r\n    // --- NEW HELPER: Find which page a data-key belongs to ---\r\n    function findKeyPage(dataKeyToFind) {\r\n        for (const pageName in KEYBOARD_LAYOUTS) {\r\n            const layout = KEYBOARD_LAYOUTS[pageName];\r\n            for (const row of layout) {\r\n                if (row.includes(dataKeyToFind)) {\r\n                    return pageName; // Return the name of the page (e.g., 'SymbolsP1')\r\n                }\r\n            }\r\n        }\r\n        // Check special combined keys specifically\r\n        if (dataKeyToFind === ',' || dataKeyToFind === '/' || dataKeyToFind === '😀') {\r\n             if (KEYBOARD_LAYOUTS['LetterPad'][3].includes(', / 😀')) return 'LetterPad';\r\n        }\r\n        if (dataKeyToFind === '.') {\r\n             if (KEYBOARD_LAYOUTS['NumberPad'][3].includes('DOT')) return 'NumberPad';\r\n        }\r\n         if (dataKeyToFind === '%') {\r\n             if (KEYBOARD_LAYOUTS['NumberPad'][0].includes('PERCENT')) return 'NumberPad';\r\n        }\r\n\r\n        return null; // Key not found in any standard layout\r\n    }\r\n    // --- END NEW HELPER ---\r\n\r\n\r\n    function handleFontSizeChange(newMultiplier) {\r\n        state.uiSettings.fontSizeMultiplier = newMultiplier;\r\n        applyFontSize();\r\n        saveState();\r\n\r\n        // Update active button in the UI\r\n        const selector = document.getElementById('font-size-selector');\r\n        if (selector) {\r\n            selector.querySelectorAll('button').forEach(btn => {\r\n                btn.classList.remove('active');\r\n                if (parseFloat(btn.dataset.size) === newMultiplier) {\r\n                    btn.classList.add('active');\r\n                }\r\n            });\r\n        }\r\n    } \r\n\r\n    function handleDisplaySizeChange(newMultiplier) {\r\n        state.uiSettings.displaySizeMultiplier = newMultiplier;\r\n        applyDisplaySize();\r\n        saveState();\r\n\r\n        const selector = document.getElementById('display-size-selector');\r\n        if (selector) {\r\n            selector.querySelectorAll('button').forEach(btn => {\r\n                btn.classList.remove('active');\r\n                if (parseFloat(btn.dataset.size) === newMultiplier) {\r\n                    btn.classList.add('active');\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    function getWindDirection(degrees) {\r\n        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];\r\n        const index = Math.round(degrees / 22.5) % 16;\r\n        return directions[index];\r\n    }\r\n\r\n    function getAqiLabel(value) {\r\n        if (value <= 20) return 'Good';\r\n        if (value <= 40) return 'Fair';\r\n        if (value <= 60) return 'Moderate';\r\n        if (value <= 80) return 'Poor';\r\n        if (value <= 100) return 'Very Poor';\r\n        return 'Extremely Poor';\r\n    }\r\n\r\n\r\n\r\n /**\r\n     * Translates a WMO weather code into a display icon.\r\n     * @param {number} code The WMO weather code from the API.\r\n     * @param {boolean} isDay Whether it is currently daytime (defaults to true).\r\n     * @returns {string} An emoji character representing the weather.\r\n     */\r\n    function wmoCodeToText(code, isSpecificTime = false) {\r\n        switch (code) {\r\n            case 0: return 'Clear sky';\r\n            case 1: return 'Mainly clear';\r\n            case 2: return 'Partly cloudy';\r\n            case 3: return 'Overcast';\r\n            case 45: case 48: return 'Fog';\r\n            case 51: case 53: case 55: return 'Drizzle';\r\n            case 56: case 57: return 'Freezing Drizzle';\r\n            case 61: return 'Slight rain';\r\n            case 63: return 'Moderate rain';\r\n            case 65: return 'Heavy rain';\r\n            case 66: case 67: return 'Freezing Rain';\r\n            case 71: case 73: case 75: return 'Snow fall';\r\n            case 77: return 'Snow grains';\r\n            case 80: case 81: case 82: return 'Rain showers';\r\n            case 85: case 86: return 'Snow showers';\r\n            case 95: return 'Thunderstorm';\r\n            case 96: case 99: return isSpecificTime ? 'Thunderstorm with hail' : 'A thunderstorm this morning; otherwise, clouds and sun';\r\n            default: return 'Unknown';\r\n        }\r\n    }\r\n\r\n    function getWeatherIcon(code, isDay = true) {\r\n        switch (code) {\r\n            case 0: return isDay ? '☀️' : '🌙'; // Clear sky\r\n            case 1: return '🌤️'; // Mainly clear\r\n            case 2: return '⛅️'; // Partly cloudy\r\n            case 3: return '☁️'; // Overcast\r\n            case 45: case 48: return '🌫️'; // Fog\r\n            case 51: case 53: case 55: return '🌦️'; // Drizzle\r\n            case 56: case 57: return '🥶'; // Freezing Drizzle\r\n            case 61: case 63: case 65: return '🌧️'; // Rain\r\n            case 66: case 67: return '🥶'; // Freezing Rain\r\n            case 71: case 73: case 75: return '🌨️'; // Snow fall\r\n            case 77: return '❄️'; // Snow grains\r\n            case 80: case 81: case 82: return '⛈️'; // Rain showers\r\n            case 85: case 86: return '🌨️'; // Snow showers\r\n            case 95: case 96: case 99: return '🌩️'; // Thunderstorm\r\n            default: return '🤷';\r\n        }\r\n    }\r\n\r\n    function getWindDirection(degrees) {\r\n        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];\r\n        const index = Math.round(degrees / 22.5) % 16;\r\n        return directions[index];\r\n    }\r\n\r\n    function getAqiLabel(value) {\r\n        if (value <= 20) return 'Good';\r\n        if (value <= 40) return 'Fair';\r\n        if (value <= 60) return 'Moderate';\r\n        if (value <= 80) return 'Poor';\r\n        if (value <= 100) return 'Very Poor';\r\n        return 'Extremely Poor';\r\n    }\r\n\r\n\r\n \r\n\r\n\r\n    async function fetchWeather() {\r\n        const weatherDisplay = document.getElementById('weather-display');\r\n        if (!weatherDisplay) return;\r\n\r\n        const lat = -25.8417;\r\n        const lon = 28.1593;\r\n        \r\n        // MODIFIED: Fetch daily stats and hourly data for specific weather codes and dew point\r\n        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&hourly=weathercode,dewpoint_2m&timezone=auto`;\r\n\r\n        try {\r\n            const response = await fetch(apiUrl);\r\n            if (!response.ok) {\r\n                weatherDisplay.textContent = 'Weather unavailable';\r\n                return;\r\n            }\r\n            const data = await response.json();\r\n            \r\n            // --- Extract Data ---\r\n            const now = new Date();\r\n            const currentHour = now.getHours();\r\n\r\n            // Daily Stats\r\n            const maxTemp = Math.round(data.daily.temperature_2m_max[0]);\r\n            const minTemp = Math.round(data.daily.temperature_2m_min[0]);\r\n            \r\n            // Hourly Stats for Icons & Dew Point\r\n            const morningWeatherCode = data.hourly.weathercode[9]; // Weather at 9 AM\r\n            const afternoonWeatherCode = data.hourly.weathercode[15]; // Weather at 3 PM\r\n            const dewPoint = Math.round(data.hourly.dewpoint_2m[currentHour]); // Dew point for the current hour\r\n\r\n            // Get Icons\r\n            const morningIcon = getWeatherIcon(morningWeatherCode);\r\n            const afternoonIcon = getWeatherIcon(afternoonWeatherCode);\r\n            const dewPointIcon = '💧'; // Droplet icon\r\n\r\n            // --- Create HTML Structure ---\r\n            weatherDisplay.innerHTML = `\r\n                <div id=\"icon-fader\">\r\n                    <span class=\"weather-icon icon-max is-visible\">${afternoonIcon}</span>\r\n                    <span class=\"weather-icon icon-min\">${morningIcon}</span>\r\n                    <span class=\"weather-icon icon-dew\">${dewPointIcon}</span>\r\n                </div>\r\n                <div id=\"temp-fader\">\r\n                    <span class=\"temp-max is-visible\">${maxTemp}°C</span>\r\n                    <span class=\"temp-min\">${minTemp}°C</span>\r\n                    <span class=\"temp-dew\">${dewPoint}°C</span>\r\n                </div>\r\n            `;\r\n\r\n            // --- Start Animation Cycle ---\r\n            const elements = {\r\n                icons: [\r\n                    weatherDisplay.querySelector('.icon-max'),\r\n                    weatherDisplay.querySelector('.icon-min'),\r\n                    weatherDisplay.querySelector('.icon-dew')\r\n                ],\r\n                temps: [\r\n                    weatherDisplay.querySelector('.temp-max'),\r\n                    weatherDisplay.querySelector('.temp-min'),\r\n                    weatherDisplay.querySelector('.temp-dew')\r\n                ]\r\n            };\r\n            \r\n            let currentState = 0; // 0 = Max, 1 = Min, 2 = Dew\r\n            const totalStates = 3;\r\n\r\n            // Clear any existing interval to prevent multiple animations running\r\n            if (window.weatherAnimationInterval) {\r\n                clearInterval(window.weatherAnimationInterval);\r\n            }\r\n\r\n            window.weatherAnimationInterval = setInterval(() => {\r\n                const nextState = (currentState + 1) % totalStates;\r\n\r\n                elements.icons[currentState].classList.remove('is-visible');\r\n                elements.temps[currentState].classList.remove('is-visible');\r\n                \r\n                elements.icons[nextState].classList.add('is-visible');\r\n                elements.temps[nextState].classList.add('is-visible');\r\n                \r\n                currentState = nextState;\r\n            }, 5000); // Run this sequence every 5 seconds\r\n\r\n        } catch (error) {\r\n            console.error('Failed to fetch weather:', error);\r\n            // Fallback display on API error\r\n            const lowTemp = 12; // Placeholder low temperature\r\n            const highTemp = 25; // Placeholder high temperature\r\n            \r\n            weatherDisplay.innerHTML = `\r\n                <div id=\"temp-fader\">\r\n                    <span class=\"temp-min is-visible\">${lowTemp}°C</span>\r\n                    <span class=\"temp-max\">${highTemp}°C</span>\r\n                </div>`;\r\n\r\n            if (window.weatherAnimationInterval) {\r\n                clearInterval(window.weatherAnimationInterval);\r\n            }\r\n            \r\n            let isLowVisible = true;\r\n            window.weatherAnimationInterval = setInterval(() => {\r\n                const lowEl = weatherDisplay.querySelector('.temp-min');\r\n                const highEl = weatherDisplay.querySelector('.temp-max');\r\n                if (lowEl && highEl) {\r\n                    lowEl.classList.toggle('is-visible', !isLowVisible);\r\n                    highEl.classList.toggle('is-visible', isLowVisible);\r\n                    isLowVisible = !isLowVisible;\r\n                }\r\n            }, 5000);\r\n        }\r\n    }\r\n\r\n    function renderCurrentWeatherModal() {\r\n        if (!state.weatherData) return;\r\n        const { current } = state.weatherData;\r\n\r\n        document.getElementById('cw-time').textContent = current.time;\r\n        document.getElementById('cw-icon').textContent = getWeatherIcon(current.weatherCode);\r\n        document.getElementById('cw-temp').textContent = `${current.temp}°`;\r\n        document.getElementById('cw-realfeel').textContent = `${current.realFeel}°`;\r\n        document.getElementById('cw-realfeel-shade').textContent = `${current.realFeel}°`; // Current doesn't have shade\r\n        document.getElementById('cw-description').textContent = wmoCodeToText(current.weatherCode);\r\n        document.getElementById('cw-wind').textContent = `${current.windDir} ${current.windSpeed} km/h`;\r\n        document.getElementById('cw-wind-gusts').textContent = `${current.windGusts} km/h`;\r\n        const aqiEl = document.getElementById('cw-air-quality');\r\n        aqiEl.textContent = getAqiLabel(current.aqi);\r\n        aqiEl.className = `aqi-${getAqiLabel(current.aqi).toLowerCase().replace(' ','')}`;\r\n    }\r\n\r\n    function renderDetailedWeatherModal() {\r\n        if (!state.weatherData) return;\r\n        const { current, day, morning, afternoon } = state.weatherData;\r\n        const view = state.detailedWeatherView;\r\n\r\n        // Update active tab\r\n        document.querySelectorAll('.weather-tabs .tab').forEach(tab => {\r\n            tab.classList.toggle('active', tab.dataset.view === view);\r\n        });\r\n\r\n        // Populate top section (Detailed Current)\r\n        document.getElementById('dw-uv').textContent = `${current.uv} (Low)`;\r\n        document.getElementById('dw-dewpoint').textContent = `${current.dewPoint}°`;\r\n        document.getElementById('dw-humidity').textContent = `${current.humidity}%`;\r\n        document.getElementById('dw-pressure').textContent = `↑ ${current.pressure} mb`;\r\n        document.getElementById('dw-cloud-cover').textContent = `${current.cloudCover}%`;\r\n        document.getElementById('dw-visibility').textContent = `${current.visibility} km`;\r\n\r\n        // Populate bottom section (Forecast) based on view\r\n        let forecastData;\r\n        let gridHtml = '';\r\n        switch (view) {\r\n            case 'morning':\r\n                forecastData = morning;\r\n                gridHtml = `\r\n                    <div class=\"weather-item\"><span>Wind</span><strong>${forecastData.windDir} ${forecastData.windSpeed} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\r\n                    <div class=\"weather-item\"><span>Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\r\n                    <div class=\"weather-item\"><span>Humidity</span><strong>${forecastData.humidity}%</strong></div>\r\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\r\n                break;\r\n            case 'afternoon':\r\n                forecastData = afternoon;\r\n                gridHtml = `\r\n                    <div class=\"weather-item\"><span>Wind</span><strong>${forecastData.windDir} ${forecastData.windSpeed} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\r\n                    <div class=\"weather-item\"><span>Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\r\n                    <div class=\"weather-item\"><span>Humidity</span><strong>${forecastData.humidity}%</strong></div>\r\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\r\n                break;\r\n            case 'day':\r\n            default:\r\n                forecastData = day;\r\n                gridHtml = `\r\n                    <div class=\"weather-item\"><span>Max UV Index</span><strong>${forecastData.uv} (Very High)</strong></div>\r\n                    <div class=\"weather-item\"><span>Precipitation</span><strong>${forecastData.precipitation} mm</strong></div>\r\n                    <div class=\"weather-item\"><span>Max Wind</span><strong>${forecastData.windSpeed} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Max Wind Gusts</span><strong>${forecastData.windGusts} km/h</strong></div>\r\n                    <div class=\"weather-item\"><span>Prob. of Precip.</span><strong>${forecastData.precipProb}%</strong></div>\r\n                    <div class=\"weather-item\"><span>Cloud Cover</span><strong>${forecastData.cloudCover}%</strong></div>`;\r\n                break;\r\n        }\r\n\r\n        document.getElementById('forecast-icon').textContent = getWeatherIcon(forecastData.weatherCode);\r\n        document.getElementById('forecast-temp').textContent = `${forecastData.temp}°`;\r\n        document.getElementById('forecast-realfeel').textContent = `${forecastData.realFeel}°`;\r\n        document.getElementById('forecast-realfeel-shade').textContent = `${forecastData.realFeelShade}°`;\r\n        document.getElementById('forecast-description').textContent = wmoCodeToText(forecastData.weatherCode, view !== 'day');\r\n        document.getElementById('forecast-grid').innerHTML = gridHtml;\r\n    }\r\n\r\n    // ADDED FUNCTION: Determines if any court light is on\r\n    function getLightStatusIcon() {\r\n        const courtLights = state.lightSettings.courts;\r\n        for (const courtId in courtLights) {\r\n            // Only check court lights, not general ones\r\n            if (courtLights[courtId].isActive) {\r\n                return { class: 'mdi-lightbulb-on', icon: 'mdi mdi-lightbulb-on' };\r\n            }\r\n        }\r\n        return { class: 'mdi-lightbulb-outline', icon: 'mdi mdi-lightbulb-outline' };\r\n    }\r\n\r\n    // ADDED FUNCTION: Updates the icon in the Admin Settings button\r\n    function updateLightIcon() {\r\n        const lightButton = document.getElementById('light-management-btn');\r\n        if (lightButton) {\r\n            const iconData = getLightStatusIcon();\r\n            let iconElement = lightButton.querySelector('i');\r\n            \r\n            // Ensure the <i> element exists and is the target for class updates\r\n            if (!iconElement) {\r\n                // Re-create the <i> tag if it was accidentally removed (e.g., by emoji changes)\r\n                lightButton.innerHTML = `<i class=\"${iconData.icon}\"></i>`;\r\n                iconElement = lightButton.querySelector('i');\r\n            }\r\n            \r\n            // This is the core update logic: remove old, add new\r\n            if (iconElement) {\r\n                iconElement.classList.remove('mdi-lightbulb-on', 'mdi-lightbulb-outline');\r\n                iconElement.classList.add(iconData.class);\r\n            }\r\n        }\r\n    }\r\n\r\n    async function sendLightCommand(light, isActive) {\r\n        const apiUrl = API_ENDPOINTS.controlLight;\r\n\r\n        // Get toggleAfter - 0 means permanent toggle, >0 means pulse control\r\n        const toggleAfter = light.toggleAfter || 0;\r\n\r\n        const shellyCloudUrl = state.lightSettings?.shellyBaseUrl || '';\r\n        const authKey = state.lightSettings?.shellyAuthKey || '';\r\n        const deviceId = light.shellyCloudId || '';\r\n        const shellyIp = light.shellyDeviceId || '';\r\n\r\n        const bodyData = {\r\n            shellyCloudUrl: shellyCloudUrl,\r\n            authKey: authKey,\r\n            deviceId: deviceId,\r\n            toggleAfter: toggleAfter,  // 0 for lights, 1 for gates\r\n            shellyIp: shellyIp,\r\n            state: isActive,\r\n            method: 'cloud-first'\r\n        };\r\n\r\n        const hasCloudConfig = !!(shellyCloudUrl && shellyCloudUrl.trim() && \r\n                                authKey && authKey.trim() && \r\n                                deviceId && deviceId.trim());\r\n        const hasLocalConfig = !!(shellyIp && shellyIp.trim());\r\n\r\n        console.log(`[Frontend] Sending ${toggleAfter === 0 ? 'toggle' : 'pulse'} command for ${light.label}:`, {\r\n            method: bodyData.method,\r\n            state: isActive,\r\n            toggleAfter: toggleAfter,\r\n            hasCloudConfig: hasCloudConfig,\r\n            hasLocalConfig: hasLocalConfig\r\n        });\r\n\r\n        if (!hasCloudConfig && !hasLocalConfig) {\r\n            console.error('[Frontend] ❌ No control method configured!');\r\n            return { \r\n                success: false, \r\n                message: 'No control method configured. Check Admin > Gate/Light Settings.' \r\n            };\r\n        }\r\n\r\n        try {\r\n            const response = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(bodyData),\r\n                signal: AbortSignal.timeout(15000)\r\n            });\r\n\r\n            if (!response.ok) {\r\n                let errorMsg = `Server error: ${response.status}`;\r\n                try {\r\n                    const errorData = await response.json();\r\n                    errorMsg = errorData.message || errorData.error || errorMsg;\r\n                    console.error('[Frontend] Server error details:', errorData);\r\n                } catch (e) { /* Ignore */ }\r\n                console.error(`[Frontend] Error response from proxy: ${response.status}`);\r\n                throw new Error(errorMsg);\r\n            }\r\n\r\n            const data = await response.json();\r\n            console.log(`[Frontend] Response from proxy:`, data);\r\n\r\n            if (data.success) {\r\n                if (data.method) {\r\n                    console.log(`[Frontend] ✅ Control via: ${data.method.toUpperCase()}`);\r\n                }\r\n                return { success: true, data: data.data, method: data.method };\r\n            } else {\r\n                return { success: false, message: data.message || data.error || 'Failed to control device.' };\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(`[Frontend] Error calling proxy API:`, error);\r\n            if (error.name === 'AbortError') {\r\n                return { success: false, message: 'Request timed out.' };\r\n            }\r\n            if (error.message.includes('Failed to fetch')) {\r\n                return { success: false, message: 'Network error.' };\r\n            }\r\n            return { success: false, message: error.message };\r\n        }\r\n    }\r\n\r\n    // Gate Control Functions\r\n    async function handleGateButtonClick(gateType) {\r\n        const gate = state.gateSettings?.[gateType];\r\n        const button = document.getElementById(`${gateType}-gate-btn`);\r\n        \r\n        if (!gate) {\r\n            console.error(`Gate settings for ${gateType} not found!`);\r\n            playCustomTTS('Gate not configured.');\r\n            return;\r\n        }\r\n        \r\n        if (!gate.isManaged) {\r\n            playCustomTTS(`${gate.label} control is disabled. Long-press to configure.`);\r\n            return;\r\n        }\r\n        \r\n        console.log(`[Gate] Activating ${gate.label}...`);\r\n        \r\n        // Disable button during pulse\r\n        button.disabled = true;\r\n        button.classList.add('pulsing');\r\n        \r\n        // Send pulse command (turn on, will auto-off after 1 second via cloud API)\r\n        const apiResult = await sendLightCommand(gate, true);\r\n        \r\n        // Keep pulsing animation for full 1 second\r\n        setTimeout(() => {\r\n            button.classList.remove('pulsing');\r\n            button.disabled = false;\r\n        }, 1000);\r\n        \r\n        if (apiResult.success) {\r\n            console.log(`[Gate] ${gate.label} activated successfully via ${apiResult.method}`);\r\n            playCustomTTS(`${gate.label} activated.`);\r\n        } else {\r\n            console.error(`[Gate] Failed to activate ${gate.label}:`, apiResult.message);\r\n            playCustomTTS(`Error: Failed to activate ${gate.label}.`);\r\n        }\r\n    }\r\n\r\n    function setupGateButtonLongPress(gateType) {\r\n        const button = document.getElementById(`${gateType}-gate-btn`);\r\n        if (!button) return;\r\n        \r\n        // Pointer down - start timer\r\n        button.addEventListener('pointerdown', (e) => {\r\n            gateButtonIsLongPress = false;\r\n            \r\n            gateButtonPressTimer = setTimeout(() => {\r\n                gateButtonIsLongPress = true;\r\n                console.log(`[Gate] Long press detected on ${gateType}`);\r\n                \r\n                // Visual feedback\r\n                button.style.transform = 'scale(0.95)';\r\n                \r\n                // Show settings modal\r\n                showGateSettingsModal(gateType);\r\n                \r\n            }, 800); // 800ms for long press\r\n        });\r\n        \r\n        // Pointer up - either short click or cancel long press\r\n        button.addEventListener('pointerup', (e) => {\r\n            if (gateButtonPressTimer) {\r\n                clearTimeout(gateButtonPressTimer);\r\n            }\r\n            \r\n            button.style.transform = '';\r\n            \r\n            // Only trigger click if it wasn't a long press\r\n            if (!gateButtonIsLongPress) {\r\n                handleGateButtonClick(gateType);\r\n            }\r\n            \r\n            gateButtonIsLongPress = false;\r\n        });\r\n        \r\n        // Pointer leave - cancel timer\r\n        button.addEventListener('pointerleave', (e) => {\r\n            if (gateButtonPressTimer) {\r\n                clearTimeout(gateButtonPressTimer);\r\n            }\r\n            button.style.transform = '';\r\n            gateButtonIsLongPress = false;\r\n        });\r\n    }\r\n\r\n    // ============================================================================\r\n    // GATE SETTINGS MODAL FUNCTIONS (SEPARATE MODALS)\r\n    // ============================================================================\r\n\r\n    function showGateSettingsModal(gateType) {\r\n        const modal = document.getElementById(`${gateType}-gate-settings-modal`);\r\n        const gate = state.gateSettings?.[gateType] || {\r\n            shellyCloudId: '',\r\n            shellyDeviceId: '',\r\n            isManaged: false\r\n        };\r\n        \r\n        // Populate fields\r\n        document.getElementById(`${gateType}-gate-managed`).checked = gate.isManaged;\r\n        document.getElementById(`${gateType}-gate-cloud-id`).value = gate.shellyCloudId || '';\r\n        document.getElementById(`${gateType}-gate-local-ip`).value = gate.shellyDeviceId || '';\r\n        \r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n    function saveGateSettings(gateType) {\r\n        // Initialize gateSettings if it doesn't exist\r\n        if (!state.gateSettings) {\r\n            state.gateSettings = {\r\n                pedestrian: { label: 'Pedestrian Gate', toggleAfter: 1 },\r\n                parking: { label: 'Parking Lot Gate', toggleAfter: 1 }\r\n            };\r\n        }\r\n        \r\n        // Ensure this gate exists\r\n        if (!state.gateSettings[gateType]) {\r\n            state.gateSettings[gateType] = {\r\n                label: gateType === 'pedestrian' ? 'Pedestrian Gate' : 'Parking Lot Gate',\r\n                toggleAfter: 1\r\n            };\r\n        }\r\n        \r\n        // Save settings\r\n        state.gateSettings[gateType].isManaged = document.getElementById(`${gateType}-gate-managed`).checked;\r\n        state.gateSettings[gateType].shellyCloudId = document.getElementById(`${gateType}-gate-cloud-id`).value.trim();\r\n        state.gateSettings[gateType].shellyDeviceId = document.getElementById(`${gateType}-gate-local-ip`).value.trim();\r\n        state.gateSettings[gateType].toggleAfter = 1;  // Always 1 second for gates\r\n        \r\n        // Clear settings if not managed\r\n        if (!state.gateSettings[gateType].isManaged) {\r\n            state.gateSettings[gateType].shellyCloudId = '';\r\n            state.gateSettings[gateType].shellyDeviceId = '';\r\n        }\r\n        \r\n        console.log(`[Gate Settings] Saved ${gateType}:`, state.gateSettings[gateType]);\r\n        \r\n        saveState();\r\n        document.getElementById(`${gateType}-gate-settings-modal`).classList.add('hidden');\r\n        playCustomTTS(`${state.gateSettings[gateType].label} settings saved.`);\r\n    }\r\n\r\n    // Event Listeners (add these in your DOMContentLoaded section)\r\n    document.getElementById('pedestrian-gate-btn')?.addEventListener('click', () => {\r\n        handleGateButtonClick('pedestrian');\r\n    });\r\n\r\n    document.getElementById('parking-gate-btn')?.addEventListener('click', () => {\r\n        handleGateButtonClick('parking');\r\n    }); \r\n\r\n\r\n    function setupCourtLightLongPress() {\r\n        // This should be called after court cards are rendered\r\n        const lightButtons = document.querySelectorAll('.light-toggle-btn');\r\n        \r\n        lightButtons.forEach(button => {\r\n            const courtId = button.dataset.courtId;\r\n            \r\n            // Pointer down - start timer\r\n            button.addEventListener('pointerdown', (e) => {\r\n                lightIconIsLongPress = false;\r\n                \r\n                lightIconPressTimer = setTimeout(() => {\r\n                    lightIconIsLongPress = true;\r\n                    console.log(`[Light] Long press detected on Court ${courtId}`);\r\n                    \r\n                    // Visual feedback\r\n                    button.style.transform = 'scale(0.9)';\r\n                    \r\n                    // Show settings modal for this court\r\n                    showLightSettingsForCourt(courtId);\r\n                    \r\n                }, 800); // 800ms for long press\r\n            });\r\n            \r\n            // Pointer up - check if it was a long press\r\n            button.addEventListener('pointerup', (e) => {\r\n                if (lightIconPressTimer) {\r\n                    clearTimeout(lightIconPressTimer);\r\n                }\r\n                \r\n                button.style.transform = '';\r\n                \r\n                // If it WAS a long press, don't toggle the light\r\n                if (lightIconIsLongPress) {\r\n                    e.stopPropagation();\r\n                    e.preventDefault();\r\n                }\r\n                // Otherwise, the existing handleLightToggleChange will handle it\r\n                \r\n                lightIconIsLongPress = false;\r\n            });\r\n            \r\n            // Pointer leave - cancel timer\r\n            button.addEventListener('pointerleave', (e) => {\r\n                if (lightIconPressTimer) {\r\n                    clearTimeout(lightIconPressTimer);\r\n                }\r\n                button.style.transform = '';\r\n                lightIconIsLongPress = false;\r\n            });\r\n        });\r\n    }\r\n\r\n    function showLightSettingsForCourt(courtId) {\r\n        const modal = document.getElementById('light-settings-court-modal');\r\n        const court = state.lightSettings?.courts?.[courtId];\r\n        \r\n        if (!court) {\r\n            console.error(`No light settings for court ${courtId}`);\r\n            playCustomTTS('Court light settings not found.');\r\n            return;\r\n        }\r\n        \r\n        // Update modal title\r\n        document.getElementById('light-settings-court-title').textContent = `Court ${courtId} Light Settings`;\r\n        \r\n        // Store which court we're editing\r\n        modal.dataset.editingCourtId = courtId;\r\n        \r\n        // Load global settings (same for all courts)\r\n        document.getElementById('light-setting-base-url').value = state.lightSettings.shellyBaseUrl || '';\r\n        document.getElementById('light-setting-auth-key').value = state.lightSettings.shellyAuthKey || '';\r\n        \r\n        // Load court-specific settings\r\n        document.getElementById('light-setting-label').value = court.label || `Court ${courtId} Lights`;\r\n        document.getElementById('light-setting-cloud-id').value = court.shellyCloudId || '';\r\n        document.getElementById('light-setting-local-ip').value = court.shellyDeviceId || '';\r\n        document.getElementById('light-setting-managed').checked = court.isManaged || false;\r\n        \r\n        modal.classList.remove('hidden');\r\n        // ← ADD THESE 5 LINES HERE (before closing brace):\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-base-url'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-auth-key'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-label'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-cloud-id'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-local-ip'));\r\n    }\r\n    \r\n\r\n    // Call this after rendering courts\r\n    // Add to your renderCourts() function or wherever courts are created:\r\n    // setupCourtLightLongPress();\r\n\r\n\r\n\r\n    // ADDED FUNCTION - This is the core logic for the light feature.\r\n    async function handleLightToggleChange(e) {\r\n        const button = e.target.closest('.light-toggle-btn');\r\n        if (!button) return;\r\n\r\n        const courtId = button.dataset.courtId;\r\n        const light = state.lightSettings.courts[courtId];\r\n        \r\n        if (light) {\r\n            // Toggle the state\r\n            const isActive = !light.isActive;\r\n            \r\n            // Optimistically update UI\r\n            light.isActive = isActive;\r\n            const icon = button.querySelector('i');\r\n            icon.className = `mdi ${isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline'}`;\r\n            \r\n            // Send command\r\n            const apiResult = await sendLightCommand(light, isActive);\r\n\r\n            if (!apiResult.success) {\r\n                // Revert state and UI if API call fails\r\n                light.isActive = !isActive;\r\n                icon.className = `mdi ${!isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline'}`;\r\n                playCustomTTS(`Error: Failed to turn light ${isActive ? 'on' : 'off'}. ${apiResult.message}`);\r\n            } else {\r\n                playCustomTTS(`${light.label} turned ${isActive ? 'on' : 'off'}.`);\r\n            }\r\n            saveState();\r\n        }\r\n    }\r\n\r\n\r\n    // Now checks if stock is < 1 can to disable sign out buttons.\r\n    function updateBallStockDisplay() {\r\n        if (ballStockCount) {\r\n            ballStockCount.textContent = state.ballManagement.stock;\r\n\r\n            const isStockLow = state.ballManagement.stock < 1;\r\n            signOutOptions.querySelectorAll('.sign-out-btn').forEach(btn => {\r\n                btn.disabled = isStockLow;\r\n                btn.style.opacity = isStockLow ? 0.5 : 1;\r\n            });\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Updates the display for single used balls\r\n    function updateUsedBallStockDisplay() {\r\n        if (usedBallStockCount) {\r\n            usedBallStockCount.textContent = state.ballManagement.usedStock;\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Initial Entry Point for Returning Used Balls\r\n    function handleReturnUsedBalls() {\r\n        showMemberSelectionModal('return_used');\r\n    }\r\n\r\n    // NEW FUNCTION: Final Confirmation for USED BALL RETURN\r\n    function confirmUsedBallReturn() {\r\n        const value = parseInt(keypadDisplay.textContent, 10);\r\n        const member = customKeypadModal.dataset.member;\r\n        hideKeypad();\r\n\r\n        if (isNaN(value) || value <= 0) return;\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Used Ball Return\";\r\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm returning ${value} used ball(s), signed in by ${member}?`;\r\n        modalBtnYesConfirm.textContent = \"Confirm Return\";\r\n        modalBtnNo.textContent = \"Cancel\";\r\n        cancelConfirmModal.dataset.mode = \"returnUsedBalls\";\r\n        cancelConfirmModal.dataset.count = value;\r\n        cancelConfirmModal.dataset.member = member;\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // NEW FUNCTION: Execute USED BALL RETURN\r\n    function executeUsedBallReturn() {\r\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\r\n        const member = cancelConfirmModal.dataset.member;\r\n        if (isNaN(count) || count <= 0) return;\r\n\r\n        const stockBefore = state.ballManagement.usedStock;\r\n        state.ballManagement.usedStock += count;\r\n        const stockAfter = state.ballManagement.usedStock;\r\n\r\n        state.ballManagement.history.push({\r\n            timestamp: Date.now(), action: 'in', category: 'return_used',\r\n            count: count, member: member, stockBefore: stockBefore, stockAfter: stockAfter\r\n        });\r\n\r\n        //playCustomTTS(`Stock updated. Returned ${count} used balls.`);\r\n        updateUsedBallStockDisplay();\r\n        saveState();\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n        ballManagementModal.classList.remove(\"hidden\");\r\n        resetConfirmModal();\r\n    }  \r\n\r\n    // NEW FUNCTION: Handles ball history filter changes\r\n    function handleBallHistoryFilterChange(e) {\r\n        state.ballManagement.historyFilter = e.target.value;\r\n        saveState();\r\n        renderBallHistoryModal();\r\n    }\r\n\r\n    function showBallManagementModal() {\r\n        updateBallStockDisplay();\r\n        updateUsedBallStockDisplay(); // <-- ADD THIS LINE\r\n        adminSettingsModal.classList.add('hidden');\r\n        ballManagementModal.classList.remove('hidden');\r\n    }\r\n\r\n    // --- REFACTORED WORKFLOW ---\r\n\r\n    // 1. Initial Entry Point for Add/Return\r\n    function handleAddStock() {\r\n        showMemberSelectionModal('add');\r\n    }\r\n\r\n    function handleReturnStock() {\r\n        showMemberSelectionModal('return');\r\n    }\r\n\r\n    // NEW FUNCTION: Handles the selection of Cans or Singles for a Sale\r\n    function handleSaleStockTypeSelection(stockType) {\r\n        if (stockType === 'cans' && state.ballManagement.stock === 0) {\r\n            playCustomTTS(\"Cannot sell cans. Stock is empty.\");\r\n            return;\r\n        }\r\n        if (stockType === 'singles' && state.ballManagement.usedStock === 0) {\r\n            playCustomTTS(\"Cannot sell old balls. Used stock is empty.\");\r\n            return;\r\n        }\r\n\r\n        // Store the selection\r\n        state.ballManagement.tempSale.stockType = stockType;\r\n        \r\n        ballSaleTypeModal.classList.add('hidden');\r\n        \r\n        // Next step is always to select the committee member who is signing out the stock\r\n        // The category is hardcoded as 'Sale' to trigger the custom sale flow in handleMemberSelectionConfirm\r\n        showMemberSelectionModal('signout', 'Sale');\r\n    }\r\n\r\n    // NEW FUNCTION: Confirms the purchaser and proceeds to quantity keypad (Step 4 is skipped)\r\n    function confirmPurchaser(purchaserName, purchaserType) {\r\n        const tempSale = state.ballManagement.tempSale;\r\n        const memberSignOut = tempSale.memberSignOut; // Committee member's name\r\n\r\n        tempSale.purchaserName = purchaserName;\r\n        tempSale.purchaserType = purchaserType;\r\n        \r\n        // Close the relevant modal if it's not already closed\r\n        guestNameModal.classList.add('hidden');\r\n        document.getElementById('returning-guest-modal').classList.add('hidden');\r\n        purchaserSelectionModal.classList.add('hidden');\r\n\r\n        // CRITICAL FIX: Ensure ALL required context variables are set on the keypad modal\r\n        customKeypadModal.dataset.member = memberSignOut; \r\n        customKeypadModal.dataset.action = 'signout'; \r\n        customKeypadModal.dataset.purchaserName = purchaserName; \r\n        customKeypadModal.dataset.category = 'Sale'; // <-- FIX: Set the category explicitly here!\r\n\r\n        // Proceed to quantity keypad\r\n        showKeypad(null, { \r\n            mode: 'signOut', \r\n            maxLength: 2, \r\n            title: `Quantity for ${purchaserName}` \r\n        });\r\n    }\r\n\r\n    // 2. Initial Entry Point for Sign Out\r\n    function handleSignOut(e) {\r\n        const button = e.target.closest('.sign-out-btn');\r\n        if (!button) return;\r\n\r\n        if (button.disabled) {\r\n            //playCustomTTS(\"Sign out requires balls. Please add stock first.\");\r\n            return;\r\n        }\r\n\r\n        const category = button.dataset.category;\r\n\r\n        // --- NEW LOGIC: Start sale flow if category is 'Sale' ---\r\n        if (category === 'Sale') {\r\n            // CRITICAL FIX: Clear temporary sale state before starting new flow\r\n            state.ballManagement.tempSale = { stockType: null, memberSignOut: null, purchaserName: null, purchaserType: null };\r\n            ballManagementModal.classList.add('hidden');\r\n            ballSaleTypeModal.classList.remove('hidden');\r\n            return;\r\n        }\r\n        // --- END NEW LOGIC ---\r\n\r\n        showMemberSelectionModal('signout', category);\r\n    }\r\n\r\n// 3. Generalized Member Selection Modal\r\n    function showMemberSelectionModal(action, category = null) {\r\n        signOutMemberList.innerHTML = '';\r\n        const indexElement = document.getElementById('sign-out-member-abc-index'); // Get index element\r\n\r\n        // Set modal prompt based on the action\r\n        // ... (rest of the prompt setting logic remains the same) ...\r\n\r\n        // Store action context in the modal\r\n        // ... (rest of the dataset setting logic remains the same) ...\r\n\r\n        const members = MASTER_MEMBER_LIST.filter(m => m.committee).sort((a, b) => a.name.localeCompare(b.name));\r\n\r\n        if (members.length === 0) {\r\n            signOutMemberList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No committee members found.</li>';\r\n            indexElement.innerHTML = ''; // Clear index if list is empty\r\n            // ... (rest of the return logic remains the same) ...\r\n            return;\r\n        }\r\n\r\n        signOutMemberConfirmBtn.disabled = true;\r\n\r\n        members.forEach(member => {\r\n            const li = document.createElement('li');\r\n            li.className = 'committee-member';\r\n            li.dataset.player = member.name; // Use data-player for consistency\r\n            // --- ADD data-player-name attribute for index ---\r\n            li.dataset.playerName = member.name;\r\n            // --- END ADD ---\r\n            li.innerHTML = `<label><input type=\"radio\" name=\"signoutMember\" value=\"${member.name}\"><div class=\"member-details\"><span class=\"member-name\">${member.name}</span><span class=\"member-designation\">${member.committee || 'Member'}</span></div></label>`;\r\n            signOutMemberList.appendChild(li);\r\n        });\r\n\r\n        signOutMemberList.querySelectorAll('input[name=\"signoutMember\"]').forEach(radio => {\r\n            // Re-bind listener: remove old, add new\r\n            radio.removeEventListener('change', enableSignOutConfirm); // Use named function\r\n            radio.addEventListener('change', enableSignOutConfirm);    // Use named function\r\n        });\r\n\r\n        // --- ADD THIS LINE ---\r\n        setupListWithIndex(members, signOutMemberList, indexElement);\r\n        // --- END ADD ---\r\n\r\n        adminSettingsModal.classList.add('hidden');\r\n        ballManagementModal.classList.add('hidden');\r\n        signOutMemberModal.classList.remove('hidden');\r\n    }\r\n\r\n    // --- NEW HELPER FUNCTION FOR ENABLING CONFIRM BUTTON ---\r\n    function enableSignOutConfirm() {\r\n        signOutMemberConfirmBtn.disabled = false;\r\n    }\r\n    // --- END NEW HELPER FUNCTION ---\r\n\r\n    // 4. Generalized Member Confirmation and Keypad Trigger\r\n    function handleMemberSelectionConfirm() {\r\n        const action = signOutMemberModal.dataset.action;\r\n        const member = signOutMemberList.querySelector('input[name=\"signoutMember\"]:checked').value;\r\n        \r\n        // --- NEW LOGIC: If it's a sale, redirect to purchaser selection first ---\r\n        if (action === 'signout' && signOutMemberModal.dataset.category === 'Sale' && !state.ballManagement.tempSale.memberSignOut) {\r\n            signOutMemberModal.classList.add('hidden');\r\n            // This is the committee member who is signing out, pass their name to the next step\r\n            showPurchaserSelectionModal(member); \r\n            return;\r\n        }\r\n        // --- END NEW LOGIC ---\r\n\r\n        customKeypadModal.dataset.member = member;\r\n        customKeypadModal.dataset.action = action;\r\n\r\n        signOutMemberModal.classList.add('hidden');\r\n\r\n        if (action === 'add') {\r\n            showKeypad(null, { mode: 'addStock', maxLength: 3, title: `Cans to add for ${member}` });\r\n        } else if (action === 'return') {\r\n            showKeypad(null, { mode: 'returnStock', maxLength: 3, title: `Cans to return for ${member}` });\r\n        } else if (action === 'return_used') {\r\n            showKeypad(null, { mode: 'returnUsed', maxLength: 3, title: `Used balls to return for ${member}` });\r\n        } else if (action === 'signout') {\r\n            const category = signOutMemberModal.dataset.category;\r\n            customKeypadModal.dataset.category = category;\r\n            \r\n            // CRITICAL FIX: For a non-sale signout, manually set required data attributes on the keypad modal\r\n            const stockType = 'cans';\r\n            const purchaserName = member;\r\n\r\n            customKeypadModal.dataset.stockType = stockType; \r\n            customKeypadModal.dataset.purchaserName = purchaserName; \r\n            \r\n            showKeypad(null, { mode: 'signOut', maxLength: 2, title: `Cans for ${member} (${category})` });\r\n        }\r\n    }\r\n\r\n    // 5a. Final Confirmation for ADD\r\n    function confirmBallStockUpdate() {\r\n        const value = parseInt(keypadDisplay.textContent, 10);\r\n        const member = customKeypadModal.dataset.member;\r\n        hideKeypad();\r\n\r\n        if (isNaN(value) || value <= 0) return;\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Purchase\";\r\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm adding ${value} new cans, signed in by ${member}?`;\r\n        modalBtnYesConfirm.textContent = \"Confirm Add\";\r\n        modalBtnNo.textContent = \"Cancel\";\r\n        cancelConfirmModal.dataset.mode = \"addBallStock\";\r\n        cancelConfirmModal.dataset.count = value;\r\n        cancelConfirmModal.dataset.member = member;\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // 5b. Final Confirmation for RETURN\r\n    function confirmBallStockReturn() {\r\n        const value = parseInt(keypadDisplay.textContent, 10);\r\n        const member = customKeypadModal.dataset.member;\r\n        hideKeypad();\r\n\r\n        if (isNaN(value) || value <= 0) return;\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Return\";\r\n        cancelConfirmModal.querySelector(\"p\").textContent = `Confirm returning ${value} can(s), signed in by ${member}?`;\r\n        modalBtnYesConfirm.textContent = \"Confirm Return\";\r\n        modalBtnNo.textContent = \"Cancel\";\r\n        cancelConfirmModal.dataset.mode = \"returnBallStock\";\r\n        cancelConfirmModal.dataset.count = value;\r\n        cancelConfirmModal.dataset.member = member;\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // 5c. Final Confirmation for SIGN OUT\r\n    function confirmSignOutQuantity() {\r\n        const cansToSignOut = parseInt(keypadDisplay.textContent, 10);\r\n        const category = customKeypadModal.dataset.category;\r\n        const member = customKeypadModal.dataset.member;\r\n        \r\n        // --- CONTEXT VARIABLES ---\r\n        const tempSale = state.ballManagement.tempSale;\r\n        \r\n        // For sale transactions, pull all context from tempSale. For non-sale, use defaults.\r\n        const isSale = category === 'Sale';\r\n\r\n        // stockType is 'cans' by default for non-sale (League, Social)\r\n        const stockType = isSale ? tempSale.stockType : 'cans'; \r\n        \r\n        // purchaserName is the member's name by default for non-sale\r\n        const purchaserName = isSale ? tempSale.purchaserName : member; \r\n        \r\n        const currentStock = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\r\n        // --- END CONTEXT VARIABLES ---\r\n\r\n        hideKeypad();\r\n\r\n        if (isNaN(cansToSignOut) || cansToSignOut <= 0 || cansToSignOut > currentStock) {\r\n            //playCustomTTS(\"Sign out failed. Invalid quantity or insufficient stock.\");\r\n            return;\r\n        }\r\n\r\n        // Determine modal title based on context\r\n        const modalTitle = isSale\r\n            ? `Confirm Sign Out: ${stockType === 'cans' ? 'New Balls' : 'Old Balls'}` \r\n            : `Confirm Sign Out: ${category}`;\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = modalTitle;\r\n        \r\n        // Determine prompt text:\r\n        let promptText;\r\n        if (isSale) {\r\n            // Sale prompt: uses stockType and purchaserName\r\n            promptText = `Confirm signing out ${cansToSignOut} ${stockType} to ${purchaserName}, by ${member}?`; \r\n        } else {\r\n            // Non-Sale prompt: uses 'can(s)' and category (the fix)\r\n            promptText = `Confirm signing out ${cansToSignOut} can(s) for ${category}, by ${member}?`;\r\n        }\r\n            \r\n        cancelConfirmModal.querySelector(\"p\").textContent = promptText;\r\n        modalBtnYesConfirm.textContent = \"Confirm Sign Out\";\r\n        modalBtnNo.textContent = \"Cancel\";\r\n        cancelConfirmModal.dataset.mode = \"signOutBalls\";\r\n        \r\n        // Ensure all data is passed to the final execution step\r\n        cancelConfirmModal.dataset.category = category;\r\n        cancelConfirmModal.dataset.count = cansToSignOut;\r\n        cancelConfirmModal.dataset.member = member;\r\n        cancelConfirmModal.dataset.stockType = stockType; \r\n        cancelConfirmModal.dataset.purchaserName = purchaserName; \r\n        \r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // 6a. Execute ADD\r\n    function executeAddBallStock() {\r\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\r\n        const member = cancelConfirmModal.dataset.member;\r\n        if (isNaN(count) || count <= 0) return;\r\n\r\n        const stockBefore = state.ballManagement.stock;\r\n        state.ballManagement.stock += count;\r\n        const stockAfter = state.ballManagement.stock;\r\n\r\n        state.ballManagement.history.push({\r\n            timestamp: Date.now(), action: 'in', category: 'purchase',\r\n            count: count, member: member, stockBefore: stockBefore, stockAfter: stockAfter\r\n        });\r\n\r\n        //playCustomTTS(`Stock updated. Added ${count} cans.`);\r\n        updateBallStockDisplay();\r\n        saveState();\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n        ballManagementModal.classList.remove(\"hidden\");\r\n        resetConfirmModal(); // ADD THIS LINE\r\n    }\r\n\r\n    // 6b. Execute RETURN\r\n    function executeReturnBallStock() {\r\n        const count = parseInt(cancelConfirmModal.dataset.count, 10);\r\n        const member = cancelConfirmModal.dataset.member;\r\n        if (isNaN(count) || count <= 0) return;\r\n\r\n        const stockBefore = state.ballManagement.stock;\r\n        state.ballManagement.stock += count;\r\n        const stockAfter = state.ballManagement.stock;\r\n\r\n        state.ballManagement.history.push({\r\n            timestamp: Date.now(), action: 'in', category: 'return',\r\n            count: count, member: member, stockBefore: stockBefore, stockAfter: stockAfter\r\n        });\r\n\r\n        //playCustomTTS(`Stock updated. Returned ${count} cans.`);\r\n        updateBallStockDisplay();\r\n        saveState();\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n        ballManagementModal.classList.remove(\"hidden\");\r\n        resetConfirmModal(); // ADD THIS LINE\r\n    }\r\n\r\n    // 6c. Execute SIGN OUT\r\n    function executeSignOutBalls() {\r\n        const cansCount = parseInt(cancelConfirmModal.dataset.count, 10);\r\n        const category = cancelConfirmModal.dataset.category;\r\n        const member = cancelConfirmModal.dataset.member;\r\n        \r\n        // --- NEW CONTEXT VARIABLES ---\r\n        const stockType = cancelConfirmModal.dataset.stockType;\r\n        const purchaserName = cancelConfirmModal.dataset.purchaserName;\r\n        const currentStock = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\r\n        // --- END NEW CONTEXT VARIABLES ---\r\n\r\n        if (isNaN(cansCount) || currentStock < cansCount) {\r\n            playCustomTTS(\"Sign out failed. Insufficient stock.\");\r\n            return;\r\n        }\r\n\r\n        const stockBefore = currentStock;\r\n        if (stockType === 'cans') {\r\n            state.ballManagement.stock -= cansCount;\r\n        } else {\r\n            state.ballManagement.usedStock -= cansCount;\r\n        }\r\n        const stockAfter = stockType === 'cans' ? state.ballManagement.stock : state.ballManagement.usedStock;\r\n\r\n        state.ballManagement.history.push({\r\n            timestamp: Date.now(), action: 'out', category: category,\r\n            count: cansCount, member: member, stockBefore: stockBefore, stockAfter: stockAfter\r\n        });\r\n\r\n        // --- NEW HISTORY FIELDS & CLEAR TEMPORARY STATE ---\r\n        state.ballManagement.history[state.ballManagement.history.length - 1].stockType = stockType;\r\n        state.ballManagement.history[state.ballManagement.history.length - 1].purchaserName = purchaserName;\r\n        state.ballManagement.tempSale = { stockType: null, memberSignOut: null, purchaserName: null, purchaserType: null };\r\n        // --- END NEW ---\r\n\r\n        playCustomTTS(`Signed out ${cansCount} ${stockType} to ${purchaserName}, by ${member}.`);\r\n        updateBallStockDisplay();\r\n        updateUsedBallStockDisplay();\r\n        saveState();\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n        ballManagementModal.classList.remove(\"hidden\");\r\n        resetConfirmModal(); // ADD THIS LINE\r\n    }\r\n    \r\n    function renderBallHistoryModal() {\r\n        ballHistoryList.innerHTML = ''; // Clear previous content\r\n\r\n        const filter = state.ballManagement.historyFilter;\r\n\r\n        // 1. Create the HTML for the filter radio buttons\r\n        const filterHTML = `\r\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\r\n                <div class=\"radio-group\">\r\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"all\" ${filter === 'all' ? 'checked' : ''}> All </label>\r\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"new\" ${filter === 'new' ? 'checked' : ''}> New </label>\r\n                    <label> <input type=\"radio\" name=\"ball-history-filter\" value=\"used\" ${filter === 'used' ? 'checked' : ''}> Used </label>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // 2. Filter the history based on the current state\r\n        const filteredHistory = state.ballManagement.history.filter(entry => {\r\n            if (filter === 'all') return true;\r\n            // Determine if the entry relates to used balls (singles or return_used category)\r\n            const isUsed = entry.stockType === 'singles' || entry.category === 'return_used';\r\n            if (filter === 'used') return isUsed;\r\n            if (filter === 'new') return !isUsed;\r\n            return true;\r\n        });\r\n\r\n        if (filteredHistory.length === 0) {\r\n            ballHistoryList.innerHTML = filterHTML + '<p style=\"text-align: center; color: #6c757d;\">No transactions match the selected filter.</p>';\r\n        } else {\r\n            // 3. Build the rest of the list using the filtered data\r\n            // --- MODIFIED HEADER: Removed Committee Member ---\r\n            const headerHTML = `\r\n                <div class=\"history-item\" style=\"border-bottom: 2px solid var(--primary-blue); font-weight: bold; background-color: #f8f9fa; cursor: default;\">\r\n                    <div class=\"ball-history-details\">\r\n                        <span>Date & Time</span>\r\n                        <span class=\"numeric\">Before</span>\r\n                        <span class=\"numeric\">Change</span>\r\n                        <span class=\"numeric\">After</span>\r\n                    </div>\r\n                </div>\r\n            `;\r\n\r\n            const historyItemsHTML = [...filteredHistory].reverse().map(entry => {\r\n                const dateTime = new Date(entry.timestamp).toLocaleString('en-ZA');\r\n                // --- MODIFIED CHANGE DISPLAY: Removed purchaser ---\r\n                const change = entry.action === 'in' ? `+${entry.count}` : `-${entry.count}`;\r\n                const changeClass = entry.action === 'in' ? 'stock-in' : 'stock-out';\r\n                const isUsedBalls = entry.stockType === 'singles' || entry.category === 'return_used';\r\n                const stockClass = isUsedBalls ? 'stock-used' : 'stock-new';\r\n\r\n                // --- MODIFIED ROW: Removed Committee Member, Added data-entry-id ---\r\n                return `\r\n                    <div class=\"history-item\" data-entry-id=\"${entry.timestamp}\">\r\n                        <div class=\"ball-history-details\">\r\n                            <span class=\"timestamp\">${dateTime}</span>\r\n                            <span class=\"numeric ${stockClass}\" data-label=\"Before\">${entry.stockBefore}</span>\r\n                            <span class=\"numeric ${changeClass}\" data-label=\"Change\">${change}</span>\r\n                            <span class=\"numeric ${stockClass}\" data-label=\"After\">${entry.stockAfter}</span>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n            }).join('');\r\n\r\n            ballHistoryList.innerHTML = filterHTML + headerHTML + historyItemsHTML;\r\n        }\r\n\r\n        // 4. Attach event listeners to the new radio buttons\r\n        ballHistoryList.querySelectorAll('input[name=\"ball-history-filter\"]').forEach(radio => {\r\n            radio.addEventListener('change', handleBallHistoryFilterChange);\r\n        });\r\n\r\n        // 5. NEW: Add click listener for list items (delegated)\r\n        ballHistoryList.removeEventListener('click', handleBallHistoryItemClick); // Prevent duplicates\r\n        ballHistoryList.addEventListener('click', handleBallHistoryItemClick);\r\n    }\r\n\r\n    // NEW FUNCTION: Handles clicks on ball history items\r\n    function handleBallHistoryItemClick(e) {\r\n        const historyItem = e.target.closest('.history-item[data-entry-id]');\r\n        if (historyItem) {\r\n            const entryId = parseInt(historyItem.dataset.entryId, 10);\r\n            const entry = state.ballManagement.history.find(item => item.timestamp === entryId);\r\n            if (entry) {\r\n                showBallHistoryDetailModal(entry);\r\n            }\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Shows the detailed ball history modal\r\n    function showBallHistoryDetailModal(entry) {\r\n        // Populate the modal fields\r\n        const stockType = (entry.stockType === 'singles' || entry.category === 'return_used') ? 'Used Balls (Singles)' : 'New Balls (Cans)';\r\n        detailStockType.textContent = stockType;\r\n\r\n        // Format category for display\r\n        let categoryDisplay = entry.category || 'N/A';\r\n        if (categoryDisplay === 'purchase') categoryDisplay = 'Stock Added';\r\n        else if (categoryDisplay === 'return') categoryDisplay = 'Stock Returned';\r\n        else if (categoryDisplay === 'return_used') categoryDisplay = 'Used Balls Returned';\r\n        else if (categoryDisplay === 'ClubChamps') categoryDisplay = 'Club Champs'; // Format display\r\n        categoryDisplay = categoryDisplay.charAt(0).toUpperCase() + categoryDisplay.slice(1); // Capitalize\r\n        detailCategory.textContent = categoryDisplay;\r\n\r\n        detailDatetime.textContent = new Date(entry.timestamp).toLocaleString('en-ZA');\r\n\r\n        const change = entry.action === 'in' ? `+${entry.count}` : `-${entry.count}`;\r\n        detailCount.textContent = change;\r\n        detailCount.style.color = entry.action === 'in' ? 'var(--confirm-color)' : 'var(--cancel-color)';\r\n        detailStockChange.textContent = change; // Also update the stock level change display\r\n        detailStockChange.style.color = entry.action === 'in' ? 'var(--confirm-color)' : 'var(--cancel-color)';\r\n\r\n        // --- NEW: Dynamically set Committee Member Label ---\r\n        const committeeLabel = document.getElementById('detail-committee-label');\r\n        if (committeeLabel) {\r\n            committeeLabel.textContent = entry.action === 'in' ? 'Committee Member (Sign In)' : 'Committee Member (Sign Out)';\r\n        }\r\n        // --- END NEW ---\r\n        detailCommitteeMember.textContent = entry.member || 'N/A';\r\n\r\n\r\n        // --- THIS IS THE MODIFIED LOGIC for Purchaser/Recipient ---\r\n        let purchaserDisplay = 'N/A'; // Default\r\n        const nonSaleSignOuts = ['Social', 'League', 'ClubChamps'];\r\n        if (entry.action === 'out' && nonSaleSignOuts.includes(entry.category)) {\r\n            // For Social, League, ClubChamps, show the category\r\n            purchaserDisplay = categoryDisplay; // Use the formatted category name\r\n        } else if (entry.purchaserName) {\r\n            // For Sales or other types with a purchaserName, show that name\r\n            purchaserDisplay = entry.purchaserName;\r\n        }\r\n        detailPurchaser.textContent = purchaserDisplay;\r\n        // --- END MODIFIED LOGIC ---\r\n\r\n        // Show/hide purchaser based on whether there's relevant info to display\r\n        const purchaserRow = detailPurchaser.closest('.stat-item');\r\n        if (purchaserRow) {\r\n            // Show if it's a non-sale sign-out category OR if there's an actual purchaser name\r\n            purchaserRow.style.display = (entry.action === 'out' && nonSaleSignOuts.includes(entry.category)) || entry.purchaserName ? 'flex' : 'none';\r\n        }\r\n\r\n        detailStockBefore.textContent = entry.stockBefore;\r\n        detailStockAfter.textContent = entry.stockAfter;\r\n\r\n        // Show the modal\r\n        ballHistoryModal.classList.add('hidden'); // Hide the list modal\r\n        ballHistoryDetailModal.classList.remove('hidden');\r\n    }\r\n\r\n    function showBallHistoryModal() {\r\n        renderBallHistoryModal();\r\n        ballManagementModal.classList.add('hidden');\r\n        ballHistoryModal.classList.remove('hidden');\r\n    }\r\n\r\n    // NEW FUNCTION: Show the modal to select the purchaser\r\n    function showPurchaserSelectionModal(memberSignOutName) {\r\n        const tempSale = state.ballManagement.tempSale;\r\n        const stockType = tempSale.stockType;\r\n        const stockDisplay = stockType === 'cans' ? 'can(s) of new balls' : 'old ball(s)';\r\n        \r\n        tempSale.memberSignOut = memberSignOutName;\r\n        \r\n        purchaserSelectionPrompt.textContent = `Who is purchasing the ${stockDisplay} signed out by ${memberSignOutName}?`;\r\n        \r\n        // 1. Populate the list with Club Members\r\n        purchaserMemberList.innerHTML = '';\r\n\r\n        // Get all members and guests (from clubMembers, availablePlayers, courts, and guestHistory)\r\n        const allKnownPlayers = getAllKnownPlayers();\r\n        \r\n        // Filter out committee member who signed out, and filter for uniqueness\r\n        const membersAndGuests = allKnownPlayers\r\n            .filter(p => p.name !== memberSignOutName) \r\n            .sort((a, b) => a.name.localeCompare(b.name));\r\n\r\n        if (membersAndGuests.length === 0) {\r\n            purchaserMemberList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No other players found. Please add as a new guest.</li>';\r\n        } else {\r\n            membersAndGuests.forEach(player => {\r\n                const li = document.createElement('li');\r\n                li.className = 'committee-member'; // Re-use the styling\r\n                \r\n                // Determine player type for display\r\n                const isGuest = player.guest || !MASTER_MEMBER_LIST.some(m => m.name === player.name);\r\n                const memberData = MASTER_MEMBER_LIST.find(m => m.name === player.name);\r\n                const playerType = isGuest ? 'Guest' : (memberData && memberData.committee ? memberData.committee : 'Member');\r\n                \r\n                li.innerHTML = `<label><input type=\"radio\" name=\"purchaserMember\" value=\"${player.name}\"><div class=\"member-details\"><span class=\"member-name\">${player.name}</span><span class=\"member-designation\">${playerType}</span></div></label>`;\r\n                purchaserMemberList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        purchaserSelectionModal.classList.remove('hidden');\r\n    }\r\n\r\n\r\n    function populateAbcIndex(playerList, listElement, indexElement) {\r\n        const firstLetters = [...new Set(playerList.map(player => player.name[0].toUpperCase()))].sort();\r\n        indexElement.innerHTML = '';\r\n\r\n        const scrollHandler = () => {\r\n            updateActiveIndexLetter(listElement, indexElement);\r\n        };\r\n\r\n        if (listElement._scrollHandler) {\r\n            listElement.removeEventListener('scroll', listElement._scrollHandler);\r\n        }\r\n\r\n        listElement.addEventListener('scroll', scrollHandler);\r\n        listElement._scrollHandler = scrollHandler;\r\n\r\n        firstLetters.forEach(letter => {\r\n            const letterDiv = document.createElement('div');\r\n            letterDiv.textContent = letter;\r\n            letterDiv.addEventListener('click', () => {\r\n                listElement.removeEventListener('scroll', listElement._scrollHandler);\r\n\r\n                const allLetters = indexElement.querySelectorAll('div');\r\n                allLetters.forEach(el => el.classList.remove('active'));\r\n                letterDiv.classList.add('active');\r\n\r\n                const playerToShow = listElement.querySelector(`[data-player-name^=\"${letter}\"], [data-player-name^=\"${letter.toLowerCase()}\"]`);\r\n                if (playerToShow) {\r\n                    playerToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n                }\r\n\r\n                setTimeout(() => {\r\n                    listElement.addEventListener('scroll', listElement._scrollHandler);\r\n                }, 500);\r\n            });\r\n            indexElement.appendChild(letterDiv);\r\n        });\r\n    }\r\n\r\n    function updateActiveIndexLetter(listElement, indexElement) {\r\n        if (!listElement || !indexElement) return;\r\n\r\n        const listTop = listElement.getBoundingClientRect().top;\r\n        const listItems = Array.from(listElement.querySelectorAll('li[data-player-name]'));\r\n        let activeLetter = '';\r\n\r\n        const topItem = listItems.find(item => item.getBoundingClientRect().top >= listTop);\r\n\r\n        if (topItem) {\r\n            activeLetter = topItem.dataset.playerName[0].toUpperCase();\r\n        } else if (listItems.length > 0) {\r\n            activeLetter = listItems[listItems.length - 1].dataset.playerName[0].toUpperCase();\r\n        }\r\n\r\n        const indexLetters = indexElement.querySelectorAll('div');\r\n        indexLetters.forEach(letterDiv => {\r\n            letterDiv.classList.toggle('active', letterDiv.textContent === activeLetter);\r\n        });\r\n\r\n        // --- THIS IS THE FIX ---\r\n        // Find the newly active letter element\r\n        const activeLetterEl = indexElement.querySelector('div.active');\r\n        if (activeLetterEl) {\r\n            // Automatically scroll the index list to make the active letter visible\r\n            activeLetterEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n        }\r\n        // --- END OF FIX ---\r\n    }\r\n    function setupListWithIndex(playerList, listElement, indexElement) {\r\n        populateAbcIndex(playerList, listElement, indexElement);\r\n\r\n        if (listElement._scrollHandler) {\r\n            listElement.removeEventListener('scroll', listElement._scrollHandler);\r\n        }\r\n\r\n        listElement._scrollHandler = () => updateActiveIndexLetter(listElement, indexElement);\r\n\r\n        listElement.addEventListener('scroll', listElement._scrollHandler);\r\n\r\n        setTimeout(() => updateActiveIndexLetter(listElement, indexElement), 50);\r\n\r\n\r\n    }\r\n        \r\n    function updateAlertStatusTimer() {\r\n        if (!alertStatusDisplay) return;\r\n\r\n        // Check current conditions\r\n        const hasEnoughPlayers = getActivePlayerCount() >= 4;\r\n        const isAnyCourtAvailable = findNextAvailableCourtId();\r\n        \r\n        alertStatusDisplay.classList.remove('hidden');\r\n\r\n        if (!hasEnoughPlayers) {\r\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">(${getActivePlayerCount()}/4)</span><span class=\"timer-label\">Waiting for players</span>`;\r\n            return;\r\n        }\r\n\r\n        if (!isAnyCourtAvailable) {\r\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Waiting</span><span class=\"timer-label\">for courts...</span>`;\r\n            return;\r\n        }\r\n\r\n        if (alertScheduleTime === 0) {\r\n             alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Initializing</span><span class=\"timer-label\">timer...</span>`;\r\n             return;\r\n        }\r\n        \r\n        const remainingMs = alertScheduleTime - Date.now();\r\n        \r\n        if (remainingMs <= 0) {\r\n            alertStatusDisplay.innerHTML = `<span class=\"timer-value\">Alert Due!</span><span class=\"timer-label\">Next game ready</span>`; \r\n            return;\r\n        }\r\n\r\n        const remainingSeconds = Math.floor(remainingMs / 1000);\r\n        const minutes = Math.floor(remainingSeconds / 60);\r\n        const seconds = remainingSeconds % 60;\r\n\r\n        // MODIFIED: Create two spans to mirror the \"On Duty\" HTML structure\r\n        alertStatusDisplay.innerHTML = `<span class=\"timer-value\">${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}</span><span class=\"timer-label\">Next alert in</span>`;\r\n    }\r\n\r\n    function dynamicallyCenterHeaderTitle() {\r\n        const headerLogo = document.getElementById('header-logo');\r\n        const headerTitle = document.querySelector('.header-title');\r\n        const headerButtons = document.querySelector('.header-buttons');\r\n\r\n        if (!headerLogo || !headerTitle || !headerButtons) return;\r\n\r\n        // Get the actual rendered width of the side elements\r\n        const logoWidth = headerLogo.offsetWidth;\r\n        const buttonsWidth = headerButtons.offsetWidth;\r\n\r\n        // Calculate the difference and amplify it by a factor of 3 based on feedback\r\n        const widthDifference = (logoWidth - buttonsWidth) * 3;\r\n\r\n        // Apply padding to the title to offset the difference\r\n        // If the logo is wider (positive difference), add padding to the right to shift text left\r\n        // If the buttons are wider (negative difference), add padding to the left to shift text right\r\n        headerTitle.style.paddingRight = widthDifference > 0 ? `${widthDifference}px` : '0';\r\n        headerTitle.style.paddingLeft = widthDifference < 0 ? `${-widthDifference}px` : '0';\r\n    }\r\n\r\n    function calculatePlayerPlaytime() {\r\n        const stats = calculatePlayerStats(state.gameHistory); // Process all games for total playtime\r\n        const now = Date.now();\r\n        state.courts.forEach(court => {\r\n            if (court.status === 'in_progress' && court.gameStartTime) {\r\n                const elapsed = Date.now() - court.gameStartTime;\r\n                court.players.forEach(player => {\r\n                    const name = player.name;\r\n                    stats[name] = stats[name] || { played: 0, won: 0, totalDurationMs: 0 };\r\n                    stats[name].totalDurationMs += elapsed;\r\n                });\r\n            }\r\n        });\r\n        return stats;\r\n    }\r\n\r\n    function calculateTeamStats(gamesToProcess) {\r\n        const teamStats = {};\r\n\r\n        gamesToProcess.forEach(game => {\r\n            // Skip games that were skipped or have no score\r\n            if (game.winner === 'skipped' || !game.score) return;\r\n\r\n            // Skip games if any player opted out of the leaderboard\r\n            const allPlayerObjects = [...game.teams.team1, ...game.teams.team2].map(name => getPlayerByName(name));\r\n            if (allPlayerObjects.some(p => p.onLeaderboard === false)) return;\r\n\r\n            // Calculate game duration\r\n            const [hStr, mStr] = game.duration.split('h').map(s => s.replace('m', ''));\r\n            const gameDuration = (parseInt(hStr, 10) * 3600000) + (parseInt(mStr, 10) * 60000);\r\n\r\n            const processTeam = (team, isWinner) => {\r\n                // A team must consist of exactly 2 players. This excludes singles.\r\n                if (team.length !== 2) return;\r\n                \r\n                // Create a unique key for the team by sorting player names\r\n                const teamKey = [...team].sort().join(' & ');\r\n                const teamPlayerObjects = team.map(name => getPlayerByName(name));\r\n                const genders = teamPlayerObjects.map(p => p.gender);\r\n                \r\n                let teamType = 'Mixed';\r\n                if (genders.every(g => g === 'M')) teamType = 'Men';\r\n                if (genders.every(g => g === 'F')) teamType = 'Women';\r\n\r\n                if (!teamStats[teamKey]) {\r\n                    teamStats[teamKey] = {\r\n                        players: team,\r\n                        type: teamType,\r\n                        played: 0,\r\n                        won: 0,\r\n                        totalDurationMs: 0\r\n                    };\r\n                }\r\n                teamStats[teamKey].played += 1;\r\n                teamStats[teamKey].totalDurationMs += gameDuration;\r\n                if (isWinner) {\r\n                    teamStats[teamKey].won += 1;\r\n                }\r\n            };\r\n\r\n            const isTeam1Winner = game.winner === 'team1';\r\n            processTeam(game.teams.team1, isTeam1Winner);\r\n            processTeam(game.teams.team2, !isTeam1Winner);\r\n        });\r\n\r\n        return teamStats;\r\n    }\r\n\r\n    function calculateWinningStreaks() {\r\n        const streaks = {};\r\n        const lastGameResult = {}; // Tracks if the last game was a win for a player\r\n\r\n        // Sort games by end time, oldest to newest, to correctly track streaks\r\n        const sortedHistory = [...state.gameHistory].sort((a, b) => a.endTime - b.endTime);\r\n\r\n        sortedHistory.forEach(game => {\r\n            if (game.winner === 'skipped') {\r\n                // If a game was skipped, it breaks all streaks for players involved\r\n                [...game.teams.team1, ...game.teams.team2].forEach(playerName => {\r\n                    lastGameResult[playerName] = 'loss'; // Treat skip as a loss for streak purposes\r\n                });\r\n                return;\r\n            }\r\n\r\n            const winnerTeam = game.winner === 'team1' ? game.teams.team1 : game.teams.team2;\r\n            const loserTeam = game.winner === 'team1' ? game.teams.team2 : game.teams.team1;\r\n\r\n            winnerTeam.forEach(playerName => {\r\n                if (lastGameResult[playerName] === 'win') {\r\n                    streaks[playerName] = (streaks[playerName] || 1) + 1;\r\n                } else {\r\n                    streaks[playerName] = 1; // Start a new streak\r\n                }\r\n                lastGameResult[playerName] = 'win';\r\n            });\r\n\r\n            loserTeam.forEach(playerName => {\r\n                streaks[playerName] = 0; // Reset streak on loss\r\n                lastGameResult[playerName] = 'loss';\r\n            });\r\n        });\r\n\r\n        // Return only players with an active streak\r\n        const activeStreaks = {};\r\n        for (const player in streaks) {\r\n            if (streaks[player] > 0) {\r\n                activeStreaks[player] = streaks[player];\r\n            }\r\n        }\r\n        return activeStreaks;\r\n    }\r\n\r\n\r\n    function calculateHeartbreaker() {\r\n        const closeLossCounts = {};\r\n        const today = new Date().toISOString().split('T')[0];\r\n\r\n        const todaysGames = state.gameHistory.filter(game => {\r\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\r\n            return gameDate === today && game.winner !== 'skipped' && game.score;\r\n        });\r\n\r\n        todaysGames.forEach(game => {\r\n            const winnerScore = Math.max(game.score.team1, game.score.team2);\r\n            const loserScore = Math.min(game.score.team1, game.score.team2);\r\n\r\n            // Define a \"close loss\" as a score of 7-5, 7-6, or a close Fast Play game\r\n            const isCloseLoss = (winnerScore === 7 && (loserScore === 5 || loserScore === 6));\r\n\r\n            if (isCloseLoss) {\r\n                const loserTeam = (game.score.team1 < game.score.team2) ? game.teams.team1 : game.teams.team2;\r\n                loserTeam.forEach(playerName => {\r\n                    closeLossCounts[playerName] = (closeLossCounts[playerName] || 0) + 1;\r\n                });\r\n            }\r\n        });\r\n\r\n        let heartbreakerName = null;\r\n        let maxCloseLosses = 0;\r\n\r\n        for (const playerName in closeLossCounts) {\r\n            if (closeLossCounts[playerName] > maxCloseLosses) {\r\n                maxCloseLosses = closeLossCounts[playerName];\r\n                heartbreakerName = playerName;\r\n            }\r\n        }\r\n\r\n        // Only return a heartbreaker if they have at least one close loss\r\n        return maxCloseLosses > 0 ? heartbreakerName : null;\r\n    }\r\n\r\n\r\n    function calculatePlayerPowerScore(player, allGames, returnDetailed = false) {\r\n        // 1. Establish Baseline Ranking (no changes here)\r\n        const baselineStats = {};\r\n        allGames.forEach(game => {\r\n            [...game.teams.team1, ...game.teams.team2].forEach(pName => {\r\n                if (!baselineStats[pName]) baselineStats[pName] = { played: 0, won: 0 };\r\n            });\r\n            if (game.winner !== 'skipped' && game.score) {\r\n                const winnerTeam = game.winner === 'team1' ? game.teams.team1 : game.teams.team2;\r\n                const loserTeam = game.winner === 'team1' ? game.teams.team2 : game.teams.team1;\r\n                winnerTeam.forEach(pName => { baselineStats[pName].played++; baselineStats[pName].won++; });\r\n                loserTeam.forEach(pName => { baselineStats[pName].played++; });\r\n            }\r\n        });\r\n        const baselineRank = {};\r\n        for (const pName in baselineStats) {\r\n            baselineRank[pName] = (baselineStats[pName].played > 0) ? (baselineStats[pName].won / baselineStats[pName].played) : 0;\r\n        }\r\n        const avgRank = Object.values(baselineRank).reduce((a, b) => a + b, 0) / Object.values(baselineRank).length || 0.5;\r\n\r\n        // 2. Calculate Strength-of-Schedule Score (ENHANCED)\r\n        // Uses Expected Outcome probability to fairly assess performance\r\n        let historicalScore = 0;\r\n        let gamesPlayedHistorical = 0;\r\n        const thirtyDaysAgo = new Date();\r\n        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n        const historicalGames = allGames.filter(game => new Date(game.endTime) > thirtyDaysAgo && (game.teams.team1.includes(player.name) || game.teams.team2.includes(player.name)));\r\n        \r\n        historicalGames.forEach(game => {\r\n            if (game.winner === 'skipped' || !game.score) return;\r\n            \r\n            // Determine player's team and opponent team\r\n            const isPlayerInTeam1 = game.teams.team1.includes(player.name);\r\n            const playerTeam = isPlayerInTeam1 ? game.teams.team1 : game.teams.team2;\r\n            const opponentTeam = isPlayerInTeam1 ? game.teams.team2 : game.teams.team1;\r\n            const isWinner = (isPlayerInTeam1 && game.winner === 'team1') || (!isPlayerInTeam1 && game.winner === 'team2');\r\n            \r\n            // Calculate team averages using baseline ranks\r\n            const playerTeamAvg = playerTeam.reduce((sum, pName) => \r\n                sum + (baselineRank[pName] || avgRank), 0) / playerTeam.length;\r\n            const opponentTeamAvg = opponentTeam.reduce((sum, pName) => \r\n                sum + (baselineRank[pName] || avgRank), 0) / opponentTeam.length;\r\n            \r\n            // Calculate expected win probability using logistic function\r\n            // This accounts for ALL 4 players' strengths\r\n            const scoreDiff = playerTeamAvg - opponentTeamAvg;\r\n            const expectedWinProb = 1 / (1 + Math.exp(-5 * scoreDiff));\r\n            \r\n            // Calculate performance score based on expected outcome\r\n            let performanceScore;\r\n            \r\n            if (isWinner) {\r\n                // Won the match\r\n                if (expectedWinProb < 0.5) {\r\n                    // UPSET WIN (were underdogs)\r\n                    // Massive bonus for beating stronger opponents\r\n                    performanceScore = (1.0 - expectedWinProb) * 2;\r\n                } else {\r\n                    // EXPECTED WIN (were favorites)\r\n                    // Small credit for beating weaker opponents\r\n                    performanceScore = (1.0 - expectedWinProb) * 0.5;\r\n                }\r\n            } else {\r\n                // Lost the match\r\n                if (expectedWinProb > 0.5) {\r\n                    // BAD LOSS (were favorites)\r\n                    // Heavy penalty for losing to weaker opponents\r\n                    performanceScore = -(expectedWinProb) * 2;\r\n                } else {\r\n                    // EXPECTED LOSS (were underdogs)\r\n                    // Small penalty for losing to stronger opponents\r\n                    performanceScore = -(expectedWinProb) * 0.5;\r\n                }\r\n            }\r\n            \r\n            historicalScore += performanceScore;\r\n            gamesPlayedHistorical++;\r\n        });\r\n        \r\n        const finalHistoricalScore = gamesPlayedHistorical > 0 ? historicalScore / gamesPlayedHistorical : 0;\r\n\r\n        // 3. Today's Form (no changes here)\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const todaysGames = historicalGames.filter(game => new Date(game.endTime).toISOString().split('T')[0] === today);\r\n        let todaysWins = 0;\r\n        todaysGames.forEach(game => {\r\n            const isWinner = (game.teams.team1.includes(player.name) && game.winner === 'team1') || (game.teams.team2.includes(player.name) && game.winner === 'team2');\r\n            if (isWinner) todaysWins++;\r\n        });\r\n        const todaysWinPct = todaysGames.length > 0 ? (todaysWins / todaysGames.length) - 0.5 : 0;\r\n\r\n        // --- THIS IS THE REFINED ADAPTIVE WEIGHTING LOGIC ---\r\n        const totalGamesInHistory = allGames.length;\r\n        let historicalWeight;\r\n\r\n        if (totalGamesInHistory >= 20) {\r\n            historicalWeight = 0.7;\r\n        } else if (totalGamesInHistory >= 15) {\r\n            historicalWeight = 0.525; // 75% of the way to 0.7\r\n        } else if (totalGamesInHistory >= 10) {\r\n            historicalWeight = 0.35;  // 50% of the way to 0.7\r\n        } else if (totalGamesInHistory >= 5) {\r\n            historicalWeight = 0.175; // 25% of the way to 0.7\r\n        } else {\r\n            historicalWeight = 0.0;   // 0% historical weight for the first few games\r\n        }\r\n        \r\n        const todayWeight = 1 - historicalWeight;\r\n        let blendedScore = (finalHistoricalScore * historicalWeight) + (todaysWinPct * todayWeight);\r\n        // --- END OF REFINED LOGIC ---\r\n\r\n        // 5. Apply Player Type Modifiers\r\n        // ENHANCED: Removed static penalties for Veteran/Junior\r\n        // Player type doesn't determine skill - performance does!\r\n        // Strategic veterans and elite juniors now get proper credit\r\n        if (player.guest && gamesPlayedHistorical === 0) blendedScore = 0;\r\n\r\n        if (returnDetailed) {\r\n            return {\r\n                historicalScore: finalHistoricalScore,\r\n                todayForm: todaysWinPct,\r\n                finalScore: blendedScore\r\n            };\r\n        }\r\n        \r\n        return blendedScore;\r\n    }\r\n\r\n    // --- POWER SCORE MODAL FUNCTIONS ---\r\n\r\n    function showPowerScoreModal() {\r\n        renderPowerScoreList();\r\n        adminSettingsModal.classList.add('hidden');\r\n        powerScoreModal.classList.remove('hidden');\r\n    }\r\n\r\n    function renderPowerScoreList() {\r\n        powerScoreList.innerHTML = \"\";\r\n\r\n        const playersOnCourt = state.courts.flatMap(c => c.players);\r\n        const allPlayersAtClub = [...state.availablePlayers, ...playersOnCourt];\r\n        const uniquePlayers = Array.from(new Map(allPlayersAtClub.map(p => [p.name, p])).values());\r\n\r\n        if (uniquePlayers.length === 0) {\r\n            powerScoreList.innerHTML = '<p style=\"text-align: center; color: #6c757d;\">No players are currently checked in.</p>';\r\n            return;\r\n        }\r\n\r\n        const playerScores = uniquePlayers.map(player => {\r\n            const scores = calculatePlayerPowerScore(player, state.gameHistory, true); // Get detailed scores\r\n            return {\r\n                name: player.name,\r\n                ...scores\r\n            };\r\n        });\r\n\r\n        const { key, order } = state.powerScoreSort;\r\n        playerScores.sort((a, b) => {\r\n            let valA = a[key];\r\n            let valB = b[key];\r\n            if (key === 'name') {\r\n                return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);\r\n            }\r\n            return order === 'asc' ? valA - valB : valB - valA;\r\n        });\r\n\r\n        const getSortIcon = (sortKey) => (state.powerScoreSort.key !== sortKey) ? ' ' : (state.powerScoreSort.order === 'asc' ? ' 🔼' : ' 🔽');\r\n\r\n        const headerHTML = `\r\n            <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\r\n                <div class=\"power-score-grid-row\">\r\n                    <button class=\"sort-btn\" data-sort-key=\"name\">Player ${getSortIcon('name')}</button>\r\n                    <button class=\"sort-btn\" data-sort-key=\"historicalScore\">Historical ${getSortIcon('historicalScore')}</button>\r\n                    <button class=\"sort-btn\" data-sort-key=\"todayForm\">Today ${getSortIcon('todayForm')}</button>\r\n                    <button class=\"sort-btn\" data-sort-key=\"finalScore\">Score ${getSortIcon('finalScore')}</button>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        const playerRows = playerScores.map(p => `\r\n            <div class=\"history-item\">\r\n                <div class=\"power-score-grid-row\">\r\n                    <span>${p.name}</span>\r\n                    <span>${p.historicalScore.toFixed(2)}</span>\r\n                    <span>${p.todayForm.toFixed(2)}</span>\r\n                    <span style=\"font-weight: bold;\">${p.finalScore.toFixed(2)}</span>\r\n                </div>\r\n            </div>\r\n        `).join('');\r\n\r\n        powerScoreList.innerHTML = headerHTML + playerRows;\r\n\r\n        // Attach listeners to new sort buttons\r\n        powerScoreList.querySelectorAll('.sort-btn').forEach(btn => {\r\n            btn.addEventListener('click', handlePowerScoreSortClick);\r\n        });\r\n    }\r\n    \r\n    // --- ADMIN CHECKLIST FUNCTIONS ---\r\n\r\n    function renderChecklist(checklistData = state.adminChecklist, targetElement = checklistContent, isReadOnly = false) {\r\n        targetElement.innerHTML = ''; // Clear existing content\r\n\r\n        const createListItems = (items, listType) => {\r\n            if (!items || items.length === 0) return '';\r\n            return items.map(item => {\r\n                const uniqueId = `check-${listType}-${item.id}`;\r\n                // Add 'disabled' attribute if read-only\r\n                const disabledAttr = isReadOnly ? 'disabled' : '';\r\n                return `\r\n                    <li class=\"checklist-item\">\r\n                        <label for=\"${uniqueId}\">\r\n                            <input type=\"checkbox\" id=\"${uniqueId}\" data-checklist-id=\"${item.id}\" data-list-type=\"${listType}\" ${item.checked ? 'checked' : ''} ${disabledAttr}>\r\n                            <span>${item.text}</span>\r\n                        </label>\r\n                    </li>\r\n                `;\r\n            }).join('');\r\n        };\r\n\r\n        const arrivalItemsHTML = createListItems(checklistData.arrival, 'arrival');\r\n        const departureItemsHTML = createListItems(checklistData.departure, 'departure');\r\n\r\n        if (arrivalItemsHTML) {\r\n            targetElement.innerHTML += `<h2 class=\"checklist-section-header\">On Arrival</h2><ul>${arrivalItemsHTML}</ul>`;\r\n        }\r\n        if (departureItemsHTML) {\r\n            targetElement.innerHTML += `<h2 class=\"checklist-section-header\">On Departure</h2><ul>${departureItemsHTML}</ul>`;\r\n        }\r\n\r\n        if (!arrivalItemsHTML && !departureItemsHTML) {\r\n            targetElement.innerHTML = '<p style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No checklist items defined.</p>';\r\n        }\r\n\r\n        // Add internal list styling if needed (e.g., remove bullets)\r\n        targetElement.querySelectorAll('ul').forEach(ul => {\r\n            ul.style.listStyle = 'none';\r\n            ul.style.padding = '0';\r\n            ul.style.margin = '0';\r\n        });\r\n    }\r\n\r\n    function showChecklistModal() {\r\n        renderChecklist(); // Populate the list\r\n        adminSettingsModal.classList.add('hidden');\r\n        checklistModal.classList.remove('hidden');\r\n    }\r\n\r\n    function handleChecklistChange(e) {\r\n        if (e.target.type === 'checkbox' && e.target.dataset.checklistId) {\r\n            const itemId = e.target.dataset.checklistId;\r\n            const listType = e.target.dataset.listType; // 'arrival' or 'departure'\r\n            const isChecked = e.target.checked;\r\n\r\n            if (!listType || !state.adminChecklist[listType]) return; // Safety check\r\n\r\n            const item = state.adminChecklist[listType].find(i => i.id === itemId);\r\n            if (item) {\r\n                item.checked = isChecked;\r\n\r\n                // Mutual exclusion for Amp settings\r\n                if (listType === 'arrival') {\r\n                    if (itemId === 'arrAmpAux' && isChecked) {\r\n                        const opticalItem = state.adminChecklist.arrival.find(i => i.id === 'arrAmpOptical');\r\n                        if (opticalItem) opticalItem.checked = false;\r\n                    } else if (itemId === 'arrAmpOptical' && isChecked) {\r\n                        const auxItem = state.adminChecklist.arrival.find(i => i.id === 'arrAmpAux');\r\n                        if (auxItem) auxItem.checked = false;\r\n                    }\r\n                    // Re-render only the arrival list if exclusion happened\r\n                    if ((itemId === 'arrAmpAux' || itemId === 'arrAmpOptical')) {\r\n                    renderChecklist(); // Re-render the whole checklist to update visuals\r\n                    }\r\n                }\r\n\r\n                saveState();\r\n                saveChecklistHistory();\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- CHECKLIST HISTORY FUNCTIONS ---\r\n    function saveChecklistHistory() {\r\n        const today = new Date();\r\n        const year = today.getFullYear();\r\n        const month = String(today.getMonth() + 1).padStart(2, '0');\r\n        const day = String(today.getDate()).padStart(2, '0');\r\n        const todayDateStr = `${year}-${month}-${day}`;\r\n\r\n        // --- Original Condition: Games Played & Duty Member ---\r\n        const gamesPlayedToday = state.gameHistory.some(game =>\r\n            // Ensure comparison uses local date string format\r\n            new Date(game.endTime).toLocaleDateString('en-CA') === todayDateStr // 'en-CA' gives YYYY-MM-DD\r\n        );\r\n        const dutyMemberAssigned = state.onDuty !== 'None';\r\n        const initialCreationConditionMet = gamesPlayedToday && dutyMemberAssigned;\r\n        // --- End Original Condition ---\r\n\r\n        const historyIndex = state.checklistHistory.findIndex(entry => entry.date === todayDateStr);\r\n\r\n        // --- Logic: Create if condition met & doesn't exist, Update if exists ---\r\n        if (historyIndex > -1) {\r\n            // --- ALWAYS UPDATE if entry for today exists ---\r\n            try {\r\n                // Update today's entry with the current state (deep copy)\r\n                state.checklistHistory[historyIndex].checklist = JSON.parse(JSON.stringify(state.adminChecklist));\r\n                // console.log(`Checklist history UPDATED for ${todayDateStr} (Live update).`);\r\n                saveState(); // Save the updated history\r\n            } catch (error) {\r\n                console.error(\"Error updating checklist history:\", error);\r\n            }\r\n            // --- END UPDATE LOGIC ---\r\n        } else if (initialCreationConditionMet) {\r\n            // --- CREATE entry only if initial condition is met AND it doesn't exist yet ---\r\n            try {\r\n                const checklistCopy = JSON.parse(JSON.stringify(state.adminChecklist)); // Deep copy\r\n                state.checklistHistory.push({\r\n                    date: todayDateStr,\r\n                    checklist: checklistCopy\r\n                });\r\n                // console.log(`Checklist history CREATED for ${todayDateStr} (Game/Duty condition met).`);\r\n                saveState(); // Save the newly created history entry\r\n            } catch (error) {\r\n                console.error(\"Error creating checklist history:\", error);\r\n            }\r\n            // --- END CREATE LOGIC ---\r\n        } else {\r\n             // console.log(`Checklist history entry for ${todayDateStr} NOT created/updated. Initial condition: ${initialCreationConditionMet}, Exists: ${historyIndex > -1}`);\r\n        }\r\n    }\r\n\r\n    // --- NEW FUNCTION: Resets checklist for the new day ---\r\n    function resetChecklistForNewDay(forceReset = false) {\r\n        const today = new Date();\r\n        const year = today.getFullYear();\r\n        const month = String(today.getMonth() + 1).padStart(2, '0');\r\n        const day = String(today.getDate()).padStart(2, '0');\r\n        const todayDateStr = `${year}-${month}-${day}`;\r\n\r\n        // Get the date of the last reset from localStorage\r\n        const lastResetDate = localStorage.getItem(\"checklistLastResetDate\");\r\n\r\n        // Only reset if it's a new day OR if forceReset is true (e.g., from manual reset button)\r\n        if (forceReset || lastResetDate !== todayDateStr) {\r\n            console.log(`Resetting checklist for new day: ${todayDateStr}`);\r\n\r\n            // Reset all 'checked' states to false\r\n            Object.keys(state.adminChecklist).forEach(section => {\r\n                if (Array.isArray(state.adminChecklist[section])) {\r\n                    state.adminChecklist[section].forEach(item => {\r\n                        item.checked = false;\r\n                    });\r\n                }\r\n            });\r\n\r\n            // Update the last reset date in localStorage\r\n            localStorage.setItem(\"checklistLastResetDate\", todayDateStr);\r\n            saveState(); // Save the reset state\r\n        }\r\n    }\r\n\r\n    // Call this function periodically (e.g., every hour) or on app close/reset\r\n    // Simple hourly check:\r\n    setInterval(saveChecklistHistory, 60 * 60 * 1000);\r\n    // More robust would be to tie it to a 'day end' event if available.\r\n\r\n    function renderChecklistHistoryList() {\r\n        checklistHistoryList.innerHTML = '';\r\n        checklistHistoryTitle.textContent = 'Checklist History'; // Reset title\r\n\r\n        if (state.checklistHistory.length === 0) {\r\n            checklistHistoryList.innerHTML = '<li style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No history recorded yet.</li>';\r\n            return;\r\n        }\r\n\r\n        // Sort history, newest first\r\n        const sortedHistory = [...state.checklistHistory].sort((a, b) => b.date.localeCompare(a.date));\r\n\r\n        sortedHistory.forEach(entry => {\r\n            const li = document.createElement('li');\r\n            li.textContent = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-ZA', {\r\n                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'\r\n            });\r\n            li.dataset.date = entry.date;\r\n            checklistHistoryList.appendChild(li);\r\n        });\r\n    }\r\n\r\n    function showChecklistHistoryModal() {\r\n        renderChecklistHistoryList();\r\n        // Show the list view, hide the detail view\r\n        checklistHistoryListView.classList.remove('hidden');\r\n        checklistHistoryDetailView.classList.add('hidden');\r\n        checklistHistoryBackBtn.classList.add('hidden'); // Hide back button initially\r\n        checklistModal.classList.add('hidden'); // Hide main checklist\r\n        checklistHistoryModal.classList.remove('hidden');\r\n    }\r\n\r\n    function showChecklistHistoryDetail(dateStr) {\r\n        const historyEntry = state.checklistHistory.find(entry => entry.date === dateStr);\r\n        if (!historyEntry) return;\r\n\r\n        state.selectedChecklistHistoryDate = dateStr; // Store selected date\r\n\r\n        const displayDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-ZA', {\r\n            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'\r\n        });\r\n        checklistHistoryTitle.textContent = `Checklist for ${displayDate}`;\r\n        checklistDetailDate.textContent = displayDate; // Update detail paragraph date\r\n\r\n        // Use the renderChecklist function in read-only mode\r\n        renderChecklist(historyEntry.checklist, checklistHistoryDetail, true);\r\n\r\n        // Switch views\r\n        checklistHistoryListView.classList.add('hidden');\r\n        checklistHistoryDetailView.classList.remove('hidden');\r\n        checklistHistoryBackBtn.classList.remove('hidden'); // Show back button\r\n    }\r\n    // --- END CHECKLIST HISTORY FUNCTIONS ---\r\n\r\n\r\n\r\n    // --- END ADMIN CHECKLIST FUNCTIONS ---    \r\n\r\n    function handlePowerScoreSortClick(e) {\r\n        const key = e.target.dataset.sortKey;\r\n        if (!key) return;\r\n\r\n        if (state.powerScoreSort.key === key) {\r\n            state.powerScoreSort.order = state.powerScoreSort.order === 'asc' ? 'desc' : 'asc';\r\n        } else {\r\n            state.powerScoreSort.key = key;\r\n            state.powerScoreSort.order = 'desc'; // Default to desc for new columns\r\n        }\r\n        renderPowerScoreList();\r\n    }\r\n\r\n    // --- POWER SCORE MODAL EVENT LISTENERS ---\r\n    powerScoreBtn.addEventListener('click', showPowerScoreModal);\r\n    powerScoreCloseBtn.addEventListener('click', () => {\r\n        powerScoreModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    }); \r\n\r\n    /**\r\n     * Determines the most balanced game based on settings and player pool.\r\n     * Incorporates percentage-based overrides for specific scenarios.\r\n     * Returns an object { suggestion: { team1, team2 } | null, type: string | null }.\r\n     */\r\n    function findMostBalancedGame(selector, available) {\r\n        const settings = state.suggestionSettings;\r\n        // Generate a single random number (0-100) to check against percentages sequentially.\r\n        const percentageRoll = Math.random() * 100;\r\n\r\n        // --- Prepare Player Data ---\r\n        const poolPlayers = [selector, ...available.slice(0, 4)];\r\n        const playerPlaytimes = calculatePlayerPlaytime(); // Get playtime data\r\n        const poolPlayerScores = poolPlayers.map(p => ({\r\n            player: p,\r\n            score: calculatePlayerPowerScore(p, state.gameHistory)\r\n        }));\r\n        const selectorScoreData = poolPlayerScores.find(ps => ps.player.name === selector.name);\r\n\r\n        // --- Scenario 1: Top Player Head-to-Head ---\r\n        if (!settings.powerScoreOnly && percentageRoll < settings.topPlayerPercent) {\r\n            console.log(`Attempting Top Player H2H suggestion... (Roll: ${percentageRoll.toFixed(1)} < ${settings.topPlayerPercent}%)`);\r\n            const sortedByScore = [...poolPlayerScores].sort((a, b) => b.score - a.score);\r\n            const top4PlayersData = sortedByScore.slice(0, 4);\r\n\r\n            if (top4PlayersData.length === 4 && top4PlayersData.some(ps => ps.player.name === selector.name)) {\r\n                const males = top4PlayersData.filter(ps => ps.player.gender === 'M').length;\r\n                const females = top4PlayersData.filter(ps => ps.player.gender === 'F').length;\r\n\r\n                if (!(males === 3 && females === 1) && !(males === 1 && females === 3)) {\r\n                    console.log(\"Top Player H2H applied.\");\r\n                    const suggestion = findBestCombination(top4PlayersData);\r\n                    return { suggestion: suggestion, type: 'topPlayer' }; // Return type\r\n                } else {\r\n                    console.log(\"Top Player H2H skipped due to 3:1 gender split.\");\r\n                }\r\n            } else {\r\n                console.log(\"Top Player H2H skipped: Selector not in top 4 or not enough players.\");\r\n            }\r\n        } else if (!settings.powerScoreOnly) {\r\n             console.log(`Top Player H2H skipped (Roll: ${percentageRoll.toFixed(1)} >= ${settings.topPlayerPercent}%)`);\r\n        }\r\n\r\n\r\n        // --- Scenario 2: Frequent Opponent ---\r\n        // Check only if Top Player wasn't triggered. Use the *same* percentageRoll.\r\n        if (!settings.powerScoreOnly && percentageRoll >= settings.topPlayerPercent && percentageRoll < (settings.topPlayerPercent + settings.frequentOpponentPercent)) {\r\n            console.log(`Attempting Frequent Opponent suggestion... (Roll: ${percentageRoll.toFixed(1)} in range)`);\r\n            const frequentOpponentName = findFrequentOpponent(selector.name, state.gameHistory);\r\n            const opponentInPool = poolPlayerScores.find(ps => ps.player.name === frequentOpponentName);\r\n\r\n            if (opponentInPool) {\r\n                console.log(`Frequent Opponent (${frequentOpponentName}) found in pool. Applying.`);\r\n                let selection = [selector, opponentInPool.player];\r\n                let remainingForBalance = poolPlayerScores.filter(ps =>\r\n                    ps.player.name !== selector.name && ps.player.name !== opponentInPool.player.name\r\n                ).map(ps => ps.player);\r\n\r\n                if (remainingForBalance.length >= 2) {\r\n                    // Fill remaining 2 spots using standard balance logic (mixed aim, ignore least playtime here)\r\n                    const finalTwo = findBestBalancingPlayers(selection, remainingForBalance, 2, poolPlayerScores, false, 'mixed', selector.gender, opponentInPool.player.gender);\r\n                    if (finalTwo && finalTwo.length === 2) { // Check if findBestBalancingPlayers succeeded\r\n                         selection.push(...finalTwo);\r\n                         if (selection.length === 4) {\r\n                             const finalScores = poolPlayerScores.filter(ps => selection.some(p => p.name === ps.player.name));\r\n                             const suggestion = findBestCombination(finalScores);\r\n                             return { suggestion: suggestion, type: 'frequentOpponent' }; // Return type\r\n                         }\r\n                    } else {\r\n                         console.log(\"Frequent Opponent skipped: Could not find 2 balanced players to complete the team.\");\r\n                    }\r\n                } else {\r\n                    console.log(\"Frequent Opponent skipped: Not enough remaining players.\");\r\n                }\r\n            } else {\r\n                console.log(\"Frequent Opponent skipped: Opponent not found or not frequent enough.\");\r\n            }\r\n        } else if (!settings.powerScoreOnly) {\r\n             console.log(`Frequent Opponent skipped (Roll: ${percentageRoll.toFixed(1)} not in range or Top Player triggered)`);\r\n        }\r\n\r\n        // --- Scenario 3: Weak Player Grouping ---\r\n        // Check only if previous scenarios weren't triggered. Use the *same* percentageRoll.\r\n        const weakPlayerUpperBoundary = settings.topPlayerPercent + settings.frequentOpponentPercent + settings.weakPlayerPercent;\r\n        if (!settings.powerScoreOnly && percentageRoll >= (settings.topPlayerPercent + settings.frequentOpponentPercent) && percentageRoll < weakPlayerUpperBoundary) {\r\n            console.log(`Attempting Weak Player Grouping suggestion... (Roll: ${percentageRoll.toFixed(1)} in range)`);\r\n            if (!selectorScoreData) {\r\n                 console.log(\"Weak Player Grouping skipped: Selector score data missing.\");\r\n            } else {\r\n                 const selectorIsWeak = isWeakPlayer(selectorScoreData.score, settings.weakPlayerThreshold);\r\n                 if (selectorIsWeak) {\r\n                     const otherWeakPlayers = poolPlayerScores.filter(ps =>\r\n                         ps.player.name !== selector.name && isWeakPlayer(ps.score, settings.weakPlayerThreshold)\r\n                     );\r\n\r\n                     if (otherWeakPlayers.length >= 3) {\r\n                         otherWeakPlayers.sort((a, b) => a.score - b.score); // Sort weakest first\r\n                         const weakFoursomeData = [selectorScoreData, ...otherWeakPlayers.slice(0, 3)];\r\n\r\n                         const males = weakFoursomeData.filter(ps => ps.player.gender === 'M').length;\r\n                         const females = weakFoursomeData.filter(ps => ps.player.gender === 'F').length;\r\n                         if (!(males === 3 && females === 1) && !(males === 1 && females === 3)) {\r\n                             console.log(\"Weak Player Grouping applied.\");\r\n                             const suggestion = findBestCombination(weakFoursomeData);\r\n                             return { suggestion: suggestion, type: 'weakPlayer' }; // Return type\r\n                         } else {\r\n                              console.log(\"Weak Player Grouping skipped due to 3:1 gender split.\");\r\n                         }\r\n                     } else {\r\n                         console.log(\"Weak Player Grouping skipped: Not enough other weak players available.\");\r\n                     }\r\n                 } else {\r\n                     console.log(\"Weak Player Grouping skipped: Selector is not weak.\");\r\n                 }\r\n            }\r\n        } else if (!settings.powerScoreOnly) {\r\n            console.log(`Weak Player Grouping skipped (Roll: ${percentageRoll.toFixed(1)} not in range or previous triggered)`);\r\n        }\r\n\r\n\r\n        // --- Scenario 4: Standard Balancing Logic (Fallback) ---\r\n        console.log(\"Falling back to Standard Balancing Logic.\");\r\n        let selectedPlayers = [selector];\r\n        let remainingPool = [...poolPlayerScores.filter(ps => ps.player.name !== selector.name)];\r\n\r\n        // --- Least Playtime Selection (incorporating 100% gender preference) ---\r\n        if (settings.prioritizeLeastPlaytime && !settings.powerScoreOnly && remainingPool.length > 0) {\r\n            let targetGenderForLeastPlaytime = null;\r\n            const isFemaleSelector = selector.gender === 'F';\r\n            const availableFemalesInPool = remainingPool.filter(ps => ps.player.gender === 'F').length;\r\n            const availableMalesInPool = remainingPool.filter(ps => ps.player.gender === 'M').length;\r\n            const playersNeededForFullTeam = 3;\r\n\r\n            if (isFemaleSelector && settings.femaleRatioPercent === 100 && availableFemalesInPool >= playersNeededForFullTeam) {\r\n                targetGenderForLeastPlaytime = 'F';\r\n            } else if (!isFemaleSelector && settings.maleRatioPercent === 100 && availableMalesInPool >= playersNeededForFullTeam) {\r\n                targetGenderForLeastPlaytime = 'M';\r\n            }\r\n\r\n            let poolForLeastPlaytime = remainingPool;\r\n            if (targetGenderForLeastPlaytime) {\r\n                const filteredPool = remainingPool.filter(ps => ps.player.gender === targetGenderForLeastPlaytime);\r\n                if (filteredPool.length > 0) {\r\n                    poolForLeastPlaytime = filteredPool;\r\n                } else {\r\n                     console.warn(`Standard Balance: 100% ${targetGenderForLeastPlaytime === 'F' ? 'Female' : 'Male'} preference set, but no matching players in pool.`);\r\n                }\r\n            }\r\n\r\n            let minPlaytime = Infinity;\r\n            let leastPlayedPlayerScoreObj = null;\r\n            poolForLeastPlaytime.forEach(ps => {\r\n                const playtime = playerPlaytimes[ps.player.name]?.totalDurationMs || 0;\r\n                if (playtime < minPlaytime) {\r\n                    minPlaytime = playtime;\r\n                    leastPlayedPlayerScoreObj = ps;\r\n                } else if (playtime === minPlaytime && leastPlayedPlayerScoreObj) {\r\n                    const currentIndex = remainingPool.findIndex(rp => rp.player.name === ps.player.name);\r\n                    const currentBestIndex = remainingPool.findIndex(rp => rp.player.name === leastPlayedPlayerScoreObj.player.name);\r\n                    if (currentIndex < currentBestIndex) leastPlayedPlayerScoreObj = ps;\r\n                }\r\n            });\r\n\r\n            if (leastPlayedPlayerScoreObj) {\r\n                selectedPlayers.push(leastPlayedPlayerScoreObj.player);\r\n                remainingPool = remainingPool.filter(ps => ps.player.name !== leastPlayedPlayerScoreObj.player.name);\r\n            }\r\n        }\r\n        // --- End Least Playtime ---\r\n\r\n        // --- Select Remaining Players ---\r\n        const playersNeeded = 4 - selectedPlayers.length;\r\n        if (remainingPool.length < playersNeeded) {\r\n            console.warn(\"Standard Balance: Not enough players remaining after least playtime selection.\");\r\n            // Try to form best possible team with what's left\r\n             const finalGroup = [...selectedPlayers, ...remainingPool.map(ps => ps.player)];\r\n             const finalGroupScores = poolPlayerScores.filter(ps => finalGroup.some(p => p.name === ps.player.name));\r\n             if (finalGroupScores.length >= 2) { // Need at least 2 for findBestCombination\r\n                const suggestion = findBestCombination(finalGroupScores); // May return fewer than 4\r\n                return { suggestion: suggestion, type: 'standard' };\r\n             } else {\r\n                return { suggestion: null, type: null }; // Cannot form even a pair\r\n             }\r\n        }\r\n\r\n        let finalPlayersToAdd = [];\r\n        if (settings.powerScoreOnly) { // Check powerScoreOnly toggle\r\n            finalPlayersToAdd = findBestBalancingPlayers(selectedPlayers, remainingPool.map(ps => ps.player), playersNeeded, poolPlayerScores, true);\r\n        } else {\r\n            // Determine gender aim based on ratios\r\n            let aimForGender = 'mixed';\r\n            const isFemaleSelector = selector.gender === 'F';\r\n            // Use Math.random here for the ratio check, as the initial percentageRoll was for overrides\r\n            const genderRoll = Math.random() * 100;\r\n\r\n            const currentAvailableFemales = remainingPool.filter(ps => ps.player.gender === 'F').length;\r\n            const currentAvailableMales = remainingPool.filter(ps => ps.player.gender === 'M').length;\r\n\r\n            if (isFemaleSelector && currentAvailableFemales >= playersNeeded) {\r\n                if (genderRoll < settings.femaleRatioPercent) aimForGender = 'female';\r\n            } else if (!isFemaleSelector && currentAvailableMales >= playersNeeded) {\r\n                if (genderRoll < settings.maleRatioPercent) aimForGender = 'male';\r\n            }\r\n\r\n            const secondPlayerGender = selectedPlayers.length > 1 ? selectedPlayers[1].gender : null;\r\n            finalPlayersToAdd = findBestBalancingPlayers(selectedPlayers, remainingPool.map(ps => ps.player), playersNeeded, poolPlayerScores, false, aimForGender, selector.gender, secondPlayerGender);\r\n        }\r\n\r\n        // --- Final Assembly ---\r\n        if (finalPlayersToAdd && finalPlayersToAdd.length === playersNeeded) {\r\n             selectedPlayers.push(...finalPlayersToAdd);\r\n        } else {\r\n             console.warn(\"Standard Balance: findBestBalancingPlayers did not return enough players.\");\r\n             // Attempt with remaining pool if findBestBalancingPlayers failed\r\n             selectedPlayers.push(...remainingPool.slice(0, playersNeeded).map(ps => ps.player));\r\n        }\r\n\r\n\r\n        if (selectedPlayers.length === 4) {\r\n            const finalPlayerScores = poolPlayerScores.filter(ps => selectedPlayers.some(p => p.name === ps.player.name));\r\n            const suggestion = findBestCombination(finalPlayerScores);\r\n            return { suggestion: suggestion, type: 'standard' };\r\n        } else {\r\n            console.error(\"Standard balance failed definitively to select 4 players.\");\r\n             // Attempt to return the most balanced group possible even if not 4\r\n             const finalScores = poolPlayerScores.filter(ps => selectedPlayers.some(p => p.name === ps.player.name));\r\n             if (finalScores.length >= 2) {\r\n                 const suggestion = findBestCombination(finalScores);\r\n                 return { suggestion: suggestion, type: 'standard' };\r\n             } else {\r\n                 return { suggestion: null, type: null };\r\n             }\r\n        }\r\n    }\r\n\r\n    // NEW Helper Function: Finds the best players to add for balance\r\n    // Helper Function: Finds the best players to add for balance (Corrected for strict 100% aim)\r\n    function findBestBalancingPlayers(currentSelection, pool, count, allPlayerScores, powerScoreOnly = false, aimGender = 'mixed', selectorGender = null, secondPlayerGender = null) {\r\n        let bestCombination = [];\r\n        let minDiff = Infinity;\r\n        let bestOverallBalance = Infinity;\r\n\r\n        const combinations = getCombinations(pool, count);\r\n\r\n        combinations.forEach(combo => {\r\n            const potentialFoursome = [...currentSelection, ...combo];\r\n            if (potentialFoursome.length !== 4) return; // Only consider full foursomes\r\n\r\n            const potentialFoursomeNames = potentialFoursome.map(p => p.name);\r\n\r\n            if (powerScoreOnly) {\r\n                // Power score only logic (remains unchanged)\r\n                const males = potentialFoursome.filter(p => p.gender === 'M').length;\r\n                const females = potentialFoursome.filter(p => p.gender === 'F').length;\r\n\r\n                // CRITICAL: Never allow 3:1 gender splits\r\n                if ((males === 3 && females === 1) || (males === 1 && females === 3)) {\r\n                    return; // Skip this combination entirely\r\n                }\r\n                const foursomeScores = allPlayerScores.filter(ps => potentialFoursomeNames.includes(ps.player.name));\r\n                 if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\r\n                const teamSplit = findBestCombination(foursomeScores);\r\n                if (!teamSplit) return;\r\n                const team1Score = teamSplit.team1.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                const team2Score = teamSplit.team2.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                const diff = Math.abs(team1Score - team2Score);\r\n                if (diff < bestOverallBalance) {\r\n                    bestOverallBalance = diff;\r\n                    bestCombination = combo;\r\n                }\r\n            } else {\r\n                // Gender Balancing Logic\r\n                const males = potentialFoursome.filter(p => p.gender === 'M').length;\r\n                const females = potentialFoursome.filter(p => p.gender === 'F').length;\r\n\r\n                // CRITICAL: Never allow 3:1 gender splits\r\n                if ((males === 3 && females === 1) || (males === 1 && females === 3)) {\r\n                    return; // Skip this combination entirely\r\n                }\r\n\r\n                let isMatch = false;\r\n                // --- START CORRECTION ---\r\n                // Be strict when aiming for a single gender\r\n                if (aimGender === 'female') {\r\n                    if (females === 4) isMatch = true;\r\n                } else if (aimGender === 'male') {\r\n                    if (males === 4) isMatch = true;\r\n                } else { // aimGender === 'mixed' or a fallback occurred before calling\r\n                    // Prefer 2M/2F for mixed, but allow 4M or 4F as fallback *if aiming for mixed initially*\r\n                    if (males === 2 && females === 2) isMatch = true;\r\n                    else if (aimGender === 'mixed' && (males === 4 || females === 4)) isMatch = true; // Allow single-gender only if original aim was mixed\r\n                }\r\n                // --- END CORRECTION ---\r\n\r\n                if (isMatch) {\r\n                    // Calculate power score difference for this valid gender combination\r\n                    const foursomeScores = allPlayerScores.filter(ps => potentialFoursomeNames.includes(ps.player.name));\r\n                     if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\r\n                    const teamSplit = findBestCombination(foursomeScores);\r\n                    if (!teamSplit) return;\r\n                    const team1Score = teamSplit.team1.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                    const team2Score = teamSplit.team2.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                    const diff = Math.abs(team1Score - team2Score);\r\n\r\n                    // Update bestCombination only if this matching gender combo has better balance\r\n                    if (diff < minDiff) {\r\n                        minDiff = diff;\r\n                        bestCombination = combo;\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        // Fallback: If NO combination met the strict gender goal (or power score goal), find the *most* balanced overall valid foursome\r\n        if (bestCombination.length === 0 && combinations.length > 0) {\r\n            console.warn(\"Suggestion fallback: No combination met the primary goal, selecting most balanced valid foursome overall.\");\r\n            let fallbackMinDiff = Infinity;\r\n            combinations.forEach(combo => {\r\n                const potentialFoursome = [...currentSelection, ...combo];\r\n                if (potentialFoursome.length !== 4) return; // Ensure fallback also considers only foursomes\r\n\r\n                // Rule: Avoid 3:1 gender splits even in fallback\r\n                const males = potentialFoursome.filter(p => p.gender === 'M').length;\r\n                const females = potentialFoursome.filter(p => p.gender === 'F').length;\r\n\r\n                // CRITICAL: Never allow 3:1 gender splits\r\n                if ((males === 3 && females === 1) || (males === 1 && females === 3)) {\r\n                    return; // Skip this combination entirely\r\n                }\r\n\r\n                const potentialFoursomeNames = potentialFoursome.map(p => p.name);\r\n                const foursomeScores = allPlayerScores.filter(ps => potentialFoursomeNames.includes(ps.player.name));\r\n                 if (foursomeScores.length !== 4) return; // Ensure we have scores for 4 players\r\n                const teamSplit = findBestCombination(foursomeScores);\r\n                if (!teamSplit) return;\r\n                const team1Score = teamSplit.team1.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                const team2Score = teamSplit.team2.reduce((sum, p) => sum + allPlayerScores.find(ps => ps.player.name === p.name).score, 0);\r\n                const diff = Math.abs(team1Score - team2Score);\r\n                if (diff < fallbackMinDiff) {\r\n                    fallbackMinDiff = diff;\r\n                    bestCombination = combo;\r\n                }\r\n            });\r\n            // If still no combo after fallback (e.g., all valid combos were skipped?), return empty\r\n            if(bestCombination.length === 0) {\r\n                 console.error(\"Suggestion Error: Could not find any valid foursome combination in fallback.\");\r\n            }\r\n        }\r\n\r\n        return bestCombination;\r\n    }\r\n\r\n    // NEW Helper function to generate combinations\r\n    function getCombinations(arr, k) {\r\n        if (k < 0 || k > arr.length) {\r\n            return [];\r\n        }\r\n        if (k === 0) {\r\n            return [[]];\r\n        }\r\n        if (k === arr.length) {\r\n            return [arr];\r\n        }\r\n        if (k === 1) {\r\n            return arr.map(e => [e]);\r\n        }\r\n        const combs = [];\r\n        for (let i = 0; i < arr.length - k + 1; i++) {\r\n            const head = arr.slice(i, i + 1);\r\n            const tailCombs = getCombinations(arr.slice(i + 1), k - 1);\r\n            for (let j = 0; j < tailCombs.length; j++) {\r\n                combs.push(head.concat(tailCombs[j]));\r\n            }\r\n        }\r\n        return combs;\r\n    }\r\n\r\n    // Helper function to find the best team combination within a group of 4 players\r\n    function findBestCombination(fourPlayers) {\r\n        let bestCombination = null;\r\n        let minDiff = Infinity;\r\n        const combinations = [\r\n            [[0, 1], [2, 3]],\r\n            [[0, 2], [1, 3]],\r\n            [[0, 3], [1, 2]]\r\n        ];\r\n\r\n        combinations.forEach(combo => {\r\n            const team1 = combo[0].map(i => fourPlayers[i]);\r\n            const team2 = combo[1].map(i => fourPlayers[i]);\r\n            const team1Score = team1.reduce((sum, p) => sum + p.score, 0);\r\n            const team2Score = team2.reduce((sum, p) => sum + p.score, 0);\r\n            const diff = Math.abs(team1Score - team2Score);\r\n\r\n            if (diff < minDiff) {\r\n                minDiff = diff;\r\n                bestCombination = {\r\n                    team1: team1.map(p => p.player),\r\n                    team2: team2.map(p => p.player)\r\n                };\r\n            }\r\n        });\r\n        return bestCombination;\r\n    }\r\n\r\n    function clearSuggestionHighlights() {\r\n        // Clear the active suggestion from the state\r\n        delete state.activeSuggestion;\r\n        \r\n        // THIS IS THE FIX: Clear the player selection array\r\n        state.selection.players = [];\r\n\r\n        // Re-render the UI to remove all highlights and deactivate court selection\r\n        render();\r\n        \r\n        // After rendering, ensure the animations are correctly hidden\r\n        ensureCourtSelectionAnimation();\r\n    }\r\n\r\n\r\n    function renderTeamHistory() {\r\n        const teamStats = calculateTeamStats(state.gameHistory);\r\n        const teamHistoryList = document.getElementById('team-history-list');\r\n        teamHistoryList.innerHTML = \"\";\r\n\r\n        let teamsWithStats = Object.values(teamStats).filter(team => {\r\n            if (state.statsFilter.teamGender === 'all') return true;\r\n            return team.type.toLowerCase() === state.statsFilter.teamGender;\r\n        });\r\n\r\n        // --- H2H FILTERING LOGIC ---\r\n        if (state.comparison.active && state.comparison.items.length === 1) {\r\n            const selectedTeamKey = state.comparison.items[0];\r\n            teamsWithStats = teamsWithStats.filter(team => {\r\n                const teamKey = [...team.players].sort().join(' & ');\r\n                // Filter the list to only include the selected team and its opponents\r\n                return teamKey === selectedTeamKey || state.comparison.opponents.has(teamKey);\r\n            });\r\n        }\r\n        // --- END H2H FILTERING ---\r\n\r\n        teamsWithStats.sort((a, b) => {\r\n            const statA = a;\r\n            const statB = b;\r\n            let compareValue = 0;\r\n            if (state.statsFilter.sortKey === 'name') {\r\n                compareValue = a.players.join(',').localeCompare(b.players.join(','));\r\n            } else {\r\n                compareValue = (statB[state.statsFilter.sortKey] || 0) - (statA[state.statsFilter.sortKey] || 0);\r\n            }\r\n            return state.statsFilter.sortOrder === 'asc' ? -compareValue : compareValue;\r\n        });\r\n\r\n        const genderFilterHTML = `\r\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\r\n                <div class=\"radio-group\">\r\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"all\" ${state.statsFilter.teamGender === 'all' ? 'checked' : ''}> All </label>\r\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"men\" ${state.statsFilter.teamGender === 'men' ? 'checked' : ''}> Men </label>\r\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"women\" ${state.statsFilter.teamGender === 'women' ? 'checked' : ''}> Women </label>\r\n                    <label> <input type=\"radio\" name=\"team-gender-filter\" value=\"mixed\" ${state.statsFilter.teamGender === 'mixed' ? 'checked' : ''}> Mixed </label>\r\n                </div>\r\n            </div>`;\r\n\r\n        if (teamsWithStats.length === 0) {\r\n            teamHistoryList.innerHTML = genderFilterHTML + '<p style=\"text-align: center; color: #6c757d;\">No team stats available for the selected filter.</p>';\r\n        } else {\r\n            const getSortIcon = (key) => (state.statsFilter.sortKey !== key) ? ' ' : (state.statsFilter.sortOrder === 'asc' ? ' 🔼' : ' 🔽');\r\n\r\n            const tableHeader = `\r\n                <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\r\n                    <div class=\"stats-grid-row\">\r\n                        <button class=\"sort-btn\" data-sort-key=\"name\" style=\"text-align: left; background: none; border: none; font-weight: bold; cursor: pointer;\">Team${getSortIcon('name')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"played\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Played${getSortIcon('played')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"won\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Won %${getSortIcon('won')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"totalDurationMs\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Time${getSortIcon('totalDurationMs')}</button>\r\n                    </div>\r\n                </div>`;\r\n\r\n            const teamRows = teamsWithStats.map(team => {\r\n                const winPercentage = formatWinPercentage(team.played, team.won);\r\n                const teamNameHTML = team.players.map(name => `<span>${name}</span>`).join('');\r\n\r\n                const teamKey = [...team.players].sort().join(' & ');\r\n                let rowClass = '';\r\n                if(state.comparison.items.includes(teamKey)) {\r\n                    rowClass = 'selected-for-comparison';\r\n                }\r\n\r\n                return `\r\n                    <div class=\"history-item ${rowClass}\" data-name=\"${teamKey}\" data-type=\"team\">\r\n                        <div class=\"stats-grid-row\">\r\n                            <span class=\"team-name-stacked\">${teamNameHTML}</span>\r\n                            <span>${team.played}</span>\r\n                            <span>${winPercentage}</span>\r\n                            <span>${formatDuration(team.totalDurationMs)}</span>\r\n                        </div>\r\n                    </div>`;\r\n            }).join('');\r\n\r\n            teamHistoryList.innerHTML = genderFilterHTML + tableHeader + teamRows;\r\n        }\r\n\r\n        teamHistoryList.querySelectorAll('input[name=\"team-gender-filter\"]').forEach(radio => radio.addEventListener('change', handleTeamStatsFilterChange));\r\n        teamHistoryList.querySelectorAll('.sort-btn').forEach(btn => btn.addEventListener('click', handleSortClick));\r\n\r\n        // Apply comparison styling immediately after render\r\n        if (state.comparison.active && state.comparison.type === 'team') {\r\n            const teamItems = teamHistoryList.querySelectorAll('.history-item[data-type=\"team\"]');\r\n            teamItems.forEach(item => {\r\n                const teamKey = item.dataset.name;\r\n                if (state.comparison.items.includes(teamKey)) {\r\n                    item.classList.add('selected-for-comparison');\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n\r\n    function handleTeamStatsFilterChange(e) {\r\n        state.statsFilter.teamGender = e.target.value;\r\n        saveState();\r\n        renderTeamHistory();\r\n    }\r\n\r\n    // --- NEW COMPARISON MODAL FUNCTIONS ---\r\n\r\n    function calculateComparisonStats() {\r\n        const { type, items, timeFrame } = state.comparison;\r\n        if (items.length < 2) return null;\r\n\r\n        const item1Name = items[0];\r\n        const item2Name = items[1];\r\n\r\n        const games = state.gameHistory.filter(game => isGameInTimeFrame(game, timeFrame));\r\n\r\n        let headToHeadGames = [];\r\n\r\n        if (type === 'player') {\r\n            headToHeadGames = games.filter(game => {\r\n                const team1Players = game.teams.team1;\r\n                const team2Players = game.teams.team2;\r\n                const item1OnTeam1 = team1Players.includes(item1Name);\r\n                const item2OnTeam1 = team1Players.includes(item2Name);\r\n                const item1OnTeam2 = team2Players.includes(item1Name);\r\n                const item2OnTeam2 = team2Players.includes(item2Name);\r\n                return (item1OnTeam1 && item2OnTeam2) || (item1OnTeam2 && item2OnTeam1);\r\n            });\r\n        } else { // 'team'\r\n            headToHeadGames = games.filter(game => {\r\n                const team1Key = [...game.teams.team1].sort().join(' & ');\r\n                const team2Key = [...game.teams.team2].sort().join(' & ');\r\n                return (team1Key === item1Name && team2Key === item2Name) || (team1Key === item2Name && team2Key === item1Name);\r\n            });\r\n        }\r\n\r\n        const uniqueDays = new Set(headToHeadGames.map(game => new Date(game.endTime).toISOString().split('T')[0]));\r\n        const totalDaysPlayed = uniqueDays.size;\r\n\r\n        if (headToHeadGames.length === 0) {\r\n            return {\r\n                totalSets: 0,\r\n                totalTimeMs: 0,\r\n                totalDaysPlayed: 0,\r\n                item1: { name: item1Name, setsWon: 0, gamesWon: 0 },\r\n                item2: { name: item2Name, setsWon: 0, gamesWon: 0 },\r\n            };\r\n        }\r\n\r\n        let totalTimeMs = 0;\r\n        let item1SetsWon = 0;\r\n        let item2SetsWon = 0;\r\n        let item1GamesWon = 0;\r\n        let item2GamesWon = 0;\r\n\r\n        headToHeadGames.forEach(game => {\r\n            const [h, m] = game.duration.split('h').map(s => parseInt(s.replace('m', ''), 10));\r\n            totalTimeMs += (h * 3600000) + (m * 60000);\r\n\r\n            if (game.winner === 'skipped') return;\r\n\r\n            const isItem1Winner = (game.winner === 'team1' && (type === 'player' ? game.teams.team1.includes(item1Name) : [...game.teams.team1].sort().join(' & ') === item1Name)) || (game.winner === 'team2' && (type === 'player' ? game.teams.team2.includes(item1Name) : [...game.teams.team2].sort().join(' & ') === item1Name));\r\n\r\n            if(isItem1Winner) item1SetsWon++;\r\n            else item2SetsWon++;\r\n\r\n            if (game.score) {\r\n                const team1Score = game.score.team1 || 0;\r\n                const team2Score = game.score.team2 || 0;\r\n\r\n                const isItem1OnTeam1 = type === 'player' ? game.teams.team1.includes(item1Name) : [...game.teams.team1].sort().join(' & ') === item1Name;\r\n\r\n                if (isItem1OnTeam1) {\r\n                    item1GamesWon += team1Score;\r\n                    item2GamesWon += team2Score;\r\n                } else {\r\n                    item1GamesWon += team2Score;\r\n                    item2GamesWon += team1Score;\r\n                }\r\n            }\r\n        });\r\n\r\n        return {\r\n            totalSets: headToHeadGames.length,\r\n            totalTimeMs: totalTimeMs,\r\n            totalDaysPlayed: totalDaysPlayed,\r\n            item1: { name: item1Name, setsWon: item1SetsWon, gamesWon: item1GamesWon },\r\n            item2: { name: item2Name, setsWon: item2SetsWon, gamesWon: item2GamesWon },\r\n        };\r\n    }\r\n\r\n    function renderComparisonModal() {\r\n        const stats = calculateComparisonStats();\r\n        if (!stats) {\r\n            comparisonContent.innerHTML = \"<p>Error calculating stats.</p>\";\r\n            return;\r\n        }\r\n\r\n        const { totalSets, totalTimeMs, totalDaysPlayed, item1, item2 } = stats;\r\n\r\n        const item1WinPct = totalSets > 0 ? Math.round((item1.setsWon / totalSets) * 100) : 0;\r\n        const item2WinPct = totalSets > 0 ? Math.round((item2.setsWon / totalSets) * 100) : 0;\r\n\r\n        const totalGamesPlayed = item1.gamesWon + item2.gamesWon;\r\n        const item1GamesWinPct = totalGamesPlayed > 0 ? Math.round((item1.gamesWon / totalGamesPlayed) * 100) : 0;\r\n        const item2GamesWinPct = totalGamesPlayed > 0 ? Math.round((item2.gamesWon / totalGamesPlayed) * 100) : 0;\r\n        \r\n        // --- UPDATED: Determine winner and loser classes for styling ---\r\n        let item1SetsNameClass = '', item2SetsNameClass = '';\r\n        if (item1.setsWon > item2.setsWon) {\r\n            item1SetsNameClass = 'h2h-winner-text';\r\n            item2SetsNameClass = 'h2h-loser-text'; // Loser\r\n        } else if (item2.setsWon > item1.setsWon) {\r\n            item1SetsNameClass = 'h2h-loser-text'; // Loser\r\n            item2SetsNameClass = 'h2h-winner-text';\r\n        }\r\n\r\n        let item1SetsBgClass = '', item2SetsBgClass = '';\r\n        if (item1.setsWon > item2.setsWon) {\r\n            item1SetsBgClass = 'h2h-winner-bg';\r\n            item2SetsBgClass = 'h2h-loser-bg';\r\n        } else if (item2.setsWon > item1.setsWon) {\r\n            item1SetsBgClass = 'h2h-loser-bg';\r\n            item2SetsBgClass = 'h2h-winner-bg';\r\n        }\r\n\r\n        let item1GamesBgClass = '', item2GamesBgClass = '';\r\n        if (item1.gamesWon > item2.gamesWon) {\r\n            item1GamesBgClass = 'h2h-winner-bg';\r\n            item2GamesBgClass = 'h2h-loser-bg';\r\n        } else if (item2.gamesWon > item1.gamesWon) {\r\n            item1GamesBgClass = 'h2h-loser-bg';\r\n            item2GamesBgClass = 'h2h-winner-bg';\r\n        }\r\n        \r\n        comparisonTitle.textContent = `Head-to-Head: ${state.comparison.type === 'player' ? 'Players' : 'Teams'}`;\r\n\r\n        comparisonFilterContainer.innerHTML = createGameHistoryFilters();\r\n        comparisonFilterContainer.querySelectorAll('input[name=\"game-time-filter\"]').forEach(radio => {\r\n            radio.addEventListener('change', (e) => {\r\n                state.comparison.timeFrame = e.target.value;\r\n                renderComparisonModal();\r\n            });\r\n        });\r\n        const activeRadio = comparisonFilterContainer.querySelector(`input[value=\"${state.comparison.timeFrame}\"]`);\r\n        if(activeRadio) activeRadio.checked = true;\r\n\r\n        comparisonContent.innerHTML = `\r\n            <div class=\"comparison-grid-content\">\r\n                <div class=\"comparison-column\">\r\n                    <div class=\"comparison-header ${item1SetsNameClass}\">${item1.name.replace(/ \\& /g, '<br>')}</div>\r\n                    <div class=\"comparison-stat-card ${item1SetsBgClass}\">\r\n                        <div class=\"label\">Sets Won</div>\r\n                        <div class=\"value\">${item1.setsWon}</div>\r\n                        <div class=\"win-percentage\">${item1WinPct}% of sets</div>\r\n                    </div>\r\n                    <div class=\"comparison-stat-card ${item1GamesBgClass}\">\r\n                        <div class=\"label\">Games Won</div>\r\n                        <div class=\"value\">${item1.gamesWon}</div>\r\n                        <div class=\"win-percentage\">${item1GamesWinPct}% of games</div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"comparison-column\">\r\n                    <div class=\"comparison-header ${item2SetsNameClass}\">${item2.name.replace(/ \\& /g, '<br>')}</div>\r\n                    <div class=\"comparison-stat-card ${item2SetsBgClass}\">\r\n                        <div class=\"label\">Sets Won</div>\r\n                        <div class=\"value\">${item2.setsWon}</div>\r\n                        <div class=\"win-percentage\">${item2WinPct}% of sets</div>\r\n                    </div>\r\n                    <div class=\"comparison-stat-card ${item2GamesBgClass}\">\r\n                        <div class=\"label\">Games Won</div>\r\n                        <div class=\"value\">${item2.gamesWon}</div>\r\n                        <div class=\"win-percentage\">${item2GamesWinPct}% of games</div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"comparison-summary-row\">\r\n                    <div class=\"comparison-summary-card\">\r\n                        <div class=\"label\">Total Days Played</div>\r\n                        <div class=\"value\">${totalDaysPlayed}</div>\r\n                    </div>\r\n                    <div class=\"comparison-summary-card\">\r\n                        <div class=\"label\">Total Time on Court</div>\r\n                        <div class=\"value\">${formatDuration(totalTimeMs)}</div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"comparison-summary-row\">\r\n                    <div class=\"comparison-summary-card\">\r\n                        <div class=\"label\">Total Sets Played</div>\r\n                        <div class=\"value\">${totalSets}</div>\r\n                    </div>\r\n                    <div class=\"comparison-summary-card\">\r\n                        <div class=\"label\">Total Games Played</div>\r\n                        <div class=\"value\">${totalGamesPlayed}</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        historyPage.classList.add('hidden');\r\n        comparisonModal.classList.remove('hidden');\r\n    }\r\n\r\n    function resetComparisonState() {\r\n        state.comparison = { active: false, type: null, items: [], timeFrame: 'Total', opponents: new Set() };\r\n        document.querySelectorAll('.selected-for-comparison').forEach(el => el.classList.remove('selected-for-comparison'));\r\n        document.querySelectorAll('.not-a-match').forEach(el => el.classList.remove('not-a-match'));\r\n        saveState(); // Add this line\r\n    }\r\n\r\n    // --- NEW FUNCTION TO RESET FILTERS ---\r\n    function resetStatsFilters() {\r\n        state.statsFilter = {\r\n            gender: 'all',\r\n            teamGender: 'all',\r\n            sortKey: 'totalDurationMs',\r\n            sortOrder: 'desc'\r\n        };\r\n        state.gameHistoryFilter = {\r\n            timeFrame: 'Total',\r\n            gameType: 'all'\r\n        };\r\n        state.historySort = {\r\n            key: 'endTime',\r\n            order: 'desc'\r\n        };\r\n        saveState(); // Save the reset state\r\n    }\r\n\r\n\r\n    // Helper function to check if a game falls within the selected time frame\r\n    function isGameInTimeFrame(game, timeFrame) {\r\n        const gameDate = new Date(game.endTime);\r\n        const now = new Date();\r\n\r\n        const gameYear = gameDate.getFullYear();\r\n        const currentYear = now.getFullYear();\r\n\r\n        switch (timeFrame) {\r\n            case 'Today':\r\n                return gameDate.toISOString().split('T')[0] === now.toISOString().split('T')[0];\r\n            case 'Month':\r\n                return gameYear === currentYear && gameDate.getMonth() === now.getMonth();\r\n            case 'Year':\r\n                return gameYear === currentYear;\r\n            case 'Total':\r\n            default:\r\n                return true;\r\n        }\r\n    }\r\n\r\n    // Handler for the time frame filter change\r\n    function handleGameTimeFilterChange(e) {\r\n        state.gameHistoryFilter.timeFrame = e.target.value;\r\n        saveState();\r\n        renderGameHistory();\r\n    }\r\n\r\n    // Handler for the game type filter change\r\n    function handleGameTypeFilterChange(e) {\r\n        state.gameHistoryFilter.gameType = e.target.value;\r\n        saveState();\r\n        renderGameHistory();\r\n    }\r\n\r\n    function handleHistorySortClick(e) {\r\n        const key = e.target.dataset.sortKey;\r\n        if (!key) return;\r\n\r\n        if (state.historySort.key === key) {\r\n            state.historySort.order = state.historySort.order === 'asc' ? 'desc' : 'asc';\r\n        } else {\r\n            state.historySort.key = key;\r\n            state.historySort.order = 'desc'; // Default to descending for any new column\r\n        }\r\n        renderGameHistory(); // Re-render just the game history list\r\n        saveState();\r\n    } \r\n\r\n    function createCourtCard(court) {\r\n        const requiredPlayers = state.selection.gameMode === \"doubles\" ? 4 : 2;\r\n        const playersSelected = state.selection.players.length;\r\n        const selectionComplete = playersSelected === requiredPlayers;\r\n\r\n        const isCollapsed = court.isCollapsed;\r\n        const isModeOverlayActive = court.isModeOverlayActive === true;\r\n        const courtMode = court.courtMode || 'doubles';\r\n        const bodyClass = isCollapsed ? 'is-collapsed' : '';\r\n        const iconClass = isCollapsed ? 'mdi-chevron-down' : 'mdi-chevron-up';\r\n\r\n        // --- CORE LOGIC FOR RESERVED / SELECTABLE STATES ---\r\n        let isReservedSelectable = false;\r\n        let isGreenBallSelectable = false;\r\n\r\n        // Selection logic only runs if enough players are selected to potentially start *a game* (2 players).\r\n        if (court.status === 'available' && playersSelected >= 2) {\r\n\r\n            // CRITERIA FOR RED BALL (Reserved/Exclusionary)\r\n            if (courtMode === 'league' && selectionComplete) {\r\n                isReservedSelectable = true;\r\n            }\r\n            // Singles court reserved if 4 players selected (incompatible with singles court)\r\n            else if (courtMode === 'singles' && playersSelected === 4) {\r\n                isReservedSelectable = true;\r\n            }\r\n            // Block Doubles, League, AND Rookie courts when Singles is selected\r\n            else if (requiredPlayers === 2 && (courtMode === 'doubles' || courtMode === 'league' || courtMode === 'rookie')) {\r\n                isReservedSelectable = true;\r\n            }\r\n\r\n            // CRITERIA FOR GREEN BALL (Selectable for Play)\r\n            if (!isReservedSelectable && selectionComplete) {\r\n                if (requiredPlayers === 2) {\r\n                    // User selected 2 players (Singles Mode)\r\n                    if (courtMode === 'singles') {\r\n                        isGreenBallSelectable = true;\r\n                    }\r\n                } else if (requiredPlayers === 4) {\r\n                    // User selected 4 players (Doubles Mode)\r\n                    if (courtMode === 'doubles' || courtMode === 'rookie') {\r\n                        isGreenBallSelectable = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        const isSelectable = isGreenBallSelectable || isReservedSelectable;\r\n        const selectionMinimumMet = playersSelected >= 2;\r\n        const finalIsSelectable = selectionMinimumMet && isSelectable;\r\n        const reservedClass = isReservedSelectable && !isGreenBallSelectable ? 'is-reserved-only' : '';\r\n        const isSelected = court.id === state.selection.courtId;\r\n\r\n        let statusText;\r\n        let isLeagueReserved = false;\r\n        let isRookieMode = courtMode === 'rookie';\r\n\r\n        if (isSelected) {\r\n            statusText = 'SELECTED';\r\n        } else if (court.status === 'available' && courtMode === 'league') {\r\n            statusText = 'League';\r\n            isLeagueReserved = true;\r\n        } else if (court.status === 'available' && isRookieMode) {\r\n            statusText = 'Rookie';\r\n        } else {\r\n            statusText = court.status.replace(/_/g, ' ');\r\n        }\r\n\r\n        const courtCard = document.createElement('div');\r\n\r\n        let modeClass = '';\r\n        if (court.status === 'available') {\r\n            if (isLeagueReserved) {\r\n                modeClass = 'is-league-reserved';\r\n            } else if (isRookieMode) {\r\n                modeClass = 'is-rookie-mode';\r\n            }\r\n        }\r\n\r\n        courtCard.className = `court-card status-${court.status} ${isSelected ? 'selected' : ''} ${finalIsSelectable ? 'selectable' : ''} ${bodyClass} ${reservedClass} ${modeClass}`;\r\n        \r\n        courtCard.dataset.courtId = court.id;\r\n        if (isModeOverlayActive) {\r\n            courtCard.dataset.modeOverlayActive = 'true';\r\n        }\r\n\r\n        let cancelBtnHTML = '';\r\n        let editBtnHTML = '';\r\n\r\n        if (court.status !== 'available' && !isSelected) {\r\n            cancelBtnHTML = `<button class=\"cancel-game-btn on-court\" title=\"Cancel Game\" data-action=\"cancel-game-setup\">X</button>`;\r\n        }\r\n\r\n        // --- UPDATED: Always show pencil icon for in-progress games ---\r\n        if (court.status === 'in_progress') {\r\n            // Always show the edit/manage players button (pencil icon)\r\n            editBtnHTML = `<button class=\"edit-game-btn on-court\" title=\"Manage Players\" data-action=\"edit-game\"><i class=\"mdi mdi-pencil\"></i></button>`;\r\n        } else if (court.status === 'game_pending' && court.teamsSet === false) {\r\n            // For pending doubles games that need teams chosen, still show team icon\r\n            editBtnHTML = `<button class=\"edit-game-btn on-court\" title=\"Set Teams\" data-action=\"choose-teams\"><i class=\"mdi mdi-account-group-outline\"></i></button>`;\r\n        }\r\n        // --- END UPDATED ---\r\n\r\n        const moreOptionsBtnHTML = `\r\n            <button class=\"more-options-btn on-court\" title=\"More Options\" data-action=\"more-options\" data-court-id=\"${court.id}\">\r\n                <i class=\"mdi mdi-dots-horizontal\"></i>\r\n            </button>\r\n        `;\r\n\r\n        const modeOverlayHTML = `\r\n            <div class=\"mode-selection-overlay\" data-court-id=\"${court.id}\">\r\n                <button class=\"mode-btn-overlay doubles-mode\" data-action=\"set-court-mode\" data-mode=\"doubles\">Doubles</button>\r\n                <button class=\"mode-btn-overlay singles-mode\" data-action=\"set-court-mode\" data-mode=\"singles\">Singles</button>\r\n                <button class=\"mode-btn-overlay beginner-mode\" data-action=\"set-court-mode\" data-mode=\"rookie\">Rookie</button>\r\n                <button class=\"mode-btn-overlay league-mode\" data-action=\"set-court-mode\" data-mode=\"league\">League</button>\r\n            </div>\r\n        `;\r\n\r\n        const courtIndex = COURT_HIERARCHY.indexOf(court.id);\r\n        const staticStaggerMs = courtIndex >= 0 ? courtIndex * 500 : 0;\r\n\r\n        let animationDurationMs = 4000;\r\n        if (courtMode === 'rookie') {\r\n            animationDurationMs = 8000;\r\n        }\r\n\r\n        const elapsedTime = Date.now() - state.pongAnimationOffset;\r\n        const currentOffsetMs = (elapsedTime + staticStaggerMs) % animationDurationMs;\r\n        const delayStyle = `animation-delay: -${(currentOffsetMs / 1000).toFixed(3)}s;`;\r\n\r\n        const pongAnimationSinglesHTML = `\r\n            <div class=\"pong-animation-container\" data-mode=\"singles\">\r\n                <div class=\"pong-paddle top-paddle\" style=\"animation-name: pong-top-move; ${delayStyle}\"></div>\r\n                <div class=\"pong-paddle bottom-paddle\" style=\"animation-name: pong-bottom-move; ${delayStyle}\"></div>\r\n                <div class=\"pong-ball\" style=\"${delayStyle}\"></div>\r\n            </div>\r\n        `;\r\n\r\n        const pongAnimationDoublesHTML = `\r\n            <div class=\"pong-animation-container\" data-mode=\"doubles\">\r\n                <div class=\"pong-paddle double dl top-paddle\" style=\"animation-name: pong-move-tl; ${delayStyle}\"></div>\r\n                <div class=\"pong-paddle double dr top-paddle\" style=\"animation-name: pong-move-tr; ${delayStyle}\"></div>\r\n                <div class=\"pong-paddle double dl bottom-paddle\" style=\"animation-name: pong-move-bl; ${delayStyle}\"></div>\r\n                <div class=\"pong-paddle double dr bottom-paddle\" style=\"animation-name: pong-move-br; ${delayStyle}\"></div>\r\n                <div class=\"pong-ball\" style=\"${delayStyle}\"></div>\r\n            </div>\r\n        `;\r\n\r\n        const pongAnimationRedBallHTML = `\r\n            <div class=\"pong-animation-container\" data-mode=\"in_progress\">\r\n                <div class=\"pong-ball red-ball-in-progress\" style=\"${delayStyle}\"></div>\r\n            </div>\r\n        `;\r\n\r\n        let bodyTimerHTML = '';\r\n        if (court.status === 'in_progress' || court.status === 'game_pending') {\r\n            bodyTimerHTML = `<div class=\"court-body-timer status-${court.status}\" id=\"timer-${court.id}\"></div>`;\r\n        }\r\n\r\n        const formatName = (playerObj) => playerObj ? playerObj.name.split(' ')[0] : '';\r\n\r\n        let playerSpotsHTML = '';\r\n        let coreReserveTextHTML = '';\r\n        let animationHTML = '';\r\n        let matchModeDisplayHTML = '';\r\n\r\n        if ((court.status === 'in_progress' || court.status === 'game_pending') && court.matchMode) {\r\n            let text = '';\r\n            if (court.matchMode === 'fast') {\r\n                text = `Fast Play (${court.fastPlayGames} games)`;\r\n            } else if (court.matchMode === '1set') {\r\n                text = '1 Set Match';\r\n            } else if (court.matchMode === '3set') {\r\n                text = '3 Set Match';\r\n            }\r\n            if (text) {\r\n                matchModeDisplayHTML = `<div class=\"match-mode-display\">${text}</div>`;\r\n            }\r\n        }\r\n\r\n        // --- DRAGGABLE PLAYER NAMES ---\r\n        const makeDraggable = (court.status === 'in_progress' || court.status === 'game_pending');\r\n        const draggableAttr = makeDraggable ? 'draggable=\"true\"' : '';\r\n        const draggableClass = makeDraggable ? 'draggable-player' : '';\r\n\r\n        if (court.status !== 'available') {\r\n            if (court.gameMode === 'singles') {\r\n                playerSpotsHTML = `\r\n                    <div class=\"player-spot single-player top-row\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[0]?.name || ''}\" data-player-pos=\"top\">\r\n                        <span class=\"${draggableClass}\">${formatName(court.teams.team1[0])}</span>\r\n                    </div>\r\n                    <div class=\"player-spot single-player bottom-row\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[0]?.name || ''}\" data-player-pos=\"bottom\">\r\n                        <span class=\"${draggableClass}\">${formatName(court.teams.team2[0])}</span>\r\n                    </div>\r\n                `;\r\n            } else {\r\n                if (court.teamsSet === false) {\r\n                    playerSpotsHTML = `\r\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[0]?.name || ''}\" data-team=\"unset\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.players[0])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[1]?.name || ''}\" data-team=\"unset\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.players[1])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[2]?.name || ''}\" data-team=\"unset\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.players[2])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.players[3]?.name || ''}\" data-team=\"unset\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.players[3])}</span>\r\n                        </div>\r\n                    `;\r\n                } else {\r\n                    playerSpotsHTML = `\r\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[0]?.name || ''}\" data-team=\"team1\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team1[0])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot top-row\" data-player-pos=\"top-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team1[1]?.name || ''}\" data-team=\"team1\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team1[1])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-left\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[0]?.name || ''}\" data-team=\"team2\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team2[0])}</span>\r\n                        </div>\r\n                        <div class=\"player-spot bottom-row\" data-player-pos=\"bottom-right\" ${draggableAttr} data-court-id=\"${court.id}\" data-player-name=\"${court.teams.team2[1]?.name || ''}\" data-team=\"team2\">\r\n                            <span class=\"${draggableClass}\">${formatName(court.teams.team2[1])}</span>\r\n                        </div>\r\n                    `;\r\n                }\r\n            }\r\n\r\n            if (court.status === 'in_progress') {\r\n                animationHTML = pongAnimationRedBallHTML;\r\n            }\r\n        }\r\n        // --- END DRAGGABLE PLAYER NAMES ---\r\n\r\n        let overlayHTML = '';\r\n\r\n        if (isSelected) {\r\n            const readyClass = selectionComplete ? 'is-ready' : '';\r\n            overlayHTML = `\r\n                <div class=\"confirmation-overlay\">\r\n                    <button class=\"court-confirm-btn cancel\" data-action=\"cancel-selection\">Cancel</button>\r\n                    <button class=\"court-confirm-btn confirm ${readyClass}\" data-action=\"confirm-selection\">Confirm</button>\r\n                </div>\r\n            `;\r\n        } else if (finalIsSelectable) {\r\n            const ballClass = isReservedSelectable ? 'reserved-ball' : '';\r\n            const isEligibleForSelection = isGreenBallSelectable ? '' : 'data-reserved-only=\"true\"';\r\n            const disabledAttr = isReservedSelectable || isLeagueReserved ? 'disabled' : '';\r\n            const buttonText = isReservedSelectable || isLeagueReserved ? '' : `SELECT<br>COURT ${court.id}`;\r\n\r\n            overlayHTML = `\r\n                <div class=\"court-selection-overlay\">\r\n                    <button class=\"court-confirm-btn select-court ${ballClass}\" data-action=\"select-court-action\" ${isEligibleForSelection} ${disabledAttr}>${buttonText}</button>\r\n                </div>\r\n            `;\r\n        }\r\n        else if (court.status === 'selecting_teams') {\r\n            overlayHTML = `\r\n                <div class=\"team-selection-overlay\">\r\n                    <button class=\"court-confirm-btn randomize\" data-action=\"randomize-teams\">Randomize Teams</button>\r\n                    <button class=\"court-confirm-btn choose\" data-action=\"choose-teams\">Choose Teams</button>\r\n                    <button class=\"court-confirm-btn choose-later\" data-action=\"choose-later\">Choose Later</button>\r\n                </div>\r\n            `;\r\n        } else if (court.status === 'game_pending') {\r\n            overlayHTML = `\r\n                <div class=\"game-action-overlay\">\r\n                    <button class=\"court-confirm-btn select-court\" data-action=\"start-game\">START MATCH</button>\r\n                </div>\r\n            `;\r\n        } else if (court.status === 'in_progress') {\r\n            const ballClass = court.isNewGame ? 'animate-in' : 'visible';\r\n            overlayHTML = `\r\n                <div class=\"game-action-overlay\">\r\n                    <button class=\"court-confirm-btn end-game-ball ${ballClass}\" data-action=\"end-game\">END<br>MATCH</button>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        let reserveTextHTML = coreReserveTextHTML;\r\n\r\n        if (court.status === 'available') {\r\n            reserveTextHTML = '';\r\n\r\n            if (courtMode === 'league') {\r\n                playerSpotsHTML = `<div class=\"league-reserved-icon-container\"></div>`;\r\n            } else if (courtMode === 'singles') {\r\n                playerSpotsHTML = pongAnimationSinglesHTML;\r\n            } else if (courtMode === 'doubles' || courtMode === 'rookie') {\r\n                playerSpotsHTML = pongAnimationDoublesHTML;\r\n            } else {\r\n                playerSpotsHTML = '';\r\n            }\r\n        }\r\n\r\n        const light = state.lightSettings.courts[court.id];\r\n        const isLightManaged = light && light.isManaged;\r\n        const lightIconClass = isLightManaged && light.isActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline';\r\n        const lightDisabledAttr = isLightManaged ? '' : 'disabled';\r\n\r\n        const lightBtnHTML = `\r\n            <button class=\"light-toggle-btn on-court\" title=\"Toggle Lights\" data-action=\"toggle-light\" data-court-id=\"${court.id}\" ${lightDisabledAttr}>\r\n                <i class=\"mdi ${lightIconClass}\"></i>\r\n            </button>\r\n        `;\r\n\r\n        courtCard.innerHTML = `\r\n            <div class=\"card-header header-status-${court.status}\">\r\n                <h3>Court ${court.id}</h3>\r\n                <div class=\"header-controls\">\r\n                    <span class=\"status-tag\">${statusText}</span>\r\n                    <button class=\"settings-btn summary-toggle-btn\" data-court-id=\"${court.id}\" data-card-type=\"court\" title=\"Toggle Details\">\r\n                        <i class=\"mdi ${iconClass}\"></i>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <div class=\"court-inner\">\r\n                    ${bodyTimerHTML}\r\n                    <div class=\"center-service-line\"></div>\r\n                    ${playerSpotsHTML}\r\n                    ${animationHTML}\r\n                    ${overlayHTML}\r\n                    ${reserveTextHTML}\r\n                    ${matchModeDisplayHTML}\r\n                    ${modeOverlayHTML}\r\n                </div>\r\n                ${cancelBtnHTML}\r\n                ${editBtnHTML}\r\n                ${moreOptionsBtnHTML}\r\n                ${lightBtnHTML}\r\n            </div>`;\r\n\r\n        return courtCard;\r\n    }\r\n\r\n    // NEW FUNCTION: Calculate the players with the highest stats overall\r\n    function calculateStarPlayers() {\r\n        // --- THIS IS THE NEW LOGIC ---\r\n        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format\r\n        const todaysGames = state.gameHistory.filter(game => {\r\n            const gameDate = new Date(game.endTime).toISOString().split('T')[0];\r\n            return gameDate === today;\r\n        });\r\n        const stats = calculatePlayerStats(todaysGames); // Calculate stats for ONLY today's games\r\n        // --- END OF NEW LOGIC ---\r\n\r\n        const allPlayers = getAllKnownPlayers();\r\n\r\n        let king = { name: null, wp: -1, duration: -1 };\r\n        let queen = { name: null, wp: -1, duration: -1 };\r\n\r\n        for (const name in stats) {\r\n            const playerStats = stats[name];\r\n            const playerObj = allPlayers.find(p => p.name === name);\r\n\r\n            // Skip players who opted out of the leaderboard, have no stats, or lack gender info\r\n            if (!playerObj || playerStats.played === 0 || playerObj.onLeaderboard === false || !playerObj.gender) {\r\n                continue;\r\n            }\r\n\r\n            const winPercentage = playerStats.won / playerStats.played;\r\n\r\n            if (playerObj.gender === 'M') {\r\n                if (winPercentage > king.wp) {\r\n                    king = { name: name, wp: winPercentage, duration: playerStats.totalDurationMs };\r\n                } else if (winPercentage === king.wp && playerStats.totalDurationMs > king.duration) {\r\n                    king = { name: name, wp: winPercentage, duration: playerStats.totalDurationMs };\r\n                }\r\n            } else if (playerObj.gender === 'F') {\r\n                if (winPercentage > queen.wp) {\r\n                    queen = { name: name, wp: winPercentage, duration: playerStats.totalDurationMs };\r\n                } else if (winPercentage === queen.wp && playerStats.totalDurationMs > queen.duration) {\r\n                    queen = { name: name, wp: winPercentage, duration: playerStats.totalDurationMs };\r\n                }\r\n            }\r\n        }\r\n\r\n        return {\r\n            kingOfTheCourt: king.name,\r\n            queenOfTheCourt: queen.name\r\n        };\r\n    }\r\n    // END NEW FUNCTION\r\n\r\n    function createSummaryCard() {\r\n        const total = totalPlayersAtClub();\r\n        const available = getActivePlayerCount();\r\n        const onCourt = total - available;\r\n        const availableCourtsCount = state.courts.filter(\r\n            c => state.courtSettings.visibleCourts.includes(c.id) && c.status === 'available'\r\n        ).length;\r\n        const totalVisibleCourts = state.courtSettings.visibleCourts.length;\r\n        const onDutyName = state.onDuty === 'None' ? 'Nobody' : state.onDuty;\r\n        const dutyLabel = state.onDuty === 'None' ? 'Call Any Committee Member!' : 'Is On Duty. Call Me!';\r\n\r\n        const { kingOfTheCourt, queenOfTheCourt } = calculateStarPlayers();\r\n        let matchModeText = '';\r\n        if (state.matchSettings.matchMode === '1set') {\r\n            matchModeText = '1 Set Game Mode';\r\n        } else if (state.matchSettings.matchMode === '3set') {\r\n            matchModeText = '3 Set Game Mode';\r\n        } else {\r\n            matchModeText = `Fast Play ${state.matchSettings.fastPlayGames} Game Mode`;\r\n        }\r\n\r\n        const availableCourts = state.courts.filter(c => c.status === 'available' && state.courtSettings.visibleCourts.includes(c.id));\r\n        const doublesAvailable = availableCourts.filter(c => c.courtMode === 'doubles').length;\r\n        const singlesAvailable = availableCourts.filter(c => c.courtMode === 'singles').length;\r\n        const rookieAvailable = availableCourts.filter(c => c.courtMode === 'rookie').length;\r\n\r\n        const isExpanded = state.mobileControls.isSummaryExpanded;\r\n        const bodyClass = isExpanded ? '' : 'is-collapsed';\r\n        const iconClass = isExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down';\r\n\r\n        return `\r\n            <div class=\"summary-card ${bodyClass}\" data-card-type=\"summary\">\r\n                <div class=\"card-header\">\r\n                    <h3>Information</h3>\r\n                    <div class=\"header-controls\">\r\n                        <button class=\"settings-btn summary-toggle-btn\" data-card-type=\"summary\" title=\"Toggle Details\">\r\n                            <i class=\"mdi ${iconClass}\"></i>\r\n                        </button>\r\n                        <button class=\"settings-btn\" id=\"notify-now-btn\" title=\"Force Notification Now\">📢</button>\r\n                        <button class=\"settings-btn\" id=\"settings-btn\" title=\"Admin Settings\">⚙️</button>\r\n                    </div>\r\n                </div>\r\n                <div class=\"card-body summary-body\">\r\n                    <div class=\"on-duty-section\">\r\n                        <div class=\"duty-info-container\">\r\n                            <button id=\"call-duty-btn\" class=\"duty-image-placeholder\" title=\"Call On-Duty Member\">\r\n                                <i class=\"mdi mdi-phone duty-icon\"></i>\r\n                                <span class=\"duty-text\">PRESS</span>\r\n                            </button>\r\n                            <div class=\"duty-info\">\r\n                                <p class=\"duty-name\">${onDutyName}</p>\r\n                                <p class=\"duty-label\">${dutyLabel}</p>\r\n                            </div>\r\n                        </div>\r\n                        <span id=\"alert-status-display\"></span>\r\n                    </div>\r\n\r\n                    <div class=\"summary-match-mode\">\r\n                        <p>\r\n                            <span class=\"match-mode-label\">Match Mode:</span>\r\n                            <span class=\"match-mode-value\">${matchModeText}</span>\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div class=\"summary-stats\">\r\n                        <div class=\"summary-stats-grid\">\r\n                            <div class=\"stats-column\">\r\n                                <div><span>Players:</span> <strong>${total}</strong></div>\r\n                                <div><span>Queueing:</span> <strong class=\"available-value\">${available}</strong></div>\r\n                                <div><span>On Court:</span> <strong class=\"on-court-value\">${onCourt}</strong></div>\r\n                            </div>\r\n                            <div class=\"stats-column\">\r\n                                <div><span>Courts:</span> <strong>${availableCourtsCount} / ${totalVisibleCourts}</strong></div>\r\n                                <div><span>Availability:</span> <strong>D:${doublesAvailable} S:${singlesAvailable} R:${rookieAvailable}</strong></div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"summary-extra-stats\">\r\n                        <div>\r\n                            <span class=\"stat-label\">King of the Court!</span>\r\n                            <strong class=\"stat-value\">👑 ${kingOfTheCourt || 'N/A'}</strong>\r\n                        </div>\r\n                        <div>\r\n                            <span class=\"stat-label\">Queen of the Court!</span>\r\n                            <strong class=\"stat-value\">👑 ${queenOfTheCourt || 'N/A'}</strong>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"quote-section\">\r\n                        <p id=\"quote-text\" class=\"quote-text\"></p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    function updateGameModeBasedOnPlayerCount() {\r\n        const availableCount = getActivePlayerCount();\r\n        let newMode = state.selection.gameMode;\r\n        let modeChanged = false;\r\n        \r\n        if (availableCount < 4) {\r\n            newMode = 'singles';\r\n        } else if (availableCount >= 4) {\r\n            newMode = 'doubles';\r\n        }\r\n\r\n        if (newMode !== state.selection.gameMode) {\r\n            state.selection.gameMode = newMode;\r\n            modeChanged = true;\r\n        }\r\n\r\n        const requiredPlayers = newMode === 'doubles' ? 4 : 2;\r\n        if (modeChanged || state.selection.players.length > requiredPlayers) {\r\n            state.selection.players = [];\r\n            state.selection.courtId = null;\r\n        }\r\n    }\r\n\r\n    // --- NEW FUNCTION: Dynamically sets game mode based on player selection ---\r\n    function updateGameModeBasedOnSelection() {\r\n        const { players: selectedPlayers } = state.selection;\r\n        const isSinglesCourtAvailable = state.courts.some(c => c.status === 'available' && c.courtMode === 'singles' && state.courtSettings.visibleCourts.includes(c.id));\r\n\r\n        // If 2 players are selected AND a singles court is free, switch to singles mode\r\n        if (selectedPlayers.length === 2 && isSinglesCourtAvailable) {\r\n            if (state.selection.gameMode !== 'singles') {\r\n                state.selection.gameMode = 'singles';\r\n            }\r\n        } else {\r\n            // In all other cases (more players selected, or no singles court), default to doubles\r\n            if (state.selection.gameMode !== 'doubles') {\r\n                state.selection.gameMode = 'doubles';\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- NEW HELPER FUNCTION ---\r\n    function getLastCheckInForChild(childFullName) {\r\n        let latestCheckIn = 0;\r\n        \r\n        // Iterate through all history entries\r\n        state.juniorClub.history.forEach(historyEntry => {\r\n            // Check if the child attended this session (childFullName is in the childNames array)\r\n            if (historyEntry.childNames && historyEntry.childNames.includes(childFullName)) {\r\n                // The historyEntry.id is the timestamp of the session check-in\r\n                if (historyEntry.id > latestCheckIn) {\r\n                    latestCheckIn = historyEntry.id;\r\n                }\r\n            }\r\n        });\r\n        \r\n        return latestCheckIn; // Returns 0 if no history found\r\n    }   \r\n\r\n    // --- NEW HELPER FUNCTION ---\r\n    function getLastCheckInForChild(childFullName) {\r\n        let latestCheckIn = 0;\r\n        \r\n        // Iterate through all history entries\r\n        state.juniorClub.history.forEach(historyEntry => {\r\n            // FIX 1: Trim the lookup key (childFullName) before checking inclusion.\r\n            if (historyEntry.childNames && historyEntry.childNames.includes(childFullName.trim())) {\r\n                // The historyEntry.id is the timestamp of the session check-in\r\n                if (historyEntry.id > latestCheckIn) {\r\n                    latestCheckIn = historyEntry.id;\r\n                }\r\n            }\r\n        });\r\n        \r\n        return latestCheckIn; // Returns 0 if no history found\r\n    }\r\n\r\n    // --- ADDED HELPER FUNCTION ---\r\n\r\n\r\n\r\n    function createPlayerListItem(player, index, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase = false, sliceEnd = 8, specialHighlightIndex = -1, isSelector = false, inGroup = false) {\r\n        const li = document.createElement(\"li\");\r\n        const playerName = player.name;\r\n\r\n        let statusText;\r\n        // *** MODIFIED STATUS TEXT LOGIC ***\r\n        if (player.guest) {\r\n            // If it's a guest AND they have a specific type (Junior, Adult, etc.)\r\n            if (player.type) {\r\n                statusText = `${player.type} Guest`; // e.g., \"Adult Guest\"\r\n            } else {\r\n                statusText = 'Guest'; // Fallback if type is missing\r\n            }\r\n        } else if (player.committee) {\r\n            statusText = `Committee ${player.committee}`; //\r\n        } else {\r\n            // For members, use their type from the master list if available, otherwise default\r\n            statusText = player.type ? `${player.type} Member` : 'Member'; //\r\n        }\r\n        // *** END MODIFIED LOGIC ***\r\n\r\n\r\n        let priorityText = '';\r\n        let priorityClass = 'player-status'; // Use player-status by default\r\n\r\n        if (playerName === state.onDuty) {\r\n            priorityText = 'Low Priority'; //\r\n            priorityClass = 'player-priority'; //\r\n        }\r\n\r\n        let iconHtml = '';\r\n        const isKing = playerName === starPlayers.kingOfTheCourt;\r\n        const isQueen = playerName === starPlayers.queenOfTheCourt;\r\n        const isHeartbreaker = playerName === heartbreakerName;\r\n        const streak = winningStreaks[playerName] || 0;\r\n\r\n        const statusFaderItems = [statusText]; // Start fader items with the primary status\r\n        let statusHTML;\r\n\r\n        if (isKing || isQueen) {\r\n            iconHtml += '<span style=\"color: gold; margin-left: 5px;\">👑</span>'; //\r\n            statusFaderItems.push(isKing ? \"King of the Court\" : \"Queen of the Court\"); //\r\n        }\r\n        if (streak >= 3) {\r\n            iconHtml += `<span title=\"${streak} wins in a row!\" style=\"margin-left: 5px;\">🎲</span>`; //\r\n            statusFaderItems.push(\"On a roll!\"); //\r\n        }\r\n        if (isHeartbreaker) {\r\n            iconHtml += `<span title=\"Heartbreaker!\" style=\"margin-left: 5px;\">💔</span>`; //\r\n            statusFaderItems.push(\"So Close!\"); //\r\n        }\r\n\r\n        // Generate status HTML, handling the fader if needed\r\n        if (statusFaderItems.length > 1) {\r\n            statusHTML = `<div class=\"player-status-fader\">`; //\r\n            // Add the primary status text first (which now includes the type for guests)\r\n            statusHTML += `<span class=\"status-text is-visible ${priorityClass}\">${priorityText || statusText}</span>`; //\r\n            // Add other fading statuses (King/Queen, On a Roll, etc.)\r\n            statusFaderItems.slice(1).forEach((text) => { // Start from index 1\r\n                statusHTML += `<span class=\"status-text\">${text}</span>`; //\r\n            });\r\n            statusHTML += `</div>`;\r\n        } else {\r\n             // If only one status, display it directly\r\n            statusHTML = `<span class=\"${priorityClass}\">${priorityText || statusText}</span>`; //\r\n        }\r\n\r\n\r\n        const isPaused = player.isPaused;\r\n        const pauseIcon = isPaused ? 'mdi-play' : 'mdi-pause'; //\r\n        const pauseAction = isPaused ? 'resume' : 'pause'; //\r\n\r\n        let playtimeHTML;\r\n        if (isPaused && player.pauseTime) {\r\n            const TEN_MINUTES_MS = 10 * 60 * 1000;\r\n            const elapsed = Date.now() - player.pauseTime;\r\n            const remaining = Math.max(0, TEN_MINUTES_MS - elapsed);\r\n            const minutes = Math.floor(remaining / 60000);\r\n            const seconds = Math.floor((remaining % 60000) / 1000);\r\n            const timeString = `${String(minutes).padStart(2, \"0\")}m${String(seconds).padStart(2, \"0\")}s`;\r\n            playtimeHTML = `<span class=\"player-playtime player-pause-cooldown\" data-pause-time=\"${player.pauseTime}\">${timeString}</span>`; //\r\n        } else {\r\n            const playtime = playerStats[playerName] ? formatDuration(playerStats[playerName].totalDurationMs) : '00h00m';\r\n            playtimeHTML = `<span class=\"player-playtime\">${playtime}</span>`; //\r\n        }\r\n\r\n        let suggestionButtonHTML = '<div class=\"suggestion-icon-wrapper\"></div>'; // Placeholder for alignment\r\n        if (isSelector && getActivePlayerCount() >= 5) {\r\n            suggestionButtonHTML = `<div class=\"suggestion-icon-wrapper\"><button class=\"suggestion-btn\" title=\"Suggest a balanced game\">💡</button></div>`; //\r\n        }\r\n\r\n        li.innerHTML = `\r\n            <div class=\"player-details\">\r\n                <div class=\"player-name-container\">\r\n                    <span class=\"player-name\">${playerName}</span>\r\n                    ${iconHtml}\r\n                </div>\r\n                ${statusHTML}\r\n            </div>\r\n            <div class=\"player-stats\">\r\n                ${suggestionButtonHTML}\r\n                <button class=\"pause-toggle-btn\" data-player-name=\"${playerName}\" data-action=\"${pauseAction}\" title=\"${isPaused ? 'Resume Game Play' : 'Pause Game Play'}\">\r\n                    <i class=\"mdi ${pauseIcon}\"></i>\r\n                </button>\r\n                <div class=\"gender-container gender-${player.gender}\">\r\n                    <span class=\"player-gender\">${player.gender}</span>\r\n                </div>\r\n                ${playtimeHTML}\r\n            </div>\r\n        `; //\r\n        li.dataset.playerName = playerName; //\r\n\r\n        // Apply suggestion classes if a suggestion is active\r\n        if (state.activeSuggestion) {\r\n            const { team1, team2 } = state.activeSuggestion;\r\n            if (team1.some(p => p.name === playerName)) {\r\n                li.classList.add('suggested-partner'); //\r\n            } else if (team2.some(p => p.name === playerName)) {\r\n                li.classList.add('suggested-opponent'); //\r\n            }\r\n        }\r\n\r\n        if (player.isPaused) li.classList.add(\"paused-player\"); //\r\n        if (selectedPlayerNames.includes(playerName)) li.classList.add(\"selected\"); //\r\n        else {\r\n            const isSelectionFull = selectedPlayerNames.length >= 4; // Check if 4 players already selected\r\n            let isDisabled = false;\r\n            if (isSpecialCase) { if (index >= sliceEnd) isDisabled = true; } //\r\n            else { if (index >= sliceEnd) isDisabled = true; } //\r\n            if (player.isPaused) isDisabled = true; //\r\n            if (index === specialHighlightIndex) isDisabled = false; //\r\n            // Disable if selection is full OR if player is beyond the selectable range/paused\r\n            if (isSelectionFull || isDisabled) li.classList.add(\"disabled\"); //\r\n        }\r\n\r\n        if (isSelector) li.classList.add(\"first-player\"); //\r\n        // This handles the case where the paused player at index 0 makes the next available player the 'first-player' visually\r\n        if (!isSelector && index === state.availablePlayers.findIndex(p => !p.isPaused)) li.classList.add(\"first-player\"); //\r\n\r\n        return li;\r\n    }\r\n\r\n    function handleOnDutyChange(e) {\r\n        state.onDuty = e.target.value;\r\n        saveState();\r\n        enforceQueueLogic(); // --- THIS IS THE FIX ---\r\n        render();\r\n    }\r\n\r\n    // NEW FUNCTION: Check if on-duty member is being selected for a game\r\n    function checkOnDutyMemberInSelection(selectedPlayerNames) {\r\n        if (state.onDuty === 'None') return false;\r\n        return selectedPlayerNames.includes(state.onDuty);\r\n    }\r\n\r\n    // NEW FUNCTION: Show temporary duty handover modal\r\n    function showTempDutyHandoverModal(callback) {\r\n        tempDutyHandoverList.innerHTML = '';\r\n        tempDutyCurrentMember.textContent = state.onDuty;\r\n        \r\n        // Get all committee members who are currently checked in\r\n        const checkedInCommitteeMembers = [\r\n            ...state.availablePlayers.filter(p => p.committee),\r\n            ...state.courts.flatMap(c => c.players).filter(p => p.committee)\r\n        ];\r\n\r\n        const selectedPlayerNames = new Set(state.selection.players);\r\n        \r\n        // Remove the current on-duty member and filter for those NOT on court\r\n        const availableCommitteeMembers = state.availablePlayers\r\n            .filter(p => p.committee && p.name !== state.onDuty && !selectedPlayerNames.has(p.name))\r\n            .sort((a, b) => a.name.localeCompare(b.name));\r\n        \r\n        // Add \"None\" option first\r\n        const noneOption = document.createElement('li');\r\n        noneOption.className = 'committee-member';\r\n        noneOption.innerHTML = `\r\n            <label>\r\n                <input type=\"radio\" name=\"tempDutyMember\" value=\"None\">\r\n                <div class=\"member-details\">\r\n                    <span class=\"member-name\">None</span>\r\n                    <span class=\"member-designation\">No temporary replacement</span>\r\n                </div>\r\n            </label>\r\n        `;\r\n        tempDutyHandoverList.appendChild(noneOption);\r\n        \r\n        // Add available committee members\r\n        if (availableCommitteeMembers.length === 0) {\r\n            const noMembersLi = document.createElement('li');\r\n            noMembersLi.style.justifyContent = 'center';\r\n            noMembersLi.style.color = 'var(--neutral-color)';\r\n            noMembersLi.textContent = 'No other committee members available';\r\n            tempDutyHandoverList.appendChild(noMembersLi);\r\n        } else {\r\n            availableCommitteeMembers.forEach(member => {\r\n                const li = document.createElement('li');\r\n                li.className = 'committee-member';\r\n                li.innerHTML = `\r\n                    <label>\r\n                        <input type=\"radio\" name=\"tempDutyMember\" value=\"${member.name}\">\r\n                        <div class=\"member-details\">\r\n                            <span class=\"member-name\">${member.name}</span>\r\n                            <span class=\"member-designation\">${member.committee}</span>\r\n                        </div>\r\n                    </label>\r\n                `;\r\n                tempDutyHandoverList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        // Store the callback to execute on confirm\r\n        tempDutyHandoverModal.dataset.callback = 'pending';\r\n        tempDutyHandoverModal.callback = callback;\r\n        \r\n        tempDutyConfirmBtn.disabled = true;\r\n        \r\n        // Enable confirm button when a selection is made\r\n        tempDutyHandoverList.querySelectorAll('input[name=\"tempDutyMember\"]').forEach(radio => {\r\n            radio.addEventListener('change', () => {\r\n                tempDutyConfirmBtn.disabled = false;\r\n            });\r\n        });\r\n        \r\n        tempDutyHandoverModal.classList.remove('hidden');\r\n    }\r\n\r\n    // NEW FUNCTION: Handle temporary duty handover confirmation\r\n    function handleTempDutyHandoverConfirm() {\r\n        const selectedMember = tempDutyHandoverList.querySelector('input[name=\"tempDutyMember\"]:checked');\r\n\r\n        if (!selectedMember) return;\r\n\r\n        const newTempDuty = selectedMember.value;\r\n        const originalDuty = state.onDuty;\r\n\r\n        // Store the original on-duty member\r\n        if (!state.tempDutyHandover) {\r\n            state.tempDutyHandover = {\r\n                originalMember: originalDuty,\r\n                tempMember: newTempDuty,\r\n                timestamp: Date.now()\r\n            };\r\n        }\r\n\r\n        // Update the on-duty member\r\n        state.onDuty = newTempDuty;\r\n\r\n        // Announce the change - using pronounceable names\r\n        const originalDutyPronounceable = getPronounceableName(originalDuty);\r\n        if (newTempDuty === 'None') {\r\n            playAlertSound(`There will be nobody on duty while ${originalDutyPronounceable} is in a match.`);\r\n        } else {\r\n            const newTempDutyPronounceable = getPronounceableName(newTempDuty);\r\n            playAlertSound(`${newTempDutyPronounceable} is temporarily on duty while ${originalDutyPronounceable} is in a match.`);\r\n        }\r\n\r\n        tempDutyHandoverModal.classList.add('hidden');\r\n\r\n        // Execute the stored callback (continue with game setup)\r\n        if (tempDutyHandoverModal.callback) {\r\n            tempDutyHandoverModal.callback();\r\n            tempDutyHandoverModal.callback = null;\r\n        }\r\n\r\n        saveState();\r\n        render();\r\n    }\r\n\r\n    // NEW FUNCTION: Restore original duty member after game ends\r\n    function restoreOriginalDutyMember() {\r\n        if (state.tempDutyHandover && state.tempDutyHandover.originalMember) {\r\n            state.onDuty = state.tempDutyHandover.originalMember;\r\n            state.tempDutyHandover = null;\r\n            saveState();\r\n            render();\r\n        }\r\n    }\r\n\r\n// --- CUSTOM ANNOUNCEMENT FUNCTIONS ---\r\n\r\n    function handleTtsIntervalChange(direction) {\r\n        // --- THIS IS THE FIX ---\r\n        // Ensure currentInterval is a number, defaulting to 30 if it's not.\r\n        const currentInterval = Number(state.customAnnouncementState.ttsIntervalMins) || 30;\r\n        // --- END OF FIX ---\r\n\r\n        let newInterval = currentInterval;\r\n        if (direction === 'increase') {\r\n            newInterval += 15;\r\n        } else if (direction === 'decrease') {\r\n            newInterval -= 15;\r\n        }\r\n        // Set a minimum of 15 minutes\r\n        state.customAnnouncementState.ttsIntervalMins = Math.max(15, newInterval);\r\n        document.getElementById('tts-interval-display').textContent = `${state.customAnnouncementState.ttsIntervalMins} min`;\r\n    }\r\n\r\n    function showAnnouncementsModal() {\r\n        announcementList.innerHTML = ''; // Clear existing list\r\n\r\n        // --- THIS IS THE FIX ---\r\n        // Ensure the interval defaults to 30 if it's not already a number.\r\n        const interval = Number(state.customAnnouncementState.ttsIntervalMins) || 30;\r\n        document.getElementById('tts-interval-display').textContent = `${interval} min`;\r\n        // --- END OF FIX ---\r\n\r\n        const renderItem = (announcement = { text: '', tts: false }, index, isLast = false) => {\r\n            const li = document.createElement('li');\r\n            const uniqueId = `tts-${Date.now()}-${Math.random()}`;\r\n            li.innerHTML = `\r\n                <input type=\"text\" value=\"${announcement.text}\" placeholder=\"Enter announcement text...\">\r\n                <label for=\"${uniqueId}\" class=\"tts-checkbox-label\">\r\n                    <input type=\"checkbox\" id=\"${uniqueId}\" ${announcement.tts ? 'checked' : ''}> TTS\r\n                </label>\r\n                ${isLast ? '<span class=\"add-announcement-btn\" title=\"Add another message\">+</span>' : ''}\r\n                <span class=\"action-icon remove\" data-index=\"${index}\" title=\"Remove message\">&times;</span>\r\n            `;\r\n            announcementList.appendChild(li);\r\n        };\r\n\r\n        if (state.announcements.length === 0) {\r\n            renderItem(undefined, 0, true);\r\n        } else {\r\n            state.announcements.forEach((ann, index) => {\r\n                renderItem(ann, index, index === state.announcements.length - 1);\r\n            });\r\n        }\r\n        \r\n        adminSettingsModal.classList.add('hidden');\r\n        customAnnouncementModal.classList.remove('hidden');\r\n    }\r\n\r\n    function handleAnnouncementsSave() {\r\n        const newAnnouncements = [];\r\n        announcementList.querySelectorAll('li').forEach(li => {\r\n            const textInput = li.querySelector('input[type=\"text\"]');\r\n            const ttsCheckbox = li.querySelector('input[type=\"checkbox\"]');\r\n            if (textInput && textInput.value.trim() !== '') {\r\n                newAnnouncements.push({\r\n                    text: textInput.value.trim(),\r\n                    tts: ttsCheckbox.checked\r\n                });\r\n            }\r\n        });\r\n\r\n        state.announcements = newAnnouncements;\r\n        saveState();\r\n        customAnnouncementModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n        \r\n        // --- THIS IS THE FIX ---\r\n        // Restart the animation and scheduler to apply all changes immediately.\r\n        startHeaderTextAnimation();\r\n        startCustomTtsScheduler();\r\n        // --- END OF FIX ---\r\n    }\r\n\r\n    function startHeaderTextAnimation() {\r\n        // 1. Stop any pending animation cycle\r\n        if (window.headerAnimationInterval) {\r\n            clearTimeout(window.headerAnimationInterval);\r\n        }\r\n\r\n        // 2. Immediately reset the UI to a clean, default state\r\n        const announcementContainer = document.getElementById('announcement-container');\r\n        if (announcementContainer) {\r\n            announcementContainer.innerHTML = ''; // Remove any active scrolling elements\r\n        }\r\n        const clock = document.getElementById('header-clock');\r\n        if (clock) {\r\n            clock.style.opacity = 1; // Force the clock to be visible immediately\r\n        }\r\n\r\n        // 3. Exit if there's nothing to animate\r\n        if (!clock || !announcementContainer || state.announcements.length === 0) {\r\n            return;\r\n        }\r\n\r\n        let currentIndex = 0;\r\n\r\n        const cycleAnimation = () => {\r\n            const announcement = state.announcements[currentIndex];\r\n            if (!announcement) {\r\n                clock.style.opacity = 1;\r\n                window.headerAnimationInterval = setTimeout(cycleAnimation, 10000); // 10-second pause between cycles\r\n                return;\r\n            }\r\n\r\n            clock.style.opacity = 0; // Fade out clock\r\n\r\n            setTimeout(() => {\r\n                const announcementEl = document.createElement('h1');\r\n                announcementEl.className = 'scrolling-announcement';\r\n                // --- START MODIFICATION ---\r\n                // Use innerHTML to add images\r\n                announcementEl.innerHTML = `\r\n                    <span class=\"scrolling-ball\"><span>🥎</span></span>\r\n                    <span class=\"scrolling-flame\">🔥</span>\r\n                    ${announcement.text}\r\n\r\n                `;\r\n                // --- END MODIFICATION ---\r\n                announcementContainer.appendChild(announcementEl);\r\n\r\n                const containerWidth = announcementContainer.offsetWidth;\r\n                // --- START MODIFICATION ---\r\n                // Need a slight delay for image loading and accurate width calculation\r\n                requestAnimationFrame(() => {\r\n                    requestAnimationFrame(() => { // Double RAF for safety\r\n                        const textWidth = announcementEl.offsetWidth;\r\n                        const scrollDistance = containerWidth + textWidth;\r\n                        const scrollSpeed = 100; // pixels per second\r\n                        const duration = scrollDistance / scrollSpeed;\r\n\r\n                        // Set animation duration for the ball spin\r\n                        announcementEl.querySelectorAll('.scrolling-ball > span').forEach(innerSpan => {\r\n                            innerSpan.style.animationDuration = '1s';\r\n                        });\r\n\r\n\r\n\r\n                        announcementEl.style.transform = `translateX(${containerWidth}px)`;\r\n                        announcementEl.classList.add('is-visible');\r\n                        announcementEl.getBoundingClientRect(); // Force browser repaint\r\n\r\n                        announcementEl.style.transition = `transform ${duration}s linear`;\r\n                        announcementEl.style.transform = `translateX(-${textWidth}px)`;\r\n\r\n                        announcementEl.addEventListener('transitionend', () => {\r\n                            announcementEl.remove();\r\n                            clock.style.opacity = 1; // Fade in clock\r\n                            currentIndex = (currentIndex + 1) % state.announcements.length;\r\n\r\n                            // Schedule the NEXT cycle after the 10-second pause\r\n                            window.headerAnimationInterval = setTimeout(cycleAnimation, 10000);\r\n                        }, { once: true });\r\n                    });\r\n                });\r\n\r\n\r\n            }, 500); // Wait for clock fade-out\r\n        };\r\n\r\n        // Start the first cycle after a brief delay\r\n        window.headerAnimationInterval = setTimeout(cycleAnimation, 1000);\r\n    }\r\n\r\n    function startCustomTtsScheduler() {\r\n        // THIS IS THE FIX: Use the value from the state\r\n        const ANNOUNCEMENT_CYCLE_MS = state.customAnnouncementState.ttsIntervalMins * 60 * 1000;\r\n        const ANNOUNCEMENT_INTERVAL_MS = 5 * 60 * 1000;\r\n\r\n        if (state.customAnnouncementState.scheduler) {\r\n            clearInterval(state.customAnnouncementState.scheduler);\r\n        }\r\n\r\n        const ttsAnnouncements = state.announcements.filter(a => a.tts);\r\n        if (ttsAnnouncements.length === 0) return;\r\n\r\n        const scheduleNextAnnouncement = () => {\r\n            const mainAlertRemaining = alertScheduleTime > 0 ? alertScheduleTime - Date.now() : ANNOUNCEMENT_CYCLE_MS;\r\n            const midwayPoint = mainAlertRemaining / 2;\r\n            state.customAnnouncementState.nextAnnouncementTime = Date.now() + midwayPoint;\r\n        };\r\n\r\n        const runScheduler = () => {\r\n            const now = Date.now();\r\n            const isGamePending = state.courts.some(c => c.status === 'game_pending');\r\n\r\n            if (isGamePending || state.customAnnouncementState.isPaused) {\r\n                return;\r\n            }\r\n\r\n            if (now >= state.customAnnouncementState.nextAnnouncementTime) {\r\n                const announcement = ttsAnnouncements[state.customAnnouncementState.currentIndex];\r\n                if (announcement) {\r\n                    playCustomTTS(announcement.text);\r\n                }\r\n\r\n                state.customAnnouncementState.currentIndex = (state.customAnnouncementState.currentIndex + 1) % ttsAnnouncements.length;\r\n\r\n                const nextDelay = state.customAnnouncementState.currentIndex === 0 ? ANNOUNCEMENT_CYCLE_MS : ANNOUNCEMENT_INTERVAL_MS;\r\n                state.customAnnouncementState.nextAnnouncementTime = now + nextDelay;\r\n            }\r\n        };\r\n\r\n        scheduleNextAnnouncement();\r\n        state.customAnnouncementState.scheduler = setInterval(runScheduler, 5000);\r\n    }\r\n\r\n\r\n    // --- EVENT LISTENERS FOR ANNOUNCEMENTS ---\r\n    customAnnouncementBtn.addEventListener('click', showAnnouncementsModal);\r\n    announcementSaveBtn.addEventListener('click', handleAnnouncementsSave);\r\n    announcementCancelBtn.addEventListener('click', () => {\r\n        customAnnouncementModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    });\r\n    announcementList.addEventListener('click', (e) => {\r\n        // Check if the add button was clicked\r\n        if (e.target.classList.contains('add-announcement-btn')) {\r\n            // --- ADD LOGIC ---\r\n            const parentLi = e.target.closest('li');\r\n            if (parentLi) {\r\n                e.target.remove(); // Remove the '+' from the current last item\r\n            }\r\n\r\n            // Create a new, empty list item with the plus button\r\n            const newLi = document.createElement('li');\r\n            const newUniqueId = `tts-${Date.now()}-${Math.random()}`;\r\n            newLi.innerHTML = `\r\n                <input type=\"text\" value=\"\" placeholder=\"Enter announcement text...\">\r\n                <label for=\"${newUniqueId}\" class=\"tts-checkbox-label\">\r\n                    <input type=\"checkbox\" id=\"${newUniqueId}\"> TTS\r\n                </label>\r\n                <span class=\"add-announcement-btn\" title=\"Add another message\">+</span>\r\n                <span class=\"action-icon remove\" title=\"Remove message\">&times;</span>\r\n            `;\r\n            announcementList.appendChild(newLi); // Append the new item\r\n        } \r\n        // Check if the remove button was clicked\r\n        else if (e.target.classList.contains('remove')) {\r\n            // --- REMOVE LOGIC ---\r\n            const liToRemove = e.target.closest('li');\r\n            if (liToRemove) {\r\n                liToRemove.remove();\r\n            }\r\n            // If it was the last item, we need to ensure the new last item gets a plus button.\r\n            // The easiest way is to re-render the list from the current state of the inputs.\r\n            const currentAnnouncements = [];\r\n            announcementList.querySelectorAll('li').forEach(li => {\r\n                const textInput = li.querySelector('input[type=\"text\"]');\r\n                const ttsCheckbox = li.querySelector('input[type=\"checkbox\"]');\r\n                currentAnnouncements.push({\r\n                    text: textInput.value,\r\n                    tts: ttsCheckbox.checked\r\n                });\r\n            });\r\n            state.announcements = currentAnnouncements;\r\n            showAnnouncementsModal();\r\n        }\r\n    });\r\n\r\n    function render() {\r\n        autoAssignCourtModes()\r\n        const gameModeContainer = document.getElementById('game-mode-container');\r\n        const availablePlayersSectionEl = document.getElementById('availablePlayersSection');\r\n        if (gameModeContainer && availablePlayersSectionEl) {\r\n            const showSelector = state.courtSettings.showGameModeSelector;\r\n            gameModeContainer.style.display = showSelector ? 'block' : 'none';\r\n            availablePlayersSectionEl.classList.toggle('mode-selector-hidden', !showSelector);\r\n        }\r\n        const {\r\n            gameMode,\r\n            players: selectedPlayerNames,\r\n            courtId: selectedCourtId\r\n        } = state.selection;\r\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\r\n        const playerStats = calculatePlayerPlaytime();\r\n        const starPlayers = calculateStarPlayers();\r\n        const winningStreaks = calculateWinningStreaks();\r\n        const heartbreakerName = calculateHeartbreaker(); // <-- ADD THIS LINE\r\n\r\n        autoAssignMatchMode();\r\n        runAutoMinimizeLogic(); \r\n        availablePlayersList.innerHTML = \"\";\r\n\r\n        let sliceStart = 0;\r\n        let selectorPlayer = state.availablePlayers[0];\r\n\r\n        if (selectorPlayer && selectorPlayer.isPaused) {\r\n            const firstUnpausedIndex = state.availablePlayers.findIndex(p => !p.isPaused);\r\n            if (firstUnpausedIndex !== -1) {\r\n                sliceStart = firstUnpausedIndex;\r\n                selectorPlayer = state.availablePlayers[firstUnpausedIndex];\r\n            } else {\r\n                selectorPlayer = null;\r\n            }\r\n        }\r\n\r\n        const renderQueue = state.availablePlayers;\r\n\r\n        if (renderQueue.length === 0 && selectedPlayerNames.length === 0) {\r\n            const li = document.createElement(\"li\");\r\n            li.className = \"waiting-message\";\r\n            li.textContent = totalPlayersAtClub() > 0 ? \"All players are on court.\" : \"Waiting For Players To Check In...\";\r\n            availablePlayersList.appendChild(li);\r\n        } else {\r\n            let isSpecialCase = false;\r\n            let specialHighlightIndex = -1;\r\n            let nextPlayerSliceEnd = renderQueue.length;\r\n            const selectableGroupBaseSize = 7;\r\n\r\n            if (selectorPlayer && (renderQueue.length - sliceStart - 1) >= selectableGroupBaseSize) {\r\n                const selectorGender = selectorPlayer.gender;\r\n                \r\n                const playersAfterSelector = renderQueue.slice(sliceStart + 1);\r\n                const availableInSelectableRange = playersAfterSelector.filter(p => !p.isPaused).slice(0, selectableGroupBaseSize);\r\n                \r\n                if (availableInSelectableRange.length > 0) {\r\n                    const sameGenderCountInRange = availableInSelectableRange.filter(p => p.gender === selectorGender).length;\r\n                    const lastPlayerInRange = availableInSelectableRange[availableInSelectableRange.length - 1];\r\n                    const endOfRangeIndex = renderQueue.findIndex(p => p.name === lastPlayerInRange.name);\r\n\r\n                    if (sameGenderCountInRange === 0) {\r\n                        isSpecialCase = true;\r\n                        nextPlayerSliceEnd = endOfRangeIndex;\r\n                        \r\n                        const searchPool = renderQueue.slice(endOfRangeIndex);\r\n                        const foundPlayerIndexInPool = searchPool.findIndex(p => p.gender === selectorGender && !p.isPaused);\r\n                        \r\n                        if (foundPlayerIndexInPool !== -1) {\r\n                            specialHighlightIndex = endOfRangeIndex + foundPlayerIndexInPool;\r\n                        } else {\r\n                            isSpecialCase = false;\r\n                            nextPlayerSliceEnd = endOfRangeIndex + 1;\r\n                        }\r\n                    } else {\r\n                        isSpecialCase = false;\r\n                        specialHighlightIndex = -1;\r\n                        nextPlayerSliceEnd = endOfRangeIndex + 1;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (renderQueue.length > 0) {\r\n                const playersBeforeSelector = renderQueue.slice(0, sliceStart);\r\n                playersBeforeSelector.forEach((player, index) => {\r\n                    // MODIFIED THIS LINE\r\n                    const li = createPlayerListItem(player, index, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, false);\r\n                    availablePlayersList.appendChild(li);\r\n                });\r\n\r\n                if (selectorPlayer) {\r\n                    const selectorIndex = sliceStart;\r\n                    // MODIFIED THIS LINE\r\n                    const liSelector = createPlayerListItem(selectorPlayer, selectorIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, true, false);\r\n                    availablePlayersList.appendChild(liSelector);\r\n                }\r\n\r\n                const orangeGroupPlayers = renderQueue.slice(sliceStart + 1, nextPlayerSliceEnd);\r\n                if (orangeGroupPlayers.length > 0) {\r\n                    const groupDiv = document.createElement('div');\r\n                    groupDiv.className = 'next-players-group';\r\n                    orangeGroupPlayers.forEach((player, index) => {\r\n                        const playerIndex = sliceStart + 1 + index;\r\n                        // MODIFIED THIS LINE\r\n                        const playerLi = createPlayerListItem(player, playerIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, true);\r\n                        groupDiv.appendChild(playerLi);\r\n                    });\r\n                    availablePlayersList.appendChild(groupDiv);\r\n                }\r\n\r\n                const playersAfterOrangeGroup = renderQueue.slice(nextPlayerSliceEnd);\r\n                playersAfterOrangeGroup.forEach((player, index) => {\r\n                    const playerIndex = nextPlayerSliceEnd + index;\r\n                    // MODIFIED THIS LINE\r\n                    const playerLi = createPlayerListItem(player, playerIndex, selectedPlayerNames, requiredPlayers, playerStats, starPlayers, winningStreaks, heartbreakerName, isSpecialCase, nextPlayerSliceEnd, specialHighlightIndex, false, false);\r\n\r\n                    if (playerIndex === specialHighlightIndex) {\r\n                        const groupDiv = document.createElement('div');\r\n                        groupDiv.className = 'next-players-group';\r\n                        groupDiv.appendChild(playerLi);\r\n                        availablePlayersList.appendChild(groupDiv);\r\n                    } else {\r\n                        availablePlayersList.appendChild(playerLi);\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        if (renderQueue.length > 0 && renderQueue.length < 4) {\r\n            const li = document.createElement(\"li\");\r\n            li.textContent = \"Waiting For More Players...\";\r\n            li.className = \"waiting-message\";\r\n            availablePlayersList.appendChild(li);\r\n        }\r\n\r\n        const playersToggleIcon = document.querySelector('#players-toggle-btn i');\r\n        if (playersToggleIcon) {\r\n            const isExpanded = state.mobileControls.isPlayersExpanded;\r\n            playersToggleIcon.className = `mdi ${isExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down'}`;\r\n        }\r\n        availablePlayersSection.classList.toggle('is-collapsed', !state.mobileControls.isPlayersExpanded);\r\n\r\n        courtGrid.innerHTML = \"\";\r\n        courtGrid.insertAdjacentHTML('afterbegin', createSummaryCard());\r\n        alertStatusDisplay = document.getElementById('alert-status-display');\r\n\r\n        state.courts.filter(court => state.courtSettings.visibleCourts.includes(court.id)).forEach(court => {\r\n            const card = createCourtCard(court);\r\n            courtGrid.appendChild(card);\r\n        });\r\n\r\n        // ← ADD THIS LINE:\r\n        setupCourtLightLongPress();\r\n\r\n        // ================================\r\n        // STEP 16: ATTACH DRAG & DROP EVENT LISTENERS\r\n        // ================================\r\n        // Attach drag & drop listeners to player spots on courts\r\n        document.querySelectorAll('.player-spot[draggable=\"true\"]').forEach(spot => {\r\n            spot.addEventListener('dragstart', handlePlayerDragStart);\r\n            spot.addEventListener('dragend', handlePlayerDragEnd);\r\n            spot.addEventListener('dragover', handlePlayerDragOver);\r\n            spot.addEventListener('dragleave', handlePlayerDragLeave);\r\n            spot.addEventListener('drop', handlePlayerDrop);\r\n            spot.addEventListener('dblclick', handlePlayerDoubleClick); // Add double-click handler\r\n        });\r\n\r\n        // Attach drag listeners to available players list for substitution drops\r\n        const availablePlayersListEl = document.getElementById('availablePlayersList');\r\n        if (availablePlayersListEl) {\r\n            // Remove old listeners to prevent duplicates (if any)\r\n            availablePlayersListEl.removeEventListener('dragover', handlePlayerDragOver);\r\n            availablePlayersListEl.removeEventListener('dragleave', handlePlayerDragLeave);\r\n            availablePlayersListEl.removeEventListener('drop', handlePlayerDrop);\r\n            \r\n            // Add new listeners\r\n            availablePlayersListEl.addEventListener('dragover', handlePlayerDragOver);\r\n            availablePlayersListEl.addEventListener('dragleave', handlePlayerDragLeave);\r\n            availablePlayersListEl.addEventListener('drop', handlePlayerDrop);\r\n        }\r\n        // ================================\r\n        // END STEP 16\r\n        // ================================\r\n\r\n        const courtInSetup = state.courts.find(c => c.status === \"selecting_teams\" || c.status === \"game_pending\");\r\n        const firstAvailablePlayer = selectorPlayer ? selectorPlayer.name : null;\r\n        const remainingToSelect = requiredPlayers - selectedPlayerNames.length;\r\n        const allCourtsBusy = state.courts.filter(c => state.courtSettings.visibleCourts.includes(c.id)).every(c => c.status !== \"available\");\r\n\r\n        infoBar.classList.remove(\"blue-theme\", \"green-theme\", \"yellow-theme\", \"red-theme\", \"hidden\");\r\n\r\n        if (courtInSetup) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"yellow-theme\");\r\n            infoBarText.textContent = `Court ${courtInSetup.id}: Choose how to form teams on the court card.`;\r\n        } else if (renderQueue.length === 0 && totalPlayersAtClub() > 0) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"blue-theme\");\r\n            infoBarText.textContent = \"All Players are on Court...\";\r\n        } else if (selectedPlayerNames.length === 0 && totalPlayersAtClub() < 2) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"red-theme\");\r\n            infoBarText.textContent = \"Waiting For Players To Check In...\";\r\n        } else if (selectedPlayerNames.length === 0 && allCourtsBusy) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"red-theme\");\r\n            infoBarText.textContent = \"Please wait for a court to become available.\";\r\n        } else if (selectedPlayerNames.length === 0 && firstAvailablePlayer) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"green-theme\");\r\n            infoBarText.textContent = `${firstAvailablePlayer.split(' ')[0]}, please select players for a game.`;\r\n        } else if (selectedPlayerNames.length > 0 && selectedPlayerNames.length < requiredPlayers) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"green-theme\");\r\n            infoBarText.textContent = `Please select ${remainingToSelect} more player(s).`;\r\n        } else if (selectedPlayerNames.length === requiredPlayers && !selectedCourtId) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"green-theme\");\r\n            infoBarText.textContent = \"Please select an available court.\";\r\n        } else if (selectedPlayerNames.length === requiredPlayers && selectedCourtId) {\r\n            infoBar.classList.remove(\"hidden\");\r\n            infoBar.classList.add(\"yellow-theme\");\r\n            infoBarText.textContent = `Court ${selectedCourtId} selected. Confirm on the court card below.`;\r\n        } else {\r\n            infoBar.classList.add(\"hidden\");\r\n        }\r\n\r\n        modeDoublesBtn.classList.toggle(\"active\", gameMode === \"doubles\");\r\n        modeSinglesBtn.classList.toggle(\"active\", gameMode === \"singles\");\r\n        modeDoublesBtn.disabled = renderQueue.length < 4;\r\n\r\n        availablePlayersSection.classList.toggle(\"locked\", !!courtInSetup || (selectedPlayerNames.length === 0 && allCourtsBusy));\r\n        \r\n        updateTimers(); \r\n        \r\n        initSummaryCardElements();\r\n        setTimeout(setPlayerListHeight, 0);\r\n        \r\n        requestAnimationFrame(setActiveCardForMobileScroll);\r\n    }\r\n\r\n    // NEW FUNCTION: Resets collapse state when screen is wide (desktop/tablet)\r\n    function resetCollapseOnResize() {\r\n        // Breakpoint for switching from stacked to two-column layout\r\n        const DESKTOP_BREAKPOINT = 900; \r\n\r\n        // We only need to reset the state if the window is wider than the mobile/stacked breakpoint\r\n        if (window.innerWidth > DESKTOP_BREAKPOINT) {\r\n            let stateChanged = false;\r\n\r\n            if (!state.mobileControls.isSummaryExpanded) {\r\n                state.mobileControls.isSummaryExpanded = true;\r\n                stateChanged = true;\r\n            }\r\n\r\n            if (!state.mobileControls.isPlayersExpanded) {\r\n                state.mobileControls.isPlayersExpanded = true;\r\n                stateChanged = true;\r\n            }\r\n\r\n            state.courts.forEach(court => {\r\n                if (court.isCollapsed) {\r\n                    court.isCollapsed = false;\r\n                    stateChanged = true;\r\n                }\r\n            });\r\n\r\n            if (stateChanged) {\r\n                // Save the state immediately and re-render the UI\r\n                saveState();\r\n                render();\r\n            }\r\n        }\r\n    }\r\n    \r\n    // UTILITY: Finds the ID of the first available and visible court based on hierarchy\r\n    function findNextAvailableCourtId() {\r\n        for (const id of COURT_HIERARCHY) {\r\n            const court = state.courts.find(c => c.id === id);\r\n            // Check if court exists, is visible, and is available\r\n            if (court && state.courtSettings.visibleCourts.includes(id) && court.status === 'available') {\r\n                return id;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n// REPLACE this function\r\n    function handleModeOptionsClick(courtId) {\r\n        // If an admin session is already active, just perform the action.\r\n        if (adminSessionActive) {\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (court) {\r\n                court.isModeOverlayActive = !court.isModeOverlayActive;\r\n                if (court.isModeOverlayActive) {\r\n                    state.courts.forEach(c => {\r\n                        if (c.id !== courtId) c.isModeOverlayActive = false;\r\n                    });\r\n                }\r\n                render();\r\n                saveState();\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Otherwise, store the action and show the dedicated court mode keypad.\r\n        courtModeAction = () => {\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (court) {\r\n                court.isModeOverlayActive = !court.isModeOverlayActive;\r\n                 if (court.isModeOverlayActive) {\r\n                    state.courts.forEach(c => {\r\n                        if (c.id !== courtId) c.isModeOverlayActive = false;\r\n                    });\r\n                }\r\n                render();\r\n                saveState();\r\n            }\r\n        };\r\n        showCourtModeKeypad();\r\n    }\r\n\r\n\r\n    function handleMatchModeChange(e) {\r\n        const newMode = e.target.value;\r\n        state.matchSettings.matchMode = newMode;\r\n        saveState();\r\n\r\n        // Toggle visibility of the Fast Play Games selector in the admin modal\r\n        const fastPlaySelector = document.querySelector('.fast-play-games-selector');\r\n        if (fastPlaySelector) {\r\n            fastPlaySelector.style.display = newMode === 'fast' ? '' : 'none';\r\n        }\r\n\r\n        render(); // <-- ADD THIS LINE to refresh the UI\r\n    }\r\n\r\n    function handleFastPlayGamesChange(e) {\r\n        state.matchSettings.fastPlayGames = parseInt(e.target.value, 10);\r\n        saveState();\r\n        render(); // <-- ADD THIS LINE\r\n    }\r\n\r\n\r\n    // NEW FUNCTION: Sets the court mode and closes the mode overlay\r\n    function handleSetCourtMode(courtId, newMode) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (court) {\r\n            court.courtMode = newMode;\r\n            court.isModeOverlayActive = false; // Always close the overlay after selection\r\n\r\n            // Preserve the existing player selection and re-render the court grid.\r\n            render();\r\n            saveState();\r\n\r\n            // CRITICAL FIX: After the render cycle, use requestAnimationFrame\r\n            // to guarantee that the animation is restored to all now-selectable courts.\r\n            requestAnimationFrame(ensureCourtSelectionAnimation);\r\n        }\r\n    }\r\n\r\n    function handleCourtGridClick(e){\r\n        const courtCard = e.target.closest(\".court-card\");\r\n        if (!courtCard) return;\r\n\r\n        // Find the closest element with a data-action, not just the direct click target.\r\n        const actionTarget = e.target.closest('[data-action]');\r\n        const action = actionTarget ? actionTarget.dataset.action : null;\r\n        \r\n        const courtId = courtCard.dataset.courtId;\r\n\r\n        const teamsNotSet = e.target.closest(\".teams-not-set\");\r\n        if (teamsNotSet) {\r\n            // Ignore click if it's the non-clickable 'Reserved For X' text\r\n            if (teamsNotSet.style.cursor !== 'default') {\r\n                handleChooseTeams(courtId);\r\n                return;\r\n            }\r\n        }\r\n\r\n        if (action === 'more-options') { // ✅ NEW: Toggles the Mode Selection Overlay\r\n            handleModeOptionsClick(courtId);\r\n            return;\r\n        }\r\n        \r\n        if (action === 'set-court-mode') { // ✅ NEW: Sets the court mode\r\n            handleSetCourtMode(courtId, actionTarget.dataset.mode); \r\n            return;\r\n        }\r\n\r\n        if (action === 'edit-game') {\r\n            showManageCourtPlayersModal(courtId);\r\n            return;\r\n        }\r\n\r\n        if (action === 'toggle-light') {\r\n            handleLightToggleChange(e);\r\n            return;\r\n        }\r\n        \r\n        if (action === 'randomize-teams') {\r\n            handleRandomizeTeams(courtId);\r\n            return;\r\n        }\r\n        if (action === 'choose-later') {\r\n            handleChooseLater(courtId);\r\n            return;\r\n        }\r\n        if (action === 'choose-teams') {\r\n            // --- THIS IS THE FIX ---\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            // If the game is already in progress, pass a special context.\r\n            if (court && court.status === 'in_progress') {\r\n                handleChooseTeams(courtId, 'in_progress');\r\n            } else {\r\n                handleChooseTeams(courtId);\r\n            }\r\n            // --- END OF FIX ---\r\n            return;\r\n        }\r\n        if (action === 'cancel-game-setup') {\r\n            handleCancelGame(courtId);\r\n            return;\r\n        }\r\n        if (action === 'start-game') {\r\n            handleStartGame(courtId);\r\n            return;\r\n        }\r\n        if (action === 'end-game') {\r\n            const button = e.target.closest('.end-game-ball');\r\n            if (button) {\r\n                button.classList.remove('animate-in');\r\n                button.classList.add('hide-anim');\r\n                setTimeout(() => {\r\n                    handleEndGame(courtId);\r\n                }, 1500);\r\n            } else {\r\n                handleEndGame(courtId);\r\n            }\r\n            return;\r\n        }\r\n        \r\n        if (action === 'select-court-action') {\r\n            const clickedButton = e.target.closest('.court-confirm-btn');\r\n            if (!clickedButton) return;\r\n            \r\n            // 🔴 EXCLUSION LOGIC: Block selection if the court is only marked as reserved\r\n            if (clickedButton.dataset.reservedOnly === 'true') {\r\n                playCustomTTS(\"This court is reserved for a different type of match.\");\r\n                return;\r\n            }\r\n\r\n            const allSelectableButtons = document.querySelectorAll('.court-card.selectable .court-confirm-btn.select-court');\r\n            clickedButton.classList.remove('serve-in');\r\n            clickedButton.classList.add('hide-anim');\r\n\r\n            let delay = 0;\r\n            allSelectableButtons.forEach(button => {\r\n                if (button !== clickedButton) {\r\n                    setTimeout(() => {\r\n                        button.classList.remove('serve-in');\r\n                        button.classList.add('serve-out');\r\n                    }, delay);\r\n                    delay += 200;\r\n                }\r\n            });\r\n\r\n            setTimeout(() => {\r\n                const { players: selectedPlayerNames, gameMode } = state.selection;\r\n                const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\r\n\r\n                if (selectedPlayerNames.length !== requiredPlayers || !courtId) return;\r\n\r\n                // NEW: Check if on-duty member is in the selection BEFORE setting up the court\r\n                if (checkOnDutyMemberInSelection(selectedPlayerNames)) {\r\n                    showTempDutyHandoverModal(() => {\r\n                        // This callback continues the game setup after duty handover\r\n                        proceedWithCourtSelection(selectedPlayerNames, courtId, gameMode);\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                // If on-duty member is not selected, proceed normally\r\n                proceedWithCourtSelection(selectedPlayerNames, courtId, gameMode);\r\n\r\n            }, 2000);\r\n            \r\n            return;\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Extracted court selection logic\r\n\r\n    function proceedWithCourtSelection(selectedPlayerNames, courtId, gameMode) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n\r\n        // --- THIS IS THE FIX ---\r\n        // The snapshot is now taken BEFORE any players are removed from the available list.\r\n        court.queueSnapshot = JSON.parse(JSON.stringify(state.availablePlayers));\r\n        // --- END OF FIX ---\r\n\r\n        // If a suggestion is active, use its teams and bypass player selection\r\n        if (state.activeSuggestion) {\r\n            court.players = [...state.activeSuggestion.team1, ...state.activeSuggestion.team2];\r\n            court.teams.team1 = state.activeSuggestion.team1;\r\n            court.teams.team2 = state.activeSuggestion.team2;\r\n            court.teamsSet = true;\r\n            court.gameMode = 'doubles'; // Suggestion is always for doubles\r\n            \r\n            state.availablePlayers = state.availablePlayers.filter(p => !court.players.some(p2 => p2.name === p.name));\r\n            clearSuggestionHighlights(); // Clear highlights and stored suggestion\r\n        } else {\r\n            const selectedPlayerObjects = selectedPlayerNames.map(name => getPlayerByName(name));\r\n            court.players = [...selectedPlayerObjects];\r\n            court.gameMode = gameMode;\r\n            if (gameMode === 'doubles') {\r\n                court.status = \"selecting_teams\";\r\n                court.teams.team1 = [];\r\n                court.teams.team2 = [];\r\n            } else {\r\n                court.teams.team1 = [selectedPlayerObjects[0]];\r\n                court.teams.team2 = [selectedPlayerObjects[1]];\r\n            }\r\n            state.availablePlayers = state.availablePlayers.filter(p => !selectedPlayerNames.includes(p.name));\r\n        }\r\n\r\n        // The rest of the original function remains the same\r\n        court.status = court.status === \"selecting_teams\" ? \"selecting_teams\" : \"game_pending\";\r\n        if (court.status === \"game_pending\") {\r\n            court.autoStartTimeTarget = Date.now() + 60000;\r\n            court.autoStartTimer = setTimeout(() => handleStartGame(courtId), 60000);\r\n        }\r\n\r\n        // --- ADD THIS BLOCK ---\r\n        // Clear the stored suggestion outcome for the next turn\r\n        state.currentSuggestionOutcome = null;\r\n        state.currentSuggestionType = null;\r\n        // --- END ADD ---\r\n\r\n        state.selection = { gameMode: state.selection.gameMode, players: [], courtId: null };\r\n        updateGameModeBasedOnPlayerCount();\r\n        enforceDutyPosition();\r\n        render();\r\n        saveState();\r\n    }\r\n\r\n    function formatDuration(ms) { if (ms === 0) return \"00h00m\"; const totalMinutes = Math.floor(ms / 60000); const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; return `${String(hours).padStart(2, \"0\")}h${String(minutes).padStart(2, \"0\")}m`; }\r\n    function calculatePlayerStats(gamesToProcess){\r\n        const stats = {};\r\n        gamesToProcess.forEach(game => {\r\n            const allPlayersInGame = [...game.teams.team1, ...game.teams.team2];\r\n\r\n            // Find the player objects to check their leaderboard preference\r\n            const allPlayerObjects = allPlayersInGame.map(name => getPlayerByName(name));\r\n\r\n            // If ANY player in the game has opted out, the game does not count for anyone's stats\r\n            if (allPlayerObjects.some(p => p.onLeaderboard === false)) {\r\n                return; // Skip this game\r\n            }\r\n\r\n            const allPlayers = [...game.teams.team1, ...game.teams.team2];\r\n            const [hStr, mStr] = game.duration.split('h').map(s => s.replace('m', ''));\r\n            const gameDuration = (parseInt(hStr, 10) * 3600000) + (parseInt(mStr, 10) * 60000);\r\n\r\n            allPlayers.forEach(player => {\r\n                stats[player] = stats[player] || { played: 0, won: 0, totalDurationMs: 0 };\r\n                stats[player].totalDurationMs += gameDuration;\r\n            });\r\n\r\n            if (game.winner !== 'skipped') {\r\n                const winnerTeam = game.winner === \"team1\" ? game.teams.team1 : game.teams.team2;\r\n                if (game.score) {\r\n                    const loserTeam = game.winner === \"team1\" ? game.teams.team2 : game.teams.team1;\r\n                    const winnerScore = game.score.team1 > game.score.team2 ? game.score.team1 : game.score.team2;\r\n                    const loserScore = game.score.team1 > game.score.team2 ? game.score.team2 : game.score.team1;\r\n                    allPlayers.forEach(player => {\r\n                        if (winnerTeam.includes(player)) {\r\n                            stats[player].played += winnerScore + loserScore;\r\n                            stats[player].won += winnerScore;\r\n                        } else if (loserTeam.includes(player)) {\r\n                            stats[player].played += winnerScore + loserScore;\r\n                            stats[player].won += loserScore;\r\n                        }\r\n                    });\r\n                } else {\r\n                    allPlayers.forEach(player => {\r\n                        stats[player].played += 1;\r\n                        if (winnerTeam.includes(player)) {\r\n                            stats[player].won += 1;\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n        return stats;\r\n    }\r\n    function formatWinPercentage(played, won){ return played === 0 ? \"N/A\" : `${Math.round(won / played * 100)}%`; }\r\n\r\n// ADD NEW FUNCTION: Pause/Resume game play click handler\r\n//    function handlePauseToggleClick(e) {\r\n //       const button = e.target.closest(\".pause-toggle-btn\");\r\n//        // We know button exists because it was checked in handlePlayerClick\r\n//        \r\n//        const playerName = button.dataset.playerName;\r\n//        const action = button.dataset.action; // 'pause' or 'resume'\r\n//        const playerObj = state.availablePlayers.find(p => p.name === playerName);\r\n//\r\n//        if (!playerObj) return;\r\n//\r\n //       const verb = action === 'pause' ? 'pause' : 'resume';\r\n //       const message = action === 'pause' \r\n//            ? `Are you sure you want to pause your game play? You will remain in position #${state.availablePlayers.indexOf(playerObj) + 1} until you resume.` \r\n//            : `Are you sure you want to resume your game play? You will be immediately restored to position #${state.availablePlayers.indexOf(playerObj) + 1}.`;\r\n////\r\n//        cancelConfirmModal.querySelector(\"h3\").textContent = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;\r\n//        cancelConfirmModal.querySelector(\"p\").textContent = message;\r\n//        modalBtnYesConfirm.textContent = verb.charAt(0).toUpperCase() + verb.slice(1);\r\n//        modalBtnNo.textContent = \"Close\";\r\n//        \r\n //       cancelConfirmModal.dataset.mode = \"pauseToggle\";\r\n//        cancelConfirmModal.dataset.player = playerName;\r\n//        cancelConfirmModal.dataset.verb = action;\r\n//\r\n//        cancelConfirmModal.classList.remove(\"hidden\");\r\n//    }\r\n\r\n// ADD NEW FUNCTION: Pause/Resume game play click handler (IMMEDIATE ACTION)\r\n//    function handlePauseToggleClick(e) {\r\n//        const button = e.target.closest(\".pause-toggle-btn\");\r\n//        if (!button) return;\r\n//        \r\n//        const playerName = button.dataset.playerName;\r\n//        const action = button.dataset.action;\r\n//        const playerObj = state.availablePlayers.find(p => p.name === playerName);\r\n//\r\n//        if (playerObj) {\r\n//            // IMMEDIATE ACTION: Toggle the paused state\r\n//            playerObj.isPaused = (action === 'pause');\r\n//            \r\n//            // Re-run necessary updates\r\n//            updateGameModeBasedOnPlayerCount();\r\n//            enforceDutyPosition();\r\n//            render();\r\n//            saveState();\r\n//            checkAndPlayAlert(false);\r\n//        }\r\n//    }\r\n\r\n    function handleSort(key) { if (state.statsFilter.sortKey === key) { state.statsFilter.sortOrder = state.statsFilter.sortOrder === 'asc' ? 'desc' : 'asc'; } else { state.statsFilter.sortKey = key; state.statsFilter.sortOrder = key === 'name' ? 'asc' : 'desc'; } renderHistory(); saveState(); }\r\n    function renderHistory() {\r\n        const historyListEl = document.getElementById('history-list');\r\n        const teamHistoryListEl = document.getElementById('team-history-list');\r\n        const historyTitle = document.querySelector(\"#history-page h3\");\r\n        const historyToggleViewBtn = document.getElementById('history-toggle-view');\r\n        const historyToggleTeamsBtn = document.getElementById('history-toggle-teams-btn');\r\n\r\n        // Hide all lists initially\r\n        historyListEl.style.display = 'none';\r\n        teamHistoryListEl.style.display = 'none';\r\n        setActiveMobileMenuItem('mobile-history-btn');\r\n\r\n        if (state.historyViewMode === \"stats\") {\r\n            historyTitle.textContent = \"Player Stats\";\r\n            historyToggleViewBtn.textContent = \"Game History\";\r\n            historyToggleTeamsBtn.textContent = \"Team Stats\";\r\n            historyListEl.style.display = ''; // Show the player stats/game history list\r\n            renderPlayerHistory(); // A new function for just the player stats part\r\n        } else if (state.historyViewMode === \"teams\") {\r\n            historyTitle.textContent = \"Team Stats\";\r\n            historyToggleViewBtn.textContent = \"Player Stats\";\r\n            historyToggleTeamsBtn.textContent = \"Game History\";\r\n            teamHistoryListEl.style.display = ''; \r\n            state.statsFilter.teamGender = 'all'; // <-- ADD THIS LINE\r\n            renderTeamHistory();\r\n        } else { // \"games\" view\r\n            historyTitle.textContent = \"Game History\";\r\n            historyToggleViewBtn.textContent = \"Player Stats\";\r\n            historyToggleTeamsBtn.textContent = \"Team Stats\";\r\n            historyListEl.style.display = ''; // Show the player stats/game history list\r\n            renderGameHistory(); // A new function for just the game history part\r\n        }\r\n    }\r\n\r\n    function renderPlayerHistory() {\r\n        const stats = calculatePlayerStats(state.gameHistory);\r\n        const allKnownPlayers = getAllKnownPlayers();\r\n        const historyListEl = document.getElementById('history-list');\r\n        historyListEl.innerHTML = \"\";\r\n\r\n        let playersWithStats = Object.keys(stats).filter(name => {\r\n            const playerObj = allKnownPlayers.find(p => p.name === name);\r\n            if (!playerObj || playerObj.onLeaderboard === false) return false;\r\n            if (state.statsFilter.gender === 'all') return true;\r\n            return playerObj.gender === state.statsFilter.gender;\r\n        });\r\n\r\n        // --- H2H FILTERING LOGIC ---\r\n        if (state.comparison.active && state.comparison.items.length === 1) {\r\n            const selectedPlayer = state.comparison.items[0];\r\n            // Filter the list to only include the selected player and their opponents\r\n            playersWithStats = playersWithStats.filter(name => \r\n                name === selectedPlayer || state.comparison.opponents.has(name)\r\n            );\r\n        }\r\n        // --- END H2H FILTERING ---\r\n\r\n        playersWithStats.sort((a, b) => {\r\n            const statA = stats[a];\r\n            const statB = stats[b];\r\n            let compareValue = 0;\r\n            if (state.statsFilter.sortKey === 'name') {\r\n                compareValue = a.localeCompare(b);\r\n            } else {\r\n                compareValue = (statB[state.statsFilter.sortKey] || 0) - (statA[state.statsFilter.sortKey] || 0);\r\n            }\r\n            return state.statsFilter.sortOrder === 'asc' ? -compareValue : compareValue;\r\n        });\r\n\r\n        const genderFilterHTML = `\r\n            <div class=\"gender-selector\" style=\"justify-content: center; margin-bottom: 1rem;\">\r\n                <div class=\"radio-group\">\r\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"all\" ${state.statsFilter.gender === 'all' ? 'checked' : ''}> All </label>\r\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"M\" ${state.statsFilter.gender === 'M' ? 'checked' : ''}> Men </label>\r\n                    <label> <input type=\"radio\" name=\"stats-gender-filter\" value=\"F\" ${state.statsFilter.gender === 'F' ? 'checked' : ''}> Women </label>\r\n                </div>\r\n            </div>`;\r\n\r\n        if (playersWithStats.length === 0) {\r\n            historyListEl.innerHTML = genderFilterHTML + '<p style=\"text-align: center; color: #6c757d;\">No stats available for the selected filter.</p>';\r\n        } else {\r\n            const getSortIcon = (key) => (state.statsFilter.sortKey !== key) ? ' ' : (state.statsFilter.sortOrder === 'asc' ? ' 🔼' : ' 🔽');\r\n\r\n            const tableHeader = `\r\n                <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\r\n                    <div class=\"stats-grid-row\">\r\n                        <button class=\"sort-btn\" data-sort-key=\"name\" style=\"text-align: left; background: none; border: none; font-weight: bold; cursor: pointer;\">Player${getSortIcon('name')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"played\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Played${getSortIcon('played')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"won\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Won %${getSortIcon('won')}</button>\r\n                        <button class=\"sort-btn\" data-sort-key=\"totalDurationMs\" style=\"background: none; border: none; font-weight: bold; cursor: pointer;\">Time${getSortIcon('totalDurationMs')}</button>\r\n                    </div>\r\n                </div>`;\r\n\r\n            const playerRows = playersWithStats.map(name => {\r\n                const playerStats = stats[name];\r\n                const winPercentage = formatWinPercentage(playerStats.played, playerStats.won);\r\n\r\n                let rowClass = '';\r\n                if(state.comparison.items.includes(name)) {\r\n                    rowClass = 'selected-for-comparison';\r\n                }\r\n\r\n                return `\r\n                    <div class=\"history-item ${rowClass}\" data-name=\"${name}\" data-type=\"player\">\r\n                        <div class=\"stats-grid-row\">\r\n                            <span>${name}</span>\r\n                            <span>${playerStats.played}</span>\r\n                            <span>${winPercentage}</span>\r\n                            <span>${formatDuration(playerStats.totalDurationMs)}</span>\r\n                        </div>\r\n                    </div>`;\r\n            }).join('');\r\n\r\n            historyListEl.innerHTML = genderFilterHTML + tableHeader + playerRows;\r\n        }\r\n\r\n        historyListEl.querySelectorAll('input[name=\"stats-gender-filter\"]').forEach(radio => radio.addEventListener('change', handleStatsFilterChange));\r\n        historyListEl.querySelectorAll('.sort-btn').forEach(btn => btn.addEventListener('click', handleSortClick));\r\n    }\r\n\r\n    function renderGameHistory() {\r\n        const historyListEl = document.getElementById('history-list');\r\n        historyListEl.innerHTML = \"\";\r\n        \r\n        if (state.gameHistory.length === 0) {\r\n            // Include the filters even when empty\r\n            const emptyFilters = createGameHistoryFilters(); \r\n            historyListEl.innerHTML = emptyFilters + '<p style=\"text-align: center; color: #6c757d;\">No games have been completed yet.</p>';\r\n            \r\n            // Re-attach listeners even to the empty version\r\n            attachGameHistoryFilterListeners();\r\n            return;\r\n        }\r\n\r\n        // --- FILTERING LOGIC ---\r\n        const filteredByTime = state.gameHistory.filter(game => \r\n            isGameInTimeFrame(game, state.gameHistoryFilter.timeFrame)\r\n        );\r\n\r\n        const filteredHistory = filteredByTime.filter(game => {\r\n            if (state.gameHistoryFilter.gameType === 'all') return true;\r\n            return game.teams.team1.length === (state.gameHistoryFilter.gameType === 'doubles' ? 2 : 1);\r\n        });\r\n\r\n        // --- Sorting Logic ---\r\n        const sortedHistory = [...filteredHistory].sort((a, b) => {\r\n            // ... (existing sorting logic remains here) ...\r\n            const { key, order } = state.historySort;\r\n            let valA, valB;\r\n\r\n            if (key === 'score') {\r\n                // If score is null (skipped game), treat as 0 for sorting purposes\r\n                valA = a.score ? Math.max(a.score.team1, a.score.team2) : 0;\r\n                valB = b.score ? Math.max(b.score.team1, b.score.team2) : 0;\r\n            } else if (key === 'court') {\r\n                // Sorting by court (A, B, C...)\r\n                valA = a.court || '';\r\n                valB = b.court || '';\r\n            }\r\n            else {\r\n                // Default to sorting by endTime if other key is not found or is 'endTime'\r\n                valA = a.endTime || 0; \r\n                valB = b.endTime || 0;\r\n            }\r\n            // For 'score' and 'endTime', default order is usually desc. For 'court' it is asc.\r\n            const defaultOrder = (key === 'score' || key === 'endTime') ? 'desc' : 'asc';\r\n            const finalOrder = order || defaultOrder;\r\n\r\n            if (valA < valB) return finalOrder === 'asc' ? -1 : 1;\r\n            if (valA > valB) return finalOrder === 'asc' ? 1 : -1;\r\n            return 0; \r\n        });\r\n\r\n        // --- HEADER GENERATION ---\r\n        const getSortIcon = (key) => (state.historySort.key !== key) ? ' ' : (state.historySort.order === 'asc' ? ' 🔼' : ' 🔽');\r\n        const headerHTML = `\r\n            <div class=\"history-item\" style=\"font-weight: bold; background-color: #f8f9fa;\">\r\n                <div class=\"game-history-grid\">\r\n                    <button class=\"sort-btn game-time-cell\" data-sort-key=\"endTime\">${'Time'}${getSortIcon('endTime')}</button>\r\n                    <button class=\"sort-btn game-duration-cell\" data-sort-key=\"court\">Game Info${getSortIcon('court')}</button>\r\n                    <div class=\"teams-header game-teams-cell\">Teams</div>\r\n                    <button class=\"sort-btn game-score-cell\" data-sort-key=\"score\">${'Score'}${getSortIcon('score')}</button>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // --- GAME ROWS GENERATION (Existing Logic) ---\r\n        const gamesHTML = sortedHistory.map(game => {\r\n            // ... (existing game row rendering logic) ...\r\n            const gameDate = new Date(game.endTime);\r\n            const time = gameDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });\r\n            const date = gameDate.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });\r\n\r\n            const isResultSkipped = game.winner === 'skipped';\r\n            \r\n            let team1Class = isResultSkipped ? '' : (game.winner === \"team1\" ? 'winner' : 'loser');\r\n            let team2Class = isResultSkipped ? '' : (game.winner === \"team1\" ? 'loser' : 'winner');\r\n\r\n            const team1HTML = game.teams.team1.map(player => `<p class=\"${team1Class}\">${player}</p>`).join('');\r\n            const team2HTML = game.teams.team2.map(player => `<p class=\"${team2Class}\">${player}</p>`).join('');\r\n            \r\n            let scoreDisplayHTML;\r\n            if (isResultSkipped) {\r\n                scoreDisplayHTML = '<p>Skipped</p>';\r\n            } else if (!game.score) {\r\n                scoreDisplayHTML = 'N/A';\r\n            } else {\r\n                const winningScore = game.winner === 'team1' ? game.score.team1 : game.score.team2;\r\n                const losingScore = game.winner === 'team1' ? game.score.team2 : game.score.team1;\r\n\r\n                scoreDisplayHTML = `<p><span class=\"winner\">${winningScore}</span> - <span class=\"loser\">${losingScore}</span></p>`;\r\n\r\n                if (game.score.tiebreak1 !== null && game.score.tiebreak2 !== null) {\r\n                    const winnerTiebreak = game.winner === 'team1' ? game.score.tiebreak1 : game.score.tiebreak2;\r\n                    const loserTiebreak = game.winner === 'team1' ? game.score.tiebreak2 : game.score.tiebreak1;\r\n                    const tiebreakHTML = `(<span class=\"winner\">${winnerTiebreak}</span> - <span class=\"loser\">${loserTiebreak}</span>)`;\r\n                    scoreDisplayHTML += `<p style=\"font-size: 0.9em; color: var(--neutral-color);\">${tiebreakHTML}</p>`;\r\n                }\r\n            }\r\n\r\n            const courtDisplay = game.court === 'Manual' \r\n                ? `${game.teams.team1.length === 2 ? 'Doubles' : 'Singles'}` \r\n                : `Court ${game.court}`;\r\n            \r\n            // MODIFIED DURATION CELL\r\n            return `\r\n                <div class=\"history-item\" data-game-id=\"${game.id}\"> \r\n                    <div class=\"game-history-grid\">\r\n                        <div class=\"game-time-cell\" style=\"display: flex; flex-direction: column; line-height: 1.2;\">\r\n                            <span>${time}</span>\r\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${date}</span>\r\n                        </div>\r\n                        <div class=\"game-duration-cell\" style=\"display: flex; flex-direction: column; line-height: 1.2;\">\r\n                            <span>${courtDisplay}</span>\r\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${game.duration}</span>\r\n                        </div>\r\n                        <div class=\"game-teams-cell\">\r\n                            ${team1HTML}\r\n                            ${team2HTML}\r\n                        </div>\r\n                        <div class=\"game-score-cell\">\r\n                            ${scoreDisplayHTML}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        }).join('');\r\n        \r\n        // --- ASSEMBLE FINAL HTML ---\r\n        historyListEl.innerHTML = createGameHistoryFilters() + headerHTML + gamesHTML;\r\n        \r\n        // --- RE-ATTACH LISTENERS ---\r\n        historyListEl.querySelectorAll('.sort-btn').forEach(btn => {\r\n            btn.addEventListener('click', handleHistorySortClick);\r\n        });\r\n        attachGameHistoryFilterListeners();\r\n    }\r\n\r\n    function createGameHistoryFilters() {\r\n        const { timeFrame, gameType } = state.gameHistoryFilter;\r\n        \r\n        return `\r\n            <div class=\"game-history-filter-container\">\r\n                <div class=\"gender-selector\" style=\"justify-content: center;\">\r\n                    <div class=\"radio-group\">\r\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Today\" ${timeFrame === 'Today' ? 'checked' : ''}> Today </label>\r\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Month\" ${timeFrame === 'Month' ? 'checked' : ''}> Month </label>\r\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Year\" ${timeFrame === 'Year' ? 'checked' : ''}> Year </label>\r\n                        <label> <input type=\"radio\" name=\"game-time-filter\" value=\"Total\" ${timeFrame === 'Total' ? 'checked' : ''}> Total </label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    function attachGameHistoryFilterListeners() {\r\n        // Time Frame Filter\r\n        document.querySelectorAll('input[name=\"game-time-filter\"]').forEach(radio => {\r\n            radio.removeEventListener('change', handleGameTimeFilterChange);\r\n            radio.addEventListener('change', handleGameTimeFilterChange);\r\n        });\r\n\r\n        // Game Type Filter\r\n        document.querySelectorAll('input[name=\"game-type-filter\"]').forEach(radio => {\r\n            radio.removeEventListener('change', handleGameTypeFilterChange);\r\n            radio.addEventListener('change', handleGameTypeFilterChange);\r\n        });\r\n    }\r\n\r\n    function renderReorderHistory() {\r\n        reorderHistoryList.innerHTML = \"\";\r\n        \r\n        if (state.reorderHistory.length === 0) {\r\n            reorderHistoryList.innerHTML = '<p style=\"text-align: center; color: #6c757d; padding: 2rem;\">No queue reorder actions have been logged.</p>';\r\n            return;\r\n        }\r\n\r\n        // Iterate through history, newest first\r\n        [...state.reorderHistory].reverse().forEach(entry => {\r\n            const dateTime = new Date(entry.endTime).toLocaleString();\r\n            let playersHtml = '';\r\n\r\n            // Iterate through players involved in this session\r\n            for (const [name, log] of Object.entries(entry.players)) {\r\n                // Only display players who actually moved (start position !== current position)\r\n                if (log.startPosition !== log.currentPosition) {\r\n                    playersHtml += `\r\n                        <p style=\"margin: 0.25rem 0; font-size: 0.95rem; display: flex; justify-content: space-between;\">\r\n                            <span style=\"font-weight: 500;\">${name}</span>\r\n                            <span style=\"color: var(--primary-blue);\">Moved from #${log.startPosition + 1} to #${log.currentPosition + 1}</span>\r\n                        </p>\r\n                    `;\r\n                }\r\n            }\r\n\r\n            // Only render the entry if at least one player moved\r\n            if (playersHtml) {\r\n                const details = document.createElement('div');\r\n                details.className = 'history-item';\r\n                details.style.textAlign = 'left';\r\n                details.innerHTML = `\r\n                    <div class=\"history-details\" style=\"margin-bottom: 0.75rem;\">\r\n                        <span style=\"color: var(--primary-blue);\">${entry.adminAction} (${dateTime})</span>\r\n                    </div>\r\n                    <div style=\"padding-left: 1rem;\">\r\n                        ${playersHtml}\r\n                    </div>\r\n                `;\r\n                reorderHistoryList.appendChild(details);\r\n            }\r\n        });\r\n    }\r\n\r\n    function handleStatsFilterChange(e) { state.statsFilter.gender = e.target.value; saveState(); renderHistory(); }\r\n    function handleSortClick(e) { const key = e.target.dataset.sortKey; if (key) { handleSort(key); } }\r\n    \r\n    // Player selection and game setup functions (no alert calls here)\r\n    function handleCancelSelection() {\r\n        // This is the corrected logic. It preserves the selected players\r\n        // and only nullifies the court selection before re-rendering.\r\n        state.selection.courtId = null;\r\n\r\n        // Note: We do NOT clear currentSuggestionOutcome here\r\n        // This prevents gaming the system by cancelling court selection to get different results\r\n\r\n        render();\r\n        saveState();\r\n    }\r\n    function handleModeChange(mode){\r\n        // 1. Unconditionally preserve the current selection at the start.\r\n        const playersToPreserve = [...state.selection.players];\r\n\r\n        state.selection.gameMode = mode;\r\n        state.selection.courtId = null;\r\n\r\n        const newRequiredPlayers = mode === \"doubles\" ? 4 : 2;\r\n\r\n        // 2. Decide whether to keep or clear the preserved players.\r\n        // This logic correctly handles switching from a 4-player selection to Singles.\r\n        if (newRequiredPlayers === 2 && playersToPreserve.length > 2) {\r\n            state.selection.players = [];\r\n        } else {\r\n            state.selection.players = playersToPreserve;\r\n        }\r\n\r\n        // 3. Rebuild the UI.\r\n        render();\r\n\r\n        // 4. CRITICAL FIX: Schedule the animation to run after the next browser paint.\r\n        // This guarantees that the '.selectable' courts exist in the DOM before we try to animate them.\r\n        requestAnimationFrame(() => {\r\n            // This second frame is a failsafe to ensure the paint has completed.\r\n            requestAnimationFrame(ensureCourtSelectionAnimation);\r\n        });\r\n\r\n        saveState();\r\n    }\r\n\r\n    function ensureCourtSelectionAnimation() {\r\n        const { players: selectedPlayerNames, gameMode } = state.selection;\r\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\r\n\r\n        if (selectedPlayerNames.length === requiredPlayers) {\r\n            const selectableCourts = document.querySelectorAll('.court-card.selectable .court-confirm-btn.select-court');\r\n            selectableCourts.forEach(button => {\r\n                // Unconditionally add the class to make the ball visible\r\n                button.classList.add('serve-in');\r\n            });\r\n        } else {\r\n            // If the selection is not complete, ensure the class is removed from all buttons.\r\n            const allCourts = document.querySelectorAll('.court-confirm-btn.select-court');\r\n            allCourts.forEach(button => {\r\n                button.classList.remove('serve-in');\r\n            });\r\n        }\r\n    }\r\n\r\n    function handlePlayerClick(e){\r\n        const suggestionBtn = e.target.closest('.suggestion-btn');\r\n        if (suggestionBtn) {\r\n            // If a suggestion is already active *on the screen* (highlighted), clear it.\r\n            if (state.activeSuggestion) {\r\n                clearSuggestionHighlights();\r\n                // Note: We do NOT clear currentSuggestionOutcome here\r\n                // This prevents gaming the system by toggling to get different results\r\n            } \r\n            // Otherwise, generate or retrieve the stored suggestion\r\n            else {\r\n                const selector = state.availablePlayers.find(p => !p.isPaused);\r\n                if (!selector) return; // No selector\r\n                \r\n                const available = state.availablePlayers.filter(p => p.name !== selector.name);\r\n\r\n                let suggestionOutcome;\r\n\r\n                // Check if we already have a stored outcome for this turn\r\n                if (state.currentSuggestionOutcome) {\r\n                    console.log(\"Using stored suggestion type:\", state.currentSuggestionType);\r\n                    suggestionOutcome = state.currentSuggestionOutcome;\r\n                } else {\r\n                    // If not, roll the dice and store the result\r\n                    console.log(\"Generating new suggestion outcome...\");\r\n                    // This now receives the { suggestion, type } object\r\n                    suggestionOutcome = findMostBalancedGame(selector, available);\r\n                    state.currentSuggestionOutcome = suggestionOutcome; // Store the whole object\r\n                    state.currentSuggestionType = suggestionOutcome.type; // Store just the type\r\n                }\r\n\r\n                // Now, use the suggestion part of the outcome\r\n                const actualSuggestion = suggestionOutcome.suggestion; // This is { team1, team2 } or null\r\n\r\n                if (actualSuggestion && actualSuggestion.team1 && actualSuggestion.team2) {\r\n                    // Populate the main selection array\r\n                    state.selection.players = [\r\n                        ...actualSuggestion.team1.map(p => p.name),\r\n                        ...actualSuggestion.team2.map(p => p.name)\r\n                    ];\r\n                    \r\n                    state.activeSuggestion = actualSuggestion; // Store the { team1, team2 } part for highlighting\r\n                    \r\n                    render(); // Re-render the UI with the new state\r\n                    \r\n                    // Trigger the court selection animations\r\n                    requestAnimationFrame(() => {\r\n                        requestAnimationFrame(ensureCourtSelectionAnimation);\r\n                    });\r\n                } else {\r\n                     console.error(\"Suggestion logic failed to return a valid suggestion.\");\r\n                     playCustomTTS(\"Could not find a balanced game with the current players.\");\r\n                }\r\n            }\r\n            return; // Stop further execution\r\n        }\r\n\r\n        const pauseButton = e.target.closest(\".pause-toggle-btn\");\r\n        if (pauseButton) {\r\n            handlePauseToggleClick(pauseButton);\r\n            return;\r\n        }\r\n        \r\n        // If a player is clicked manually, clear any active suggestion highlights\r\n        if(state.activeSuggestion) {\r\n            clearSuggestionHighlights();\r\n        }\r\n\r\n        // Note: We do NOT clear currentSuggestionOutcome here\r\n        // This prevents gaming the system by clicking players to get different results\r\n\r\n        const li = e.target.closest(\"li\");\r\n        \r\n        let firstAvailablePlayer = state.availablePlayers[0] ? state.availablePlayers[0].name : null;\r\n        if (state.availablePlayers[0] && state.availablePlayers[0].isPaused) {\r\n            const firstUnpaused = state.availablePlayers.find(p => !p.isPaused);\r\n            firstAvailablePlayer = firstUnpaused ? firstUnpaused.name : null;\r\n        }\r\n        \r\n        if (li && li.dataset.playerName === firstAvailablePlayer) return; \r\n        if (!li || li.classList.contains(\"disabled\") || li.classList.contains(\"waiting-message\") || state.availablePlayers.length === 0) return;\r\n        \r\n        const playerName = li.dataset.playerName; \r\n        const { players: selectedPlayerNames } = state.selection; \r\n\r\n        if (selectedPlayerNames.length === 0) { \r\n            if (playerName !== firstAvailablePlayer) { \r\n                selectedPlayerNames.push(firstAvailablePlayer, playerName); \r\n            } else { \r\n                selectedPlayerNames.push(playerName); \r\n            } \r\n        } else { \r\n            if (selectedPlayerNames.includes(playerName)) { \r\n                selectedPlayerNames.splice(selectedPlayerNames.indexOf(playerName), 1); \r\n                if (selectedPlayerNames.length === 1) { \r\n                    state.selection.players = []; \r\n                } \r\n            } else if (selectedPlayerNames.length < 4) {\r\n                selectedPlayerNames.push(playerName); \r\n            } \r\n        }\r\n\r\n        updateGameModeBasedOnSelection();\r\n        render(); \r\n        saveState();\r\n\r\n        const requiredPlayers = state.selection.gameMode === \"doubles\" ? 4 : 2;\r\n        if (state.selection.players.length === requiredPlayers) {\r\n            scrollToFirstAvailableCourt();\r\n            collapsePlayerListOnMobile();\r\n        }\r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(ensureCourtSelectionAnimation);\r\n        });\r\n    }\r\n\r\n    function handleConfirmSelection(){\r\n        const {players: selectedPlayerNames, courtId, gameMode} = state.selection;\r\n        const requiredPlayers = gameMode === \"doubles\" ? 4 : 2;\r\n        if (selectedPlayerNames.length !== requiredPlayers || !courtId) return;\r\n        \r\n        // This function is now only called from the confirmation overlay\r\n        // which means it's an alternative flow, but we still need the same check\r\n        if (checkOnDutyMemberInSelection(selectedPlayerNames)) {\r\n            showTempDutyHandoverModal(() => {\r\n                proceedWithCourtSelection(selectedPlayerNames, courtId, gameMode);\r\n            });\r\n            return;\r\n        }\r\n        \r\n        proceedWithCourtSelection(selectedPlayerNames, courtId, gameMode);\r\n    }\r\n\r\n\r\n    // NEW FUNCTION: Extracted game setup logic\r\n    function proceedWithGameSetup(selectedPlayerNames, courtId, gameMode) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        const selectedPlayerObjects = selectedPlayerNames.map(name => getPlayerByName(name));\r\n\r\n        court.queueSnapshot = JSON.parse(JSON.stringify(state.availablePlayers));\r\n        court.players = [...selectedPlayerObjects];\r\n        court.gameMode = gameMode;\r\n\r\n        // --- NEW LOGIC: Snapshot the match settings for this game ---\r\n        court.matchMode = state.matchSettings.matchMode;\r\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\r\n        // --- END NEW LOGIC ---\r\n\r\n        if (gameMode === 'doubles') {\r\n            court.status = \"selecting_teams\";\r\n            court.teams.team1 = [];\r\n            court.teams.team2 = [];\r\n        } else {\r\n            court.teams.team1 = [selectedPlayerObjects[0]];\r\n            court.teams.team2 = [selectedPlayerObjects[1]];\r\n            court.status = \"game_pending\";\r\n            court.autoStartTimeTarget = Date.now() + 60000;\r\n            court.autoStartTimer = setTimeout(() => handleStartGame(courtId), 60000);\r\n        }\r\n        state.availablePlayers = state.availablePlayers.filter(p => !selectedPlayerNames.includes(p.name));\r\n        state.selection = {gameMode: state.selection.gameMode, players: [], courtId: null};\r\n        updateGameModeBasedOnPlayerCount();\r\n        enforceDutyPosition();\r\n        autoAssignCourtModes();\r\n        render();\r\n        saveState();\r\n    }\r\n\r\n\r\n    function handleCheckout(playerObject) {\r\n        // This function decides which modal to show.\r\n        if (playerObject.onLeaderboard === true) {\r\n            // If the player opted IN, show the modal with stats.\r\n            // This now passes the full object as required by the updated function.\r\n            showCheckoutThanksModal(playerObject);\r\n        } else {\r\n            // If the player opted OUT, show the new modal without stats.\r\n            showCheckoutThanksModalNoStats(playerObject);\r\n        }\r\n    }\r\n\r\n    function handleChooseLater(courtId){\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        court.status = \"game_pending\";\r\n        court.teamsSet = false;\r\n        court.matchMode = state.matchSettings.matchMode;\r\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\r\n        court.autoStartTimeTarget = Date.now() + 60000;\r\n        court.autoStartTimer = setTimeout(() => handleStartGame(courtId), 60000);\r\n        render();\r\n        saveState();\r\n    }\r\n    function handleRandomizeTeams(courtId) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court || court.players.length !== 4) return;\r\n\r\n        const men = court.players.filter(p => p.gender === 'M');\r\n        const women = court.players.filter(p => p.gender === 'F');\r\n\r\n        // --- THIS IS THE NEW LOGIC ---\r\n        // If it's a 2-man, 2-woman group, create mixed teams\r\n        if (men.length === 2 && women.length === 2) {\r\n            // Shuffle each gender group\r\n            const shuffledMen = men.sort(() => 0.5 - Math.random());\r\n            const shuffledWomen = women.sort(() => 0.5 - Math.random());\r\n\r\n            // Create mixed teams\r\n            court.teams.team1 = [shuffledMen[0], shuffledWomen[0]];\r\n            court.teams.team2 = [shuffledMen[1], shuffledWomen[1]];\r\n        } else {\r\n            // Fallback to the original complete shuffle for any other combination\r\n            let players = [...court.players].sort(() => 0.5 - Math.random());\r\n            court.teams.team1 = [players[0], players[1]];\r\n            court.teams.team2 = [players[2], players[3]];\r\n        }\r\n        // --- END OF NEW LOGIC ---\r\n\r\n        court.status = \"game_pending\";\r\n        court.matchMode = state.matchSettings.matchMode;\r\n        court.fastPlayGames = state.matchSettings.fastPlayGames;\r\n        court.teamsSet = true;\r\n        court.autoStartTimeTarget = Date.now() + 60000;\r\n        court.autoStartTimer = setTimeout(() => handleStartGame(courtId), 60000);\r\n        render();\r\n        saveState();\r\n    }\r\n    function handleModalConfirm() {\r\n        const courtId = chooseTeamsModal.dataset.courtId;\r\n        const openedFrom = chooseTeamsModal.dataset.openedFrom;\r\n        const team1Names = Array.from(modalPlayerList.querySelectorAll(\".selected\")).map(el => el.dataset.player);\r\n\r\n        if (team1Names.length !== 2) {\r\n            alert(\"Please select exactly 2 players for Team 1.\");\r\n            return;\r\n        }\r\n\r\n        const allPlayerNames = JSON.parse(chooseTeamsModal.dataset.playerNames || '[]');\r\n        const allPlayerObjects = allPlayerNames.map(name => getPlayerByName(name));\r\n        const team1Players = team1Names.map(name => getPlayerByName(name));\r\n        const team2Players = allPlayerObjects.filter(player => !team1Names.includes(player.name));\r\n\r\n        chooseTeamsModal.classList.add(\"hidden\");\r\n        delete chooseTeamsModal.dataset.openedFrom;\r\n        delete chooseTeamsModal.dataset.playerNames;\r\n        delete chooseTeamsModal.dataset.courtId;\r\n\r\n        if (openedFrom === 'manual') {\r\n            const manualGameData = {\r\n                players: allPlayerObjects,\r\n                gameMode: 'doubles',\r\n                teamsSet: true, // Mark teams as set\r\n                teams: { team1: team1Players, team2: team2Players }\r\n            };\r\n            // Re-call handleEndGame with the completed data to show the results modal\r\n            handleEndGame(null, null, manualGameData);\r\n        } else {\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (court) {\r\n                court.teams.team1 = team1Players;\r\n                court.teams.team2 = team2Players;\r\n                court.teamsSet = true;\r\n                court.matchMode = state.matchSettings.matchMode;\r\n                court.fastPlayGames = state.matchSettings.fastPlayGames;\r\n\r\n                if (openedFrom === 'in_progress') {\r\n                    // If teams were set during an active game, re-render and return to manage modal\r\n                    render();\r\n                    saveState();\r\n                    // Reopen the manage players modal\r\n                    showManageCourtPlayersModal(courtId);\r\n                    return; // Exit early so we don't fall through to the saveState below\r\n                } else if (openedFrom === 'endgame') {\r\n                    handleEndGame(courtId); // Re-enter to show results modal\r\n                } else { // Normal pre-game setup\r\n                    court.status = \"game_pending\";\r\n                    court.autoStartTimeTarget = Date.now() + 60000;\r\n                    court.autoStartTimer = setTimeout(() => handleStartGame(courtId), 60000);\r\n                    render(); // <-- THIS IS THE FIX\r\n                }\r\n                saveState();\r\n            }\r\n        }\r\n    }\r\n\r\n    function handleChooseTeams(courtId, openedFrom = 'setup', players = null) {\r\n        chooseTeamsModal.classList.remove(\"hidden\");\r\n        chooseTeamsModal.dataset.openedFrom = openedFrom;\r\n\r\n        modalPlayerList.innerHTML = \"\";\r\n        modalPlayerList.classList.remove('two-row-grid');\r\n\r\n        document.getElementById('modal-confirm-teams-btn').textContent = \"Confirm\";\r\n        document.getElementById('modal-cancel-btn').textContent = \"Close\";\r\n\r\n        const court = courtId ? state.courts.find(c => c.id === courtId) : null;\r\n        const playersToDisplay = players || (court ? court.players : []);\r\n\r\n        if (playersToDisplay.length > 0) {\r\n            if (playersToDisplay.length === 4) {\r\n                modalPlayerList.classList.add('two-row-grid');\r\n            }\r\n\r\n            playersToDisplay.forEach(player => {\r\n                const div = document.createElement(\"div\");\r\n                div.className = \"modal-player\";\r\n                div.textContent = player.name;\r\n                div.dataset.player = player.name;\r\n                modalPlayerList.appendChild(div);\r\n            });\r\n            \r\n            // Store reference to the players being configured\r\n            chooseTeamsModal.dataset.playerNames = JSON.stringify(playersToDisplay.map(p => p.name));\r\n            if (courtId) {\r\n                chooseTeamsModal.dataset.courtId = courtId;\r\n            }\r\n        }\r\n\r\n        modalConfirmBtn.disabled = true;\r\n        modalConfirmBtn.classList.remove('modal-confirm-ready');\r\n\r\n        modalPlayerList.addEventListener('click', () => {\r\n            const selectedCount = modalPlayerList.querySelectorAll(\".selected\").length;\r\n            if (selectedCount === 2) {\r\n                modalConfirmBtn.disabled = false;\r\n                modalConfirmBtn.classList.add('modal-confirm-ready');\r\n            } else {\r\n                modalConfirmBtn.disabled = true;\r\n                modalConfirmBtn.classList.remove('modal-confirm-ready');\r\n            }\r\n        });\r\n    }\r\n\r\n    function handleModalPlayerClick(e){ if (e.target.classList.contains(\"modal-player\")){ const selectedCount = modalPlayerList.querySelectorAll(\".selected\").length; if (e.target.classList.contains(\"selected\")){ e.target.classList.remove(\"selected\"); } else if (selectedCount < 2) { e.target.classList.add(\"selected\"); } } }\r\n\r\n    function handleStartGame(courtId){\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court) return;\r\n\r\n        const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId}\"]`);\r\n        const startButton = courtCardEl ? courtCardEl.querySelector('[data-action=\"start-game\"]') : null;\r\n\r\n        if (startButton) {\r\n            startButton.classList.add('start-game-hop');\r\n        }\r\n\r\n        setTimeout(() => {\r\n            if(court.autoStartTimer) {\r\n                clearTimeout(court.autoStartTimer);\r\n                court.autoStartTimer = null;\r\n            }\r\n            court.status = \"in_progress\";\r\n            court.gameStartTime = Date.now();\r\n            court.autoStartTimeTarget = null;\r\n            court.isNewGame = true;\r\n\r\n            const team1Names = getPlayerNames(court.teams.team1);\r\n            const team2Names = getPlayerNames(court.teams.team2);\r\n            let announcementMessage;\r\n\r\n            // Updated formatTeamNames to use getPronounceableName\r\n            const formatTeamNames = (names) => {\r\n                const pronounceableNames = names.map(getPronounceableName); // Use helper here\r\n                if (pronounceableNames.length === 1) return pronounceableNames[0];\r\n                if (pronounceableNames.length === 2) return `${pronounceableNames[0]} and ${pronounceableNames[1]}`;\r\n                return pronounceableNames.slice(0, -1).join(', ') + ` and ${pronounceableNames.slice(-1)[0]}`;\r\n            };\r\n\r\n            const formattedCourtId = formatCourtIdForTTS(court.id);\r\n\r\n            // --- NEW ANNOUNCEMENT LOGIC ---\r\n            let matchModeAnnouncement = '';\r\n            if (court.matchMode === 'fast') {\r\n                matchModeAnnouncement = `... a Fast Play match, first to ${court.fastPlayGames} games`;\r\n            } else if (court.matchMode === '3set') {\r\n                matchModeAnnouncement = '... a 3 set match';\r\n            }\r\n            // --- END NEW LOGIC ---\r\n\r\n            if (court.gameMode === 'singles') {\r\n                // Use pronounceable names for singles\r\n                announcementMessage = `${getPronounceableName(team1Names[0])}, and ${getPronounceableName(team2Names[0])} ...are on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\r\n            } else { // Doubles\r\n                if (court.teamsSet === false) {\r\n                    const playerNames = getPlayerNames(court.players);\r\n                    const namesList = formatTeamNames(playerNames); // Uses pronounceable names via helper\r\n                    announcementMessage = `It's ${namesList}, on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\r\n                } else {\r\n                    const team1String = formatTeamNames(team1Names); // Uses pronounceable names via helper\r\n                    const team2String = formatTeamNames(team2Names); // Uses pronounceable names via helper\r\n                    announcementMessage = `It's team ${team1String}, versus team ${team2String} ...on Court ${formattedCourtId}${matchModeAnnouncement}... Lekker Speel!`;\r\n                }\r\n            }\r\n\r\n            playAlertSound(announcementMessage, null);\r\n            // --- THIS IS THE MODIFIED LOGIC ---\r\n            // 1. Scroll back to the summary card on mobile.\r\n            scrollToSummaryCard();\r\n\r\n            // 2. Expand the player list so it's ready for the next selection.\r\n            expandPlayerListOnMobile(); // <-- ADD THIS LINE\r\n\r\n            // 3. Render the final UI state.\r\n            render();\r\n            court.isNewGame = false;\r\n            saveState();\r\n            resetAlertSchedule();\r\n            checkAndPlayAlert(false);\r\n        }, 2000);\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function renderManualSelectedPlayers(container) {\r\n        container.innerHTML = '';\r\n        const { players } = state.manualEntry;\r\n\r\n        if (players.length === 0) {\r\n            container.innerHTML = '<p style=\"color: var(--neutral-color); margin: 0; text-align: center; width: 100%;\">No players selected yet.</p>';\r\n        } else {\r\n            players.forEach(playerName => {\r\n                const chip = document.createElement('div');\r\n                chip.className = 'selected-player-chip';\r\n                chip.textContent = playerName.split(' ')[0]; // This is the fix for first names\r\n                chip.dataset.playerName = playerName;\r\n                chip.title = 'Click to remove';\r\n                container.appendChild(chip);\r\n            });\r\n        }\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function handleRemoveManualPlayer(playerName) {\r\n        state.manualEntry.players = state.manualEntry.players.filter(p => p !== playerName);\r\n\r\n        // Check which modal is currently visible to refresh the correct view\r\n        if (!manualEntryModal.classList.contains('hidden')) {\r\n            showManualPlayerSelectionModal();\r\n        } else if (!outsidePlayerModal.classList.contains('hidden')) {\r\n            showOutsidePlayerModal();\r\n        }\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function openManualPlayerSelectionModal() {\r\n        state.manualEntry.players = []; // Clear state ONLY when opening fresh.\r\n        showManualPlayerSelectionModal(); // Now call the render function.\r\n    }\r\n\r\n// REPLACE this function\r\n    function showManualPlayerSelectionModal() {\r\n        historyPage.classList.add('hidden');\r\n        manualEntryModal.classList.remove('hidden');\r\n        \r\n        renderManualSelectedPlayers(manualSelectedPlayersContainer);\r\n\r\n        const playersOnCourt = state.courts.flatMap(c => c.players);\r\n        const allPlayersAtClub = [...state.availablePlayers, ...playersOnCourt];\r\n        \r\n        const uniquePlayers = Array.from(new Map(allPlayersAtClub.map(p => [p.name, p])).values())\r\n            .filter(p => !state.manualEntry.players.includes(p.name))\r\n            .sort((a, b) => a.name.localeCompare(b.name));\r\n\r\n        manualPlayerList.innerHTML = '';\r\n        if (uniquePlayers.length === 0) {\r\n            manualPlayerList.innerHTML = '<li class=\"waiting-message\">All checked-in players have been selected.</li>';\r\n        } else {\r\n            uniquePlayers.forEach(player => {\r\n                const li = document.createElement('li');\r\n                li.innerHTML = `\r\n                    <span style=\"flex-grow: 1;\">${player.name}</span>\r\n                    <span class=\"action-icon add\" data-player-name=\"${player.name}\">+</span>\r\n                `;\r\n                li.dataset.playerName = player.name;\r\n                manualPlayerList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        setupListWithIndex(uniquePlayers, manualPlayerList, document.getElementById('manual-player-abc-index'));\r\n        \r\n        const count = state.manualEntry.players.length;\r\n        const isValid = count === 2 || count === 4;\r\n        manualEntryConfirmBtn.disabled = !isValid;\r\n        manualEntryConfirmBtn.style.backgroundColor = isValid ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n\r\n// REPLACE this function\r\n    function handleManualPlayerClick(e) {\r\n        const addIcon = e.target.closest('.action-icon.add');\r\n        if (addIcon) {\r\n            const playerName = addIcon.dataset.playerName;\r\n            if (state.manualEntry.players.length < 4) {\r\n                state.manualEntry.players.push(playerName);\r\n                showManualPlayerSelectionModal(); // This is the fix\r\n            } else {\r\n                playCustomTTS(\"You can select a maximum of 4 players.\");\r\n            }\r\n        }\r\n    }\r\n\r\n// REPLACE this function\r\n    function showOutsidePlayerModal() {\r\n        manualEntryModal.classList.add('hidden');\r\n        outsidePlayerModal.classList.remove('hidden');\r\n\r\n        renderManualSelectedPlayers(outsideSelectedPlayersContainer);\r\n\r\n        const playersOnCourt = state.courts.flatMap(c => c.players.map(p => p.name));\r\n        const availablePlayerNames = state.availablePlayers.map(p => p.name);\r\n        const checkedInNames = new Set([...playersOnCourt, ...availablePlayerNames]);\r\n\r\n        const outsideMembers = MASTER_MEMBER_LIST.filter(m => !checkedInNames.has(m.name));\r\n        const returningGuests = state.guestHistory.filter(g => !checkedInNames.has(g.name));\r\n        \r\n        const allOutsidePlayers = [...outsideMembers, ...returningGuests]\r\n            .filter(p => !state.manualEntry.players.includes(p.name))\r\n            .sort((a, b) => a.name.localeCompare(b.name));\r\n        \r\n        outsidePlayerList.innerHTML = '';\r\n        if (allOutsidePlayers.length === 0) {\r\n            outsidePlayerList.innerHTML = '<li class=\"waiting-message\">All other players have been selected.</li>';\r\n        } else {\r\n            allOutsidePlayers.forEach(player => {\r\n                const li = document.createElement('li');\r\n                li.innerHTML = `\r\n                    <span style=\"flex-grow: 1;\">${player.name}</span>\r\n                    <span class=\"action-icon add\" data-player-name=\"${player.name}\">+</span>\r\n                `;\r\n                li.dataset.playerName = player.name;\r\n                outsidePlayerList.appendChild(li);\r\n            });\r\n        }\r\n        setupListWithIndex(allOutsidePlayers, outsidePlayerList, document.getElementById('outside-player-abc-index'));\r\n\r\n        // Logic for the new confirm button\r\n        const count = state.manualEntry.players.length;\r\n        const isValid = count === 2 || count === 4;\r\n        outsidePlayerConfirmBtn.disabled = !isValid;\r\n        outsidePlayerConfirmBtn.style.backgroundColor = isValid ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n\r\n// REPLACE this function\r\n    function handleOutsidePlayerClick(e) {\r\n        const addIcon = e.target.closest('.action-icon.add');\r\n        if (addIcon) {\r\n            const playerName = addIcon.dataset.playerName;\r\n            if (state.manualEntry.players.length < 4) {\r\n                state.manualEntry.players.push(playerName);\r\n                showOutsidePlayerModal(); // Re-render this view\r\n            } else {\r\n                playCustomTTS(\"You have already selected the maximum of 4 players.\");\r\n            }\r\n        }\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function handleConfirmManualPlayers() {\r\n        const { players } = state.manualEntry;\r\n        if (players.length !== 2 && players.length !== 4) return;\r\n        \r\n        const playerObjects = players.map(name => getPlayerByName(name));\r\n        const gameMode = players.length === 2 ? 'singles' : 'doubles';\r\n        \r\n        // Create a temporary object to mimic a court for the endGame flow\r\n        const manualGameData = {\r\n            players: playerObjects,\r\n            gameMode: gameMode,\r\n            teamsSet: false,\r\n            teams: { team1: [], team2: [] }\r\n        };\r\n\r\n        if (gameMode === 'singles') {\r\n            manualGameData.teamsSet = true;\r\n            manualGameData.teams.team1 = [playerObjects[0]];\r\n            manualGameData.teams.team2 = [playerObjects[1]];\r\n        }\r\n        \r\n        // --- FIX: Ensure both player selection modals are closed ---\r\n        manualEntryModal.classList.add('hidden');\r\n        outsidePlayerModal.classList.add('hidden'); \r\n        // --- END FIX ---\r\n        \r\n        handleEndGame(null, null, manualGameData); // Pass the manual data object\r\n    }\r\n\r\n// REPLACE this function\r\n\r\n    function handleEndGame(courtId, editGameId = null, manualEntryData = null) {\r\n        resetEndGameModal(); \r\n\r\n        let matchModeDetails = { matchMode: '1set', fastPlayGames: 4 };\r\n\r\n        if (manualEntryData) {\r\n            if (manualEntryData.teamsSet) {\r\n                endGameModal.dataset.manualEntry = JSON.stringify(manualEntryData.players.map(p => p.name));\r\n                endGameTimestamp.textContent = `Manual Entry - ${new Date().toLocaleString('en-ZA')}`;\r\n                const team1Names = getPlayerNames(manualEntryData.teams.team1).join(\" & \");\r\n                const team2Names = getPlayerNames(manualEntryData.teams.team2).join(\" & \");\r\n                endGameTeams.innerHTML = `\r\n                    <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\r\n                    <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\r\n                `;\r\n            } else {\r\n                handleChooseTeams(null, 'manual', manualEntryData.players);\r\n                return;\r\n            }\r\n        }\r\n        else if (editGameId) {\r\n            const gameToEdit = state.gameHistory.find(g => g.id == editGameId);\r\n            if (!gameToEdit) return;\r\n            endGameModal.dataset.editGameId = editGameId;\r\n            endGameTimestamp.textContent = `Editing Game from: ${new Date(gameToEdit.endTime).toLocaleString()}`;\r\n            const team1Names = gameToEdit.teams.team1.join(\" & \");\r\n            const team2Names = gameToEdit.teams.team2.join(\" & \");\r\n            endGameTeams.innerHTML = `\r\n                <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\r\n                <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\r\n            `;\r\n        }\r\n        else if (courtId) {\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (!court) return;\r\n            if (court.teamsSet === false) {\r\n                handleChooseTeams(courtId, 'endgame');\r\n                return;\r\n            }\r\n            endGameModal.dataset.courtId = courtId;\r\n            matchModeDetails = { matchMode: court.matchMode, fastPlayGames: court.fastPlayGames };\r\n            const now = new Date();\r\n            endGameTimestamp.textContent = `Completed: ${now.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short' })} at ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;\r\n            const team1Names = getPlayerNames(court.teams.team1).join(\" & \");\r\n            const team2Names = getPlayerNames(court.teams.team2).join(\" & \");\r\n            endGameTeams.innerHTML = `\r\n                <div class=\"team-selection\" data-team=\"team1\"><div><strong>Team 1:</strong> <span>${team1Names}</span></div></div>\r\n                <div class=\"team-selection\" data-team=\"team2\"><div><strong>Team 2:</strong> <span>${team2Names}</span></div></div>\r\n            `;\r\n        }\r\n\r\n        endGameModal.dataset.matchMode = matchModeDetails.matchMode;\r\n        endGameModal.dataset.fastPlayGames = matchModeDetails.fastPlayGames;\r\n\r\n        const skipBtn = document.getElementById('end-game-skip-btn');\r\n        endGameTeams.querySelectorAll('.team-selection').forEach(el => el.addEventListener('click', (e) => {\r\n            const selectedTeam = e.currentTarget.dataset.team;\r\n            endGameModal.dataset.winner = selectedTeam;\r\n            endGameTeams.querySelectorAll('.team-selection').forEach(teamEl => {\r\n                teamEl.classList.toggle('winner', teamEl.dataset.team === selectedTeam);\r\n                teamEl.classList.toggle('loser', teamEl.dataset.team !== selectedTeam);\r\n            });\r\n            scoreSection.classList.remove('hidden');\r\n            skipBtn.textContent = 'Skip Scores';\r\n            skipBtn.dataset.action = 'skip-scores';\r\n            validateEndGameForm();\r\n        }));\r\n        \r\n        // --- THIS IS THE FIX ---\r\n        // Define keypad rules based on the current game's mode\r\n        let winKeypadConfig = {};\r\n        let loseKeypadConfig = {};\r\n\r\n        if (matchModeDetails.matchMode === 'fast') {\r\n            winKeypadConfig = { maxLength: 2, maxValue: matchModeDetails.fastPlayGames };\r\n            loseKeypadConfig = { maxLength: 2, maxValue: matchModeDetails.fastPlayGames - 1 };\r\n        } else { // 1 Set Match logic\r\n            winKeypadConfig = { maxLength: 1, maxValue: 7 };\r\n            loseKeypadConfig = { maxLength: 1, maxValue: 7 };\r\n        }\r\n\r\n        // Dynamically wire up the score inputs to use these specific rules for this session\r\n        wireScoreInputToKeypad(winningScoreInput, winKeypadConfig);\r\n        wireScoreInputToKeypad(losingScoreInput, loseKeypadConfig);\r\n        // --- END OF FIX ---\r\n\r\n        endGameModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    function handleCancelGame(courtId){ \r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Cancellation\"; \r\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to cancel this game? Players will be returned to their original queue positions.\"; \r\n        modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\r\n        modalBtnNo.textContent = \"Close\";      // Standardized Text\r\n        cancelConfirmModal.dataset.mode = \"cancelGame\"; \r\n        cancelConfirmModal.dataset.courtId = courtId; \r\n        cancelConfirmModal.classList.remove(\"hidden\"); \r\n    }\r\n    \r\n    // FIX 1: Add checkAndPlayAlert(false) to trigger re-evaluation after game cancellation\r\n    function executeGameCancellation(){\r\n        const courtId = cancelConfirmModal.dataset.courtId;\r\n        if (!courtId) return;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (court) {\r\n            if(court.autoStartTimer) clearTimeout(court.autoStartTimer);\r\n            \r\n            // --- THIS IS THE FIX ---\r\n            // Instead of re-selecting players, we clear the selection entirely.\r\n            state.selection.players = []; \r\n            state.selection.courtId = null; \r\n            // --- END OF FIX ---\r\n            \r\n            if (court.queueSnapshot) {\r\n                // Restore the available players list to exactly how it was before the game was made.\r\n                state.availablePlayers = court.queueSnapshot;\r\n            } else {\r\n                // Fallback: If for some reason there's no snapshot, return players to the front.\r\n                const playersToRequeue = court.players.filter(p => !p.guest);\r\n                state.availablePlayers = [...playersToRequeue, ...state.availablePlayers];\r\n            }\r\n\r\n            court.becameAvailableAt = Date.now();\r\n            \r\n            court.status = \"available\";\r\n            court.players = [];\r\n            court.teams = {team1:[], team2:[]};\r\n            court.gameMode = null;\r\n            court.autoStartTimer = null;\r\n            court.gameStartTime = null;\r\n            court.queueSnapshot = null;\r\n            court.teamsSet = null;\r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            updateGameModeBasedOnPlayerCount();\r\n            enforceDutyPosition();\r\n            autoAssignCourtModes();         \r\n            render();\r\n            saveState();\r\n            checkAndPlayAlert(false);\r\n\r\n            requestAnimationFrame(() => {\r\n            requestAnimationFrame(ensureCourtSelectionAnimation);\r\n            });\r\n        }\r\n    }\r\n    \r\n    function executePlayerCheckIn(){\r\n        const playerToCheckInName = cancelConfirmModal.dataset.player;\r\n        if (playerToCheckInName) {\r\n            const playerObject = state.clubMembers.find(p => p.name === playerToCheckInName);\r\n            if (playerObject) {\r\n                // Show leaderboard confirmation instead of directly checking in\r\n                leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\r\n                leaderboardConfirmModal.classList.remove('hidden');\r\n                cancelConfirmModal.classList.add('hidden');\r\n                checkInModal.classList.add('hidden');\r\n            }\r\n        }\r\n    }\r\n\r\n    // Helper function to complete the check-in process\r\n// in script.js\r\n\r\n    // Helper function to complete the check-in process\r\n    function finishCheckIn(playerObject) {\r\n        if (!state.availablePlayers.some(p => p.name === playerObject.name)) {\r\n            state.availablePlayers.push(playerObject);\r\n            state.clubMembers = state.clubMembers.filter(p => p.name !== playerObject.name);\r\n        }\r\n\r\n        // Hide the leaderboard/guest modals\r\n        leaderboardConfirmModal.classList.add('hidden');\r\n        guestNameModal.classList.add('hidden');\r\n\r\n        // Repopulate the check-in list with the remaining members\r\n        populateCheckInModal();\r\n        \r\n        // --- THIS IS THE KEY CHANGE ---\r\n        // Re-open the check-in modal instead of going to the main screen\r\n        checkInModal.classList.remove('hidden');\r\n\r\n        // Reset the guest form fields for the next potential entry\r\n        guestNameInput.value = '';\r\n        guestSurnameInput.value = '';\r\n        guestConfirmBtn.disabled = true;\r\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\r\n\r\n        // Update the main application state in the background\r\n        updateGameModeBasedOnPlayerCount();\r\n        autoAssignCourtModes();\r\n        render();\r\n        saveState();\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n    function executePlayerCheckOut(){\r\n        const playerToCheckOutName = cancelConfirmModal.dataset.player;\r\n        if (playerToCheckOutName) {\r\n            // --- THIS IS THE FIX ---\r\n            // Check if the player checking out is the first one in the queue.\r\n            if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerToCheckOutName) {\r\n                // If so, reset the alert timer and count for the next player.\r\n                resetAlertSchedule();\r\n            }\r\n            // --- END OF FIX ---\r\n\r\n            const playerObject = state.availablePlayers.find(p => p.name === playerToCheckOutName);\r\n            if (playerObject) {\r\n                if (playerObject.isJunior) {\r\n                    state.juniorClub.activeChildren = state.juniorClub.active-children.filter(child => child.name !== playerToCheckOutName);\r\n                }\r\n\r\n                if (!playerObject.guest) {\r\n                    state.clubMembers.push(playerObject);\r\n                    state.clubMembers.sort((a, b) => a.name.localeCompare(b.name));\r\n                }\r\n            }\r\n            state.availablePlayers = state.availablePlayers.filter(p => p.name !== playerToCheckOutName);\r\n            \r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            populateCheckOutModal();\r\n            checkOutModal.classList.remove(\"hidden\");\r\n            updateGameModeBasedOnPlayerCount();\r\n            autoAssignCourtModes();\r\n            render();\r\n            saveState();\r\n            // The render() function now triggers the necessary alert checks automatically.\r\n        }\r\n    }\r\n    \r\n// ADD THIS NEW FUNCTION\r\n    function resetEndGameModal() {\r\n        endGameModal.classList.add(\"hidden\");\r\n        // Clear all data attributes\r\n        delete endGameModal.dataset.courtId;\r\n        delete endGameModal.dataset.editGameId;\r\n        delete endGameModal.dataset.winner;\r\n        \r\n        // Clear dynamic content\r\n        endGameTeams.innerHTML = '';\r\n        \r\n        // Hide optional sections\r\n        scoreSection.classList.add('hidden');\r\n        tieBreakerArea.classList.add('hidden');\r\n        \r\n        // Clear input values\r\n        winningScoreInput.value = '';\r\n        losingScoreInput.value = '';\r\n        winnerTiebreakInput.value = '';\r\n        loserTiebreakInput.value = '';\r\n        \r\n        // Reset the confirm button to its default disabled/orange state\r\n        endGameConfirmBtn.disabled = true;\r\n        endGameConfirmBtn.style.backgroundColor = 'var(--inactive-color)';\r\n        endGameConfirmBtn.style.borderColor = 'var(--inactive-color)';\r\n\r\n        // Reset the skip button's text and action\r\n        const skipBtn = document.getElementById('end-game-skip-btn');\r\n        skipBtn.textContent = 'Skip Result';\r\n        skipBtn.dataset.action = 'skip-result';\r\n    }\r\n\r\n\r\n    // REPLACE this function\r\n    function confirmEndGame() {\r\n        const editGameId = endGameModal.dataset.editGameId;\r\n        const manualPlayerNamesJSON = endGameModal.dataset.manualEntry;\r\n        const now = Date.now(); // Get current time once\r\n        const winnerValue = endGameModal.dataset.winner; // Get winner from modal data\r\n\r\n        // --- Score Processing (Common Logic) ---\r\n        let score1 = null, score2 = null, tiebreak1 = null, tiebreak2 = null;\r\n        const finalWinningScore = parseInt(winningScoreInput.value, 10);\r\n        const finalLosingScore = parseInt(losingScoreInput.value, 10);\r\n\r\n        // Only process scores if they are valid numbers\r\n        if (!isNaN(finalWinningScore) && !isNaN(finalLosingScore)) {\r\n            if (winnerValue === 'team1') {\r\n                score1 = finalWinningScore;\r\n                score2 = finalLosingScore;\r\n            } else {\r\n                score1 = finalLosingScore;\r\n                score2 = finalWinningScore;\r\n            }\r\n            // Process tiebreak only if the area is visible and scores are entered\r\n            if (!tieBreakerArea.classList.contains('hidden')) {\r\n                const finalWinnerTiebreak = parseInt(winnerTiebreakInput.value, 10);\r\n                const finalLoserTiebreak = parseInt(loserTiebreakInput.value, 10);\r\n                if (!isNaN(finalWinnerTiebreak) && !isNaN(finalLoserTiebreak)) {\r\n                    if (winnerValue === 'team1') {\r\n                        tiebreak1 = finalWinnerTiebreak;\r\n                        tiebreak2 = finalLoserTiebreak;\r\n                    } else {\r\n                        tiebreak1 = finalLoserTiebreak;\r\n                        tiebreak2 = finalWinnerTiebreak;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // --- End Score Processing ---\r\n\r\n        if (manualPlayerNamesJSON) {\r\n            // --- MANUAL ENTRY LOGIC ---\r\n            const manualPlayerNames = JSON.parse(manualPlayerNamesJSON);\r\n            const team1Selection = endGameTeams.querySelector('.team-selection[data-team=\"team1\"] span').textContent;\r\n            const team2Selection = endGameTeams.querySelector('.team-selection[data-team=\"team2\"] span').textContent;\r\n            // Reconstruct teams based on modal display (handles names with '&')\r\n            const team1NamesManual = team1Selection.split(' & ');\r\n            const team2NamesManual = team2Selection.split(' & ');\r\n\r\n            const manualGame = {\r\n                id: now,\r\n                court: 'Manual', // Indicate it's a manual entry\r\n                startTime: now - (1 * 60 * 60 * 1000), // Estimate start time (e.g., 1 hour ago)\r\n                endTime: now,\r\n                duration: '01h00m', // Default duration\r\n                teams: { team1: team1NamesManual, team2: team2NamesManual },\r\n                // Include score object only if scores were entered\r\n                score: (score1 !== null && score2 !== null) ? { team1: score1, team2: score2, tiebreak1: tiebreak1, tiebreak2: tiebreak2 } : null,\r\n                winner: winnerValue\r\n            };\r\n            state.gameHistory.push(manualGame);\r\n            // Clear manual entry state\r\n            state.manualEntry.players = [];\r\n            delete endGameModal.dataset.manualEntry; // Clean up dataset\r\n\r\n            // --- FIX: Close end game modal and SHOW history ---\r\n            endGameModal.classList.add(\"hidden\");\r\n            historyPage.classList.remove(\"hidden\"); // Re-show history\r\n            renderGameHistory(); // Re-render history list\r\n            saveState();\r\n            resetEndGameModal();\r\n            // --- END FIX ---\r\n\r\n            return; // Exit after handling manual entry\r\n\r\n        } else if (editGameId) {\r\n            // --- EDIT GAME LOGIC ---\r\n            const gameIndex = state.gameHistory.findIndex(g => g.id == editGameId);\r\n            if (gameIndex > -1) {\r\n                state.gameHistory[gameIndex].winner = winnerValue;\r\n                // Update score only if valid scores were entered\r\n                if (score1 !== null && score2 !== null) {\r\n                    state.gameHistory[gameIndex].score = { team1: score1, team2: score2, tiebreak1: tiebreak1, tiebreak2: tiebreak2 };\r\n                } else {\r\n                    state.gameHistory[gameIndex].score = null; // Clear score if invalid/skipped\r\n                }\r\n            }\r\n            delete endGameModal.dataset.editGameId; // Clean up dataset\r\n            endGameModal.classList.add(\"hidden\");\r\n            historyPage.classList.remove(\"hidden\"); // Re-show history\r\n            renderGameHistory(); // Re-render history list\r\n            saveState();\r\n            resetEndGameModal();\r\n            return; // Exit after handling edit\r\n\r\n        } else {\r\n            // --- REGULAR GAME END LOGIC ---\r\n            const courtId = endGameModal.dataset.courtId;\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (!court) return;\r\n\r\n            const team1Names = getPlayerNames(court.teams.team1);\r\n            const team2Names = getPlayerNames(court.teams.team2);\r\n            const newGame = {\r\n                id: now,\r\n                court: court.id,\r\n                startTime: court.gameStartTime,\r\n                endTime: now,\r\n                duration: document.getElementById(`timer-${court.id}`).textContent,\r\n                teams: { team1: team1Names, team2: team2Names },\r\n                // Include score object only if scores were entered\r\n                score: (score1 !== null && score2 !== null) ? { team1: score1, team2: score2, tiebreak1: tiebreak1, tiebreak2: tiebreak2 } : null,\r\n                winner: winnerValue\r\n            };\r\n            state.gameHistory.push(newGame);\r\n\r\n            const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\r\n            const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\r\n            const playersToRequeue = [...winningPlayers, ...losingPlayers].filter(p => !p.guest);\r\n\r\n            state.availablePlayers.push(...playersToRequeue);\r\n            court.becameAvailableAt = now;\r\n\r\n            // Grace period check logic remains the same...\r\n            const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\r\n            if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\r\n                // Find court ID *after* resetting current one (but before calling resetCourtAfterGame)\r\n                const tempAvailableCourtId = findNextAvailableCourtIdAfterReset(courtId);\r\n                const firstPlayerFullName = getFirstAvailablePlayerNameAfterRequeue(playersToRequeue); // Get name *after* adding players back\r\n                const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\r\n                if (firstPlayerPronounceableName) {\r\n                    const openCourtMessage = tempAvailableCourtId\r\n                        ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(tempAvailableCourtId)} is available.`\r\n                        : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\r\n                    playAlertSound(openCourtMessage);\r\n                }\r\n            } else {\r\n                console.log(\"Skipped game end announcement due to grace period.\");\r\n            }\r\n\r\n            resetCourtAfterGame(courtId); // This calls render() and saveState()\r\n            resetEndGameModal();\r\n        }\r\n    }\r\n\r\n    // --- NEW HELPER FUNCTIONS FOR GRACE PERIOD ---\r\n    // Finds the next available court *assuming* the current court (courtIdToReset) is reset\r\n    function findNextAvailableCourtIdAfterReset(courtIdToReset) {\r\n        for (const id of COURT_HIERARCHY) {\r\n            const court = state.courts.find(c => c.id === id);\r\n            if (court && state.courtSettings.visibleCourts.includes(id)) {\r\n                // Consider the court being reset as available, or check its actual status\r\n                if (id === courtIdToReset || court.status === 'available') {\r\n                    return id;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Finds the first available player *assuming* the playersToRequeue have been added\r\n    function getFirstAvailablePlayerNameAfterRequeue(playersToRequeue) {\r\n        // Simulate adding players to the end for the check\r\n        const simulatedAvailablePlayers = [...state.availablePlayers, ...playersToRequeue];\r\n        const selectorPlayer = simulatedAvailablePlayers.find(p => !p.isPaused);\r\n        return selectorPlayer ? selectorPlayer.name : null;\r\n    }\r\n    // --- END NEW HELPER FUNCTIONS ---\r\n\r\n    // REPLACE this function\r\n    function confirmSkipResult() {\r\n        const courtId = endGameModal.dataset.courtId;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court) return;\r\n        const now = Date.now(); // Get current time\r\n\r\n        // ... (game history logging remains the same) ...\r\n        const team1Names = getPlayerNames(court.teams.team1);\r\n        const team2Names = getPlayerNames(court.teams.team2);\r\n        const newGame = {\r\n            id: now, // Use 'now'\r\n            court: court.id,\r\n            startTime: court.gameStartTime,\r\n            endTime: now, // Use 'now'\r\n            duration: document.getElementById(`timer-${court.id}`).textContent,\r\n            teams: { team1: team1Names, team2: team2Names },\r\n            score: null,\r\n            winner: 'skipped'\r\n        };\r\n        state.gameHistory.push(newGame);\r\n        // ... (rest of history logging) ...\r\n\r\n        const playersToRequeue = [...court.players].filter(p => !p.guest);\r\n        state.availablePlayers.push(...playersToRequeue);\r\n\r\n        // --- GRACE PERIOD CHECK ---\r\n        const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\r\n        if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\r\n            const nextAvailableCourtId = findNextAvailableCourtId(); // Find court ID *after* resetting current one\r\n            const firstPlayerFullName = getFirstAvailablePlayerName(); // Get name *after* requeuing\r\n            const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\r\n            if (firstPlayerPronounceableName) {\r\n                const openCourtMessage = nextAvailableCourtId\r\n                    ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(nextAvailableCourtId)} is available.`\r\n                    : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\r\n                playAlertSound(openCourtMessage);\r\n            }\r\n        } else {\r\n            console.log(\"Skipped skip result announcement due to grace period.\");\r\n        }\r\n        // --- END GRACE PERIOD CHECK ---\r\n\r\n        resetCourtAfterGame(court.id); // This calls render() and saveState()\r\n        endGameModal.classList.add(\"hidden\");\r\n        // checkAndPlayAlert(false); // No longer needed here, resetCourtAfterGame handles it\r\n    }\r\n\r\n    // REPLACE this function\r\n    function confirmSkipScores() {\r\n        const courtId = endGameModal.dataset.courtId;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        const winnerValue = endGameModal.dataset.winner;\r\n        if (!court || !winnerValue) return;\r\n        const now = Date.now(); // Get current time\r\n\r\n        // ... (game history logging remains the same) ...\r\n        const team1Names = getPlayerNames(court.teams.team1);\r\n        const team2Names = getPlayerNames(court.teams.team2);\r\n        const newGame = {\r\n            id: now, // Use 'now'\r\n            court: court.id,\r\n            startTime: court.gameStartTime,\r\n            endTime: now, // Use 'now'\r\n            duration: document.getElementById(`timer-${court.id}`).textContent,\r\n            teams: { team1: team1Names, team2: team2Names },\r\n            score: null,\r\n            winner: winnerValue\r\n        };\r\n        state.gameHistory.push(newGame);\r\n        // ... (rest of history logging) ...\r\n\r\n        const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\r\n        const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\r\n        const playersToRequeue = [...winningPlayers, ...losingPlayers].filter(p => !p.guest);\r\n        state.availablePlayers.push(...playersToRequeue);\r\n\r\n        // --- GRACE PERIOD CHECK ---\r\n        const timeUntilNextAlert = alertScheduleTime > 0 ? alertScheduleTime - now : Infinity;\r\n        if (timeUntilNextAlert > ANNOUNCEMENT_GRACE_PERIOD_MS) {\r\n            const nextAvailableCourtId = findNextAvailableCourtId(); // Find court ID *after* resetting current one\r\n            const firstPlayerFullName = getFirstAvailablePlayerName(); // Get name *after* requeuing\r\n            const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName);\r\n            if (firstPlayerPronounceableName) {\r\n                const openCourtMessage = nextAvailableCourtId\r\n                    ? `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formatCourtIdForTTS(nextAvailableCourtId)} is available.`\r\n                    : `Attention, ${firstPlayerPronounceableName}. Please come and select your match. A court is now available.`;\r\n                playAlertSound(openCourtMessage);\r\n            }\r\n        } else {\r\n             console.log(\"Skipped skip scores announcement due to grace period.\");\r\n        }\r\n        // --- END GRACE PERIOD CHECK ---\r\n\r\n        resetCourtAfterGame(court.id); // This calls render() and saveState()\r\n        endGameModal.classList.add(\"hidden\");\r\n        // checkAndPlayAlert(false); // No longer needed here, resetCourtAfterGame handles it\r\n    }\r\n\r\n    function checkAndShowTieBreak() {\r\n        const matchMode = endGameModal.dataset.matchMode || '1set';\r\n\r\n        // --- THIS IS THE FIX ---\r\n        // Never show tie-break for Fast Play mode\r\n        if (matchMode === 'fast') {\r\n            tieBreakerArea.classList.add('hidden');\r\n            winnerTiebreakInput.value = '';\r\n            loserTiebreakInput.value = '';\r\n            return;\r\n        }\r\n        // --- END OF FIX ---\r\n\r\n        const winScore = parseInt(winningScoreInput.value, 10);\r\n        const loseScore = parseInt(losingScoreInput.value, 10);\r\n        if (winScore === 7 && loseScore === 6) {\r\n            tieBreakerArea.classList.remove('hidden');\r\n        } else {\r\n            tieBreakerArea.classList.add('hidden');\r\n            winnerTiebreakInput.value = '';\r\n            loserTiebreakInput.value = '';\r\n        }\r\n    }\r\n\r\n    // NOTE: Score validation logic is correct for standard tennis rules (6-0 to 6-4, 7-5, 7-6 + tiebreak).\r\n    function validateEndGameForm(){\r\n        const winnerSelected = !!endGameModal.dataset.winner;\r\n        if (!winnerSelected) {\r\n            endGameConfirmBtn.disabled = true;\r\n            return;\r\n        }\r\n\r\n        const matchMode = endGameModal.dataset.matchMode || '1set'; // Get match mode\r\n        const fastPlayGames = parseInt(endGameModal.dataset.fastPlayGames, 10) || 4; // Get fast play games\r\n\r\n        const winScoreVal = winningScoreInput.value;\r\n        const loseScoreVal = losingScoreInput.value;\r\n        const winScore = parseInt(winScoreVal, 10);\r\n        const loseScore = parseInt(loseScoreVal, 10);\r\n        let scoresValid = false;\r\n        if (winScoreVal !== '' && loseScoreVal !== '') {\r\n            if (matchMode === 'fast') {\r\n                if (winScore === fastPlayGames && loseScore < fastPlayGames) {\r\n                    scoresValid = true;\r\n                }\r\n            } else { // 1set or 3set logic\r\n                if (winScore === 6 && loseScore >= 0 && loseScore <= 4) scoresValid = true;\r\n                if (winScore === 7 && loseScore === 5) scoresValid = true;\r\n                if (winScore === 7 && loseScore === 6) scoresValid = true;\r\n            }\r\n        }\r\n        if (!scoresValid) {\r\n            endGameConfirmBtn.disabled = true;\r\n            endGameConfirmBtn.style.backgroundColor = 'var(--inactive-color)';\r\n            endGameConfirmBtn.style.borderColor = 'var(--inactive-color)';\r\n            return;\r\n        }\r\n        let tiebreakValid = true;\r\n        if (!tieBreakerArea.classList.contains('hidden')) {\r\n            const tbWinnerVal = winnerTiebreakInput.value;\r\n            const tbLoserVal = loserTiebreakInput.value;\r\n            if (tbWinnerVal === '' || tbLoserVal === '') {\r\n                tiebreakValid = false;\r\n            } else {\r\n                const numTbWinner = parseInt(tbWinnerVal, 10);\r\n                const numTbLoser = parseInt(tbLoserVal, 10);\r\n                tiebreakValid = (numTbWinner >= 7 && (numTbWinner - numTbLoser) >= 2) || (numTbLoser >= 7 && (numTbLoser - numTbWinner) >= 2);\r\n            }\r\n        }\r\n        const isReady = winnerSelected && scoresValid && tiebreakValid;\r\n        endGameConfirmBtn.disabled = !isReady;\r\n        endGameConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n        endGameConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n\r\n    /**\r\n     * Converts a single-letter court ID to a phonetic spelling for clearer TTS.\r\n     * @param {string} courtId The court ID (e.g., 'A', 'B').\r\n     * @returns {string} The phonetic spelling (e.g., 'AYY', 'Bee').\r\n     */\r\n    function formatCourtIdForTTS(courtId) {\r\n        if (!courtId) return '';\r\n        switch (courtId.toUpperCase()) {\r\n            case 'A': return 'AYY';\r\n            case 'B': return 'Bee';\r\n            case 'C': return 'See';\r\n            case 'D': return 'Dee';\r\n            case 'E': return 'EE';\r\n            default: return courtId; // Fallback for any other court names\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Helper to configure a SpeechSynthesisUtterance object with voice settings.\r\n     * @param {string} message The message for the utterance.\r\n     * @returns {SpeechSynthesisUtterance|null} Configured utterance object or null if not supported.\r\n     */\r\n    function getUtterance(message) {\r\n        if (!('speechSynthesis' in window)) return null;\r\n\r\n        const utterance = new SpeechSynthesisUtterance(message);\r\n        \r\n        // TTS VOICE SELECTION (Prioritizing clear English, checking for SA English)\r\n        const voices = window.speechSynthesis.getVoices();\r\n        // THIS IS THE LINE THAT SELECTS THE en-ZA VOICE\r\n        let preferredVoice = voices.find(voice => voice.lang === 'en-ZA');\r\n\r\n        // This part is a fallback in case an en-ZA voice is not found\r\n        if (!preferredVoice) {\r\n            preferredVoice = voices.find(voice => voice.lang.startsWith('en-') && voice.name.includes('Google'));\r\n        }\r\n        \r\n        if (preferredVoice) {\r\n            utterance.voice = preferredVoice;\r\n        }\r\n        utterance.rate = 0.85;\r\n        utterance.pitch = 0.95;\r\n        \r\n        return utterance;\r\n    }\r\n\r\n\r\n    /**\r\n     * Executes the Text-to-Speech call for a single, independent message.\r\n     * This function immediately cancels any existing speech before speaking.\r\n     * @param {string} message The message to be spoken.\r\n     */\r\n    function playCustomTTS(message) {\r\n         // NEW: Check if all notifications are muted OR if TTS is disabled\r\n         if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\r\n\r\n         const utterance = getUtterance(message);\r\n         if (utterance) {\r\n             // Ensure no pending TTS is running before starting the new one\r\n             if (window.speechSynthesis.speaking) {\r\n                 window.speechSynthesis.cancel();\r\n             }\r\n             window.speechSynthesis.speak(utterance);\r\n         }\r\n    }\r\n\r\n    /**\r\n     * Calculates the age of a person in full years from a date string (YYYY-MM-DD).\r\n     * @param {string} dateString The birth date in 'YYYY-MM-DD' format.\r\n     * @returns {number|null} The age in years, or null if the date is invalid.\r\n     */\r\n    function calculateAge(dateString) {\r\n        if (!dateString) return null;\r\n        const today = new Date();\r\n        const birthDate = new Date(dateString);\r\n\r\n        if (isNaN(birthDate)) return null;\r\n\r\n        let age = today.getFullYear() - birthDate.getFullYear();\r\n        const m = today.getMonth() - birthDate.getMonth();\r\n\r\n        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {\r\n            age--;\r\n        }\r\n        return age;\r\n    }\r\n\r\n    \r\n    // NEW FUNCTION: Function that handles the actual sound + TTS sequence for a single item\r\n    function _playAnnouncementSequence(item, callback) {\r\n        isAnnouncementPlaying = true;\r\n        const { msg1, msg2, soundFile } = item;\r\n        \r\n        const playSequencedTTS = (msg1, msg2, onDone) => {\r\n            if (state.notificationControls.isTTSDisabled) return onDone();\r\n\r\n            if (!msg1 && !msg2) return onDone();\r\n\r\n            const utterance1 = getUtterance(msg1 || msg2); \r\n            if (!utterance1) return onDone();\r\n\r\n            utterance1.onend = () => {\r\n                if (msg1 && msg2) {\r\n                    const utterance2 = getUtterance(msg2);\r\n                    if (utterance2) {\r\n                        utterance2.onend = onDone; // Call final callback after the second message\r\n                        window.speechSynthesis.speak(utterance2);\r\n                    } else {\r\n                        onDone();\r\n                    }\r\n                } else {\r\n                    onDone(); // Done after the first message\r\n                }\r\n            };\r\n\r\n            // Ensure no pending TTS is running before starting the new sequence.\r\n            if (window.speechSynthesis.speaking) {\r\n                window.speechSynthesis.cancel();\r\n            }\r\n            window.speechSynthesis.speak(utterance1);\r\n        };\r\n\r\n        if (state.notificationControls.isTTSDisabled) {\r\n            // If TTS is disabled, we only worry about the audio playing, then call back.\r\n            if (!soundFile) return callback();\r\n        }\r\n        \r\n        // Stop previous sound\r\n        if (currentAudio) {\r\n            currentAudio.pause();\r\n            currentAudio.currentTime = 0;\r\n        }\r\n\r\n        // CRITICAL FIX: Cancel any existing speech NOW before starting audio/TTS.\r\n        if (window.speechSynthesis.speaking) {\r\n            window.speechSynthesis.cancel();\r\n        }\r\n        \r\n        if (!soundFile) {\r\n            playSequencedTTS(msg1, msg2, callback);\r\n            return;\r\n        }\r\n\r\n        // NEW LOGIC: If a sound is about to play for this item, suppress the sound\r\n        // for all subsequent announcements currently waiting in the queue.\r\n        announcementQueue.forEach(queuedItem => {\r\n            queuedItem.soundFile = null;\r\n        });\r\n\r\n        const audioPath = `source/${soundFile}`;\r\n        currentAudio = new Audio(audioPath);\r\n        \r\n        // Wait for sound to finish, then start TTS sequence\r\n        currentAudio.addEventListener('playing', function onSoundPlaying() {\r\n            currentAudio.removeEventListener('playing', onSoundPlaying);\r\n            \r\n            currentAudio.addEventListener('ended', function onSoundEnd() {\r\n                currentAudio.removeEventListener('ended', onSoundEnd);\r\n                // Play sequenced TTS, passing the main callback as the final onDone\r\n                playSequencedTTS(msg1, msg2, callback); \r\n            });\r\n        });\r\n\r\n        currentAudio.play().catch(error => {\r\n            console.error(`Error playing alert sound ${audioPath}: `, error);\r\n            // Fallback: Play sequenced TTS immediately if sound fails\r\n            playSequencedTTS(msg1, msg2, callback);\r\n        });\r\n    }\r\n\r\n    // NEW FUNCTION: Function that processes the queue\r\n    function processAnnouncementQueue() {\r\n        if (isAnnouncementPlaying && announcementQueue.length === 0) {\r\n            isAnnouncementPlaying = false;\r\n            return;\r\n        }\r\n        if (announcementQueue.length === 0) {\r\n            return;\r\n        }\r\n\r\n        if (!isAnnouncementPlaying) {\r\n            isAnnouncementPlaying = true;\r\n            \r\n            const firstItem = announcementQueue[0];\r\n            \r\n            if (!firstItem.soundFile) {\r\n                announcementQueue.unshift({\r\n                    msg1: null,\r\n                    msg2: null,\r\n                    soundFile: state.selectedAlertSound \r\n                });\r\n            } \r\n        }\r\n\r\n        const nextItem = announcementQueue.shift();\r\n        \r\n        _playAnnouncementSequence(nextItem, processAnnouncementQueue);\r\n    }\r\n\r\n    // PUBLIC INTERFACE (Replaces old playAlertSound)\r\n    function playAlertSound(courtMessage = null, dutyMessage = null, soundFileNameOverride = null) {\r\n        \r\n        // Check if all notifications are muted\r\n        if (state.notificationControls.isMuted) return; \r\n\r\n        // 1. Add the new announcement to the queue\r\n        announcementQueue.push({\r\n            msg1: courtMessage,\r\n            msg2: dutyMessage,\r\n            // CRITICAL: Standard alerts are now TTS-only. Sound is only included if it is an OVERRIDE (e.g., CommitteeCall)\r\n            soundFile: soundFileNameOverride || null\r\n        });\r\n\r\n        // 2. Start the queue processor if it's not already running\r\n        if (!isAnnouncementPlaying) {\r\n            processAnnouncementQueue();\r\n        }\r\n    }\r\n\r\n    // PUBLIC INTERFACE (Replaces old playCustomTTS)\r\n    function playCustomTTS(message) {\r\n        // Check if all notifications are muted OR if TTS is disabled\r\n        if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\r\n\r\n        const utterance = getUtterance(message);\r\n        if (utterance) {\r\n            // Push to queue with no sound and no second message, preserving the null sound file for TTS-only announcements\r\n            playAlertSound(message, null, null);\r\n        }\r\n    }\r\n\r\n    // NEW HELPER FUNCTION: Finds the name of the first available, non-paused player\r\n    function getFirstAvailablePlayerName() {\r\n        const selectorPlayer = state.availablePlayers.find(p => !p.isPaused);\r\n        return selectorPlayer ? selectorPlayer.name : null;\r\n    }\r\n\r\n    // UPDATED FUNCTION: Logic maintains alertScheduleTime unless overridden or conditions are missed.\r\n    // @param {boolean} forceCheck - If true, triggers the alert/sound/TTS immediately and resets the timer.\r\n    function checkAndPlayAlert(forceCheck = false) {\r\n        const availablePlayerCount = state.availablePlayers.length;\r\n        const TWO_MINUTES_MS = 2 * 60 * 1000;\r\n        const FIVE_MINUTES_MS = 5 * 60 * 1000;\r\n        const now = Date.now();\r\n\r\n        const hasEnoughPlayers = availablePlayerCount >= 4;\r\n        const availableCourtId = findNextAvailableCourtId();\r\n        const conditionMet = hasEnoughPlayers && availableCourtId;\r\n        const firstPlayerFullName = getFirstAvailablePlayerName(); // Get the full name first\r\n\r\n        if (!conditionMet || !firstPlayerFullName) {\r\n            resetAlertSchedule();\r\n            return;\r\n        }\r\n\r\n        const firstPlayerPronounceableName = getPronounceableName(firstPlayerFullName); // Get pronounceable name\r\n        const formattedCourtId = formatCourtIdForTTS(availableCourtId);\r\n        // Use pronounceable name in the message\r\n        let standardMessage = `Attention, ${firstPlayerPronounceableName}. Please come and select your match. Court ${formattedCourtId} is available.`;\r\n\r\n        if (forceCheck) {\r\n            playAlertSound(standardMessage);\r\n            return;\r\n        }\r\n\r\n        if (alertState === 'initial_check') {\r\n            const firstInterval = state.notificationControls.isMinimized ? TWO_MINUTES_MS : FIVE_MINUTES_MS;\r\n            alertScheduleTime = now + firstInterval;\r\n            alertState = '2_min_countdown';\r\n            state.currentAlertCount = 1;\r\n            return;\r\n        }\r\n\r\n        if (now >= alertScheduleTime) {\r\n            if (state.currentAlertCount >= 2) {\r\n            // Find the index of the first active (not paused) player. This is our target.\r\n            const playerToMoveIndex = state.availablePlayers.findIndex(p => !p.isPaused);\r\n\r\n            if (playerToMoveIndex !== -1 && state.availablePlayers.length > 1) {\r\n                // Remove that specific player from their current position in the array.\r\n                const [playerToMove] = state.availablePlayers.splice(playerToMoveIndex, 1);\r\n\r\n                // --- THIS IS THE FIX ---\r\n                // We want to insert them at position #9.\r\n                // We calculate how many paused players are \"in front of\" our target insertion point.\r\n                const targetPosition = 8;\r\n                const pausedPlayersBeforeTarget = state.availablePlayers.slice(0, targetPosition).filter(p => p.isPaused).length;\r\n\r\n                // The actual index in the array is the target position plus the number of paused players.\r\n                const insertionIndex = Math.min(targetPosition + pausedPlayersBeforeTarget, state.availablePlayers.length);\r\n                // --- END OF FIX ---\r\n\r\n                state.availablePlayers.splice(insertionIndex, 0, playerToMove);\r\n\r\n                enforceQueueLogic(); // Re-apply all queue rules after the move\r\n\r\n                // Clear any stored suggestion since the selector has changed\r\n                state.currentSuggestionOutcome = null;\r\n                state.currentSuggestionType = null;\r\n                if (state.activeSuggestion) {\r\n                    clearSuggestionHighlights();\r\n                }\r\n\r\n                const newFirstPlayerFullName = getFirstAvailablePlayerName();\r\n                // Use pronounceable names in the swap message\r\n                const playerToMovePronounceable = getPronounceableName(playerToMove.name);\r\n                const newFirstPlayerPronounceable = getPronounceableName(newFirstPlayerFullName);\r\n                const swapMessage = `${playerToMovePronounceable} has been moved down. ${newFirstPlayerPronounceable}, please select your match on court ${formattedCourtId}.`;\r\n\r\n                playAlertSound(swapMessage);\r\n                render();\r\n                saveState();\r\n                resetAlertSchedule();\r\n                return;\r\n            }\r\n\r\n            // --- END OF FIX ---\r\n        }\r\n\r\n            // --- THIS IS THE FIX ---\r\n            // If this is the second alert (count is 1 before increment), add the \"last call\" message.\r\n            if (state.currentAlertCount === 1) {\r\n                standardMessage += \" This is your last call.\";\r\n            }\r\n            // --- END OF FIX ---\r\n\r\n            playAlertSound(standardMessage);\r\n            state.currentAlertCount++;\r\n\r\n            const nextInterval = state.notificationControls.isMinimized ? TWO_MINUTES_MS : FIVE_MINUTES_MS;\r\n            alertScheduleTime = now + nextInterval;\r\n            alertState = '5_min_repeat';\r\n        }\r\n    }\r\n\r\n\r\n\r\n    function initQuoteRotator() { \r\n        const quoteTextEl = document.getElementById('quote-text'); \r\n        if (!quoteTextEl || quoteTextEl.dataset.initialized === 'true') return; \r\n\r\n        quoteTextEl.textContent = `\"${state.tennisQuotes[state.currentQuoteIndex]}\"`; \r\n        \r\n        // Only set the interval once\r\n        if (!window.quoteInterval) {\r\n            window.quoteInterval = setInterval(() => { \r\n                quoteTextEl.classList.add('fading'); \r\n                setTimeout(() => { \r\n                    state.currentQuoteIndex = (state.currentQuoteIndex + 1) % state.tennisQuotes.length; \r\n                    // Ensure element exists before updating, as it might be destroyed during a render cycle\r\n                    const currentQuoteEl = document.getElementById('quote-text');\r\n                    if (currentQuoteEl) {\r\n                        currentQuoteEl.textContent = `\"${state.tennisQuotes[state.currentQuoteIndex]}\"`; \r\n                        currentQuoteEl.classList.remove('fading');\r\n                    }\r\n                }, 1000); \r\n            }, 12000); \r\n        }\r\n        quoteTextEl.dataset.initialized = 'true';\r\n    }\r\n\r\n// REPLACE this function\r\n    function getAdminPasscode() {\r\n        const today = new Date();\r\n        const dayOfMonth = String(today.getDate()).padStart(2, '0');\r\n        return `${ADMIN_PIN_BASE}${dayOfMonth}`;\r\n    }\r\n\r\n// REPLACE this function\r\n    function handleAdminLogin() {\r\n        if (adminSessionActive) {\r\n            // If session is active, PAUSE the timer by clearing it.\r\n            if (adminSessionTimer) {\r\n                clearTimeout(adminSessionTimer);\r\n                adminSessionTimer = null;\r\n            }\r\n            showAdminModal(); // And go directly to the modal\r\n            return;\r\n        }\r\n\r\n        // If no session is active, prompt for the PIN using the original admin keypad\r\n        showKeypad(null, { mode: 'admin', maxLength: 6, title: 'Enter Admin Passcode' });\r\n    }\r\n\r\n// REPLACE this function\r\n    function checkAdminPasscode() {\r\n        const enteredCode = keypadDisplay.dataset.hiddenValue;\r\n        const expectedCode = getAdminPasscode();\r\n\r\n        if (enteredCode === expectedCode) {\r\n            hideKeypad();\r\n            adminSessionActive = true;\r\n            \r\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\r\n            adminSessionTimer = setTimeout(() => {\r\n                adminSessionActive = false;\r\n                adminSessionTimer = null;\r\n                state.courts.forEach(c => c.isModeOverlayActive = false);\r\n                render();\r\n                playAlertSound(null, null, 'Alert7.mp3');\r\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\r\n            }, 60000); // 1 minute\r\n\r\n            showAdminModal();\r\n\r\n        } else {\r\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\r\n            keypadContent.classList.add('shake');\r\n            setTimeout(() => {\r\n                keypadContent.classList.remove('shake');\r\n                keypadDisplay.textContent = '';\r\n                if (keypadDisplay.dataset.hiddenValue) {\r\n                    keypadDisplay.dataset.hiddenValue = '';\r\n                }\r\n                if(activeInput) activeInput.value = '';\r\n                keypadConfirmBtn.disabled = true;\r\n            }, 820);\r\n        }\r\n    }\r\n\r\n    function checkUndoPasscode() {\r\n        const enteredPin = keypadDisplay.dataset.hiddenValue || '';\r\n        const actionIndex = parseInt(customKeypadModal.dataset.undoActionIndex);\r\n        \r\n        // Get the correct PIN (0308 + DD)\r\n        const correctPin = getAdminPasscode();\r\n        \r\n        console.log('=== UNDO PIN CHECK ===');\r\n        console.log('Entered PIN:', enteredPin);\r\n        console.log('Correct PIN:', correctPin);\r\n        console.log('Match:', enteredPin === correctPin);\r\n        \r\n        if (enteredPin === correctPin) {\r\n            hideKeypad();\r\n            executeUndoAction(actionIndex);\r\n            delete customKeypadModal.dataset.undoActionIndex;\r\n            delete customKeypadModal.dataset.undoActionDescription;\r\n        } else {\r\n            // Shake animation instead of alert\r\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\r\n            keypadContent.classList.add('shake');\r\n            \r\n            // Clear the display\r\n            keypadDisplay.textContent = '';\r\n            delete keypadDisplay.dataset.hiddenValue;\r\n            keypadConfirmBtn.disabled = true;\r\n            \r\n            // Remove shake class after animation completes\r\n            setTimeout(() => {\r\n                keypadContent.classList.remove('shake');\r\n            }, 820);\r\n        }\r\n    } \r\n\r\n// ADD THIS NEW FUNCTION\r\n    function showCourtModeKeypad() {\r\n        courtModeKeypadDisplay.textContent = '';\r\n        delete courtModeKeypadDisplay.dataset.hiddenValue;\r\n        courtModeKeypadConfirmBtn.disabled = true;\r\n        courtModeKeypadModal.classList.remove('hidden');\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function hideCourtModeKeypad() {\r\n        courtModeKeypadModal.classList.add('hidden');\r\n        courtModeAction = null; // Clear the stored action\r\n    }\r\n\r\n    // ADD THIS NEW FUNCTION\r\n    function checkCourtModePasscode() {\r\n        const enteredCode = courtModeKeypadDisplay.dataset.hiddenValue;\r\n        const expectedCode = getAdminPasscode();\r\n\r\n        if (enteredCode === expectedCode) {\r\n            hideCourtModeKeypad();\r\n            adminSessionActive = true;\r\n\r\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\r\n            adminSessionTimer = setTimeout(() => {\r\n                adminSessionActive = false;\r\n                adminSessionTimer = null;\r\n                state.courts.forEach(c => c.isModeOverlayActive = false);\r\n                render();\r\n                playAlertSound(null, null, 'Alert7.mp3');\r\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\r\n            }, 60000); // 1 minute\r\n\r\n            if (courtModeAction) {\r\n                courtModeAction();\r\n            }\r\n\r\n        } else {\r\n            const keypadContent = courtModeKeypadModal.querySelector('.keypad-content');\r\n            keypadContent.classList.add('shake');\r\n            setTimeout(() => {\r\n                keypadContent.classList.remove('shake');\r\n                courtModeKeypadDisplay.textContent = '';\r\n                if (courtModeKeypadDisplay.dataset.hiddenValue) {\r\n                    courtModeKeypadDisplay.dataset.hiddenValue = '';\r\n                }\r\n                courtModeKeypadConfirmBtn.disabled = true;\r\n            }, 820);\r\n        }\r\n    }\r\n\r\n    function runAutoMinimizeLogic() {\r\n        if (!state.notificationControls.autoMinimize) {\r\n            return; // Do nothing if the feature is turned off\r\n        }\r\n\r\n        // 1. Count only the courts available for social play (not reserved for league or turned off)\r\n        const socialCourts = state.courts.filter(c =>\r\n            state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league'\r\n        );\r\n        const socialCourtCount = socialCourts.length;\r\n\r\n        // 2. Get the total number of players currently at the club\r\n        const totalPlayerCount = totalPlayersAtClub();\r\n\r\n        // 3. Define the threshold based on the available social courts\r\n        // This is the max capacity of social courts for doubles, plus a waiting queue of 4.\r\n        const minimizeThreshold = (socialCourtCount * 4) + 4;\r\n\r\n\r\n        // 4. Apply the new logic\r\n        // Condition for quick turnaround (2-minute timer):\r\n        if (totalPlayerCount >= minimizeThreshold) {\r\n            if (!state.notificationControls.isMinimized) {\r\n                state.notificationControls.isMinimized = true;\r\n                // --- THIS IS THE FIX ---\r\n                if (!state.matchSettings.autoMatchModes) {\r\n                    playCustomTTS(\"Switching to 2-minute alerts.\");\r\n                }\r\n                // --- END OF FIX ---\r\n                updateNotificationIcons();\r\n                saveState();\r\n            }\r\n        }\r\n        // Condition for relaxed turnaround (5-minute timer):\r\n        else {\r\n            if (state.notificationControls.isMinimized) {\r\n                state.notificationControls.isMinimized = false;\r\n                if (!state.matchSettings.autoMatchModes) {\r\n                    playCustomTTS(\"Switching to 5-minute alerts.\");\r\n                }\r\n                updateNotificationIcons();\r\n                saveState();\r\n            }\r\n        }\r\n    }\r\n    \r\n    function handleNotifyNow() {\r\n        const availablePlayerCount = state.availablePlayers.length;\r\n        const hasEnoughPlayers = availablePlayerCount >= 4;\r\n        const isAnyCourtAvailable = findNextAvailableCourtId();\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Announcement\";\r\n        modalBtnYesConfirm.textContent = \"Confirm\";\r\n        modalBtnNo.textContent = \"Close\";\r\n\r\n        if (!hasEnoughPlayers) {\r\n            cancelConfirmModal.querySelector(\"p\").textContent = \"There are not enough players for a doubles match. Announce to waiting players?\";\r\n            cancelConfirmModal.dataset.mode = \"forceAnnouncementNotEnoughPlayers\";\r\n            cancelConfirmModal.classList.remove(\"hidden\");\r\n            return;\r\n        }\r\n\r\n        if (!isAnyCourtAvailable) {\r\n            // This is a hard stop, so a simple alert is appropriate.\r\n            alert(\"Notification cannot be sent: No courts are available.\");\r\n            return;\r\n        }\r\n\r\n        // This is the standard case where everything is ready.\r\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to force a player announcement now?\";\r\n        cancelConfirmModal.dataset.mode = \"forceAnnouncement\";\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    function initSummaryCardElements() {\r\n        // 1. Re-bind the settings button listener\r\n        const settingsBtn = document.getElementById('settings-btn');\r\n        if (settingsBtn) {\r\n            settingsBtn.removeEventListener('click', handleAdminLogin); // Prevent multiple bindings\r\n            settingsBtn.addEventListener('click', handleAdminLogin);\r\n        }\r\n\r\n        // 2. REVISED LISTENER BINDING for the notify button\r\n        const notifyNowBtn = document.getElementById('notify-now-btn');\r\n        if (notifyNowBtn) {\r\n            // Ensure any previous listener is removed before adding the new one\r\n            notifyNowBtn.removeEventListener('click', handleNotifyNow);\r\n            notifyNowBtn.addEventListener('click', handleNotifyNow);\r\n        }\r\n\r\n        // 3. ADDED LISTENER for the new call duty button\r\n        const callDutyBtn = document.getElementById('call-duty-btn');\r\n        if (callDutyBtn) {\r\n            callDutyBtn.removeEventListener('click', handleCallDuty);\r\n            callDutyBtn.addEventListener('click', handleCallDuty);\r\n        }\r\n        \r\n        // 4. Re-start the quote rotator\r\n        initQuoteRotator();\r\n    }\r\n    \r\n    // NEW FUNCTION: Updates the icons on the sound selection modal based on state\r\n    function updateNotificationIcons() {\r\n        // Ensure buttons exist before querying for icons\r\n        if (!muteBtn || !minimizeNotificationsBtn || !noSpeechBtn) return;\r\n        \r\n        const muteIcon = muteBtn.querySelector('i');\r\n        const minimizeIcon = minimizeNotificationsBtn.querySelector('i');\r\n        const noSpeechIcon = noSpeechBtn.querySelector('i');\r\n\r\n        if (muteIcon) muteIcon.className = state.notificationControls.isMuted ? 'mdi mdi-volume-off' : 'mdi mdi-volume-high';\r\n        if (minimizeIcon) minimizeIcon.className = state.notificationControls.isMinimized ? 'mdi mdi-arrow-collapse-vertical' : 'mdi mdi-arrow-expand-vertical';\r\n        if (noSpeechIcon) noSpeechIcon.className = state.notificationControls.isTTSDisabled ? 'mdi mdi-microphone-off' : 'mdi mdi-microphone-message';\r\n    }\r\n\r\n    function showAdminModal() {\r\n        // Populate Committee Member List (Assuming this logic is correct from your file)\r\n        committeeMemberList.innerHTML = '';\r\n        const committeeMembers = MASTER_MEMBER_LIST.filter(m => m.committee);\r\n        const noneOption = document.createElement('li');\r\n        noneOption.innerHTML = `\r\n            <label>\r\n                <input type=\"radio\" name=\"onDutyMember\" value=\"None\" ${state.onDuty === 'None' ? 'checked' : ''}>\r\n                <div class=\"member-details\">\r\n                    <span class=\"member-name\">None</span>\r\n                    <span class=\"member-designation\">No assigned member</span>\r\n                </div>\r\n            </label>\r\n        `;\r\n        committeeMemberList.appendChild(noneOption);\r\n        committeeMembers.sort((a, b) => a.name.localeCompare(b.name)).forEach(member => {\r\n            const li = document.createElement('li');\r\n            li.className = 'committee-member';\r\n            li.innerHTML = `\r\n                <label>\r\n                    <input type=\"radio\" name=\"onDutyMember\" value=\"${member.name}\" ${state.onDuty === member.name ? 'checked' : ''}>\r\n                    <div class=\"member-details\">\r\n                        <span class=\"member-name\">${member.name}</span>\r\n                        <span class=\"member-designation\">${member.committee}</span>\r\n                    </div>\r\n                </label>\r\n            `;\r\n            committeeMemberList.appendChild(li);\r\n        });\r\n        committeeMemberList.querySelectorAll('input[name=\"onDutyMember\"]').forEach(radio => {\r\n            radio.removeEventListener('change', handleOnDutyChange); // Prevent duplicates\r\n            radio.addEventListener('change', handleOnDutyChange);\r\n        });\r\n\r\n        // Populate Court Availability List\r\n        courtAvailabilityList.innerHTML = '';\r\n\r\n        // --- Render the global Toggles First ---\r\n        const togglesLi = document.createElement('li');\r\n        togglesLi.className = 'court-availability-item';\r\n        // Removed inline styles, assuming CSS handles layout\r\n        togglesLi.innerHTML = `\r\n            <label style=\"flex-grow: 1;\">Auto Court Modes</label>\r\n            <label class=\"switch\">\r\n                <input type=\"checkbox\" id=\"auto-assign-toggle\" ${state.courtSettings.autoAssignModes ? 'checked' : ''}>\r\n                <span class=\"slider\"></span>\r\n            </label>\r\n            <label style=\"flex-grow: 1; margin-left: 1rem;\">Show Mode Selector</label>\r\n            <label class=\"switch\">\r\n                <input type=\"checkbox\" id=\"show-mode-selector-toggle\" ${state.courtSettings.showGameModeSelector ? 'checked' : ''}>\r\n                <span class=\"slider\"></span>\r\n            </label>\r\n        `;\r\n        courtAvailabilityList.appendChild(togglesLi);\r\n\r\n        // --- Render Match Mode Settings ---\r\n        const matchModeSettingsHtml = `\r\n            <li class=\"court-availability-item\" style=\"border-top: 1px dashed var(--border-color); padding-top: 1rem; margin-top: 0.5rem; flex-direction: column; align-items: stretch;\">\r\n                <div style=\"display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;\">\r\n                     <label style=\"flex-grow: 1;\">Auto Match Modes</label>\r\n                     <label class=\"switch\">\r\n                         <input type=\"checkbox\" id=\"auto-match-mode-toggle\" ${state.matchSettings.autoMatchModes ? 'checked' : ''}>\r\n                         <span class=\"slider\"></span>\r\n                     </label>\r\n                </div>\r\n                <div id=\"match-mode-selector-admin\" class=\"match-mode-selector\" style=\"${state.matchSettings.autoMatchModes ? 'display: none;' : ''}\">\r\n                    <label>\r\n                        <input type=\"radio\" name=\"match-mode\" value=\"1set\" ${state.matchSettings.matchMode === '1set' ? 'checked' : ''}> 1 Set\r\n                    </label>\r\n                    <label>\r\n                        <input type=\"radio\" name=\"match-mode\" value=\"3set\" ${state.matchSettings.matchMode === '3set' ? 'checked' : ''}> 3 Sets\r\n                    </label>\r\n                    <label>\r\n                        <input type=\"radio\" name=\"match-mode\" value=\"fast\" ${state.matchSettings.matchMode === 'fast' ? 'checked' : ''}> Fast Play\r\n                    </label>\r\n                </div>\r\n                <div class=\"fast-play-games-selector\" style=\"${state.matchSettings.matchMode !== 'fast' || state.matchSettings.autoMatchModes ? 'display: none;' : ''}\">\r\n                    <label>Fast Play Games (First to):</label>\r\n                    <div class=\"radio-group\">\r\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"3\" ${state.matchSettings.fastPlayGames === 3 ? 'checked' : ''}> 3 </label>\r\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"4\" ${state.matchSettings.fastPlayGames === 4 ? 'checked' : ''}> 4 </label>\r\n                        <label> <input type=\"radio\" name=\"fast-play-games\" value=\"5\" ${state.matchSettings.fastPlayGames === 5 ? 'checked' : ''}> 5 </label>\r\n                    </div>\r\n                </div>\r\n            </li>\r\n        `;\r\n        courtAvailabilityList.insertAdjacentHTML('beforeend', matchModeSettingsHtml);\r\n\r\n        // --- Court List Rendering (MODIFIED for click delegation) ---\r\n            state.courts.forEach(court => {\r\n                const li = document.createElement('li');\r\n                li.className = 'court-availability-item';\r\n                // li.style.cursor = 'pointer'; // Keep removed\r\n                li.dataset.courtId = court.id;\r\n\r\n                const isVisible = state.courtSettings.visibleCourts.includes(court.id);\r\n                const light = state.lightSettings.courts ? state.lightSettings.courts[court.id] : null;\r\n                const isLightManaged = light && light.isManaged;\r\n                const isLightActive = isLightManaged && light.isActive;\r\n                const lightIconClass = isLightActive ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline';\r\n                const lightDisabledAttr = isLightManaged ? '' : 'disabled';\r\n\r\n                // --- REVISED li.innerHTML ---\r\n                li.innerHTML = `\r\n                    <span style=\"font-weight: 500; margin-right: auto;\">${court.id}</span> <button class=\"light-toggle-btn\" data-court-id=\"${court.id}\" title=\"Toggle Court ${court.id} Lights\" ${lightDisabledAttr} style=\"flex-shrink: 0;\"> <i class=\"mdi ${lightIconClass}\"></i>\r\n                    </button>\r\n                    <label class=\"switch\" style=\"flex-shrink: 0; width: 50px\"> <input type=\"checkbox\" data-court-id=\"${court.id}\" ${isVisible ? 'checked' : ''}>\r\n                        <span class=\"slider\"></span>\r\n                    </label>\r\n                `;\r\n                // --- END REVISED li.innerHTML ---\r\n                courtAvailabilityList.appendChild(li);\r\n            });\r\n\r\n        // --- Event Listener Delegation (MODIFIED) ---\r\n        courtAvailabilityList.removeEventListener('click', handleAdminCourtListClick); // Remove previous listener if exists\r\n        courtAvailabilityList.addEventListener('click', handleAdminCourtListClick);   // Add new delegated listener\r\n\r\n        // --- Attach Listeners for Toggles & Match Mode ---\r\n        document.getElementById('auto-assign-toggle')?.addEventListener('change', (e) => {\r\n            state.courtSettings.autoAssignModes = e.target.checked;\r\n            saveState();\r\n            autoAssignCourtModes(); // Run the logic immediately\r\n            render(); // Re-render to show/hide court modes if needed\r\n        });\r\n        document.getElementById('show-mode-selector-toggle')?.addEventListener('change', (e) => {\r\n            state.courtSettings.showGameModeSelector = e.target.checked;\r\n            saveState();\r\n            render(); // Re-render to show/hide the main selector\r\n        });\r\n         document.getElementById('auto-match-mode-toggle')?.addEventListener('change', (e) => {\r\n             state.matchSettings.autoMatchModes = e.target.checked;\r\n             // Show/hide manual selectors\r\n             document.getElementById('match-mode-selector-admin').style.display = e.target.checked ? 'none' : '';\r\n             document.querySelector('.fast-play-games-selector').style.display = (e.target.checked || state.matchSettings.matchMode !== 'fast') ? 'none' : '';\r\n             saveState();\r\n             autoAssignMatchMode(); // Run the logic immediately\r\n             render(); // Re-render summary card\r\n        });\r\n\r\n        document.querySelectorAll('input[name=\"match-mode\"]').forEach(radio => radio.addEventListener('change', handleMatchModeChange));\r\n        document.querySelectorAll('input[name=\"fast-play-games\"]').forEach(radio => radio.addEventListener('change', handleFastPlayGamesChange));\r\n\r\n        updateLightIcon(); // Update admin header light icon\r\n        adminSettingsModal.classList.remove('hidden');\r\n    }\r\n\r\n    // --- NEW Delegated Click Handler for Admin Court List ---\r\n    function handleAdminCourtListClick(e) {\r\n        const lightButton = e.target.closest('.light-toggle-btn');\r\n        const visibilityToggleInput = e.target.closest('.switch input[type=\"checkbox\"]'); // Target the input directly\r\n        const courtLabelButton = e.target.closest('.court-label-button'); // Target the new label span\r\n\r\n        if (lightButton) {\r\n            // Clicked the light icon button\r\n            handleLightToggleChange(e);\r\n        } else if (visibilityToggleInput) {\r\n            // Clicked the visibility toggle switch's input\r\n            handleCourtVisibilityChange({ target: visibilityToggleInput }); // Pass the input as the target\r\n        }\r\n        // Clicks elsewhere within the li (like empty space) are ignored\r\n    }\r\n\r\n// --- NEW: Light Settings Modal Functions (Consolidated) ---\r\n\r\n    function showLightSettingsCourtModal(courtId) {\r\n        // Ensure lightSettings structure exists\r\n        if (!state.lightSettings) {\r\n             console.error(\"state.lightSettings is missing!\");\r\n             return; // Or initialize it here\r\n        }\r\n        const court = state.lightSettings.courts ? state.lightSettings.courts[courtId] : null;\r\n        if (!court) {\r\n             console.error(`Court settings for ${courtId} not found!`);\r\n             return;\r\n        }\r\n\r\n        const modal = document.getElementById('light-settings-court-modal');\r\n        modal.dataset.editingCourtId = courtId;\r\n\r\n        document.getElementById('light-settings-court-title').textContent = `Edit Light Settings for Court ${courtId}`;\r\n\r\n        // ++ POPULATE GLOBAL FIELDS ++\r\n        document.getElementById('light-setting-base-url').value = state.lightSettings.shellyBaseUrl || '';\r\n        document.getElementById('light-setting-auth-key').value = state.lightSettings.shellyAuthKey || '';\r\n        // ++ END POPULATE GLOBAL FIELDS ++\r\n\r\n        // == POPULATE COURT-SPECIFIC FIELDS ==\r\n        document.getElementById('light-setting-label').value = court.label || `Court ${courtId} Lights`;\r\n        document.getElementById('light-setting-cloud-id').value = court.shellyCloudId || '';\r\n        document.getElementById('light-setting-local-ip').value = court.shellyDeviceId || '';\r\n        // Default 'isManaged' to true if it's undefined in the state\r\n        document.getElementById('light-setting-managed').checked = court.isManaged !== false;\r\n\r\n        adminSettingsModal.classList.add('hidden');\r\n        modal.classList.remove('hidden');\r\n\r\n        // Wire up global keyboard for ALL inputs inside this modal\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-base-url'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-auth-key'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-label'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-cloud-id'));\r\n        wireGlobalKeypadToInput(document.getElementById('light-setting-local-ip'));\r\n    }\r\n\r\n    function saveLightSettingsCourtModal() {\r\n        const modal = document.getElementById('light-settings-court-modal');\r\n        const courtId = modal.dataset.editingCourtId;\r\n        \r\n        if (!courtId || !state.lightSettings?.courts?.[courtId]) {\r\n            console.error(`Cannot save: Court ${courtId} not found!`);\r\n            return;\r\n        }\r\n        \r\n        // Save GLOBAL settings (shared by all courts)\r\n        state.lightSettings.shellyBaseUrl = document.getElementById('light-setting-base-url').value.trim();\r\n        state.lightSettings.shellyAuthKey = document.getElementById('light-setting-auth-key').value.trim();\r\n        \r\n        // Save COURT-SPECIFIC settings\r\n        const court = state.lightSettings.courts[courtId];\r\n        court.label = document.getElementById('light-setting-label').value.trim() || `Court ${courtId} Lights`;\r\n        court.shellyCloudId = document.getElementById('light-setting-cloud-id').value.trim();\r\n        court.shellyDeviceId = document.getElementById('light-setting-local-ip').value.trim();\r\n        court.isManaged = document.getElementById('light-setting-managed').checked;\r\n        court.toggleAfter = 0;  // ← IMPORTANT: Permanent toggle, no auto-off\r\n        \r\n        if (!court.isManaged) {\r\n            court.shellyCloudId = '';\r\n            court.shellyDeviceId = '';\r\n            court.isActive = false;\r\n        }\r\n        \r\n        console.log(`[Light Settings] Saved Court ${courtId}:`, court);\r\n\r\n        saveState();\r\n        modal.classList.add('hidden');\r\n        render(); // ← ADD THIS LINE\r\n        playCustomTTS(`Court ${courtId} light settings saved.`);\r\n    }\r\n    // --- NEW: Click and Hold Paste Functionality ---\r\n    function setupLongPressPaste() {\r\n        const pasteTargets = document.querySelectorAll('.long-press-paste');\r\n        let pressTimer = null;\r\n        let isLongPress = false;\r\n\r\n        pasteTargets.forEach(input => {\r\n            // Remove previous listeners to prevent duplicates if called multiple times\r\n            input.removeEventListener('pointerdown', handlePointerDown);\r\n            input.removeEventListener('pointerup', handlePointerUp);\r\n            input.removeEventListener('pointerleave', handlePointerLeave);\r\n            input.removeEventListener('contextmenu', handleContextMenu);\r\n\r\n            // Add new listeners\r\n            input.addEventListener('pointerdown', handlePointerDown);\r\n            input.addEventListener('pointerup', handlePointerUp);\r\n            input.addEventListener('pointerleave', handlePointerLeave); // Handle finger sliding off\r\n            input.addEventListener('contextmenu', handleContextMenu); // Prevent default right-click menu\r\n        });\r\n\r\n        function handlePointerDown(e) {\r\n            const input = e.target;\r\n            isLongPress = false; // Reset flag\r\n\r\n            // --- ADD THIS LINE ---\r\n            // If a short click timer is running for this input, cancel it because a long press is starting.\r\n            if (input._clickTimeoutId) {\r\n                clearTimeout(input._clickTimeoutId);\r\n                input._clickTimeoutId = null;\r\n            }\r\n            // --- END ADD ---\r\n\r\n\r\n            // Start timer\r\n            pressTimer = setTimeout(async () => {\r\n                isLongPress = true; // Mark as long press\r\n                console.log('Long press detected on:', input.id);\r\n                input.style.backgroundColor = '#a8d5ff'; // Highlight during paste attempt\r\n\r\n                try {\r\n                    // Check for clipboard permission first\r\n                    const permission = await navigator.permissions.query({ name: 'clipboard-read' });\r\n                    if (permission.state === 'granted' || permission.state === 'prompt') {\r\n                        const text = await navigator.clipboard.readText();\r\n                        if (text) {\r\n                            input.value = text;\r\n                            // Manually trigger 'input' event if needed by other logic\r\n                            input.dispatchEvent(new Event('input', { bubbles: true }));\r\n                            console.log('Pasted successfully!');\r\n                            playCustomTTS(\"Pasted from clipboard.\"); // Optional feedback\r\n                        } else {\r\n                            console.log('Clipboard is empty.');\r\n                            playCustomTTS(\"Clipboard is empty.\");\r\n                        }\r\n                    } else {\r\n                         console.error('Clipboard read permission denied.');\r\n                         playCustomTTS(\"Could not paste. Please allow clipboard permissions.\");\r\n                         alert('Clipboard access denied. Please allow clipboard permissions in your browser settings for this site.');\r\n                    }\r\n                } catch (err) {\r\n                    console.error('Failed to read clipboard contents:', err);\r\n                    playCustomTTS(\"Could not paste.\");\r\n                    alert('Failed to paste from clipboard. Error: ' + err.message);\r\n                } finally {\r\n                    // Reset background color slightly later to keep visual feedback\r\n                    setTimeout(() => {\r\n                        input.style.backgroundColor = '';\r\n                    }, 300);\r\n                    pressTimer = null; // Clear timer ID after execution\r\n                }\r\n            }, 750); // 750ms for long press\r\n        }\r\n\r\n        function handlePointerUp(e) {\r\n            if (pressTimer) { // Only clear if timer is still running (wasn't a completed long press)\r\n                clearTimeout(pressTimer);\r\n                pressTimer = null;\r\n            }\r\n            // Reset background immediately ONLY if it wasn't a completed long press action\r\n            if (!isLongPress) {\r\n                 e.target.style.backgroundColor = '';\r\n            }\r\n            // If it *was* a long press, the background reset is handled in the timer's finally block\r\n        }\r\n\r\n        function handlePointerLeave(e) {\r\n             // If pointer leaves element during press, cancel the timer\r\n            if (pressTimer) {\r\n                clearTimeout(pressTimer);\r\n                pressTimer = null;\r\n                isLongPress = false;\r\n                e.target.style.backgroundColor = ''; // Reset background\r\n            }\r\n        }\r\n\r\n        function handleContextMenu(e) {\r\n            // Prevent the default right-click menu, especially on desktop\r\n            e.preventDefault();\r\n        }\r\n    } \r\n\r\n\r\n    function showSuggestionSettingsModal() {\r\n        // Set initial values from state\r\n        femaleRatioSlider.value = state.suggestionSettings.femaleRatioPercent;\r\n        updateFemaleRatioDisplay();\r\n        maleRatioSlider.value = state.suggestionSettings.maleRatioPercent;\r\n        updateMaleRatioDisplay();\r\n        leastPlaytimeToggle.checked = state.suggestionSettings.prioritizeLeastPlaytime;\r\n        powerScoreOnlyToggle.checked = state.suggestionSettings.powerScoreOnly;\r\n        // --- ADD THESE LINES ---\r\n        topPlayerSlider.value = state.suggestionSettings.topPlayerPercent;\r\n        updateTopPlayerDisplay();\r\n        frequentOpponentSlider.value = state.suggestionSettings.frequentOpponentPercent;\r\n        updateFrequentOpponentDisplay();\r\n        weakPlayerSlider.value = state.suggestionSettings.weakPlayerPercent;\r\n        updateWeakPlayerDisplay();\r\n        // --- END ADD ---\r\n\r\n\r\n        // Apply initial disabled/fade state based on powerScoreOnly\r\n        toggleSuggestionOptionsAvailability(state.suggestionSettings.powerScoreOnly);\r\n\r\n        adminSettingsModal.classList.add('hidden');\r\n        suggestionSettingsModal.classList.remove('hidden');\r\n    }\r\n\r\n    function updateFemaleRatioDisplay() {\r\n        const value = femaleRatioSlider.value;\r\n        femaleRatioDisplay.textContent = `${value}% All Female`;\r\n    }\r\n\r\n    function updateMaleRatioDisplay() {\r\n        const value = maleRatioSlider.value;\r\n        maleRatioDisplay.textContent = `${value}% All Male`;\r\n    }\r\n\r\n    function handleFemaleRatioChange() {\r\n        state.suggestionSettings.femaleRatioPercent = parseInt(femaleRatioSlider.value, 10);\r\n        updateFemaleRatioDisplay();\r\n        saveState();\r\n    }\r\n\r\n    function handleMaleRatioChange() {\r\n        state.suggestionSettings.maleRatioPercent = parseInt(maleRatioSlider.value, 10);\r\n        updateMaleRatioDisplay();\r\n        saveState();\r\n    }\r\n\r\n    function handleLeastPlaytimeToggleChange() {\r\n        state.suggestionSettings.prioritizeLeastPlaytime = leastPlaytimeToggle.checked;\r\n        saveState();\r\n    }\r\n\r\n    // Function to visually disable/enable other options\r\n    function toggleSuggestionOptionsAvailability(isDisabled) {\r\n        // Toggle the 'disabled' class on container elements\r\n        leastPlaytimeContainer.classList.toggle('disabled', isDisabled);\r\n        femaleRatioContainer.classList.toggle('disabled', isDisabled);\r\n        maleRatioContainer.classList.toggle('disabled', isDisabled);\r\n\r\n        // Explicitly enable/disable controls within the containers\r\n        leastPlaytimeToggle.disabled = isDisabled;\r\n        femaleRatioSlider.disabled = isDisabled;\r\n        maleRatioSlider.disabled = isDisabled;\r\n    // --- ADD THESE LINES ---\r\n        topPlayerContainer.classList.toggle('disabled', isDisabled);\r\n        frequentOpponentContainer.classList.toggle('disabled', isDisabled);\r\n        weakPlayerContainer.classList.toggle('disabled', isDisabled);\r\n\r\n        topPlayerSlider.disabled = isDisabled;\r\n        frequentOpponentSlider.disabled = isDisabled;\r\n        weakPlayerSlider.disabled = isDisabled;\r\n        // --- END ADD ---\r\n    }\r\n\r\n    function handlePowerScoreOnlyToggleChange() {\r\n        const isEnabled = powerScoreOnlyToggle.checked;\r\n        state.suggestionSettings.powerScoreOnly = isEnabled;\r\n\r\n        // Call the function to update UI based on the new state\r\n        toggleSuggestionOptionsAvailability(isEnabled);\r\n\r\n        saveState();\r\n    }\r\n\r\n    function updateTopPlayerDisplay() {\r\n        const value = topPlayerSlider.value;\r\n        topPlayerDisplay.textContent = `${value}% Top Player H2H`;\r\n    }\r\n    function handleTopPlayerChange() {\r\n        state.suggestionSettings.topPlayerPercent = parseInt(topPlayerSlider.value, 10);\r\n        updateTopPlayerDisplay();\r\n        saveState();\r\n    }\r\n\r\n    function updateFrequentOpponentDisplay() {\r\n        const value = frequentOpponentSlider.value;\r\n        frequentOpponentDisplay.textContent = `${value}% Frequent Opponent`;\r\n    }\r\n    function handleFrequentOpponentChange() {\r\n        state.suggestionSettings.frequentOpponentPercent = parseInt(frequentOpponentSlider.value, 10);\r\n        updateFrequentOpponentDisplay();\r\n        saveState();\r\n    }\r\n\r\n    function updateWeakPlayerDisplay() {\r\n        const value = weakPlayerSlider.value;\r\n        weakPlayerDisplay.textContent = `${value}% Weak Player Group`;\r\n    }\r\n    function handleWeakPlayerChange() {\r\n        state.suggestionSettings.weakPlayerPercent = parseInt(weakPlayerSlider.value, 10);\r\n        updateWeakPlayerDisplay();\r\n        saveState();\r\n    }\r\n\r\n\r\n\r\n    // FIX 5: Add checkAndPlayAlert(false) to trigger re-evaluation after court visibility change\r\n    function handleCourtVisibilityChange(e) {\r\n        const courtId = e.target.dataset.courtId;\r\n        const isVisible = e.target.checked;\r\n        if (isVisible) {\r\n            if (!state.courtSettings.visibleCourts.includes(courtId)) {\r\n                state.courtSettings.visibleCourts.push(courtId);\r\n                state.courtSettings.visibleCourts.sort(); \r\n            }\r\n        } else {\r\n            state.courtSettings.visibleCourts = state.courtSettings.visibleCourts.filter(id => id !== courtId);\r\n        }\r\n        saveState();\r\n        render();\r\n        checkAndPlayAlert(false); // Re-evaluate logic immediately\r\n    }\r\n    \r\n    function logPlayerSwap(playerName, oldIndex, newIndex) {\r\n        if (oldIndex === newIndex) return;\r\n\r\n        // Initialize sessionLog on tempPlayerOrder if it doesn't exist\r\n        tempPlayerOrder.sessionLog = tempPlayerOrder.sessionLog || {};\r\n        \r\n        let sessionLog = tempPlayerOrder.sessionLog;\r\n        \r\n        // Initialize or get the player's log\r\n        let playerLog = sessionLog[playerName] || { \r\n            startPosition: oldIndex, \r\n            currentPosition: oldIndex,\r\n            movements: [] \r\n        };\r\n\r\n        // Record the atomic movement\r\n        playerLog.movements.push({ from: oldIndex, to: newIndex, timestamp: Date.now() });\r\n\r\n        // Update the player's final position for this session\r\n        playerLog.currentPosition = newIndex;\r\n\r\n        sessionLog[playerName] = playerLog;\r\n        tempPlayerOrder.sessionLog = sessionLog;\r\n    }\r\n\r\n    function showReorderModal() {\r\n        if (state.availablePlayers.length < 2) {\r\n            alert(\"At least two players must be available to reorder the queue.\");\r\n            return;\r\n        }\r\n        tempPlayerOrder = [...state.availablePlayers];\r\n        renderReorderList();\r\n        adminSettingsModal.classList.add('hidden');\r\n        reorderPlayersModal.classList.remove('hidden');\r\n    }\r\n\r\n    function renderReorderList() {\r\n        reorderPlayersList.innerHTML = \"\";\r\n        tempPlayerOrder.forEach((player, index) => {\r\n            const li = document.createElement('li');\r\n            const isFirst = index === 0;\r\n            const isLast = index === tempPlayerOrder.length - 1;\r\n            li.innerHTML = `\r\n                <span class=\"reorder-position\" data-player-name=\"${player.name}\" data-current-index=\"${index}\">${index + 1}</span>\r\n                <span>${player.name}</span>\r\n                <div class=\"reorder-controls\">\r\n                    <button class=\"reorder-btn\" data-player-name=\"${player.name}\" data-direction=\"up\" ${isFirst ? 'disabled' : ''}>↑</button>\r\n                    <button class=\"reorder-btn\" data-player-name=\"${player.name}\" data-direction=\"down\" ${isLast ? 'disabled' : ''}>↓</button>\r\n                </div>\r\n            `;\r\n            reorderPlayersList.appendChild(li);\r\n        });\r\n    }\r\n\r\n    function handleReorderClick(e) {\r\n        const button = e.target.closest('.reorder-btn');\r\n        const positionEl = e.target.closest('.reorder-position');\r\n\r\n        if (button) {\r\n            const playerName = button.dataset.playerName;\r\n            const direction = button.dataset.direction;\r\n            const currentIndex = tempPlayerOrder.findIndex(p => p.name === playerName);\r\n            if (currentIndex === -1) return;\r\n            let newIndex = currentIndex;\r\n            if (direction === 'up' && currentIndex > 0) {\r\n                newIndex = currentIndex - 1;\r\n            } else if (direction === 'down' && currentIndex < tempPlayerOrder.length - 1) {\r\n                newIndex = currentIndex + 1;\r\n            }\r\n            \r\n            if (newIndex !== currentIndex) {\r\n                const [playerToMove] = tempPlayerOrder.splice(currentIndex, 1);\r\n                tempPlayerOrder.splice(newIndex, 0, playerToMove);\r\n                // Note: We don't need to log the swap here, it will be logged when the position is changed.\r\n            }\r\n            renderReorderList();\r\n        } else if (positionEl) {\r\n            showKeypad(positionEl, {\r\n                title: `Set new position for ${positionEl.dataset.playerName}`,\r\n                maxLength: 2\r\n            });\r\n        }\r\n    }\r\n    \r\n    // NEW FUNCTION: Sound selection modal logic\r\n    function handleSoundSelectionModal() {\r\n        tempSelectedSound = state.selectedAlertSound;\r\n        updateNotificationIcons();\r\n        \r\n        // Set the state of the new toggle switch\r\n        const autoMinimizeToggle = document.getElementById('auto-minimize-toggle');\r\n        if (autoMinimizeToggle) {\r\n            autoMinimizeToggle.checked = state.notificationControls.autoMinimize;\r\n        }\r\n\r\n        renderSoundList();\r\n        adminSettingsModal.classList.add('hidden');\r\n        soundSelectionModal.classList.remove('hidden');\r\n    }\r\n\r\n    // NEW FUNCTION: Render the sound list\r\n    function renderSoundList() {\r\n        soundSelectionList.innerHTML = '';\r\n        alertSounds.forEach(soundFile => {\r\n            const li = document.createElement('li');\r\n            li.className = 'sound-selection-item';\r\n            const isSelected = soundFile === tempSelectedSound;\r\n            \r\n            // Extract the number from the filename for display\r\n            const displayName = soundFile.replace('.mp3', '').replace('Alert', 'Alert ');\r\n\r\n            li.innerHTML = `\r\n                <label class=\"sound-selection-label\">\r\n                    <input type=\"radio\" name=\"alertSound\" value=\"${soundFile}\" ${isSelected ? 'checked' : ''}>\r\n                    ${displayName}\r\n                </label>\r\n                <button class=\"sound-preview-btn\" data-sound-file=\"${soundFile}\">▶</button>\r\n            `;\r\n            soundSelectionList.appendChild(li);\r\n        });\r\n\r\n        // Set initial state of confirm button\r\n        soundConfirmBtn.disabled = !tempSelectedSound;\r\n        soundConfirmBtn.style.backgroundColor = tempSelectedSound ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n        soundConfirmBtn.style.borderColor = tempSelectedSound ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n\r\n    // NEW FUNCTION: Handle radio button selection in sound modal\r\n    function handleSoundSelection(e) {\r\n        if (e.target.type === 'radio' && e.target.name === 'alertSound') {\r\n            tempSelectedSound = e.target.value;\r\n            soundConfirmBtn.disabled = false;\r\n            soundConfirmBtn.style.backgroundColor = 'var(--confirm-color)';\r\n            soundConfirmBtn.style.borderColor = 'var(--confirm-color)';\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Handle sound preview button click\r\n    function handleSoundPreview(e) {\r\n        const button = e.target.closest('.sound-preview-btn');\r\n        if (!button) return;\r\n        const soundFile = button.dataset.soundFile;\r\n        \r\n        // FIX: Stop previous sound before playing the new one\r\n        if (currentAudio) {\r\n            currentAudio.pause();\r\n            currentAudio.currentTime = 0;\r\n        }\r\n\r\n        const audioPath = `source/${soundFile}`;\r\n        currentAudio = new Audio(audioPath);\r\n        \r\n        currentAudio.play().catch(error => {\r\n            console.warn(`Could not play audio from source/${soundFile}. Error: `, error);\r\n            // Optional: alert(`Preview for ${soundFile} failed. Check file existence in the 'source' directory.`);\r\n        });\r\n    }\r\n\r\n    // NEW FUNCTION: Confirm and save sound selection\r\n    function confirmSoundSelection() {\r\n        state.selectedAlertSound = tempSelectedSound;\r\n        saveState();\r\n        soundSelectionModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    }\r\n\r\n    // NEW FUNCTION: Cancel sound selection\r\n    function cancelSoundSelection() {\r\n        soundSelectionModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    }\r\n\r\n    function resetAlertSchedule() {\r\n        alertScheduleTime = 0;\r\n        alertState = 'initial_check';\r\n        state.currentAlertCount = 0; // <-- ADD THIS NEW LINE\r\n    }\r\n\r\n\r\n    /* =================================\r\n        Screensaver FUNCTIONS (NEW)\r\n    ================================= */\r\n\r\n    function resetAlertSchedule() {\r\n        alertScheduleTime = 0;\r\n        alertState = 'initial_check';\r\n        state.currentAlertCount = 0; // <-- ADD THIS NEW LINE\r\n    }\r\n\r\n    // --- NEW: Screensaver Functions ---\r\n\r\n    function startScreensaver() {\r\n        // Don't start if already active or on mobile\r\n        if (!screensaverOverlay.classList.contains('hidden') || window.innerWidth <= 900) {\r\n             return;\r\n        }\r\n        console.log(\"Starting screensaver...\");\r\n        screensaverOverlay.classList.remove('hidden'); // Fade in overlay container\r\n        isShowingScreensaverEvent = true; // Reset state: Start by showing an event\r\n        screensaverCurrentIndex = 0; // Reset index to the first event\r\n\r\n        // Clear any previous interval to prevent duplicates\r\n        if (screensaverCycleInterval) {\r\n            clearInterval(screensaverCycleInterval);\r\n            screensaverCycleInterval = null; // Ensure it's cleared\r\n        }\r\n\r\n        // Function to display the next item (event or app view)\r\n                // SCREENSAVER CYCLING LOGIC:\r\n        // - Event View: Shows event details with overlay background\r\n        // - Main App View: Makes overlay transparent so you can see courts/players/main app\r\n        // - Cycles every 15 seconds between these two states\r\n        // - This allows monitoring courts while still promoting events\r\n        \r\n    const displayNextScreensaverItem = () => {\r\n        const activeEvents = state.events.filter(event => event.isActive);\r\n\r\n        // --- FADE OUT ---\r\n        screensaverContent.classList.remove('visible');\r\n        screensaverOverlay.classList.remove('show-main-app');\r\n\r\n        // --- Remove existing overlay button ---\r\n        const existingOverlayBtn = document.getElementById('screensaver-interested-btn-overlay');\r\n        if (existingOverlayBtn) {\r\n            existingOverlayBtn.remove();\r\n        }\r\n\r\n        setTimeout(() => {\r\n            if (isShowingScreensaverEvent && activeEvents.length > 0) {\r\n                // --- SHOW EVENT ---\r\n                const eventIndexToShow = screensaverCurrentIndex % activeEvents.length;\r\n                const event = activeEvents[eventIndexToShow];\r\n\r\n                // --- Format Date (Removed weekday) ---\r\n                const eventDateFormatted = event.eventDate\r\n                    ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' }) // Removed weekday:'long'\r\n                    : 'Date TBC';\r\n\r\n                // --- Format Time (Added AM/PM) ---\r\n                let eventTimeFormatted = 'Time TBC';\r\n                if (event.startTime) {\r\n                    try {\r\n                        const [hours, minutes] = event.startTime.split(':');\r\n                        const hourInt = parseInt(hours, 10);\r\n                        const minuteInt = parseInt(minutes, 10);\r\n                        const ampm = hourInt >= 12 ? 'PM' : 'AM';\r\n                        const hour12 = hourInt % 12 || 12; // Convert 0 hour to 12\r\n                        eventTimeFormatted = `${hour12}:${String(minuteInt).padStart(2, '0')} ${ampm}`;\r\n                    } catch (e) {\r\n                        console.error(\"Error formatting event time:\", e);\r\n                        eventTimeFormatted = event.startTime; // Fallback to original if parsing fails\r\n                    }\r\n                }\r\n                // --- END Time Formatting ---\r\n\r\n                const rsvpDateFormatted = event.rsvpDate\r\n                    ? new Date(event.rsvpDate + 'T00:00:00').toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' })\r\n                    : 'N/A';\r\n\r\n                // Build images HTML\r\n                let imagesHTML = '';\r\n                if (event.image1Filename && event.image1Filename !== 'None') {\r\n                    imagesHTML += `<img src=\"source/screensaver/${event.image1Filename}\" alt=\"Event Image 1\" class=\"screensaver-event-image\">`;\r\n                }\r\n                if (event.image2Filename && event.image2Filename !== 'None') {\r\n                    imagesHTML += `<img src=\"source/screensaver/${event.image2Filename}\" alt=\"Event Image 2\" class=\"screensaver-event-image\">`;\r\n                }\r\n\r\n                // Build cost display\r\n                let costHTML = '';\r\n                if (event.costAdult > 0 || event.costChild > 0) {\r\n                    const adultCost = event.costAdult > 0 ? `Adult: R${event.costAdult}` : '';\r\n                    const childCost = event.costChild > 0 ? `Child: R${event.costChild}` : '';\r\n                    const separator = adultCost && childCost ? ' | ' : '';\r\n                    costHTML = `<p class=\"screensaver-cost\">${adultCost}${separator}${childCost}</p>`;\r\n\r\n                    if (event.participationDiscount > 0) {\r\n                            costHTML += `<p class=\"screensaver-discount\">Club Champ Participants get R${event.participationDiscount} off</p>`;\r\n                    }\r\n                }\r\n\r\n                // Build RSVP section\r\n                let rsvpHTML = '';\r\n                if (rsvpDateFormatted && rsvpDateFormatted !== 'N/A') {\r\n                    let rsvpText = `RSVP BY ${rsvpDateFormatted.toUpperCase()}`;\r\n                    if (event.volunteersNeeded) {\r\n                        rsvpText += ' - VOLUNTEER COOKS NEEDED';\r\n                    }\r\n                    rsvpHTML = `<p class=\"screensaver-rsvp\"><strong>${rsvpText}</strong></p>`;\r\n                } else if (event.volunteersNeeded) {\r\n                    rsvpHTML = `<p class=\"screensaver-rsvp\"><strong>VOLUNTEER COOKS NEEDED</strong></p>`;\r\n                }\r\n\r\n                // Build contact info HTML\r\n                let contactHTML = '';\r\n                if (event.phone || event.email || event.website) {\r\n                        contactHTML = '<div class=\"screensaver-contact-bar\">';\r\n                        if (event.phone) {\r\n                            contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">📞</span><span class=\"contact-text\">${event.phone}</span></div>`;\r\n                        }\r\n                        if (event.email) {\r\n                            contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">✉</span><span class=\"contact-text\">${event.email}</span></div>`;\r\n                        }\r\n                        if (event.website) {\r\n                            contactHTML += `<div class=\"screensaver-contact-item\"><span class=\"contact-icon\">🌐</span><span class=\"contact-text\">${event.website}</span></div>`;\r\n                        }\r\n                        contactHTML += '</div>';\r\n                }\r\n\r\n                // Build open to text\r\n                let openToText = event.openTo || 'All Members';\r\n                if (event.isOpenToGuests) {\r\n                    openToText += ' and Invited Guests';\r\n                }\r\n                const openBannerHTML = `<div class=\"screensaver-open-banner\">EVENT OPEN TO ${openToText.toUpperCase()}</div>`;\r\n\r\n                // --- Build the HTML content for the event (RSVP Moved) ---\r\n                screensaverContent.innerHTML = `\r\n                    <div class=\"screensaver-event-layout\">\r\n                        <div class=\"screensaver-left-column\">\r\n                            ${imagesHTML || '<div class=\"screensaver-placeholder-image\"></div>'}\r\n                        </div>\r\n\r\n                        <div class=\"screensaver-right-column\">\r\n                            <div class=\"screensaver-right-column-main-content\">\r\n                                <img src=\"source/mzansi-court-q-logo.png\" alt=\"Eldoraigne Tennis\" class=\"screensaver-club-logo\">\r\n\r\n                                <h1 class=\"screensaver-event-heading\">${event.heading || 'Club Event'}</h1>\r\n\r\n                                <div class=\"screensaver-datetime-row\">\r\n                                    <div class=\"screensaver-date\">\r\n                                        <div class=\"date-value\">${eventDateFormatted}</div>\r\n                                    </div>\r\n                                    ${eventTimeFormatted && eventTimeFormatted !== 'Time TBC' ? `\r\n                                    <div class=\"screensaver-trophy\"><img src=\"source/tennis-ball.png\" alt=\"Tennis Ball\"></div>\r\n                                    <div class=\"screensaver-time\">\r\n                                        <div class=\"time-value\">${eventTimeFormatted} TO CLOSING</div>\r\n                                    </div>\r\n                                    ` : ''}\r\n                                </div>\r\n\r\n                                <div class=\"screensaver-body-text\">\r\n                                    ${event.body1 ? `<p>${event.body1}</p>` : ''}\r\n                                    ${event.body2 ? `<p>${event.body2}</p>` : ''}\r\n                                </div>\r\n\r\n                                ${costHTML}\r\n\r\n                                <button id=\"screensaver-interested-btn\" data-event-id=\"${event.id}\">I am interested</button>\r\n                            </div>\r\n\r\n                            ${rsvpHTML}\r\n                            ${contactHTML}\r\n                            ${openBannerHTML}\r\n                        </div>\r\n                    </div>\r\n                `;\r\n\r\n                // Clear any background images\r\n                screensaverContent.style.backgroundImage = 'none';\r\n\r\n                screensaverContent.style.display = 'flex';\r\n                screensaverContent.classList.add('visible');\r\n\r\n                isShowingScreensaverEvent = false;\r\n\r\n            } else {\r\n                // --- SHOW MAIN APP VIEW (Logic Unchanged) ---\r\n                screensaverContent.style.display = 'none';\r\n                screensaverContent.classList.remove('visible');\r\n                screensaverOverlay.classList.add('show-main-app');\r\n                isShowingScreensaverEvent = true;\r\n                if (activeEvents.length > 0) {\r\n                    screensaverCurrentIndex++;\r\n                }\r\n            }\r\n        }, 1000);\r\n    };\r\n\r\n        displayNextScreensaverItem(); // Display the first item immediately\r\n        screensaverCycleInterval = setInterval(displayNextScreensaverItem, SCREENSAVER_INTERVAL_MS); // Cycle every 15 seconds\r\n    }\r\n\r\n    function stopScreensaver() {\r\n        if (screensaverOverlay.classList.contains('hidden')) {\r\n            return; // Already stopped\r\n        }\r\n        console.log(\"Stopping screensaver...\");\r\n        screensaverOverlay.classList.add('hidden'); // Fade out overlay\r\n        screensaverContent.classList.remove('visible'); // Hide content immediately\r\n        screensaverOverlay.classList.remove('show-main-app'); // Reset view class\r\n        screensaverContent.style.display = 'flex'; // Reset display for next time\r\n        screensaverContent.style.backgroundImage = 'none'; // Clear background images\r\n\r\n\r\n        if (screensaverCycleInterval) {\r\n            clearInterval(screensaverCycleInterval);\r\n            screensaverCycleInterval = null;\r\n        }\r\n        resetInactivityTimer(); // Start monitoring inactivity again\r\n    }\r\n    \r\n    // --- NEW FUNCTION: Add player to event interest list ---\r\n    function addInterestedPlayer(playerName, eventId) {\r\n        if (!playerName || !eventId) return;\r\n\r\n        // Find the event in the state\r\n        const event = state.events.find(ev => ev.id == eventId); // Use == for potential type coercion if IDs are numbers/strings\r\n\r\n        if (event) {\r\n            // Initialize interestedPlayers array if it doesn't exist\r\n            event.interestedPlayers = event.interestedPlayers || [];\r\n\r\n            // Add player name if not already in the list\r\n            if (!event.interestedPlayers.includes(playerName)) {\r\n                event.interestedPlayers.push(playerName);\r\n                saveState();\r\n                console.log(`${playerName} added to interest list for event ID ${eventId}`);\r\n                // Optional: Brief confirmation feedback\r\n                // playCustomTTS(`${getPronounceableName(playerName)} added to interest list.`);\r\n            } else {\r\n                console.log(`${playerName} is already on the interest list for event ID ${eventId}`);\r\n                // Optional: Feedback if already added\r\n                // playCustomTTS(`${getPronounceableName(playerName)} is already interested.`);\r\n            }\r\n        } else {\r\n            console.error(\"Could not find event with ID:\", eventId);\r\n        }\r\n\r\n        // Close the check-in modal and clean up context/styling\r\n        checkInModal.classList.add(\"hidden\");\r\n        checkInModal.style.zIndex = ''; // Reset z-index\r\n        delete checkInModal.dataset.screensaverEventId; // Remove context\r\n    }\r\n    // --- END NEW FUNCTION ---\r\n\r\n    // --- NEW FUNCTION: Show Event List Modal ---\r\n    // --- NEW FUNCTION: Delete Event with Confirmation ---\r\n    function deleteEvent(eventId) {\r\n        const event = state.events.find(ev => ev.id == eventId);\r\n        if (!event) return;\r\n\r\n        const eventName = event.heading || 'this event';\r\n        const confirmDelete = confirm(`Are you sure you want to delete \"${eventName}\"?\\n\\nThis action cannot be undone.`);\r\n        \r\n        if (confirmDelete) {\r\n            // Remove the event from state\r\n            state.events = state.events.filter(ev => ev.id != eventId);\r\n            saveState();\r\n            \r\n            // Refresh the event list display\r\n            showEventListModal();\r\n            \r\n            // If screensaver is running and this was an active event, refresh it\r\n            const screensaverOverlay = document.getElementById('screensaver-overlay');\r\n            if (!screensaverOverlay.classList.contains('hidden')) {\r\n                stopScreensaver();\r\n                resetInactivityTimer();\r\n            }\r\n        }\r\n    }\r\n    // --- END NEW FUNCTION ---\r\n\r\n    function showEventListModal() {\r\n        // Find or create the necessary elements if not already done\r\n        const eventList = document.getElementById('event-list');\r\n        const eventListModal = document.getElementById('event-list-modal');\r\n        if (!eventList || !eventListModal) return; // Basic safety check\r\n\r\n        eventList.innerHTML = ''; // Clear previous list\r\n\r\n        if (state.events.length === 0) {\r\n            eventList.innerHTML = '<li style=\"text-align: center; color: var(--neutral-color); padding: 1rem;\">No events created yet.</li>';\r\n        } else {\r\n            // Sort events, maybe newest first? (Optional)\r\n            const sortedEvents = [...state.events].sort((a, b) => (b.eventDate || '').localeCompare(a.eventDate || '') || (b.id - a.id) );\r\n\r\n            sortedEvents.forEach(event => {\r\n                const li = document.createElement('li');\r\n                li.className = 'event-list-item';\r\n                li.dataset.eventId = event.id; // Store event ID\r\n\r\n                const eventDateStr = event.eventDate ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString('en-ZA', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Date TBC';\r\n\r\n                li.innerHTML = `\r\n                    <div class=\"event-summary\">\r\n                        <span class=\"event-heading\">${event.heading || 'Untitled Event'}</span>\r\n                        <span class=\"event-date\">${eventDateStr}</span>\r\n                    </div>\r\n                    <div class=\"event-controls\">\r\n                        <button class=\"action-btn edit-event-btn\" data-action=\"edit\">Edit</button>\r\n                        <span class=\"action-icon remove delete-event-btn\" data-action=\"delete\" title=\"Delete Event\">&times;</span>\r\n                        <label class=\"switch\" title=\"Show in Screensaver\">\r\n                            <input type=\"checkbox\" class=\"event-active-toggle\" ${event.isActive ? 'checked' : ''}>\r\n                            <span class=\"slider\"></span>\r\n                        </label>\r\n                    </div>\r\n                `;\r\n                eventList.appendChild(li);\r\n            });\r\n        }\r\n\r\n        adminSettingsModal.classList.add('hidden'); // Hide admin settings\r\n        eventListModal.classList.remove('hidden'); // Show event list\r\n    }\r\n    // --- END NEW FUNCTION ---\r\n\r\n    // --- NEW FUNCTION: Load available screensaver images ---\r\n    async function loadScreensaverImages() {\r\n        try {\r\n            // Try to load images.json file first (recommended method)\r\n            const response = await fetch('source/screensaver/images.json');\r\n            if (response.ok) {\r\n                const data = await response.json();\r\n                if (data.images && Array.isArray(data.images) && data.images.length > 0) {\r\n                    console.log('Loaded images from images.json:', data.images);\r\n                    return ['None', ...data.images];\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.log('images.json not found, trying directory listing...');\r\n        }\r\n        \r\n        // Fallback: Try directory listing (may not work on all servers)\r\n        try {\r\n            const response = await fetch('source/screensaver/');\r\n            if (response.ok) {\r\n                const text = await response.text();\r\n                const imageRegex = /<a href=\"([^\"]+\\.(?:jpg|jpeg|png|gif|webp))\"/gi;\r\n                const matches = [...text.matchAll(imageRegex)];\r\n                const images = matches.map(match => match[1]);\r\n                \r\n                if (images.length > 0) {\r\n                    console.log('Loaded images from directory listing:', images);\r\n                    return ['None', ...images];\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.log('Directory listing not available');\r\n        }\r\n        \r\n        // Final fallback: Return default list\r\n        console.warn('Using default image list - please create source/screensaver/images.json');\r\n        return ['None', 'Trophy.jpg', 'Potjiekos.jpg', 'Tennis.jpg', 'Braai.jpg', 'Rugby.jpg', 'F1.jpg', 'ClubChamps.jpg'];\r\n    }\r\n\r\n    // --- NEW FUNCTION: Populate image dropdowns ---\r\n    async function populateImageDropdowns() {\r\n        const images = await loadScreensaverImages();\r\n        \r\n        const dropdown1 = document.getElementById('event-image1');\r\n        const dropdown2 = document.getElementById('event-image2');\r\n        \r\n        if (dropdown1 && dropdown2) {\r\n            // Save current selections\r\n            const currentValue1 = dropdown1.value;\r\n            const currentValue2 = dropdown2.value;\r\n            \r\n            // Clear and repopulate\r\n            dropdown1.innerHTML = '';\r\n            dropdown2.innerHTML = '';\r\n            \r\n            images.forEach(img => {\r\n                const option1 = document.createElement('option');\r\n                option1.value = img;\r\n                option1.textContent = img === 'None' ? 'None' : img.replace(/\\.[^.]+$/, ''); // Remove extension for display\r\n                dropdown1.appendChild(option1);\r\n                \r\n                const option2 = document.createElement('option');\r\n                option2.value = img;\r\n                option2.textContent = img === 'None' ? 'None' : img.replace(/\\.[^.]+$/, '');\r\n                dropdown2.appendChild(option2);\r\n            });\r\n            \r\n            // Restore selections if they still exist\r\n            if ([...dropdown1.options].some(opt => opt.value === currentValue1)) {\r\n                dropdown1.value = currentValue1;\r\n            }\r\n            if ([...dropdown2.options].some(opt => opt.value === currentValue2)) {\r\n                dropdown2.value = currentValue2;\r\n            }\r\n        }\r\n    }\r\n    // --- END NEW FUNCTIONS ---\r\n\r\n    // --- NEW/MODIFIED FUNCTION: Show Event Create/Edit Modal ---\r\n    async function showEventCreateEditModal(eventId = null) {\r\n        const modal = document.getElementById('event-create-edit-modal');\r\n        \r\n        // Populate image dropdowns with available files\r\n        await populateImageDropdowns();\r\n        const title = document.getElementById('event-modal-title');\r\n        const form = modal.querySelector('.event-form-grid');\r\n        const interestedSection = document.getElementById('interested-players-section');\r\n        const interestedList = document.getElementById('interested-players-list');\r\n\r\n        // Reset form fields\r\n        form.querySelectorAll('input, select').forEach(el => {\r\n            if (el.type === 'checkbox' || el.type === 'radio') {\r\n                el.checked = false;\r\n            } else if (el.type === 'range') {\r\n                el.value = el.min || 0; // Reset sliders to min\r\n            } else {\r\n                el.value = '';\r\n            }\r\n        });\r\n        // Reset specific defaults\r\n        document.getElementById('event-type').value = 'Social';\r\n        document.querySelector('input[name=\"event-open-to\"][value=\"All Members\"]').checked = true;\r\n        document.getElementById('event-image1').value = 'None';\r\n        document.getElementById('event-image2').value = 'None';\r\n         // Clear interested list\r\n        interestedList.innerHTML = '';\r\n        interestedSection.style.display = 'none';\r\n\r\n\r\n        if (eventId) {\r\n            // --- EDIT MODE ---\r\n            const event = state.events.find(ev => ev.id == eventId);\r\n            if (!event) {\r\n                console.error(\"Event not found for editing:\", eventId);\r\n                // Optionally show event list modal again or an error\r\n                showEventListModal();\r\n                return;\r\n            }\r\n\r\n            modal.dataset.editingEventId = eventId; // Store ID for saving\r\n            title.textContent = 'Edit Event';\r\n\r\n            // Populate form fields\r\n            document.getElementById('event-type').value = event.eventType || 'Social';\r\n            document.getElementById('event-heading').value = event.heading || '';\r\n            document.getElementById('event-date').value = event.eventDate || '';\r\n            document.getElementById('event-rsvp-date').value = event.rsvpDate || '';\r\n            document.getElementById('event-start-time').value = event.startTime || '';\r\n            document.getElementById('event-body1').value = event.body1 || '';\r\n            document.getElementById('event-body2').value = event.body2 || '';\r\n            document.getElementById('event-cost-adult').value = event.costAdult || 0;\r\n            document.getElementById('event-cost-child').value = event.costChild || 0;\r\n            document.getElementById('event-participation-discount').value = event.participationDiscount || event.participationDiscountPercent || 0;\r\n            document.getElementById('event-volunteers').checked = event.volunteersNeeded || false;\r\n            document.getElementById('event-phone').value = event.phone || '';\r\n            document.getElementById('event-email').value = event.email || '';\r\n            document.getElementById('event-website').value = event.website || '';\r\n            const openToRadio = form.querySelector(`input[name=\"event-open-to\"][value=\"${event.openTo || 'All Members'}\"]`);\r\n            if (openToRadio) openToRadio.checked = true;\r\n            document.getElementById('event-open-guests').checked = event.isOpenToGuests || false;\r\n            document.getElementById('event-image1').value = event.image1Filename || 'None';\r\n            document.getElementById('event-image2').value = event.image2Filename || 'None';\r\n\r\n            // Populate Interested Players List\r\n            event.interestedPlayers = event.interestedPlayers || []; // Ensure array exists\r\n            if (event.interestedPlayers.length > 0) {\r\n                event.interestedPlayers.forEach(playerName => {\r\n                    const li = document.createElement('li');\r\n                    li.innerHTML = `\r\n                        <span>${playerName}</span>\r\n                        <span class=\"action-icon remove\" data-player-name=\"${playerName}\" title=\"Remove player\">&times;</span>\r\n                    `;\r\n                    interestedList.appendChild(li);\r\n                });\r\n                interestedSection.style.display = 'block'; // Show the section\r\n            } else {\r\n                 interestedList.innerHTML = '<li style=\"color: var(--neutral-color); justify-content: center;\">No players currently interested.</li>';\r\n                 interestedSection.style.display = 'block'; // Still show section, but with message\r\n            }\r\n\r\n\r\n        } else {\r\n            // --- CREATE MODE ---\r\n            delete modal.dataset.editingEventId; // Ensure no ID is stored\r\n            title.textContent = 'Create New Event';\r\n            interestedSection.style.display = 'none'; // Hide interested list\r\n        }\r\n\r\n        // Update slider display values\r\n        updateAllSliderDisplays();\r\n\r\n\r\n        modal.classList.remove('hidden');\r\n    }\r\n    // --- END NEW/MODIFIED FUNCTION ---\r\n\r\n\r\n    // --- NEW HELPER: Update Slider Value Displays ---\r\n   function updateSliderDisplay(sliderId) {\r\n       const slider = document.getElementById(sliderId);\r\n       const displaySpan = slider.previousElementSibling?.querySelector('.slider-value'); // Find span in label before slider\r\n       if (!slider || !displaySpan) return;\r\n\r\n       let prefix = '';\r\n       let suffix = '';\r\n       if (sliderId.includes('cost')) prefix = 'R';\r\n       if (sliderId.includes('discount')) suffix = '%';\r\n\r\n       displaySpan.textContent = `${prefix}${slider.value}${suffix}`;\r\n   }\r\n\r\n    // --- NEW HELPER: Update All Sliders ---\r\n    function updateAllSliderDisplays() {\r\n        updateSliderDisplay('event-cost-adult');\r\n        updateSliderDisplay('event-cost-child');\r\n        updateSliderDisplay('event-participation-discount');\r\n    }\r\n   // --- END NEW HELPERS ---\r\n\r\n    // --- NEW FUNCTION: Remove player from interest list (Admin) ---\r\n    function removeInterestedPlayer(playerName, eventId) {\r\n        if (!playerName || !eventId) return;\r\n\r\n        const event = state.events.find(ev => ev.id == eventId);\r\n        if (event && event.interestedPlayers) {\r\n            const initialLength = event.interestedPlayers.length;\r\n            event.interestedPlayers = event.interestedPlayers.filter(p => p !== playerName);\r\n\r\n            if (event.interestedPlayers.length < initialLength) {\r\n                saveState();\r\n                // Re-render just the interested list within the modal\r\n                const interestedList = document.getElementById('interested-players-list');\r\n                interestedList.innerHTML = ''; // Clear\r\n                if (event.interestedPlayers.length > 0) {\r\n                    event.interestedPlayers.forEach(pName => {\r\n                         const li = document.createElement('li');\r\n                         li.innerHTML = `\r\n                            <span>${pName}</span>\r\n                            <span class=\"action-icon remove\" data-player-name=\"${pName}\" title=\"Remove player\">&times;</span>\r\n                         `;\r\n                         interestedList.appendChild(li);\r\n                    });\r\n                } else {\r\n                     interestedList.innerHTML = '<li style=\"color: var(--neutral-color); justify-content: center;\">No players currently interested.</li>';\r\n                }\r\n\r\n                console.log(`${playerName} removed from interest list for event ID ${eventId}`);\r\n            }\r\n        }\r\n    }\r\n    // --- END NEW FUNCTION ---\r\n\r\n    // --- NEW FUNCTION: Save Event (Create or Update) ---\r\n    function saveEvent() {\r\n        const modal = document.getElementById('event-create-edit-modal');\r\n        const eventIdToEdit = modal.dataset.editingEventId;\r\n        const isEditing = !!eventIdToEdit;\r\n\r\n        // --- Gather data from form fields ---\r\n        const eventType = document.getElementById('event-type').value;\r\n        const heading = document.getElementById('event-heading').value.trim();\r\n        const eventDate = document.getElementById('event-date').value;\r\n        const rsvpDate = document.getElementById('event-rsvp-date').value;\r\n        const startTime = document.getElementById('event-start-time').value;\r\n        const body1 = document.getElementById('event-body1').value.trim();\r\n        const body2 = document.getElementById('event-body2').value.trim();\r\n        const costAdult = parseInt(document.getElementById('event-cost-adult').value, 10) || 0;\r\n        const costChild = parseInt(document.getElementById('event-cost-child').value, 10) || 0;\r\n        let participationDiscountPercent = 0;\r\n         if (eventType === 'Club Champs' || eventType === 'League') {\r\n             participationDiscountPercent = parseInt(document.getElementById('event-participation-discount').value, 10) || 0;\r\n         }\r\n        const volunteersNeeded = document.getElementById('event-volunteers').checked;\r\n        const phone = document.getElementById('event-phone').value.trim();\r\n        const email = document.getElementById('event-email').value.trim();\r\n        const website = document.getElementById('event-website').value.trim();\r\n        const openToRadio = modal.querySelector('input[name=\"event-open-to\"]:checked');\r\n        const openTo = openToRadio ? openToRadio.value : 'All Members'; // Default if none selected\r\n        const isOpenToGuests = document.getElementById('event-open-guests').checked;\r\n        const image1Filename = document.getElementById('event-image1').value;\r\n        const image2Filename = document.getElementById('event-image2').value;\r\n\r\n        // Basic Validation (e.g., heading is required)\r\n        if (!heading) {\r\n            alert(\"Please enter an Event Heading.\");\r\n            return; // Stop saving\r\n        }\r\n         if (!eventDate) {\r\n             alert(\"Please select an Event Date.\");\r\n             return;\r\n         }\r\n\r\n\r\n        // --- Create or Update Event Object ---\r\n        let eventData = {\r\n            eventType,\r\n            heading,\r\n            eventDate,\r\n            rsvpDate,\r\n            startTime,\r\n            body1,\r\n            body2,\r\n            costAdult,\r\n            costChild,\r\n            participationDiscountPercent,\r\n            participationDiscount: parseInt(document.getElementById('event-participation-discount').value, 10) || 0,\r\n            volunteersNeeded,\r\n            phone,\r\n            email,\r\n            website,\r\n            openTo,\r\n            isOpenToGuests,\r\n            image1Filename,\r\n            image2Filename,\r\n            // isActive and interestedPlayers handled below\r\n        };\r\n\r\n        if (isEditing) {\r\n            // Find existing event and update it\r\n            const eventIndex = state.events.findIndex(ev => ev.id == eventIdToEdit);\r\n            if (eventIndex > -1) {\r\n                // Merge new data, preserving ID, active status, and interested players\r\n                state.events[eventIndex] = {\r\n                    ...state.events[eventIndex], // Keep existing id, isActive, interestedPlayers\r\n                    ...eventData // Overwrite with new form data\r\n                };\r\n                console.log(\"Event updated:\", eventIdToEdit);\r\n            } else {\r\n                console.error(\"Failed to find event to update:\", eventIdToEdit);\r\n                return; // Stop if event not found\r\n            }\r\n        } else {\r\n            // Create new event\r\n            eventData.id = Date.now(); // Generate unique ID\r\n            eventData.isActive = false; // New events default to inactive\r\n            eventData.interestedPlayers = []; // Initialize empty interest list\r\n            state.events.push(eventData);\r\n            console.log(\"New event created:\", eventData.id);\r\n        }\r\n\r\n        // --- Finish Up ---\r\n        saveState(); // Save the updated events array\r\n        modal.classList.add('hidden'); // Hide the create/edit modal\r\n        showEventListModal(); // Show the updated event list\r\n\r\n        // If screensaver is running, stop and reset to reflect potential changes\r\n         if (!screensaverOverlay.classList.contains('hidden')) {\r\n             stopScreensaver();\r\n             resetInactivityTimer();\r\n         }\r\n    }\r\n    // --- END NEW FUNCTION ---\r\n\r\n    function resetInactivityTimer() {\r\n        // Always clear any existing timer first\r\n        clearTimeout(inactivityTimer);\r\n        inactivityTimer = null; // Clear the timer ID\r\n\r\n        // Check if there are any active events\r\n        const hasActiveEvents = state.events.some(event => event.isActive);\r\n\r\n        // Only start the inactivity timer if there's at least one active event\r\n        // AND we are not on mobile (screensaver disabled on mobile)\r\n        if (hasActiveEvents && window.innerWidth > 900) {\r\n            // console.log(\"Resetting inactivity timer (active events found)...\"); // Optional logging\r\n            // Set the timeout again for 5 minutes (INACTIVITY_TIMEOUT_MS is already defined as 5 * 60 * 1000)\r\n            inactivityTimer = setTimeout(startScreensaver, INACTIVITY_TIMEOUT_MS);\r\n        } else {\r\n            // console.log(\"Inactivity timer NOT reset (no active events or mobile view).\"); // Optional logging\r\n            // Ensure screensaver is stopped if it somehow got started without active events\r\n            stopScreensaver(); // Call stopScreensaver here to ensure it's hidden if conditions aren't met\r\n        }\r\n    }\r\n    // --- END: Screensaver Functions ---\r\n    // --- NEW: Screensaver Activity Listeners ---\r\n    document.addEventListener('click', resetInactivityTimer);\r\n    document.addEventListener('touchstart', resetInactivityTimer);\r\n    document.addEventListener('mousemove', resetInactivityTimer);\r\n    document.addEventListener('keydown', resetInactivityTimer);\r\n    // Call it once on load to start the timer initially if conditions are met\r\n    resetInactivityTimer();\r\n\r\n    /* =================================\r\n        END Screensaver FUNCTIONS (NEW)\r\n    ================================= */\r\n\r\n    \r\n    function renderReorderHistory() {\r\n        reorderHistoryList.innerHTML = \"\";\r\n        \r\n        if (state.reorderHistory.length === 0) {\r\n            reorderHistoryList.innerHTML = '<p style=\"text-align: center; color: #6c757d; padding: 2rem;\">No queue reorder actions have been logged.</p>';\r\n            return;\r\n        }\r\n\r\n        // Iterate through history, newest first\r\n        [...state.reorderHistory].reverse().forEach(entry => {\r\n            const dateTime = new Date(entry.endTime).toLocaleString();\r\n            let playersHtml = '';\r\n\r\n            // Iterate through players involved in this session\r\n            for (const [name, log] of Object.entries(entry.players)) {\r\n                // Only display players who actually moved (start position !== current position)\r\n                if (log.startPosition !== log.currentPosition) {\r\n                    playersHtml += `\r\n                        <p style=\"margin: 0.25rem 0; font-size: 0.95rem; display: flex; justify-content: space-between;\">\r\n                            <span style=\"font-weight: 500;\">${name}</span>\r\n                            <span style=\"color: var(--primary-blue);\">Moved from #${log.startPosition + 1} to #${log.currentPosition + 1}</span>\r\n                        </p>\r\n                    `;\r\n                }\r\n            }\r\n\r\n            // Only render the entry if at least one player moved\r\n            if (playersHtml) {\r\n                const details = document.createElement('div');\r\n                details.className = 'history-item';\r\n                details.style.textAlign = 'left';\r\n                details.innerHTML = `\r\n                    <div class=\"history-details\" style=\"margin-bottom: 0.75rem;\">\r\n                        <span style=\"color: var(--primary-blue);\">${entry.adminAction} (${dateTime})</span>\r\n                    </div>\r\n                    <div style=\"padding-left: 1rem;\">\r\n                        ${playersHtml}\r\n                    </div>\r\n                `;\r\n                reorderHistoryList.appendChild(details);\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- ADMIN MANAGEMENT FUNCTIONS (REFACTORED FOR 3-CARD FLOW) ---\r\n\r\n    // Card 1: Court Selection View\r\n    function showCourtSelectionCard() {\r\n        const { adminCourtManagement } = state;\r\n        \r\n        // Reset temporary state and mode\r\n        adminCourtManagement.mode = 'card1_select_court';\r\n        adminCourtManagement.courtId = null;\r\n        adminCourtManagement.currentCourtPlayers = [];\r\n        adminCourtManagement.removedPlayers = [];\r\n        adminCourtManagement.addedPlayers = [];\r\n        \r\n        document.getElementById('manage-court-players-instructions').textContent = \"Select a court with an active game.\";\r\n        \r\n        // Set data attribute for CSS\r\n        manageModalActions.dataset.cardMode = 'card1';\r\n\r\n        // Show Card 1 list, hide Card 2 & 3 lists\r\n        courtListForManagement.classList.remove('hidden');\r\n        removePlayersList.classList.add('hidden');\r\n        addPlayersList.classList.add('hidden');\r\n\r\n        // Button visibility for Card 1\r\n        managePlayersBackBtn.classList.add('hidden');\r\n        managePlayersAddBtn.classList.add('hidden');\r\n        managePlayersConfirmBtn.classList.add('hidden');\r\n        managePlayersCloseBtn.textContent = 'Close';\r\n        \r\n        courtListForManagement.innerHTML = '';\r\n        const activeCourts = state.courts.filter(c => c.status === 'in_progress' && state.courtSettings.visibleCourts.includes(c.id));\r\n\r\n        if (activeCourts.length === 0) {\r\n            courtListForManagement.innerHTML = '<li style=\"justify-content: center; color: #6c757d;\">No games are currently in progress on visible courts.</li>';\r\n        } else {\r\n            activeCourts.forEach(court => {\r\n                const li = document.createElement('li');\r\n                li.className = 'court-select-item';\r\n                const playerNames = getPlayerNames(court.players).map(name => name.split(' ')[0]).join(' / ');\r\n                li.innerHTML = `\r\n                    <span style=\"flex-grow: 1;\">Court ${court.id}</span>\r\n                    <span style=\"margin-right: 1rem; color: #6c757d; font-size: 0.9em;\">(${playerNames})</span>\r\n                    <span class=\"action-icon add\" data-court-id=\"${court.id}\" data-action=\"select-court\" style=\"font-size: 1.2rem;\">&gt;</span>\r\n                `;\r\n                courtListForManagement.appendChild(li);\r\n            });\r\n        }\r\n\r\n        adminSettingsModal.classList.add('hidden');\r\n        manageCourtPlayersModal.classList.remove('hidden');\r\n    }\r\n\r\n    // Original entry point, now just calls Card 1 function\r\n    function showManageCourtPlayersModal(courtId) { // --- Now accepts courtId ---\r\n        // 1. Safety check for any pending additions from a previous unfinished session\r\n        const { addedPlayers } = state.adminCourtManagement;\r\n        if (addedPlayers.length > 0) {\r\n            state.availablePlayers = [...addedPlayers, ...state.availablePlayers];\r\n            state.adminCourtManagement.addedPlayers = [];\r\n        }\r\n        \r\n        // 2. Clear any old state before starting\r\n        state.adminCourtManagement = {\r\n            mode: 'card1_select_court', // Keep this for reset purposes\r\n            courtId: null,\r\n            currentCourtPlayers: [], \r\n            removedPlayers: [], \r\n            addedPlayers: [] \r\n        };\r\n\r\n        // 3. Directly call the function to show the \"Remove Players\" card\r\n        showRemovePlayerCard(courtId);\r\n        \r\n        // 4. Show the main modal container\r\n        manageCourtPlayersModal.classList.remove('hidden');\r\n    }\r\n\r\n    // Card 2: Remove Player View\r\n    function showRemovePlayerCard(courtId) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court || court.status !== 'in_progress') {\r\n            return showCourtSelectionCard();\r\n        }\r\n        \r\n        const { adminCourtManagement } = state;\r\n        \r\n        // Initialize/switch to Card 2 mode\r\n        adminCourtManagement.mode = 'card2_remove_players';\r\n        adminCourtManagement.courtId = courtId;\r\n        \r\n        // If coming from Card 1 (no players loaded yet), set the initial list\r\n        if (adminCourtManagement.currentCourtPlayers.length === 0) {\r\n            // Deep copy of player objects to manipulate locally\r\n            adminCourtManagement.currentCourtPlayers = JSON.parse(JSON.stringify(court.players));\r\n        }\r\n        \r\n        // Update header text based on game mode\r\n        const headerText = court.gameMode === 'doubles' \r\n            ? `Court ${courtId}: Manage Players` \r\n            : `Court ${courtId}: Remove players from the game.`;\r\n        document.getElementById('manage-court-players-instructions').textContent = headerText;\r\n        \r\n        // Add action buttons to the main modal header\r\n        const modalHeader = manageCourtPlayersModal.querySelector('.modal-header-with-actions h3');\r\n        if (modalHeader) {\r\n            // Remove any existing action buttons\r\n            const existingSwapBtn = manageCourtPlayersModal.querySelector('.header-swap-player-btn');\r\n            const existingTeamBtn = manageCourtPlayersModal.querySelector('.header-team-select-btn');\r\n            if (existingSwapBtn) existingSwapBtn.remove();\r\n            if (existingTeamBtn) existingTeamBtn.remove();\r\n            \r\n            // Create button container\r\n            const buttonContainer = document.createElement('div');\r\n            buttonContainer.className = 'modal-header-actions';\r\n            \r\n            // Add swap player button (always visible for in-progress games)\r\n            const swapBtn = document.createElement('button');\r\n            swapBtn.className = 'header-swap-player-btn';\r\n            swapBtn.title = 'Swap with Player on Another Court';\r\n            swapBtn.innerHTML = '<i class=\"mdi mdi-account-switch\"></i>';\r\n            swapBtn.onclick = () => {\r\n                showSwapPlayerModal(courtId);\r\n            };\r\n            buttonContainer.appendChild(swapBtn);\r\n            \r\n            // Add team selection button (only for doubles)\r\n            if (court.gameMode === 'doubles') {\r\n                const teamSelectBtn = document.createElement('button');\r\n                teamSelectBtn.className = 'header-team-select-btn';\r\n                teamSelectBtn.title = court.teamsSet ? 'Reselect Teams' : 'Set Teams';\r\n                teamSelectBtn.innerHTML = '<i class=\"mdi mdi-account-group-outline\"></i>';\r\n                teamSelectBtn.onclick = () => {\r\n                    manageCourtPlayersModal.classList.add('hidden');\r\n                    handleChooseTeams(courtId, 'in_progress');\r\n                };\r\n                buttonContainer.appendChild(teamSelectBtn);\r\n            }\r\n            \r\n            // Append button container to header\r\n            modalHeader.parentElement.appendChild(buttonContainer);\r\n        }\r\n        \r\n        // Set data attribute for CSS\r\n        manageModalActions.dataset.cardMode = 'card2';\r\n\r\n        // Hide all lists except Card 2 list\r\n        courtListForManagement.classList.add('hidden');\r\n        removePlayersList.classList.remove('hidden');\r\n        addPlayersList.classList.add('hidden');\r\n        \r\n        // Button visibility for Card 2\r\n        managePlayersBackBtn.classList.remove('hidden'); // Back to Card 1\r\n        managePlayersAddBtn.classList.remove('hidden'); // Go to Card 3\r\n        managePlayersConfirmBtn.classList.add('hidden');\r\n        managePlayersCloseBtn.textContent = 'Close'; \r\n        \r\n        // Enable/Disable Add Player button based on changes\r\n        const hasChanges = adminCourtManagement.removedPlayers.length > 0 || adminCourtManagement.addedPlayers.length > 0;\r\n        managePlayersAddBtn.disabled = !hasChanges;\r\n        managePlayersAddBtn.style.backgroundColor = hasChanges ? 'var(--confirm-color)' : 'var(--neutral-color)';\r\n        \r\n        renderRemovePlayersList(courtId);\r\n    }\r\n    function renderRemovePlayersList(courtId) {\r\n        const { currentCourtPlayers, removedPlayers } = state.adminCourtManagement;\r\n        \r\n        removePlayersList.innerHTML = '';\r\n        \r\n        // 1. Render players still on the court (currentCourtPlayers - removedPlayers)\r\n        // Find which players are on court (currentCourtPlayers) but NOT in the removed list\r\n        const playersOnCourt = currentCourtPlayers.filter(p => !removedPlayers.some(rp => rp.name === p.name));\r\n\r\n        if (playersOnCourt.length === 0 && removedPlayers.length === 0) {\r\n             removePlayersList.innerHTML = '<li style=\"justify-content: center; color: var(--cancel-color);\">No players remaining. Must add players or go back.</li>';\r\n        } else {\r\n            playersOnCourt.forEach(player => {\r\n                const li = document.createElement('li');\r\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\r\n                li.innerHTML = `\r\n                    <span style=\"flex-grow: 1;\">${displayName}</span>\r\n                    <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span>\r\n                    <span class=\"action-icon remove\" data-player=\"${player.name}\" data-court-id=\"${courtId}\" data-action=\"remove-player-temp\" title=\"Remove Player\">&times;</span>\r\n                `;\r\n                removePlayersList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        // 2. Render temporary removed players in the main list.\r\n        if (removedPlayers.length > 0) {\r\n            removePlayersList.innerHTML += '<li style=\"justify-content: center; background-color: #f0f0f0; margin-top: 1rem; color: var(--dark-text); font-weight: 500;\">Removed Players (Click '+' to return to court):</li>';\r\n            removedPlayers.forEach(player => {\r\n                const li = document.createElement('li');\r\n                li.style.backgroundColor = '#fbe9eb';\r\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\r\n                li.innerHTML = `\r\n                    <span style=\"flex-grow: 1; color: var(--cancel-color); font-weight: 500;\">${displayName}</span>\r\n                    <span class=\"action-icon add\" data-player=\"${player.name}\" data-court-id=\"${courtId}\" data-action=\"return-player-temp\" title=\"Keep on Court\">+</span>\r\n                `;\r\n                removePlayersList.appendChild(li);\r\n            });\r\n        }\r\n    }\r\n\r\n    // Card 3: Add Player View\r\n    function showAddPlayerCard(courtId) {\r\n        const { adminCourtManagement } = state;\r\n\r\n        // Switch to Card 3 mode\r\n        adminCourtManagement.mode = 'card3_add_players';\r\n        \r\n        document.getElementById('manage-court-players-instructions').textContent = `Court ${courtId}: Select player(s) to add (Max 7 available).`;\r\n        \r\n        // Set data attribute for CSS\r\n        manageModalActions.dataset.cardMode = 'card3';\r\n\r\n        // Hide all lists except Card 3 list\r\n        courtListForManagement.classList.add('hidden');\r\n        removePlayersList.classList.add('hidden');\r\n        addPlayersList.classList.remove('hidden');\r\n        \r\n        // Button visibility for Card 3\r\n        managePlayersBackBtn.classList.remove('hidden'); // Back to Card 2\r\n        managePlayersAddBtn.classList.add('hidden');\r\n        managePlayersConfirmBtn.classList.remove('hidden'); // Confirm button is here\r\n        managePlayersCloseBtn.textContent = 'Close'; \r\n\r\n        renderAddPlayersList(courtId);\r\n    }\r\n\r\n    function renderAddPlayersList(courtId) {\r\n        const { addedPlayers, removedPlayers } = state.adminCourtManagement;\r\n        addPlayersList.innerHTML = '';\r\n\r\n        // We'll show the top 7 available players as potential additions.\r\n        const availableForAdding = state.availablePlayers.slice(0, 7);\r\n            \r\n        if (availableForAdding.length === 0) {\r\n            addPlayersList.innerHTML = '<li style=\"justify-content: center; color: #6c757d;\">No players are currently available to add.</li>';\r\n        } else {\r\n            availableForAdding.forEach(player => {\r\n                const isAlreadyAdded = addedPlayers.some(ap => ap.name === player.name);\r\n                const li = document.createElement('li');\r\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\r\n\r\n                if (isAlreadyAdded) {\r\n                    // Style for players who are marked to be added\r\n                    li.style.backgroundColor = 'var(--light-blue)';\r\n                    li.innerHTML = `\r\n                        <span style=\"flex-grow: 1; color: var(--primary-blue); font-weight: 500;\">${displayName}</span>\r\n                        <span class=\"action-icon remove\" data-player=\"${player.name}\" data-court-id=\"${courtId}\" data-action=\"undo-add-player-temp\" title=\"Undo Add\">&times;</span>\r\n                    `;\r\n                } else {\r\n                    // Style for players who are available to be added\r\n                    li.innerHTML = `\r\n                        <span style=\"flex-grow: 1;\">${displayName}</span>\r\n                        <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span>\r\n                        <span class=\"action-icon add\" data-player=\"${player.name}\" data-court-id=\"${courtId}\" data-action=\"add-player-temp\" title=\"Add Player\">+</span>\r\n                    `;\r\n                }\r\n                addPlayersList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        // Enable the confirm button only if there are changes to be made\r\n        const hasChanges = addedPlayers.length > 0 || removedPlayers.length > 0;\r\n        managePlayersConfirmBtn.disabled = !hasChanges;\r\n        managePlayersConfirmBtn.style.backgroundColor = hasChanges ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n        managePlayersConfirmBtn.style.borderColor = hasChanges ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n\r\n    // --- Navigation/Action Handlers ---\r\n\r\n    // Handles Close button on Card 1, 2, or 3\r\n    function handleManageClose() {\r\n        // Simply reset the temporary state and close the modal.\r\n        // No players need to be returned to the queue as they were never removed.\r\n        state.adminCourtManagement = {\r\n            mode: 'card1_select_court',\r\n            courtId: null,\r\n            currentCourtPlayers: [], \r\n            removedPlayers: [], \r\n            addedPlayers: [] \r\n        };\r\n        \r\n        manageCourtPlayersModal.classList.add('hidden');\r\n        updateGameModeBasedOnPlayerCount();\r\n        render();\r\n        saveState();\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n    // Handles Back button on Card 2 (to Card 1) or Card 3 (to Card 2)\r\n    function handleManageBack() {\r\n        const { mode, courtId } = state.adminCourtManagement;\r\n        \r\n        if (mode === 'card2_remove_players') {\r\n            // Back from \"Remove\" to \"Select Court\". All temporary changes are discarded.\r\n            showCourtSelectionCard();\r\n        } else if (mode === 'card3_add_players') {\r\n            // Back from \"Add\" to \"Remove\". Discard only the 'added' players list.\r\n            state.adminCourtManagement.addedPlayers = [];\r\n            showRemovePlayerCard(courtId);\r\n        }\r\n        \r\n        updateGameModeBasedOnPlayerCount();\r\n        render();\r\n        saveState();\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n    // Handles Confirm button on Card 3 (Final Save)\r\n    function handleManageConfirm() {\r\n        const { courtId, removedPlayers, addedPlayers } = state.adminCourtManagement;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court || court.status !== 'in_progress') {\r\n            return handleManageClose();\r\n        }\r\n\r\n        // (Position-Aware Swap Logic and Queue Swap Logic remain the same...)\r\n        let newCourtPlayers = [...court.players];\r\n        const removedPlayerNames = new Set(removedPlayers.map(p => p.name));\r\n        let playersToAdd = [...addedPlayers]; \r\n        const vacantIndices = [];\r\n        newCourtPlayers.forEach((player, index) => {\r\n            if (removedPlayerNames.has(player.name)) {\r\n                vacantIndices.push(index);\r\n            }\r\n        });\r\n        vacantIndices.forEach(index => {\r\n            if (playersToAdd.length > 0) {\r\n                newCourtPlayers[index] = playersToAdd.shift();\r\n            } else {\r\n                newCourtPlayers[index] = null;\r\n            }\r\n        });\r\n        newCourtPlayers = newCourtPlayers.filter(p => p !== null);\r\n        if (playersToAdd.length > 0) {\r\n            newCourtPlayers.push(...playersToAdd);\r\n        }\r\n        let playersToRequeueInQueue = [...removedPlayers];\r\n        const addedPlayerNamesInQueue = new Set(addedPlayers.map(p => p.name));\r\n        let newAvailablePlayers = state.availablePlayers.map(playerInQueue => {\r\n            if (addedPlayerNamesInQueue.has(playerInQueue.name)) {\r\n                if (playersToRequeueInQueue.length > 0) {\r\n                    return playersToRequeueInQueue.shift();\r\n                } else {\r\n                    return null;\r\n                }\r\n            }\r\n            return playerInQueue;\r\n        });\r\n        newAvailablePlayers = newAvailablePlayers.filter(p => p !== null);\r\n        if (playersToRequeueInQueue.length > 0) {\r\n            newAvailablePlayers.push(...playersToRequeueInQueue);\r\n        }\r\n        state.availablePlayers = newAvailablePlayers;\r\n        \r\n        // --- UPDATED ANNOUNCEMENT LOGIC ---\r\n        const newGameMode = newCourtPlayers.length === 2 ? 'singles' : 'doubles';\r\n        \r\n        // Use the new helper function here\r\n        const formattedCourtId = formatCourtIdForTTS(courtId);\r\n\r\n        if (newCourtPlayers.length < 2) {\r\n            if(court.autoStartTimer) clearTimeout(court.autoStartTimer);\r\n            state.availablePlayers.push(...court.players.filter(p => !p.guest));\r\n            court.becameAvailableAt = Date.now();\r\n            court.status = \"available\";\r\n            court.players = [];\r\n            court.teams = {team1:[], team2:[]};\r\n            court.gameMode = null;\r\n            court.gameStartTime = null;\r\n            playCustomTTS(`Attention: Game on Court ${formattedCourtId} has been cancelled due to insufficient players.`);\r\n        } else {\r\n            court.gameMode = newGameMode;\r\n            court.players = newCourtPlayers;\r\n            if (newGameMode === 'singles') {\r\n                court.teams.team1 = [newCourtPlayers[0]];\r\n                court.teams.team2 = [newCourtPlayers[1]];\r\n            } else {\r\n                const teamSize = Math.ceil(newCourtPlayers.length / 2);\r\n                court.teams.team1 = newCourtPlayers.slice(0, teamSize);\r\n                court.teams.team2 = newCourtPlayers.slice(teamSize);\r\n            }\r\n\r\n            const removedNamesStr = removedPlayers.map(p => p.name).join(' and ');\r\n            const addedNamesStr = addedPlayers.map(p => p.name).join(' and ');\r\n\r\n            let announcementPart1 = `Attention on Court ${formattedCourtId}. Player substitution complete.`;\r\n            let announcementPart2 = null;\r\n\r\n            if (removedPlayers.length > 0 && addedPlayers.length > 0) {\r\n                announcementPart2 = `${addedNamesStr} will be filling in for ${removedNamesStr}.`;\r\n            } else if (removedPlayers.length > 0) {\r\n                announcementPart1 = `Attention on Court ${formattedCourtId}: ${removedNamesStr} have left the game.`;\r\n            } else if (addedPlayers.length > 0) {\r\n                announcementPart1 = `Attention on Court ${formattedCourtId}: ${addedNamesStr} have joined the game.`;\r\n            }\r\n            \r\n            playAlertSound(announcementPart1, announcementPart2);\r\n        }\r\n        // --- END UPDATED LOGIC ---\r\n        \r\n        state.adminCourtManagement = { mode: 'card1_select_court', courtId: null, currentCourtPlayers: [], removedPlayers: [], addedPlayers: [] };\r\n        manageCourtPlayersModal.classList.add('hidden');\r\n        \r\n        updateGameModeBasedOnPlayerCount();\r\n        enforceDutyPosition();\r\n        autoAssignCourtModes();\r\n        render();\r\n        saveState();\r\n        resetAlertSchedule();\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n\r\n    \r\n    function handleKeypadClick(e) {\r\n        const key = e.target.dataset.key;\r\n        const {\r\n            mode,\r\n            maxLength,\r\n            maxValue\r\n        } = keypadConfig;\r\n        let displayValue = (mode === 'admin' || mode === 'reset' || mode === 'undo') ? (keypadDisplay.dataset.hiddenValue || '') : keypadDisplay.textContent;\r\n\r\n        if (e.target.id === 'keypad-confirm-btn') {\r\n            if (e.target.disabled) return;\r\n\r\n            switch (mode) {\r\n                case 'admin':\r\n                    checkAdminPasscode();\r\n                    break;\r\n                case 'reset':\r\n                    checkResetPasscode();\r\n                    break;\r\n                case 'undo':\r\n                    checkUndoPasscode();\r\n                    break;\r\n                case 'addStock':\r\n                    confirmBallStockUpdate();\r\n                    break;\r\n                case 'returnStock':\r\n                    confirmBallStockReturn();\r\n                    break;\r\n                case 'returnUsed':\r\n                    confirmUsedBallReturn();\r\n                    break;\r\n                case 'signOut':\r\n                    confirmSignOutQuantity();\r\n                    break;\r\n                default:\r\n                    if (activeInput && activeInput.classList.contains('reorder-position')) {\r\n                        handleReorderPositionChange(keypadDisplay.textContent);\r\n                    } else if (activeInput) {\r\n                        activeInput.dispatchEvent(new Event('input'));\r\n                    }\r\n                    hideKeypad();\r\n                    break;\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (key === 'backspace') {\r\n            displayValue = displayValue.slice(0, -1);\r\n        } else if (key === 'clear') {\r\n            displayValue = '';\r\n        } else if (/[0-9]/.test(key)) {\r\n            if (maxLength && displayValue.length >= maxLength) {\r\n                return;\r\n            }\r\n            const potentialValue = displayValue + key;\r\n            if (maxValue !== undefined && parseInt(potentialValue, 10) > maxValue) {\r\n                return;\r\n            }\r\n            displayValue += key;\r\n        }\r\n\r\n        if (mode === 'admin' || mode === 'reset' || mode === 'undo') {\r\n            keypadDisplay.dataset.hiddenValue = displayValue;\r\n            keypadDisplay.textContent = '*'.repeat(displayValue.length);\r\n        } else {\r\n            keypadDisplay.textContent = displayValue;\r\n            if (activeInput && !activeInput.classList.contains('reorder-position')) {\r\n                activeInput.value = displayValue;\r\n                activeInput.dispatchEvent(new Event('input'));\r\n            }\r\n        }\r\n\r\n        keypadConfirmBtn.disabled = displayValue.length === 0;\r\n    }\r\n\r\n\r\n    // MODIFIED: Added data-mode to display and adjusted placeholder logic for admin mode\r\n    function showKeypad(input, config = {}) {\r\n        activeInput = input;\r\n        keypadConfig = config;\r\n        const {\r\n            mode,\r\n            title\r\n        } = config;\r\n\r\n        keypadDisplay.textContent = '';\r\n        delete keypadDisplay.dataset.hiddenValue;\r\n\r\n        if (mode === 'admin' || mode === 'reset' || mode === 'undo') {\r\n            keypadDisplay.setAttribute('data-mode', mode);\r\n            \r\n            // Don't show placeholder for undo mode\r\n            if (mode === 'undo') {\r\n                keypadDisplay.removeAttribute('data-placeholder');\r\n            } else {\r\n                keypadDisplay.setAttribute('data-placeholder', title || 'Enter PIN');\r\n            }\r\n            \r\n            keypadCancelBtn.classList.remove('hidden');\r\n            keypadConfirmBtn.classList.remove('wide-full');\r\n            keypadConfirmBtn.classList.add('wide-half');\r\n        } else {\r\n            keypadDisplay.removeAttribute('data-mode');\r\n            if (title) {\r\n                keypadDisplay.setAttribute('data-placeholder', title);\r\n            } else {\r\n                keypadDisplay.removeAttribute('data-placeholder');\r\n            }\r\n\r\n            keypadCancelBtn.classList.add('hidden');\r\n            keypadConfirmBtn.classList.remove('wide-half');\r\n            keypadConfirmBtn.classList.add('wide-full');\r\n        }\r\n\r\n        customKeypadModal.classList.remove('hidden');\r\n        keypadConfirmBtn.disabled = keypadDisplay.textContent.length === 0;\r\n    }\r\n\r\n    function hideKeypad() { customKeypadModal.classList.add('hidden'); keypadConfig = {}; activeInput = null; }\r\n\r\n    function wireScoreInputToKeypad(input, config = {}) {\r\n        input.readOnly = true;\r\n        // Remove any old listener attached to this input to prevent duplicates\r\n        if (input._keypadListener) {\r\n            input.removeEventListener('click', input._keypadListener);\r\n        }\r\n        // Define the new listener with the current game's rules\r\n        const newListener = (e) => {\r\n            e.preventDefault(); // Prevent native keyboards on mobile\r\n            showKeypad(e.target, config);\r\n        };\r\n        // Add the new listener\r\n        input.addEventListener('click', newListener);\r\n        // Store a reference to the new listener so it can be removed later\r\n        input._keypadListener = newListener;\r\n    }\r\n    // --- ALPHA KEYPAD CORE DATA (Required for alphabetical input) ---\r\n    const QWERTY_LAYOUT = [ \r\n        ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'], \r\n        ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'], \r\n        ['Z', 'X', 'C', 'V', 'B', 'N', 'M'] \r\n    ];\r\n\r\n    function generateAlphaKeypad() {\r\n        const displayValue = alphaKeypadDisplay.textContent;\r\n        alphaKeypadGrid.innerHTML = '';\r\n        \r\n        QWERTY_LAYOUT.forEach((row, index) => {\r\n            const rowDiv = document.createElement('div');\r\n            rowDiv.className = `key-row-${index + 1}`;\r\n            row.forEach(key => {\r\n                const button = document.createElement('button');\r\n                button.className = 'keypad-btn';\r\n                button.dataset.key = key;\r\n                let char = key;\r\n                if (displayValue.length === 0 || displayValue.slice(-1) === ' ') {\r\n                    char = key.toUpperCase();\r\n                } else {\r\n                    char = key.toLowerCase();\r\n                }\r\n                button.textContent = char;\r\n                rowDiv.appendChild(button);\r\n            });\r\n            alphaKeypadGrid.appendChild(rowDiv);\r\n        });\r\n\r\n        const lastRowDiv = document.createElement('div');\r\n        lastRowDiv.className = `key-row-4`;\r\n        \r\n        const spaceBtn = document.createElement('button');\r\n        spaceBtn.className = 'keypad-btn wide-control control';\r\n        spaceBtn.dataset.key = 'space';\r\n        spaceBtn.textContent = 'Space';\r\n        lastRowDiv.appendChild(spaceBtn);\r\n\r\n        const backspace = document.createElement('button');\r\n        backspace.className = 'keypad-btn control';\r\n        backspace.dataset.key = 'backspace';\r\n        backspace.textContent = '⌫';\r\n        lastRowDiv.appendChild(backspace);\r\n\r\n        const done = document.createElement('button');\r\n        done.className = 'keypad-btn wide-control confirm';\r\n        done.id = 'alpha-keypad-confirm-btn';\r\n        done.textContent = 'Done';\r\n        lastRowDiv.appendChild(done);\r\n\r\n        alphaKeypadGrid.appendChild(lastRowDiv);\r\n\r\n        document.querySelectorAll('#custom-alpha-keypad-modal .keypad-btn').forEach(button => { \r\n            button.removeEventListener('click', handleAlphaKeypadClick);\r\n            button.addEventListener('click', handleAlphaKeypadClick); \r\n        });\r\n    }\r\n    function handleAlphaKeypadClick(e) {\r\n        const key = e.target.dataset.key;\r\n        let displayValue = alphaKeypadDisplay.textContent;\r\n        if (!activeAlphaInput) return;\r\n\r\n        if (key === 'backspace') {\r\n            displayValue = displayValue.slice(0, -1);\r\n        } else if (key === 'space') {\r\n            if (displayValue.length > 0 && displayValue.slice(-1) !== ' ') {\r\n                displayValue += ' ';\r\n            }\r\n        } else if (e.target.id === 'alpha-keypad-confirm-btn') {\r\n            hideAlphaKeypad();\r\n            return;\r\n        } else {\r\n            let char = key;\r\n            if (displayValue.length === 0 || displayValue.slice(-1) === ' ') {\r\n                char = key.toUpperCase();\r\n            } else {\r\n                char = key.toLowerCase();\r\n            }\r\n            displayValue += char;\r\n        }\r\n\r\n        alphaKeypadDisplay.textContent = displayValue;\r\n        activeAlphaInput.value = displayValue;\r\n        generateAlphaKeypad(); \r\n        \r\n        // --- FIX: Manually dispatch 'input' event to trigger listeners (autofill & validation) ---\r\n        if (activeAlphaInput.closest('#new-parent-modal')) {\r\n             activeAlphaInput.dispatchEvent(new Event('input'));\r\n        }\r\n        // --- END FIX ---\r\n        \r\n        validateGuestForm();\r\n    }\r\n    \r\n    function showAlphaKeypad(input) {\r\n        activeAlphaInput = input;\r\n        alphaKeypadDisplay.textContent = activeAlphaInput.value;\r\n        generateAlphaKeypad();\r\n        customAlphaKeypadModal.classList.remove('hidden');\r\n        guestNameModal.classList.add('hidden');\r\n        \r\n        // Check if the input is a child's name field and hide the original new parent modal\r\n        if (input.closest('#new-parent-modal')) {\r\n            document.getElementById('new-parent-modal').classList.add('hidden');\r\n        }\r\n    }\r\n    function hideAlphaKeypad() {\r\n        customAlphaKeypadModal.classList.add('hidden');\r\n        // Restore the correct parent modal (either guestNameModal or newParentModal)\r\n        if (activeAlphaInput && activeAlphaInput.closest('#new-parent-modal')) {\r\n            document.getElementById('new-parent-modal').classList.remove('hidden');\r\n            \r\n            // --- FIX: Manually dispatch 'input' event on close for final validation/autofill ---\r\n            activeAlphaInput.dispatchEvent(new Event('input')); \r\n            // --- END FIX ---\r\n\r\n        } else {\r\n            guestNameModal.classList.remove('hidden');\r\n        }\r\n        activeAlphaInput = null;\r\n        validateGuestForm();\r\n    }\r\n\r\n    // --- Adjust wireGlobalKeypadToInput to store timeout ID ---\r\n    function wireGlobalKeypadToInput(input, validationCallback = null) { // Added default null\r\n        if (!input) return; // Add safety check\r\n        input.readOnly = true;\r\n\r\n        const handleClick = (e) => {\r\n            // Clear any previous timeout ID stored on this input\r\n            if (input._clickTimeoutId) {\r\n                clearTimeout(input._clickTimeoutId);\r\n            }\r\n\r\n            // Set timeout and store ID on the input element itself\r\n            input._clickTimeoutId = setTimeout(() => {\r\n                // Ensure the modal containing this input is still visible\r\n                const parentModal = input.closest('.modal-overlay');\r\n                if (parentModal && !parentModal.classList.contains('hidden')) {\r\n                    showGlobalKeyboard(input); // Pass the original input\r\n                }\r\n                input._clickTimeoutId = null; // Clear ID after execution or check\r\n            }, 150); // 150ms delay\r\n        };\r\n\r\n        // Remove previous listener if it exists\r\n        if (input._globalKeypadClickListener) {\r\n            input.removeEventListener('click', input._globalKeypadClickListener);\r\n        }\r\n        // Add the new listener\r\n        input.addEventListener('click', handleClick);\r\n        input._globalKeypadClickListener = handleClick; // Store reference\r\n\r\n        // Optional: Add input listener if validation callback provided\r\n        if (validationCallback && typeof validationCallback === 'function') {\r\n            if (input._globalKeypadInputListener) {\r\n                 input.removeEventListener('input', input._globalKeypadInputListener);\r\n            }\r\n            input.addEventListener('input', validationCallback);\r\n            input._globalKeypadInputListener = validationCallback;\r\n        }\r\n    }\r\n\r\n    function validateGuestForm() {\r\n        const name = guestNameInput.value.trim();\r\n        const surname = guestSurnameInput.value.trim();\r\n        const genderSelected = !!document.querySelector('input[name=\"guest-gender\"]:checked'); // Check if gender is selected\r\n        const ageTypeSelected = !!document.querySelector('input[name=\"age-type\"]:checked'); // *** NEW: Check if age type is selected ***\r\n        const isReady = (name.length > 0 && surname.length > 0 && genderSelected && ageTypeSelected); // *** Added ageTypeSelected ***\r\n        guestConfirmBtn.disabled = !isReady;\r\n        guestConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n        guestConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    }\r\n    // REVISED function to handle different contexts\r\n    function handleGuestCheckIn() {\r\n        const firstName = guestNameInput.value.trim();\r\n        const lastName = guestSurnameInput.value.trim();\r\n        const gender = document.querySelector('input[name=\"guest-gender\"]:checked').value;\r\n        const guestType = document.querySelector('input[name=\"player-type\"]:checked').value; // Guest or Member\r\n        const ageType = document.querySelector('input[name=\"age-type\"]:checked').value; // *** NEW: Read age type ***\r\n        const isGuest = guestType === 'guest';\r\n        const context = guestNameModal.dataset.context; // Get the context\r\n\r\n        // Always enable the 'member' radio button after use, regardless of context\r\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\r\n        if (memberRadio) memberRadio.disabled = false;\r\n\r\n\r\n        if (!firstName || !lastName) return;\r\n\r\n        const formatCase = (str) => str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');\r\n        const formattedPlayerName = `${formatCase(firstName)} ${formatCase(lastName)}`;\r\n\r\n        let playerObject;\r\n\r\n        // --- Logic based on context and player type ---\r\n        if (context === 'purchaser') {\r\n            // Purchaser flow - always treat as guest, add/update history\r\n            playerObject = { name: formattedPlayerName, gender: gender, guest: true, type: ageType, isPaused: false }; // *** Store ageType ***\r\n            updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\r\n            guestNameModal.classList.add('hidden');\r\n            delete guestNameModal.dataset.context;\r\n            confirmPurchaser(formattedPlayerName, 'new_guest');\r\n            resetGuestForm(); // Reset form after use\r\n            return; // Exit purchaser flow\r\n        }\r\n        else if (context === 'manual-entry') {\r\n            // Manual entry flow - always treat as guest, add to history AND manual selection\r\n            playerObject = { name: formattedPlayerName, gender: gender, guest: true, type: ageType, isPaused: false }; // *** Store ageType ***\r\n            updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\r\n\r\n            // Add directly to manual entry selection if not already there and space permits\r\n            if (state.manualEntry.players.length < 4 && !state.manualEntry.players.includes(playerObject.name)) {\r\n                state.manualEntry.players.push(playerObject.name);\r\n            }\r\n\r\n            guestNameModal.classList.add('hidden');\r\n            delete guestNameModal.dataset.context;\r\n            showManualPlayerSelectionModal(); // Re-show and update the manual entry modal\r\n            resetGuestForm(); // Reset form after use\r\n            saveState(); // Save guest history update\r\n            return; // Exit manual entry flow\r\n        }\r\n        else {\r\n             // Standard check-in flow\r\n             if (isGuest) {\r\n                 playerObject = { name: formattedPlayerName, gender: gender, guest: true, type: ageType, isPaused: false }; // *** Store ageType ***\r\n                 updateGuestHistory(playerObject.name, playerObject.gender); // Add/Update guest history\r\n             } else {\r\n                 // Member check-in\r\n                 playerObject = MASTER_MEMBER_LIST.find(p => p.name.toLowerCase() === formattedPlayerName.toLowerCase());\r\n                 if (playerObject) {\r\n                     // If found in master list, update its type property (if it exists) or add it\r\n                     playerObject.type = ageType; // *** Store ageType for existing member ***\r\n                     state.clubMembers = state.clubMembers.filter(p => p.name.toLowerCase() !== formattedPlayerName.toLowerCase());\r\n                 } else {\r\n                     // If member not found, treat as guest (but mark as member type internally)\r\n                     playerObject = { name: formattedPlayerName, gender: gender, guest: false, type: ageType, isPaused: false }; // *** Mark guest:false, Store ageType ***\r\n                     updateGuestHistory(playerObject.name, playerObject.gender); // Still track visits for potential future guest status? Or skip? Let's track.\r\n                 }\r\n             }\r\n             // Proceed to leaderboard confirmation for standard check-in\r\n             leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\r\n             leaderboardConfirmModal.classList.remove('hidden');\r\n             guestNameModal.classList.add('hidden');\r\n             // Form reset is handled within finishCheckIn for this flow\r\n        }\r\n    }\r\n\r\n    // --- NEW HELPER: Add/Update Guest History ---\r\n    function updateGuestHistory(guestName, guestGender) {\r\n        const guestIndex = state.guestHistory.findIndex(g => g.name === guestName);\r\n        const today = new Date().toISOString().split('T')[0];\r\n\r\n        if (guestIndex > -1) {\r\n            // Update existing guest gender if needed\r\n            state.guestHistory[guestIndex].gender = guestGender;\r\n            // Increment visits only if last visit wasn't today\r\n            if (state.guestHistory[guestIndex].lastCheckIn !== today) {\r\n                state.guestHistory[guestIndex].daysVisited = (state.guestHistory[guestIndex].daysVisited || 0) + 1;\r\n                state.guestHistory[guestIndex].lastCheckIn = today;\r\n            }\r\n        } else {\r\n            // Add new guest\r\n            state.guestHistory.push({\r\n                name: guestName,\r\n                gender: guestGender,\r\n                daysVisited: 1, // First visit\r\n                lastCheckIn: today\r\n            });\r\n        }\r\n    }\r\n\r\n    // --- NEW HELPER: Reset Guest Form ---\r\n    function resetGuestForm() {\r\n        guestNameInput.value = '';\r\n        guestSurnameInput.value = '';\r\n        guestConfirmBtn.disabled = true;\r\n        document.querySelector('input[name=\"guest-gender\"][value=\"M\"]').checked = true; // Default gender to M\r\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true; // Default type to Guest\r\n        document.querySelector('input[name=\"age-type\"][value=\"Adult\"]').checked = true; // *** NEW: Default age type to Adult ***\r\n        // Ensure member radio is re-enabled if it was disabled\r\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\r\n        if (memberRadio) memberRadio.disabled = false;\r\n    }\r\n    function resetConfirmModal(){ \r\n        setTimeout(() => { \r\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Action\"; \r\n            cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure?\"; \r\n            modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\r\n            modalBtnNo.textContent = \"Close\";         // Standardized Text\r\n        }, 300); \r\n    }\r\n\r\n    function populateCheckInModal() {\r\n        checkInList.innerHTML = \"\";\r\n\r\n        const checkedInPlayerNames = new Set([\r\n            ...state.availablePlayers.map(p => p.name),\r\n            ...state.courts.flatMap(c => c.players).map(p => p.name)\r\n        ]);\r\n\r\n        const membersAvailableToCheckIn = state.clubMembers.filter(member => !checkedInPlayerNames.has(member.name));\r\n        \r\n        // --- THIS IS THE FIX ---\r\n        // Sort the members alphabetically by name before rendering.\r\n        membersAvailableToCheckIn.sort((a, b) => a.name.localeCompare(b.name));\r\n        // --- END OF FIX ---\r\n\r\n        if (membersAvailableToCheckIn.length === 0) {\r\n            const li = document.createElement(\"li\");\r\n            li.textContent = \"All club members are currently checked in.\";\r\n            li.style.justifyContent = \"center\";\r\n            checkInList.appendChild(li);\r\n        } else {\r\n            membersAvailableToCheckIn.forEach(player => {\r\n                const li = document.createElement(\"li\");\r\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\r\n                li.innerHTML = ` <span style=\"flex-grow: 1;\">${displayName}</span> <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span> <span class=\"action-icon add\" data-player=\"${player.name}\">+</span> `;\r\n                li.dataset.playerName = player.name;\r\n                checkInList.appendChild(li);\r\n            });\r\n        }\r\n        setupListWithIndex(membersAvailableToCheckIn, checkInList, document.getElementById('check-in-abc-index'));\r\n    }\r\n\r\n    function populateCheckOutModal() {\r\n        checkOutList.innerHTML = \"\";\r\n        if (state.availablePlayers.length === 0) {\r\n            const li = document.createElement(\"li\");\r\n            li.textContent = \"There are no players currently checked in.\";\r\n            li.style.justifyContent = \"center\";\r\n            checkOutList.appendChild(li);\r\n        } else {\r\n            // --- THIS IS THE FIX ---\r\n            // Create a sorted copy of the array for display purposes only.\r\n            // This does NOT change the actual queue order in state.availablePlayers.\r\n            const sortedPlayers = [...state.availablePlayers].sort((a, b) => a.name.localeCompare(b.name));\r\n            // --- END OF FIX ---\r\n            \r\n            sortedPlayers.forEach(player => {\r\n                const li = document.createElement(\"li\");\r\n                const displayName = player.guest ? `${player.name} (Guest)` : player.name;\r\n                li.innerHTML = ` <span style=\"flex-grow: 1;\">${displayName}</span> <span style=\"margin-right: 1rem; color: #6c757d;\">${player.gender}</span> <span class=\"action-icon remove\" data-player=\"${player.name}\">&times;</span> `;\r\n                li.dataset.playerName = player.name;\r\n                checkOutList.appendChild(li);\r\n            });\r\n            setupListWithIndex(sortedPlayers, checkOutList, document.getElementById('check-out-abc-index'));\r\n        }\r\n    }\r\n\r\n\r\n\r\n    function executeCheckout(playerName) {\r\n        if (!playerName) return;\r\n\r\n        if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerName) {\r\n            resetAlertSchedule();\r\n        }\r\n\r\n        const playerObject = state.availablePlayers.find(p => p.name === playerName);\r\n        if (playerObject) {\r\n            if (playerObject.isJunior) {\r\n                state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter(child => child.name !== playerName);\r\n            }\r\n            if (!playerObject.guest) {\r\n                state.clubMembers.push(playerObject);\r\n                state.clubMembers.sort((a, b) => a.name.localeCompare(b.name));\r\n            }\r\n        }\r\n        state.availablePlayers = state.availablePlayers.filter(p => p.name !== playerName);\r\n\r\n        // Hide both modals, just in case\r\n        document.getElementById('checkout-thanks-modal').classList.add(\"hidden\");\r\n        document.getElementById('checkout-thanks-no-stats-modal').classList.add(\"hidden\");\r\n\r\n        populateCheckOutModal();\r\n        checkOutModal.classList.remove(\"hidden\");\r\n        \r\n        updateGameModeBasedOnPlayerCount();\r\n        autoAssignCourtModes();\r\n        render();\r\n        saveState();\r\n    }\r\n\r\n// REPLACE your existing 'showCheckoutThanksModal' function with this one\r\n\r\n    function showCheckoutThanksModalNoStats(playerObject) {\r\n        if (!playerObject) return;\r\n\r\n        const playerName = playerObject.name;\r\n        const firstName = playerName.split(' ')[0];\r\n        document.getElementById('checkout-thanks-no-stats-title').textContent = `Thanks for joining us, ${firstName}!`;\r\n\r\n        const today = new Date();\r\n        const dayOfWeek = today.getDay();\r\n        let nextSocialDay, nextSocialTime;\r\n\r\n        if (dayOfWeek < 3 || (dayOfWeek === 3 && today.getHours() < 17)) {\r\n            nextSocialDay = \"this coming Wednesday\";\r\n            nextSocialTime = \"17h30\";\r\n        } else if (dayOfWeek < 6 || (dayOfWeek === 6 && today.getHours() < 13)) {\r\n            nextSocialDay = \"this coming Saturday\";\r\n            nextSocialTime = \"13h00\";\r\n        } else {\r\n            nextSocialDay = \"next Wednesday\";\r\n            nextSocialTime = \"17h30\";\r\n        }\r\n\r\n        const message = `We hope you had a great day on the courts. Please join us for our next social on ${nextSocialDay}, starting at ${nextSocialTime}.`;\r\n        document.getElementById('checkout-thanks-no-stats-message').textContent = message;\r\n        \r\n        const modal = document.getElementById('checkout-thanks-no-stats-modal');\r\n        modal.dataset.player = playerName;\r\n\r\n        checkOutModal.classList.add('hidden');\r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n    function showCheckoutThanksModal(playerObject) {\r\n        if (!playerObject) return;\r\n\r\n        const playerName = playerObject.name;\r\n        const firstName = playerName.split(' ')[0];\r\n        document.getElementById('checkout-thanks-title').textContent = `Thanks for joining us, ${firstName}!`;\r\n\r\n        const statsContainer = document.getElementById('checkout-player-stats');\r\n        \r\n        statsContainer.classList.add('hidden');\r\n\r\n        if (playerObject.onLeaderboard === true) {\r\n            const todaysGames = state.gameHistory.filter(game => new Date(game.endTime).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]);\r\n            const playerStatsToday = calculatePlayerStats(todaysGames)[playerName];\r\n\r\n            // This is the key change: We no longer check if games have been played.\r\n            // We only check if the stats object exists, which it will for any checked-in player.\r\n            if (playerStatsToday) {\r\n                const rank = getPlayerRank(playerName, playerObject.gender);\r\n                const winPercentage = formatWinPercentage(playerStatsToday.played, playerStatsToday.won);\r\n                const { best, worst } = findBestAndWorstMatches(playerName);\r\n                const allTimeStats = calculatePlayerStats(state.gameHistory);\r\n                const allTimeDurationMs = allTimeStats[playerName] ? allTimeStats[playerName].totalDurationMs : 0;\r\n\r\n                document.getElementById('stat-rank').textContent = rank ? `#${rank}` : 'N/A';\r\n                document.getElementById('stat-win-percentage').textContent = winPercentage;\r\n                document.getElementById('stat-games-played').textContent = playerStatsToday.played;\r\n                document.getElementById('stat-games-won').textContent = playerStatsToday.won;\r\n                document.getElementById('stat-time-today').textContent = formatDuration(playerStatsToday.totalDurationMs);\r\n                document.getElementById('stat-total-time').textContent = formatDuration(allTimeDurationMs);\r\n                document.getElementById('best-match-highlight').innerHTML = `<strong>Best Match:</strong> ${best || 'N/A'}`;\r\n                document.getElementById('worst-match-highlight').innerHTML = `<strong>Toughest Match:</strong> ${worst || 'N/A'}`;\r\n\r\n                statsContainer.classList.remove('hidden');\r\n            }\r\n        }\r\n        \r\n        const today = new Date();\r\n        const dayOfWeek = today.getDay();\r\n        let nextSocialDay, nextSocialTime;\r\n\r\n        if (dayOfWeek < 3 || (dayOfWeek === 3 && today.getHours() < 17)) {\r\n            nextSocialDay = \"this coming Wednesday\";\r\n            nextSocialTime = \"17h30\";\r\n        } else if (dayOfWeek < 6 || (dayOfWeek === 6 && today.getHours() < 13)) {\r\n            nextSocialDay = \"this coming Saturday\";\r\n            nextSocialTime = \"13h00\";\r\n        } else {\r\n            nextSocialDay = \"next Wednesday\";\r\n            nextSocialTime = \"17h30\";\r\n        }\r\n\r\n        const message = `We hope you had a great day on the courts. Please join us for our next social on ${nextSocialDay}, starting at ${nextSocialTime}.`;\r\n        document.getElementById('checkout-thanks-message').textContent = message;\r\n        \r\n        const modal = document.getElementById('checkout-thanks-modal');\r\n        modal.dataset.player = playerName;\r\n\r\n        checkOutModal.classList.add('hidden');\r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n\r\n\r\n// NEW, DECOUPLED FUNCTION: Handles only the Committee Call announcement sequence\r\n    function playUntimedCall(ttsMessage) {\r\n        // 1. Check if all notifications are muted or TTS is disabled\r\n        if (state.notificationControls.isMuted || state.notificationControls.isTTSDisabled) return;\r\n\r\n        const utterance = getUtterance(ttsMessage);\r\n        if (!utterance) return;\r\n        \r\n        // 2. CRITICAL FIX: Cancel any existing speech NOW before starting audio/TTS.\r\n        if (window.speechSynthesis.speaking) {\r\n             window.speechSynthesis.cancel();\r\n        }\r\n        \r\n        // 3. Stop previous audio\r\n        if (currentAudio) {\r\n            currentAudio.pause();\r\n            currentAudio.currentTime = 0;\r\n        }\r\n\r\n        // 4. Create new audio object\r\n        const customAudio = new Audio('source/CommitteeCall.mp3');\r\n\r\n        // --- DEFINITIVE FIX: Use the 'playing' event to reliably attach the 'ended' listener ---\r\n        \r\n        // Stage 1: Attach listener for when audio STARTs playing\r\n        customAudio.addEventListener('playing', function onSoundPlaying() {\r\n            customAudio.removeEventListener('playing', onSoundPlaying);\r\n            \r\n            // Stage 2: Only now attach the listener for when the audio ENDS\r\n            customAudio.addEventListener('ended', function onSoundEnd() {\r\n                customAudio.removeEventListener('ended', onSoundEnd);\r\n                \r\n                // Play TTS only AFTER the audio ends\r\n                window.speechSynthesis.speak(utterance); \r\n            });\r\n        });\r\n\r\n        // 5. Play the sound (no promise chain)\r\n        customAudio.play().catch(error => {\r\n            console.error(`Error playing custom sound: `, error);\r\n            // Fallback: Play TTS immediately if sound fails\r\n            window.speechSynthesis.speak(utterance);\r\n        });\r\n    }\r\n    function handleCallDuty() {\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Call\";\r\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to call the committee member on duty?\";\r\n        modalBtnYesConfirm.textContent = \"Confirm\"; // Standardized Text\r\n        modalBtnNo.textContent = \"Close\";      // Standardized Text\r\n        cancelConfirmModal.dataset.mode = \"callDuty\";\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    function executeCallDuty() {\r\n        const onDutyName = state.onDuty;\r\n        let isPlaying = false;\r\n        if (onDutyName !== 'None') {\r\n            isPlaying = state.courts.some(court => court.players.some(p => p.name === onDutyName));\r\n        }\r\n\r\n        let ttsMessage;\r\n        if (onDutyName === 'None' || isPlaying) {\r\n            // User's preferred general message\r\n            ttsMessage = \"Committee member required. Please report to your station for assistance.\";\r\n        } else {\r\n            // Targeted message - Use pronounceable name\r\n            const firstNamePronounceable = getPronounceableName(onDutyName);\r\n            ttsMessage = `${firstNamePronounceable}, please report to your station for assistance.`;\r\n        }\r\n\r\n        // 1. Synchronous Fix: Reset the main alert timer schedule.\r\n        //resetAlertSchedule(); // <-- COMMENTED OUT AS REQUESTED\r\n\r\n        // 2. Use the main system's stable alert function (playAlertSound),\r\n        //    passing the special sound name as an override.\r\n        playAlertSound(ttsMessage, null, 'CommitteeCall.mp3'); // <-- NEW, CORRECT CALL\r\n\r\n        // 3. Close modal\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n    }\r\n\r\n    // ADD NEW FUNCTION: Execute the actual pause/resume state change\r\n    function executePauseToggle() {\r\n        const playerName = cancelConfirmModal.dataset.player;\r\n        const verb = cancelConfirmModal.dataset.verb;\r\n        const playerObj = state.availablePlayers.find(p => p.name === playerName);\r\n\r\n        if (playerObj) {\r\n\r\n            const currentSelectorFullName = getFirstAvailablePlayerName(); // Get full name\r\n\r\n            const wasPlayerHoldingSwapFlag = playerObj.isHoldingDutySwap;\r\n            const isPlayerPausing = (verb === 'pause');\r\n\r\n            if (verb === 'resume' && wasPlayerHoldingSwapFlag) {\r\n\r\n                const cmIndex = state.availablePlayers.findIndex(p => p.name === state.onDuty);\r\n                const playerAtPos2Index = 1;\r\n\r\n                if (cmIndex > playerAtPos2Index) {\r\n                    const playerToSwapWith = state.availablePlayers[playerAtPos2Index];\r\n\r\n                    state.availablePlayers[playerAtPos2Index] = state.availablePlayers[cmIndex];\r\n                    state.availablePlayers[cmIndex] = playerToSwapWith;\r\n                }\r\n\r\n                playerObj.isHoldingDutySwap = false;\r\n            }\r\n\r\n            // --- THIS IS THE NEW/MODIFIED LOGIC ---\r\n            playerObj.isPaused = isPlayerPausing;\r\n\r\n            if (isPlayerPausing) {\r\n                playerObj.pauseTime = Date.now(); // Set the pause timestamp\r\n            } else {\r\n                delete playerObj.pauseTime; // Remove timestamp on resume\r\n            }\r\n            // --- END OF NEW LOGIC ---\r\n\r\n            if (verb === 'pause') {\r\n                const firstActiveIndex = state.availablePlayers.findIndex(p => !p.isPaused);\r\n                if (firstActiveIndex === state.availablePlayers.indexOf(playerObj)) {\r\n                    playerObj.isHoldingDutySwap = true;\r\n                } else {\r\n                    playerObj.isHoldingDutySwap = false;\r\n                }\r\n            }\r\n\r\n            enforceQueueLogic(); // --- THIS IS THE FIX ---\r\n\r\n            const fullPlayerName = playerObj.name;\r\n            const pronounceablePlayerName = getPronounceableName(fullPlayerName); // Get pronounceable name\r\n            let firstMessage = '';\r\n            let secondMessage = null;\r\n\r\n            if (playerObj.isPaused) {\r\n                // Use pronounceable name\r\n                firstMessage = `${pronounceablePlayerName} is now taking a well-deserved break.`;\r\n\r\n                if (fullPlayerName === currentSelectorFullName) {\r\n                    const nextSelectorFullName = getFirstAvailablePlayerName();\r\n                    if (nextSelectorFullName) {\r\n                         // Use pronounceable name for the next selector\r\n                        const nextSelectorPronounceable = getPronounceableName(nextSelectorFullName);\r\n                        secondMessage = `${nextSelectorPronounceable}, please select players for a game.`;\r\n                    }\r\n                }\r\n            } else {\r\n                 // Use pronounceable name\r\n                firstMessage = `${pronounceablePlayerName} is back on court and ready to play.`;\r\n            }\r\n\r\n            playAlertSound(firstMessage, secondMessage);\r\n\r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            updateGameModeBasedOnPlayerCount();\r\n            render();\r\n            saveState();\r\n            checkAndPlayAlert(false);\r\n        }\r\n    }\r\n\r\n    function showCooldownModal(remainingMs) {\r\n        if (cooldownTimerInterval) {\r\n            clearInterval(cooldownTimerInterval);\r\n        }\r\n\r\n        const endTime = Date.now() + remainingMs;\r\n\r\n        function updateCountdown() {\r\n            const now = Date.now();\r\n            const timeLeft = endTime - now;\r\n\r\n            if (timeLeft <= 0) {\r\n                clearInterval(cooldownTimerInterval);\r\n                cooldownModal.classList.add('hidden');\r\n                return;\r\n            }\r\n\r\n            const minutes = Math.floor(timeLeft / 60000);\r\n            const seconds = Math.floor((timeLeft % 60000) / 1000);\r\n            cooldownTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\r\n        }\r\n\r\n        updateCountdown(); // Initial call to display time immediately\r\n        cooldownTimerInterval = setInterval(updateCountdown, 1000);\r\n        cooldownModal.classList.remove('hidden');\r\n    }\r\n\r\n    function handlePauseToggleClick(button) {\r\n        const playerName = button.dataset.playerName;\r\n        const action = button.dataset.action; // 'pause' or 'resume'\r\n        const playerObj = state.availablePlayers.find(p => p.name === playerName);\r\n\r\n        if (!playerObj) return;\r\n\r\n        if (action === 'resume') {\r\n            const TEN_MINUTES_MS = 10 * 60 * 1000;\r\n            if (playerObj.pauseTime && (Date.now() - playerObj.pauseTime) < TEN_MINUTES_MS) {\r\n                const remainingMs = TEN_MINUTES_MS - (Date.now() - playerObj.pauseTime);\r\n                showCooldownModal(remainingMs); // <-- This is the change\r\n                return;\r\n            }\r\n        }\r\n        \r\n        const verb = action === 'pause' ? 'pause' : 'resume';\r\n        \r\n        const message = action === 'pause' \r\n            ? `Are you sure you want to pause your game play? You will be paused for a minimum of 10 minutes and will remain in position #${state.availablePlayers.indexOf(playerObj) + 1} until you resume.` \r\n            : `Are you sure you want to resume your game play? You will be immediately restored to position #${state.availablePlayers.indexOf(playerObj) + 1}.`;\r\n\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;\r\n        cancelConfirmModal.querySelector(\"p\").textContent = message;\r\n        modalBtnYesConfirm.textContent = verb.charAt(0).toUpperCase() + verb.slice(1);\r\n        modalBtnNo.textContent = \"Close\";\r\n        \r\n        cancelConfirmModal.dataset.mode = \"pauseToggle\";\r\n        cancelConfirmModal.dataset.player = playerName;\r\n        cancelConfirmModal.dataset.verb = action;\r\n\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // --- ADDED FUNCTION ---\r\n    function enforceDutyPosition() {\r\n        if (state.availablePlayers.length < 2 || state.onDuty === 'None') {\r\n            return;\r\n        }\r\n\r\n        const players = state.availablePlayers;\r\n        \r\n        // Find the index of the player who is currently the ACTIVE selector (first non-paused player)\r\n        const firstActiveIndex = players.findIndex(p => !p.isPaused);\r\n        \r\n        // If no active players exist, or the CM is not the active player, exit.\r\n        if (firstActiveIndex === -1 || players[firstActiveIndex].name !== state.onDuty) {\r\n            return;\r\n        }\r\n        \r\n        // --- CM IS THE EFFECTIVE SELECTOR (players[firstActiveIndex]) ---\r\n        \r\n        // Find the index of the FIRST suitable (available, non-paused, non-duty) player to swap with.\r\n        // Start searching immediately after the CM's position.\r\n        const targetSwapIndex = players.findIndex((p, index) => \r\n            index > firstActiveIndex &&         // Must be after the CM\r\n            !p.isPaused &&                      // Must be available/unpaused\r\n            p.name !== state.onDuty             // Must not be the CM (safety check)\r\n        );\r\n\r\n        // If a suitable player is found, perform the swap.\r\n        if (targetSwapIndex !== -1) {\r\n            const cmPlayer = players[firstActiveIndex];\r\n            const targetPlayer = players[targetSwapIndex];\r\n            \r\n            // Perform the clean swap\r\n            [players[firstActiveIndex], players[targetSwapIndex]] = [targetPlayer, cmPlayer];\r\n        }\r\n    }\r\n\r\n    // Track last announcement times to prevent duplicates\r\n    let lastFastPlayAnnouncement = 0;\r\n    let last1SetAnnouncement = 0;\r\n    const ANNOUNCEMENT_COOLDOWN = 5000; // 5 seconds cooldown between same announcements\r\n\r\n    function autoAssignMatchMode() {\r\n        if (!state.matchSettings.autoMatchModes) {\r\n            return; // Do nothing if the feature is turned off\r\n        }\r\n\r\n        const socialCourts = state.courts.filter(c => \r\n            state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league'\r\n        );\r\n        const socialCourtCount = socialCourts.length;\r\n        \r\n        const totalPlayerCount = totalPlayersAtClub();\r\n        const fastPlayThreshold = (socialCourtCount * 4) + 4;\r\n\r\n        const TWO_MINUTES_MS = 2 * 60 * 1000;\r\n\r\n        if (totalPlayerCount >= fastPlayThreshold) {\r\n            if (state.matchSettings.matchMode !== 'fast') {\r\n                state.matchSettings.matchMode = 'fast';\r\n                state.matchSettings.fastPlayGames = 4;\r\n                // Only announce if cooldown period has passed\r\n                const now = Date.now();\r\n                if (now - lastFastPlayAnnouncement > ANNOUNCEMENT_COOLDOWN) {\r\n                    playCustomTTS(\"There is currently a high demand. Switching to Fast Play mode and 2-minute alerts.\");\r\n                    lastFastPlayAnnouncement = now;\r\n                }\r\n\r\n                // If an alert is scheduled for more than 2 minutes away, reset it to 2 minutes.\r\n                const remainingTime = alertScheduleTime - Date.now();\r\n                if (alertState !== 'initial_check' && remainingTime > TWO_MINUTES_MS) {\r\n                    alertScheduleTime = Date.now() + TWO_MINUTES_MS;\r\n                    playCustomTTS(\"Alert timer accelerated.\");\r\n                }\r\n            }\r\n        } else {\r\n            if (state.matchSettings.matchMode !== '1set') {\r\n                state.matchSettings.matchMode = '1set';\r\n                // Only announce if cooldown period has passed\r\n                const now2 = Date.now();\r\n                if (now2 - last1SetAnnouncement > ANNOUNCEMENT_COOLDOWN) {\r\n                    playCustomTTS(\"Player queue is reduced. Switching to standard 1 Set matches and 5-minute alerts.\");\r\n                    last1SetAnnouncement = now2;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function autoAssignCourtModes() {\r\n        // 1. Check if the feature is enabled in admin settings\r\n        if (!state.courtSettings.autoAssignModes) {\r\n            return;\r\n        }\r\n\r\n        // 2. Perform Calculations\r\n        const visibleSocialCourts = state.courts.filter(c =>\r\n            state.courtSettings.visibleCourts.includes(c.id) && c.courtMode !== 'league'\r\n        );\r\n        const visibleSocialCourtCount = visibleSocialCourts.length;\r\n\r\n        const activeLeagueCourts = state.courts.filter(c => c.courtMode === 'league' && c.status === 'in_progress').length;\r\n        const socialPlayersOnCourt = state.courts\r\n            .filter(c => c.courtMode !== 'league')\r\n            .reduce((sum, court) => sum + court.players.length, 0);\r\n        const totalSocialPlayers = state.availablePlayers.length + socialPlayersOnCourt;\r\n\r\n        // Filter for courts that are available, visible, and not league courts\r\n        const courtsToModify = state.courts.filter(c =>\r\n            c.status === 'available' &&\r\n            state.courtSettings.visibleCourts.includes(c.id) &&\r\n            c.courtMode !== 'league'\r\n        );\r\n\r\n        // 3. Apply Prioritized Rules\r\n        // Rule 1: League Priority\r\n        if (activeLeagueCourts >= 2) {\r\n            courtsToModify.forEach(court => {\r\n                if (court.courtMode !== 'doubles') court.courtMode = 'doubles';\r\n            });\r\n        }\r\n        // Rule 2: Full Capacity (Dynamic)\r\n        else if (totalSocialPlayers >= visibleSocialCourtCount * 4) {\r\n            courtsToModify.forEach(court => {\r\n                if (court.courtMode !== 'doubles') court.courtMode = 'doubles';\r\n            });\r\n        }\r\n        // Rule 3: High Occupancy (Dynamic)\r\n        else if (totalSocialPlayers >= (visibleSocialCourtCount - 1) * 4) {\r\n            courtsToModify.forEach(court => {\r\n                if (court.id === 'A' && court.courtMode !== 'doubles') {\r\n                    court.courtMode = 'doubles';\r\n                } else if (court.id === 'E' && court.courtMode !== 'rookie') {\r\n                    court.courtMode = 'rookie';\r\n                }\r\n            });\r\n        }\r\n        // Rule 4: Low Occupancy (Default)\r\n        else {\r\n            courtsToModify.forEach(court => {\r\n                if (court.id === 'A' && court.courtMode !== 'singles') {\r\n                    court.courtMode = 'singles';\r\n                } else if (court.id === 'E' && court.courtMode !== 'rookie') {\r\n                    court.courtMode = 'rookie';\r\n                }\r\n            });\r\n        }\r\n        saveState(); // Save any changes made to court modes\r\n    }\r\n\r\n\r\n    // --- ADDED FUNCTION ---\r\n    function handleReorderPositionChange(newPositionStr) {\r\n        if (!activeInput || !activeInput.dataset.playerName) return;\r\n\r\n        const playerName = activeInput.dataset.playerName;\r\n        const oldIndex = parseInt(activeInput.dataset.currentIndex, 10);\r\n        const newIndex = parseInt(newPositionStr, 10) - 1;\r\n\r\n        if (isNaN(newIndex) || newIndex < 0 || newIndex >= tempPlayerOrder.length) {\r\n            alert(`Invalid position. Please enter a number between 1 and ${tempPlayerOrder.length}.`);\r\n            return;\r\n        }\r\n\r\n        const [playerToMove] = tempPlayerOrder.splice(oldIndex, 1);\r\n        tempPlayerOrder.splice(newIndex, 0, playerToMove);\r\n\r\n        logPlayerSwap(playerName, oldIndex, newIndex);\r\n        renderReorderList();\r\n    }\r\n\r\n    // --- ADDED FUNCTION ---\r\n    function confirmSkipScores() {\r\n        const courtId = endGameModal.dataset.courtId;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        const winnerValue = endGameModal.dataset.winner;\r\n\r\n        if (!court || !winnerValue) return;\r\n\r\n        const team1Names = getPlayerNames(court.teams.team1);\r\n        const team2Names = getPlayerNames(court.teams.team2);\r\n\r\n        const newGame = {\r\n            id: Date.now(),\r\n            court: court.id,\r\n            startTime: court.gameStartTime,\r\n            endTime: Date.now(),\r\n            duration: document.getElementById(`timer-${court.id}`).textContent,\r\n            teams: { team1: team1Names, team2: team2Names },\r\n            score: null,\r\n            winner: winnerValue\r\n        };\r\n        state.gameHistory.push(newGame);\r\n\r\n        const winningPlayers = winnerValue === \"team1\" ? court.teams.team1 : court.teams.team2;\r\n        const losingPlayers = winnerValue === \"team1\" ? court.teams.team2 : court.teams.team1;\r\n        \r\n        const playersToRequeue = [...winningPlayers, ...losingPlayers].filter(p => !p.guest);\r\n        state.availablePlayers.push(...playersToRequeue);\r\n\r\n        // Reset the court and close modal\r\n        resetCourtAfterGame(court.id);\r\n        endGameModal.classList.add(\"hidden\");\r\n        checkAndPlayAlert(false);\r\n    }\r\n    \r\n    // REPLACE this function (minor change to call checkAndPlayAlert correctly)\r\n    function resetCourtAfterGame(courtId) {\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court) return;\r\n\r\n        court.status = \"available\";\r\n        court.players = [];\r\n        court.teams = {team1:[], team2:[]};\r\n        court.gameMode = null;\r\n        court.gameStartTime = null;\r\n        court.queueSnapshot = null;\r\n        court.becameAvailableAt = Date.now(); // Ensure this is set when becoming available\r\n\r\n        // NEW: Check if we need to restore the original duty member\r\n        if (state.tempDutyHandover && state.tempDutyHandover.originalMember) {\r\n            // Check if the original duty member's game has ended\r\n            const originalMemberStillOnCourt = state.courts.some(c =>\r\n                c.status === 'in_progress' &&\r\n                c.players.some(p => p.name === state.tempDutyHandover.originalMember)\r\n            );\r\n\r\n            if (!originalMemberStillOnCourt) {\r\n                restoreOriginalDutyMember(); // This will call render() internally\r\n            }\r\n        }\r\n\r\n        updateGameModeBasedOnPlayerCount();\r\n        enforceDutyPosition();\r\n        autoAssignCourtModes();\r\n        render(); // Render the UI update first\r\n        saveState();\r\n\r\n        // --- THIS IS THE FIX ---\r\n        // Call checkAndPlayAlert *after* render and save, so it evaluates the new state.\r\n        // Pass false so it doesn't force an immediate alert, but resets timer if needed.\r\n        checkAndPlayAlert(false);\r\n        // --- END OF FIX ---\r\n    }\r\n\r\n    function confirmSkipResult() {\r\n        const courtId = endGameModal.dataset.courtId;\r\n        const court = state.courts.find(c => c.id === courtId);\r\n        if (!court) return;\r\n\r\n        const team1Names = getPlayerNames(court.teams.team1);\r\n        const team2Names = getPlayerNames(court.teams.team2);\r\n\r\n        const newGame = {\r\n            id: Date.now(),\r\n            court: court.id,\r\n            startTime: court.gameStartTime,\r\n            endTime: Date.now(),\r\n            duration: document.getElementById(`timer-${court.id}`).textContent,\r\n            teams: { team1: team1Names, team2: team2Names },\r\n            score: null,\r\n            winner: 'skipped'\r\n        };\r\n        state.gameHistory.push(newGame);\r\n\r\n        const playersToRequeue = [...court.players].filter(p => !p.guest);\r\n        state.availablePlayers.push(...playersToRequeue);\r\n\r\n        // Reset the court and close modal\r\n        resetCourtAfterGame(court.id);\r\n        endGameModal.classList.add(\"hidden\");\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n// REPLACE this function\r\n    function handleSkipButtonClick() {\r\n        const skipBtn = document.getElementById('end-game-skip-btn');\r\n        const action = skipBtn.dataset.action;\r\n\r\n        if (action === 'skip-scores') {\r\n            confirmSkipScores();\r\n        } else { // 'skip-result'\r\n            confirmSkipResult();\r\n        }\r\n    }\r\n\r\n        // --- ADDED FUNCTION ---\r\n    // Triggers the keypad for the reset confirmation\r\n    function handleResetAppClick() {\r\n        showKeypad(null, {\r\n            mode: 'reset', // A new, special mode for the keypad\r\n            maxLength: 5,\r\n            title: 'Enter Reset PIN'\r\n        });\r\n    }\r\n\r\n    // --- ADDED FUNCTION ---\r\n    // Checks the entered PIN against the hardcoded value\r\n    function checkResetPasscode() {\r\n        const enteredCode = keypadDisplay.dataset.hiddenValue;\r\n        const expectedCode = \"30221\"; // The hardcoded reset PIN\r\n\r\n        if (enteredCode === expectedCode) {\r\n            // If correct, show a final confirmation before resetting\r\n            hideKeypad();\r\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Final Confirmation\";\r\n            cancelConfirmModal.querySelector(\"p\").textContent = \"WARNING: This will erase all game history and check out all players. Are you absolutely sure?\";\r\n            modalBtnYesConfirm.textContent = \"Yes, Reset\";\r\n            modalBtnNo.textContent = \"Cancel\";\r\n            cancelConfirmModal.dataset.mode = \"executeReset\";\r\n            cancelConfirmModal.classList.remove(\"hidden\");\r\n        } else {\r\n            // If incorrect, shake the keypad and clear it\r\n            const keypadContent = customKeypadModal.querySelector('.keypad-content');\r\n            keypadContent.classList.add('shake');\r\n            setTimeout(() => {\r\n                keypadContent.classList.remove('shake');\r\n                keypadDisplay.textContent = '';\r\n                if (keypadDisplay.dataset.hiddenValue) {\r\n                    keypadDisplay.dataset.hiddenValue = '';\r\n                }\r\n                keypadConfirmBtn.disabled = true;\r\n            }, 820);\r\n        }\r\n    }\r\n\r\n    // --- ADDED FUNCTION ---\r\n    // The core function that resets the application state\r\n    function executeAppReset() {\r\n        // --- ADD THIS BLOCK AT THE BEGINNING ---\r\n        // Save the final state of the checklist for the day *before* resetting\r\n        saveChecklistHistory();\r\n        // Force the checklist to reset its 'checked' status immediately\r\n        resetChecklistForNewDay(true); // Pass true to force reset regardless of date\r\n        // --- END ADD ---\r\n\r\n        // Reset all player locations\r\n        state.clubMembers = [...MASTER_MEMBER_LIST].sort((a, b) => a.name.localeCompare(b.name));\r\n        state.availablePlayers = [];\r\n\r\n        // ... (rest of the reset logic for courts, history, etc.) ...\r\n\r\n        // Clear all history (game, reorder)\r\n        state.gameHistory = [];\r\n        state.reorderHistory = [];\r\n        // DO NOT CLEAR state.checklistHistory here - we want to keep past checklists\r\n\r\n        // ... (reset other relevant states like onDuty, selection) ...\r\n\r\n        // Close all modals\r\n        adminSettingsModal.classList.add('hidden');\r\n        cancelConfirmModal.classList.add('hidden');\r\n\r\n        // Save the new, clean state and re-render the UI\r\n        saveState();\r\n        autoAssignCourtModes();\r\n        render();\r\n        alert(\"Application has been reset. Checklist state for the previous session (if applicable) has been archived.\");\r\n    }\r\n\r\n    function formatCase(str) {\r\n        return str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');\r\n    }\r\n\r\n    // --- ADDED FUNCTION: Wrapper for the Add Child button click ---\r\n    function addChild() {\r\n        generateChildField();\r\n    }\r\n\r\n    // --- JUNIOR CLUB FUNCTIONS (RESTORED) ---\r\n    function generateChildField() {\r\n        // --- DEBUG LOG ---\r\n        console.log(\"--- generateChildField START ---\");\r\n\r\n        const groupId = Date.now();\r\n        const fieldGroup = document.createElement('div');\r\n        fieldGroup.className = 'child-field-group';\r\n        fieldGroup.dataset.groupId = groupId;\r\n        fieldGroup.dataset.complete = 'false'; // Start as incomplete\r\n\r\n        // --- DEBUG LOG ---\r\n        console.log(\"generateChildField: Created fieldGroup element:\", fieldGroup);\r\n\r\n        const currentParentSurname = parentSurnameInput.value.trim(); // Get current parent surname\r\n\r\n        // --- UPDATED HTML with stacked fields and labels ---\r\n        fieldGroup.innerHTML = `\r\n            <div class=\"child-collapsed-display collapsed-area hidden\"></div>\r\n            <div class=\"child-expanded-fields\">\r\n                <div style=\"display: block;\">\r\n                    <div class=\"child-name-input score-input-area\" style=\"flex-direction: column; align-items: stretch; width: 100%;\">\r\n                        <label for=\"child-name-${groupId}\">Child First Name:</label>\r\n                        <input type=\"text\" id=\"child-name-${groupId}\" name=\"childName\" readonly placeholder=\"Tap to enter name\" style=\"width: 100%;\">\r\n                    </div>\r\n                    <div class=\"child-surname-container score-input-area\" style=\"flex-direction: column; align-items: stretch; width: 100%;\">\r\n                        <label for=\"child-surname-${groupId}\">Child Surname:</label>\r\n                        <input type=\"text\" id=\"child-surname-${groupId}\" name=\"childSurname\" readonly placeholder=\"Tap to enter surname\" style=\"width: 100%;\" data-autofill-surname=\"${currentParentSurname}\">\r\n                    </div>\r\n                </div>\r\n                <div style=\"display: flex; gap: 0.75rem; margin-top: 0.5rem; width: 100%;\">\r\n                    <div class=\"child-dob-input score-input-area\" style=\"flex-direction: column; align-items: stretch; flex: 1; min-width: 0; position: relative;\">\r\n                        <label for=\"child-dob-${groupId}\">Birth Date:</label>\r\n                        <div class=\"date-time-input-wrapper\">\r\n                            <input type=\"date\" id=\"child-dob-${groupId}\" name=\"childBirthDate\">\r\n                            <div class=\"date-time-overlay\" id=\"child-dob-${groupId}-overlay\">\r\n                                <span class=\"part empty\" data-part=\"YYYY\">yyyy</span><span class=\"separator\">/</span><span class=\"part empty\" data-part=\"MM\">mm</span><span class=\"separator\">/</span><span class=\"part empty\" data-part=\"DD\">dd</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"gender-selector score-input-area\" style=\"flex-direction: column; align-items: stretch; flex: 1; min-width: 0;\">\r\n                        <label>Gender:</label>\r\n                        <div class=\"radio-group\" style=\"background-color: transparent; border: 1px solid var(--border-color); border-radius: 5px; height: 100%; box-sizing: border-box; display: flex; align-items: center; justify-content: space-around; padding: 0.25rem 0.5rem;\">\r\n                            <label><input type=\"radio\" name=\"child-gender-${groupId}\" value=\"M\"> Male</label>\r\n                            <label><input type=\"radio\" name=\"child-gender-${groupId}\" value=\"F\"> Female</label>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // --- Get Input References ---\r\n        const childNameInput = fieldGroup.querySelector('[name=\"childName\"]');\r\n        const childSurnameInput = fieldGroup.querySelector('[name=\"childSurname\"]');\r\n        const childDobInput = fieldGroup.querySelector('[name=\"childBirthDate\"]');\r\n\r\n        // --- Attach Global Keyboard Listeners ---\r\n        childNameInput.addEventListener('click', (e) => showGlobalKeyboard(e.target, 'LetterPad', ''));\r\n        childSurnameInput.addEventListener('click', (e) => showGlobalKeyboard(e.target, 'LetterPad', ''));\r\n        // Update overlay when date value changes\r\n        childDobInput.addEventListener('change', function(e) {\r\n            const overlay = fieldGroup.querySelector(`#child-dob-${groupId}-overlay`);\r\n            if (!overlay) return;\r\n            \r\n            const value = e.target.value; // Format: YYYY-MM-DD\r\n            if (value) {\r\n                const [year, month, day] = value.split('-');\r\n                const parts = overlay.querySelectorAll('.part');\r\n                \r\n                parts[0].textContent = year;\r\n                parts[0].classList.remove('empty');\r\n                parts[0].classList.add('filled');\r\n                \r\n                parts[1].textContent = month;\r\n                parts[1].classList.remove('empty');\r\n                parts[1].classList.add('filled');\r\n                \r\n                parts[2].textContent = day;\r\n                parts[2].classList.remove('empty');\r\n                parts[2].classList.add('filled');\r\n            }\r\n        });\r\n\r\n        // --- Define Validation Handler for this specific group ---\r\n        const validationHandlerForGroup = () => {\r\n            checkAndCollapseChild(fieldGroup); // Check if this specific group is complete\r\n            validateNewParentForm(false); // Validate parent form buttons (don't re-render parent)\r\n            renderChildFields(); // Re-render child fields to update collapse state\r\n        };\r\n\r\n        // --- Attach Input/Change Listeners ---\r\n        childNameInput.addEventListener('input', validationHandlerForGroup);\r\n        childSurnameInput.addEventListener('input', validationHandlerForGroup);\r\n        childDobInput.addEventListener('change', validationHandlerForGroup); // Date uses 'change'\r\n        fieldGroup.querySelectorAll(`input[name^=\"child-gender\"]`).forEach(radio => {\r\n            radio.addEventListener('change', validationHandlerForGroup);\r\n        });\r\n\r\n        // --- Autofill Logic (Remains the same) ---\r\n         childNameInput.addEventListener('input', () => {\r\n             const surnameToAutofill = childSurnameInput.dataset.autofillSurname;\r\n             if (surnameToAutofill && childNameInput.value.trim().length > 0 && childSurnameInput.value.trim().length === 0) {\r\n                 childSurnameInput.value = surnameToAutofill;\r\n                 // Dispatch an input event manually AFTER setting the value\r\n                 childSurnameInput.dispatchEvent(new Event('input', { bubbles: true }));\r\n             } else if (childNameInput.value.trim().length === 0) {\r\n                 childSurnameInput.value = '';\r\n                 childSurnameInput.dispatchEvent(new Event('input', { bubbles: true }));\r\n             }\r\n             // No need for validationHandlerForGroup() here, the 'input' event on childSurnameInput handles it\r\n         });\r\n\r\n\r\n        // --- Add listener to collapsed area to re-expand ---\r\n        const collapsedDisplay = fieldGroup.querySelector('.child-collapsed-display');\r\n        collapsedDisplay.addEventListener('click', (e) => {\r\n             if (e.target.closest('.collapsed-area') || e.target.closest('.edit-icon')) {\r\n                fieldGroup.dataset.complete = 'false';\r\n                renderChildFields(); // Re-render to show expanded view\r\n             }\r\n        });\r\n        collapsedDisplay.dataset.listenerBound = 'true'; // Mark as bound\r\n\r\n\r\n        // --- Append to Container ---\r\n        const childrenContainerElement = document.getElementById('children-container');\r\n        if (childrenContainerElement) {\r\n             console.log(\"generateChildField: Appending fieldGroup to #children-container:\", childrenContainerElement);\r\n             childrenContainerElement.appendChild(fieldGroup);\r\n        } else {\r\n             console.error(\"generateChildField: #children-container NOT FOUND!\");\r\n        }\r\n\r\n        // --- DEBUG LOG ---\r\n        console.log(\"--- generateChildField END ---\");\r\n\r\n        // Initial validation call for the new field AFTER appending\r\n        validationHandlerForGroup();\r\n    }\r\n\r\n    function showEditParentModal(parent) {\r\n        // 1. Set the modal to 'edit' mode and store the parent's original ID.\r\n        newParentModal.querySelector('h3').textContent = 'Edit Parent Profile';\r\n        newParentModal.dataset.mode = 'edit';\r\n        newParentModal.dataset.originalParentId = parent.id;\r\n        newParentConfirmBtn.textContent = 'Save Changes';\r\n\r\n        // 2. Populate the main parent fields.\r\n        parentNameInput.value = parent.name;\r\n        parentSurnameInput.value = parent.surname;\r\n        parentPhoneInput.value = parent.phone || '';\r\n\r\n        // 3. Clear any old child forms.\r\n        childrenContainer.innerHTML = '';\r\n\r\n        // 4. Loop through the existing children and create a pre-filled form for each.\r\n        parent.registeredChildren.forEach(child => {\r\n            // Creates a new, empty child form group.\r\n            generateChildField(); \r\n            \r\n            // Get a reference to the form we just created.\r\n            const lastChildGroup = childrenContainer.lastElementChild;\r\n            if (lastChildGroup) {\r\n                // Populate the fields of that form with the child's data.\r\n                lastChildGroup.querySelector('[name=\"childName\"]').value = child.name;\r\n                lastChildGroup.querySelector('[name=\"childSurname\"]').value = child.surname;\r\n                lastChildGroup.querySelector('[name=\"childBirthDate\"]').value = child.birthDate;\r\n                \r\n                const genderRadio = lastChildGroup.querySelector(`input[name^=\"child-gender\"][value=\"${child.gender}\"]`);\r\n                if (genderRadio) {\r\n                    genderRadio.checked = true;\r\n                }\r\n\r\n                // --- THIS IS THE CRITICAL FIX ---\r\n                // Manually run the check to mark this pre-filled form as \"complete\".\r\n                checkAndCollapseChild(lastChildGroup);\r\n                // --- END OF FIX ---\r\n            }\r\n        });\r\n\r\n        // 5. Set the initial state to show the form as already collapsed.\r\n        state.juniorClub.registrationFlow = {\r\n            parentCollapsed: true,\r\n            childrenExpanded: true,\r\n        };\r\n\r\n        // 6. Show the modal.\r\n        juniorClubModal.classList.add('hidden');\r\n        newParentModal.classList.remove('hidden');\r\n\r\n        // 7. Render the form. Because we fixed the \"complete\" state in step 4,\r\n        // this will now correctly render the collapsed summary view.\r\n        renderParentForm();\r\n    }\r\n\r\n    function showJuniorClubRosterModal() {\r\n        renderJuniorClubRoster(); // Renders with default/last applied sort\r\n        juniorClubModal.classList.add('hidden');\r\n        juniorClubRosterModal.classList.remove('hidden');\r\n    }\r\n\r\n    function showRosterDetailModal(item) {\r\n        rosterDetailContent.innerHTML = '';\r\n        \r\n        // Ensure the detail modal content container is visible\r\n        rosterDetailModal.classList.add('hidden');\r\n\r\n        if (item.isParent) {\r\n            // --- PARENT DETAIL VIEW: List Children ---\r\n            rosterDetailTitle.textContent = `${item.name} ${item.surname}'s Registered Children`;\r\n            // ADDED STYLE: Compact Title\r\n            rosterDetailTitle.style.marginTop = '0';\r\n            rosterDetailTitle.style.marginBottom = '0.5rem';\r\n\r\n            if (item.children && item.children.length > 0) {\r\n                const ul = document.createElement('ul');\r\n                ul.style.listStyleType = 'none';\r\n                ul.style.padding = '0';\r\n                ul.style.margin = '0.5rem 0';\r\n                \r\n                item.children.forEach(childName => {\r\n                    const childLastCheckInMs = getLastCheckInForChild(childName);\r\n                    const checkInDisplay = childLastCheckInMs > 0 \r\n                        ? new Date(childLastCheckInMs).toLocaleDateString('en-ZA') \r\n                        : 'Never Checked In';\r\n\r\n                    const li = document.createElement('li');\r\n                    li.innerHTML = `\r\n                        <div style=\"display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #eee;\">\r\n                            <span style=\"font-weight: 500; color: var(--dark-text);\">${childName}</span>\r\n                            <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${checkInDisplay}</span>\r\n                        </div>\r\n                    `;\r\n                    ul.appendChild(li);\r\n                });\r\n                rosterDetailContent.appendChild(ul);\r\n            } else {\r\n                // MODIFIED STYLE: Compact margin for empty state\r\n                rosterDetailContent.innerHTML = '<p style=\"text-align: center; color: var(--neutral-color); margin-top: 1rem; margin-bottom: 0;\">No children currently registered under this parent.</p>';\r\n            }\r\n\r\n        } else {\r\n            // --- CHILD DETAIL VIEW: Show Parent in list style ---\r\n            rosterDetailTitle.textContent = `${item.name} ${item.surname}'s Parent`;\r\n            // ADDED STYLE: Compact Title\r\n            rosterDetailTitle.style.marginTop = '0';\r\n            rosterDetailTitle.style.marginBottom = '0.5rem';\r\n            \r\n            const ul = document.createElement('ul');\r\n            ul.style.listStyleType = 'none';\r\n            ul.style.padding = '0';\r\n            ul.style.margin = '0.5rem 0';\r\n\r\n            // Find the parent object to get their last check-in details\r\n            const parent = state.juniorClub.parents.find(p => `${p.name} ${p.surname}` === item.parentName);\r\n            let parentLastCheckInDisplay = 'Never Checked In';\r\n\r\n            if (parent) {\r\n                // Re-use the existing logic to find the parent's most recent check-in through children\r\n                let latestParentChildrenCheckIn = 0;\r\n                parent.registeredChildren.forEach(child => {\r\n                    const childFullName = `${child.name} ${child.surname}`;\r\n                    const childCheckIn = getLastCheckInForChild(childFullName);\r\n                    if (childCheckIn > latestParentChildrenCheckIn) {\r\n                        latestParentChildrenCheckIn = childCheckIn;\r\n                    }\r\n                });\r\n\r\n                if (latestParentChildrenCheckIn > 0) {\r\n                    parentLastCheckInDisplay = new Date(latestParentChildrenCheckIn).toLocaleDateString('en-ZA');\r\n                }\r\n            }\r\n\r\n\r\n            const li = document.createElement('li');\r\n            li.innerHTML = `\r\n                <div style=\"display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #eee;\">\r\n                    <span style=\"font-weight: 500; color: var(--dark-text);\">Parent: ${item.parentName}</span>\r\n                    <span style=\"font-size: 0.9em; color: var(--neutral-color);\">${parentLastCheckInDisplay}</span>\r\n                </div>\r\n            `;\r\n            ul.appendChild(li);\r\n            rosterDetailContent.appendChild(ul);\r\n        }\r\n\r\n        // Hide the roster modal and show the detail modal\r\n        juniorClubRosterModal.classList.add('hidden');\r\n        rosterDetailModal.classList.remove('hidden');\r\n    }\r\n\r\n    function renderJuniorClubRoster() {\r\n        juniorClubRosterList.innerHTML = ''; // Clear previous content\r\n        const { sortKey, sortOrder, type } = state.juniorClub.rosterFilter;\r\n\r\n        let finalRoster = [];\r\n        // --- Populate finalRoster based on 'type' filter ---\r\n        if (type === 'parents') {\r\n            state.juniorClub.parents.forEach(parent => {\r\n                let latestChildCheckIn = 0;\r\n                // Find the latest check-in time among all children of this parent\r\n                parent.registeredChildren.forEach(child => {\r\n                    const childFullName = `${child.name} ${child.surname}`.trim();\r\n                    const childCheckIn = getLastCheckInForChild(childFullName);\r\n                    if (childCheckIn > latestChildCheckIn) latestChildCheckIn = childCheckIn;\r\n                });\r\n                // Add parent data, including email\r\n                finalRoster.push({\r\n                    isParentOnlyView: true,\r\n                    id: parent.id,\r\n                    name: `${parent.name} ${parent.surname}`,\r\n                    phone: parent.phone || 'N/A',\r\n                    email: parent.email || 'N/A', // <-- ADDED EMAIL HERE\r\n                    lastCheckInMs: latestChildCheckIn\r\n                });\r\n            });\r\n        } else if (type === 'all') {\r\n            // Logic for 'all' view (unchanged)\r\n            state.juniorClub.parents.forEach(parent => {\r\n                parent.registeredChildren.forEach(child => {\r\n                    const childFullName = `${child.name} ${child.surname}`.trim();\r\n                    const childAge = calculateAge(child.birthDate);\r\n                    finalRoster.push({\r\n                        isAllView: true,\r\n                        id: childFullName, // Unique ID for list items if needed\r\n                        parentName: `${parent.name} ${parent.surname}`,\r\n                        childData: { name: childFullName, age: childAge, ageDisplay: childAge !== null ? `${childAge}y` : 'N/A', gender: child.gender || '?' },\r\n                        lastCheckInMs: getLastCheckInForChild(childFullName)\r\n                    });\r\n                });\r\n            });\r\n        } else { // 'children' view\r\n             // Logic for 'children' view (unchanged)\r\n            state.juniorClub.parents.forEach(parent => {\r\n                parent.registeredChildren.forEach(child => {\r\n                    const childFullName = `${child.name} ${child.surname}`.trim();\r\n                    const childAge = calculateAge(child.birthDate);\r\n                    finalRoster.push({\r\n                        isChildrenView: true,\r\n                        id: childFullName, // Unique ID\r\n                        name: `${child.name} ${child.surname}`,\r\n                        age: childAge,\r\n                        ageDisplay: childAge !== null ? `${childAge}y` : 'N/A',\r\n                        gender: child.gender || '?',\r\n                        lastCheckInMs: getLastCheckInForChild(childFullName),\r\n                    });\r\n                });\r\n            });\r\n        }\r\n\r\n        // --- Sorting Logic (unchanged) ---\r\n        let uniqueRoster = finalRoster; // Assuming filtering for uniqueness isn't needed here currently\r\n        uniqueRoster.sort((a, b) => {\r\n            let compareValue = 0;\r\n            // Determine name based on view type for sorting\r\n            const nameA = a.isParentOnlyView ? a.name : (a.isAllView ? a.childData.name : a.name);\r\n            const nameB = b.isParentOnlyView ? b.name : (b.isAllView ? b.childData.name : b.name);\r\n\r\n            if (sortKey === 'name') { compareValue = nameA.localeCompare(nameB); }\r\n            else if (sortKey === 'last_checkin') { compareValue = a.lastCheckInMs - b.lastCheckInMs; }\r\n            // Add other sort key logic if needed (age, gender, email etc.)\r\n            else if (sortKey === 'age') { /* ... age sort logic ... */ }\r\n            else if (sortKey === 'gender') { /* ... gender sort logic ... */ }\r\n\r\n            return sortOrder === 'asc' ? compareValue : -compareValue;\r\n        });\r\n\r\n        // --- Filter HTML Injection (unchanged) ---\r\n        const filterHTML = `\r\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\r\n                <div class=\"radio-group\" id=\"roster-type-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\r\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"all\" ${type === 'all' ? 'checked' : ''}> All</label>\r\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"parents\" ${type === 'parents' ? 'checked' : ''}> Parents Only</label>\r\n                    <label> <input type=\"radio\" name=\"roster-type-filter\" value=\"children\" ${type === 'children' ? 'checked' : ''}> Children Only</label>\r\n                </div>\r\n            </div>\r\n        `;\r\n        juniorClubRosterList.insertAdjacentHTML('afterbegin', filterHTML);\r\n\r\n        // Re-attach listener\r\n        juniorClubRosterList.querySelector('#roster-type-filter-group').addEventListener('change', handleRosterTypeFilterChange);\r\n\r\n        // --- Prepare for List Rendering ---\r\n        const indexList = uniqueRoster.map(item => ({ name: item.isParentOnlyView ? item.name : (item.isAllView ? item.childData.name : item.name) }));\r\n\r\n        if (uniqueRoster.length === 0) {\r\n            document.getElementById('junior-club-roster-abc-index').innerHTML = ''; // Clear index\r\n            juniorClubRosterList.insertAdjacentHTML('beforeend', '<li class=\"waiting-message\">No members match the current filters.</li>');\r\n            return; // Exit if no items\r\n        }\r\n\r\n        juniorClubRosterList.rosterData = uniqueRoster; // Store data for detail view clicks\r\n        const getSortIcon = (key) => (state.juniorClub.rosterFilter.sortKey !== key) ? ' ' : (sortOrder === 'asc' ? ' 🔼' : ' 🔽');\r\n        const buttonStyle = \"background: none; color: var(--dark-text); border: none; padding: 0.5rem; min-width: 0; line-height: 1.2; font-weight: bold; font-size: calc(0.8rem * var(--font-size-multiplier));\"; // Shared style\r\n\r\n        let headerHTML = '';\r\n        // --- Header Generation based on 'type' ---\r\n        if (type === 'parents') {\r\n            // *** UPDATED HEADER for Parents Only view ***\r\n            headerHTML = `<div class=\"history-item roster-header\" style=\"padding: 0.5rem 1rem;\">\r\n                <div class=\"roster-row\">\r\n                    <button class=\"action-btn roster-sort-btn roster-col-name\" data-sort-key=\"name\" style=\"${buttonStyle} flex: 2.5; text-align: left;\">Parent Name${getSortIcon('name')}</button>\r\n                    <span class=\"roster-col-contact\" style=\"color: var(--dark-text); font-weight: bold; flex: 1; text-align: center; font-size: calc(0.8rem * var(--font-size-multiplier));\">Contact</span>\r\n                    <span class=\"roster-col-email\" style=\"color: var(--dark-text); font-weight: bold; flex: 1.5; text-align: center; font-size: calc(0.8rem * var(--font-size-multiplier));\">Email</span>\r\n                    <button class=\"action-btn roster-sort-btn roster-col-checkin\" data-sort-key=\"last_checkin\" style=\"${buttonStyle} flex: 1; text-align: center;\">Last<br>Check-In${getSortIcon('last_checkin')}</button>\r\n                </div></div>`;\r\n        } else { // 'all' or 'children' view (Header remains the same for these)\r\n            headerHTML = `<div class=\"history-item roster-header\" style=\"padding: 0.5rem 1rem;\">\r\n                <div class=\"roster-row\">\r\n                    <button class=\"action-btn roster-sort-btn roster-col-name\" data-sort-key=\"name\" style=\"${buttonStyle} flex: 2.5; text-align: left;\">${type === 'all' ? 'Parent / Child' : 'Name'}${getSortIcon('name')}</button>\r\n                    <button class=\"action-btn roster-sort-btn roster-col-gender\" data-sort-key=\"gender\" style=\"${buttonStyle} flex: 1; text-align: center;\">Gender${getSortIcon('gender')}</button>\r\n                    <button class=\"action-btn roster-sort-btn roster-col-age\" data-sort-key=\"age\" style=\"${buttonStyle} flex: 1; text-align: center;\">Age${getSortIcon('age')}</button>\r\n                    <button class=\"action-btn roster-sort-btn roster-col-checkin\" data-sort-key=\"last_checkin\" style=\"${buttonStyle} flex: 1; text-align: center;\">Last<br>Check-In${getSortIcon('last_checkin')}</button>\r\n                </div></div>`;\r\n        }\r\n        juniorClubRosterList.insertAdjacentHTML('beforeend', headerHTML); // Add header\r\n\r\n        // --- List Item Generation ---\r\n        uniqueRoster.forEach((item, index) => {\r\n            const li = document.createElement('li');\r\n            li.className = 'roster-item';\r\n            li.dataset.rosterIndex = index; // For detail view click\r\n            // Name used for ABC index mapping\r\n            const nameToIndex = item.isParentOnlyView ? item.name : (item.isAllView ? item.childData.name : item.name);\r\n            li.dataset.playerName = nameToIndex;\r\n\r\n            const lastCheckInDate = item.lastCheckInMs > 0 ? new Date(item.lastCheckInMs).toLocaleDateString('en-ZA') : 'N/A';\r\n            const itemStyle = \"min-width: 0; text-align: center;\"; // Base style for columns\r\n\r\n            // Populate innerHTML based on view type\r\n            if (item.isParentOnlyView) {\r\n                // *** UPDATED ITEM for Parents Only view ***\r\n                 li.innerHTML = `<div class=\"roster-row\">\r\n                        <span class=\"roster-col-name\" style=\"font-weight: 700; color: var(--primary-blue); flex: 2.5; text-align: left;\">${item.name}</span>\r\n                        <span class=\"roster-col-contact\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.phone}</span>\r\n                        <span class=\"roster-col-email\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${item.email}</span>\r\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\r\n                    </div>`;\r\n            } else if (item.isAllView) { // 'all' view\r\n                 li.innerHTML = `<div class=\"roster-row\">\r\n                        <div class=\"roster-col-name\" style=\"display: flex; flex-direction: column; flex: 2.5; text-align: left;\">\r\n                            <span style=\"font-weight: 700; color: var(--primary-blue);\">${item.parentName}</span>\r\n                            <span style=\"font-size: 0.9em; color: var(--dark-text); padding-left: 1rem;\">${item.childData.name}</span>\r\n                        </div>\r\n                        <span class=\"roster-col-gender\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.childData.gender}</span>\r\n                        <span class=\"roster-col-age\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.childData.ageDisplay}</span>\r\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\r\n                    </div>`;\r\n            } else { // 'children' view\r\n                 li.style.padding = '0.8rem 1rem'; // Specific padding for children view\r\n                 li.innerHTML = `<div class=\"roster-row\">\r\n                        <span class=\"roster-col-name\" style=\"font-weight: 700; color: var(--dark-text); flex: 2.5; text-align: left;\">${item.name}</span>\r\n                        <span class=\"roster-col-gender\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.gender}</span>\r\n                        <span class=\"roster-col-age\" style=\"color: var(--neutral-color); ${itemStyle} flex: 1;\">${item.ageDisplay}</span>\r\n                        <span class=\"roster-col-checkin\" style=\"font-size: 0.85em; color: var(--neutral-color); font-weight: 500; ${itemStyle} flex: 1;\">${lastCheckInDate}</span>\r\n                    </div>`;\r\n            }\r\n            juniorClubRosterList.appendChild(li); // Add item to list\r\n        });\r\n\r\n        // Re-attach sort listeners to header buttons\r\n        juniorClubRosterList.querySelectorAll('.roster-sort-btn').forEach(btn => {\r\n            btn.removeEventListener('click', handleRosterSortClick); // Prevent duplicates\r\n            btn.addEventListener('click', handleRosterSortClick);\r\n        });\r\n\r\n        // Setup ABC Index\r\n        setupListWithIndex(indexList, juniorClubRosterList, document.getElementById('junior-club-roster-abc-index'));\r\n    }\r\n    \r\n    // New handler for the radio buttons\r\n    function handleRosterTypeFilterChange(e) {\r\n        state.juniorClub.rosterFilter.type = e.target.value;\r\n        saveState();\r\n        renderJuniorClubRoster();\r\n    }\r\n\r\n\r\n    // New handler function for sort button clicks (The correct and final version)\r\n    function handleRosterSortClick(e) {\r\n        // Find the button element by traversing up from the click target\r\n        const button = e.target.closest('[data-sort-key]');\r\n        if (!button) return;\r\n\r\n        const key = button.dataset.sortKey;\r\n        if (key) {\r\n            if (state.juniorClub.rosterFilter.sortKey === key) {\r\n                state.juniorClub.rosterFilter.sortOrder = state.juniorClub.rosterFilter.sortOrder === 'asc' ? 'desc' : 'asc';\r\n            } else {\r\n                state.juniorClub.rosterFilter.sortKey = key;\r\n                state.juniorClub.rosterFilter.sortOrder = key === 'name' ? 'asc' : 'desc';\r\n            }\r\n            saveState();\r\n            renderJuniorClubRoster();\r\n        }\r\n    }\r\n\r\n    function isChildFieldComplete(group) {\r\n        const childName = group.querySelector('[name=\"childName\"]').value.trim();\r\n        const childSurname = group.querySelector('[name=\"childSurname\"]').value.trim();\r\n        const childDob = group.querySelector('[name=\"childBirthDate\"]').value;\r\n        const childGender = group.querySelector(`input[name^=\"child-gender\"]:checked`);\r\n\r\n        return childName.length > 0 && childSurname.length > 0 && !!childDob && !!childGender;\r\n    }\r\n\r\n    function checkAndCollapseChild(group) {\r\n        const isComplete = isChildFieldComplete(group);\r\n        group.dataset.complete = isComplete ? 'true' : 'false';\r\n    }\r\n\r\n\r\n    function showChildSelectionModal(parent) {\r\n        attendingChildrenList.innerHTML = \"\";\r\n        \r\n        childSelectionModal.dataset.parentId = parent.id;\r\n        childSelectionModal.querySelector('h3').textContent = `${parent.name} ${parent.surname}'s Children`;\r\n\r\n        // NEW: Compile a set of all currently checked-in junior players\r\n        const allCheckedInJuniorNames = new Set([\r\n            ...state.availablePlayers.filter(p => p.isJunior).map(p => p.name),\r\n            ...state.courts.flatMap(c => c.players).filter(p => p.isJunior).map(p => p.name),\r\n            // CRITICAL ADDITION: Include activeChildren from the junior club state\r\n            ...state.juniorClub.activeChildren.map(c => c.name) \r\n        ]);\r\n\r\n        parent.registeredChildren.forEach(child => {\r\n            const li = document.createElement('li');\r\n            // FIX 1: Trim the reconstructed full name string for the checkbox value.\r\n            const childFullName = `${child.name} ${child.surname}`.trim();\r\n            li.innerHTML = `\r\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\r\n                    <input type=\"checkbox\" name=\"attendingChild\" value=\"${childFullName}\" data-child-name=\"${child.name}\" style=\"margin-right: 1rem;\">\r\n                    <div style=\"flex-grow: 1;\">\r\n                        <span style=\"font-weight: 500;\">${child.name} ${child.surname}</span>\r\n                    </div>\r\n                </label>\r\n            `;\r\n            attendingChildrenList.appendChild(li);\r\n        });\r\n        \r\n        childSelectionConfirmBtn.disabled = true;\r\n        childSelectionConfirmBtn.textContent = 'Check In (0 Children)';\r\n        \r\n        juniorClubModal.classList.add('hidden');\r\n        childSelectionModal.classList.remove('hidden');\r\n    }\r\n\r\n\r\n    /**\r\n     * Renders the main Junior Club check-in list, dynamically switching between\r\n     * Parent Name and Child Name display based on state.juniorClub.checkInFilter.displayMode.\r\n     */\r\n    function renderJuniorClubCheckInList() {\r\n        juniorClubList.innerHTML = \"\";\r\n        \r\n        const displayMode = state.juniorClub.checkInFilter.displayMode;\r\n        \r\n        // --- START OF NEW FILTER HTML INJECTION ---\r\n        const filterHTML = `\r\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\r\n                <div class=\"radio-group\" id=\"junior-club-name-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\r\n                    <label> <input type=\"radio\" name=\"junior-club-name-filter\" value=\"parent\" ${displayMode === 'parent' ? 'checked' : ''}> Parent Name</label>\r\n                    <label> <input type=\"radio\" name=\"junior-club-name-filter\" value=\"child\" ${displayMode === 'child' ? 'checked' : ''}> Child Name</label>\r\n                </div>\r\n            </div>\r\n        `;\r\n        juniorClubList.insertAdjacentHTML('afterbegin', filterHTML);\r\n        \r\n        // RE-ATTACH LISTENER to the newly injected radio group\r\n        juniorClubList.querySelector('#junior-club-name-filter-group').addEventListener('change', handleJuniorClubNameFilterChange);\r\n        // --- END OF NEW FILTER HTML INJECTION ---\r\n\r\n        \r\n        // 1. Get a list of all player names currently at the club (available or on court)\r\n        const checkedInPlayerNames = new Set(state.juniorClub.activeChildren.map(c => c.name));\r\n        \r\n        let finalListItems = [];\r\n        state.juniorClub.parents.forEach(parent => {\r\n            parent.registeredChildren.forEach(child => {\r\n                const childFullName = `${child.name} ${child.surname}`.trim();\r\n                const isCheckedIn = checkedInPlayerNames.has(childFullName);\r\n                \r\n                const age = calculateAge(child.birthDate);\r\n                const gender = child.gender || '?';\r\n                const ageDisplay = age !== null ? `${age}y` : 'N/A';\r\n                \r\n                const item = {\r\n                    parent: parent,\r\n                    childFullName: childFullName,\r\n                    childName: child.name,\r\n                    childSurname: child.surname,\r\n                    childDisplay: `${child.name.split(' ')[0]} (${ageDisplay} ${gender})`,\r\n                    canCheckIn: !isCheckedIn,\r\n                    sortKey: displayMode === 'parent' ? parent.name : child.name,\r\n                };\r\n                finalListItems.push(item);\r\n            });\r\n        });\r\n        \r\n        let renderedList = [];\r\n\r\n        if (displayMode === 'parent') {\r\n            // Find all parents who have at least one child available for check-in. This now works correctly.\r\n            const availableParents = state.juniorClub.parents.filter(parent => \r\n                parent.registeredChildren.some(child => !checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim()))\r\n            ).sort((a, b) => a.name.localeCompare(b.name));\r\n            \r\n            renderedList = availableParents.map(parent => {\r\n                // Find the first child who is NOT checked in to display their details\r\n                const firstAvailableChild = parent.registeredChildren.find(child => !checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim())) || parent.registeredChildren[0];\r\n                \r\n                const age = calculateAge(firstAvailableChild.birthDate);\r\n                const gender = firstAvailableChild.gender || '?';\r\n                const ageDisplay = age !== null ? `${age}y` : 'N/A';\r\n                \r\n                // Count how many children are NOT checked in for this parent\r\n                const availableChildCount = parent.registeredChildren.filter(child => !checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim())).length;\r\n                \r\n                return {\r\n                    parent: parent,\r\n                    primaryDisplay: `${parent.name} ${parent.surname}`,\r\n                    secondaryDisplay: `${firstAvailableChild.name.split(' ')[0]} (${ageDisplay} ${gender})`,\r\n                    childCount: availableChildCount,\r\n                    sortKey: parent.name,\r\n                    canCheckIn: true,\r\n                };\r\n            });\r\n            \r\n        } else { // displayMode === 'child'\r\n            // Filter to show only children who are NOT checked in. This also works correctly now.\r\n            renderedList = finalListItems\r\n                .filter(item => item.canCheckIn)\r\n                .sort((a, b) => a.sortKey.localeCompare(b.sortKey))\r\n                .map(item => ({\r\n                    parent: item.parent,\r\n                    primaryDisplay: `${item.childName} ${item.childSurname}`,\r\n                    secondaryDisplay: `Parent: ${item.parent.name} ${item.parent.surname}`,\r\n                    sortKey: item.sortKey,\r\n                    canCheckIn: true,\r\n                }));\r\n        }\r\n\r\n        if (renderedList.length === 0) { \r\n            const li = document.createElement(\"li\");\r\n            li.style.justifyContent = \"center\";\r\n            li.style.textAlign = \"center\";\r\n            li.style.color = \"#6c757d\";\r\n            li.textContent = \"All junior players are currently checked in.\";\r\n            juniorClubList.appendChild(li);\r\n        } else {\r\n            renderedList.forEach(item => {\r\n                const parent = item.parent;\r\n                const li = document.createElement(\"li\");\r\n                \r\n                // This logic correctly determines if the parent has ANY child left to check in\r\n                const canCheckIn = parent.registeredChildren.some(child => !checkedInPlayerNames.has(`${child.name} ${child.surname}`.trim()));\r\n                \r\n                const childCountDisplay = (displayMode === 'parent' && item.childCount > 0)\r\n                    ? `${item.childCount} Child${item.childCount === 1 ? '' : 'ren'}`\r\n                    : '';\r\n                \r\n                // Set opacity to 0.5 if no children are available for check-in\r\n                const checkInIcon = canCheckIn\r\n                    ? `<span class=\"action-icon add\" data-parent-id=\"${parent.id}\">+</span>`\r\n                    : `<span class=\"action-icon\" data-parent-id=\"${parent.id}\" style=\"color: var(--neutral-color); opacity: 0.5;\">+</span>`;\r\n                \r\n                const displayContainerStyle = \"flex-grow: 1; font-weight: 500; display: flex; flex-direction: column;\";\r\n\r\n                li.innerHTML = `\r\n                    <span style=\"${displayContainerStyle}\">\r\n                        <span style=\"font-weight: 500;\">${item.primaryDisplay}</span>\r\n                        <span style=\"font-size: 0.9em; color: #6c757d;\">${item.secondaryDisplay}</span>\r\n                    </span>\r\n                    <span style=\"margin-right: 1rem; color: #6c757d; min-width: 70px; text-align: right;\">${childCountDisplay}</span>\r\n                    <span class=\"action-icon edit\" data-parent-id=\"${parent.id}\" title=\"Edit Parent\"><i class=\"mdi mdi-pencil\"></i></span>\r\n                    ${checkInIcon}\r\n                `;\r\n                \r\n                li.dataset.parentId = parent.id;\r\n                li.dataset.playerName = item.primaryDisplay; // CRITICAL: Set for indexing\r\n                juniorClubList.appendChild(li);\r\n            });\r\n        }\r\n        \r\n        // CRITICAL: Setup the index\r\n        const indexList = renderedList.map(item => ({ name: item.primaryDisplay }));\r\n            \r\n        setupListWithIndex(indexList, juniorClubList, document.getElementById('junior-club-abc-index'));\r\n    }\r\n\r\n    // New wrapper function to update the entire modal display\r\n    function showJuniorClubModal() {\r\n        // Render the list with the current filter settings\r\n        renderJuniorClubCheckInList();\r\n        setActiveMobileMenuItem('mobile-junior-club-btn');\r\n        juniorClubModal.classList.remove('hidden');\r\n    }\r\n\r\n    // Function to handle filter change\r\n    function handleJuniorClubNameFilterChange(e) {\r\n        state.juniorClub.checkInFilter.displayMode = e.target.value;\r\n        saveState();\r\n        renderJuniorClubCheckInList();\r\n    }\r\n\r\n    function showChildSelectionModal(parent) {\r\n        attendingChildrenList.innerHTML = \"\";\r\n        \r\n        childSelectionModal.dataset.parentId = parent.id;\r\n        childSelectionModal.querySelector('h3').textContent = `${parent.name} ${parent.surname}'s Children`;\r\n\r\n        // NEW: Compile a set of all currently checked-in junior players\r\n        const allCheckedInJuniorNames = new Set([\r\n            ...state.availablePlayers.filter(p => p.isJunior).map(p => p.name),\r\n            ...state.courts.flatMap(c => c.players).filter(p => p.isJunior).map(p => p.name),\r\n            // CRITICAL ADDITION: Include activeChildren from the junior club state\r\n            ...state.juniorClub.activeChildren.map(c => c.name) \r\n        ]);\r\n\r\n        parent.registeredChildren.forEach(child => {\r\n            const li = document.createElement('li');\r\n            // FIX 1: Trim the reconstructed full name string for the checkbox value.\r\n            const childFullName = `${child.name} ${child.surname}`.trim();\r\n            li.innerHTML = `\r\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\r\n                    <input type=\"checkbox\" name=\"attendingChild\" value=\"${childFullName}\" data-child-name=\"${child.name}\" style=\"margin-right: 1rem;\">\r\n                    <div style=\"flex-grow: 1;\">\r\n                        <span style=\"font-weight: 500;\">${child.name} ${child.surname}</span>\r\n                    </div>\r\n                </label>\r\n            `;\r\n            attendingChildrenList.appendChild(li);\r\n        });\r\n        \r\n        childSelectionConfirmBtn.disabled = true;\r\n        childSelectionConfirmBtn.textContent = 'Check In (0 Children)';\r\n        \r\n        juniorClubModal.classList.add('hidden');\r\n        childSelectionModal.classList.remove('hidden');\r\n    }\r\n\r\n    function validateNewParentForm(shouldRender = true) {\r\n        const parentName = parentNameInput.value.trim();\r\n        const parentSurname = parentSurnameInput.value.trim();\r\n        const parentEmail = parentEmailInput.value.trim(); // <-- ADDED email input reading\r\n        const parentPhone = parentPhoneInput.value.trim();\r\n\r\n        // Basic email validation: check if it contains @ and has text before and after\r\n        const isEmailValid = parentEmail.includes('@') && parentEmail.indexOf('@') > 0 && parentEmail.indexOf('@') < parentEmail.length - 1; // <-- ADDED email validation\r\n\r\n        // FIX: Changed phone validation from >= 9 to >= 8 and ADDED email check\r\n        const parentFieldsValid = parentName.length > 0 && parentSurname.length > 0 && isEmailValid && parentPhone.length >= 8; // <-- UPDATED condition\r\n\r\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\r\n        let allChildrenComplete = childGroups.length > 0; // Assume complete if > 0 children exist initially\r\n\r\n        const addChildBtn = document.getElementById('add-child-btn');\r\n        const removeChildBtn = document.getElementById('remove-child-btn-main'); // Ensure this ID matches your HTML\r\n        const lastChildGroup = childGroups.length > 0 ? childGroups[childGroups.length - 1] : null;\r\n\r\n        childGroups.forEach((group) => {\r\n            // Check each child group; if ANY are incomplete, set allChildrenComplete to false\r\n            if (!isChildFieldComplete(group)) {\r\n                allChildrenComplete = false;\r\n            }\r\n        });\r\n\r\n        const shouldParentBeCollapsed = parentFieldsValid;\r\n        const shouldChildrenBeExpanded = parentFieldsValid; // Children section expands when parent is valid\r\n\r\n        // Update the state based on validation results\r\n        state.juniorClub.registrationFlow.parentCollapsed = shouldParentBeCollapsed;\r\n        state.juniorClub.registrationFlow.childrenExpanded = shouldChildrenBeExpanded;\r\n\r\n        // Can add a child if parent is valid AND (either no children exist OR the last child is complete)\r\n        const canAddChild = parentFieldsValid && (!lastChildGroup || isChildFieldComplete(lastChildGroup));\r\n\r\n        // Can remove a child only if there's more than one child group present\r\n        const canRemoveChild = childGroups.length > 1; // Simplified this condition\r\n\r\n        // Show/hide/disable Add Child button\r\n        if (addChildBtn) {\r\n            addChildBtn.style.display = shouldChildrenBeExpanded ? 'block' : 'none'; // Only show if children section is expanded\r\n            addChildBtn.disabled = !canAddChild;\r\n        }\r\n\r\n        // Show/hide/disable Remove Child button\r\n        if (removeChildBtn) {\r\n            removeChildBtn.style.display = shouldChildrenBeExpanded && childGroups.length > 0 ? 'block' : 'none'; // Show if children expanded and > 0 exist\r\n            removeChildBtn.disabled = !canRemoveChild;\r\n        }\r\n\r\n        // Determine if the final Confirm button should be enabled\r\n        const isConfirmReady = parentFieldsValid && allChildrenComplete;\r\n        newParentConfirmBtn.disabled = !isConfirmReady;\r\n\r\n        // Update Confirm button styling based on readiness\r\n        if (isConfirmReady) {\r\n            newParentConfirmBtn.style.setProperty('background-color', 'var(--confirm-color)', 'important');\r\n            newParentConfirmBtn.style.setProperty('border-color', 'var(--confirm-color)', 'important');\r\n        } else {\r\n            newParentConfirmBtn.style.setProperty('background-color', 'var(--inactive-color)', 'important');\r\n            newParentConfirmBtn.style.setProperty('border-color', 'var(--inactive-color)', 'important');\r\n        }\r\n\r\n        // Render the parent form UI based on the updated state if requested\r\n        if (shouldRender) {\r\n            renderParentForm();\r\n        }\r\n    }\r\n\r\n    function registerNewParent() {\r\n        const parentName = formatCase(parentNameInput.value.trim());\r\n        const parentSurname = formatCase(parentSurnameInput.value.trim());\r\n        const parentEmail = parentEmailInput.value.trim().toLowerCase(); // <-- Store email lowercase\r\n        const parentPhone = parentPhoneInput.value.trim();\r\n\r\n        // Get country code and create full phone number\r\n        const countryCode = document.getElementById('parent-country-code')?.value || '+27';\r\n        const fullPhone = countryCode + parentPhone; // No leading zero needed with country code\r\n\r\n        // Determine mode and parent ID\r\n        const currentMode = newParentModal.dataset.mode || 'new'; // 'new' or 'edit'\r\n        const newParentId = parentName + parentSurname; // Potential new ID based on current name/surname\r\n\r\n        // 1. Collect all child data\r\n        const children = [];\r\n        childrenContainer.querySelectorAll('.child-field-group').forEach(group => {\r\n            const childName = formatCase(group.querySelector('[name=\"childName\"]').value.trim());\r\n            const childSurname = formatCase(group.querySelector('[name=\"childSurname\"]').value.trim());\r\n            const childBirthDate = group.querySelector('[name=\"childBirthDate\"]').value;\r\n            const childGenderChecked = group.querySelector('input[type=\"radio\"]:checked');\r\n            const childGender = childGenderChecked ? childGenderChecked.value : '?';\r\n\r\n            // Ensure all child fields are actually filled before adding\r\n            if (childName && childSurname && childBirthDate && childGender !== '?') {\r\n                children.push({\r\n                    name: childName,\r\n                    surname: childSurname,\r\n                    gender: childGender,\r\n                    birthDate: childBirthDate\r\n                });\r\n            }\r\n        });\r\n\r\n        // Basic validation: Must have filled parent details and at least one complete child\r\n        const parentFieldsValid = parentName.length > 0 && parentSurname.length > 0 && parentEmail.includes('@') && parentPhone.length >= 8;\r\n        if (!parentFieldsValid || children.length === 0) {\r\n            playCustomTTS(\"Please complete all parent and child details before confirming.\");\r\n            return; // Stop if validation fails\r\n        }\r\n\r\n\r\n        // 2. Check for duplicate Parent ID during NEW registration\r\n        //    (Only check if it's NOT edit mode AND the potential new ID already exists)\r\n        if (currentMode !== 'edit' && state.juniorClub.parents.some(p => p.id === newParentId)) {\r\n            playCustomTTS(\"A parent with this name is already registered.\");\r\n            return;\r\n        }\r\n\r\n        let parentToUpdate = null;\r\n        if (currentMode === 'edit') {\r\n            // In Edit mode, find the original parent entry using the stored original ID\r\n            const originalId = newParentModal.dataset.originalParentId;\r\n            parentToUpdate = state.juniorClub.parents.find(p => p.id === originalId);\r\n            if (!parentToUpdate) {\r\n                console.error(\"Error editing parent: Original parent not found with ID\", originalId);\r\n                playCustomTTS(\"Error finding parent profile to update.\");\r\n                return; // Stop if original parent not found\r\n            }\r\n        }\r\n\r\n        // 3. Create or Update Parent Object\r\n        if (parentToUpdate) {\r\n            // --- EDIT MODE: Update existing parent ---\r\n            parentToUpdate.name = parentName;\r\n            parentToUpdate.surname = parentSurname;\r\n            parentToUpdate.phone = fullPhone;\r\n            parentToUpdate.email = parentEmail; // <-- SAVING EMAIL\r\n            parentToUpdate.id = newParentId; // Update ID in case name/surname changed\r\n            parentToUpdate.registeredChildren = children; // Overwrite children list\r\n\r\n            playCustomTTS(`${parentName}'s profile has been successfully updated.`);\r\n        } else {\r\n            // --- NEW REGISTRATION MODE ---\r\n            parentToUpdate = {\r\n                id: newParentId,\r\n                name: parentName,\r\n                surname: parentSurname,\r\n                phone: fullPhone,\r\n                email: parentEmail, // <-- SAVING EMAIL\r\n                registeredChildren: children\r\n            };\r\n            state.juniorClub.parents.push(parentToUpdate);\r\n            playCustomTTS(`${parentName} successfully registered.`);\r\n        }\r\n\r\n        // 4. Clean up state and UI\r\n        state.juniorClub.parents.sort((a, b) => a.name.localeCompare(b.name)); // Keep sorted\r\n\r\n        // Restore default modal state for next use\r\n        newParentModal.classList.add('hidden');\r\n        newParentModal.querySelector('h3').textContent = 'New Parent Registration';\r\n        newParentModal.dataset.mode = ''; // Clear mode\r\n        delete newParentModal.dataset.originalParentId; // Clear original ID\r\n        newParentConfirmBtn.textContent = 'Confirm Registration';\r\n        parentNameInput.value = '';\r\n        parentSurnameInput.value = '';\r\n        parentPhoneInput.value = '';\r\n        parentEmailInput.value = ''; // Clear email input\r\n        childrenContainer.innerHTML = '';\r\n        document.getElementById('parent-collapsed-display').innerHTML = ''; // Clear summary display\r\n\r\n        // Reset the flow state\r\n        state.juniorClub.registrationFlow = {\r\n            parentCollapsed: false,\r\n            childrenExpanded: false,\r\n        };\r\n\r\n        // 5. If it was a NEW registration, proceed to check-in. If it was an EDIT, return to the main list.\r\n        if (currentMode === 'edit') {\r\n            showJuniorClubModal(); // Show updated main list\r\n        } else {\r\n            showChildSelectionModal(parentToUpdate); // Proceed to check-in modal\r\n        }\r\n\r\n        saveState(); // Save changes\r\n    }\r\n\r\n    function showRemoveChildSelectionModal() {\r\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\r\n        if (childGroups.length <= 1) return; // Should be disabled if only one remains\r\n\r\n        childrenForRemovalList.innerHTML = '';\r\n        removeChildSelectionModal.dataset.selectedGroups = '';\r\n\r\n        childGroups.forEach((group, index) => {\r\n            const groupId = group.dataset.groupId;\r\n            const childName = group.querySelector('[name=\"childName\"]').value.trim();\r\n            const childSurname = group.querySelector('[name=\"childSurname\"]').value.trim();\r\n            const displayName = childName || childSurname ? `${childName} ${childSurname}`.trim() : `Child ${index + 1} (Empty)`;\r\n\r\n            const li = document.createElement('li');\r\n            li.innerHTML = `\r\n                <label style=\"flex-grow: 1; display: flex; align-items: center; cursor: pointer;\">\r\n                    <input type=\"checkbox\" name=\"childToRemove\" value=\"${groupId}\" style=\"margin-right: 1rem;\">\r\n                    <div style=\"flex-grow: 1;\">\r\n                        <span style=\"font-weight: 500;\">${displayName}</span>\r\n                    </div>\r\n                </label>\r\n            `;\r\n            childrenForRemovalList.appendChild(li);\r\n        });\r\n\r\n        // Reset Confirm button state\r\n        removeChildSelectionConfirmBtn.disabled = true;\r\n        removeChildSelectionConfirmBtn.textContent = 'Remove Selected (0 Children)';\r\n        \r\n        newParentModal.classList.add('hidden');\r\n        removeChildSelectionModal.classList.remove('hidden');\r\n    }\r\n\r\n    function executeRemoveSingleChild() {\r\n        const groupId = cancelConfirmModal.dataset.childGroupId;\r\n        const groupToRemove = document.querySelector(`.child-field-group[data-group-id=\"${groupId}\"]`);\r\n        if (groupToRemove) {\r\n            groupToRemove.remove();\r\n        }\r\n\r\n        // If that was the last child, add a new empty form to start over\r\n        if (childrenContainer.querySelectorAll('.child-field-group').length === 0) {\r\n            generateChildField();\r\n        }\r\n\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n        newParentModal.classList.remove('hidden'); // Re-show the parent registration form\r\n        validateNewParentForm();\r\n        resetConfirmModal();\r\n    }\r\n\r\n    // --- NEW FUNCTION: Executes the removal of selected child fields ---\r\n    function executeRemoveChild() {\r\n        const selectedIds = Array.from(childrenForRemovalList.querySelectorAll('input[name=\"childToRemove\"]:checked')).map(cb => cb.value);\r\n\r\n        if (selectedIds.length === 0) return;\r\n\r\n        selectedIds.forEach(id => {\r\n            const groupToRemove = document.querySelector(`.child-field-group[data-group-id=\"${id}\"]`);\r\n            if (groupToRemove) {\r\n                groupToRemove.remove();\r\n            }\r\n        });\r\n        \r\n        // --- START OF FIX ---\r\n        // After removal, check if any child groups are left.\r\n        const remainingChildGroups = childrenContainer.querySelectorAll('.child-field-group').length;\r\n        if (remainingChildGroups === 0) {\r\n            // If no children are left, automatically add a new, empty child field.\r\n            generateChildField();\r\n        }\r\n        // --- END OF FIX ---\r\n\r\n        removeChildSelectionModal.classList.add('hidden');\r\n        newParentModal.classList.remove('hidden');\r\n        validateNewParentForm();\r\n    }\r\n    \r\n    // TEMPORARY DUTY HANDOVER LISTENERS\r\n    tempDutyCancelBtn.addEventListener('click', () => {\r\n        tempDutyHandoverModal.classList.add('hidden');\r\n        tempDutyHandoverModal.callback = null;\r\n    });\r\n\r\n    tempDutyConfirmBtn.addEventListener('click', handleTempDutyHandoverConfirm);\r\n\r\n    // New Parent Modal: Handle the main Remove Child button click\r\n    document.getElementById('remove-child-btn-main').addEventListener('click', () => {\r\n        const childGroups = childrenContainer.querySelectorAll('.child-field-group');\r\n        \r\n        if (childGroups.length > 1) {\r\n            // If more than one child exists, show the selection modal as before.\r\n            showRemoveChildSelectionModal();\r\n        } else if (childGroups.length === 1) {\r\n            // --- NEW LOGIC ---\r\n            // If exactly one child exists, show a direct confirmation prompt.\r\n            const childToRemove = childGroups[0];\r\n            const childName = childToRemove.querySelector('[name=\"childName\"]').value.trim() || 'this child';\r\n            \r\n            cancelConfirmModal.querySelector(\"h3\").textContent = \"Confirm Removal\";\r\n            cancelConfirmModal.querySelector(\"p\").textContent = `Are you sure you want to remove ${childName}?`;\r\n            modalBtnYesConfirm.textContent = \"Confirm\";\r\n            modalBtnNo.textContent = \"Close\";\r\n            \r\n            // Set a new mode for our confirmation logic\r\n            cancelConfirmModal.dataset.mode = \"removeSingleChild\";\r\n            cancelConfirmModal.dataset.childGroupId = childToRemove.dataset.groupId;\r\n            \r\n            newParentModal.classList.add('hidden'); // Hide the parent form temporarily\r\n            cancelConfirmModal.classList.remove(\"hidden\"); // Show the confirmation\r\n        }\r\n    });\r\n\r\n    // Remove Child Selection Modal Listeners\r\n    removeChildSelectionBackBtn.addEventListener('click', () => {\r\n        removeChildSelectionModal.classList.add('hidden');\r\n        newParentModal.classList.remove('hidden');\r\n    });\r\n\r\n    removeChildSelectionConfirmBtn.addEventListener('click', executeRemoveChild);\r\n\r\n    // Update Confirm button on selection change\r\n    childrenForRemovalList.addEventListener('change', () => {\r\n        const checkedCount = childrenForRemovalList.querySelectorAll('input[name=\"childToRemove\"]:checked').length;\r\n        const isReady = checkedCount > 0;\r\n        \r\n        removeChildSelectionConfirmBtn.disabled = !isReady;\r\n        removeChildSelectionConfirmBtn.textContent = `Remove Selected (${checkedCount} Child${checkedCount === 1 ? '' : 'ren'})`;\r\n        \r\n        // --- START OF RESTRUCTURED CODE ---\r\n        if (isReady) {\r\n            // When ready, style as a white button with blue text and border\r\n            removeChildSelectionConfirmBtn.style.setProperty('background-color', 'white', 'important');\r\n            removeChildSelectionConfirmBtn.style.setProperty('color', 'var(--primary-blue)', 'important');\r\n            removeChildSelectionConfirmBtn.style.setProperty('border', '2px solid var(--primary-blue)', 'important');\r\n        } else {\r\n            // When disabled, revert to a neutral grey style\r\n            removeChildSelectionConfirmBtn.style.setProperty('background-color', 'var(--neutral-color)', 'important');\r\n            removeChildSelectionConfirmBtn.style.setProperty('color', 'white', 'important');\r\n            removeChildSelectionConfirmBtn.style.setProperty('border', '2px solid var(--neutral-color)', 'important');\r\n        }\r\n        // --- END OF RESTRUCTURED CODE ---\r\n    });\r\n\r\n\r\n    function handleChildSelectionConfirm() {\r\n        const parentId = childSelectionModal.dataset.parentId;\r\n        const parent = state.juniorClub.parents.find(p => p.id === parentId);\r\n        \r\n        if (!parent) return;\r\n\r\n        const attendingCheckboxes = attendingChildrenList.querySelectorAll('input[name=\"attendingChild\"]:checked');\r\n        const attendingChildrenNames = Array.from(attendingCheckboxes).map(cb => cb.value);\r\n\r\n        if (attendingChildrenNames.length === 0) return; \r\n\r\n        const attendingChildren = parent.registeredChildren\r\n            .filter(child => attendingChildrenNames.includes(`${child.name} ${child.surname}`.trim()))\r\n            .map(child => ({\r\n                name: `${child.name} ${child.surname}`.trim(), \r\n                gender: child.gender,\r\n                guest: true,\r\n                isJunior: true, \r\n                parentName: parent.name + ' ' + parent.surname\r\n            }));\r\n        \r\n        const allCheckedInNames = new Set([\r\n            ...state.availablePlayers.map(p => p.name),\r\n            ...state.courts.flatMap(c => c.players).map(p => p.name),\r\n            ...state.juniorClub.activeChildren.map(c => c.name),\r\n        ]);\r\n\r\n        const newChildren = attendingChildren.filter(c => !allCheckedInNames.has(c.name));\r\n        \r\n        if (newChildren.length === 0) {\r\n            // playCustomTTS(\"All selected children are already checked in.\");\r\n            childSelectionModal.classList.add('hidden');\r\n            showJuniorClubModal(); // Show the main junior list again\r\n            return;\r\n        }\r\n        \r\n        state.juniorClub.activeChildren.push(...newChildren);\r\n\r\n        const newHistoryEntry = {\r\n            id: Date.now(),\r\n            parentId: parent.id,\r\n            parentName: `${parent.name} ${parent.surname}`,\r\n            childNames: newChildren.map(c => c.name),\r\n            date: new Date().toISOString().split('T')[0],\r\n            isPaid: false, \r\n        };\r\n        state.juniorClub.history.push(newHistoryEntry);\r\n        \r\n        // --- START OF CHANGE ---\r\n        // The following block that pushes children to the main availablePlayers list has been removed.\r\n        // --- END OF CHANGE ---\r\n\r\n        childSelectionModal.classList.add('hidden');\r\n        \r\n        const numCheckedIn = newChildren.length;\r\n        const childString = numCheckedIn === 1 ? 'child' : 'children';\r\n        // playCustomTTS(`${numCheckedIn} ${childString} checked in for ${parent.name}.`);\r\n        \r\n        // Refresh the junior club list to show the updated check-in status\r\n        showJuniorClubModal(); \r\n        saveState();\r\n    }\r\n\r\n    function formatChildNames(childNames) {\r\n        return childNames.join(', ');\r\n    }\r\n\r\n    function showJuniorClubStatsModal() {\r\n        juniorClubModal.classList.add('hidden');\r\n        juniorClubStatsModal.classList.remove('hidden');\r\n        \r\n        // Reset the 'details' button state\r\n        juniorClubStatsDetailsBtn.disabled = true;\r\n        juniorClubStatsDetailsBtn.style.backgroundColor = 'var(--inactive-color)';\r\n        \r\n        // Render the list based on the current filter settings\r\n        renderJuniorClubHistory();\r\n    }\r\n\r\n    function renderJuniorClubHistory() {\r\n        juniorClubHistoryList.innerHTML = '';\r\n        \r\n        const filter = state.juniorClub.statsFilter.paid;\r\n        \r\n        // --- START OF NEW FILTER HTML INJECTION ---\r\n        const filterHTML = `\r\n            <div class=\"list-filter-header\" style=\"text-align: center;\">\r\n                <div class=\"radio-group\" id=\"payment-filter-group\" style=\"display: flex; gap: 2rem; justify-content: center; background-color: transparent;\">\r\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"all\" ${filter === 'all' ? 'checked' : ''}> All</label>\r\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"paid\" ${filter === 'paid' ? 'checked' : ''}> Paid</label>\r\n                    <label> <input type=\"radio\" name=\"payment-filter\" value=\"unpaid\" ${filter === 'unpaid' ? 'checked' : ''}> Unpaid</label>\r\n                </div>\r\n            </div>\r\n        `;\r\n        juniorClubHistoryList.insertAdjacentHTML('afterbegin', filterHTML);\r\n\r\n        // RE-ATTACH LISTENER to the newly injected radio group\r\n        juniorClubHistoryList.querySelector('#payment-filter-group').addEventListener('change', handlePaymentFilterChange);\r\n        // --- END OF NEW FILTER HTML INJECTION ---\r\n\r\n        const filteredHistory = state.juniorClub.history.filter(entry => {\r\n            if (filter === 'all') return true;\r\n            if (filter === 'paid') return entry.isPaid === true;\r\n            if (filter === 'unpaid') return entry.isPaid === false;\r\n            return true;\r\n        }).sort((a, b) => b.id - a.id);\r\n\r\n        // --- NEW LOGIC FOR ABC INDEXING ---\r\n        const indexList = filteredHistory.map(entry => ({ name: entry.parentName }));\r\n\r\n        if (filteredHistory.length === 0) {\r\n            document.getElementById('junior-club-history-abc-index').innerHTML = '';\r\n            juniorClubHistoryList.insertAdjacentHTML('beforeend', '<li class=\"waiting-message\">No history matches the current filter.</li>');\r\n            return;\r\n        }\r\n\r\n        filteredHistory.forEach(entry => {\r\n            const li = document.createElement('li');\r\n            li.className = 'history-item';\r\n            li.dataset.entryId = entry.id;\r\n            li.dataset.playerName = entry.parentName; // For ABC index\r\n\r\n            const paymentStatusText = entry.isPaid ? 'Paid' : 'Unpaid';\r\n            const paymentStatusClass = entry.isPaid ? 'paid' : 'unpaid';\r\n            \r\n            const childNamesStr = entry.childNames.join(', ');\r\n            const date = new Date(entry.id).toLocaleDateString('en-ZA');\r\n\r\n            // --- CORRECTED HTML STRUCTURE (No outer wrapper div) ---\r\n            li.innerHTML = `\r\n                <div class=\"name-col\">\r\n                    <span style=\"font-weight: 500; color: var(--dark-text);\">${entry.parentName}</span>\r\n                    <span style=\"font-weight: 400; color: var(--dark-text); font-size: 0.95em; padding-left: 1rem;\">${childNamesStr}</span>\r\n                </div>\r\n                <div class=\"status-col\">\r\n                    <span class=\"payment-status ${paymentStatusClass}\">${paymentStatusText}</span>\r\n                    <span class=\"payment-date-text\" style=\"font-size: 0.85em; color: var(--neutral-color); display: block;\">${date}</span>\r\n                </div>\r\n            `;\r\n            // --- END CORRECTION ---\r\n\r\n            juniorClubHistoryList.appendChild(li);\r\n        });\r\n\r\n        // CRITICAL: Setup the index\r\n        setupListWithIndex(indexList, juniorClubHistoryList, document.getElementById('junior-club-history-abc-index'));\r\n    }\r\n    \r\n    function updateDateDisplay(inputElement) {\r\n        const displayId = `date-display-${inputElement.id.split('-').pop()}`;\r\n        const displayElement = document.getElementById(displayId);\r\n        if (!displayElement) return;\r\n\r\n        const mask = \"YYYY/MM/DD\";\r\n        const cleanValue = inputElement.value.replace(/\\D/g, ''); // Raw numbers (e.g., \"202510\")\r\n        let formattedValue = '';\r\n        let valueIndex = 0;\r\n\r\n        for (let i = 0; i < mask.length; i++) {\r\n            if (valueIndex >= cleanValue.length) {\r\n                // If out of numbers, show the rest of the mask as a faint placeholder\r\n                formattedValue += `<span class=\"date-placeholder\">${mask.substring(i)}</span>`;\r\n                break;\r\n            }\r\n            \r\n            if (mask[i].match(/[YMD]/)) {\r\n                formattedValue += cleanValue[valueIndex];\r\n                valueIndex++;\r\n            } else {\r\n                // Automatically add the '/' separator\r\n                if (cleanValue.length > valueIndex) {\r\n                    formattedValue += mask[i];\r\n                } else {\r\n                    formattedValue += `<span class=\"date-placeholder\">${mask.substring(i)}</span>`;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        \r\n        displayElement.innerHTML = formattedValue;\r\n    }\r\n\r\n    function handleDateInput(currentFormattedValue, key) {\r\n        let rawNumbers = (currentFormattedValue || '').replace(/\\D/g, '');\r\n\r\n        if (key === 'backspace') {\r\n            rawNumbers = rawNumbers.slice(0, -1);\r\n        } else if (key === 'clear') {\r\n            rawNumbers = '';\r\n        } else if (key.match(/[0-9]/) && rawNumbers.length < 8) {\r\n            rawNumbers += key;\r\n        }\r\n\r\n        let formatted = rawNumbers;\r\n        if (rawNumbers.length > 4) {\r\n            formatted = `${rawNumbers.slice(0, 4)}/${rawNumbers.slice(4)}`;\r\n        }\r\n        if (rawNumbers.length > 6) {\r\n            formatted = `${formatted.slice(0, 7)}/${rawNumbers.slice(7)}`;\r\n        }\r\n        return formatted;\r\n    }\r\n\r\n    function handleJuniorClubHistoryClick(e) {\r\n        const li = e.target.closest('.history-item');\r\n        if (!li) return;\r\n\r\n        // Deselect all others\r\n        juniorClubHistoryList.querySelectorAll('.history-item').forEach(item => {\r\n            item.style.backgroundColor = 'transparent';\r\n        });\r\n        \r\n        // Select the clicked one\r\n        li.style.backgroundColor = '#f1f1f1';\r\n        \r\n        // Store the selected entry ID\r\n        juniorClubStatsModal.dataset.selectedEntryId = li.dataset.entryId;\r\n        \r\n        // Enable button\r\n        juniorClubStatsDetailsBtn.disabled = false;\r\n        juniorClubStatsDetailsBtn.style.backgroundColor = 'var(--confirm-color)';\r\n        juniorClubStatsDetailsBtn.style.borderColor = 'var(--confirm-color)';\r\n    }\r\n\r\n    function renderParentForm() {\r\n        const { parentCollapsed, childrenExpanded } = state.juniorClub.registrationFlow;\r\n        console.log('Rendering Form - State Read:', { parentCollapsed, childrenExpanded }); // You should see {true, true}\r\n\r\n        const parentFieldsEl = document.getElementById('parent-fields');\r\n        const parentCollapseEl = document.getElementById('parent-collapsed-display');\r\n        const childrenHeader = newParentModal.querySelector('h4'); // Assuming this selects the \"Children Details\" header\r\n        const childrenContainerWrapper = document.getElementById('children-container-wrapper');\r\n        const childrenContainer = document.getElementById('children-container'); // Make sure this is selected too\r\n\r\n        // --- Parent Section ---\r\n        if (parentCollapseEl) {\r\n            const shouldHideSummary = !parentCollapsed;\r\n            console.log(`Parent Summary (#parent-collapsed-display): Setting hidden=${shouldHideSummary}`);\r\n            parentCollapseEl.classList.toggle('hidden', shouldHideSummary);\r\n            // Verify style after toggle\r\n            requestAnimationFrame(() => console.log(`Parent Summary computed display: ${window.getComputedStyle(parentCollapseEl).display}`));\r\n        } else {\r\n            console.error(\"ELEMENT NOT FOUND: #parent-collapsed-display\");\r\n        }\r\n\r\n        if (parentFieldsEl) {\r\n            const newParentFieldsDisplay = parentCollapsed ? 'none' : 'block';\r\n            console.log(`Parent Fields (#parent-fields): Setting display=${newParentFieldsDisplay}`);\r\n            parentFieldsEl.style.display = newParentFieldsDisplay;\r\n            // Verify style after setting\r\n            requestAnimationFrame(() => console.log(`Parent Fields computed display: ${window.getComputedStyle(parentFieldsEl).display}`));\r\n        } else {\r\n            console.error(\"ELEMENT NOT FOUND: #parent-fields\");\r\n        }\r\n\r\n        // --- Populate Parent Summary (Only if collapsed and element exists) ---\r\n        if (parentCollapsed && parentCollapseEl) {\r\n            console.log(\"Populating parent summary...\");\r\n            const parentName = document.getElementById('parent-name-input')?.value.trim(); // Use safe navigation ?.\r\n            const parentSurname = document.getElementById('parent-surname-input')?.value.trim();\r\n            const parentEmail = document.getElementById('parent-email-input')?.value.trim();\r\n            const parentPhone = document.getElementById('parent-phone-input')?.value.trim();\r\n\r\n            parentCollapseEl.innerHTML = `\r\n                <div class=\"collapsed-summary\">\r\n                    <span>${parentName || '?'} ${parentSurname || '?'}</span>\r\n                    <span>${parentEmail || '?'} | ${parentPhone || '?'}</span>\r\n                </div>\r\n                <i class=\"mdi mdi-pencil edit-icon\"></i>\r\n            `;\r\n            // Re-attach listener logic here...\r\n            if (!parentCollapseEl.dataset.listenerBound) {\r\n                parentCollapseEl.addEventListener('click', (e) => {\r\n                    if (e.target.closest('.collapsed-summary') || e.target.closest('.edit-icon')) {\r\n                        state.juniorClub.registrationFlow.parentCollapsed = false;\r\n                        renderParentForm();\r\n                    }\r\n                });\r\n                parentCollapseEl.dataset.listenerBound = 'true';\r\n            }\r\n        }\r\n\r\n\r\n        // --- Children Section ---\r\n        if (childrenHeader) {\r\n            const shouldHideHeader = !childrenExpanded;\r\n            console.log(`Children Header (h4): Setting hidden=${shouldHideHeader}`);\r\n            childrenHeader.classList.toggle('hidden', shouldHideHeader);\r\n        } else {\r\n            console.warn(\"Children header (h4) not found within newParentModal.\");\r\n        }\r\n\r\n        if (childrenContainerWrapper) {\r\n            const newWrapperDisplay = childrenExpanded ? 'block' : 'none';\r\n            console.log(`Children Wrapper (#children-container-wrapper): Setting display=${newWrapperDisplay}`); // Should log 'block'\r\n            childrenContainerWrapper.style.display = newWrapperDisplay;\r\n            // Verify style after setting\r\n            requestAnimationFrame(() => console.log(`Children Wrapper computed display: ${window.getComputedStyle(childrenContainerWrapper).display}`));\r\n        } else {\r\n            console.error(\"ELEMENT NOT FOUND: #children-container-wrapper\");\r\n        }\r\n\r\n        // --- Generate First Child / Render Children ---\r\n        if (childrenExpanded) {\r\n            if (!childrenContainer) {\r\n                console.error(\"ELEMENT NOT FOUND: #children-container. Cannot add child fields.\");\r\n            } else {\r\n                const childGroupCount = childrenContainer.querySelectorAll('.child-field-group').length;\r\n                console.log(`Checking if first child needed. childrenExpanded=${childrenExpanded}, childGroupCount=${childGroupCount}, parentCollapsed=${parentCollapsed}`);\r\n\r\n                if (childGroupCount === 0 && parentCollapsed) { // Kept original condition for now\r\n                    console.log(\"Condition met: Generating first child field...\");\r\n                    generateChildField();\r\n                } else if (childGroupCount === 0 && !parentCollapsed) {\r\n                    console.log(\"Skipping child generation: Parent not collapsed yet.\");\r\n                } else {\r\n                    console.log(\"Skipping child generation: Child fields already exist.\");\r\n                }\r\n                renderChildFields();\r\n            }\r\n        } else {\r\n            console.log(\"Skipping child generation/rendering: childrenExpanded is false.\");\r\n        }\r\n    }\r\n\r\n    // NEW FUNCTION: Renders each individual child field group (called by renderParentForm)\r\n    function renderChildFields() {\r\n        // --- Find the container once ---\r\n        const container = document.getElementById('children-container');\r\n        if (!container) {\r\n            console.error(\"renderChildFields: #children-container not found!\");\r\n            return;\r\n        }\r\n\r\n        const childGroups = container.querySelectorAll('.child-field-group');\r\n        console.log(`--- renderChildFields START --- Found ${childGroups.length} child groups.`);\r\n\r\n        childGroups.forEach((group, index) => {\r\n            const isComplete = group.dataset.complete === 'true';\r\n            const collapsedDisplay = group.querySelector('.child-collapsed-display');\r\n            const expandedFields = group.querySelector('.child-expanded-fields');\r\n\r\n            console.log(`Group ${index + 1}: isComplete=${isComplete}`);\r\n\r\n            if (!collapsedDisplay) {\r\n                console.error(`Group ${index + 1}: '.child-collapsed-display' element NOT FOUND!`);\r\n            }\r\n            if (!expandedFields) {\r\n                console.error(`Group ${index + 1}: '.child-expanded-fields' element NOT FOUND!`);\r\n            }\r\n\r\n            // --- Toggle Visibility Logic ---\r\n            if (collapsedDisplay) {\r\n                collapsedDisplay.classList.toggle('hidden', !isComplete);\r\n            }\r\n            if (expandedFields) {\r\n                if (isComplete) {\r\n                    console.log(`Group ${index + 1}: Hiding expanded fields.`);\r\n                    expandedFields.style.display = 'none';\r\n                } else {\r\n                    console.log(`Group ${index + 1}: Setting expanded fields display to 'block'.`);\r\n                    expandedFields.style.display = 'block'; // Ensure it's 'block'\r\n                    // Log computed style AFTER setting it, wrapped in requestAnimationFrame\r\n                     requestAnimationFrame(() => {\r\n                        const computedDisplay = window.getComputedStyle(expandedFields).display;\r\n                        console.log(`Group ${index + 1} expanded computed display: ${computedDisplay}`);\r\n                        if (computedDisplay !== 'block') {\r\n                            console.warn(`CSS might be overriding display for Group ${index + 1}`);\r\n                        }\r\n                     });\r\n                }\r\n            }\r\n\r\n            // --- Populate Collapsed Display (Only if complete) ---\r\n            if (isComplete && collapsedDisplay) {\r\n                // Safely get values from inputs within this specific group\r\n                const childName = group.querySelector('[name=\"childName\"]')?.value.trim();\r\n                const childSurname = group.querySelector('[name=\"childSurname\"]')?.value.trim();\r\n                const childDob = group.querySelector('[name=\"childBirthDate\"]')?.value;\r\n                const childGenderChecked = group.querySelector(`input[name^=\"child-gender\"]:checked`);\r\n                const childGender = childGenderChecked ? childGenderChecked.value : '?';\r\n                const childAge = calculateAge(childDob);\r\n\r\n                const genderDisplay = childGender === 'M' ? 'Male' : (childGender === 'F' ? 'Female' : 'N/A');\r\n                const ageDisplay = childAge !== null ? `${childAge}y` : 'N/A';\r\n\r\n                collapsedDisplay.innerHTML = `\r\n                    <span class=\"collapsed-title\">${childName || '?'} ${childSurname || '?'}</span>\r\n                    <span class=\"collapsed-detail\">${ageDisplay} (${genderDisplay})</span>\r\n                    <i class=\"mdi mdi-pencil edit-icon\"></i>\r\n                `;\r\n\r\n                // Re-attach listener if needed (check if already bound)\r\n                 if (!collapsedDisplay.dataset.listenerBound) {\r\n                    collapsedDisplay.addEventListener('click', (e) => {\r\n                         if (e.target.closest('.collapsed-area') || e.target.closest('.edit-icon')) {\r\n                            group.dataset.complete = 'false';\r\n                            renderChildFields();\r\n                         }\r\n                    });\r\n                    collapsedDisplay.dataset.listenerBound = 'true';\r\n                 }\r\n            }\r\n        }); // End forEach\r\n\r\n        console.log(\"--- renderChildFields END ---\");\r\n\r\n        // Revalidate parent form buttons without causing infinite render loop\r\n        validateNewParentForm(false);\r\n    }\r\n\r\n\r\n    // MODIFIED: Entry point for the New Parent Modal\r\n    function showNewParentModal() {\r\n        juniorClubModal.classList.add('hidden');\r\n        \r\n        // --- THIS IS THE FIX ---\r\n        // 1. Reset the modal's title and mode\r\n        newParentModal.querySelector('h3').textContent = 'New Parent Registration';\r\n        newParentModal.dataset.mode = 'new'; // Explicitly set mode to 'new'\r\n        \r\n        // 2. Reset the confirm button text\r\n        newParentConfirmBtn.textContent = 'Confirm Registration';\r\n        // --- END OF FIX ---\r\n\r\n        newParentModal.classList.remove('hidden');\r\n        \r\n        // Reset/Initialize the form flow state\r\n        state.juniorClub.registrationFlow = {\r\n            parentCollapsed: false,\r\n            childrenExpanded: false, // Starts collapsed\r\n        };\r\n        \r\n        // --- AGGRESSIVE FIELD CLEARING ---\r\n        childrenContainer.innerHTML = '';\r\n        parentNameInput.value = '';\r\n        parentSurnameInput.value = '';\r\n        parentEmailInput.value = '';\r\n        parentPhoneInput.value = ''; \r\n        // Clear the collapsed display element's content as well\r\n        document.getElementById('parent-collapsed-display').innerHTML = '';\r\n        \r\n        // CRITICAL FIX: Ensure Parent Fields start visible, and Children start hidden\r\n        document.getElementById('parent-fields').style.display = 'block'; // Ensures expanded fields are visible\r\n        document.getElementById('children-container-wrapper').style.display = 'none'; // Ensures children start hidden\r\n        \r\n        // DON'T add child field yet - wait for parent fields to be filled\r\n        // generateChildField(); \r\n        validateNewParentForm();\r\n        renderParentForm(); // Start the rendering process\r\n    }\r\n\r\n    function handlePaymentFilterChange(e) {\r\n        state.juniorClub.statsFilter.paid = e.target.value;\r\n        renderJuniorClubHistory();\r\n        saveState();\r\n    }\r\n\r\n    function showJuniorClubDetailModal() {\r\n        const entryId = juniorClubStatsModal.dataset.selectedEntryId;\r\n        const entry = state.juniorClub.history.find(e => e.id == entryId);\r\n        \r\n        if (!entry) return;\r\n\r\n        document.getElementById('detail-parent-name').textContent = entry.parentName;\r\n        document.getElementById('detail-date').textContent = new Date(entry.id).toLocaleString('en-ZA');\r\n\r\n        document.getElementById('detail-children-list').innerHTML = entry.childNames.map(name => \r\n            `<li><span>${name}</span></li>`\r\n        ).join('');\r\n        \r\n        updateDetailModalButton(entry);\r\n        \r\n        juniorClubStatsModal.classList.add('hidden');\r\n        juniorClubDetailModal.classList.remove('hidden');\r\n    }\r\n\r\n    function updateDetailModalButton(entry) {\r\n        const isPaid = entry.isPaid;\r\n        detailTogglePaidBtn.textContent = isPaid ? 'Mark as Unpaid' : 'Mark as Paid';\r\n        detailTogglePaidBtn.style.backgroundColor = isPaid ? 'var(--cancel-color)' : 'var(--confirm-color)';\r\n    }\r\n\r\n    function handleDetailTogglePaid() {\r\n        const entryId = juniorClubStatsModal.dataset.selectedEntryId;\r\n        const entry = state.juniorClub.history.find(e => e.id == entryId);\r\n        \r\n        if (!entry) return;\r\n        \r\n        // Toggle the status\r\n        entry.isPaid = !entry.isPaid;\r\n        \r\n        const isNowPaid = entry.isPaid;\r\n        const childrenNames = entry.childNames;\r\n        const parent = state.juniorClub.parents.find(p => p.id === entry.parentId);\r\n        \r\n        if (isNowPaid) {\r\n            // MARKED AS PAID -> CHECK OUT\r\n\r\n            // --- START FIX ---\r\n            // Also remove these children from the activeChildren list to prevent re-check-in issues\r\n            state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter(child => !childrenNames.includes(child.name));\r\n            // --- END FIX ---\r\n\r\n            const checkedOutChildren = state.availablePlayers.filter(p => childrenNames.includes(p.name));\r\n            state.availablePlayers = state.availablePlayers.filter(p => !childrenNames.includes(p.name));\r\n            \r\n            if (checkedOutChildren.length > 0) {\r\n                // playCustomTTS(`${childrenNames.join(' and ')} checked out due to payment.`);\r\n            } else {\r\n                // playCustomTTS(`Payment marked for ${entry.parentName}'s children. They were not currently checked in.`);\r\n            }\r\n\r\n        } else {\r\n            // ... (rest of the function for marking as unpaid is correct)\r\n            // MARKED AS UNPAID -> CHECK BACK IN\r\n            if (parent) {\r\n                const checkedInPlayerNames = new Set([\r\n                    ...state.availablePlayers.map(p => p.name),\r\n                    ...state.courts.flatMap(c => c.players).map(p => p.name)\r\n                ]);\r\n                \r\n                const childrenToReCheckIn = [];\r\n                entry.childNames.forEach(childName => {\r\n                    if (!checkedInPlayerNames.has(childName)) {\r\n                        const childDetails = parent.registeredChildren.find(c => `${c.name} ${c.surname}` === childName);\r\n                        \r\n                        if (childDetails) {\r\n                            childrenToReCheckIn.push({\r\n                                name: childName,\r\n                                gender: childDetails.gender || '?',\r\n                                guest: true,\r\n                                isJunior: true,\r\n                                isPaused: false,\r\n                            });\r\n                        } else {\r\n                            childrenToReCheckIn.push({\r\n                                name: childName,\r\n                                gender: '?',\r\n                                guest: true,\r\n                                isJunior: true,\r\n                                isPaused: false,\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n                \r\n                state.availablePlayers.push(...childrenToReCheckIn);\r\n\r\n                if (childrenToReCheckIn.length > 0) {\r\n                    const names = childrenToReCheckIn.map(c => c.name).join(' and ');\r\n                    // playCustomTTS(`${names} checked back in as ${entry.parentName}'s session is marked unpaid.`);\r\n                } else {\r\n                    // playCustomTTS(`${entry.parentName}'s children are already checked in.`);\r\n                }\r\n            }\r\n        }\r\n        \r\n        updateDetailModalButton(entry);\r\n        // playCustomTTS(`${entry.parentName}'s session on ${new Date(entry.id).toLocaleDateString('en-ZA')} marked as ${entry.isPaid ? 'paid' : 'unpaid'}.`);\r\n        saveState();\r\n        renderJuniorClubHistory();\r\n        updateGameModeBasedOnPlayerCount();\r\n        enforceDutyPosition();\r\n        render();\r\n        checkAndPlayAlert(false);\r\n    }\r\n\r\n    // --- END JUNIOR CLUB HISTORY & STATS FUNCTIONS ---\r\n\r\n\r\n    // --- NEW: Screensaver Activity Listeners ---\r\n    document.addEventListener('click', resetInactivityTimer);\r\n    document.addEventListener('touchstart', resetInactivityTimer);\r\n    document.addEventListener('mousemove', resetInactivityTimer);\r\n    document.addEventListener('keydown', resetInactivityTimer);\r\n\r\n    // Listener specifically for the screensaver overlay\r\n    screensaverOverlay.addEventListener('click', (e) => {\r\n        // Stop screensaver ONLY if the click wasn't on the \"I am interested\" button\r\n        if (!e.target.closest('#screensaver-interested-btn')) {\r\n            stopScreensaver(); // This correctly stops it\r\n        } else {\r\n            // --- MODIFIED BLOCK ---\r\n            const button = e.target.closest('#screensaver-interested-btn');\r\n            const eventId = button ? button.dataset.eventId : null; // Get eventId from button\r\n            if (eventId) {\r\n                populateCheckInModal(); // Populate with members\r\n                checkInModal.style.zIndex = 10000; // Ensure it's above screensaver\r\n                checkInModal.classList.remove('hidden');\r\n                // Store event ID context specifically for screensaver interest\r\n                checkInModal.dataset.screensaverEventId = eventId;\r\n            }\r\n            // --- END MODIFIED BLOCK ---\r\n        }\r\n    });\r\n\r\n    // --- NEW: Event List Modal Listeners ---\r\n    document.getElementById('manage-events-btn')?.addEventListener('click', showEventListModal);\r\n\r\n    document.getElementById('close-event-list-btn')?.addEventListener('click', () => {\r\n        document.getElementById('event-list-modal')?.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden'); // Go back to admin settings\r\n    });\r\n\r\n    document.getElementById('create-new-event-btn')?.addEventListener('click', () => {\r\n        document.getElementById('event-list-modal')?.classList.add('hidden');\r\n        showEventCreateEditModal(); // Open edit modal in 'create' mode\r\n    });\r\n\r\n    // Use event delegation for edit buttons and toggles within the list\r\n    document.getElementById('event-list')?.addEventListener('click', (e) => {\r\n        const button = e.target.closest('.edit-event-btn');\r\n        const deleteButton = e.target.closest('.delete-event-btn');\r\n        const toggle = e.target.closest('.event-active-toggle');\r\n        const listItem = e.target.closest('.event-list-item');\r\n        const eventId = listItem ? listItem.dataset.eventId : null;\r\n\r\n        if (button && eventId) {\r\n            // Edit button clicked\r\n            document.getElementById('event-list-modal')?.classList.add('hidden');\r\n            showEventCreateEditModal(eventId); // Open edit modal in 'edit' mode\r\n        } else if (deleteButton && eventId) {\r\n            // Delete button clicked\r\n            deleteEvent(eventId);\r\n        } else if (toggle && eventId) {\r\n            // Active toggle changed\r\n            const event = state.events.find(ev => ev.id == eventId);\r\n            if (event) {\r\n                event.isActive = toggle.checked;\r\n                saveState();\r\n                // Optional: Provide feedback or maybe restart screensaver if it was running?\r\n\r\n                    // If screensaver is currently running, stopping it will force a refresh next time\r\n                if (!screensaverOverlay.classList.contains('hidden')) {\r\n                    stopScreensaver();\r\n                    resetInactivityTimer(); // Start timer again\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    // --- NEW: Add listener to header logo for manual screensaver start ---\r\n        const headerLogoElement = document.getElementById('header-logo');\r\n        if (headerLogoElement) {\r\n            headerLogoElement.addEventListener('click', () => {\r\n\r\n                // Clear any pending inactivity timer first\r\n                clearTimeout(inactivityTimer);\r\n                inactivityTimer = null; // Clear the timer ID\r\n                // Start the screensaver immediately\r\n                startScreensaver();\r\n            });\r\n        }\r\n        // --- END: Header logo listener ---\r\n\r\n    // --- END: Event List Listeners ---\r\n\r\n\r\n\r\n    // --- END: Screensaver Listeners ---\r\n\r\n\r\n     // --- INITIALIZATION ---\r\n    async function initializeApp() {\r\n        try {\r\n            const response = await fetch('source/members.csv');\r\n            if (!response.ok) {\r\n                throw new Error('Could not load member list from members.csv.');\r\n            }\r\n            const csvText = await response.text();\r\n            MASTER_MEMBER_LIST = parseCSV(csvText);\r\n\r\n\r\n\r\n            // Now that we have the member list, we can proceed\r\n            await loadState(MASTER_MEMBER_LIST);\r\n            // --- ADD THIS LINE ---\r\n            resetChecklistForNewDay(); // Check if checklist needs reset for the current day\r\n            // --- END ADD ---\r\n            state.clubMembers = [...MASTER_MEMBER_LIST].sort((a, b) => a.name.localeCompare(b.name));\r\n            updateGameModeBasedOnPlayerCount();\r\n            autoAssignCourtModes();\r\n            render();\r\n            // Real-time sync setup\r\n            API.onStateUpdate((updatedState) => {\r\n                console.log('🔄 Real-time update received!');\r\n                \r\n                // IGNORE updates if we're making a local change\r\n                if (localChangeInProgress) {\r\n                    console.log('⏸️ Ignoring update - local change in progress');\r\n                    return;\r\n                }\r\n                \r\n                // Set flag to prevent saveState during this update\r\n                state._isReceivingUpdate = true;\r\n                \r\n                const localUIState = {\r\n                    mobileControls: state.mobileControls,\r\n                    notificationControls: state.notificationControls,\r\n                    uiSettings: state.uiSettings\r\n                };\r\n                \r\n                state = { ...state, ...updatedState };\r\n                \r\n                state.mobileControls = localUIState.mobileControls;\r\n                state.notificationControls = localUIState.notificationControls;\r\n                state.uiSettings = localUIState.uiSettings;\r\n                state._isReceivingUpdate = true; // Restore flag after merge\r\n                \r\n                const checkedInNames = new Set();\r\n                if (Array.isArray(state.availablePlayers)) {\r\n                    state.availablePlayers.forEach(p => checkedInNames.add(p.name));\r\n                }\r\n                state.courts.forEach(court => {\r\n                    if (Array.isArray(court.players)) {\r\n                        court.players.forEach(p => checkedInNames.add(p.name));\r\n                    }\r\n                });\r\n                state.clubMembers = MASTER_MEMBER_LIST.filter(p => !checkedInNames.has(p.name));\r\n                state.clubMembers.sort((a,b) => a.name.localeCompare(b.name));\r\n                \r\n                render();\r\n                \r\n                // Clear flag after render completes\r\n                setTimeout(() => {\r\n                    state._isReceivingUpdate = false;\r\n                }, 100);\r\n                \r\n                console.log('✅ UI updated');\r\n            });\r\n            resetInactivityTimer(); // Start the inactivity timer when the app loads\r\n            // CRITICAL FIX: Ensure animations are restored on page load if a selection is active.\r\n            setTimeout(ensureCourtSelectionAnimation, 50);\r\n\r\n            updateNotificationIcons();\r\n            applyFontSize();\r\n            applyDisplaySize();\r\n            fetchWeather();\r\n            updateLightIcon();\r\n            \r\n            if (!state.pongAnimationOffset) {\r\n                state.pongAnimationOffset = Date.now();\r\n            }\r\n\r\n            // START 1-second timers for display updates\r\n            setInterval(() => {\r\n                updateTimers();\r\n            }, 1000);\r\n\r\n            // Start repeating check for alert condition\r\n            const LOGIC_CHECK_INTERVAL_MS = 10 * 1000;\r\n            checkAndPlayAlert(false);\r\n            setInterval(checkAndPlayAlert, LOGIC_CHECK_INTERVAL_MS);\r\n\r\n            // NEW: Interval timer for the \"On a Roll\" text fader\r\n            if (!window.statusFaderInterval) {\r\n                window.statusFaderInterval = setInterval(() => {\r\n                    const faders = document.querySelectorAll('.player-status-fader');\r\n                    faders.forEach(fader => {\r\n                        const statusTexts = Array.from(fader.querySelectorAll('.status-text'));\r\n                        const currentlyVisibleIndex = statusTexts.findIndex(el => el.classList.contains('is-visible'));\r\n\r\n                        if (currentlyVisibleIndex !== -1) {\r\n                            // Hide the current text\r\n                            statusTexts[currentlyVisibleIndex].classList.remove('is-visible');\r\n\r\n                            // Calculate the index of the next text to show\r\n                            const nextIndex = (currentlyVisibleIndex + 1) % statusTexts.length;\r\n                            \r\n                            // Show the next text\r\n                            statusTexts[nextIndex].classList.add('is-visible');\r\n                        }\r\n                    });\r\n                }, 3000); // Fades every 3 seconds\r\n            }\r\n\r\n            let wasMobile = window.innerWidth <= 900; // Initial check\r\n\r\n            window.addEventListener('resize', () => {\r\n                const isMobile = window.innerWidth <= 900;\r\n                // Reload only if the state changes (crossed the 900px boundary)\r\n                if (isMobile !== wasMobile) {\r\n                    location.reload();\r\n                }\r\n                // Update the state for the next resize event\r\n                wasMobile = isMobile;\r\n            });\r\n\r\n            // Start Custom Announcement Features\r\n            setupLongPressPaste();\r\n            startHeaderTextAnimation();\r\n            startCustomTtsScheduler();\r\n            saveChecklistHistory(); // Attempt save on load\r\n\r\n        } catch (error) {\r\n            console.error('Failed to initialize application:', error);\r\n            alert('Error: Could not load master member list. Please ensure \"public/source/members.csv\" exists and is formatted correctly. The application cannot start.');\r\n        }\r\n    }\r\n\r\n    initializeApp();\r\n\r\n\r\n    function populateReturningGuestModal() {\r\n        const returningGuestList = document.getElementById('returning-guest-list');\r\n        returningGuestList.innerHTML = \"\";\r\n\r\n        // --- THIS IS THE NEW LOGIC (Mirrors the fix in the other function) ---\r\n        const checkedInPlayerNames = new Set([\r\n            ...state.availablePlayers.map(p => p.name),\r\n            ...state.courts.flatMap(c => c.players).map(p => p.name)\r\n        ]);\r\n\r\n        const availableGuests = state.guestHistory.filter(g => !checkedInPlayerNames.has(g.name));\r\n        // --- END OF NEW LOGIC ---\r\n\r\n        if (availableGuests.length === 0) {\r\n            const li = document.createElement(\"li\");\r\n            li.textContent = \"All previous guests are checked in or there is no guest history.\";\r\n            li.style.justifyContent = \"center\";\r\n            returningGuestList.appendChild(li);\r\n        } else {\r\n            availableGuests.sort((a, b) => a.name.localeCompare(b.name));\r\n            availableGuests.forEach(guest => {\r\n                const li = document.createElement(\"li\");\r\n                const visits = guest.daysVisited || 1;\r\n                const plural = visits === 1 ? '' : 's';\r\n                li.innerHTML = `\r\n                    <div style=\"display: flex; flex-direction: column; flex-grow: 1;\">\r\n                        <span>${guest.name}</span>\r\n                        <span style=\"font-size: 0.8em; color: #6c757d;\">${visits} visit${plural}</span>\r\n                    </div>\r\n                    <span style=\"margin-right: 1rem; color: #6c757d;\">${guest.gender}</span>\r\n                    <span class=\"action-icon add\" data-player=\"${guest.name}\">+</span>\r\n                `;\r\n                li.dataset.playerName = guest.name;\r\n                returningGuestList.appendChild(li);\r\n            });\r\n        }\r\n        setupListWithIndex(availableGuests, returningGuestList, document.getElementById('returning-guest-abc-index'));\r\n    }\r\n\r\n    function handleReturningGuestCheckIn(playerName) {\r\n        const guestData = state.guestHistory.find(g => g.name === playerName);\r\n        if (!guestData) return;\r\n\r\n        const returningGuestModal = document.getElementById('returning-guest-modal');\r\n        const context = returningGuestModal.dataset.context;\r\n        const today = new Date().toISOString().split('T')[0];\r\n        \r\n        // Only increment daysVisited if it's their first check-in/sale of the day\r\n        if (guestData.lastCheckIn !== today) {\r\n            guestData.daysVisited = (guestData.daysVisited || 0) + 1;\r\n            guestData.lastCheckIn = today;\r\n        }\r\n\r\n        if (context === 'purchaser') {\r\n            delete returningGuestModal.dataset.context;\r\n            confirmPurchaser(playerName, 'returning_guest');\r\n            return;\r\n        }\r\n        \r\n        const playerObject = { ...guestData, isPaused: false };\r\n        state.availablePlayers.push(playerObject);\r\n\r\n        returningGuestModal.classList.add('hidden');\r\n        // FIXED: Re-open the check-in modal after adding the returning guest\r\n        populateCheckInModal(); // Refresh the check-in list\r\n        checkInModal.classList.remove('hidden'); // Re-open check-in modal\r\n        \r\n        updateGameModeBasedOnPlayerCount();\r\n        autoAssignCourtModes();\r\n        render();\r\n        saveState();\r\n        checkAndPlayAlert(false);\r\n    } \r\n\r\n\r\n// BIND ALL INITIAL DOM LISTENERS\r\n\r\n    // Undo History Listeners\r\n    document.getElementById('undo-history-btn')?.addEventListener('click', showUndoHistoryModal);\r\n\r\n    document.getElementById('undo-history-close-btn').addEventListener('click', () => {\r\n        document.getElementById('undo-history-modal').classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    });\r\n\r\n    // Mobile Menu Bar Event Listeners\r\n    if (document.getElementById('mobile-menu-bar')) {\r\n        document.getElementById('mobile-junior-club-btn').addEventListener('click', () => {\r\n            checkInModal.classList.add('hidden');\r\n            checkOutModal.classList.add('hidden');\r\n            showJuniorClubModal();\r\n        });\r\n\r\n        document.getElementById('mobile-history-btn').addEventListener('click', () => {\r\n            state.historyViewMode = 'games';\r\n            renderHistory();\r\n            historyPage.classList.remove(\"hidden\");\r\n        });\r\n\r\n        document.getElementById('mobile-notify-btn').addEventListener('click', handleNotifyNow);\r\n\r\n        document.getElementById('mobile-settings-btn').addEventListener('click', handleAdminLogin);\r\n    }\r\n\r\n    // --- LISTENERS FOR PULL DOWN HEADER ---\r\n    // Attach event listeners\r\n    window.addEventListener('scroll', handleScroll, { passive: true });\r\n    document.addEventListener('touchstart', handleTouchStart, { passive: true });\r\n    document.addEventListener('touchmove', handleTouchMove, { passive: true });\r\n    document.addEventListener('touchend', handleTouchEnd, { passive: true });\r\n    document.addEventListener('mousedown', handleMouseDown);\r\n    document.addEventListener('mousemove', handleMouseMove);\r\n    document.addEventListener('mouseup', handleMouseUp);\r\n\r\n    // Start the auto-hide timer on page load\r\n    startHeaderHideTimer();\r\n\r\n    \r\n    updateOverlaySpacers();\r\n    window.addEventListener('resize', setPlayerListHeight);\r\n    modeDoublesBtn.addEventListener(\"click\",()=>handleModeChange(\"doubles\"));\r\n    modeSinglesBtn.addEventListener(\"click\",()=>handleModeChange(\"singles\"));\r\n    availablePlayersList.addEventListener(\"click\",handlePlayerClick);\r\n    courtGrid.addEventListener(\"click\",handleCourtGridClick);\r\n    modalConfirmBtn.addEventListener(\"click\",handleModalConfirm);\r\n    modalCancelBtn.addEventListener(\"click\",()=>{\r\n        const openedFrom = chooseTeamsModal.dataset.openedFrom;\r\n        const courtId = chooseTeamsModal.dataset.courtId;\r\n        chooseTeamsModal.classList.add(\"hidden\");\r\n        delete chooseTeamsModal.dataset.openedFrom; // Clean up context\r\n\r\n        if (openedFrom === 'endgame' && courtId) {\r\n            // If cancelling from the end game flow, restore the end game button animation\r\n            const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId}\"]`);\r\n            const button = courtCardEl ? courtCardEl.querySelector('.end-game-ball') : null;\r\n            if (button) {\r\n                // Reset the button's state and re-apply the appear animation\r\n                button.classList.remove('hide-anim', 'animate-in');\r\n                setTimeout(() => {\r\n                    button.classList.add('animate-in');\r\n                }, 50);\r\n            }\r\n        }\r\n    });\r\n    modalPlayerList.addEventListener(\"click\",handleModalPlayerClick);\r\n\r\n    historyBtn.addEventListener(\"click\", () => {\r\n        state.historyViewMode = 'games'; // Always start on the game history view\r\n        renderHistory();\r\n        historyPage.classList.remove(\"hidden\");\r\n    });\r\n\r\n    historyCloseBtn.addEventListener(\"click\", () => {\r\n        historyPage.classList.add(\"hidden\");\r\n    });\r\n\r\n    historyToggleViewBtn.addEventListener(\"click\", () => {\r\n        // RESET filters and comparison state before switching views\r\n        resetComparisonState();\r\n        resetStatsFilters();\r\n\r\n        if (state.historyViewMode === 'stats') {\r\n            state.historyViewMode = \"games\";\r\n        } else {\r\n            state.historyViewMode = \"stats\";\r\n        }\r\n        renderHistory();\r\n        saveState();\r\n    });\r\n\r\n    document.getElementById('history-toggle-teams-btn').addEventListener('click', () => {\r\n        // RESET filters and comparison state before switching views\r\n        resetComparisonState();\r\n        resetStatsFilters();\r\n\r\n        if (state.historyViewMode === 'teams') {\r\n            state.historyViewMode = 'games';\r\n        } else {\r\n            state.historyViewMode = 'teams';\r\n        }\r\n        renderHistory();\r\n        saveState();\r\n    });\r\n\r\n    checkInBtn.addEventListener(\"click\",()=>{populateCheckInModal(),checkInModal.classList.remove(\"hidden\")});\r\n    checkInCancelBtn.addEventListener(\"click\",()=> {\r\n        checkInModal.classList.add(\"hidden\");\r\n        // --- NEW: Reset z-index and context on close ---\r\n        checkInModal.style.zIndex = ''; // Reset to default CSS value\r\n        delete checkInModal.dataset.screensaverEventId;\r\n        // --- END NEW ---\r\n    });\r\n\r\n    // --- NEW: Event Create/Edit Modal Listeners ---\r\n    document.getElementById('cancel-event-edit-btn')?.addEventListener('click', () => {\r\n        document.getElementById('event-create-edit-modal')?.classList.add('hidden');\r\n        showEventListModal(); // Go back to the event list\r\n    });\r\n\r\n    // --- THIS LINE ---\r\n    document.getElementById('save-event-btn')?.addEventListener('click', saveEvent);\r\n    // --- END THIS LINE ---\r\n\r\n    // Wire up text inputs to alpha keypad\r\n    wireGlobalKeypadToInput(document.getElementById('event-heading'));\r\n    wireGlobalKeypadToInput(document.getElementById('event-body1'));\r\n    wireGlobalKeypadToInput(document.getElementById('event-body2'));\r\n\r\n    // --- NEW: Wire Body Text inputs to the Global Keyboard ---\r\n    // Note: We create a custom listener instead of using wireAlphaKeypadToInput\r\n    document.getElementById('event-body1')?.addEventListener('click', (e) => showGlobalKeyboard(e.target));\r\n    document.getElementById('event-body2')?.addEventListener('click', (e) => showGlobalKeyboard(e.target));\r\n    \r\n    // --- NEW: Wire phone, email, website fields to Global Keyboard ---\r\n    document.getElementById('event-phone')?.addEventListener('click', function() {\r\n        showGlobalKeyboard(this, 'NumberPad');\r\n    });\r\n    document.getElementById('event-email')?.addEventListener('click', function() {\r\n        showGlobalKeyboard(this, 'LetterPad');\r\n    });\r\n    document.getElementById('event-website')?.addEventListener('click', function() {\r\n        showGlobalKeyboard(this, 'LetterPad');\r\n    });\r\n    // --- END NEW ---\r\n\r\n    // Listeners for sliders to update display\r\n    document.getElementById('event-cost-adult')?.addEventListener('input', () => updateSliderDisplay('event-cost-adult'));\r\n    document.getElementById('event-cost-child')?.addEventListener('input', () => updateSliderDisplay('event-cost-child'));\r\n    document.getElementById('event-participation-discount')?.addEventListener('input', () => updateSliderDisplay('event-participation-discount'));\r\n\r\n    // Delegate clicks for removing interested players\r\n    document.getElementById('interested-players-list')?.addEventListener('click', (e) => {\r\n        const removeButton = e.target.closest('.action-icon.remove');\r\n        const playerName = removeButton?.dataset.playerName;\r\n        const modal = document.getElementById('event-create-edit-modal');\r\n        const eventId = modal?.dataset.editingEventId;\r\n\r\n        if (playerName && eventId) {\r\n            removeInterestedPlayer(playerName, eventId);\r\n        }\r\n    });\r\n    // --- END: Event Create/Edit Listeners ---\r\n\r\n\r\n\r\n    \r\n    document.getElementById('end-game-skip-btn').addEventListener('click', handleSkipButtonClick);\r\n    document.getElementById('reset-app-btn').addEventListener('click', handleResetAppClick);\r\n\r\n    // --- REVISED GLOBAL CLICK LISTENER FOR ALL CARD TOGGLES ---\r\n    document.addEventListener('click', (e) => {\r\n        const toggleButton = e.target.closest('.summary-toggle-btn');\r\n        if (!toggleButton) return;\r\n\r\n        const cardType = toggleButton.dataset.cardType;\r\n        const courtId = toggleButton.dataset.courtId;\r\n        let stateChanged = false;\r\n\r\n        // Find the parent card element\r\n        const cardElement = toggleButton.closest('.court-card, .summary-card, #availablePlayersSection');\r\n        if (!cardElement) return;\r\n\r\n        // Find the icon to toggle\r\n        const icon = toggleButton.querySelector('i');\r\n\r\n        // Toggle the visual state directly in the DOM\r\n        cardElement.classList.toggle('is-collapsed');\r\n        if (icon) {\r\n            icon.classList.toggle('mdi-chevron-up');\r\n            icon.classList.toggle('mdi-chevron-down');\r\n        }\r\n\r\n        // Update the application's internal state so it's remembered\r\n        if (cardType === 'summary') {\r\n            state.mobileControls.isSummaryExpanded = !state.mobileControls.isSummaryExpanded;\r\n            stateChanged = true;\r\n        } else if (cardType === 'players') {\r\n            state.mobileControls.isPlayersExpanded = !state.mobileControls.isPlayersExpanded;\r\n            stateChanged = true;\r\n        } else if (cardType === 'court' && courtId) {\r\n            const court = state.courts.find(c => c.id === courtId);\r\n            if (court) {\r\n                court.isCollapsed = !court.isCollapsed;\r\n                stateChanged = true;\r\n            }\r\n        }\r\n        \r\n        // Save the new state, but DO NOT call render()\r\n        if (stateChanged) {\r\n            saveState();\r\n        }\r\n    });\r\n\r\n    // --- JUNIOR CLUB LISTENERS (Re-added to DOMContentLoaded) ---\r\n   juniorClubBtn.addEventListener('click', () => {\r\n        checkInModal.classList.add('hidden'); \r\n        checkOutModal.classList.add('hidden');\r\n        showJuniorClubModal(); // Calls the new wrapper function\r\n    });\r\n    juniorClubCloseBtn.addEventListener('click', () => {\r\n        // Aggressively clear the sub-modal state before closing the main modal\r\n        childrenContainer.innerHTML = '';\r\n        parentNameInput.value = '';\r\n        parentSurnameInput.value = '';\r\n        parentPhoneInput.value = ''; \r\n        document.getElementById('parent-collapsed-display').innerHTML = '';\r\n        \r\n        // Reset flow state before closing\r\n        state.juniorClub.registrationFlow = {\r\n            parentCollapsed: false,\r\n            childrenExpanded: false,\r\n        };\r\n        \r\n        juniorClubModal.classList.add('hidden');\r\n    });\r\n\r\n\r\n    // New Parent Registration Flow (Corrected Cancel Listener)\r\n    newParentBtn.addEventListener('click', () => {\r\n        // showNewParentModal is called here, which handles all clearing and initial setup\r\n        showNewParentModal(); \r\n    });\r\n\r\n    newParentCancelBtn.addEventListener('click', () => {\r\n        // --- CANCEL ACTION: Aggressively clear all fields and state ---\r\n        childrenContainer.innerHTML = '';\r\n        parentNameInput.value = '';\r\n        parentSurnameInput.value = '';\r\n        parentPhoneInput.value = ''; \r\n        document.getElementById('parent-collapsed-display').innerHTML = '';\r\n        \r\n        // Reset flow state before closing\r\n        state.juniorClub.registrationFlow = {\r\n            parentCollapsed: false,\r\n            childrenExpanded: false,\r\n        };\r\n\r\n        newParentModal.classList.add('hidden');\r\n        juniorClubModal.classList.remove('hidden'); // Return to main junior club list\r\n    });\r\n    newParentConfirmBtn.addEventListener('click', registerNewParent);\r\n\r\n    rosterDetailCloseBtn.addEventListener('click', () => {\r\n        rosterDetailModal.classList.add('hidden');\r\n        juniorClubRosterModal.classList.remove('hidden'); // Return to the roster list\r\n    });\r\n\r\n    // --- NEW LISTENER: Click delegation for Roster Items ---\r\n    juniorClubRosterList.addEventListener('click', (e) => {\r\n        const itemEl = e.target.closest('.roster-item');\r\n        const sortBtn = e.target.closest('.roster-sort-btn');\r\n        \r\n        // Ignore clicks on the sort buttons\r\n        if (sortBtn) return;\r\n        if (!itemEl) return;\r\n        \r\n        const index = parseInt(itemEl.dataset.rosterIndex, 10);\r\n        const rosterData = juniorClubRosterList.rosterData; // Retrieve stored data\r\n        \r\n        if (rosterData && rosterData[index]) {\r\n            showRosterDetailModal(rosterData[index]);\r\n        }\r\n    });\r\n\r\n    // NEW LISTENER: Filter toggle\r\n    if (juniorClubNameFilterGroup) {\r\n        juniorClubNameFilterGroup.addEventListener('change', handleJuniorClubNameFilterChange);\r\n    }\r\n\r\n \r\n\r\n    // Child Fields\r\n    addChildBtn.addEventListener('click', addChild);\r\n    newParentModal.addEventListener('click', (e) => {\r\n        if (e.target.closest('[data-action=\"match-surname\"]')) {\r\n            handleMatchSurname(e);\r\n        } else if (e.target.closest('[data-action=\"remove-child\"]')) {\r\n            removeChild(e);\r\n        }\r\n    });\r\n\r\n    juniorClubModal.addEventListener('click', (e) => {\r\n        \r\n        // 1. Handle Header Icon Clicks (Roster and History)\r\n        if (e.target.closest('#junior-club-roster-btn')) {\r\n            showJuniorClubRosterModal();\r\n            return;\r\n        }\r\n        if (e.target.closest('#junior-club-history-btn')) {\r\n            showJuniorClubStatsModal();\r\n            return;\r\n        }\r\n        \r\n        // 2. Handle List Item Clicks (Check-In/Edit)\r\n        const checkInTarget = e.target.closest('.action-icon.add');\r\n        const editTarget = e.target.closest('.action-icon.edit');\r\n        \r\n        const listItem = e.target.closest('#junior-club-list li'); \r\n        if (!listItem) return;\r\n\r\n        // --- Logic for the 'Add' (+) button (Check In) ---\r\n        if (checkInTarget) {\r\n            const parentId = checkInTarget.dataset.parentId;\r\n            const parent = state.juniorClub.parents.find(p => p.id === parentId);\r\n            \r\n            // Proceed only if the parent is found and the button is not disabled\r\n            if (parent && checkInTarget.style.opacity !== '0.5') {\r\n                const displayMode = state.juniorClub.checkInFilter.displayMode;\r\n                \r\n                // If in 'Child Name' view, check in the specific child directly (This part was already working)\r\n                if (displayMode === 'child') {\r\n                    const childFullName = listItem.querySelector('span:first-child span:first-child').textContent.trim();\r\n                    const attendingChildren = parent.registeredChildren\r\n                        .filter(child => `${child.name} ${child.surname}`.trim() === childFullName)\r\n                        .map(child => ({\r\n                            name: `${child.name} ${child.surname}`.trim(), \r\n                            gender: child.gender,\r\n                            guest: true,\r\n                            isJunior: true, \r\n                            parentName: parent.name + ' ' + parent.surname\r\n                        }));\r\n                    \r\n                    if (attendingChildren.length > 0) {\r\n                        const newChildren = attendingChildren;\r\n                        state.juniorClub.activeChildren.push(...newChildren);\r\n\r\n                        const newHistoryEntry = {\r\n                            id: Date.now(),\r\n                            parentId: parent.id,\r\n                            parentName: `${parent.name} ${parent.surname}`,\r\n                            childNames: newChildren.map(c => c.name),\r\n                            date: new Date().toISOString().split('T')[0],\r\n                            isPaid: false, \r\n                        };\r\n                        state.juniorClub.history.push(newHistoryEntry);\r\n                        \r\n                        // playCustomTTS(`${newChildren.length} child checked in for ${parent.name}.`);\r\n                        saveState();\r\n                        renderJuniorClubCheckInList(); // Refresh the list\r\n                        return;\r\n                    }\r\n                }\r\n                \r\n                // --- THIS IS THE MISSING LOGIC FOR THE PLUS ICON IN PARENT VIEW ---\r\n                // If in 'Parent Name' view, show the child selection modal\r\n                showChildSelectionModal(parent);\r\n            }\r\n        } \r\n        // --- THIS IS THE MISSING LOGIC for the 'Edit' (✎) button ---\r\n        else if (editTarget) {\r\n            const parentId = editTarget.dataset.parentId;\r\n            const parentToEdit = state.juniorClub.parents.find(p => p.id === parentId);\r\n            if (parentToEdit) {\r\n                // This now correctly calls the function to open the edit modal\r\n                showEditParentModal(parentToEdit);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Child Selection Modal\r\n    childSelectionBackBtn.addEventListener('click', () => {\r\n        childSelectionModal.classList.add('hidden');\r\n        juniorClubModal.classList.remove('hidden');\r\n    });\r\n    childSelectionConfirmBtn.addEventListener('click', handleChildSelectionConfirm);\r\n\r\n\r\n \r\n\r\n\r\n\r\n    // Child Fields\r\n    addChildBtn.addEventListener('click', addChild);\r\n    newParentModal.addEventListener('click', (e) => {\r\n        if (e.target.closest('[data-action=\"match-surname\"]')) {\r\n            handleMatchSurname(e);\r\n        } else if (e.target.closest('[data-action=\"remove-child\"]')) {\r\n            removeChild(e);\r\n        }\r\n    });\r\n\r\n    juniorClubModal.addEventListener('click', (e) => {\r\n        \r\n        // 1. Handle Header Icon Clicks (Roster and History)\r\n        if (e.target.closest('#junior-club-roster-btn')) {\r\n            showJuniorClubRosterModal();\r\n            return;\r\n        }\r\n        if (e.target.closest('#junior-club-history-btn')) {\r\n            showJuniorClubStatsModal();\r\n            return;\r\n        }\r\n        \r\n        // 2. Handle List Item Clicks (Check-In/Edit)\r\n        const checkInTarget = e.target.closest('.action-icon.add');\r\n        const editTarget = e.target.closest('.action-icon.edit');\r\n        \r\n        const listItem = e.target.closest('#junior-club-list li'); \r\n        if (!listItem) return;\r\n\r\n        // --- Logic for the 'Add' (+) button (Check In) ---\r\n        if (checkInTarget) {\r\n            const parentId = checkInTarget.dataset.parentId;\r\n            const parent = state.juniorClub.parents.find(p => p.id === parentId);\r\n            \r\n            // Proceed only if the parent is found and the button is not disabled\r\n            if (parent && checkInTarget.style.opacity !== '0.5') {\r\n                const displayMode = state.juniorClub.checkInFilter.displayMode;\r\n                \r\n                // If in 'Child Name' view, check in the specific child directly (This part was already working)\r\n                if (displayMode === 'child') {\r\n                    const childFullName = listItem.querySelector('span:first-child span:first-child').textContent.trim();\r\n                    const attendingChildren = parent.registeredChildren\r\n                        .filter(child => `${child.name} ${child.surname}`.trim() === childFullName)\r\n                        .map(child => ({\r\n                            name: `${child.name} ${child.surname}`.trim(), \r\n                            gender: child.gender,\r\n                            guest: true,\r\n                            isJunior: true, \r\n                            parentName: parent.name + ' ' + parent.surname\r\n                        }));\r\n                    \r\n                    if (attendingChildren.length > 0) {\r\n                        const newChildren = attendingChildren;\r\n                        state.juniorClub.activeChildren.push(...newChildren);\r\n\r\n                        const newHistoryEntry = {\r\n                            id: Date.now(),\r\n                            parentId: parent.id,\r\n                            parentName: `${parent.name} ${parent.surname}`,\r\n                            childNames: newChildren.map(c => c.name),\r\n                            date: new Date().toISOString().split('T')[0],\r\n                            isPaid: false, \r\n                        };\r\n                        state.juniorClub.history.push(newHistoryEntry);\r\n                        \r\n                        playCustomTTS(`${newChildren.length} child checked in for ${parent.name}.`);\r\n                        saveState();\r\n                        renderJuniorClubCheckInList(); // Refresh the list\r\n                        return;\r\n                    }\r\n                }\r\n                \r\n                // --- THIS IS THE MISSING LOGIC FOR THE PLUS ICON IN PARENT VIEW ---\r\n                // If in 'Parent Name' view, show the child selection modal\r\n                showChildSelectionModal(parent);\r\n            }\r\n        } \r\n        // --- THIS IS THE MISSING LOGIC for the 'Edit' (✎) button ---\r\n        else if (editTarget) {\r\n            const parentId = editTarget.dataset.parentId;\r\n            const parentToEdit = state.juniorClub.parents.find(p => p.id === parentId);\r\n            if (parentToEdit) {\r\n                // This now correctly calls the function to open the edit modal\r\n                showEditParentModal(parentToEdit);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Child Selection Modal\r\n    childSelectionBackBtn.addEventListener('click', () => {\r\n        childSelectionModal.classList.add('hidden');\r\n        juniorClubModal.classList.remove('hidden');\r\n    });\r\n    childSelectionConfirmBtn.addEventListener('click', handleChildSelectionConfirm);\r\n\r\n    // Child Selection validation (updates button text/state)\r\n    attendingChildrenList.addEventListener('change', () => {\r\n        const checkedCount = attendingChildrenList.querySelectorAll('input[name=\"attendingChild\"]:checked').length;\r\n        const isReady = checkedCount > 0;\r\n        \r\n        childSelectionConfirmBtn.disabled = !isReady;\r\n        // --- START OF CHANGE ---\r\n        const childString = checkedCount === 1 ? 'child' : 'children';\r\n        childSelectionConfirmBtn.textContent = `Check In (${checkedCount} ${childString})`;\r\n        // --- END OF CHANGE ---\r\n        childSelectionConfirmBtn.style.backgroundColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n        childSelectionConfirmBtn.style.borderColor = isReady ? 'var(--confirm-color)' : 'var(--inactive-color)';\r\n    });\r\n\r\n\r\n    // Event Listeners to insert at line 2011\r\n    // Junior Club History/Stats Listeners\r\n    // Event Listeners to insert at line 2011\r\n    // Junior Club History/Stats Listeners\r\n    juniorClubHistoryBtn.addEventListener('click', showJuniorClubStatsModal);\r\n    juniorClubStatsBackBtn.addEventListener('click', () => {\r\n        juniorClubStatsModal.classList.add('hidden');\r\n        showJuniorClubModal(); // <-- MODIFIED: Ensure list is re-rendered on return\r\n    });\r\n    juniorClubHistoryList.addEventListener('click', handleJuniorClubHistoryClick);\r\n    // NOTE: document.getElementById('payment-filter-group').addEventListener('change', handlePaymentFilterChange); is now handled inside renderJuniorClubHistory\r\n    juniorClubStatsDetailsBtn.addEventListener('click', showJuniorClubDetailModal);\r\n\r\n    // Junior Club Detail Modal Listeners\r\n    detailCloseBtn.addEventListener('click', () => {\r\n        juniorClubDetailModal.classList.add('hidden');\r\n        showJuniorClubStatsModal(); // <-- MODIFIED: Ensure history is re-rendered on return\r\n    });\r\n    detailTogglePaidBtn.addEventListener('click', handleDetailTogglePaid);\r\n\r\n    cooldownCloseBtn.addEventListener('click', () => {\r\n        if (cooldownTimerInterval) {\r\n            clearInterval(cooldownTimerInterval);\r\n        }\r\n        cooldownModal.classList.add('hidden');\r\n    });\r\n\r\n\r\n    // ADDED WINDOW RESIZE LISTENER FOR AUTOMATIC EXPANSION\r\n    window.addEventListener('resize', resetCollapseOnResize);\r\n\r\n    // UPDATED: Bypasses the confirmation modal for a direct check-in flow\r\n    checkInList.addEventListener(\"click\", e => {\r\n        if (e.target.classList.contains(\"add\")) {\r\n            const playerName = e.target.dataset.player;\r\n            // --- NEW CONTEXT CHECK ---\r\n            const screensaverEventId = checkInModal.dataset.screensaverEventId;\r\n\r\n            if (screensaverEventId) {\r\n                // If opened from screensaver, add to interest list instead of checking in\r\n                addInterestedPlayer(playerName, screensaverEventId);\r\n            } else {\r\n                // --- Original Check-in Logic ---\r\n                const playerObject = state.clubMembers.find(p => p.name === playerName);\r\n                if (playerObject) {\r\n                    leaderboardConfirmModal.dataset.player = JSON.stringify(playerObject);\r\n                    leaderboardConfirmModal.classList.remove('hidden');\r\n                    checkInModal.classList.add('hidden');\r\n                }\r\n                // --- End Original Logic ---\r\n            }\r\n            // --- END NEW CONTEXT CHECK ---\r\n        }\r\n    });\r\n\r\n    checkOutBtn.addEventListener(\"click\",()=>{populateCheckOutModal(),checkOutModal.classList.remove(\"hidden\")});\r\n    checkOutCloseBtn.addEventListener(\"click\",()=>checkOutModal.classList.add(\"hidden\"));\r\n    \r\n    // MODIFIED: This now calls the new handleCheckout function\r\n    checkOutList.addEventListener(\"click\", e => {\r\n        if (e.target.classList.contains(\"remove\")) {\r\n            const playerName = e.target.dataset.player;\r\n            const playerObject = state.availablePlayers.find(p => p.name === playerName);\r\n            if (playerObject) {\r\n                // Instead of showing a modal directly, call the new handler function\r\n                handleCheckout(playerObject);\r\n            }\r\n        }\r\n    });\r\n\r\n\r\n\r\n    // Listener for the ORIGINAL modal (with stats)\r\n    document.getElementById('checkout-thanks-confirm-btn').addEventListener('click', () => {\r\n        const modal = document.getElementById('checkout-thanks-modal');\r\n        executeCheckout(modal.dataset.player);\r\n    });\r\n\r\n    // NEW: Listener for the NEW modal (no stats)\r\n    document.getElementById('checkout-thanks-no-stats-confirm-btn').addEventListener('click', () => {\r\n        const modal = document.getElementById('checkout-thanks-no-stats-modal');\r\n        executeCheckout(modal.dataset.player);\r\n    });\r\n\r\n\r\n    // NEW: Listener for the branded checkout modal confirmation\r\n\r\n    // On the Thank You (with stats) modal, go back to the Check-out list\r\n    document.getElementById('checkout-thanks-back-btn').addEventListener('click', () => {\r\n        document.getElementById('checkout-thanks-modal').classList.add('hidden');\r\n        checkOutModal.classList.remove('hidden');\r\n    });\r\n\r\n    // On the Thank You (no stats) modal, go back to the Check-out list\r\n    document.getElementById('checkout-thanks-no-stats-back-btn').addEventListener('click', () => {\r\n        document.getElementById('checkout-thanks-no-stats-modal').classList.add('hidden');\r\n        checkOutModal.classList.remove('hidden');\r\n    });\r\n    document.getElementById('checkout-thanks-confirm-btn').addEventListener('click', () => {\r\n        const modal = document.getElementById('checkout-thanks-modal');\r\n        const playerToCheckOutName = modal.dataset.player;\r\n\r\n        if (playerToCheckOutName) {\r\n            // --- This is the same core logic from executePlayerCheckOut ---\r\n            if (state.availablePlayers.length > 0 && state.availablePlayers[0].name === playerToCheckOutName) {\r\n                resetAlertSchedule();\r\n            }\r\n\r\n            const playerObject = state.availablePlayers.find(p => p.name === playerToCheckOutName);\r\n            if (playerObject) {\r\n                if (playerObject.isJunior) {\r\n                    state.juniorClub.activeChildren = state.juniorClub.activeChildren.filter(child => child.name !== playerToCheckOutName);\r\n                }\r\n                if (!playerObject.guest) {\r\n                    state.clubMembers.push(playerObject);\r\n                    state.clubMembers.sort((a, b) => a.name.localeCompare(b.name));\r\n                }\r\n            }\r\n            state.availablePlayers = state.availablePlayers.filter(p => p.name !== playerToCheckOutName);\r\n            \r\n            // Hide the thanks modal\r\n            modal.classList.add(\"hidden\");\r\n            \r\n            // Repopulate and show the original checkout modal again\r\n            populateCheckOutModal();\r\n            checkOutModal.classList.remove(\"hidden\");\r\n            \r\n            // Update the main state\r\n            updateGameModeBasedOnPlayerCount();\r\n            autoAssignCourtModes();\r\n            render();\r\n            saveState();\r\n        }\r\n    });\r\n\r\n// REPLACE this event listener\r\n    endGameCancelBtn.addEventListener(\"click\", () => {\r\n        const courtId = endGameModal.dataset.courtId;\r\n        const editGameId = endGameModal.dataset.editGameId;\r\n\r\n        if (editGameId) {\r\n            // If we were editing, close the end game modal and re-open the history page\r\n            delete endGameModal.dataset.editGameId;\r\n            endGameModal.classList.add(\"hidden\");\r\n            historyPage.classList.remove(\"hidden\"); // <-- THIS IS THE FIX\r\n            return;\r\n        }\r\n\r\n        if (courtId) {\r\n            const courtCardEl = document.querySelector(`.court-card[data-court-id=\"${courtId}\"]`);\r\n            const button = courtCardEl ? courtCardEl.querySelector('.end-game-ball') : null;\r\n            if (button) {\r\n                button.classList.remove('hide-anim', 'animate-in');\r\n                setTimeout(() => {\r\n                    button.classList.add('animate-in');\r\n                }, 50);\r\n            }\r\n        }\r\n        endGameModal.classList.add(\"hidden\");\r\n    });\r\n\r\n    endGameConfirmBtn.addEventListener(\"click\",confirmEndGame);\r\n    \r\n    // MODIFIED: No button now handles closing and restoring the correct modal\r\n    modalBtnNo.addEventListener(\"click\", () => {\r\n        const mode = cancelConfirmModal.dataset.mode;\r\n        cancelConfirmModal.classList.add(\"hidden\");\r\n\r\n        // Logic to return to the correct modal after cancellation\r\n        if (mode === \"checkInPlayer\") {\r\n            checkInModal.classList.remove(\"hidden\");\r\n        } else if (mode === \"checkOutPlayer\") {\r\n            checkOutModal.classList.remove(\"hidden\");\r\n        } else if (mode === \"addBallStock\" || mode === \"returnBallStock\" || mode === \"signOutBalls\") {\r\n            ballManagementModal.classList.remove(\"hidden\");\r\n        } \r\n        // --- START OF FIX ---\r\n        else if (mode === \"removeSingleChild\") {\r\n            newParentModal.classList.remove(\"hidden\"); // This correctly returns to the registration form.\r\n        }\r\n        // --- END OF FIX ---\r\n\r\n        resetConfirmModal();\r\n    });\r\n    \r\n    // MODIFIED: Yes button now handles check-in/out and the force announcement\r\n    // MODIFIED: Yes button now handles check-in/out and the force announcement\r\n    modalBtnYesConfirm.addEventListener(\"click\", () => {\r\n        const mode = cancelConfirmModal.dataset.mode;\r\n\r\n        if (mode === \"removeSingleChild\") {\r\n            executeRemoveSingleChild();\r\n        } else if (mode === \"confirmEditGame\") {\r\n            const gameId = cancelConfirmModal.dataset.gameId;\r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            resetConfirmModal();\r\n            handleEndGame(null, gameId); \r\n        } else if (mode === \"checkOutPlayer\") {\r\n            executePlayerCheckOut();\r\n        } else if (mode === \"checkInPlayer\") {\r\n            executePlayerCheckIn();\r\n        } else if (mode === \"cancelGame\") {\r\n            executeGameCancellation();\r\n        } else if (mode === \"callDuty\") {\r\n            executeCallDuty();\r\n        } else if (mode === \"executeReset\") {\r\n            executeAppReset();\r\n        } else if (mode === \"pauseToggle\") {\r\n            executePauseToggle();\r\n        } else if (mode === \"addBallStock\") {\r\n            executeAddBallStock();\r\n        } else if (mode === \"returnBallStock\") {\r\n            executeReturnBallStock();\r\n        } else if (mode === \"returnUsedBalls\") {\r\n            executeUsedBallReturn();\r\n        } else if (mode === \"signOutBalls\") {\r\n            executeSignOutBalls();\r\n        } else if (mode === \"forceAnnouncement\") {\r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            checkAndPlayAlert(true);\r\n            resetConfirmModal();\r\n        } else if (mode === \"forceAnnouncementNotEnoughPlayers\") {\r\n            const now = Date.now();\r\n            const FIVE_MINUTES_MS = 5 * 60 * 1000;\r\n\r\n            if (state.notificationControls.isMinimized) {\r\n                alertScheduleTime = 0;\r\n                alertState = 'initial_check';\r\n            } else {\r\n                alertScheduleTime = now + FIVE_MINUTES_MS;\r\n                alertState = '5_min_repeat';\r\n            }\r\n\r\n            const availablePlayerCount = state.availablePlayers.length;\r\n            const playerNames = state.availablePlayers.map(p => p.name).join(' and ');\r\n            const playersNeeded = 4 - availablePlayerCount;\r\n            const pluralS = playersNeeded > 1 ? 's' : '';\r\n            let message = `Attention ${playerNames}, we are waiting for ${playersNeeded} more player${pluralS} before we can start a match.`;\r\n            if (availablePlayerCount >= 2) {\r\n                message += \" or start a singles game in the meantime.\";\r\n            }\r\n            playAlertSound(message);\r\n\r\n            cancelConfirmModal.classList.add(\"hidden\");\r\n            resetConfirmModal();\r\n        }\r\n    });\r\n\r\n    // Undo Toast Listeners\r\n    document.getElementById('undo-toast-dismiss').addEventListener('click', hideUndoToast);\r\n    document.getElementById('undo-toast-btn').addEventListener('click', () => {\r\n        if (state.undoHistory.currentToast && state.undoHistory.currentToast.undoAction) {\r\n            state.undoHistory.currentToast.undoAction();\r\n            hideUndoToast();\r\n        }\r\n    }); \r\n    \r\n    // Add generic listeners that trigger validation whenever an input's value changes.\r\n    const scoreInputs = [winningScoreInput, losingScoreInput, winnerTiebreakInput, loserTiebreakInput];\r\n    scoreInputs.forEach(input => {\r\n        input.addEventListener(\"input\", () => {\r\n            checkAndShowTieBreak();\r\n            validateEndGameForm();\r\n        });\r\n    });\r\n\r\n    // Wire up the keypad for the tie-break inputs, which have no special max value rules.\r\n    // The main score inputs are now wired up dynamically inside handleEndGame().\r\n    wireScoreInputToKeypad(winnerTiebreakInput);\r\n    wireScoreInputToKeypad(loserTiebreakInput);\r\n\r\n\r\n// REPLACE this event listener\r\n    courtModeKeypadButtons.forEach(button => {\r\n        button.addEventListener('click', (e) => {\r\n            const key = e.target.dataset.key;\r\n            let displayValue = courtModeKeypadDisplay.dataset.hiddenValue || '';\r\n\r\n            if (e.target.id === 'court-mode-keypad-confirm-btn') {\r\n                if (e.target.disabled) return;\r\n                checkCourtModePasscode();\r\n                return;\r\n            }\r\n\r\n            if (key === 'backspace') {\r\n                displayValue = displayValue.slice(0, -1);\r\n            } else if (key === 'clear') {\r\n                displayValue = '';\r\n            } else if (/[0-9]/.test(key)) {\r\n                if (displayValue.length >= 6) return; // Max length for PIN\r\n                displayValue += key;\r\n            }\r\n\r\n            courtModeKeypadDisplay.dataset.hiddenValue = displayValue;\r\n            courtModeKeypadDisplay.textContent = '*'.repeat(displayValue.length);\r\n\r\n            // --- THIS IS THE FIX ---\r\n            // The button is only enabled when exactly 6 digits are entered.\r\n            const isReady = displayValue.length === 6;\r\n            courtModeKeypadConfirmBtn.disabled = !isReady;\r\n            // --- END OF FIX ---\r\n        });\r\n    });\r\n\r\n    courtModeKeypadCancelBtn.addEventListener('click', hideCourtModeKeypad);\r\n\r\n    keypadButtons.forEach(button => { button.addEventListener('click', handleKeypadClick); });\r\n    keypadCancelBtn.addEventListener('click', () => {\r\n        // Check if we're canceling from undo mode\r\n        if (keypadConfig.mode === 'undo') {\r\n            hideKeypad();\r\n            delete customKeypadModal.dataset.undoActionIndex;\r\n            delete customKeypadModal.dataset.undoActionDescription;\r\n            // Return to undo history modal\r\n            document.getElementById('undo-history-modal').classList.remove('hidden');\r\n        } else {\r\n            hideKeypad();\r\n        }\r\n    });\r\n    document.getElementById('add-new-player-btn').addEventListener(\"click\",()=>{ \r\n        checkInModal.classList.add('hidden'); \r\n        guestNameModal.classList.remove('hidden'); \r\n        guestNameInput.value = ''; \r\n        guestSurnameInput.value = ''; \r\n        document.querySelector('input[name=\"guest-gender\"][value=\"M\"]').checked = true;\r\n        validateGuestForm(); \r\n    });\r\n\r\n    document.getElementById('returning-guest-btn').addEventListener(\"click\", () => {\r\n        checkInModal.classList.add('hidden');\r\n        populateReturningGuestModal();\r\n        document.getElementById('returning-guest-modal').classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('returning-guest-cancel-btn').addEventListener(\"click\", () => {\r\n        document.getElementById('returning-guest-modal').classList.add('hidden');\r\n        checkInModal.classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('returning-guest-list').addEventListener(\"click\", e => {\r\n        if (e.target.classList.contains(\"add\")) {\r\n            const playerName = e.target.dataset.player;\r\n            handleReturningGuestCheckIn(playerName);\r\n        }\r\n    });\r\n    guestCancelBtn.addEventListener(\"click\", () => {\r\n        const context = guestNameModal.dataset.context; // Get context\r\n        guestNameModal.classList.add('hidden');\r\n        delete guestNameModal.dataset.context; // Clear context after use\r\n\r\n        // --- NEW CONDITIONAL LOGIC ---\r\n        if (context === 'manual-entry') {\r\n            manualEntryModal.classList.remove('hidden'); // Return to manual entry\r\n        } else {\r\n            checkInModal.classList.remove('hidden'); // Default return to check-in\r\n        }\r\n        // --- END NEW LOGIC ---\r\n\r\n        // Also ensure the member radio button is re-enabled on cancel\r\n        const memberRadio = document.querySelector('input[name=\"player-type\"][value=\"member\"]');\r\n        if (memberRadio) memberRadio.disabled = false;\r\n        resetGuestForm(); // Reset form fields\r\n    });\r\n    guestConfirmBtn.addEventListener(\"click\", handleGuestCheckIn);\r\n    guestGenderRadios.forEach(radio => radio.addEventListener('change', validateGuestForm));\r\n    const wireNameInputToKeypad = (input) => { input.readOnly = true; input.addEventListener('click', (e) => { showAlphaKeypad(e.target); }); };\r\n    wireNameInputToKeypad(guestNameInput);\r\n    wireNameInputToKeypad(guestSurnameInput);\r\n\r\n    adminCloseBtn.addEventListener('click', () => {\r\n        adminSettingsModal.classList.add('hidden');\r\n\r\n        if (adminSessionActive) {\r\n            if (adminSessionTimer) clearTimeout(adminSessionTimer);\r\n            adminSessionTimer = setTimeout(() => {\r\n                adminSessionActive = false;\r\n                adminSessionTimer = null;\r\n                state.courts.forEach(c => c.isModeOverlayActive = false);\r\n                render();\r\n                playAlertSound(null, null, 'Alert7.mp3');\r\n                requestAnimationFrame(ensureCourtSelectionAnimation); // <-- THIS IS THE FIX\r\n            }, 60000); // 1 minute\r\n        }\r\n    });\r\n\r\n    reorderPlayersBtn.addEventListener('click', showReorderModal);\r\n    reorderPlayersList.addEventListener('click', handleReorderClick);\r\n\r\n    reorderCancelBtn.addEventListener('click', () => {\r\n        reorderPlayersModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n        tempPlayerOrder = [];\r\n    });\r\n\r\n    reorderSaveBtn.addEventListener('click', () => {\r\n        state.availablePlayers = tempPlayerOrder;\r\n\r\n        // --- THIS IS THE FIX ---\r\n        enforceQueueLogic(); // Re-apply all queue rules after the admin reorder\r\n\r\n        if (tempPlayerOrder.sessionLog && Object.keys(tempPlayerOrder.sessionLog).length > 0) {\r\n            const movedPlayers = Object.fromEntries(\r\n                Object.entries(tempPlayerOrder.sessionLog).filter(([name, log]) => log.startPosition !== log.currentPosition)\r\n            );\r\n\r\n            if (Object.keys(movedPlayers).length > 0) {\r\n                const historyEntry = {\r\n                    id: Date.now(),\r\n                    adminAction: 'Queue Reorder',\r\n                    players: movedPlayers,\r\n                    endTime: Date.now()\r\n                };\r\n                state.reorderHistory.push(historyEntry);\r\n            }\r\n        }\r\n        \r\n        // --- ANNOUNCEMENT: Admin action confirmation ---\r\n        playAlertSound(\"Players have been re-ordered by the Admin.\", null); \r\n        // --- END ANNOUNCEMENT ---\r\n\r\n        enforceDutyPosition();\r\n\r\n        reorderPlayersModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n        tempPlayerOrder = [];\r\n        render();\r\n        saveState();\r\n    });\r\n\r\n    viewReorderLogBtn.addEventListener('click', () => {\r\n        renderReorderHistory();\r\n        adminSettingsModal.classList.add('hidden');\r\n        reorderLogModal.classList.remove('hidden');\r\n    });\r\n\r\n    reorderLogBackBtn.addEventListener('click', () => {\r\n        reorderLogModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    });\r\n\r\n\r\n    // Helper function to call both validation and rendering\r\n    function validateParentAndRender() {\r\n        validateNewParentForm(); // First, update the state based on input\r\n        renderParentForm();      // Then, update the UI based on the new state\r\n    }\r\n\r\n    // Attach the helper function to the 'input' event for each field\r\n    if (parentNameInput) {\r\n        parentNameInput.removeEventListener('input', validateParentAndRender); // Prevent duplicates\r\n        parentNameInput.addEventListener('input', validateParentAndRender);\r\n    }\r\n    if (parentSurnameInput) {\r\n        parentSurnameInput.removeEventListener('input', validateParentAndRender);\r\n        parentSurnameInput.addEventListener('input', validateParentAndRender);\r\n    }\r\n     if (parentEmailInput) {\r\n         parentEmailInput.removeEventListener('input', validateParentAndRender);\r\n         parentEmailInput.addEventListener('input', validateParentAndRender);\r\n      }\r\n    if (parentPhoneInput) {\r\n        parentPhoneInput.removeEventListener('input', validateParentAndRender);\r\n        parentPhoneInput.addEventListener('input', validateParentAndRender);\r\n    }\r\n\r\n    // --- ROSTER MODAL LISTENERS (RE-VERIFIED AND ENSURED) ---\r\n    if (juniorClubRosterBtn) {\r\n        juniorClubRosterBtn.addEventListener('click', showJuniorClubRosterModal);\r\n    }\r\n    if (rosterCloseBtn) {\r\n        rosterCloseBtn.addEventListener('click', () => {\r\n            juniorClubRosterModal.classList.add('hidden');\r\n            juniorClubModal.classList.remove('hidden'); // Return to main junior club list\r\n        });\r\n    }\r\n    if (rosterTypeFilterGroup) {\r\n        rosterTypeFilterGroup.addEventListener('change', handleRosterTypeFilterChange);\r\n    }\r\n\r\n\r\n\r\n    // --- WEATHER MODAL LISTENERS ---\r\n    document.getElementById('weather-display').addEventListener('click', () => {\r\n        if (currentWeatherModal) currentWeatherModal.classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('cw-close-btn').addEventListener('click', () => {\r\n        if (currentWeatherModal) currentWeatherModal.classList.add('hidden');\r\n    });\r\n\r\n    document.getElementById('cw-more-details-btn').addEventListener('click', () => {\r\n        if (currentWeatherModal) currentWeatherModal.classList.add('hidden');\r\n        if (detailedWeatherModal) detailedWeatherModal.classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('dw-close-btn').addEventListener('click', () => {\r\n        if (detailedWeatherModal) detailedWeatherModal.classList.add('hidden');\r\n    });\r\n\r\n    // Event Delegation for the Day/Morning/Afternoon tabs\r\n    if (detailedWeatherModal) {\r\n        detailedWeatherModal.addEventListener('click', (e) => {\r\n            const tab = e.target.closest('.tab');\r\n            if (tab) {\r\n                state.detailedWeatherView = tab.dataset.view;\r\n                renderDetailedWeatherModal();\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n// EVENT LISTENER FOR GAME HISTORY\r\n    historyList.addEventListener('click', (e) => {\r\n         // --- ADD THIS BLOCK ---\r\n        if (e.target.closest('.sort-btn')) {\r\n            return; // Do nothing if a sort button was clicked\r\n        }\r\n        // --- END BLOCK ---\r\n        const historyItem = e.target.closest('.history-item');\r\n        if (!historyItem || !historyItem.dataset.gameId) return;\r\n\r\n        const gameId = historyItem.dataset.gameId;\r\n\r\n        // Show a confirmation modal before starting the edit\r\n        cancelConfirmModal.querySelector(\"h3\").textContent = \"Edit Game Results\";\r\n        cancelConfirmModal.querySelector(\"p\").textContent = \"Are you sure you want to edit the results for this game?\";\r\n        modalBtnYesConfirm.textContent = \"Yes, Edit\";\r\n        modalBtnNo.textContent = \"Cancel\";\r\n        cancelConfirmModal.dataset.mode = \"confirmEditGame\";\r\n        cancelConfirmModal.dataset.gameId = gameId;\r\n        cancelConfirmModal.classList.remove(\"hidden\");\r\n    });\r\n\r\n    // EVENT LISTENERS FOR LEADERBOARD AND DISCLAIMER MODALS\r\n\r\n    // On the Rules/Leaderboard modal, go back to the Check-in list\r\n    document.getElementById('leaderboard-back-btn').addEventListener('click', () => {\r\n        leaderboardConfirmModal.classList.add('hidden');\r\n        checkInModal.classList.remove('hidden');\r\n    });\r\n    document.getElementById('leaderboard-btn-yes').addEventListener('click', () => {\r\n        const player = JSON.parse(leaderboardConfirmModal.dataset.player);\r\n        player.onLeaderboard = true;\r\n        finishCheckIn(player);\r\n    });\r\n\r\n    document.getElementById('leaderboard-btn-no').addEventListener('click', () => {\r\n        const player = JSON.parse(leaderboardConfirmModal.dataset.player);\r\n        player.onLeaderboard = false;\r\n        finishCheckIn(player);\r\n    });\r\n\r\n    document.getElementById('disclaimer-btn').addEventListener('click', () => {\r\n        disclaimerModal.classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('disclaimer-close-btn').addEventListener('click', () => {\r\n        disclaimerModal.classList.add('hidden');\r\n    });\r\n\r\n    // Event listener for the new Auto-Minimize toggle\r\n    document.getElementById('auto-minimize-toggle').addEventListener('change', (e) => {\r\n        state.notificationControls.autoMinimize = e.target.checked;\r\n        if (state.notificationControls.autoMinimize) {\r\n            runAutoMinimizeLogic(); // Immediately run the logic when turned on\r\n        }\r\n        saveState();\r\n    });\r\n\r\n    // We also need to call the auto-minimize logic whenever players or courts change state\r\n    // For example, at the end of these functions:\r\n    // (You will need to find these functions and add the call)\r\n\r\n    // In executeGameCancellation() -> right before saveState()\r\n    runAutoMinimizeLogic();\r\n\r\n    // In executePlayerCheckIn() -> right before saveState()\r\n    runAutoMinimizeLogic();\r\n\r\n    // In executePlayerCheckOut() -> right before saveState()\r\n    runAutoMinimizeLogic();\r\n\r\n    // In finishCheckIn() -> right before saveState()\r\n    runAutoMinimizeLogic();\r\n    \r\n    // In resetCourtAfterGame() -> right before saveState()\r\n    runAutoMinimizeLogic();\r\n\r\n\r\n\r\n    // EVENT LISTENERS FOR SOUND SELECTION\r\n    selectSoundBtn.addEventListener('click', handleSoundSelectionModal);\r\n    soundSelectionList.addEventListener('change', handleSoundSelection);\r\n    soundSelectionList.addEventListener('click', handleSoundPreview);\r\n    soundConfirmBtn.addEventListener('click', confirmSoundSelection);\r\n    soundCancelBtn.addEventListener('click', cancelSoundSelection);\r\n\r\n    // EVENT LISTENERS FOR STYLE EDITOR\r\n    editStylesBtn.addEventListener('click', showEditStylesModal);\r\n    editStylesCloseBtn.addEventListener('click', () => {\r\n        editStylesModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');\r\n    });\r\n\r\n    // EVENT LISTENER FOR NEW FONT SIZE BUTTONS\r\n    document.getElementById('font-size-selector').addEventListener('click', (e) => {\r\n        if (e.target.tagName === 'BUTTON') {\r\n            const newSize = parseFloat(e.target.dataset.size);\r\n            handleFontSizeChange(newSize);\r\n        }\r\n    });\r\n\r\n    // EVENT LISTENER FOR NEW DISPLAY SIZE BUTTONS\r\n    document.getElementById('display-size-selector').addEventListener('click', (e) => {\r\n        if (e.target.tagName === 'BUTTON') {\r\n            const newSize = parseFloat(e.target.dataset.size);\r\n            handleDisplaySizeChange(newSize);\r\n        }\r\n    });\r\n    \r\n    // EVENT LISTENERS FOR NOTIFICATION CONTROLS\r\n    muteBtn.addEventListener('click', () => {\r\n        state.notificationControls.isMuted = !state.notificationControls.isMuted;\r\n        if (state.notificationControls.isMuted) {\r\n             state.notificationControls.isTTSDisabled = true; // Mute implies TTS disabled\r\n        }\r\n        saveState();\r\n        updateNotificationIcons();\r\n        checkAndPlayAlert(false);\r\n    });\r\n\r\n    minimizeNotificationsBtn.addEventListener('click', () => {\r\n        state.notificationControls.isMinimized = !state.notificationControls.isMinimized;\r\n        // If minimizing, reset the alert timer to initial check state\r\n        if (state.notificationControls.isMinimized) {\r\n            resetAlertSchedule();\r\n        }\r\n        saveState();\r\n        updateNotificationIcons();\r\n        checkAndPlayAlert(false);\r\n    });\r\n\r\n    noSpeechBtn.addEventListener('click', () => {\r\n        state.notificationControls.isTTSDisabled = !state.notificationControls.isTTSDisabled;\r\n        // If TTS is disabled, we cannot be globally muted (unless actively pressed Mute)\r\n        if (!state.notificationControls.isTTSDisabled && state.notificationControls.isMuted) {\r\n             state.notificationControls.isMuted = false;\r\n        }\r\n        saveState();\r\n        updateNotificationIcons();\r\n    });\r\n\r\n    // EVENT LISTENERS FOR BALL MANAGEMENT (FIXED: Event Delegation)\r\n    ballManagementBtn.addEventListener('click', showBallManagementModal);\r\n    ballManagementCloseBtn.addEventListener('click', () => {\r\n        ballManagementModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden');   \r\n    });\r\n    addStockBtn.addEventListener('click', handleAddStock);\r\n    returnStockBtn.addEventListener('click', handleReturnStock);\r\n    returnUsedBallsBtn.addEventListener('click', handleReturnUsedBalls); // <-- ADD THIS LINE\r\n    ballHistoryBtn.addEventListener('click', showBallHistoryModal);\r\n    ballHistoryCloseBtn.addEventListener('click', () => {\r\n        ballHistoryModal.classList.add('hidden');\r\n        ballManagementModal.classList.remove('hidden');\r\n    });\r\n\r\n    ballDetailCloseBtn.addEventListener('click', () => {\r\n        ballHistoryDetailModal.classList.add('hidden');\r\n        ballHistoryModal.classList.remove('hidden'); // Go back to the list\r\n    });\r\n\r\n    // Use event delegation for the sign out buttons\r\n    signOutOptions.addEventListener('click', handleSignOut);\r\n    \r\n    // FIX: Individual listener binding to guarantee button functionality\r\n    //document.querySelectorAll('.sign-out-btn').forEach(button => {\r\n        // Ensure we don't double-bind if the script is reloaded\r\n    //    button.removeEventListener('click', handleSignOut);\r\n    //    button.addEventListener('click', handleSignOut);\r\n    //});\r\n\r\n\r\n    // --- NEW EVENT LISTENERS FOR BALL SALES FLOW ---\r\n    \r\n    // 0. Listener to handle Sale Type selection on Ball Management Modal\r\n    ballManagementModal.addEventListener('click', (e) => {\r\n        if (e.target.closest('.sign-out-btn') && e.target.closest('.sign-out-btn').dataset.category === 'Sale') {\r\n            // Redirect to handleSignOut, which has been modified to start the sale flow\r\n            handleSignOut(e); \r\n        }\r\n    });\r\n    \r\n    // 1. Sale Stock Type Modal\r\n    saleTypeCansBtn.addEventListener('click', () => handleSaleStockTypeSelection('cans'));\r\n    saleTypeSinglesBtn.addEventListener('click', () => handleSaleStockTypeSelection('singles'));\r\n    saleTypeCancelBtn.addEventListener('click', () => {\r\n        ballSaleTypeModal.classList.add('hidden');\r\n        ballManagementModal.classList.remove('hidden');\r\n    });\r\n\r\n    // 2. Purchaser Selection Modal\r\n    purchaserMemberList.addEventListener('click', (e) => { \r\n        const li = e.target.closest('li');\r\n        if (li && li.querySelector('input[name=\"purchaserMember\"]')) {\r\n            const radio = li.querySelector('input[name=\"purchaserMember\"]');\r\n            radio.checked = true; // Select the radio button\r\n            const purchaserName = radio.value;\r\n            const purchaserType = li.querySelector('.member-designation').textContent.toLowerCase().includes('guest') ? 'guest' : 'member';\r\n            purchaserSelectionModal.classList.add('hidden'); // Close the list modal\r\n            confirmPurchaser(purchaserName, purchaserType);\r\n        }\r\n    });\r\n\r\n    document.getElementById('purchaser-new-guest-btn').addEventListener('click', () => {\r\n        // Use the existing guest name modal logic, but with a new 'purchaser' context\r\n        guestNameModal.dataset.context = 'purchaser'; \r\n        purchaserSelectionModal.classList.add('hidden');\r\n        // The guest name modal's confirm button will now call confirmPurchaser upon completion\r\n        guestNameModal.classList.remove('hidden');\r\n        // Ensure guest form is reset for new guest entry\r\n        guestNameInput.value = '';\r\n        guestSurnameInput.value = '';\r\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\r\n        document.querySelector('input[name=\"player-type\"][value=\"member\"]').disabled = true; // Disable member option here\r\n        validateGuestForm();\r\n    });\r\n    \r\n    document.getElementById('purchaser-returning-guest-btn').addEventListener('click', () => {\r\n        document.getElementById('returning-guest-modal').dataset.context = 'purchaser';\r\n        purchaserSelectionModal.classList.add('hidden');\r\n        populateReturningGuestModal();\r\n        document.getElementById('returning-guest-modal').classList.remove('hidden');\r\n    });\r\n    \r\n    document.getElementById('purchaser-cancel-btn').addEventListener('click', () => {\r\n        purchaserSelectionModal.classList.add('hidden');\r\n        // Clear temporary state and go back to committee member selection modal\r\n        state.ballManagement.tempSale = { stockType: null, memberSignOut: null, purchaserName: null };\r\n        // The only way to get here is from a sale, so re-open the committee member list\r\n        handleSignOut({ target: document.querySelector('.sign-out-btn[data-category=\"Sale\"]') });\r\n    });\r\n\r\n    // --- RE-ADD LISTENER FOR RETURNING GUEST BACK BUTTON IN PURCHASER CONTEXT ---\r\n    document.getElementById('returning-guest-cancel-btn').addEventListener(\"click\", (e) => {\r\n        const returningGuestModal = document.getElementById('returning-guest-modal');\r\n        if (returningGuestModal.dataset.context === 'purchaser') {\r\n            e.preventDefault(); // Stop default action\r\n            returningGuestModal.classList.add('hidden');\r\n            // Show the purchaser modal again (which auto-populates the list)\r\n            purchaserSelectionModal.classList.remove('hidden');\r\n            delete returningGuestModal.dataset.context; \r\n        }\r\n    });\r\n\r\n\r\n\r\n    // NEW EVENT LISTENERS FOR SIGN-OUT MEMBER MODAL\r\n    signOutMemberConfirmBtn.addEventListener('click', handleMemberSelectionConfirm);\r\n    signOutMemberCancelBtn.addEventListener('click', () => {\r\n        signOutMemberModal.classList.add('hidden');\r\n        ballManagementModal.classList.remove('hidden');\r\n    });\r\n\r\n    // EVENT LISTENERS FOR MANUAL GAME ENTRY (Consolidated and Corrected)\r\n    document.getElementById('manual-entry-btn').addEventListener('click', openManualPlayerSelectionModal);\r\n\r\n    manualPlayerList.addEventListener('click', handleManualPlayerClick);\r\n\r\n    manualEntryCancelBtn.addEventListener('click', () => {\r\n        manualEntryModal.classList.add('hidden');\r\n        historyPage.classList.remove('hidden'); // Return to history\r\n    });\r\n\r\n    manualEntryConfirmBtn.addEventListener('click', handleConfirmManualPlayers);\r\n\r\n    addOutsidePlayerBtn.addEventListener('click', showOutsidePlayerModal);\r\n\r\n    outsidePlayerList.addEventListener('click', handleOutsidePlayerClick);\r\n\r\n    outsidePlayerConfirmBtn.addEventListener('click', handleConfirmManualPlayers);\r\n\r\n    outsidePlayerBackBtn.addEventListener('click', () => {\r\n        outsidePlayerModal.classList.add('hidden');\r\n        showManualPlayerSelectionModal(); // Go back and re-render the main selection modal\r\n    });\r\n\r\n    document.getElementById('manual-add-guest-btn').addEventListener('click', () => {\r\n        // Use the existing guest name modal logic, but set context\r\n        guestNameModal.dataset.context = 'manual-entry';\r\n        manualEntryModal.classList.add('hidden'); // Hide manual entry temporarily\r\n        // Ensure guest form is reset for new guest entry\r\n        guestNameInput.value = '';\r\n        guestSurnameInput.value = '';\r\n        document.querySelector('input[name=\"player-type\"][value=\"guest\"]').checked = true;\r\n        // Disable selecting 'member' when adding guest from manual entry\r\n        document.querySelector('input[name=\"player-type\"][value=\"member\"]').disabled = true;\r\n        validateGuestForm();\r\n        guestNameModal.classList.remove('hidden');\r\n    }); \r\n\r\n    // Listener for removing a player from the \"Selected\" area in the main modal\r\n    manualSelectedPlayersContainer.addEventListener('click', (e) => {\r\n        const chip = e.target.closest('.selected-player-chip');\r\n        if (chip) {\r\n            handleRemoveManualPlayer(chip.dataset.playerName);\r\n        }\r\n    });\r\n\r\n    // Listener for removing a player from the \"Selected\" area in the outside player modal\r\n    outsideSelectedPlayersContainer.addEventListener('click', (e) => {\r\n        const chip = e.target.closest('.selected-player-chip');\r\n        if (chip) {\r\n            handleRemoveManualPlayer(chip.dataset.playerName);\r\n        }\r\n    });\r\n\r\n    // EVENT LISTENERS FOR ADMIN COURT MANAGEMENT\r\n\r\n    managePlayersCloseBtn.addEventListener('click', handleManageClose);\r\n    managePlayersBackBtn.addEventListener('click', handleManageBack);\r\n    managePlayersConfirmBtn.addEventListener('click', handleManageConfirm);\r\n    \r\n    managePlayersAddBtn.addEventListener('click', () => {\r\n        const { removedPlayers, addedPlayers, courtId } = state.adminCourtManagement;\r\n        const hasChanges = removedPlayers.length > 0 || addedPlayers.length > 0;\r\n        if (hasChanges) {\r\n            showAddPlayerCard(courtId);\r\n        }\r\n    });\r\n\r\n    manageCourtPlayersModal.addEventListener('click', (e) => {\r\n        const target = e.target.closest('.action-icon');\r\n        if (!target) return;\r\n\r\n        const courtId = target.dataset.courtId;\r\n        const action = target.dataset.action;\r\n        const playerName = target.dataset.player;\r\n        const { adminCourtManagement } = state;\r\n\r\n        if (action === 'select-court') {\r\n            showRemovePlayerCard(courtId);\r\n        } else if (action === 'remove-player-temp') {\r\n            const playerObject = adminCourtManagement.currentCourtPlayers.find(p => p.name === playerName);\r\n            if (playerObject && !adminCourtManagement.removedPlayers.some(p => p.name === playerName)) {\r\n                adminCourtManagement.removedPlayers.push(playerObject);\r\n                showRemovePlayerCard(adminCourtManagement.courtId);\r\n            }\r\n        } else if (action === 'return-player-temp') {\r\n            adminCourtManagement.removedPlayers = adminCourtManagement.removedPlayers.filter(p => p.name !== playerName);\r\n            showRemovePlayerCard(adminCourtManagement.courtId);\r\n        } else if (action === 'add-player-temp') {\r\n            // Corrected: Just add to the temp list. Do NOT modify state.availablePlayers here.\r\n            const playerObject = state.availablePlayers.find(p => p.name === playerName);\r\n            if (playerObject && !adminCourtManagement.addedPlayers.some(p => p.name === playerName)) {\r\n                adminCourtManagement.addedPlayers.push(playerObject);\r\n                renderAddPlayersList(adminCourtManagement.courtId);\r\n            }\r\n        } else if (action === 'undo-add-player-temp') {\r\n            // Corrected: Just remove from the temp list.\r\n            adminCourtManagement.addedPlayers = adminCourtManagement.addedPlayers.filter(p => p.name !== playerName);\r\n            renderAddPlayersList(adminCourtManagement.courtId);\r\n        }\r\n        updateGameModeBasedOnPlayerCount();\r\n        saveState();\r\n    });\r\n\r\n    // --- START OF NEW KEYBOARD BINDING LOGIC ---\r\n    document.addEventListener('keydown', (e) => {\r\n        // Determine which modal is active\r\n        const isNumericKeypadActive = !customKeypadModal.classList.contains('hidden');\r\n        const isAlphaKeypadActive = !customAlphaKeypadModal.classList.contains('hidden');\r\n        const isGlobalKeyboardActive = !globalKeyboardModal.classList.contains('hidden'); // <-- NEW CHECK\r\n\r\n        // First, check if the numeric keypad is active\r\n        if (isNumericKeypadActive) {\r\n            e.preventDefault();\r\n            // ... (numeric keypad logic remains the same) ...\r\n            let targetButton;\r\n            const key = e.key;\r\n\r\n            if (key >= '0' && key <= '9') {\r\n                targetButton = customKeypadModal.querySelector(`.keypad-btn[data-key=\"${key}\"]`);\r\n            } else if (key === 'Backspace') {\r\n                targetButton = customKeypadModal.querySelector('.keypad-btn[data-key=\"backspace\"]');\r\n            } else if (key === 'Enter') {\r\n                targetButton = document.getElementById('keypad-confirm-btn');\r\n            } else if (key.toLowerCase() === 'c') { // Allow 'c' for clear\r\n                targetButton = customKeypadModal.querySelector('.keypad-btn[data-key=\"clear\"]');\r\n            }\r\n\r\n            if (targetButton && !targetButton.disabled) {\r\n                targetButton.click();\r\n            }\r\n\r\n        }\r\n        // Otherwise, check if the alphabetic keypad is active\r\n        else if (isAlphaKeypadActive) {\r\n            e.preventDefault();\r\n            // ... (alpha keypad logic remains the same) ...\r\n             let targetButton;\r\n            const key = e.key;\r\n\r\n            if (key.length === 1 && key.match(/[a-zA-Z]/i)) {\r\n                // Find letter buttons (case-insensitive)\r\n                targetButton = customAlphaKeypadModal.querySelector(`.keypad-btn[data-key=\"${key.toUpperCase()}\"]`);\r\n            } else if (key === ' ') {\r\n                targetButton = customAlphaKeypadModal.querySelector('.keypad-btn[data-key=\"space\"]');\r\n            } else if (key === 'Backspace') {\r\n                targetButton = customAlphaKeypadModal.querySelector('.keypad-btn[data-key=\"backspace\"]');\r\n            } else if (key === 'Enter') {\r\n                targetButton = document.getElementById('alpha-keypad-confirm-btn');\r\n            }\r\n\r\n            if (targetButton && !targetButton.disabled) {\r\n                targetButton.click();\r\n            }\r\n        }\r\n\r\n    // --- REVISED BLOCK for Global Keyboard (Direct Input - Refined Shift) ---\r\n        else if (isGlobalKeyboardActive) {\r\n            e.preventDefault(); // Prevent default typing behavior\r\n\r\n            const key = e.key;\r\n            const code = e.code; // Use e.code for more reliable layout-independent key identification\r\n            const isShiftPressed = e.shiftKey;\r\n            let characterToInsert = null;\r\n            let actionToPerform = null;\r\n\r\n            // --- 1. Determine Character or Action ---\r\n\r\n            // Handle letters first (respecting physical shift)\r\n            if (code.startsWith('Key') && key.length === 1 && key.match(/[a-zA-Z]/i)) {\r\n                 characterToInsert = isShiftPressed ? key.toUpperCase() : key.toLowerCase();\r\n            }\r\n            // Handle specific action keys by code\r\n            else if (code === 'Backspace') { actionToPerform = 'BACK'; }\r\n            else if (code === 'Enter')     { actionToPerform = 'ENTER'; }\r\n            else if (code === 'Space')     { actionToPerform = 'SPACE'; }\r\n            else if (code === 'ShiftLeft' || code === 'ShiftRight') { actionToPerform = 'SHIFT'; }\r\n            // Handle Tab, Escape, etc. by code if needed\r\n\r\n            // Handle numbers and symbols (PRIORITIZE direct key value if it's a symbol)\r\n            else if (key.length === 1 && !key.match(/[a-zA-Z]/i)) { // Check if e.key itself is a non-letter single character\r\n                 // Check if it's a standard symbol first\r\n                 const standardSymbols = \"!@#$%^&*()_+{}|:\\\"<>?~`-=[]\\\\;',./\";\r\n                 if (standardSymbols.includes(key)) {\r\n                     characterToInsert = key; // Use the symbol directly reported by e.key\r\n                 }\r\n                 // If it wasn't a direct symbol, check if it's a non-shifted number\r\n                 else if (key >= '0' && key <= '9' && !isShiftPressed) {\r\n                     characterToInsert = key;\r\n                 }\r\n                 // Add specific fallbacks if e.key *doesn't* report the symbol directly with Shift\r\n                 // (This part might be less necessary now but kept as a backup)\r\n                 else if (isShiftPressed) {\r\n                     switch (code) { // Use e.code for shift+number mapping\r\n                         case 'Digit1': characterToInsert = '!'; break;\r\n                         case 'Digit2': characterToInsert = '@'; break;\r\n                         case 'Digit3': characterToInsert = '#'; break;\r\n                         case 'Digit4': characterToInsert = '$'; break;\r\n                         case 'Digit5': characterToInsert = '%'; break;\r\n                         case 'Digit6': characterToInsert = '^'; break;\r\n                         case 'Digit7': characterToInsert = '&'; break;\r\n                         case 'Digit8': characterToInsert = '*'; break;\r\n                         case 'Digit9': characterToInsert = '('; break;\r\n                         case 'Digit0': characterToInsert = ')'; break;\r\n                         case 'Minus': characterToInsert = '_'; break;\r\n                         case 'Equal': characterToInsert = '+'; break;\r\n                         // ... other shift+symbol mappings using e.code if needed ...\r\n                     }\r\n                 } else { // Non-shifted symbols based on e.code if e.key didn't match\r\n                     switch (code) {\r\n                         case 'Minus': characterToInsert = '-'; break;\r\n                         case 'Equal': characterToInsert = '='; break;\r\n                         case 'BracketLeft': characterToInsert = '['; break;\r\n                         case 'BracketRight': characterToInsert = ']'; break;\r\n                         case 'Backslash': characterToInsert = '\\\\'; break;\r\n                         case 'Semicolon': characterToInsert = ';'; break;\r\n                         case 'Quote': characterToInsert = '\\''; break;\r\n                         case 'Comma': characterToInsert = ','; break;\r\n                         case 'Period': characterToInsert = '.'; break;\r\n                         case 'Slash': characterToInsert = '/'; break;\r\n                         case 'Backquote': characterToInsert = '`'; break;\r\n                     }\r\n                 }\r\n            } // End of single character key handling\r\n\r\n\r\n            // --- 2. Handle Navigation Keys (Use button clicks for page changes) ---\r\n            // (Navigation logic remains the same - finding button by text content)\r\n            const navKeyMap = {\r\n                // 'ArrowRight': '!@#', // Example\r\n                // 'ArrowLeft': 'ABC',   // Example\r\n            };\r\n            if (navKeyMap[key] || navKeyMap[code]) { // Check both key and code for nav\r\n                 actionToPerform = navKeyMap[key] || navKeyMap[code];\r\n                 characterToInsert = null;\r\n            }\r\n\r\n            // --- 3. Perform Action or Insert Character ---\r\n            let currentValue = globalKeyboardDisplay.textContent;\r\n\r\n            if (characterToInsert !== null) {\r\n                currentValue += characterToInsert;\r\n                 if (globalKeyboardState.case === 'shift') {\r\n                    globalKeyboardState.case = 'lower';\r\n                    if (globalKeyboardState.currentPage === 'LetterPad') {\r\n                        renderGlobalKeyboard();\r\n                    }\r\n                 }\r\n            } else if (actionToPerform) {\r\n                let targetButton;\r\n\r\n                switch (actionToPerform) {\r\n                    case 'SPACE': currentValue += ' '; break;\r\n                    case 'BACK': currentValue = currentValue.slice(0, -1); break;\r\n                    case 'ENTER':\r\n                        currentValue += '\\n';\r\n                        targetButton = globalKeyboardModal.querySelector('.global-keypad-btn[data-key=\"ENTER\"]');\r\n                        break;\r\n                    case 'SHIFT':\r\n                        targetButton = globalKeyboardModal.querySelector('.global-keypad-btn[data-key=\"SHIFT\"]');\r\n                        break;\r\n                    case '?123': case 'ABC': case '1234': case '!@#':\r\n                         targetButton = Array.from(globalKeyboardModal.querySelectorAll('.global-keypad-btn.key-special'))\r\n                                             .find(btn => btn.textContent.trim() === actionToPerform);\r\n                        break;\r\n                }\r\n\r\n                if (targetButton && !targetButton.disabled) {\r\n                    targetButton.click();\r\n                }\r\n            }\r\n\r\n            // --- 4. Update Display and Input ---\r\n            if (characterToInsert !== null || ['SPACE', 'BACK', 'ENTER'].includes(actionToPerform)) {\r\n                globalKeyboardDisplay.textContent = currentValue;\r\n                if (activeGlobalInput) {\r\n                    activeGlobalInput.value = currentValue;\r\n                    activeGlobalInput.dispatchEvent(new Event('input'));\r\n                }\r\n                globalKeyboardDisplay.scrollTop = globalKeyboardDisplay.scrollHeight;\r\n            }\r\n        }\r\n        // --- END REVISED BLOCK ---\r\n    });\r\n\r\n\r\n\r\n    // --- START OF NEW VISIBILITY CHANGE LOGIC ---\r\n    document.addEventListener('visibilitychange', () => {\r\n        // Check if the page has become visible\r\n        if (document.visibilityState === 'visible') {\r\n            // Re-run the function that applies the court selection animations\r\n            ensureCourtSelectionAnimation();\r\n        }\r\n    });\r\n    // --- END OF NEW VISIBILITY CHANGE LOGIC ---\r\n\r\n\r\n\r\n    function getTeamKeyFromElement(item) {\r\n        const teamNameSpan = item.querySelector('.team-name-stacked');\r\n        if (teamNameSpan) {\r\n            const playerSpans = teamNameSpan.querySelectorAll('span');\r\n            const players = Array.from(playerSpans).map(span => span.textContent.trim());\r\n            return players.sort().join(' & ');\r\n        }\r\n        return item.dataset.name; // Fallback to data attribute\r\n    }\r\n\r\n    // --- NEW: COMPARISON MODAL LISTENERS (Event Delegation) ---\r\n    function handleHistoryItemClick(e) {\r\n        const item = e.target.closest('.history-item');\r\n        if (!item || e.target.closest('.sort-btn') || e.target.closest('.radio-group')) return;\r\n        \r\n        let type = item.dataset.type;\r\n        let name = item.dataset.name;\r\n        \r\n        // If no dataset, determine from current view\r\n        if (!type) {\r\n            if (state.historyViewMode === 'teams') {\r\n                type = 'team';\r\n                name = getTeamKeyFromElement(item); // Use helper\r\n            } else if (state.historyViewMode === 'stats') {\r\n                type = 'player';\r\n                const nameSpan = item.querySelector('.stats-grid-row span:first-child');\r\n                if (nameSpan) name = nameSpan.textContent.trim();\r\n            }\r\n        }\r\n        \r\n        if (!name || !type) return;\r\n\r\n        if (state.comparison.active && state.comparison.type !== type) {\r\n            resetComparisonState();\r\n        }\r\n\r\n        state.comparison.active = true;\r\n        state.comparison.type = type;\r\n\r\n        const itemIndex = state.comparison.items.indexOf(name);\r\n        if (itemIndex > -1) {\r\n            state.comparison.items.splice(itemIndex, 1);\r\n        } else if (state.comparison.items.length < 2) {\r\n            state.comparison.items.push(name);\r\n        }\r\n\r\n        if (state.comparison.items.length === 1) {\r\n            const selectedName = state.comparison.items[0];\r\n            const opponents = new Set();\r\n            \r\n            state.gameHistory.forEach(game => {\r\n                const team1Players = game.teams.team1;\r\n                const team2Players = game.teams.team2;\r\n\r\n                if (type === 'player') {\r\n                    const isOnTeam1 = team1Players.includes(selectedName);\r\n                    const isOnTeam2 = team2Players.includes(selectedName);\r\n                    if (isOnTeam1) {\r\n                        team2Players.forEach(p => opponents.add(p));\r\n                    } else if (isOnTeam2) {\r\n                        team1Players.forEach(p => opponents.add(p));\r\n                    }\r\n                } else {\r\n                    const team1Key = [...team1Players].sort().join(' & ');\r\n                    const team2Key = [...team2Players].sort().join(' & ');\r\n                    if (team1Key === selectedName) {\r\n                        opponents.add(team2Key);\r\n                    } else if (team2Key === selectedName) {\r\n                        opponents.add(team1Key);\r\n                    }\r\n                }\r\n            });\r\n            state.comparison.opponents = opponents;\r\n        } else if (state.comparison.items.length === 0) {\r\n            resetComparisonState();\r\n        }\r\n        \r\n        if (type === 'player') renderPlayerHistory();\r\n        else renderTeamHistory();\r\n        \r\n        saveState(); // Add this\r\n\r\n        if (state.comparison.items.length === 2) {\r\n            renderComparisonModal();\r\n        }\r\n    }\r\n\r\n    // Replace with a single delegated listener on the parent container:\r\n    historyPage.addEventListener('click', (e) => {\r\n        // Check if click is within either stats list\r\n        const historyItem = e.target.closest('#history-list .history-item, #team-history-list .history-item');\r\n        if (!historyItem) return;\r\n        \r\n        // Prevent action on sort buttons\r\n        if (e.target.closest('.sort-btn') || e.target.closest('.radio-group')) return;\r\n        \r\n        handleHistoryItemClick(e);\r\n    });\r\n\r\n    comparisonCloseBtn.addEventListener('click', () => {\r\n        comparisonModal.classList.add('hidden');\r\n        historyPage.classList.remove('hidden');\r\n        resetComparisonState();\r\n        resetStatsFilters();\r\n        renderHistory(); // This will render based on current state.historyViewMode\r\n        saveState(); // Add this to persist the state\r\n    });\r\n\r\n    // --- SUGGESTION SETTINGS MODAL LISTENERS ---\r\n    suggestionSettingsBtn.addEventListener('click', showSuggestionSettingsModal);\r\n    suggestionSettingsCloseBtn.addEventListener('click', () => {\r\n        suggestionSettingsModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden'); // Return to main admin modal\r\n    });\r\n\r\n    femaleRatioSlider.addEventListener('input', handleFemaleRatioChange);\r\n    maleRatioSlider.addEventListener('input', handleMaleRatioChange);\r\n    leastPlaytimeToggle.addEventListener('change', handleLeastPlaytimeToggleChange);\r\n    powerScoreOnlyToggle.addEventListener('change', handlePowerScoreOnlyToggleChange);\r\n\r\n    topPlayerSlider.addEventListener('input', handleTopPlayerChange);\r\n    frequentOpponentSlider.addEventListener('input', handleFrequentOpponentChange);\r\n    weakPlayerSlider.addEventListener('input', handleWeakPlayerChange);\r\n\r\n    // --- ADMIN CHECKLIST MODAL LISTENERS ---\r\n    checklistBtn.addEventListener('click', showChecklistModal);\r\n\r\n    checklistCloseBtn.addEventListener('click', () => {\r\n        checklistModal.classList.add('hidden');\r\n        adminSettingsModal.classList.remove('hidden'); // Return to admin modal\r\n    });\r\n\r\n    // Use event delegation for checkboxes\r\n    checklistContent.addEventListener('change', handleChecklistChange); // Target the new container\r\n\r\n    // --- CHECKLIST HISTORY LISTENERS ---\r\n    // --- ADD THIS LISTENER ---\r\n    checklistHistoryBtn.addEventListener('click', showChecklistHistoryModal);\r\n    // --- END ADD ---\r\n\r\n    checklistHistoryCloseBtn.addEventListener('click', () => {\r\n        checklistHistoryModal.classList.add('hidden');\r\n        // Decide where to return: main checklist or admin settings\r\n        if (!checklistModal.classList.contains('hidden')) {\r\n             // If main checklist is open, stay there\r\n        } else {\r\n             adminSettingsModal.classList.remove('hidden'); // Default return to admin\r\n        }\r\n        state.selectedChecklistHistoryDate = null; // Clear selected date\r\n    });\r\n\r\n    // Delegate clicks within the history date list\r\n    checklistHistoryList.addEventListener('click', (e) => {\r\n        const li = e.target.closest('li[data-date]');\r\n        if (li) {\r\n            showChecklistHistoryDetail(li.dataset.date);\r\n        }\r\n    });\r\n\r\n    // Back button in the detail view\r\n    checklistHistoryBackBtn.addEventListener('click', () => {\r\n        checklistHistoryDetailView.classList.add('hidden');\r\n        checklistHistoryListView.classList.remove('hidden');\r\n        checklistHistoryBackBtn.classList.add('hidden'); // Hide back button again\r\n        checklistHistoryTitle.textContent = 'Checklist History'; // Reset title\r\n        state.selectedChecklistHistoryDate = null; // Clear selected date\r\n    });\r\n\r\n    // Listener to close the Global Keyboard when clicking outside (or on the DONE button if we add one)\r\n    globalKeyboardModal.addEventListener('click', (e) => {\r\n        // Only hide if the click is directly on the modal background/content, not a key\r\n        if (!e.target.closest('.global-keypad-btn') && !e.target.closest('.keyboard-content')) {\r\n            hideGlobalKeyboard();\r\n        }\r\n    });\r\n\r\n    // --- NEW: Wire Date Inputs to Global Keyboard (NumberPad on Click) ---\r\n    const eventDateInput = document.getElementById('event-date');\r\n    const eventRsvpDateInput = document.getElementById('event-rsvp-date');\r\n    const eventStartTimeInput = document.getElementById('event-start-time');\r\n\r\n    const dateInputClickListener = (e) => {\r\n        const targetInputElement = e.target;\r\n        \r\n        // Check if click was on the calendar/clock icon\r\n        // These icons are positioned on the right side of the input\r\n        const inputRect = targetInputElement.getBoundingClientRect();\r\n        const clickX = e.clientX;\r\n        const iconWidth = 30; // Approximate width of the icon area\r\n        const isIconClick = (clickX > inputRect.right - iconWidth);\r\n        \r\n        // If icon was clicked, allow native picker\r\n        if (isIconClick) {\r\n            // Don't prevent default - let the native picker open\r\n            return;\r\n        }\r\n        \r\n        // Otherwise, prevent native picker and show custom keypad\r\n        e.preventDefault();\r\n\r\n        // Add class to indicate using custom keypad\r\n        targetInputElement.classList.add('using-custom-keypad');\r\n        \r\n        // Get the overlay element\r\n        const overlayId = targetInputElement.id + '-overlay';\r\n        const overlay = document.getElementById(overlayId);\r\n        if (overlay) {\r\n            targetInputElement.dataset.overlayId = overlayId;\r\n        }\r\n        \r\n        // Initialize date part tracking (start with YYYY)\r\n        if (targetInputElement.type === 'date') {\r\n            targetInputElement.dataset.currentDatePart = 'YYYY';\r\n            targetInputElement.dataset.partialValue = '';\r\n        } else if (targetInputElement.type === 'time') {\r\n            targetInputElement.dataset.currentDatePart = 'HH';\r\n            targetInputElement.dataset.partialValue = '';\r\n        }\r\n        \r\n        // Don't pre-fill keypad display, let user type directly into date input\r\n        const initialKeypadValue = ''; // Start keypad display empty\r\n\r\n        // Show keypad, passing the *target* date input\r\n        showGlobalKeyboard(targetInputElement, 'NumberPad', initialKeypadValue); // Pass empty initial value\r\n    };\r\n\r\n    if (eventDateInput) {\r\n        eventDateInput.addEventListener('click', dateInputClickListener);\r\n    }\r\n    if (eventRsvpDateInput) {\r\n        eventRsvpDateInput.addEventListener('click', dateInputClickListener);\r\n    }\r\n    if (eventStartTimeInput) {\r\n        eventStartTimeInput.addEventListener('click', dateInputClickListener);\r\n    }\r\n    // --- END NEW ---\r\n\r\n    // --- Parent Registration Field Listeners ---\r\n    if (parentNameInput) {\r\n        parentNameInput.addEventListener('click', (e) => {\r\n            showGlobalKeyboard(e.target, 'LetterPad', '');\r\n        });\r\n    }\r\n    \r\n    if (parentSurnameInput) {\r\n        parentSurnameInput.addEventListener('click', (e) => {\r\n            showGlobalKeyboard(e.target, 'LetterPad', '');\r\n        });\r\n    }\r\n    \r\n    if (parentPhoneInput) {\r\n        parentPhoneInput.addEventListener('click', (e) => {\r\n            showGlobalKeyboard(e.target, 'NumberPad', '');\r\n        });\r\n    }\r\n    \r\n    if (parentEmailInput) {\r\n        parentEmailInput.addEventListener('click', (e) => {\r\n            showGlobalKeyboard(e.target, 'LetterPad', '');\r\n        });\r\n    }\r\n\r\n    // Swap Player Modal Listeners\r\n    document.getElementById('swap-player-back-btn').addEventListener('click', () => {\r\n        document.getElementById('swap-player-modal').classList.add('hidden');\r\n        manageCourtPlayersModal.classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('swap-confirm-back-btn').addEventListener('click', () => {\r\n        document.getElementById('swap-confirm-modal').classList.add('hidden');\r\n        document.getElementById('swap-player-modal').classList.remove('hidden');\r\n    });\r\n\r\n    document.getElementById('swap-confirm-execute-btn').addEventListener('click', () => {\r\n        executePlayerSwap();\r\n    });\r\n\r\n\r\n    // --- NEW EVENT LISTENERS FOR TTS INTERVAL ---\r\n    document.getElementById('tts-interval-increase').addEventListener('click', () => handleTtsIntervalChange('increase'));\r\n    document.getElementById('tts-interval-decrease').addEventListener('click', () => handleTtsIntervalChange('decrease'));\r\n\r\n    // --- Event Listeners for Consolidated Light Settings Modal ---\r\n    // Court settings modal buttons\r\n    document.getElementById('light-settings-court-cancel-btn')?.addEventListener('click', () => {\r\n        document.getElementById('light-settings-court-modal').classList.add('hidden');\r\n        showAdminModal(); // Re-show admin modal\r\n    });\r\n    document.getElementById('light-settings-court-save-btn')?.addEventListener('click', saveLightSettingsCourtModal);\r\n\r\n    // ============================================================================\r\n    // EVENT LISTENERS - Add these in your DOMContentLoaded section\r\n    // ============================================================================\r\n\r\n    // Setup long-press for both gate buttons\r\n    setupGateButtonLongPress('pedestrian');\r\n    setupGateButtonLongPress('parking');\r\n\r\n    // Pedestrian gate settings modal\r\n    document.getElementById('pedestrian-gate-settings-save-btn')?.addEventListener('click', () => {\r\n        saveGateSettings('pedestrian');\r\n    });\r\n\r\n    document.getElementById('pedestrian-gate-settings-cancel-btn')?.addEventListener('click', () => {\r\n        document.getElementById('pedestrian-gate-settings-modal').classList.add('hidden');\r\n    });\r\n\r\n    // Parking gate settings modal\r\n    document.getElementById('parking-gate-settings-save-btn')?.addEventListener('click', () => {\r\n        saveGateSettings('parking');\r\n    });\r\n\r\n    document.getElementById('parking-gate-settings-cancel-btn')?.addEventListener('click', () => {\r\n        document.getElementById('parking-gate-settings-modal').classList.add('hidden');\r\n    });\r\n\r\n\r\n});"],"names":["console","log","document","addEventListener","alertStatusDisplay","MASTER_MEMBER_LIST","getPronounceableName","playerName","playerObj","find","p","name","state","availablePlayers","courts","flatMap","c","players","nameParts","split","surname","length","slice","join","phoneticName","COURT_HIERARCHY","undoHistory","actions","maxHistory","juniorClub","parents","activeChildren","history","statsFilter","parent","paid","rosterFilter","sortKey","sortOrder","type","checkInFilter","displayMode","registrationFlow","parentCollapsed","childrenExpanded","events","uiSettings","fontSizeMultiplier","displaySizeMultiplier","detailedWeatherView","weatherData","pongAnimationOffset","clubMembers","sort","a","b","localeCompare","id","status","teams","team1","team2","autoStartTimer","gameMode","gameStartTime","autoStartTimeTarget","becameAvailableAt","Date","now","isCollapsed","isModeOverlayActive","courtMode","courtSettings","visibleCourts","autoAssignModes","showGameModeSelector","matchSettings","matchMode","fastPlayGames","autoMatchModes","mobileControls","isSummaryExpanded","isPlayersExpanded","selection","courtId","historySort","key","order","gameHistoryFilter","timeFrame","gameType","guestHistory","gameHistory","reorderHistory","historyViewMode","gender","teamGender","comparison","active","items","opponents","Set","announcements","customAnnouncementState","scheduler","nextAnnouncementTime","currentIndex","isPaused","ttsIntervalMins","powerScoreSort","suggestionSettings","femaleRatioPercent","maleRatioPercent","prioritizeLeastPlaytime","powerScoreOnly","topPlayerPercent","frequentOpponentPercent","weakPlayerPercent","weakPlayerThreshold","currentSuggestionType","currentSuggestionOutcome","adminChecklist","arrival","text","checked","departure","checklistHistory","selectedChecklistHistoryDate","onDuty","selectedAlertSound","notificationControls","isMuted","isMinimized","isTTSDisabled","autoMinimize","currentQuoteIndex","currentAlertCount","tennisQuotes","adminCourtManagement","mode","currentCourtPlayers","removedPlayers","addedPlayers","lightSettings","shellyBaseUrl","shellyAuthKey","label","isManaged","isActive","shellyDeviceId","shellyCloudId","toggleAfter","general","gateSettings","pedestrian","parking","manualEntry","ballManagement","stock","usedStock","historyFilter","tempSale","stockType","memberSignOut","purchaserName","draggedPlayer","activeDraggablePlayer","gateButtonPressTimer","gateButtonIsLongPress","lightIconPressTimer","lightIconIsLongPress","currentUndoAction","currentUndoTimeout","localChangeInProgress","headerTimeout","header","querySelector","timeOverlay","getElementById","headerPullTab","touchStartY","isDragging","lastScrollY","cooldownTimerInterval","alertScheduleTime","currentAudio","alertState","announcementQueue","isAnnouncementPlaying","adminSessionActive","adminSessionTimer","inactivityTimer","screensaverCycleInterval","screensaverCurrentIndex","isShowingScreensaverEvent","screensaverOverlay","screensaverContent","leaderboardConfirmModal","disclaimerModal","currentWeatherModal","detailedWeatherModal","juniorClubModal","juniorClubList","juniorClubCloseBtn","newParentBtn","newParentModal","newParentCancelBtn","newParentConfirmBtn","parentNameInput","parentSurnameInput","childrenContainer","addChildBtn","parentPhoneInput","e","value","target","startsWith","substring","parentEmailInput","removeChildSelectionModal","childrenForRemovalList","removeChildSelectionBackBtn","removeChildSelectionConfirmBtn","childSelectionModal","childSelectionConfirmBtn","childSelectionBackBtn","attendingChildrenList","juniorClubHistoryBtn","juniorClubStatsModal","juniorClubHistoryList","juniorClubStatsBackBtn","juniorClubStatsDetailsBtn","juniorClubDetailModal","detailCloseBtn","detailTogglePaidBtn","juniorClubBtn","juniorClubNameFilterGroup","juniorClubRosterBtn","juniorClubRosterModal","juniorClubRosterList","rosterCloseBtn","rosterTypeFilterGroup","tempDutyHandoverModal","tempDutyHandoverList","tempDutyCurrentMember","tempDutyCancelBtn","tempDutyConfirmBtn","manualEntryModal","manualPlayerList","manualEntryConfirmBtn","manualEntryCancelBtn","addOutsidePlayerBtn","outsidePlayerModal","outsidePlayerList","outsidePlayerBackBtn","manualSelectedPlayersContainer","outsideSelectedPlayersContainer","outsidePlayerConfirmBtn","rosterDetailModal","rosterDetailTitle","rosterDetailContent","rosterDetailCloseBtn","headerClock","availablePlayersSection","availablePlayersList","courtGrid","infoBar","infoBarText","modeDoublesBtn","modeSinglesBtn","chooseTeamsModal","modalPlayerList","modalConfirmBtn","modalCancelBtn","cancelConfirmModal","modalBtnYesConfirm","modalBtnNo","checkInModal","checkInList","checkInCancelBtn","checkInBtn","checkOutModal","checkOutList","checkOutBtn","checkOutCloseBtn","historyBtn","historyPage","historyList","historyToggleViewBtn","historyCloseBtn","endGameModal","endGameTeams","endGameConfirmBtn","endGameCancelBtn","tieBreakerArea","scoreSection","winningScoreInput","losingScoreInput","winnerTiebreakInput","loserTiebreakInput","endGameTimestamp","editStylesBtn","editStylesModal","editStylesCloseBtn","customKeypadModal","keypadDisplay","keypadButtons","querySelectorAll","keypadConfirmBtn","keypadCancelBtn","activeInput","keypadConfig","guestNameModal","guestNameInput","guestSurnameInput","guestGenderRadios","guestConfirmBtn","guestCancelBtn","customAlphaKeypadModal","alphaKeypadDisplay","alphaKeypadGrid","activeAlphaInput","globalKeyboardModal","globalKeyboardDisplay","globalKeyboardGrid","emojiSearchInput","emojiSearchContainer","activeGlobalInput","globalKeyboardState","currentPage","case","longPressTimer","KEYBOARD_LAYOUTS","EMOJI_LIST","adminSettingsModal","committeeMemberList","courtAvailabilityList","adminCloseBtn","reorderPlayersModal","reorderPlayersList","reorderPlayersBtn","reorderSaveBtn","reorderCancelBtn","reorderLogModal","reorderHistoryList","viewReorderLogBtn","reorderLogBackBtn","tempPlayerOrder","selectSoundBtn","soundSelectionModal","soundSelectionList","soundConfirmBtn","soundCancelBtn","alertSounds","Array","from","_","i","tempSelectedSound","muteBtn","minimizeNotificationsBtn","noSpeechBtn","courtModeKeypadModal","courtModeKeypadDisplay","courtModeKeypadButtons","courtModeKeypadConfirmBtn","courtModeKeypadCancelBtn","courtModeAction","manageCourtPlayersModal","courtListForManagement","removePlayersList","addPlayersList","managePlayersCloseBtn","managePlayersBackBtn","managePlayersAddBtn","managePlayersConfirmBtn","manageModalActions","customAnnouncementModal","announcementList","announcementSaveBtn","announcementCancelBtn","customAnnouncementBtn","ballManagementBtn","ballManagementModal","ballManagementCloseBtn","ballStockCount","usedBallStockCount","addStockBtn","signOutOptions","signOutMemberModal","signOutMemberList","signOutMemberConfirmBtn","signOutMemberCancelBtn","returnStockBtn","returnUsedBallsBtn","ballHistoryBtn","ballHistoryModal","ballHistoryDetailModal","detailStockType","detailCategory","detailDatetime","detailCount","detailCommitteeMember","detailPurchaser","detailStockBefore","detailStockChange","detailStockAfter","ballDetailCloseBtn","ballSaleTypeModal","saleTypeCansBtn","saleTypeSinglesBtn","saleTypeCancelBtn","purchaserSelectionModal","purchaserMemberList","purchaserSelectionPrompt","ballHistoryList","ballHistoryCloseBtn","cooldownModal","cooldownTimer","cooldownCloseBtn","comparisonModal","comparisonTitle","comparisonContent","comparisonFilterContainer","comparisonCloseBtn","powerScoreModal","powerScoreList","powerScoreBtn","powerScoreCloseBtn","suggestionSettingsBtn","suggestionSettingsModal","suggestionSettingsCloseBtn","femaleRatioSlider","femaleRatioDisplay","maleRatioSlider","maleRatioDisplay","leastPlaytimeToggle","powerScoreOnlyToggle","topPlayerSlider","topPlayerDisplay","frequentOpponentSlider","frequentOpponentDisplay","weakPlayerSlider","weakPlayerDisplay","topPlayerContainer","frequentOpponentContainer","weakPlayerContainer","checklistBtn","checklistModal","checklistCloseBtn","checklistContent","checklistHistoryBtn","checklistHistoryModal","checklistHistoryListView","checklistHistoryDetailView","checklistHistoryList","checklistHistoryDetail","checklistHistoryTitle","checklistDetailDate","checklistHistoryBackBtn","checklistHistoryCloseBtn","leastPlaytimeContainer","femaleRatioContainer","maleRatioContainer","hideHeader","window","innerWidth","classList","add","clearTimeout","startHeaderHideTimer","setTimeout","showHeader","remove","ticking","mouseStartY","isMouseDragging","scrollContainer","startX","scrollLeft","isDown","style","cursor","pageX","offsetLeft","preventDefault","walk","x","touches","passive","setActiveMobileMenuItem","buttonId","forEach","btn","activeBtn","scrollSnapContainer","scrollTimeout","setActiveCardForMobileScroll","cards","card","containerRect","getBoundingClientRect","containerCenter","left","width","closestCard","minDistance","Infinity","cardRect","distance","Math","abs","enforceQueueLogic","firstActiveIndex","findIndex","targetSwapIndex","index","selectorPlayer","selectorIndex","indexOf","availableInSelectableRange","playersAfterSelector","filter","sameGenderCountInRange","endOfRangeIndex","nextSuitablePlayerIndexInPool","searchPool","playerToMove","splice","insertionIndex","min","setPlayerListHeight","courtGridEl","referenceCard","courtColumnCount","courtGridStyles","getComputedStyle","gridTemplateColumns","height","totalHeight","offsetHeight","getAllKnownPlayers","playersOnCourt","court","uniquePlayers","Map","allPlayers","map","values","game","some","push","guest","getPlayerByName","player","getPlayerNames","playerObjects","totalPlayersAtClub","total","getActivePlayerCount","saveState","_isReceivingUpdate","API","error","showUndoToast","message","undoAction","undoToast","undoToastMessage","undoToastBtn","undoToastTimer","hideUndoToast","textContent","transition","onclick","addToUndoHistory","actionType","actionData","undoFunction","action","data","timestamp","undo","unshift","updateTeamsAfterSwap","oldPlayerName","newPlayerName","team1Index","team2Index","newPlayerObj","handlePlayerDragStart","playerSpot","closest","contains","dataset","position","playerPos","team","dataTransfer","effectAllowed","setData","setDragImage","dragImage","cloneNode","opacity","body","appendChild","removeChild","handlePlayerDoubleClick","spot","handlePlayerDragEnd","el","handlePlayerDragOver","availablePlayerLi","targetCourtId","targetPlayerName","dropEffect","targetCourt","sourceCourt","handlePlayerDragLeave","handlePlayerDrop","stopPropagation","sameCourt","executeTeamReselectionSwap","courtId1","player1Name","player2Name","originalPlayers1","JSON","parse","stringify","originalTeams1","player1Index","player2Index","temp","teamsSet","player1Team","player1TeamIndex","player2Team","player2TeamIndex","p1","p2","courtToRestore","render","executePlayerSwapBetweenCourts","sourceCourtId","sourcePlayerName","originalSourcePlayers","originalTargetPlayers","originalSourceTeams","originalTargetTeams","sourcePlayerIndex","targetPlayerIndex","tempPlayer","sourceCourtToRestore","targetCourtToRestore","executePlayerSubstitution","courtPlayerName","availablePlayerName","courtPlayerIndex","availablePlayer","courtPlayer","originalCourtPlayers","originalCourtTeams","originalAvailablePlayers","getActionDescription","sourcePlayer","targetPlayer","loadState","loaded","isArray","warn","undefined","purchaserType","defaultCourtIds","ensurePlayerObjects","playerList","defaultList","defaultPlayer","onLeaderboard","checkedInNames","has","delay","handleStartGame","updateTimers","updateHeaderClock","date","weekday","toLocaleDateString","day","String","getDate","padStart","hour24","getHours","minutes","getMinutes","seconds","getSeconds","ampm","time","timerEl","elapsed","hours","floor","remaining","pauseTime","parseInt","max","TEN_MINUTES_MS","updateAlertStatusTimer","hasEnoughPlayers","isAnyCourtAvailable","findNextAvailableCourtId","innerHTML","remainingMs","remainingSeconds","showGlobalKeyboard","inputElement","startingPage","initialValue","partialValue","scrollTop","scrollHeight","renderGlobalKeyboard","focus","selectionStart","selectionEnd","getCharForCase","toUpperCase","toLowerCase","searchTerm","layout","renderEmojiPage","filteredEmojis","includes","navRow","createElement","className","btnABC","handleGlobalKeypadClick","btnGlobe","btnMic","btnSymbols","emoji","button","keyboardContent","setAttribute","rowKeys","rowIndex","rowDiv","margin","displayChar","currentValue","isTargetDateInput","isTargetTimeInput","isTargetDateOrTimeInput","start","end","char","dispatchEvent","Event","applyFontSize","setProperty","applyDisplaySize","getWeatherIcon","code","isDay","fetchWeather","weatherDisplay","response","fetch","ok","json","currentHour","maxTemp","round","daily","temperature_2m_max","minTemp","temperature_2m_min","morningWeatherCode","hourly","weathercode","afternoonWeatherCode","dewPoint","dewpoint_2m","morningIcon","afternoonIcon","elements","icons","temps","currentState","weatherAnimationInterval","clearInterval","setInterval","nextState","isLowVisible","lowEl","highEl","toggle","updateLightIcon","lightButton","iconData","getLightStatusIcon","courtLights","class","icon","iconElement","sendLightCommand","light","apiUrl","API_ENDPOINTS","controlLight","shellyCloudUrl","authKey","deviceId","shellyIp","bodyData","method","hasCloudConfig","trim","hasLocalConfig","success","headers","signal","AbortSignal","timeout","errorMsg","errorData","Error","handleGateButtonClick","gateType","gate","playCustomTTS","disabled","apiResult","setupGateButtonLongPress","transform","showGateSettingsModal","modal","saveGateSettings","handleLightToggleChange","updateBallStockDisplay","isStockLow","updateUsedBallStockDisplay","handleBallHistoryFilterChange","renderBallHistoryModal","handleSaleStockTypeSelection","showMemberSelectionModal","confirmPurchaser","member","category","showKeypad","maxLength","title","handleSignOut","indexElement","members","m","committee","li","radio","removeEventListener","enableSignOutConfirm","setupListWithIndex","filterHTML","filteredHistory","entry","isUsed","reverse","dateTime","toLocaleString","change","count","changeClass","stockClass","isUsedBalls","stockBefore","stockAfter","handleBallHistoryItemClick","historyItem","entryId","item","showBallHistoryDetailModal","categoryDisplay","charAt","color","committeeLabel","purchaserDisplay","nonSaleSignOuts","purchaserRow","display","updateActiveIndexLetter","listElement","listTop","top","listItems","activeLetter","topItem","indexLetters","letterDiv","activeLetterEl","scrollIntoView","behavior","block","firstLetters","scrollHandler","_scrollHandler","letter","allLetters","playerToShow","calculatePlayerPlaytime","stats","calculatePlayerStats","played","won","totalDurationMs","calculatePlayerPowerScore","allGames","returnDetailed","historicalWeight","baselineStats","pName","winner","score","winnerTeam","loserTeam","baselineRank","avgRank","Object","reduce","historicalScore","gamesPlayedHistorical","thirtyDaysAgo","setDate","historicalGames","endTime","isPlayerInTeam1","playerTeam","opponentTeam","isWinner","playerTeamAvg","sum","expectedWinProb","exp","finalHistoricalScore","today","toISOString","todaysGames","todaysWins","todaysWinPct","totalGamesInHistory","todayWeight","blendedScore","todayForm","finalScore","renderPowerScoreList","allPlayersAtClub","playerScores","scores","valA","valB","getSortIcon","headerHTML","toFixed","handlePowerScoreSortClick","renderChecklist","checklistData","targetElement","isReadOnly","createListItems","listType","uniqueId","arrivalItemsHTML","departureItemsHTML","ul","listStyle","padding","saveChecklistHistory","year","getFullYear","month","getMonth","todayDateStr","gamesPlayedToday","dutyMemberAssigned","historyIndex","checklist","checklistCopy","resetChecklistForNewDay","forceReset","lastResetDate","localStorage","getItem","keys","section","setItem","findBestBalancingPlayers","currentSelection","pool","allPlayerScores","aimGender","selectorGender","secondPlayerGender","bestCombination","minDiff","bestOverallBalance","combinations","getCombinations","arr","k","combs","head","tailCombs","j","concat","combo","potentialFoursome","potentialFoursomeNames","males","females","foursomeScores","ps","teamSplit","findBestCombination","diff","team1Score","isMatch","fallbackMinDiff","fourPlayers","clearSuggestionHighlights","activeSuggestion","ensureCourtSelectionAnimation","renderTeamHistory","teamStats","calculateTeamStats","gamesToProcess","allPlayerObjects","hStr","mStr","duration","s","replace","gameDuration","processTeam","teamKey","genders","teamPlayerObjects","teamType","every","g","isTeam1Winner","teamHistoryList","teamsWithStats","selectedTeamKey","compareValue","statB","statA","genderFilterHTML","winPercentage","formatWinPercentage","teamNameHTML","rowClass","formatDuration","handleTeamStatsFilterChange","handleSortClick","teamItems","resetComparisonState","resetStatsFilters","isGameInTimeFrame","gameDate","gameYear","currentYear","handleGameTimeFilterChange","renderGameHistory","handleGameTypeFilterChange","handleHistorySortClick","calculateStarPlayers","king","wp","queen","playerStats","kingOfTheCourt","queenOfTheCourt","updateGameModeBasedOnPlayerCount","availableCount","newMode","modeChanged","requiredPlayers","getLastCheckInForChild","childFullName","latestCheckIn","historyEntry","childNames","createPlayerListItem","selectedPlayerNames","starPlayers","winningStreaks","heartbreakerName","isSpecialCase","sliceEnd","specialHighlightIndex","isSelector","inGroup","statusText","statusHTML","playtimeHTML","priorityText","priorityClass","iconHtml","isKing","isQueen","isHeartbreaker","streak","statusFaderItems","timeString","playtime","suggestionButtonHTML","isSelectionFull","isDisabled","handleOnDutyChange","handleTtsIntervalChange","direction","newInterval","Number","showAnnouncementsModal","interval","renderItem","announcement","tts","isLast","random","ann","startHeaderTextAnimation","headerAnimationInterval","announcementContainer","clock","cycleAnimation","announcementEl","containerWidth","offsetWidth","requestAnimationFrame","textWidth","innerSpan","animationDuration","scrollDistance","once","startCustomTtsScheduler","ANNOUNCEMENT_CYCLE_MS","ttsAnnouncements","mainAlertRemaining","isGamePending","nextDelay","autoAssignCourtModes","gameModeContainer","availablePlayersSectionEl","showSelector","selectedCourtId","calculateWinningStreaks","streaks","lastGameResult","sortedHistory","activeStreaks","calculateHeartbreaker","closeLossCounts","winnerScore","loserScore","maxCloseLosses","autoAssignMatchMode","runAutoMinimizeLogic","sliceStart","firstUnpausedIndex","renderQueue","nextPlayerSliceEnd","lastPlayerInRange","foundPlayerIndexInPool","playersBeforeSelector","liSelector","orangeGroupPlayers","groupDiv","playerLi","playersAfterOrangeGroup","playerIndex","playersToggleIcon","isExpanded","insertAdjacentHTML","createSummaryCard","available","availableCourtsCount","totalVisibleCourts","onDutyName","dutyLabel","matchModeText","availableCourts","doublesAvailable","singlesAvailable","rookieAvailable","createCourtCard","playersSelected","selectionComplete","isReservedSelectable","isGreenBallSelectable","isSelectable","finalIsSelectable","selectionMinimumMet","reservedClass","isSelected","isLeagueReserved","isRookieMode","courtCard","modeClass","modeOverlayActive","cancelBtnHTML","editBtnHTML","moreOptionsBtnHTML","modeOverlayHTML","courtIndex","animationDurationMs","currentOffsetMs","elapsedTime","delayStyle","pongAnimationSinglesHTML","pongAnimationDoublesHTML","pongAnimationRedBallHTML","bodyTimerHTML","formatName","playerSpotsHTML","animationHTML","matchModeDisplayHTML","makeDraggable","draggableAttr","draggableClass","overlayHTML","ballClass","isEligibleForSelection","disabledAttr","buttonText","isNewGame","reserveTextHTML","isLightManaged","lightIconClass","lightBtnHTML","lightButtons","showLightSettingsForCourt","editingCourtId","wireGlobalKeypadToInput","availablePlayersListEl","courtInSetup","firstAvailablePlayer","remainingToSelect","allCourtsBusy","initSummaryCardElements","settingsBtn","handleAdminLogin","notifyNowBtn","handleNotifyNow","callDutyBtn","handleCallDuty","quoteTextEl","initialized","quoteInterval","currentQuoteEl","handleMatchModeChange","fastPlaySelector","handleFastPlayGamesChange","proceedWithCourtSelection","queueSnapshot","selectedPlayerObjects","enforceDutyPosition","ms","totalMinutes","allPlayersInGame","renderHistory","historyListEl","teamHistoryListEl","historyTitle","historyToggleTeamsBtn","renderPlayerHistory","allKnownPlayers","playersWithStats","selectedPlayer","handleStatsFilterChange","emptyFilters","createGameHistoryFilters","attachGameHistoryFilterListeners","filteredByTime","finalOrder","gamesHTML","scoreDisplayHTML","toLocaleTimeString","hour","minute","hourCycle","isResultSkipped","team1Class","team2Class","team1HTML","team2HTML","winningScore","losingScore","tiebreak1","tiebreak2","winnerTiebreak","loserTiebreak","tiebreakHTML","courtDisplay","renderReorderHistory","playersHtml","entries","startPosition","currentPosition","details","textAlign","adminAction","handleModeChange","playersToPreserve","newRequiredPlayers","selectableCourts","allCourts","handleChooseTeams","openedFrom","playersToDisplay","div","playerNames","selectedCount","courtCardEl","startButton","announcementMessage","team1Names","team2Names","formatTeamNames","names","pronounceableNames","formattedCourtId","formatCourtIdForTTS","matchModeAnnouncement","namesList","team1String","team2String","playAlertSound","summaryCard","inline","playersSection","resetAlertSchedule","checkAndPlayAlert","renderManualSelectedPlayers","container","chip","handleRemoveManualPlayer","showOutsidePlayerModal","showManualPlayerSelectionModal","isValid","backgroundColor","allOutsidePlayers","handleConfirmManualPlayers","manualGameData","handleEndGame","editGameId","manualEntryData","resetEndGameModal","matchModeDetails","gameToEdit","skipBtn","selectedTeam","currentTarget","teamEl","validateEndGameForm","winKeypadConfig","loseKeypadConfig","maxValue","wireScoreInputToKeypad","finishCheckIn","playerObject","populateCheckInModal","borderColor","confirmSkipResult","newGame","startTime","playersToRequeue","timeUntilNextAlert","nextAvailableCourtId","firstPlayerPronounceableName","getFirstAvailablePlayerName","resetCourtAfterGame","confirmSkipScores","winnerValue","winnerSelected","winScoreVal","loseScoreVal","winScore","loseScore","scoresValid","tiebreakValid","tbWinnerVal","tbLoserVal","numTbWinner","numTbLoser","isReady","getUtterance","utterance","SpeechSynthesisUtterance","voices","speechSynthesis","getVoices","preferredVoice","voice","lang","rate","pitch","speaking","cancel","speak","calculateAge","dateString","birthDate","isNaN","age","courtMessage","dutyMessage","soundFileNameOverride","msg1","msg2","soundFile","processAnnouncementQueue","firstItem","_playAnnouncementSequence","callback","playSequencedTTS","onDone","utterance1","onend","utterance2","pause","currentTime","queuedItem","audioPath","Audio","onSoundPlaying","onSoundEnd","play","catch","shift","forceCheck","availablePlayerCount","availableCourtId","conditionMet","firstPlayerFullName","standardMessage","playerToMoveIndex","targetPosition","newFirstPlayerFullName","playerToMovePronounceable","newFirstPlayerPronounceable","getAdminPasscode","dayOfMonth","showAdminModal","hideCourtModeKeypad","socialCourtCount","socialCourts","totalPlayerCount","updateNotificationIcons","alert","muteIcon","minimizeIcon","noSpeechIcon","committeeMembers","noneOption","togglesLi","matchModeSettingsHtml","isVisible","isLightActive","handleAdminCourtListClick","visibilityToggleInput","handleCourtVisibilityChange","updateFemaleRatioDisplay","updateMaleRatioDisplay","toggleSuggestionOptionsAvailability","updateTopPlayerDisplay","updateFrequentOpponentDisplay","updateWeakPlayerDisplay","renderReorderList","isFirst","startScreensaver","displayNextScreensaverItem","activeEvents","event","existingOverlayBtn","eventIndexToShow","eventDateFormatted","eventDate","eventTimeFormatted","hourInt","minuteInt","rsvpDateFormatted","rsvpDate","imagesHTML","image1Filename","image2Filename","costHTML","costAdult","costChild","adultCost","childCost","participationDiscount","rsvpHTML","rsvpText","volunteersNeeded","contactHTML","phone","email","website","openToText","openTo","isOpenToGuests","openBannerHTML","heading","body1","body2","backgroundImage","stopScreensaver","resetInactivityTimer","showEventListModal","eventList","eventListModal","sortedEvents","eventId","eventDateStr","loadScreensaverImages","images","matches","matchAll","match","populateImageDropdowns","dropdown1","dropdown2","currentValue1","currentValue2","img","option1","option2","options","opt","showEventCreateEditModal","form","interestedSection","interestedList","ev","editingEventId","eventType","participationDiscountPercent","openToRadio","interestedPlayers","updateSliderDisplay","sliderId","slider","displaySpan","previousElementSibling","prefix","suffix","hasActiveEvents","showCourtSelectionCard","cardMode","activeCourts","showManageCourtPlayersModal","showRemovePlayerCard","headerText","modalHeader","existingSwapBtn","existingTeamBtn","buttonContainer","swapBtn","showSwapPlayerModal","swapPlayerModal","swapSourcePlayer","swapInstructions","playerDiv","showSwapTargetSelection","swapTargetList","otherCourts","confirmPlayerSwap","swapConfirmModal","swapConfirmDetails","swapData","borderRadius","onmouseenter","onmouseleave","teamSelectBtn","parentElement","hasChanges","renderRemovePlayersList","rp","displayName","renderAddPlayersList","availableForAdding","isAlreadyAdded","ap","handleManageClose","handleKeypadClick","displayValue","hiddenValue","enteredCode","hideKeypad","keypadContent","checkUndoPasscode","enteredPin","actionIndex","undoActionIndex","correctPin","context","actionDescription","undoActionDescription","confirmSignOutQuantity","promptText","cansToSignOut","isSale","currentStock","modalTitle","handleReorderPositionChange","newPositionStr","oldIndex","newIndex","logPlayerSwap","sessionLog","playerLog","movements","to","test","potentialValue","repeat","input","config","removeAttribute","readOnly","_keypadListener","newListener","newAnnouncements","textInput","ttsCheckbox","parentLi","newLi","newUniqueId","liToRemove","currentAnnouncements","QWERTY_LAYOUT","generateAlphaKeypad","row","lastRowDiv","spaceBtn","backspace","done","handleAlphaKeypadClick","validateGuestForm","validationCallback","handleClick","_clickTimeoutId","parentModal","_globalKeypadClickListener","_globalKeypadInputListener","genderSelected","ageTypeSelected","updateGuestHistory","guestName","guestGender","guestIndex","lastCheckIn","daysVisited","resetGuestForm","memberRadio","resetConfirmModal","checkedInPlayerNames","membersAvailableToCheckIn","justifyContent","populateCheckOutModal","sortedPlayers","executeCheckout","isJunior","child","cmPlayer","lastFastPlayAnnouncement","last1SetAnnouncement","remainingTime","now2","visibleSocialCourtCount","visibleSocialCourts","activeLeagueCourts","socialPlayersOnCourt","totalSocialPlayers","courtsToModify","tempDutyHandover","originalMember","formatCase","str","w","addChild","generateChildField","groupId","fieldGroup","complete","currentParentSurname","childNameInput","childSurnameInput","childDobInput","overlay","parts","validationHandlerForGroup","checkAndCollapseChild","validateNewParentForm","renderChildFields","surnameToAutofill","autofillSurname","bubbles","collapsedDisplay","listenerBound","childrenContainerElement","showEditParentModal","originalParentId","registeredChildren","lastChildGroup","lastElementChild","genderRadio","renderParentForm","showJuniorClubRosterModal","renderJuniorClubRoster","finalRoster","latestChildCheckIn","childCheckIn","isParentOnlyView","lastCheckInMs","childAge","isAllView","parentName","childData","ageDisplay","isChildrenView","uniqueRoster","nameA","nameB","handleRosterTypeFilterChange","indexList","rosterData","buttonStyle","rosterIndex","nameToIndex","lastCheckInDate","itemStyle","handleRosterSortClick","isChildFieldComplete","group","childName","childSurname","childDob","childGender","isComplete","showChildSelectionModal","parentId","renderJuniorClubCheckInList","handleJuniorClubNameFilterChange","finalListItems","isCheckedIn","childDisplay","canCheckIn","renderedList","availableParents","firstAvailableChild","availableChildCount","primaryDisplay","secondaryDisplay","childCount","childCountDisplay","checkInIcon","showJuniorClubModal","shouldRender","parentSurname","parentEmail","parentPhone","isEmailValid","parentFieldsValid","childGroups","allChildrenComplete","removeChildBtn","canAddChild","canRemoveChild","shouldChildrenBeExpanded","isConfirmReady","handleChildSelectionConfirm","attendingChildrenNames","cb","attendingChildren","allCheckedInNames","newChildren","newHistoryEntry","isPaid","showJuniorClubStatsModal","renderJuniorClubHistory","handlePaymentFilterChange","paymentStatusText","paymentStatusClass","childNamesStr","parentFieldsEl","parentCollapseEl","childrenHeader","childrenContainerWrapper","shouldHideSummary","newParentFieldsDisplay","shouldHideHeader","newWrapperDisplay","childGroupCount","expandedFields","computedDisplay","childGenderChecked","updateDetailModalButton","selectedMember","newTempDuty","originalDuty","tempMember","originalDutyPronounceable","newTempDutyPronounceable","showRemoveChildSelectionModal","selectedGroups","childToRemove","childGroupId","selectedIds","groupToRemove","remainingChildGroups","checkedCount","zIndex","screensaverEventId","deleteButton","listItem","deleteEvent","eventName","confirm","headerLogoElement","populateReturningGuestModal","returningGuestList","availableGuests","visits","initializeApp","csvText","parseCSV","lines","h","result","v","onStateUpdate","updatedState","localUIState","statusFaderInterval","faders","fader","statusTexts","currentlyVisibleIndex","nextIndex","wasMobile","isMobile","location","reload","setupLongPressPaste","pasteTargets","pressTimer","isLongPress","handlePointerDown","permission","navigator","permissions","query","clipboard","readText","err","handlePointerUp","handlePointerLeave","handleContextMenu","undoHistoryModal","undoHistoryList","actionDiv","timestampDiv","getTimeAgo","promptUndoWithPin","validationResult","validateUndoAction","reason","hasPlayer1","hasPlayer2","hasSourcePlayer","hasTargetPlayer","originalPlayerAvailable","originalPlayerOnOtherCourt","sourceCourtObj","targetCourtObj","currentScrollY","pageYOffset","documentElement","clientY","updateOverlaySpacers","headerLogo","leftSpacer","rightSpacer","logoWidth","suggestionOutcome","selector","findMostBalancedGame","settings","percentageRoll","poolPlayers","playerPlaytimes","poolPlayerScores","selectorScoreData","top4PlayersData","sortedByScore","suggestion","frequentOpponentName","findFrequentOpponent","opponentCounts","maxCount","frequentOpponent","opponentName","opponentInPool","remainingForBalance","finalTwo","weakPlayerUpperBoundary","otherWeakPlayers","weakFoursomeData","selectedPlayers","remainingPool","targetGenderForLeastPlaytime","isFemaleSelector","availableFemalesInPool","availableMalesInPool","poolForLeastPlaytime","filteredPool","minPlaytime","leastPlayedPlayerScoreObj","playersNeeded","finalGroup","finalGroupScores","finalPlayersToAdd","aimForGender","genderRoll","currentAvailableFemales","currentAvailableMales","finalScores","actualSuggestion","pauseButton","handlePauseToggleClick","updateCountdown","timeLeft","verb","firstUnpaused","isSinglesCourtAvailable","scrollToFirstAvailableCourt","actionTarget","teamsNotSet","handleModeOptionsClick","handleSetCourtMode","handleRandomizeTeams","men","women","shuffledMen","shuffledWomen","handleChooseLater","clickedButton","reservedOnly","allSelectableButtons","showTempDutyHandoverModal","availableCommitteeMembers","noMembersLi","allPlayerNames","team1Players","team2Players","eventIdToEdit","eventData","eventIndex","removeButton","removeInterestedPlayer","initialLength","toggleButton","cardType","stateChanged","cardElement","fullPhone","countryCode","currentMode","newParentId","children1","childBirthDate","parentToUpdate","originalId","itemEl","showRosterDetailModal","isParent","marginTop","marginBottom","children","listStyleType","childLastCheckInMs","checkInDisplay","parentLastCheckInDisplay","latestParentChildrenCheckIn","handleMatchSurname","checkInTarget","editTarget","parentToEdit","selectedEntryId","isNowPaid","childrenNames","checkedOutChildren","childrenToReCheckIn","childDetails","addInterestedPlayer","handleCheckout","showCheckoutThanksModal","nextSocialDay","nextSocialTime","firstName","statsContainer","playerStatsToday","rank","getPlayerRank","playerGender","allStats","leaderboardPlayers","winPctA","winPctB","best","worst","findBestAndWorstMatches","playerGames","bestMatch","scoreDiff","worstMatch","isTeam1","playerScore","opponentScore","scoreText","allTimeStats","allTimeDurationMs","dayOfWeek","getDay","showCheckoutThanksModalNoStats","playerToCheckOutName","manualPlayerNamesJSON","score1","score2","finalWinningScore","finalLosingScore","finalWinnerTiebreak","finalLoserTiebreak","team1Selection","team2Selection","manualGame","gameIndex","tempAvailableCourtId","findNextAvailableCourtIdAfterReset","courtIdToReset","getFirstAvailablePlayerNameAfterRequeue","simulatedAvailablePlayers","executeRemoveSingleChild","gameId","executePlayerCheckOut","executePlayerCheckIn","playerToCheckInName","executeGameCancellation","executeCallDuty","ttsMessage","isPlaying","firstNamePronounceable","executePauseToggle","currentSelectorFullName","wasPlayerHoldingSwapFlag","isHoldingDutySwap","isPlayerPausing","cmIndex","playerToSwapWith","fullPlayerName","pronounceablePlayerName","firstMessage","secondMessage","nextSelectorFullName","nextSelectorPronounceable","executeAddBallStock","executeReturnBallStock","executeUsedBallReturn","executeSignOutBalls","cansCount","currentToast","scoreInputs","checkAndShowTieBreak","checkCourtModePasscode","handleReturningGuestCheckIn","guestData","returningGuestModal","lastName","guestType","ageType","formattedPlayerName","wireNameInputToKeypad","showAlphaKeypad","validateParentAndRender","positionEl","movedPlayers","fromEntries","tab","view","renderDetailedWeatherModal","forecastData","current","morning","afternoon","uv","humidity","pressure","cloudCover","visibility","gridHtml","windDir","windSpeed","precipitation","windGusts","precipProb","weatherCode","realFeel","realFeelShade","wmoCodeToText","isSpecificTime","autoMinimizeToggle","currentFontMultiplier","fontSelector","btnSize","parseFloat","size","currentDisplayMultiplier","displaySelector","tagName","handleFontSizeChange","newMultiplier","handleDisplaySizeChange","showPurchaserSelectionModal","memberSignOutName","membersAndGuests","isGuest","memberData","playerType","addIcon","newCourtPlayers","removedPlayerNames","playersToAdd","vacantIndices","playersToRequeueInQueue","addedPlayerNamesInQueue","newAvailablePlayers","playerInQueue","newGameMode","teamSize","ceil","removedNamesStr","addedNamesStr","announcementPart1","announcementPart2","showAddPlayerCard","isNumericKeypadActive","isAlphaKeypadActive","isGlobalKeyboardActive","targetButton","click","isShiftPressed","shiftKey","characterToInsert","actionToPerform","standardSymbols","navKeyMap","visibilityState","handleHistoryItemClick","getTeamKeyFromElement","teamNameSpan","span","nameSpan","itemIndex","selectedName","isOnTeam1","isOnTeam2","team1Key","team2Key","renderComparisonModal","calculateComparisonStats","item1Name","item2Name","games","headToHeadGames","totalDaysPlayed","uniqueDays","item1OnTeam1","item2OnTeam1","item1OnTeam2","item2OnTeam2","totalSets","totalTimeMs","item1","setsWon","gamesWon","item2","item1SetsWon","item2SetsWon","item1GamesWon","item2GamesWon","team2Score","item1WinPct","item2WinPct","totalGamesPlayed","item1GamesWinPct","item2GamesWinPct","item1SetsNameClass","item2SetsNameClass","item1SetsBgClass","item2SetsBgClass","item1GamesBgClass","item2GamesBgClass","activeRadio","isEnabled","checklistId","itemId","isChecked","opticalItem","auxItem","renderChecklistHistoryList","showChecklistHistoryDetail","dateStr","displayDate","eventDateInput","eventRsvpDateInput","eventStartTimeInput","dateInputClickListener","targetInputElement","inputRect","clickX","clientX","right","overlayId","currentDatePart","executePlayerSwap","originalPlayers","originalTeams"],"version":3,"file":"public.ad6f3c9d.js.map","sourceRoot":"../"}